<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TikZ to SVG</title>
    <!-- Highlight.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material.min.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
    
    <!-- Custom Tailwind-like CSS for Navigation Bar -->
    <style>
        /* Tailwind-like utility classes for production */
        .w-full { width: 100%; }
        .max-w-7xl { max-width: 80rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .bg-white\/80 { background-color: rgba(255, 255, 255, 0.8); }
        .backdrop-blur { backdrop-filter: blur(8px); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .rounded-2xl { border-radius: 1rem; }
        .p-3 { padding: 0.75rem; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .mb-8 { margin-bottom: 2rem; }
        .gap-2 { gap: 0.5rem; }
        .bg-gradient-to-br { background-image: linear-gradient(to bottom right, var(--tw-gradient-stops)); }
        .from-blue-500 { --tw-gradient-from: #3b82f6; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(59, 130, 246, 0)); }
        .to-yellow-400 { --tw-gradient-to: #fbbf24; }
        .p-1\.5 { padding: 0.375rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .text-white { color: #ffffff; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-gray-800 { color: #1f2937; }
        .font-bold { font-weight: 700; }
        .hidden { display: none; }
        .md\:flex { }
        .gap-6 { gap: 1.5rem; }
        .font-medium { font-weight: 500; }
        .text-gray-700 { color: #374151; }
        .relative { position: relative; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .cursor-pointer { cursor: pointer; }
        .transition { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .hover\:text-blue-600:hover { color: #2563eb; }
        .block { display: block; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .md\:block { }
        .bg-gradient-to-r { background-image: linear-gradient(to right, var(--tw-gradient-stops)); }
        .from-red-400 { --tw-gradient-from: #f87171; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(248, 113, 113, 0)); }
        .to-red-600 { --tw-gradient-to: #dc2626; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .py-1\.5 { padding-top: 0.375rem; padding-bottom: 0.375rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .hover\:scale-105:hover { transform: scale(1.05); }
        .font-semibold { font-weight: 600; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .from-blue-400 { --tw-gradient-from: #60a5fa; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(96, 165, 250, 0)); }
        .to-yellow-400 { --tw-gradient-to: #fbbf24; }
        .md\:hidden { }
        .hover\:bg-blue-100:hover { background-color: #dbeafe; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-gray-500 { color: #6b7280; }
        .hover\:text-blue-400:hover { color: #60a5fa; }
        .fixed { position: fixed; }
        .top-0 { top: 0px; }
        .left-0 { left: 0px; }
        .h-full { height: 100%; }
        .bg-black\/50 { background-color: rgba(0, 0, 0, 0.5); }
        .z-40 { z-index: 40; }
        .z-50 { z-index: 50; }
        .z-400 { z-index: 400; }
        .absolute { position: absolute; }
        .right-0 { right: 0px; }
        .w-60 { width: 15rem; }
        .bg-white { background-color: #ffffff; }
        .flex-col { flex-direction: column; }
        .p-6 { padding: 1.5rem; }
        .gap-3 { gap: 0.75rem; }
        .self-end { align-self: flex-end; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5px; }
        .mt-2 { margin-top: 0.5rem; }
        .text-center { text-align: center; }
        .mt-8 { margin-top: 2rem; }
        .w-6 { width: 1.5rem; }
        .h-6 { height: 1.5rem; }
        .rounded-full { border-radius: 9999px; }
        .to-purple-600 { --tw-gradient-to: #9333ea; }
        .justify-center { justify-content: center; }
        .mb-4 { margin-bottom: 1rem; }
        .flex-grow { flex-grow: 1; }
        .mx-4 { margin-left: 1rem; margin-right: 1rem; }
        .overflow-hidden { overflow: hidden; }
        .p-1\.5 { padding: 0.375rem; }
        .text-base { font-size: 1rem; line-height: 1.5rem; }
        .flex-shrink-0 { flex-shrink: 0; }
        
        /* Responsive breakpoints */
        @media (min-width: 920px) {
            .md\:flex { display: flex; }
            .md\:block { display: block; }
            .md\:hidden { display: none; }
        }
        
        /* New Navigation Styles */
        .menu-underline {
          transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
          height: 3px;
          width: 0;
          background: linear-gradient(90deg, #fbbf24, #38bdf8);
          border-radius: 2px;
          margin: 0 auto;
          position: absolute;
          bottom: -2px;
          left: 50%;
          transform: translateX(-50%);
        }
        .menu-item:hover .menu-underline, .menu-item.active .menu-underline {
          width: 80%;
        }
        
        /* Override custom CSS for menu items to remove unwanted styling */
        .menu-item {
          list-style: none !important;
        }
        
        .menu-item a {
          text-decoration: none !important;
          color: #374151 !important;
        }
        
        /* Remove any bullet points or underlines from menu */
        .hidden.md\\:flex {
          list-style: none !important;
          padding: 0 !important;
          margin: 0 !important;
        }
        
        .hidden.md\\:flex li {
          list-style: none !important;
        }
        
        .hidden.md\\:flex li a {
          text-decoration: none !important;
        }
        
        /* Fix mobile menu styling */
        #mobile-menu a {
          text-decoration: none !important;
          color: #374151 !important;
        }
        
        #mobile-menu a:hover {
          color: #2563eb !important;
        }
        
        /* Mobile scroll for menu */
        #scrollable-menu {
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            -ms-overflow-style: none;
            scrollbar-width: none;
            padding-bottom: 0.75rem;
        }
        #scrollable-menu::-webkit-scrollbar {
            display: none;
        }
        
        #scrollable-menu-list {
            list-style: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        
        #scrollable-menu-list .menu-item {
            flex-shrink: 0;
        }
        
        #main-menu {
            list-style: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }
    </style>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        h2 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
        }
        textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        /* ==== Nút chính: Biên dịch, Lưu server, Tải xuống, Xem code SVG, Copy Code ==== */
        .btn-action,
        .compile-save-row-btn,
        .export-btn,
        .copy-btn {
          background: linear-gradient(90deg, #1976d2 0%, #2196f3 100%);
          color: #fff;
          padding: 12px 28px;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          text-decoration: none;
          box-shadow: 0 2px 8px rgba(25, 118, 210, 0.1);
          transition: background 0.3s, box-shadow 0.2s, transform 0.15s;
          width: auto;
          height: auto;
        }

        .btn-action:hover,
        .compile-save-row-btn:hover,
        .export-btn:hover,
        .copy-btn:hover {
          background: linear-gradient(90deg, #1565c0 0%, #42a5f5 100%);
          color: #fff;
          box-shadow: 0 4px 16px rgba(25, 118, 210, 0.18);
          transform: translateY(-2px) scale(1.03);
          outline: none;
          text-decoration: none;
        }

        /* ==== Responsive (mobile) ==== */
        @media (max-width: 1000px) {
          .compile-save-row-btn {
            width: 100%;
            min-width: 0;
            font-size: 16px;
            padding: 14px 0;
            border-radius: 8px;
            margin-bottom: 10px;
            height: 48px;
            box-sizing: border-box;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
          }
        }
        
        @media (max-width: 600px) {
          .btn-action,
          .compile-save-row-btn,
          .export-btn,
          .copy-btn {
            width: 100%;
            min-width: 0;
            font-size: 17px;
            padding: 14px 0;
            border-radius: 8px;
            margin-bottom: 10px;
            height: 48px;
            box-sizing: border-box;
          }
        }
        button:hover {
            background-color: #0056b3;
        }
        .result-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        .svg-preview {
            text-align: center;
            margin-bottom: 20px;
        }
        .svg-preview img {
            max-width: 100%;
            border: 2px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .code-section {
            margin-top: 4px;
            text-align: center;
        }
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .code-title {
            font-weight: bold;
            color: #333;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            position: relative;
        }
        .code-block pre {
            margin: 0;
            padding: 15px;
            background: transparent;
        }
        .code-block code {
            background: transparent;
            padding: 0;
        }
        .download-link {
            display: inline-block;
            background-color: #17a2b8;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            margin-top: 10px;
        }
        .download-link:hover {
            background-color: #138496;
        }
        .copy-link-btn {
            display: inline-block;
            background-color: #ffc107;
            color: #212529;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            margin-top: 10px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
        }
        .copy-link-btn:hover {
            background-color: #e0a800;
        }
        .error {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 5px;
        }
        .files-section {
            margin-top: 40px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .files-section h3 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        .file-card {
            position: relative;
            min-height: 260px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            transition: transform 0.2s ease;
        }
        .file-card:hover {
            transform: translateY(-2px);
        }
        .file-card:hover .file-img-container img {
          transform: scale(1.03);
        }
        .file-img-container {
          position: relative;
          overflow: visible;
          border-radius: 10px 10px 0 0;
          background: #fff;
          min-height: 180px;
          width: 100%;
          display: flex;
          flex-direction: column;
        }

        .file-img-container img {
          width: 100%;
          height: 180px;
          object-fit: contain;
          display: block;
          background-color: #fff;
          transition: transform 0.3s ease;
        }

        .file-actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .file-actions a, .file-actions button {
            padding: 5px 10px;
            text-decoration: none;
            border-radius: 3px;
            font-size: 11px;
            flex: 1;
            text-align: center;
        }
        .view-btn {
            background-color: #007bff;
            color: white;
        }
        .view-btn:hover {
            background-color: #0056b3;
        }
        .fb-share-btn:hover {
            background-color: #1464c7 !important;
        }
        .file-copy-link-btn {
            background-color: #ffc107;
            color: #212529;
            border: none;
        }
        .file-copy-link-btn:hover {
            background-color: #e0a800;
        }
        .copy-btn {
            background-color: #6c757d;
            color: white;
            border: none;
        }
        .copy-btn:hover {
            background-color: #5a6268;
        }
        .like-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            transition: background-color 0.2s;
        }
        .like-btn:hover {
            background-color: #5a6268;
        }
        .like-btn.liked {
            background-color: #e74c3c;
        }
        .like-btn.liked:hover {
            background-color: #c0392b;
        }
        
        /* Overlay Action Menu */
        .file-action-container {
          display: none;
          opacity: 0;
          pointer-events: none;
          transform: translateX(-10px);
          transition: opacity 0.3s, transform 0.3s;
          position: absolute;
          left: 12px;
          top: 60px;
          z-index: 300;
        }

        /* Desktop hover logic */
        @media (hover: hover) and (pointer: fine) {
          .file-img-container:hover + .file-action-container,
          .file-action-container:hover,
          .file-card:hover .file-action-container {
            display: block;
            opacity: 1;
            pointer-events: auto;
            transform: translateX(0);
          }
        }

        /* Mobile/Touch: Chỉ hiện khi card có class active */
        .file-card.active .file-action-container {
          display: block !important;
          opacity: 1 !important;
          pointer-events: auto !important;
          transform: translateX(0) !important;
        }

        /* Mobile: Hiện nút toggle ... */
        .action-toggle-btn {
          display: none;
          position: absolute;
          top: 10px;
          right: 10px;
          z-index: 200;
          border: none;
          background: rgba(255,255,255,0.95);
          border-radius: 50%;
          width: 38px;
          height: 38px;
          font-size: 22px;
          cursor: pointer;
          box-shadow: 0 2px 4px rgba(0,0,0,0.13);
        }

        @media (hover: none), (pointer: coarse) {
          .action-toggle-btn {
            display: block;
          }
          /* Vô hiệu hóa hover trên mobile */
          .file-img-container:hover + .file-action-container {
            display: none !important;
            opacity: 0 !important;
            pointer-events: none !important;
          }
        }
        .no-files {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        .file-card {
            position: relative;
            min-height: 260px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            transition: transform 0.2s ease;
        }


        .file-actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .file-actions a, .file-actions button {
            padding: 5px 10px;
            text-decoration: none;
            border-radius: 3px;
            font-size: 11px;
            flex: 1;
            text-align: center;
        }
        .view-btn {
            background-color: #007bff;
            color: white;
        }
        .view-btn:hover {
            background-color: #0056b3;
        }
        .fb-share-btn {
            background-color: #1877f3;
            color: white;
            border: none;
        }
        .fb-share-btn:hover {
            background-color: #1464c7 !important;
        }
        .download-btn {
            background-color: #28a745;
            color: white;
        }
        .file-copy-link-btn {
            background-color: #ffc107;
            color: #212529;
            border: none;
        }
        .file-copy-link-btn:hover {
            background-color: #e0a800;
        }
        /* Hover effects cho nút trong view-mode-row */
        #view-copy-link-btn:hover {
            background-color: #e0a800 !important;
        }
        #view-download-svg-btn:hover {
            background-color: #138496 !important;
        }
        .no-files {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        .tikz-code-block {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            padding: 10px;
        }
        .tikz-cm {
            width: 100%;
            min-height: 100px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 8px;
            resize: vertical;
        }
        .export-section {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .export-section h4 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }
        .export-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px 32px;
            align-items: start;
            margin-bottom: 10px;
        }
        @media (min-width: 1000px) {
            .export-form {
                grid-template-columns: 1fr 1fr 1fr 1fr;
            }
        }
        .export-pair {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .export-form .export-btn-group {
            grid-column: 1/-1;
            display: flex;
            justify-content: center;
            margin-top: 8px;
        }
        .export-form .export-btn {
            min-width: 160px;
        }
        .export-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .export-select {
            width: 90%;
            min-width: 120px;
            max-width: 180px;
            height: 40px;
            padding: 8px 12px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            box-sizing: border-box;
            vertical-align: middle;
        }
        .export-number {
            width: 100px;
        }
        .export-msg {
            margin-top: 5px;
            color: #388e3c;
            font-weight: bold;
            text-align: center;
            width: 100%;
            display: flex;
            justify-content: center;
        }
        
        /* New file action styles */


        
        /* Like Button Styles */
        input[id^="heart-"] {
            display: none;
        }

        .like-button {
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            height: 32px;
            width: 90px;
            border-radius: 8px;
            border: none;
            background-color: #2d2d2d;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            padding: 0 8px;
        }

        .like-button input[type="checkbox"] {
            display: none;
        }

        .like {
            display: flex;
            cursor: pointer;
            align-items: center;
            gap: 4px;
            flex: 1;
        }

        .like-icon {
            fill: #808080;
            height: 16px;
            width: 16px;
            transition: fill 0.2s ease;
        }

        .like-text {
            color: #e0e0e0;
            font-size: 12px;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 500;
        }

        .like-count {
            color: #808080;
            font-size: 12px;
            font-weight: 500;
            margin-left: 4px;
            transition: all 0.3s ease;
        }

        .like-count.two {
            position: absolute;
            right: 8px;
            transform: translateY(20px);
            opacity: 0;
        }

        .like-count.one {
            position: relative;
        }

        input[id^="heart-"]:checked ~ .like .like-icon {
            fill: #ff4757;
            animation: heartBeat 0.3s ease;
        }

        input[id^="heart-"]:checked ~ .like-count.one {
            transform: translateY(-20px);
            opacity: 0;
        }

        input[id^="heart-"]:checked ~ .like-count.two {
            transform: translateY(0);
            opacity: 1;
            color: #ff4757;
        }

        @keyframes heartBeat {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.3);
            }
            100% {
                transform: scale(1);
            }
        }

        .like-button-wrapper {
            position: relative;
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
            z-index: 100;
        }

        #export-msg, #view-export-msg {
            margin-top: 0;
            text-align: center;
            width: 100%;
            display: flex;
            justify-content: center;
        }
        /* Layout 2 cột cho chế độ nhập và xem - Cải tiến responsive */
        #input-preview-row, #view-mode-row {
            display: flex;
            gap: 32px;
            margin-bottom: 24px;
            /* Thêm overflow-x cho mobile scroll */
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #ccc transparent;
        }
        
        /* Form không có viền để tối giản như yêu cầu */
        #tikz-form {
            background: transparent;
            padding: 0;
            margin-bottom: 0;
            border: none;
            border-radius: 0;
            box-shadow: none;
        }
        
        /* Tùy chỉnh scrollbar cho webkit browsers */
        #input-preview-row::-webkit-scrollbar, #view-mode-row::-webkit-scrollbar {
            height: 8px;
        }
        
        #input-preview-row::-webkit-scrollbar-track, #view-mode-row::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        #input-preview-row::-webkit-scrollbar-thumb, #view-mode-row::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        #input-preview-row::-webkit-scrollbar-thumb:hover, #view-mode-row::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Firefox scrollbar */
        #input-preview-row, #view-mode-row {
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 #f1f1f1;
        }
        
        #input-preview-row .input-col, #input-preview-row .preview-col, #view-mode-row .view-col {
            flex: 1;
            min-width: 0;
            /* Thêm min-width cho mobile */
            min-width: 300px;
        }
        #input-preview-row .preview-col, #view-svg-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            border: 1.5px solid #eee;
            border-radius: 8px;
            min-height: 320px;
            min-width: 200px;
            padding: 16px;
            /* Thêm chiều cao tối đa và tối thiểu giống .preview-col */
            height: 400px;
            max-height: 100%;
            width: 100%;
            box-sizing: border-box;
        }
        #input-preview-row .preview-col img, #view-svg-preview img {
            max-width: 100%;
            max-height: 100%;
            min-height: 200px;
            min-width: 200px;
            display: block;
            margin: 0 auto;
            object-fit: contain;
        }
        /* Tăng chiều cao CodeMirror trong view-mode-row */
        #view-mode-row .CodeMirror {
            height: 320px !important;
            min-height: 320px !important;
            max-height: 100% !important;
        }
        /* Tăng chiều cao CodeMirror trong input-preview-row */
        #input-preview-row .CodeMirror {
            height: 320px !important;
            min-height: 320px !important;
            max-height: 100% !important;
        }
        /* CSS cho result-tools-section */
        #result-tools-section {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .preview-placeholder {
            text-align: center;
            color: #999;
            font-style: italic;
        }
        .preview-placeholder p {
            margin: 0;
            font-size: 16px;
        }
        /* Responsive cho input-preview-row và view-mode-row */
        @media (max-width: 768px) {
            #input-preview-row, #view-mode-row {
                gap: 16px;
                margin-bottom: 16px;
                /* Đảm bảo có thể scroll ngang */
                min-width: calc(100vw - 40px);
                max-width: none;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 10px; /* Thêm space cho scrollbar */
                padding: 16px;
            }
            
            #tikz-form { padding: 0; box-shadow: none; }
            
            /* Container bên ngoài không có viền */
            .input-preview-section .container {
                padding: 20px;
                margin: 0;
                background: #fff;
            }
            
            #input-preview-row .input-col, #input-preview-row .preview-col, #view-mode-row .view-col {
                min-width: 300px;
                flex-shrink: 0;
                flex-basis: 300px;
            }
            
            /* Tăng font size cho CodeMirror trên mobile */
            #input-preview-row .CodeMirror, #view-mode-row .CodeMirror {
                font-size: 16px !important;
            }
            
            /* Tăng padding cho preview col trên mobile */
            #input-preview-row .preview-col, #view-svg-preview {
                padding: 12px;
                min-height: 280px;
            }
        }
        
        @media (max-width: 480px) {
            #input-preview-row, #view-mode-row {
                gap: 12px;
                min-width: calc(100vw - 30px);
                padding-bottom: 8px;
                border: 2px solid #3e9f06;
                border-radius: 8px;
                padding: 12px;
                background: #fff;
                box-shadow: 0 2px 8px rgba(62, 159, 6, 0.2);
            }
            
            #input-preview-row .input-col, #input-preview-row .preview-col, #view-mode-row .view-col {
                min-width: 280px;
                flex-basis: 280px;
            }
            
            #input-preview-row .preview-col, #view-svg-preview {
                padding: 8px;
                min-height: 250px;
            }
            
            /* Cải thiện touch targets trên mobile */
            .compile-save-row-btn {
                min-height: 44px;
                font-size: 16px;
                padding: 12px 20px;
            }
            
            /* Tăng kích thước nút trên mobile */
            .btn-action, .export-btn, .copy-btn {
                min-height: 44px;
                font-size: 16px;
                padding: 12px 20px;
            }
        }
        
        /* Cải thiện trải nghiệm touch cho CodeMirror */
        .CodeMirror {
            touch-action: manipulation;
        }
        
        /* Thêm transition cho mobile hint */
        #mobile-scroll-hint {
            transition: opacity 0.3s ease;
        }
        
        /* CSS cho 3 block layout mới */
        .input-preview-section {
            background: transparent;
            padding: 40px 0;
            margin-bottom: 0;
            border: none;
            overflow-x: hidden; /* Ngăn horizontal scroll của section */
        }
        
        /* CSS theo demo - table-scroll-x */
        .table-scroll-x {
            overflow-x: auto;
            width: 100%;
            -webkit-overflow-scrolling: touch;
            border: 1px solid #3e9f06;
            border-radius: 6px;
            background: #fff;
        }
        
        /* Giới hạn chiều rộng table-scroll-x thành 900px trên màn hình lớn */
        @media (min-width: 1200px) {
            .table-scroll-x {
                width: 900px;
                margin: 0 auto;
            }
        }
        
        .table-content {
            display: flex;
            min-width: 900px;
        }
        
        .col {
            flex: 0 0 450px;
            max-width: 450px;
            min-width: 450px;
            height: 450px;
            min-height: 450px;
            max-height: 450px;
            padding: 16px;
            border-right: 1px solid #eee;
            box-sizing: border-box;
            overflow: auto;
        }

        /* Make the left column form layout fill the 450px height with CodeMirror + controls */
        .table-scroll-x .table-content .col form#tikz-form {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        /* Fallback: trước khi CodeMirror khởi tạo, cho textarea chiếm không gian */
        .table-scroll-x .table-content .col form#tikz-form textarea#code {
            flex: 1 1 auto;
        }
        .table-scroll-x .table-content .col form#tikz-form .CodeMirror {
            flex: 1 1 auto;
            height: auto !important;
            min-height: 0 !important;
            max-height: none !important;
        }
        /* 4px gap between CodeMirror and the compile/save row */
        #compile-save-row {
            margin-top: 4px;
        }
        /* Đảm bảo cột trái (Code + nút) dùng trọn 450px chiều cao nội dung */
        .table-scroll-x .table-content .col:first-child {
            padding-top: 0;
            padding-bottom: 0;
            padding-left: 16px;
            padding-right: 16px;
        }

        /* Căn giữa nội dung cột phải (preview) */
        .table-scroll-x .table-content .col:last-child {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        .table-scroll-x .table-content .col:last-child img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
        }
        .table-scroll-x .table-content .col:last-child .preview-placeholder {
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
        }
        
        .col:last-child {
            border-right: none;
        }
        
        @media (max-width: 950px) {
            .table-content {
                min-width: 100vw;
            }
        }
        
        .files-section-container {
            background: transparent;
            padding: 40px 0;
            border: none;
        }

        /* Files Grid */
        .files-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
          gap: 20px;
          margin-top: 20px;
          padding: 0;
          list-style: none;
        }

        /* Individual File Card */
        .file-card {
          position: relative;
          min-height: 260px;
          display: flex;
          flex-direction: column;
          justify-content: flex-start;
          background: #fff;
          border: 1px solid #ddd;
          border-radius: 10px;
          box-shadow: 0 2px 6px rgba(0,0,0,0.08);
          transition: transform 0.2s ease;
        }

        .file-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        /* Image Section */
        .file-img-container {
          position: relative;
          overflow: visible;
          border-radius: 10px 10px 0 0;
          background: #fff;
          min-height: 180px;
          width: 100%;
          display: flex;
          flex-direction: column;
        }

        .file-img-container img {
          width: 100%;
          height: 180px;
          object-fit: contain;
          display: block;
          background-color: #fff;
          transition: transform 0.3s ease;
        }

        .file-card:hover .file-img-container img {
          transform: scale(1.03);
        }

        /* Overlay Action Menu */
        .file-action-container {
          display: none;
          opacity: 0;
          pointer-events: none;
          transform: translateX(-10px);
          transition: opacity 0.3s, transform 0.3s;
          position: absolute;
          left: 12px;
          top: 60px;
          z-index: 300;
        }

        /* Desktop hover logic */
        @media (hover: hover) and (pointer: fine) {
          .file-img-container:hover + .file-action-container,
          .file-action-container:hover,
          .file-card:hover .file-action-container {
            display: block;
            opacity: 1;
            pointer-events: auto;
            transform: translateX(0);
          }
        }

        /* Mobile/Touch: Chỉ hiện khi card có class active */
        .file-card.active .file-action-container {
          display: block !important;
          opacity: 1 !important;
          pointer-events: auto !important;
          transform: translateX(0) !important;
        }

        /* Mobile: Hiện nút toggle ... */
        .action-toggle-btn {
          display: none;
          position: absolute;
          top: 10px;
          right: 10px;
          z-index: 200;
          border: none;
          background: rgba(255,255,255,0.95);
          border-radius: 50%;
          width: 38px;
          height: 38px;
          font-size: 22px;
          cursor: pointer;
          box-shadow: 0 2px 4px rgba(0,0,0,0.13);
        }

        @media (hover: none), (pointer: coarse) {
          .action-toggle-btn {
            display: block;
          }
          /* Vô hiệu hóa hover trên mobile */
          .file-img-container:hover + .file-action-container {
            display: none !important;
            opacity: 0 !important;
            pointer-events: none !important;
          }
          .file-card.active .file-action-container .Btn.individual-active,
          .file-card.active .file-action-container .Btn.ready-to-execute,
          .file-card.active .file-action-container .Btn.mobile-hover {
            background: linear-gradient(-50deg, rgb(39, 107, 255), rgb(112, 186, 255), rgb(39, 107, 255)) !important;
            width: 120px !important;
            transition: width 0.3s cubic-bezier(0.4,0,0.2,1);
          }

          .file-card.active .file-action-container .Btn.individual-active .text,
          .file-card.active .file-action-container .Btn.ready-to-execute .text,
          .file-card.active .file-action-container .Btn.mobile-hover .text {
            opacity: 1 !important;
            width: auto !important;
            max-width: 85px !important;
            color: #ffffff !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
          }

          .file-card.active .file-action-container .Btn.individual-active .text,
          .file-card.active .file-action-container .Btn.ready-to-execute .text {
            opacity: 1 !important;
          }

          .file-card.active .file-action-container .Btn:not(.individual-active):not(.ready-to-execute):not(.mobile-hover) {
            background: linear-gradient(-50deg, rgb(39, 107, 255), rgb(112, 186, 255), rgb(39, 107, 255)) !important;
            max-width: 10px !important;
            border-radius: 18px !important;
          }

          .file-card.active .file-action-container .Btn .text {
            opacity: 0.5 !important;
            width: auto !important;
            max-width: 120px !important;
            color: #ffffff !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
          }
        }

        .file-action-list {
          list-style: none;
          padding: 0;
          margin: 0;
          display: flex;
          flex-direction: column;
          gap: 8px;
          overflow: visible;
          width: auto;
        }

        .file-action-item {
          display: flex;
          justify-content: flex-start;
          width: 100%;
        }

        /* Button Styling */
        .Btn {
          display: flex;
          align-items: center;
          justify-content: flex-start;
          width: 35px;
          height: 35px;
          border: none;
          border-radius: 50%;
          cursor: pointer;
          position: relative;
          overflow: hidden;
          transition: all 0.3s ease;
          box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.199);
          background: linear-gradient(-50deg, rgb(39, 107, 255), rgb(112, 186, 255), rgb(39, 107, 255));
          background-size: 250%;
          background-position: left;
          min-width: 35px;
          flex-shrink: 0;
        }

        /* Icon container */
        .sign {
          width: 45px;
          height: 45px;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          justify-content: flex-start;
          padding-left: 4px;
          flex-shrink: 0;
          z-index: 2;
          position: relative;
        }

        .sign svg {
          width: 18px;
          height: 18px;
        }

        .sign svg path {
          fill: white;
        }

        .logoIcon {
          color: white;
          font-size: 16px;
        }

        /* Text label */
        .text {
          position: absolute;
          left: 20px;
          top: 50%;
          transform: translateY(-50%);
          width: 0;
          opacity: 0;
          color: white;
          font-size: 14px;
          font-weight: 600;
          transition: all 0.3s ease;
          white-space: nowrap;
          text-align: left;
          padding-left: 12px;
          z-index: 1;
        }

        /* Desktop hover effect */
        .Btn:hover {
          width: 140px;
          border-radius: 20px;
          background-position: right;
        }

        .Btn:hover .text {
          opacity: 1;
          width: auto;
          max-width: 85px;
          color: #ffffff;
          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* Button states for touch devices */
        .Btn.individual-active {
          background: linear-gradient(-50deg, rgb(39, 107, 255), rgb(112, 186, 255), rgb(39, 107, 255)) !important;
          width: 120px !important;
          border-radius: 20px !important;
        }

        .Btn.ready-to-execute {
          background: linear-gradient(-50deg, rgb(39, 107, 255), rgb(112, 186, 255), rgb(39, 107, 255)) !important;
          width: 120px !important;
          border-radius: 20px !important;
        }

        .Btn.individual-active .text,
        .Btn.ready-to-execute .text {
          opacity: 1 !important;
          width: auto !important;
          max-width: 85px !important;
          color: #ffffff !important;
          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
        }

        /* File Info Styling */
        .file-info {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 0px;
            font-size: 13px;
            color: #555;
        }

        .file-meta {
            margin-bottom: 6px;
            font-weight: 400;
        }

        .file-meta .label {
            font-weight: 500;
            color: #333;
        }

        .file-creator {
            margin-top: 8px;
            font-size: 13px;
            font-weight: 400;
        }

        /* Like Button Styles */
        input[id^="heart-"] {
            display: none;
        }

        .like-button {
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            height: 32px;
            width: 90px;
            border-radius: 8px;
            border: none;
            background-color: #2d2d2d;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            padding: 0 8px;
        }

        .like-button input[type="checkbox"] {
            display: none;
        }

        .like {
            display: flex;
            cursor: pointer;
            align-items: center;
            gap: 4px;
            flex: 1;
        }

        .like-icon {
            fill: #808080;
            height: 16px;
            width: 16px;
            transition: fill 0.2s ease;
        }

        .like-text {
            color: #e0e0e0;
            font-size: 12px;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 500;
        }

        .like-count {
            color: #808080;
            font-size: 12px;
            font-weight: 500;
            margin-left: 4px;
            transition: all 0.3s ease;
        }

        .like-count.two {
            position: absolute;
            right: 8px;
            transform: translateY(20px);
            opacity: 0;
        }

        .like-count.one {
            position: relative;
        }

        input[id^="heart-"]:checked ~ .like .like-icon {
            fill: #ff4757;
            animation: heartBeat 0.3s ease;
        }

        input[id^="heart-"]:checked ~ .like-count.one {
            transform: translateY(-20px);
            opacity: 0;
        }

        input[id^="heart-"]:checked ~ .like-count.two {
            transform: translateY(0);
            opacity: 1;
            color: #ff4757;
        }

        @keyframes heartBeat {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.3);
            }
            100% {
                transform: scale(1);
            }
        }

        /* Like Button Wrapper */
        .like-button-wrapper {
            position: relative;
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
            z-index: 100;
        }

        /* No Files */
        .no-files {
            text-align: center;
            color: #666;
            padding: 40px 20px;
            background: #f9f9f9;
            border-radius: 12px;
            border: 2px dashed #ddd;
        }

        .no-files-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* CodeMirror styles cho TikZ code block */
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            position: relative;
        }
        .code-block pre {
            margin: 0;
            padding: 15px;
            background: transparent;
        }
        .code-block code {
            background: transparent;
            padding: 0;
        }
        .tikz-code-block .CodeMirror {
            max-height: 300px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 5px;
            width: 100%;
        }
        .tikz-code-block {
            width: 100%;
        }
        .tikz-code-block .code-block {
            width: 100%;
        }
        .tikz-code-block .tikz-cm {
            display: none;
        }
        .CodeMirror-placeholder {
            color: #bbb !important;
            font-style: italic;
        }
        .CodeMirror-gutter, .CodeMirror-gutters, .CodeMirror-linenumbers {
            width: 2.5em !important;
            min-width: 2.5em !important;
        }
        .CodeMirror-linenumber, .CodeMirror-gutter-elt {
            min-width: 2em !important;
            width: 2em !important;
            text-align: right !important;
            padding-right: 0.5em !important;
            box-sizing: content-box !important;
        }

        /* TikZ code block header and copy button */
        .tikz-code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            border-radius: 5px 5px 0 0;
            font-weight: bold;
            color: #333;
        }
        
        /* Responsive cho các block */
        @media (max-width: 768px) {
            .input-preview-section,
            .files-section-container {
                padding: 20px 0;
            }
        }
        
        @media (max-width: 480px) {
            .input-preview-section,
            .files-section-container {
                padding: 15px 0;
            }
        }
        
        /* Responsive cho files-section */
        @media (max-width: 768px) {
            .files-section {
                margin-top: 20px;
                padding: 15px;
            }
            
            .files-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 12px;
            }
            
            .file-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .file-actions a, .file-actions button {
                padding: 8px 12px;
                font-size: 12px;
                min-height: 36px;
            }
        }
        
        @media (max-width: 600px) {
            .files-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .files-section {
                margin-top: 15px;
                padding: 10px;
            }
            
            .files-grid {
                gap: 10px;
            }
            
            .file-actions {
                gap: 6px;
            }
            
            .file-actions a, .file-actions button {
                padding: 6px 10px;
                font-size: 11px;
                min-height: 32px;
            }
            
            .container {
                padding: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .input-preview-section .container {
                overflow-x: visible; /* Cho phép scroll ngang trong container */
                padding-left: 10px;
                padding-right: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .input-preview-section .container {
                padding: 15px;
            }
        }

        #input-preview-row, #view-mode-row {
            padding: 12px;
        }
        
        #tikz-form { 
            padding: 0; 
            box-shadow: none; 
        }
        
        /* Responsive export-form: chỉ 1 cột khi max-width: 600px */
        @media (max-width: 600px) {
            .export-form {
                grid-template-columns: 1fr;
            }
        }
        /* Line numbers */
        .hljs-ln-numbers {
            text-align: right;
            color: #999;
            border-right: 1px solid #ddd;
            vertical-align: top;
            padding-right: 8px !important;
            min-width: 25px;
            }
        .hljs-ln-code {
            padding-left: 8px !important;
        }
        /* View mode code editor */
        #view-tikz-code {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            position: relative;
        }
        #view-tikz-code pre {
            margin: 0;
            padding: 15px;
            background: transparent;
        }
        #view-tikz-code code {
            background: transparent;
            padding: 0;
        }
        .CodeMirror {
            height: 220px;
            font-size: 15px;
            border-radius: 6px;
            border: 1.5px solid #bbb;
            background: #f8f9fa;
            overflow: auto;
        }
        
        /* Đảm bảo CodeMirror trong tikz-code-block có scrollbar đẹp */
        .tikz-code-block .CodeMirror {
            max-height: 300px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 5px;
        }
        
        /* Tùy chỉnh scrollbar cho CodeMirror */
        .tikz-code-block .CodeMirror-scrollbar-filler {
            background-color: #f0f0f0;
        }
        
        .tikz-code-block .CodeMirror-simplescroll-horizontal div,
        .tikz-code-block .CodeMirror-simplescroll-vertical div {
            background-color: #c1c1c1;
            border-radius: 10px;
        }
        
        /* Ẩn textarea gốc khi CodeMirror đã được khởi tạo */
        .tikz-code-block .tikz-cm {
            display: none;
        }
        .CodeMirror-placeholder {
            color: #bbb !important;
            font-style: italic;
        }
        /* Fix gutter/line number width for CodeMirror */
        .CodeMirror-gutter, .CodeMirror-gutters, .CodeMirror-linenumbers {
            width: 2.5em !important;
            min-width: 2.5em !important;
        }
        .CodeMirror-linenumber, .CodeMirror-gutter-elt {
            min-width: 2em !important;
            width: 2em !important;
            text-align: right !important;
            padding-right: 0.5em !important;
            box-sizing: content-box !important;
        }
        .export-form .export-col:first-child {
            max-width: 220px;
        }
        @media (max-width: 900px) {
            .export-select {
                min-width: 100px;
                max-width: 100%;
            }
        }

        .preview-col {
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            border-radius: 8px;
        }
        .compile-save-row-btn {
            min-width: 160px;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 5px;
            height: 48px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        #compile-btn.compile-save-row-btn {
            background-color: #007bff;
            color: white;
            border: none;
        }
        #compile-btn.compile-save-row-btn:hover {
            background-color: #0056b3;
        }
        #save-server-btn.compile-save-row-btn:hover {
            background-color: #e0a800;
        }
        .export-download-link {
            display: inline-block;
            background: linear-gradient(90deg, #17a2b8 0%, #138496 100%);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(23,162,184,0.2);
            margin-top: 8px;
        }

        .export-download-link:hover {
            background: linear-gradient(90deg, #138496 0%, #117a8b 100%);
            box-shadow: 0 4px 12px rgba(23,162,184,0.3);
            transform: translateY(-2px);
            color: white;
            text-decoration: none;
        }
        .export-btn-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #export-msg {
            margin-top: 0;
            text-align: center;
        }
        .export-btn-group {
            width: 100%;
        }
        #svg-code-container {
          transition: all 0.3s ease;
        }
        
        /* Hover effects cho các nút trong view mode */
        #view-copy-link-btn:hover {
            background: #e0a800 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,193,7,0.3) !important;
        }
        
        #view-download-svg-btn:hover {
            background: #138496 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(23,162,184,0.3) !important;
            text-decoration: none;
        }
        
        #view-back-to-edit-btn:hover {
            background: linear-gradient(90deg, #218838 0%, #1ea085 100%) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40,167,69,0.3) !important;
        }
        /* Layout 2 hàng cho export-form trong view mode */
        #view-export-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        #view-export-form .export-btn-group {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            margin-top: 16px;
        }
        #view-export-form .export-btn {
            min-width: 140px;
        }
        /* Responsive cho export-form trong view mode */
        @media (max-width: 1000px) {
            #view-export-form {
                grid-template-columns: 1fr;
                justify-items: center;
                gap: 16px;
            }
            #view-export-form .export-pair {
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: center;
                gap: 12px;
                width: 100%;
                max-width: 300px;
            }
            #view-export-form .export-label {
                text-align: right;
                font-weight: 600;
                color: #333;
                min-width: 80px;
                flex-shrink: 0;
            }
            #view-export-form .export-input,
            #view-export-form .export-select,
            #view-export-form .export-number {
                width: 120px;
                text-align: center;
                flex-shrink: 0;
            }
        }
        /* CSS cho các nút thao tác trong cột phải view mode */
        #view-svg-actions {
            margin-top: 16px;
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        #view-svg-actions .view-action-btn {
            background: #ffc107;
            color: #212529;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(255,193,7,0.2);
            transition: all 0.2s;
            text-decoration: none;
        }
        #view-svg-actions .view-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,193,7,0.3);
        }
        #view-svg-actions .view-download-btn {
            background: #17a2b8;
            color: white;
        }
        #view-svg-actions .view-download-btn:hover {
            box-shadow: 0 4px 12px rgba(23,162,184,0.3);
        }
        /* Responsive cho các nút thao tác */
        @media (max-width: 800px) {
            #view-svg-actions {
                flex-direction: column;
                gap: 8px;
            }
        }
        #modal-svg-preview {
          text-align: center;
        }
        #modal-svg-img {
          display: inline-block;
          margin: 0 auto;
          max-width: 100%;
          max-height: 200px;
          object-fit: contain;
          border: 1px solid #ddd;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Google Login Button Styles */
        .google-login-btn {
          max-width: 320px;
          display: flex;
          padding: 8px 16px;
          font-size: 14px;
          line-height: 1.25rem;
          font-weight: 700;
          text-align: center;
          text-transform: uppercase;
          align-items: center;
          justify-content: center;
          border-radius: 6px;
          border: 1px solid rgba(0, 0, 0, 0.25);
          gap: 0.75rem;
          color: rgb(65, 63, 63);
          background-color: #fff;
          cursor: pointer;
          transition: all .6s ease;
          min-height: 40px;
        }

        .google-login-btn svg {
          height: 24px;
          flex-shrink: 0;
        }

        .google-login-btn:hover {
          transform: scale(1.02);
          background-color: #1565c0;
          color: white;
        }

        .google-login-content {
          display: flex;
          align-items: center;
          gap: 12px;
          font-weight: 500;
          font-size: 14px;
        }
        #logout-btn {
          background: #d32f2f;
          color: white;
          padding: 8px 16px;
          border-radius: 6px;
          text-decoration: none;
          font-weight: bold;
          font-size: 14px;
          box-sizing: border-box;
        }
    </style>
</head>
<body>
    <!-- New Navigation Bar -->
    <nav class="w-full max-w-7xl mx-auto bg-white/80 backdrop-blur shadow-lg rounded-2xl p-3 flex items-center justify-between mb-8">
        <!-- Logo -->
        <div class="flex items-center gap-2 flex-shrink-0">
            <span class="bg-gradient-to-br from-blue-500 to-yellow-400 p-1.5 rounded-lg">
                <i class="fa-solid fa-meteor text-white text-lg"></i>
            </span>
            <span class="text-lg font-bold text-gray-800">TikZ to SVG</span>
        </div>
        
        <!-- Menu - Desktop -->
        <div class="hidden md:flex flex-grow mx-4 justify-center">
          <ul id="main-menu" class="flex items-center gap-6 font-medium text-gray-700">
            <li class="menu-item relative px-2 py-1 cursor-pointer transition hover:text-blue-600">
                <a href="/" class="block text-base" style="line-height: 1;">Trang chủ</a>
                <div class="menu-underline"></div>
            </li>
            {% if current_user.is_authenticated %}
            <li class="menu-item relative px-2 py-1 cursor-pointer transition hover:text-blue-600">
                <a href="/profile/{{ current_user.id }}/settings" class="block text-base" style="line-height: 1;">Hồ sơ</a>
                <div class="menu-underline"></div>
            </li>
            <li class="menu-item relative px-2 py-1 cursor-pointer transition hover:text-blue-600">
                <a href="/profile/{{ current_user.id }}/svg-files" class="block text-base" style="line-height: 1;">File SVG</a>
                <div class="menu-underline"></div>
            </li>
            <li class="menu-item relative px-2 py-1 cursor-pointer transition hover:text-blue-600">
                <a href="/profile/{{ current_user.id }}/followed-posts" class="block text-base" style="line-height: 1;">Bài đăng</a>
                <div class="menu-underline"></div>
            </li>
            {% endif %}
          </ul>
        </div>
        
        <!-- Avatar/User or Login & Hamburger -->
        <div class="flex items-center gap-2 flex-shrink-0">
            {% if current_user.is_authenticated %}
                                    <div class="flex items-center gap-2">
                        <div class="flex items-center gap-2 bg-gray-100 px-2 py-1.5 rounded-lg border border-gray-200">
                        {% if avatar %}
                            <img src="{{ url_for('static', filename='avatars/' ~ avatar) }}" 
                                 alt="Avatar" class="w-6 h-6 rounded-full"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        {% endif %}
                        {% if not avatar %}
                            <div class="w-6 h-6 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-xs">
                                {{ user_email[0].upper() if user_email else 'U' }}
                            </div>
                        {% endif %}
                        <span class="text-xs font-medium text-gray-700">{{ username or user_email.split('@')[0] }}</span>
                    </div>
                    <a href="/logout" class="hidden md:block bg-gradient-to-r from-red-400 to-red-600 text-white px-3 py-1.5 rounded-xl shadow hover:scale-105 transition font-semibold text-xs" style="text-decoration: none;">Đăng xuất</a>
                </div>
            {% else %}
                <button class="hidden md:block bg-gradient-to-r from-blue-400 to-yellow-400 text-white px-3 py-1.5 rounded-xl shadow hover:scale-105 transition font-semibold text-sm" onclick="loginWithGoogle()">Đăng nhập</button>
            {% endif %}
            <!-- Hamburger (mobile) -->
            <button id="menu-toggle" class="md:hidden p-1.5 rounded-lg hover:bg-blue-100 transition">
                <i class="fa-solid fa-bars text-lg"></i>
            </button>
        </div>
    </nav>

    <!-- Scrollable Menu - Mobile -->
    <div id="scrollable-menu" class="md:hidden w-full max-w-7xl mx-auto mb-8">
        <ul id="scrollable-menu-list" class="flex items-center gap-6 font-medium text-gray-700 px-3">
            <li class="menu-item relative px-2 py-1 cursor-pointer transition hover:text-blue-600">
                <a href="/" class="block text-base" style="line-height: 1;">Trang chủ</a>
                <div class="menu-underline"></div>
            </li>
            {% if current_user.is_authenticated %}
            <li class="menu-item relative px-2 py-1 cursor-pointer transition hover:text-blue-600">
                <a href="/profile/{{ current_user.id }}/settings" class="block text-base" style="line-height: 1;">Hồ sơ</a>
                <div class="menu-underline"></div>
            </li>
            <li class="menu-item relative px-2 py-1 cursor-pointer transition hover:text-blue-600">
                <a href="/profile/{{ current_user.id }}/svg-files" class="block text-base" style="line-height: 1;">File SVG</a>
                <div class="menu-underline"></div>
            </li>
            <li class="menu-item relative px-2 py-1 cursor-pointer transition hover:text-blue-600">
                <a href="/profile/{{ current_user.id }}/followed-posts" class="block text-base" style="line-height: 1;">Bài đăng</a>
                <div class="menu-underline"></div>
            </li>
            {% endif %}
        </ul>
    </div>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="fixed top-0 left-0 w-full h-full bg-black/50 z-400 hidden">
        <div class="absolute right-0 top-0 w-60 bg-white h-full shadow-lg flex flex-col p-6 gap-3">
            <button id="close-menu" class="self-end text-2xl text-gray-500 hover:text-blue-400">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <a href="/" class="py-2 px-3 rounded-lg text-gray-700 font-medium hover:bg-blue-100 transition">Trang chủ</a>
            {% if current_user.is_authenticated %}
            <a href="/profile/{{ current_user.id }}/settings" class="py-2 px-3 rounded-lg text-gray-700 font-medium hover:bg-blue-100 transition">Hồ sơ</a>
            <a href="/profile/{{ current_user.id }}/svg-files" class="py-2 px-3 rounded-lg text-gray-700 font-medium hover:bg-blue-100 transition">File SVG</a>
            <a href="/profile/{{ current_user.id }}/followed-posts" class="py-2 px-3 rounded-lg text-gray-700 font-medium hover:bg-blue-100 transition">Bài đăng</a>
            {% endif %}
            {% if current_user.is_authenticated %}
                <a href="/logout" class="bg-gradient-to-r from-red-400 to-red-600 text-white px-4 py-2 rounded-xl shadow font-semibold mt-2 text-center" style="text-decoration: none;">Đăng xuất</a>
            {% else %}
                <button class="bg-gradient-to-r from-blue-400 to-yellow-400 text-white px-4 py-2 rounded-xl shadow font-semibold mt-8" onclick="loginWithGoogle()">Đăng nhập</button>
            {% endif %}
        </div>
    </div>
    <!-- Block 2: Input-Preview Section -->
    <div class="input-preview-section">
        <div class="container">
            <h2>Chuyển đổi TikZ sang SVG/PNG/JPEG</h2>

            <!-- Truyền trạng thái login từ server vào JS (để linter không báo lỗi) -->
            <script id="app-state" type="application/json">{{ {
              'loggedIn': logged_in,
              'userEmail': user_email,
              'username': username,
              'avatar': avatar
            } | tojson | safe }}</script>
            <!-- Giá trị TikZ ban đầu để khởi tạo CodeMirror -->
            <script id="initial-tikz" type="application/json">{{ tikz_code|default('')|tojson|safe }}</script>
            <script>
              window.appState = JSON.parse(document.getElementById('app-state').textContent);
            </script>

        <div class="table-scroll-x">
          <div class="table-content">
            <div class="col">
              <form id="tikz-form" method="post" onsubmit="console.log('Form submit event'); return submitTikzCodeAjax(event)">
                <textarea name="code" id="code" rows="12" placeholder="Nhập code TikZ tại đây...">{{ tikz_code|default('') }}</textarea>
                <div class="d-flex justify-content-end align-items-center gap-2" id="compile-save-row">
                  <button type="submit" id="compile-btn" class="compile-save-row-btn" {% if not logged_in %}title="Bạn cần đăng nhập Google để sử dụng"{% endif %}>Biên dịch</button>
                  <button
                    type="button"
                    id="save-server-btn"
                    class="compile-save-row-btn"
                    data-file-id="{{ svg_temp_id }}"
                    data-tikz-code="{{ tikz_code | e }}"
                    style="display: none;"
                  >
                    💾 Lưu server
                  </button>
                </div>
              </form>
            </div>
            <div class="col">
              {% if error %}
                <div class="error">{{ error|safe }}</div>
              {% elif svg_temp_url %}
                <img src="{{ svg_temp_url }}" alt="SVG Preview" style="width:100%;height:100%;object-fit:contain;display:block;">
              {% else %}
                <div class="preview-placeholder">
                  <p>Nhập code TikZ để xem preview real-time</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
        <!-- Thông báo hướng dẫn cho mobile -->
        <p id="mobile-scroll-hint" style="margin-top: 12px; color: #777; font-size: 0.9em; text-align: center; display: none;">
          📱 Trên điện thoại, vuốt ngang để xem đủ 2 cột
        </p>





{# Thêm block này NGAY SAU form, TRƯỚC result-tools-section #}
{% if error %}
    <div class="result-section">
        <div class="error">{{ error|safe }}
            {% if error_log_full %}
                <br><button id="show-log-btn" style="margin-top:10px; background:#b71c1c; color:white; border:none; border-radius:4px; padding:6px 16px; cursor:pointer;">Hiển thị chi tiết log</button>
                <pre id="full-log" style="display:none; background:#fff0f0; color:#b71c1c; border:1px solid #f5c6cb; border-radius:4px; padding:12px; margin-top:10px; max-height:400px; overflow:auto;">{{ error_log_full }}</pre>
                <script>
                document.getElementById('show-log-btn').onclick = function() {
                    var log = document.getElementById('full-log');
                    if (log.style.display === 'none') {
                        log.style.display = 'block';
                        this.textContent = 'Ẩn chi tiết log';
                    } else {
                        log.style.display = 'none';
                        this.textContent = 'Hiển thị chi tiết log';
                    }
                };
                </script>
            {% endif %}
        </div>
    </div>
{% endif %}

        {% if svg_temp_url and not error %}
        </div> <!-- đóng .container của input-preview-section trước khi tools -->
    </div> <!-- đóng .input-preview-section trước khi tools -->
    
    <div id="result-tools-section" class="container" style="margin-top: 16px;">
                <div class="export-section">
                    <h4>Xuất ảnh PNG/JPEG</h4>
                    <form id="export-form" class="export-form">
                        <div class="export-pair">
                            <label for="export-format" class="export-label">Định dạng:</label>
                            <select id="export-format" class="export-input export-select">
                                <option value="png">PNG</option>
                                <option value="jpeg">JPEG</option>
                            </select>
                        </div>
                        <div class="export-pair">
                            <label for="export-dpi" class="export-label">DPI:</label>
                            <input type="number" id="export-dpi" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-pair">
                            <label for="export-width" class="export-label">Width (px):</label>
                            <input type="number" id="export-width" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-pair">
                            <label for="export-height" class="export-label">Height (px):</label>
                            <input type="number" id="export-height" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-btn-group">
                            <button id="export-btn" type="button" class="export-btn" data-file-id="{{ svg_temp_id }}">Tải xuống</button>
                        </div>
                    </form>
                    <div id="export-msg" style="margin-top:5px; color:#388e3c;"></div>
                </div>

                {% if svg_content %}
                    <div class="code-section">
                        <button id="toggle-svg-code-btn" class="copy-btn" type="button">📜 Xem code SVG</button>
                        <div id="svg-code-container" style="display:none; margin-top:12px;">
                            <div class="code-header">
                                <span class="code-title">Code SVG:</span>
                                <button id="copy-svg-code-btn" class="copy-btn" type="button">📋 Copy Code</button>
                            </div>
                            <div class="code-block" id="svgCode">
                                <pre><code class="language-xml">{{ svg_content }}</code></pre>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        {% else %}
        </div> <!-- đóng .container của input-preview-section -->
    </div> <!-- đóng .input-preview-section -->
        {% endif %}
    
    <!-- Block 3: Files Section -->
    <div class="files-section-container">
        <div class="container">
            <section class="files-section" data-is-owner="{{ 'true' if logged_in else 'false' }}">
                <h3 style="color:#1976d2; margin-bottom:24px;">📁 Files đã lưu</h3>
                <div id="files-container" class="files-grid">
                    <div class="loading-spinner" style="text-align: center; padding: 20px;">
                        <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #1976d2; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 10px; color: #666;">Đang tải files...</p>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <footer style='text-align:center;color:#888;font-size:14px;margin-top:40px;'>© 2024 TikZ2SVG - All rights reserved.</footer>

    <!-- Modal đăng nhập cho nút "Xem Code" -->
    <div id="login-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center;">
      <div style="background:white; padding:32px 40px; border-radius:12px; box-shadow:0 2px 16px rgba(0,0,0,0.15); min-width:320px; text-align:center;">
        <h3 style="margin-bottom:24px;">Đăng nhập để sử dụng tính năng này</h3>
        <p style="margin-bottom:16px; color:#666;">Vui lòng đăng nhập để có thể:</p>
        <ul style="margin-bottom:24px; color:#666; text-align:left; display:inline-block;">
          <li>👁️ Xem TikZ code</li>
          <li>👍 Like và unlike ảnh</li>
          <li>💾 Lưu ảnh vào server</li>
          <li>👥 Theo dõi người dùng khác</li>
        </ul>
        <p style="margin-bottom:24px; color:#1976d2; font-weight:500;">💡 Bạn vẫn có thể sử dụng Facebook Share và Copy Link mà không cần đăng nhập!</p>
        
        <!-- Container cho các nút - căn giữa -->
        <div style="display:flex; justify-content:center; align-items:center; gap:12px; flex-wrap:wrap;">
          <button id="modal-login-btn" class="google-login-btn" style="margin:0;">
            <span class="google-login-content">
              <svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid" viewBox="0 0 256 262">
                <path fill="#4285F4" d="M255.878 133.451c0-10.734-.871-18.567-2.756-26.69H130.55v48.448h71.947c-1.45 12.04-9.283 30.172-26.69 42.356l-.244 1.622 38.755 30.023 2.685.268c24.659-22.774 38.875-56.282 38.875-96.027"></path>
                <path fill="#34A853" d="M130.55 261.1c35.248 0 64.839-11.605 86.453-31.622l-41.196-31.913c-11.024 7.688-25.82 13.055-45.257 13.055-34.523 0-63.824-22.773-74.269-54.25l-1.531.13-40.298 31.187-.527 1.465C35.393 231.798 79.49 261.1 130.55 261.1"></path>
                <path fill="#FBBC05" d="M56.281 156.37c-2.756-8.123-4.351-16.827-4.351-25.82 0-8.994 1.595-17.697 4.206-25.82l-.073-1.73L15.26 71.312l-1.335.635C5.077 89.644 0 109.517 0 130.55s5.077 40.905 13.925 58.602l42.356-32.782"></path>
                <path fill="#EB4335" d="M130.55 50.479c24.514 0 41.05 10.589 50.479 19.438l36.844-35.974C195.245 12.91 165.798 0 130.55 0 79.49 0 35.393 29.301 13.925 71.947l42.211 32.783c10.59-31.477 39.891-54.251 74.414-54.251"></path>
              </svg>
              Đăng nhập Google
            </span>
          </button>
          <button onclick="document.getElementById('login-modal').style.display='none'" style="background:#eee; color:#333; padding:12px 24px; border-radius:6px; border:none; font-weight:bold; margin:0;">Huỷ</button>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- JavaScript Functions -->
    <script>
        // Function để đăng nhập với Google
        function loginWithGoogle() {
            window.location.href = "{{ url_for('google.login') }}";
        }

        // Function để load SVG files
        async function loadSvgFiles() {
            const filesContainer = document.getElementById('files-container');
            if (!filesContainer) return;

            try {
                const response = await fetch('/api/public/files');
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.files && data.files.length > 0) {
                        filesContainer.innerHTML = data.files.map(file => `
                            <div class="file-card" data-file-id="${file.id}">
                              <button class="action-toggle-btn" type="button" aria-label="Hiện menu hành động">⋯</button>
                              <div class="file-info">
                                <div class="file-creator" style="margin-bottom: 0; font-size: 12px;">
                                  👤 <a href="/profile/${file.creator_id}/svg-files" style="text-decoration: none; color: #1976d2; font-weight: 700; font-size: 13px;">
                                    ${file.creator_username}
                                  </a>
                                  <span style="margin-left:8px; color: #666; font-size: 11px;">${file.created_time}</span>
                                </div>
                              </div>
                              <div class="file-img-container">
                                <img src="${file.url}" alt="${file.filename}">
                                <div class="like-button-wrapper">
                                  <div class="like-button">
                                    <input id="heart-${file.id}" type="checkbox" ${file.is_liked_by_current_user ? 'checked' : ''} />
                                    <label class="like" for="heart-${file.id}">
                                      <svg class="like-icon" fill-rule="nonzero" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z"></path>
                                      </svg>
                                      <span class="like-text">Likes</span>
                                    </label>
                                    <span class="like-count one">${file.like_count}</span>
                                    <span class="like-count two">${file.like_count}</span>
                                  </div>
                                </div>
                              </div>
                              <div class="file-action-container">
                                <ul class="file-action-list">
                                  <li class="file-action-item">
                                    <button type="button" class="Btn" data-filename="${file.filename}" onclick="window.location.href='/view_svg/${file.filename}'">
                                      <div class="sign">
                                        <i class="fas fa-image logoIcon"></i>
                                      </div>
                                      <div class="text">Tải ảnh</div>
                                    </button>
                                  </li>
                                 <li class="file-action-item">
                                    <button type="button" class="Btn fb-share-btn" data-filename="${file.filename}" data-has-feedback="true">
                                      <div class="sign">
                                        <i class="fab fa-facebook logoIcon"></i>
                                      </div>
                                      <div class="text">Facebook</div>
                                    </button>
                                  </li>
                                  <li class="file-action-item">
                                    <button type="button" class="Btn file-copy-link-btn" data-url="https://tikz2svg.mathlib.io.vn/static/${file.filename}" data-has-feedback="true">
                                      <div class="sign">
                                        <i class="fas fa-link logoIcon"></i>
                                      </div>
                                      <div class="text">Copy Link</div>
                                    </button>
                                  </li>
                                  ${file.tikz_code ? `
                                  <li class="file-action-item">
                                    <button type="button" class="Btn" onclick="toggleTikzCode(this)">
                                      <div class="sign">
                                        <i class="fas fa-code logoIcon"></i>
                                      </div>
                                      <div class="text">Xem Code</div>
                                    </button>
                                  </li>
                                  ` : ''}
                                </ul>
                              </div>
                              
                              <!-- TikZ Code Section -->
                              ${file.tikz_code ? `
                              <div class="tikz-code-block" style="display:none; margin-top:10px;">
                                <div class="tikz-code-header">
                                  <span>Code TikZ:</span>
                                  <button class="copy-btn" onclick="copyTikzCode(this)">📋 Copy</button>
                                </div>
                                <div class="code-block">
                                  <textarea class="tikz-cm" readonly>${file.tikz_code}</textarea>
                                </div>
                              </div>
                              ` : ''}
                            </div>
                        `).join('');
                        
                        // Setup buttons sau khi tạo HTML
                        setupFileCardButtons();
                    } else {
                        filesContainer.innerHTML = `
                            <div class="no-files">
                                <p>Chưa có file SVG nào được tạo. Hãy thử chuyển đổi một code TikZ!</p>
                            </div>
                        `;
                    }
                } else {
                    filesContainer.innerHTML = `
                        <div class="no-files">
                            <p>Không thể tải danh sách files. Vui lòng thử lại sau.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading SVG files:', error);
                filesContainer.innerHTML = `
                    <div class="no-files">
                        <p>Lỗi khi tải danh sách files: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Function xử lý click like
        function handleLikeClick(btn, svgId) {
            if (!window.appState.loggedIn) {
                // Hiển thị modal đăng nhập nếu chưa đăng nhập
                const loginModal = document.getElementById('login-modal');
                if (loginModal) {
                    loginModal.style.display = 'flex';
                } else {
                    window.location.href = '/login/google';
                }
                return;
            }
            
            // Logic like/unlike cho người đã đăng nhập
            fetch('/like_svg', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    svg_id: svgId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Cập nhật UI
                    const currentText = btn.textContent;
                    const likeCount = parseInt(currentText.match(/\d+/)[0]);
                    const newCount = data.liked ? likeCount + 1 : likeCount - 1;
                    btn.textContent = `❤️ Likes ${newCount}`;
                    btn.style.background = data.liked ? '#e74c3c' : '#6c757d';
                }
            })
            .catch(error => {
                console.error('Error liking SVG:', error);
            });
        }

        // Function xử lý các nút khi chưa đăng nhập
        function setupFileCardButtons() {
            if (!window.appState.loggedIn) {
                // Xử lý nút fb-share-btn - CHO PHÉP HOẠT ĐỘNG khi chưa đăng nhập (copy link vào clipboard)
                document.querySelectorAll('.fb-share-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        const filename = this.getAttribute('data-filename');
                        if (filename) {
                            const shareUrl = `${window.location.origin}/view_svg/${filename}`;
                            copyToClipboardWithCustomFeedback(shareUrl, this, 'Facebook', 'Đã copy!');
                        }
                    });
                });

                // Xử lý nút file-copy-link-btn - CHO PHÉP HOẠT ĐỘNG khi chưa đăng nhập
                document.querySelectorAll('.file-copy-link-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        const url = this.getAttribute('data-url');
                        if (url) {
                            // Copy to clipboard
                            if (navigator.clipboard && window.isSecureContext) {
                                navigator.clipboard.writeText(url).then(() => {
                                    const textDiv = this.querySelector('.text');
                                    if (textDiv) {
                                        textDiv.textContent = 'Đã copy!';
                                        setTimeout(() => {
                                            textDiv.textContent = 'Copy Link';
                                        }, 2000);
                                    }
                                }).catch(() => {
                                    // Fallback
                                    const textArea = document.createElement('textarea');
                                    textArea.value = url;
                                    document.body.appendChild(textArea);
                                    textArea.select();
                                    document.execCommand('copy');
                                    document.body.removeChild(textArea);
                                    
                                    const textDiv = this.querySelector('.text');
                                    if (textDiv) {
                                        textDiv.textContent = 'Đã copy!';
                                        setTimeout(() => {
                                            textDiv.textContent = 'Copy Link';
                                        }, 2000);
                                    }
                                });
                            }
                        }
                    });
                });

                // Xử lý nút "Xem Code" - KHÔNG CẦN XỬ LÝ RIÊNG NỮA VÌ toggleTikzCode ĐÃ TỰ KIỂM TRA
                // Function toggleTikzCode và copyTikzCode đã được cập nhật để tự kiểm tra trạng thái đăng nhập
            }
        }

        // Load SVG files sẽ được gọi trong main initializer

        function updateHeaderLoginState() {
            // Logic mới: Header đã được render từ server với avatar/username
            // Chỉ cần xử lý các logic bổ sung
            
            if (window.appState.loggedIn) {
                // Cập nhật trạng thái nút sau khi đăng nhập
                updateButtonStates();
                
                // Kiểm tra xem có ảnh SVG đang chờ hiển thị sau khi đăng nhập không

            }
        }

        function setupRequireLogin() {
            // Chỉ xử lý các nút khác, không xử lý view-btn vì đã xử lý riêng
            document.querySelectorAll('.files-section .file-copy-link-btn, .files-section .copy-btn').forEach(function(btn) {
                btn.onclick = function(e) {
                    if (!window.appState.loggedIn) {
                        e.preventDefault();
                        showLoginModal();
                    }
                };
            });
        }

        // Hàm khởi tạo event listeners cho các nút
        function initializeEventListeners() {
            // ----------------------------------------------
            // 1. Copy link (🔗 Copy Link)
            // ----------------------------------------------
            document.querySelectorAll('.copy-link-btn').forEach(btn => {
                btn.onclick = function() {
                    const link = this.getAttribute('data-link');
                    if (link) {
                        navigator.clipboard.writeText(link)
                            .then(() => showFeedback(this, '✅ Đã copy!'))
                            .catch(() => showFeedback(this, '❌ Lỗi copy!'));
                    }
                };
            });

            // ----------------------------------------------
            // 2. Copy Facebook link (🟦 Copy link Facebook)
            // ----------------------------------------------
            document.querySelectorAll('.copy-fb-link-btn').forEach(btn => {
                btn.onclick = function() {
                    const link = this.getAttribute('data-link');
                    if (link) {
                        const fbLink = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`;
                        navigator.clipboard.writeText(fbLink)
                            .then(() => showFeedback(this, '✅ Đã copy link Facebook!'))
                            .catch(() => showFeedback(this, '❌ Lỗi copy!'));
                    }
                };
            });

            // ----------------------------------------------
            // 3. Xem code TikZ (📝 Xem code TikZ)
            // ----------------------------------------------
            document.querySelectorAll('.view-tikz-btn').forEach(btn => {
                btn.onclick = function() {
                    const tikzCode = this.getAttribute('data-tikz-code');
                    if (tikzCode) {
                        showTikzCodeModal(tikzCode);
                    }
                };
            });

            // ----------------------------------------------
            // 4. Nút lưu server (💾 Lưu server)
            // ----------------------------------------------
            document.querySelectorAll('#save-server-btn').forEach(btn => {
                btn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const fileId = this.getAttribute('data-file-id');
                    const tikzCode = this.getAttribute('data-tikz-code') || "";
                    
                    if (!fileId) {
                        alert("Lỗi: không có file_id!");
                        return;
                    }

                    // Reset modal
                    const keywordsInput = document.getElementById('keywordsInput');
                    const suggestionsBox = document.getElementById('keywordSuggestions');
                    if (keywordsInput) keywordsInput.value = "";
                    if (suggestionsBox) {
                        suggestionsBox.innerHTML = '';
                        suggestionsBox.style.display = 'none';
                    }

                    // Lấy URL ảnh SVG từ preview hiện tại
                    const currentPreview = document.querySelector('.preview-col img');
                    const modalSvgImg = document.getElementById('modal-svg-img');
                    if (currentPreview && modalSvgImg) {
                        modalSvgImg.src = currentPreview.src;
                        modalSvgImg.style.display = 'block';
                    } else if (modalSvgImg) {
                        modalSvgImg.style.display = 'none';
                    }

                    // Kiểm tra xem có file_id hợp lệ không (tức là đã biên dịch thành công)
                    if (!fileId || fileId === 'None' || fileId === '') {
                        alert('⚠️ Cảnh báo: Chưa có ảnh SVG được biên dịch thành công.\n\nVui lòng nhấn nút "Biên dịch" trước khi lưu server.');
                        return;
                    }

                    // Kiểm tra xem code TikZ hiện tại có khớp với code TikZ đã được biên dịch không
                    const currentTikzCode = window.cm ? window.cm.getValue() : document.getElementById('code').value;
                    const compiledTikzCode = this.getAttribute('data-tikz-code') || "";
                    
                    // Debug: Log để kiểm tra
                    console.log('Current TikZ Code:', currentTikzCode.trim());
                    console.log('Compiled TikZ Code:', compiledTikzCode.trim());
                    console.log('Are they equal?', currentTikzCode.trim() === compiledTikzCode.trim());
                    
                    if (currentTikzCode.trim() !== compiledTikzCode.trim()) {
                        alert('⚠️ Cảnh báo: Code TikZ hiện tại khác với code TikZ đã được biên dịch.\n\nẢnh hiển thị: từ code TikZ hiện tại\nẢnh sẽ được lưu: từ code TikZ đã biên dịch\n\nVui lòng nhấn nút "Biên dịch" để cập nhật trước khi lưu server.');
                        return;
                    }

                    // Lưu thông tin tạm thời
                    window.pendingFileId = fileId;
                    window.pendingTikzCode = tikzCode;

                    // Hiện modal Bootstrap
                    const modal = new bootstrap.Modal(document.getElementById('keywordModal'));
                    modal.show();
                };
            });

            // ----------------------------------------------
            // 5. Nút export PNG/JPEG (Tải xuống)
            // ----------------------------------------------
            const exportBtn = document.getElementById('export-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', async function() {
                    const svgTempId = exportBtn.getAttribute('data-file-id') || '';
                    const format = document.getElementById('export-format').value;
                    const widthVal = document.getElementById('export-width').value;
                    const heightVal = document.getElementById('export-height').value;
                    const dpiVal = document.getElementById('export-dpi').value;
                    const msg = document.getElementById('export-msg');

                    msg.textContent = '';
                    if ((widthVal && widthVal <= 0) || (heightVal && heightVal <= 0) || (dpiVal && dpiVal <= 0)) {
                        msg.textContent = 'Width, Height, DPI phải là số dương!';
                        return;
                    }

                    exportBtn.disabled = true;
                    exportBtn.textContent = 'Đang xử lý...';

                    try {
                        const res = await fetch('/temp_convert', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                file_id: svgTempId,
                                fmt: format,
                                width: widthVal || undefined,
                                height: heightVal || undefined,
                                dpi: dpiVal || undefined
                            })
                        });
                        const data = await res.json();
                        if (data.url) {
                            msg.innerHTML = `<a href="${data.url}" download class="export-download-link">Tải về ${format.toUpperCase()}</a>`;
                        } else {
                            msg.textContent = data.error || 'Lỗi không xác định!';
                        }
                    } catch (err) {
                        msg.textContent = 'Lỗi kết nối hoặc máy chủ!';
                    }

                    exportBtn.disabled = false;
                    exportBtn.textContent = 'Tải xuống';
                });
            }

            // ----------------------------------------------
            // 6. Toggle SVG Code (📜 Xem code SVG)
            // ----------------------------------------------
            const toggleSvgCodeBtn = document.getElementById('toggle-svg-code-btn');
            if (toggleSvgCodeBtn) {
                toggleSvgCodeBtn.onclick = function() {
                    const container = document.getElementById('svg-code-container');
                    if (container) {
                        const currentlyHidden = container.style.display === 'none' || container.style.display === '';
                        container.style.display = currentlyHidden ? 'block' : 'none';
                        toggleSvgCodeBtn.textContent = currentlyHidden ? '❌ Ẩn code SVG' : '📜 Xem code SVG';
                    }
                };
            }

            // ----------------------------------------------
            // 7. Copy SVG Code (📋 Copy Code)
            // ----------------------------------------------
            const copySvgCodeBtn = document.getElementById('copy-svg-code-btn');
            if (copySvgCodeBtn) {
                copySvgCodeBtn.onclick = function() {
                    const codeBlock = document.getElementById('svgCode');
                    if (codeBlock) {
                        const text = codeBlock.innerText.trim();
                        navigator.clipboard.writeText(text).then(() => {
                            copySvgCodeBtn.textContent = '✅ Đã copy!';
                            setTimeout(() => {
                                copySvgCodeBtn.textContent = '📋 Copy Code';
                            }, 2000);
                        }).catch(() => {
                            copySvgCodeBtn.textContent = '❌ Lỗi copy!';
                            setTimeout(() => {
                                copySvgCodeBtn.textContent = '📋 Copy Code';
                            }, 2000);
                        });
                    }
                };
            }
        }

        var cm; // Khai báo global để các hàm khác truy cập được
        function copyToClipboard(text, buttonElement, originalText) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = 0;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            if (buttonElement) {
                const originalContent = buttonElement.innerHTML;
                buttonElement.innerHTML = '✅ Đã copy!';
                setTimeout(() => {
                    buttonElement.innerHTML = originalContent;
                }, 2000);
            }
        }

        function copySvgCode() {
            const codeBlock = document.getElementById('svgCode');
            const copyBtn = document.querySelector('.copy-btn');
            copyToClipboard(codeBlock.textContent, copyBtn, '📋 Copy Code');
        }

        function copyTikzCode(btn) {
            // Lấy code từ CodeMirror instance nếu có, nếu không thì từ textarea gốc
            const codeBlock = btn.closest('.tikz-code-block');
            const textarea = codeBlock.querySelector('.tikz-cm');
            let code = '';
            
            // Ưu tiên lấy từ CodeMirror instance
            if (textarea.CodeMirror) {
                code = textarea.CodeMirror.getValue();
                console.log('Getting code from CodeMirror instance');
            } else {
                // Fallback: lấy từ textarea gốc
                code = textarea.value;
                console.log('Getting code from original textarea');
            }
            
            // Loại bỏ dòng trắng ở đầu và cuối, chỉ giữ tối đa 1 dòng trắng liên tiếp
            let lines = code.split('\n');
            while (lines.length && lines[0].trim() === '') lines.shift();
            while (lines.length && lines[lines.length - 1].trim() === '') lines.pop();
            let cleaned = [];
            let lastBlank = false;
            for (let line of lines) {
                if (line.trim() === '') {
                    if (!lastBlank) cleaned.push('');
                    lastBlank = true;
                } else {
                    cleaned.push(line);
                    lastBlank = false;
                }
            }
            
            const finalCode = cleaned.join('\n');
            console.log('Copying code:', finalCode.substring(0, 100) + '...');
            copyToClipboard(finalCode, btn, '📋 Copy');
        }

        

        // Khởi tạo CodeMirror sẽ được gọi trong init chính
        function initCodeMirrorAndBindings() {
            var tikzCode = document.getElementById('code');
            cm = CodeMirror.fromTextArea(tikzCode, {
                mode: 'stex',
                theme: 'material',
                lineNumbers: true,
                lineWrapping: true,
                placeholder: 'Nhập code TikZ tại đây...'
            });
            // Giá trị ban đầu từ server
            try {
                cm.setValue(JSON.parse(document.getElementById('initial-tikz')?.textContent || '""'));
            } catch(e) {
                cm.setValue('');
            }
            
            // Thêm sự kiện click vào CodeMirror để hiện modal đăng nhập nếu chưa đăng nhập
            if (!window.appState.loggedIn) {
                cm.on('mousedown', function() {
                    showLoginModal();
                });
            }
            
            // Thêm sự kiện real-time preview cho form nhập code
            let inputPreviewTimer;
            cm.on('change', function() {
                clearTimeout(inputPreviewTimer);
                inputPreviewTimer = setTimeout(() => {
                    updateInputPreview(cm.getValue());
                }, 1000); // Delay 1 giây sau khi ngừng gõ
            });
            

            // Sự kiện copy link Facebook
            document.querySelectorAll('.fb-share-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const filename = btn.getAttribute('data-filename');
                    const shareUrl = `${window.location.origin}/view_svg/${filename}`;
                    const textArea = document.createElement('textarea');
                    textArea.value = shareUrl;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = 0;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    btn.innerHTML = '✅ Đã copy link Facebook!';
                    setTimeout(() => {
                        btn.innerHTML = '🟦 Copy link Facebook';
                    }, 2000);
                });
            });


            
            // Khởi tạo preview nếu có code TikZ ban đầu
            const initialCode = cm.getValue();
            if (initialCode && initialCode.trim()) {
                updateInputPreview(initialCode);
            }
        }

        // Hiển thị lỗi biên dịch TikZ, kèm log chi tiết nếu có
        function displayCompileError(message, fullLog) {
            console.log('displayCompileError called with:', { message, hasFullLog: !!fullLog });
            // Xóa TẤT CẢ error sections cũ
            document.querySelectorAll('.result-section, #result-section, #ajax-result-section').forEach(el => {
                if (el.querySelector('.error') || el.querySelector('#ajax-show-log-btn')) {
                    el.remove();
                }
            });
            // Nếu không có log chi tiết thì chỉ hiện text lỗi chung
            const section = document.createElement('div');
            section.id = 'ajax-result-section';
            section.className = 'result-section';
            let html = `<div class=\"error\">Lỗi khi biên dịch!</div>`;
            if (fullLog && fullLog.trim()) {
                html += `<button id=\"ajax-show-log-btn\" style=\"margin-top:10px; background:#b71c1c; color:white; border:none; border-radius:4px; padding:6px 16px; cursor:pointer;\">Hiển thị chi tiết log</button>`;
                html += `<button id=\"ajax-copy-log-btn\" style=\"display:none; margin-left:10px; background:#ffc107; color:#212529; border:none; border-radius:4px; padding:6px 16px; cursor:pointer; font-weight:bold;\">Copy log</button>`;
                html += `<pre id=\"ajax-full-log\" style=\"display:none; background:#fff0f0; color:#b71c1c; border:1px solid #f5c6cb; border-radius:4px; padding:12px; margin-top:10px; max-height:400px; overflow:auto;\">${fullLog}</pre>`;
            }
            section.innerHTML = html;
            // Insert sau form
            const form = document.getElementById('tikz-form');
            if (form && form.parentNode) {
                form.parentNode.insertBefore(section, form.nextSibling);
            }
            // Gán event handler
            const logBtn = document.getElementById('ajax-show-log-btn');
            const copyBtn = document.getElementById('ajax-copy-log-btn');
            if (logBtn) {
                logBtn.onclick = function() {
                    const log = document.getElementById('ajax-full-log');
                    if (log) {
                        if (log.style.display === 'none') {
                            log.style.display = 'block';
                            this.textContent = 'Ẩn chi tiết log';
                            if (copyBtn) copyBtn.style.display = 'inline-block';
                        } else {
                            log.style.display = 'none';
                            this.textContent = 'Hiển thị chi tiết log';
                            if (copyBtn) copyBtn.style.display = 'none';
                        }
                    }
                };
                console.log('Log button event handler attached');
            }
            if (copyBtn) {
                copyBtn.onclick = function() {
                    const log = document.getElementById('ajax-full-log');
                    if (log) {
                        navigator.clipboard.writeText(log.textContent)
                            .then(() => {
                                copyBtn.textContent = '✅ Đã copy!';
                                setTimeout(() => { copyBtn.textContent = 'Copy log'; }, 2000);
                            })
                            .catch(() => {
                                copyBtn.textContent = '❌ Lỗi copy!';
                                setTimeout(() => { copyBtn.textContent = 'Copy log'; }, 2000);
                            });
                    }
                };
            }
        }

        // Hàm AJAX mới để submit không reload trang
        async function submitTikzCodeAjax(event) {
            console.log('AJAX submit started'); // Debug
            event.preventDefault(); // Ngăn form submit bình thường
            
            // Kiểm tra đăng nhập
            if (!window.appState.loggedIn) {
                showLoginModal();
                return false;
            }

            // Lấy code từ CodeMirror
            const tikzCode = cleanControlChars(cm.getValue());
            if (!tikzCode.trim()) {
                alert('Vui lòng nhập code TikZ');
                return false;
            }

            // Hiển thị loading
            const compileBtn = document.getElementById('compile-btn');
            const originalText = compileBtn.textContent;
            compileBtn.textContent = 'Đang biên dịch...';
            compileBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('code', tikzCode);

                const response = await fetch('/', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    // KIỂM TRA LỖI CHÍNH XÁC HƠN
                    // 1. Kiểm tra trong preview-col trước
                    const previewColError = doc.querySelector('.preview-col .error');
                    // 2. Kiểm tra trong result-section 
                    const resultSectionError = doc.querySelector('.result-section .error');
                    // 3. Kiểm tra error độc lập
                    const standaloneError = doc.querySelector('.error');

                    // Debug để kiểm tra error detection
                    console.log('Checking for errors in response...');
                    console.log('Preview col error:', previewColError);
                    console.log('Result section error:', resultSectionError);
                    console.log('Standalone error:', standaloneError);

                    const errorElement = previewColError || resultSectionError || standaloneError;
                    if (errorElement) {
                        const msg = errorElement.innerHTML;
                        // Tìm full log trong cùng document
                        const fullLogEl = doc.getElementById('full-log');
                        const fullLog = fullLogEl ? fullLogEl.textContent : '';
                        console.log('Error detected:', msg);
                        console.log('Full log:', fullLog ? 'Yes' : 'No');
                        displayCompileError(msg, fullLog);
                        return;
                    }

                    // Cập nhật preview
                    const previewCol = document.querySelector('.preview-col');
                    const newPreviewCol = doc.querySelector('.preview-col');
                    if (previewCol && newPreviewCol) {
                        previewCol.innerHTML = newPreviewCol.innerHTML;
                    }

                    // Cập nhật result-tools-section và đảm bảo đặt bên ngoài .table-scroll-x
                    const tableScroll = document.querySelector('.table-scroll-x');
                    const mobileHint = document.getElementById('mobile-scroll-hint');
                    const resultToolsSection = document.getElementById('result-tools-section');
                    const newResultToolsSection = doc.getElementById('result-tools-section');
                    
                    if (newResultToolsSection) {
                        if (resultToolsSection) {
                            resultToolsSection.innerHTML = newResultToolsSection.innerHTML;
                            resultToolsSection.style.display = 'block';
                            // Di chuyển ra ngay sau mobile hint (nếu có), ngược lại ngay sau .table-scroll-x
                            if (mobileHint && mobileHint.parentNode) {
                                mobileHint.parentNode.insertBefore(resultToolsSection, mobileHint.nextSibling);
                            } else if (tableScroll && tableScroll.parentNode) {
                                tableScroll.parentNode.insertBefore(resultToolsSection, tableScroll.nextSibling);
                            }
                        } else {
                            // Tạo mới result-tools-section nếu chưa có và đặt sau mobile hint (nếu có) hoặc sau .table-scroll-x
                            const newSection = document.createElement('div');
                            newSection.id = 'result-tools-section';
                            newSection.innerHTML = newResultToolsSection.innerHTML;
                            if (mobileHint && mobileHint.parentNode) {
                                mobileHint.parentNode.insertBefore(newSection, mobileHint.nextSibling);
                            } else if (tableScroll && tableScroll.parentNode) {
                                tableScroll.parentNode.insertBefore(newSection, tableScroll.nextSibling);
                            } else {
                                // Fallback: thêm cuối body nếu không tìm thấy .table-scroll-x
                                document.body.appendChild(newSection);
                            }
                        }
                        // Ẩn hoặc xóa ajax-result-section nếu có
                        const ajaxResultSection = document.getElementById('ajax-result-section');
                        if (ajaxResultSection) {
                            ajaxResultSection.style.display = 'none';
                        }
                    } else if (resultToolsSection) {
                        resultToolsSection.style.display = 'none';
                    }

                    // Khởi tạo lại các event listeners cho các nút mới
                    initializeEventListeners();

                    // Khởi tạo lại CodeMirror cho textarea id="code"
                    ensureCodeMirror();
                    
                    // Debug: Kiểm tra nút save server có được gán event chưa
                    const saveServerBtn = document.getElementById('save-server-btn');
                    if (saveServerBtn) {
                        console.log('Save server button found after AJAX update');
                        console.log('Button onclick:', saveServerBtn.onclick);
                    } else {
                        console.log('Save server button not found after AJAX update');
                    }

                    // Hiện nút Lưu server sau khi biên dịch thành công
                    if (saveServerBtn && newResultToolsSection) {
                        // Lấy svg_temp_id mới từ nút export-btn hoặc từ DOM mới
                        const exportBtn = (document.getElementById('result-tools-section') || newResultToolsSection)?.querySelector('#export-btn');
                        if (exportBtn) {
                            const newFileId = exportBtn.getAttribute('data-file-id');
                            if (newFileId) saveServerBtn.setAttribute('data-file-id', newFileId);
                        }
                        // Lấy code TikZ mới từ CodeMirror
                        if (window.cm && typeof window.cm.getValue === 'function') {
                            saveServerBtn.setAttribute('data-tikz-code', window.cm.getValue());
                        }
                        saveServerBtn.style.display = 'inline-block';
                    }
                } else {
                    // Handle HTTP errors
                    try {
                        const errorData = await response.json();
                        displayCompileError(errorData.error || 'Lỗi khi biên dịch', errorData.error_log_full || '');
                    } catch (e) {
                        displayCompileError('Lỗi kết nối với server', '');
                    }
                }
            } catch (error) {
                console.error('AJAX Error:', error);
                displayCompileError('Có lỗi xảy ra khi biên dịch: ' + error.message, '');
            } finally {
                // Khôi phục nút
                compileBtn.textContent = originalText;
                compileBtn.disabled = false;
                console.log('AJAX submit completed'); // Debug
            }
            return false;
        }
        window.submitTikzCodeAjax = submitTikzCodeAjax;

            // BỎ VÒNG LẶP NÀY - Chỉ khởi tạo CodeMirror khi cần trong toggleTikzCode
            // document.querySelectorAll('.tikz-cm').forEach(function(textarea) {
            //     if (!textarea.CodeMirror) {
            //         CodeMirror.fromTextArea(textarea, {
            //             mode: 'stex',
            //             theme: 'material',
            //             lineNumbers: true,
            //             readOnly: true,
            //             viewportMargin: Infinity
            //         });
            //     }
            // });
        // Kết thúc initCodeMirrorAndBindings

        // (Đã loại bỏ khối highlight TikZ input cũ để tránh lỗi linter và trùng chức năng)

        // Hàm cập nhật preview real-time cho form nhập code
        async function updateInputPreview(tikzCode) {
            if (!tikzCode.trim()) {
                const previewContainer = document.querySelector('.col:last-child');
                if (previewContainer) {
                    previewContainer.innerHTML = '<div class="preview-placeholder"><p>Nhập code TikZ để xem preview real-time</p></div>';
                }
                return;
            }
            
            const previewContainer = document.querySelector('.col:last-child');
            if (previewContainer) {
                // Nếu đang có ảnh SVG preview, làm mờ ảnh thay vì ẩn
                const previewImg = previewContainer.querySelector('img');
                if (previewImg) {
                    previewImg.style.opacity = '0.5';
                    previewImg.alt = 'Đang cập nhật preview...';
                } else {
                    previewContainer.innerHTML = '<div class="preview-placeholder"><p>Đang cập nhật preview...</p></div>';
                }
            }
            
            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `code=${encodeURIComponent(tikzCode)}`
                });
                
                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Kiểm tra lỗi trước khi tìm SVG
                    const previewColError = doc.querySelector('.preview-col .error');
                    const resultSectionError = doc.querySelector('.result-section .error');
                    const standaloneError = doc.querySelector('.error');
                    
                    const errorElement = previewColError || resultSectionError || standaloneError;
                    if (errorElement) {
                        if (previewContainer) {
                            previewContainer.innerHTML = '<div class="preview-placeholder"><p>Code có lỗi - vui lòng sửa</p></div>';
                        }
                        return;
                    }
                    
                    // Tìm SVG trong preview-col
                    const newSvgUrl = doc.querySelector('.col:last-child img')?.src;
                    
                    if (newSvgUrl && previewContainer) {
                        // Nếu đã có img, chỉ cập nhật src và opacity
                        let previewImg = previewContainer.querySelector('img');
                        if (previewImg) {
                            previewImg.src = newSvgUrl;
                            previewImg.style.opacity = '1';
                            previewImg.alt = 'SVG Preview (Real-time)';
                        } else {
                            previewContainer.innerHTML = `<img src="${newSvgUrl}" alt="SVG Preview (Real-time)" style="width:100%;height:100%;object-fit:contain;display:block;">`;
                        }
                    } else if (previewContainer) {
                        previewContainer.innerHTML = '<div class="preview-placeholder"><p>Chưa có preview</p></div>';
                    }
                } else {
                    if (previewContainer) {
                        previewContainer.innerHTML = '<div class="preview-placeholder"><p>Lỗi khi tạo preview</p></div>';
                    }
                }
            } catch (error) {
                console.log('Input preview update failed:', error);
                if (previewContainer) {
                    previewContainer.innerHTML = '<div class="preview-placeholder"><p>Lỗi kết nối</p></div>';
                }
            }
        }

        // Hàm cập nhật preview real-time cho view mode
        async function updateRealTimePreview(tikzCode) {
            if (!tikzCode.trim()) return;
            
            const previewImg = document.getElementById('view-svg-img');
            if (previewImg) {
                previewImg.style.opacity = '0.5';
                previewImg.alt = 'Đang cập nhật preview...';
            }
            
            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `code=${encodeURIComponent(tikzCode)}`
                });
                
                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    // Tìm SVG trong preview-col thay vì svg-preview
                    const newSvgUrl = doc.querySelector('.preview-col img')?.src;
                    
                    if (newSvgUrl && previewImg) {
                        previewImg.src = newSvgUrl;
                        previewImg.style.opacity = '1';
                        previewImg.alt = 'SVG Preview (Real-time)';
                        
                        // Cập nhật link download và copy link cho preview mới
                        const downloadBtn = document.getElementById('view-download-svg-btn');
                        if (downloadBtn) {
                            downloadBtn.href = newSvgUrl;
                        }
                        
                        // Cập nhật sự kiện copy link cho preview mới
                        const copyLinkBtn = document.getElementById('view-copy-link-btn');
                        if (copyLinkBtn) {
                            copyLinkBtn.onclick = function() {
                                copyToClipboard(newSvgUrl, this, '🔗 Copy Link');
                            };
                        }
                    }
                }
            } catch (error) {
                console.log('Preview update failed:', error);
                if (previewImg) {
                    previewImg.style.opacity = '1';
                    previewImg.alt = 'SVG Preview';
                }
            }
        }

        function toggleTikzCode(btn) {
            try {
                const card = btn.closest('.file-card');
                if (!card) return;
                const codeBlock = card.querySelector('.tikz-code-block');
                const textarea = codeBlock ? codeBlock.querySelector('.tikz-cm') : null;
                if (!codeBlock || !textarea) return;

                const isHidden = window.getComputedStyle(codeBlock).display === 'none';
                if (isHidden) {
                    codeBlock.style.display = 'block';

                    let cmInstance = textarea.CodeMirror;
                    if (!cmInstance) {
                        const existingCm = codeBlock.querySelector('.CodeMirror');
                        if (existingCm) existingCm.remove();
                        cmInstance = CodeMirror.fromTextArea(textarea, {
                            mode: 'stex',
                            theme: 'material',
                            lineNumbers: true,
                            readOnly: true,
                            viewportMargin: Infinity,
                            scrollbarStyle: 'native'
                        });
                    }
                    setTimeout(() => cmInstance && cmInstance.refresh && cmInstance.refresh(), 80);
                    btn.innerHTML = 'Ẩn code TikZ';
                    // Đưa code block vào vùng nhìn thấy
                    codeBlock.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    codeBlock.style.display = 'none';
                    btn.innerHTML = '📝 Xem code TikZ';
                }
            } catch (err) {
                console.error('toggleTikzCode error:', err);
            }
        }
    </script>
    <!-- Highlight.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/latex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
    <script>
        // Initialize highlight.js sẽ được gọi trong init chính
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/stex/stex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/display/placeholder.min.js"></script>
    <script>
    // Hàm loại bỏ ký tự điều khiển (trừ \n, \t)
    function cleanControlChars(str) {
        return str.replace(/[^\x09\x0A\x20-\x7E\xA0-\uFFFF]/g, '');
    }
    </script>


    <script>
        // Global variables
        // window.isLoggedIn được khởi tạo từ window.appState.loggedIn
        window.isLoggedIn = window.appState.loggedIn;
        window.activeFeedbackCount = 0;
        
        // Suppress deprecated DOMNodeInserted warnings silently
        const originalAddEventListener = EventTarget.prototype.addEventListener;
        EventTarget.prototype.addEventListener = function(type, listener, options) {
            if (type === 'DOMNodeInserted' || type === 'DOMNodeRemoved' || type === 'DOMSubtreeModified') {
                // Silently suppress deprecated MutationEvents without logging
                return;
            }
            return originalAddEventListener.call(this, type, listener, options);
        };
        
// Kiểm tra trạng thái đăng nhập từ backend (không dùng trực tiếp để tránh linter)
// const isLoggedIn = {{ 'true' if user_email else 'false' }};
// Gán sự kiện cho các nút cần đăng nhập trong files-section (đã gộp vào init chính)
// ĐÃ GỘP VÀO INIT CHÍNH: phần dưới giữ lại để tương thích nhưng không thêm listener mới
(function initFilesSectionBindingsOnce() {
  // Logic cho nút "🔗 Copy Link" - cần đăng nhập
  document.querySelectorAll('.files-section .file-copy-link-btn').forEach(function(btn) {
    if (!window.appState.loggedIn) {
      // Lưu onclick gốc
      const originalOnclick = btn.getAttribute('onclick');
      btn.setAttribute('data-original-onclick', originalOnclick);
      btn.onclick = function(e) {
        e.preventDefault();
        showLoginModal();
      };
    }
  });
  
  // Logic cho nút "📝 Xem code TikZ" - cần đăng nhập
  document.querySelectorAll('.files-section .copy-btn[onclick*="toggleTikzCode"]').forEach(function(btn) {
    if (!window.appState.loggedIn) {
      // Lưu onclick gốc
      const originalOnclick = btn.getAttribute('onclick');
      btn.setAttribute('data-original-onclick', originalOnclick);
      btn.onclick = function(e) {
        e.preventDefault();
        showLoginModal();
      };
    }
  });
  
  // Logic cho nút "📋 Copy" trong tikz-code-block - cần đăng nhập
  document.querySelectorAll('.tikz-code-block .copy-btn[onclick*="copyTikzCode"]').forEach(function(btn) {
    if (!window.appState.loggedIn) {
      // Lưu onclick gốc
      const originalOnclick = btn.getAttribute('onclick');
      btn.setAttribute('data-original-onclick', originalOnclick);
      btn.onclick = function(e) {
        e.preventDefault();
        showLoginModal();
      };
    }
  });
  
  // Debug: Kiểm tra các nút có sẵn
  console.log('Kiểm tra các nút:');
  console.log('View buttons:', document.querySelectorAll('.files-section .view-btn').length);
  console.log('Copy link buttons:', document.querySelectorAll('.files-section .file-copy-link-btn').length);
  console.log('Copy buttons:', document.querySelectorAll('.files-section .copy-btn').length);
  console.log('Toggle TikZ buttons:', document.querySelectorAll('.files-section .copy-btn[onclick*="toggleTikzCode"]').length);
  console.log('Copy TikZ buttons:', document.querySelectorAll('.tikz-code-block .copy-btn[onclick*="copyTikzCode"]').length);
  
  // Cập nhật trạng thái nút nếu đã đăng nhập
  updateButtonStates();
  
  // Thêm sự kiện cho nút biên dịch nếu chưa đăng nhập
  const compileBtn = document.getElementById('compile-btn');
  if (compileBtn && !window.appState.loggedIn) {
    compileBtn.addEventListener('click', function(e) {
      e.preventDefault();
      showLoginModal();
    });
  }
  
  // Đảm bảo tất cả nút "🔗 Copy Link" đều có thông báo khi click
  document.querySelectorAll('.files-section .file-copy-link-btn').forEach(function(btn) {
    if (window.appState.loggedIn) {
      // Nếu đã đăng nhập, đảm bảo onclick có thông báo
      const currentOnclick = btn.getAttribute('onclick');
      if (currentOnclick && currentOnclick.includes('copyToClipboard')) {
        const url = currentOnclick.match(/copyToClipboard\('([^']+)'/)[1];
        btn.onclick = function() {
          copyToClipboard(url, this, '🔗 Copy Link');
        };
      }
    }
  });
  
  // Đảm bảo tất cả nút "📝 Xem code TikZ" đều hoạt động khi đã đăng nhập
  document.querySelectorAll('.files-section .copy-btn[onclick*="toggleTikzCode"]').forEach(function(btn) {
    if (window.appState.loggedIn) {
      // Nếu đã đăng nhập, đảm bảo onclick hoạt động
      btn.onclick = function() {
        toggleTikzCode(this);
      };
    }
  });
  
  // Đảm bảo tất cả nút "📋 Copy" trong tikz-code-block đều hoạt động khi đã đăng nhập
  document.querySelectorAll('.tikz-code-block .copy-btn[onclick*="copyTikzCode"]').forEach(function(btn) {
    if (window.appState.loggedIn) {
      // Nếu đã đăng nhập, đảm bảo onclick hoạt động
      btn.onclick = function() {
        copyTikzCode(this);
      };
    }
  });
})();
function showLoginModal() {
  document.getElementById('login-modal').style.display = 'flex';
}

// Hàm cập nhật trạng thái nút sau khi đăng nhập
function updateButtonStates() {
  if (window.appState.loggedIn) {
    // Nút "📸 Tải ảnh PNG/JPEG" đã được xử lý trong phần khởi tạo CodeMirror
    // Không cần xử lý ở đây vì event listener gốc đã có kiểm tra đăng nhập
    
    // Khôi phục nút "🔗 Copy Link" - khôi phục onclick gốc
    document.querySelectorAll('.files-section .file-copy-link-btn').forEach(function(btn) {
      const originalOnclick = btn.getAttribute('data-original-onclick');
      if (originalOnclick) {
        // Tạo lại onclick function để đảm bảo thông báo hiển thị
        const url = originalOnclick.match(/copyToClipboard\('([^']+)'/)[1];
        btn.onclick = function() {
          copyToClipboard(url, this, '🔗 Copy Link');
        };
        btn.removeAttribute('data-original-onclick');
      }
    });
    
    // Khôi phục nút "📝 Xem code TikZ" - KHÔNG CẦN KHÔI PHỤC NỮA VÌ toggleTikzCode ĐÃ TỰ KIỂM TRA
    // Function toggleTikzCode đã được cập nhật để tự kiểm tra trạng thái đăng nhập
    
    // Khôi phục nút "📋 Copy" trong tikz-code-block - KHÔNG CẦN KHÔI PHỤC NỮA VÌ copyTikzCode ĐÃ TỰ KIỂM TRA
    // Function copyTikzCode đã được cập nhật để tự kiểm tra trạng thái đăng nhập
    
    // Khôi phục CodeMirror - xóa sự kiện mousedown
    if (window.cm && typeof window.cm.off === 'function') {
      window.cm.off('mousedown');
    }
    
    // Khôi phục nút biên dịch - xóa sự kiện click
    const compileBtn = document.getElementById('compile-btn');
    if (compileBtn) {
      compileBtn.removeEventListener('click', showLoginModal);
    }
  }
}

// Thêm sự kiện click cho nút đăng nhập Google trong modal sẽ được gọi trong init chính
</script>
<script>
// Logout link sẽ được gán trong init chính
</script>

<!-- Modal nhập từ khóa Bootstrap -->
<div class="modal fade" id="keywordModal" tabindex="-1" aria-labelledby="keywordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="keywordModalLabel">Nhập mô tả / từ khóa</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Ảnh SVG preview -->
          <div id="modal-svg-preview">
            <img id="modal-svg-img" src="" alt="SVG Preview">
          </div>
          <p>Nhập các từ khóa, cách nhau bằng dấu phẩy:</p>
          <div class="position-relative">
            <textarea id="keywordsInput" class="form-control" rows="4" placeholder="Ví dụ: toán học, hình học, đồ thị"></textarea>
            <div id="keywordSuggestions" 
                 class="list-group position-absolute w-100" 
                 style="z-index:9999; max-height:200px; overflow-y:auto; display:none;"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-primary" id="confirmKeywordBtn">Xác nhận</button>
        </div>
      </div>
    </div>
  </div>
  

<!-- 
Script này xử lý logic lưu file SVG lên server với mô tả/từ khóa do người dùng nhập:

- Biến `pendingFileId` và `pendingTikzCode` lưu tạm thông tin file SVG cần lưu.
- Khi người dùng bấm nút "Lưu server" (`save-server-btn`):
    + Lấy `file_id` và `tikz_code` từ thuộc tính của nút.
    + Reset ô nhập từ khóa trong modal.
    + Hiện modal Bootstrap để người dùng nhập mô tả/từ khóa.
- Khi người dùng bấm "Xác nhận" trong modal (`confirmKeywordBtn`):
    + Lấy từ khóa người dùng nhập.
    + Kiểm tra có `file_id` chưa, nếu chưa thì báo lỗi.
    + Gửi POST request lên `/save_svg` với `file_id`, `tikz_code`, `keywords`.
    + Nếu lưu thành công thì báo thành công và reload về trang chủ, nếu lỗi thì báo lỗi.
    + Đóng modal sau khi gửi request.
-->
<script>
    // Biến lưu tạm thông tin file cần lưu (gán trong init chính)
    function initKeywordModal() {
        const confirmBtn = document.getElementById('confirmKeywordBtn');
        const keywordsInput = document.getElementById('keywordsInput');
        const suggestionsBox = document.getElementById('keywordSuggestions');

        let typingTimeout = null;

        // Khởi tạo biến global cho pending data
        window.pendingFileId = null;
        window.pendingTikzCode = "";

        // Khi gõ trong ô textarea → fetch gợi ý
        keywordsInput.addEventListener('input', function() {
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                const text = keywordsInput.value.trim();
                const parts = text.split(',');
                const lastPart = parts[parts.length - 1].trim();

                if (lastPart.length < 1) {
                    suggestionsBox.style.display = 'none';
                    return;
                }

                fetch(`/api/keywords/search?q=${encodeURIComponent(lastPart)}`)
                    .then(res => res.json())
                    .then(data => {
                        suggestionsBox.innerHTML = '';
                        if (data.length === 0) {
                            suggestionsBox.style.display = 'none';
                            return;
                        }

                        data.forEach(word => {
                            const item = document.createElement('button');
                            item.type = 'button';
                            item.className = 'list-group-item list-group-item-action';
                            item.textContent = word;
                            item.addEventListener('click', () => {
                                // Thay thế phần cuối bằng từ chọn
                                parts[parts.length - 1] = word;
                                keywordsInput.value = parts.map(s => s.trim()).filter(s => s).join(', ') + ', ';
                                suggestionsBox.style.display = 'none';
                                keywordsInput.focus();
                            });
                            suggestionsBox.appendChild(item);
                        });
                        suggestionsBox.style.display = 'block';
                    })
                    .catch(err => {
                        console.error(err);
                        suggestionsBox.style.display = 'none';
                    });
            }, 300);
        });

        // Click ngoài suggestion → ẩn
        document.addEventListener('click', function(event) {
            if (!keywordsInput.contains(event.target) && !suggestionsBox.contains(event.target)) {
                suggestionsBox.style.display = 'none';
            }
        });

        // Khi modal mở → load tất cả keywords để hiển thị suggestions
        const keywordModal = document.getElementById('keywordModal');
        if (keywordModal) {
            keywordModal.addEventListener('shown.bs.modal', function() {
                // Load tất cả keywords khi modal mở
                fetch('/api/keywords/search?q=')
                    .then(res => res.json())
                    .then(data => {
                        suggestionsBox.innerHTML = '';
                        if (data.length > 0) {
                            data.forEach(word => {
                                const item = document.createElement('button');
                                item.type = 'button';
                                item.className = 'list-group-item list-group-item-action';
                                item.textContent = word;
                                item.addEventListener('click', () => {
                                    const currentValue = keywordsInput.value.trim();
                                    const newValue = currentValue ? currentValue + ', ' + word : word;
                                    keywordsInput.value = newValue + ', ';
                                    suggestionsBox.style.display = 'none';
                                    keywordsInput.focus();
                                });
                                suggestionsBox.appendChild(item);
                            });
                            suggestionsBox.style.display = 'block';
                        }
                    })
                    .catch(err => {
                        console.error('Error loading keywords:', err);
                    });
            });
        }

        // Khi bấm nút "Xác nhận" trong modal
        if (confirmBtn) {
            confirmBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                const keywords = keywordsInput.value.trim();
                if (!keywords) {
                    alert('Vui lòng nhập ít nhất một từ khóa!');
                    keywordsInput.focus();
                    return;
                }

                if (!window.pendingFileId) {
                    alert("Lỗi: không có file_id!");
                    return;
                }

                fetch('/save_svg', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        file_id: window.pendingFileId,
                        tikz_code: window.pendingTikzCode,
                        keywords: keywords
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert("Đã lưu thành công!");
                        window.location.href = "/";
                    } else {
                        alert(data.error || "Có lỗi xảy ra!");
                    }
                })
                .catch(err => {
                    alert("Lỗi mạng hoặc server!");
                });

                const modal = bootstrap.Modal.getInstance(document.getElementById('keywordModal'));
                modal.hide();
            });
        }

        // ==== Load files ====
        const filesSection = document.querySelector('.files-section');
        if (filesSection && filesSection.dataset.isOwner === 'true') {
            loadFiles();
            startFilesPolling();
        } else {
            // Nếu chưa đăng nhập, load public files và vẫn polling
            loadFiles();
            startFilesPolling();
        }

        // ==== Initialize touch events for buttons ====
        initializeTouchBtnEvents();
        
        // ==== Initialize touch events for all users ====
        // Touch events đã được xử lý trong initializeTouchBtnEvents cho tất cả users

        // ==== Initialize CodeMirror ====
        // Kiểm tra xem CodeMirror đã được load chưa
        if (typeof CodeMirror !== 'undefined') {
            initializeCodeMirror();
        } else {
            // Thử lại sau 1 giây
            setTimeout(() => {
                if (typeof CodeMirror !== 'undefined') {
                    initializeCodeMirror();
                } else {
                    console.error('❌ CodeMirror failed to load');
                }
            }, 1000);
        }
        
        // ==== Initialize Facebook share buttons and copy link buttons ====
        // Khởi tạo cho cả user đã đăng nhập và chưa đăng nhập
        initializeFbShareButtons();
        initializeCopyLinkButtons();
        
        // ==== Start login status polling (kiểm tra trạng thái đăng nhập định kỳ) ====
        setInterval(() => {
            refreshLoginStatusAndLoadFiles();
        }, 30000); // Kiểm tra mỗi 30 giây
        
        // ==== Listen for login success events ====
        // Kiểm tra URL để xem có phải vừa đăng nhập thành công không
        if (window.location.search.includes('login_success=true')) {
            console.log('🔄 Login success detected, switching to private files...');
            setTimeout(() => {
                stopFilesPolling();
                refreshLoginStatusAndLoadFiles();
            }, 1000); // Delay 1 giây để đảm bảo session đã được cập nhật
        }
        
        // ==== Listen for page visibility changes ====
        // Khi user quay lại tab, kiểm tra trạng thái đăng nhập
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                console.log('🔄 Page became visible, checking login status...');
                refreshLoginStatusAndLoadFiles();
            }
        });
        
        // ==== Listen for focus events ====
        // Khi user focus vào window, kiểm tra trạng thái đăng nhập
        window.addEventListener('focus', () => {
            console.log('🔄 Window focused, checking login status...');
            refreshLoginStatusAndLoadFiles();
        });
        
        // ==== Listen for storage events (cross-tab login/logout) ====
        // Khi user đăng nhập/đăng xuất ở tab khác
        window.addEventListener('storage', (e) => {
            if (e.key === 'login_status') {
                console.log('🔄 Login status changed in another tab, refreshing...');
                stopFilesPolling();
                refreshLoginStatusAndLoadFiles();
            }
        });
        
        // ==== Listen for online/offline events ====
        // Khi kết nối mạng thay đổi, kiểm tra trạng thái đăng nhập
        window.addEventListener('online', () => {
            console.log('🔄 Network online, checking login status...');
            stopFilesPolling();
            refreshLoginStatusAndLoadFiles();
        });
        
        // ==== Listen for beforeunload events ====
        // Khi user sắp rời khỏi trang, lưu trạng thái
        window.addEventListener('beforeunload', () => {
            localStorage.setItem('login_status', window.isLoggedIn ? 'logged_in' : 'logged_out');
        });
        
        // ==== Check stored login status on page load ====
        // Kiểm tra trạng thái đăng nhập đã lưu
        const storedLoginStatus = localStorage.getItem('login_status');
        if (storedLoginStatus && storedLoginStatus !== (window.isLoggedIn ? 'logged_in' : 'logged_out')) {
            console.log('🔄 Stored login status differs from current, refreshing...');
            stopFilesPolling();
            refreshLoginStatusAndLoadFiles();
        }
        
        // ==== Initialize login status in localStorage ====
        // Khởi tạo trạng thái đăng nhập trong localStorage
        localStorage.setItem('login_status', window.isLoggedIn ? 'logged_in' : 'logged_out');
        
        // ==== Log initial state ====
        console.log('🔄 Initial login status:', window.isLoggedIn ? 'Logged in' : 'Not logged in');
        console.log('🔄 Loading files for:', window.isLoggedIn ? 'logged in user' : 'public access');
        console.log('🔄 Polling will be active for both logged in and public users');
    }

    // Refresh login status and load files if needed
    function refreshLoginStatusAndLoadFiles() {
        // Cập nhật trạng thái đăng nhập từ server
        fetch('/api/check_login_status')
            .then(response => response.json())
            .then(data => {
                const wasLoggedIn = window.isLoggedIn;
                window.isLoggedIn = data.logged_in;
                
                // Cập nhật localStorage
                localStorage.setItem('login_status', window.isLoggedIn ? 'logged_in' : 'logged_out');
                
                // Nếu trạng thái đăng nhập thay đổi, load files và restart polling
                if (!wasLoggedIn && window.isLoggedIn) {
                    console.log('🔄 User logged in, switching to private files...');
                    stopFilesPolling();
                    loadFiles(true); // Force load khi user vừa đăng nhập
                    startFilesPolling();
                } else if (wasLoggedIn && !window.isLoggedIn) {
                    console.log('🔄 User logged out, switching to public files...');
                    stopFilesPolling();
                    loadFiles(true); // Force load khi user vừa đăng xuất
                    startFilesPolling();
                }
            })
            .catch(error => {
                console.error('Error checking login status:', error);
            });
    }

    // Load files from API
    function loadFiles(forceLoad = false) {
        console.log('🔄 loadFiles called...', forceLoad ? '(forced)' : '');
        const container = document.getElementById('files-container');
        console.log('🔄 Container found:', !!container);
        
        // Kiểm tra flag toàn cục
        if (window.activeFeedbackCount > 0) {
            return;
        }
        
        // Chọn API endpoint dựa trên trạng thái đăng nhập
        const apiEndpoint = window.isLoggedIn ? '/api/files' : '/api/public/files';
        console.log('🔄 Using API endpoint:', apiEndpoint);
        
        fetch(apiEndpoint)
            .then(response => {
                console.log('🔄 Response status:', response.status);
                if (!response.ok) {
                    // Nếu đã kiểm tra đăng nhập trước đó, 401 không nên xảy ra
                    // Nhưng vẫn xử lý để đảm bảo an toàn
                    if (response.status === 401) {
                        console.log('🔄 Unexpected 401 response, user session may have expired');
                        container.innerHTML = `
                            <div class="no-files">
                                <div class="no-files-icon">🔒</div>
                                <h4>Phiên đăng nhập đã hết hạn</h4>
                                <p>Vui lòng đăng nhập lại để xem files đã lưu</p>
                            </div>
                        `;
                        return Promise.reject('Unauthorized'); // Prevent further processing
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Xử lý response format khác nhau giữa /api/files và /api/public/files
                const files = window.isLoggedIn ? data : (data.files || []);
                return files;
            })
            .then(files => {
                if (!files) return;
                
                if (files.length === 0) {
                    const noFilesMessage = window.isLoggedIn 
                        ? 'Hãy tạo và lưu một số file SVG để xem chúng ở đây'
                        : 'Hiện tại chưa có file SVG nào được chia sẻ công khai';
                    
                    container.innerHTML = `
                        <div class="no-files">
                            <div class="no-files-icon">📁</div>
                            <h4>Chưa có file nào</h4>
                            <p>${noFilesMessage}</p>
                        </div>
                    `;
                    return;
                }
                
                // Render files
                const filesHTML = files.map(file => `
                    <div class="file-card" data-file-id="${file.id}">
                      <button class="action-toggle-btn" type="button" aria-label="Hiện menu hành động">⋯</button>
                      <div class="file-info">
                        <div class="file-creator" style="margin-bottom: 0; font-size: 12px;">
                          👤 <a href="/profile/${file.creator_id}/svg-files" style="text-decoration: none; color: #1976d2; font-weight: 700; font-size: 13px;">
                            ${file.creator_username}
                          </a>
                          <span style="margin-left:8px; color: #666; font-size: 11px;">${file.created_time_vn || file.created_time}</span>
                        </div>
                      </div>
                      <div class="file-img-container">
                        <img src="${file.url}" alt="${file.filename}">
                        <div class="like-button-wrapper">
                          <div class="like-button">
                            <input id="heart-${file.id}" type="checkbox" ${file.is_liked_by_current_user ? 'checked' : ''} ${!window.isLoggedIn ? 'disabled' : ''} />
                            <label class="like" for="heart-${file.id}" ${!window.isLoggedIn ? 'style="opacity: 0.6; cursor: not-allowed;"' : ''}>
                              <svg class="like-icon" fill-rule="nonzero" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z"></path>
                              </svg>
                              <span class="like-text">Likes</span>
                            </label>
                            <span class="like-count one">${file.like_count}</span>
                            <span class="like-count two">${file.like_count}</span>
                          </div>
                        </div>
                      </div>
                      <div class="file-action-container">
                        <ul class="file-action-list">
                          <li class="file-action-item">
                            <button type="button" class="Btn" data-filename="${file.filename}" onclick="window.location.href='/view_svg/${file.filename}'">
                              <div class="sign">
                                <i class="fas fa-image logoIcon"></i>
                              </div>
                              <div class="text">Tải ảnh</div>
                            </button>
                          </li>
                         <li class="file-action-item">
                            <button type="button" class="Btn fb-share-btn" data-filename="${file.filename}" data-has-feedback="true">
                              <div class="sign">
                                <i class="fab fa-facebook logoIcon"></i>
                              </div>
                              <div class="text">Facebook</div>
                            </button>
                          </li>
                          <li class="file-action-item">
                            <button type="button" class="Btn file-copy-link-btn" data-url="https://tikz2svg.mathlib.io.vn/static/${file.filename}" data-has-feedback="true">
                              <div class="sign">
                                <i class="fas fa-link logoIcon"></i>
                              </div>
                              <div class="text">Copy Link</div>
                            </button>
                          </li>
                          ${file.tikz_code ? `
                          <li class="file-action-item">
                            <button type="button" class="Btn" onclick="toggleTikzCode(this)">
                              <div class="sign">
                                <i class="fas fa-code logoIcon"></i>
                              </div>
                              <div class="text">Xem Code</div>
                            </button>
                          </li>
                          ` : ''}

                        </ul>
                      </div>
                      
                      <!-- TikZ Code Section -->
                      ${file.tikz_code ? `
                      <div class="tikz-code-block" style="display:none; margin-top:10px;">
                        <div class="tikz-code-header">
                          <span>Code TikZ:</span>
                          <button class="copy-btn" onclick="copyTikzCode(this)">📋 Copy</button>
                        </div>
                        <div class="code-block">
                          <textarea class="tikz-cm" readonly>${file.tikz_code}</textarea>
                        </div>
                      </div>
                      ` : ''}
                    </div>
                `).join('');
                
                container.innerHTML = filesHTML;
                
                // Initialize like buttons for files (chỉ khi đã đăng nhập)
                if (window.isLoggedIn) {
                    initializeFileLikeButtons();
                }
                
                // Cập nhật currentFiles cho polling
                currentFiles = files;
                console.log('🔄 Updated currentFiles for polling:', currentFiles.length, 'files');
                
                // Note: Event delegation đã được setup trong DOMContentLoaded, 
                // nên không cần re-initialize cho các element mới được thêm vào
            })
            .catch(error => {
                console.error('Error loading files:', error);
                
                // Nếu đã xử lý 401 trong .then(), không hiển thị lại
                if (error === 'Unauthorized') {
                    return;
                }
                
                // Nếu force load và có lỗi, có thể user chưa đăng nhập thực sự
                if (forceLoad) {
                    console.log('🔄 Force load failed, checking login status...');
                    refreshLoginStatusAndLoadFiles();
                    return;
                }
                
                // Thông báo lỗi khác nhau cho user đã đăng nhập và chưa đăng nhập
                const errorMessage = window.isLoggedIn 
                    ? 'Không thể tải danh sách files của bạn. Vui lòng thử lại sau.'
                    : 'Không thể tải danh sách files công khai. Vui lòng thử lại sau.';
                
                container.innerHTML = `
                    <div class="no-files">
                        <div class="no-files-icon">❌</div>
                        <h4>Không thể tải danh sách files</h4>
                        <p>${errorMessage}</p>
                    </div>
                `;
            });
    }

    // Initialize like buttons for files
    function initializeFileLikeButtons() {
        // Chỉ khởi tạo like buttons nếu đã đăng nhập
        if (!window.isLoggedIn) {
            return;
        }
        
        // Initialize like buttons
        document.querySelectorAll('input[id^="heart-"]').forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                const fileId = this.id.replace('heart-', '');
                const isLiked = this.checked;
                const likeButton = this.closest('.like-button');
                const currentNumber = likeButton.querySelector('.like-count.one');
                const moveNumber = likeButton.querySelector('.like-count.two');
                
                // Prevent double click
                this.disabled = true;
                
                // Send AJAX request to backend
                fetch('/like_svg', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        svg_id: fileId,
                        action: isLiked ? 'like' : 'unlike'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update UI with new like count
                        const newCount = data.like_count;
                        currentNumber.textContent = newCount;
                        moveNumber.textContent = newCount;
                        
                        // Update checkbox state based on server response
                        this.checked = data.is_liked;
                        
                        console.log(`✅ File ${data.message}: ${newCount} likes`);
                    } else {
                        // Revert UI if backend failed
                        this.checked = !isLiked;
                        console.log(`❌ File ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Revert UI on error
                    this.checked = !isLiked;
                    alert('Có lỗi kết nối!');
                })
                .finally(() => {
                    this.disabled = false;
                });
            });
        });
    }

    // Global variable to store current files for polling comparison
    let currentFiles = [];
    let pollingInterval = null;
    
    // Real-time synchronization for files via polling
    function startFilesPolling() {
        console.log('🔄 Starting files polling...');
        const pollInterval = 15000; // 15 seconds
        
        pollingInterval = setInterval(function() {
            console.log('🔄 Polling files...', new Date().toLocaleTimeString());
            const container = document.getElementById('files-container');
            if (!container) {
                console.log('❌ Container not found, stopping polling');
                return;
            }
            
            // Kiểm tra flag toàn cục
            if (window.activeFeedbackCount > 0) {
                return;
            }
            
            // Chọn API endpoint dựa trên trạng thái đăng nhập
            const apiEndpoint = window.isLoggedIn ? '/api/files' : '/api/public/files';
            console.log('🔄 Polling API endpoint:', apiEndpoint);
            
            // Fetch updated files
            fetch(apiEndpoint)
                .then(response => {
                    console.log('🔄 API response status:', response.status);
                    if (!response.ok) {
                        if (response.status === 401) {
                            console.log('❌ User not logged in, switching to public API');
                            // Thử lại với public API
                            return fetch('/api/public/files');
                        }
                        throw new Error('Network response was not ok');
                    }
                    return response;
                })
                .then(response => {
                    if (!response) return null;
                    return response.json();
                })
                .then(data => {
                    if (!data) return;
                    
                    // Xử lý response format khác nhau
                    const files = window.isLoggedIn ? data : (data.files || []);
                    
                    // Check if there are new files or updates
                    const hasNewFiles = files.length !== currentFiles.length;
                    const hasUpdates = files.some((file, index) => {
                        const currentFile = currentFiles[index];
                        return !currentFile || 
                               currentFile.like_count !== file.like_count ||
                               (window.isLoggedIn && currentFile.is_liked_by_current_user !== file.is_liked_by_current_user);
                    });
                    
                    if (hasNewFiles || hasUpdates) {
                        console.log('🔄 Files updated, refreshing...');
                        loadFiles();
                    }
                })
                .catch(error => {
                    console.error('Files polling error:', error);
                });
        }, pollInterval);
        
        console.log('🔄 Started files polling (15s interval)');
    }
    
    // Function to stop polling
    function stopFilesPolling() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
            console.log('🔄 Stopped files polling');
        }
    }

    // Touch events for buttons (2-tap logic)
    function initializeTouchBtnEvents() {
        if (!document.documentElement.classList.contains('is-touch')) return;

        const originalHandlers = new Map();

        // Sử dụng event delegation thay vì gắn trực tiếp
        document.addEventListener('click', function(e) {
            // ==== Xử lý action-toggle-btn (nút ...) ====
            const actionToggleBtn = e.target.closest('.action-toggle-btn');
            if (actionToggleBtn) {
                const card = actionToggleBtn.closest('.file-card');
                if (card) {
                    // Đóng tất cả card khác
                    document.querySelectorAll('.file-card.active').forEach(other => {
                        if (other !== card) other.classList.remove('active');
                    });
                    // Toggle card hiện tại
                    card.classList.toggle('active');
                }
                return;
            }
            
            // ==== Xử lý các nút .Btn ====
            const btn = e.target.closest('.Btn');
            if (!btn) return;
            
            // Xử lý các nút .Btn trong card có class active
            if (btn.classList.contains('Btn')) {
                const card = btn.closest('.file-card');
                if (!card || !card.classList.contains('active')) return;

                // Lấy hoặc tạo tapCount
                if (!btn.dataset.tapCount) btn.dataset.tapCount = '0';
                
                const currentTapCount = parseInt(btn.dataset.tapCount);
                
                if (currentTapCount === 0) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();

                    // Reset các nút khác
                    card.querySelectorAll('.Btn').forEach(otherBtn => {
                        if (otherBtn !== btn) {
                            otherBtn.classList.remove('individual-active', 'ready-to-execute');
                            otherBtn.dataset.tapCount = '0';
                        }
                    });

                    btn.classList.add('individual-active', 'ready-to-execute');
                    btn.dataset.tapCount = '1';

                    // Auto reset sau 5s
                    setTimeout(() => {
                        if (btn.dataset.tapCount === '1') {
                            btn.classList.remove('individual-active', 'ready-to-execute');
                            btn.dataset.tapCount = '0';
                        }
                    }, 5000);
                    
                    return false;
                } 
                else if (currentTapCount === 1) {
                    // TAP 2: Execute action
                    
                    // Lấy onclick handler
                    let originalHandler;
                    const onclickAttr = btn.getAttribute('onclick');
                    if (onclickAttr) {
                        originalHandler = new Function(onclickAttr);
                    } else if (originalHandlers.has(btn)) {
                        originalHandler = originalHandlers.get(btn);
                    }

                    if (originalHandler) {
                        try {
                            originalHandler.call(btn, e);
                        } catch (error) {
                            console.error('Error executing handler:', error);
                        }
                    }

                    // ✅ Xử lý cho nút "Facebook" (không có onclick)
                    if (btn.classList.contains('fb-share-btn') && btn.hasAttribute('data-filename')) {
                        const filename = btn.getAttribute('data-filename');
                        const shareUrl = `${window.location.origin}/view_svg/${filename}`;
                        copyToClipboardWithCustomFeedback(shareUrl, btn, 'Facebook', 'Đã copy!');
                        
                        // Giữ feedback hiển thị 2 giây trước khi reset
                        setTimeout(() => {
                            btn.dataset.tapCount = '0';
                            btn.classList.remove('individual-active', 'ready-to-execute');
                        }, 2000);
                    }

                    // ✅ Xử lý cho nút "Copy Link" (không có onclick)
                    else if (btn.classList.contains('file-copy-link-btn') && btn.hasAttribute('data-url')) {
                        const url = btn.getAttribute('data-url');
                        copyToClipboard(url, btn);
                        
                        // Giữ feedback hiển thị 2 giây trước khi reset
                        setTimeout(() => {
                            btn.dataset.tapCount = '0';
                            btn.classList.remove('individual-active', 'ready-to-execute');
                        }, 2000);
                    }

                    // ✅ Thêm xử lý cho nút "Tải ảnh" (có onclick)
                    else if (btn.querySelector('.text')?.textContent === 'Tải ảnh') {
                        const filename = btn.getAttribute('data-filename');
                        if (filename) {
                            window.location.href = `/view_svg/${filename}`;
                        } else {
                            console.error('Không tìm thấy data-filename cho nút Tải ảnh');
                        }
                        // Reset trạng thái cho nút Tải ảnh ngay lập tức vì sẽ navigate
                        btn.dataset.tapCount = '0';
                        btn.classList.remove('individual-active', 'ready-to-execute');
                    }
                    
                    // ✅ Thêm xử lý cho nút "Xem Code"
                    else if (btn.querySelector('.text')?.textContent === 'Xem Code' || btn.querySelector('.text')?.textContent === 'Ẩn code') {
                        // Kiểm tra trạng thái đăng nhập
                        if (window.isLoggedIn) {
                            // Gọi function toggleTikzCode để hiển thị/ẩn code
                            toggleTikzCode(btn);
                        } else {
                            // Hiển thị modal đăng nhập cho user chưa đăng nhập
                            const loginModal = document.getElementById('login-modal');
                            if (loginModal) {
                                loginModal.style.display = 'flex';
                            } else {
                                // Fallback: redirect to login
                                window.location.href = '/login/google';
                            }
                        }
                        
                        // Giữ feedback hiển thị 1 giây trước khi reset
                        setTimeout(() => {
                            btn.dataset.tapCount = '0';
                            btn.classList.remove('individual-active', 'ready-to-execute');
                        }, 1000);
                    } 
                    else {
                        // Các nút khác: Kiểm tra trạng thái đăng nhập
                        if (!window.isLoggedIn) {
                            // Hiển thị modal đăng nhập cho user chưa đăng nhập
                            const loginModal = document.getElementById('login-modal');
                            if (loginModal) {
                                loginModal.style.display = 'flex';
                            } else {
                                // Fallback: redirect to login
                                window.location.href = '/login/google';
                            }
                        }
                        
                        // Giữ feedback hiển thị 1 giây trước khi reset
                        setTimeout(() => {
                            btn.dataset.tapCount = '0';
                            btn.classList.remove('individual-active', 'ready-to-execute');
                        }, 1000);
                    }
                    
                    return false;
                }
            }
        }, true); // Capture phase
    }

    // Function xử lý touch events đơn giản cho trường hợp chưa đăng nhập
    // Đã được gộp vào initializeTouchBtnEvents để xử lý cho tất cả users

    // Copy to clipboard functions
    function copyToClipboard(url, btn) {
        const card = btn.closest('.file-card');
        const actionContainer = card ? card.querySelector('.file-action-container') : null;
        
        // Kiểm tra xem có phải HTTPS hoặc localhost không
        const isSecureContext = window.isSecureContext || window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        // Thử sử dụng navigator.clipboard trước (chỉ khi có quyền)
        if (navigator.clipboard && isSecureContext) {
            navigator.clipboard.writeText(url).then(function() {
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = 'Đã copy!';
                    window.activeFeedbackCount++; // Tăng counter
                    setTimeout(() => { 
                        textDiv.textContent = 'Copy Link'; 
                        window.activeFeedbackCount--; // Giảm counter
                    }, 3000);
                }
            }).catch(function(err) {
                console.error('❌ Clipboard API failed:', err);
                console.log('🔄 Falling back to execCommand method');
                // Fallback to execCommand
                fallbackCopyToClipboard(url, btn);
            });
        } else {
            // Fallback cho các trình duyệt không hỗ trợ Clipboard API hoặc không có quyền
            console.log('🔄 Using fallback copy method (no clipboard permission)');
            fallbackCopyToClipboard(url, btn);
        }
    }

    function fallbackCopyToClipboard(url, btn) {
        console.log('🔄 Executing fallback copy method for URL:', url);
        
        const textArea = document.createElement('textarea');
        textArea.value = url;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        
        try {
            textArea.focus();
            textArea.select();
            console.log('🔄 Text selected, attempting to copy...');
            
            const successful = document.execCommand('copy');
            console.log('🔄 execCommand result:', successful);
            
            if (successful) {
                console.log('✅ Fallback copy successful');
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = 'Đã copy!';
                    window.activeFeedbackCount++; // Tăng counter
                    setTimeout(() => { 
                        textDiv.textContent = 'Copy Link'; 
                        window.activeFeedbackCount--; // Giảm counter
                    }, 3000);
                }
            } else {
                console.error('❌ execCommand copy failed');
                // Thử hiển thị feedback ngay cả khi copy thất bại
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = 'Copy thất bại';
                    setTimeout(() => { 
                        textDiv.textContent = 'Copy Link'; 
                    }, 3000);
                }
                alert('Không thể copy link. Vui lòng copy thủ công: ' + url);
            }
        } catch (err) {
            console.error('❌ execCommand copy error:', err);
            // Thử hiển thị feedback ngay cả khi có lỗi
            const textDiv = btn.querySelector('.text');
            if (textDiv) {
                textDiv.textContent = 'Copy thất bại';
                setTimeout(() => { 
                    textDiv.textContent = 'Copy Link'; 
                }, 3000);
            }
            alert('Không thể copy link. Vui lòng copy thủ công: ' + url);
        } finally {
            // Luôn cleanup textarea
            if (document.body.contains(textArea)) {
                document.body.removeChild(textArea);
            }
        }
    }

    function copyToClipboardWithCustomFeedback(url, btn, originalText, feedbackText) {
        const card = btn.closest('.file-card');
        const actionContainer = card ? card.querySelector('.file-action-container') : null;
        
        // Kiểm tra xem có phải HTTPS hoặc localhost không
        const isSecureContext = window.isSecureContext || window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        // Thử sử dụng navigator.clipboard trước (chỉ khi có quyền)
        if (navigator.clipboard && isSecureContext) {
            navigator.clipboard.writeText(url).then(function() {
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = feedbackText;
                    window.activeFeedbackCount++; // Tăng counter
                    
                    setTimeout(() => { 
                        textDiv.textContent = originalText; 
                        window.activeFeedbackCount--; // Giảm counter
                    }, 3000);
                }
            }).catch(function(err) {
                console.error('❌ Clipboard API failed (custom feedback):', err);
                // Fallback to execCommand
                fallbackCopyToClipboardWithCustomFeedback(url, btn, originalText, feedbackText);
            });
        } else {
            // Fallback cho các trình duyệt không hỗ trợ Clipboard API hoặc không có quyền
            console.log('🔄 Using fallback copy method with custom feedback (no clipboard permission)');
            fallbackCopyToClipboardWithCustomFeedback(url, btn, originalText, feedbackText);
        }
    }

    function fallbackCopyToClipboardWithCustomFeedback(url, btn, originalText, feedbackText) {
        const textArea = document.createElement('textarea');
        textArea.value = url;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            
            if (successful) {
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = feedbackText;
                    window.activeFeedbackCount++; // Tăng counter
                    
                    setTimeout(() => { 
                        textDiv.textContent = originalText; 
                        window.activeFeedbackCount--; // Giảm counter
                    }, 3000);
                }
            } else {
                console.error('❌ execCommand copy failed (custom feedback)');
                // Thử hiển thị feedback ngay cả khi copy thất bại
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = 'Copy thất bại';
                    setTimeout(() => { 
                        textDiv.textContent = originalText; 
                    }, 3000);
                }
                alert('Không thể copy link. Vui lòng copy thủ công: ' + url);
            }
        } catch (err) {
            console.error('❌ execCommand copy error (custom feedback):', err);
            // Thử hiển thị feedback ngay cả khi có lỗi
            const textDiv = btn.querySelector('.text');
            if (textDiv) {
                textDiv.textContent = 'Copy thất bại';
                setTimeout(() => { 
                    textDiv.textContent = originalText; 
                }, 3000);
            }
            alert('Không thể copy link. Vui lòng copy thủ công: ' + url);
        }
        
        document.body.removeChild(textArea);
    }

    // Toggle TikZ code function
    function toggleTikzCode(btn) {
        console.log('🔍 toggleTikzCode function called');
        console.log('🔍 btn:', btn);
        
        // Kiểm tra trạng thái đăng nhập trước khi hiển thị code
        if (!window.appState.loggedIn) {
            console.log('🔍 User not logged in, showing login modal');
            const loginModal = document.getElementById('login-modal');
            if (loginModal) {
                loginModal.style.display = 'flex';
            } else {
                window.location.href = '/login/google';
            }
            return;
        }
        
        const card = btn.closest('.file-card');
        const codeBlock = card.querySelector('.tikz-code-block');
        const textDiv = btn.querySelector('.text');
        
        console.log('🔍 card:', card);
        console.log('🔍 codeBlock:', codeBlock);
        console.log('🔍 textDiv:', textDiv);
        
        if (codeBlock.style.display === 'none' || !codeBlock.style.display) {
            codeBlock.style.display = 'block';
            textDiv.textContent = 'Ẩn code';
            
            // Initialize CodeMirror when showing the code block
            setTimeout(() => {
                const textarea = codeBlock.querySelector('.tikz-cm');
                
                if (textarea && !textarea.CodeMirror) {
                    const existingCm = codeBlock.querySelector('.CodeMirror');
                    if (existingCm) {
                        existingCm.remove();
                    }
                    
                    if (typeof CodeMirror !== 'undefined') {
                        try {
                            const cmInstance = CodeMirror.fromTextArea(textarea, {
                                mode: 'stex',
                                theme: 'material',
                                lineNumbers: true,
                                readOnly: true,
                                lineWrapping: true,
                                foldGutter: true,
                                gutters: ['CodeMirror-linenumbers'],
                                viewportMargin: Infinity
                            });
                            
                            // Refresh CodeMirror after a short delay
                            setTimeout(() => {
                                cmInstance.refresh();
                            }, 100);
                        } catch (error) {
                            console.error('❌ Error creating CodeMirror instance:', error);
                        }
                    } else {
                        console.error('❌ CodeMirror is not defined!');
                    }
                }
            }, 50);
        } else {
            codeBlock.style.display = 'none';
            textDiv.textContent = 'Xem Code';
        }
    }

    // Copy TikZ code function
    function copyTikzCode(btn) {
        // Kiểm tra trạng thái đăng nhập trước khi copy code
        if (!window.appState.loggedIn) {
            console.log('🔍 User not logged in, showing login modal');
            const loginModal = document.getElementById('login-modal');
            if (loginModal) {
                loginModal.style.display = 'flex';
            } else {
                window.location.href = '/login/google';
            }
            return;
        }
        
        const card = btn.closest('.file-card');
        const textarea = card.querySelector('.tikz-cm');
        
        // Lấy code từ CodeMirror instance nếu có, nếu không thì từ textarea gốc
        let code = textarea.value;
        
        // Ưu tiên lấy từ CodeMirror instance
        if (textarea.CodeMirror) {
            code = textarea.CodeMirror.getValue();
            console.log('Getting code from CodeMirror instance');
        } else {
            console.log('Getting code from original textarea');
        }
        
        // Kiểm tra xem có phải HTTPS hoặc localhost không
        const isSecureContext = window.isSecureContext || window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        if (navigator.clipboard && isSecureContext) {
            navigator.clipboard.writeText(code).then(function() {
                btn.textContent = 'Đã copy!';
                setTimeout(() => { 
                    btn.textContent = '📋 Copy'; 
                }, 2000);
            }).catch(function(err) {
                console.error('❌ Clipboard API failed:', err);
                fallbackCopyTikzCode(code, btn);
            });
        } else {
            console.log('🔄 Using fallback copy method for TikZ code (no clipboard permission)');
            fallbackCopyTikzCode(code, btn);
        }
    }

    function fallbackCopyTikzCode(code, btn) {
        const textArea = document.createElement('textarea');
        textArea.value = code;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                btn.textContent = 'Đã copy!';
                setTimeout(() => { 
                    btn.textContent = '📋 Copy'; 
                }, 2000);
            } else {
                alert('Không thể copy code. Vui lòng copy thủ công.');
            }
        } catch (err) {
            console.error('❌ execCommand copy error:', err);
            alert('Không thể copy code. Vui lòng copy thủ công.');
        }
        
        document.body.removeChild(textArea);
    }

    // Initialize CodeMirror for TikZ code blocks
    function initializeCodeMirror() {
        document.querySelectorAll('.tikz-cm').forEach(function(textarea) {
            if (!textarea.CodeMirror) {
                const codeBlock = textarea.closest('.tikz-code-block');
                if (codeBlock) {
                    const existingCm = codeBlock.querySelector('.CodeMirror');
                    if (existingCm) {
                        existingCm.remove();
                    }
                    
                    if (typeof CodeMirror !== 'undefined') {
                        try {
                            const cmInstance = CodeMirror.fromTextArea(textarea, {
                                mode: 'stex',
                                theme: 'material',
                                lineNumbers: true,
                                readOnly: true,
                                lineWrapping: true,
                                foldGutter: true,
                                gutters: ['CodeMirror-linenumbers'],
                                viewportMargin: Infinity
                            });
                            
                            // Refresh CodeMirror after a short delay
                            setTimeout(() => {
                                cmInstance.refresh();
                            }, 100);
                        } catch (error) {
                            console.error('❌ Error creating CodeMirror instance:', error);
                        }
                    } else {
                        console.error('❌ CodeMirror is not defined!');
                    }
                }
            } else {
                const cmInstance = textarea.CodeMirror;
                setTimeout(() => {
                    cmInstance.refresh();
                }, 100);
            }
        });
    }

    // Function to initialize Facebook share buttons
    function initializeFbShareButtons() {
        // Initialize Facebook share buttons for file cards
        const fbShareBtns = document.querySelectorAll('.file-card .fb-share-btn');
        console.log('🔄 Initializing: Found', fbShareBtns.length, 'file fb-share-btn buttons');
        
        // Cho phép hoạt động cho cả desktop và mobile, đã đăng nhập và chưa đăng nhập
        fbShareBtns.forEach(function(btn) {
            // Kiểm tra xem button có đang hiển thị feedback không
            const textDiv = btn.querySelector('.text');
            const isShowingFeedback = textDiv && textDiv.textContent === 'Đã copy!';
            
            if (!isShowingFeedback) {
                // Remove existing event listeners
                btn.replaceWith(btn.cloneNode(true));
                const newBtn = document.querySelector(`[data-filename="${btn.getAttribute('data-filename')}"]`);
                
                if (newBtn) {
                    newBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const filename = newBtn.getAttribute('data-filename');
                        console.log('🔄 fb-share-btn clicked, filename:', filename);
                        
                        if (!filename) {
                            console.error('❌ No filename found for fb-share-btn');
                            return;
                        }
                        
                        // Tạo Facebook share URL và copy vào clipboard
                        const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(`https://tikz2svg.mathlib.io.vn/static/${filename}`)}`;
                        copyToClipboardWithCustomFeedback(shareUrl, newBtn, 'Facebook', 'Đã copy!');
                    });
                }
            } else {
                console.log('🔄 Skipping fb-share-btn initialization - button is showing feedback');
            }
        });
    }

    // Function to initialize copy link buttons
    function initializeCopyLinkButtons() {
        const copyLinkBtns = document.querySelectorAll('.file-card .file-copy-link-btn');
        console.log('🔄 Initializing: Found', copyLinkBtns.length, 'file file-copy-link-btn buttons');
        
        // Cho phép hoạt động cho cả desktop và mobile, đã đăng nhập và chưa đăng nhập
        copyLinkBtns.forEach(function(btn) {
            // Thêm event listener nếu chưa có onclick attribute
            if (!btn.hasAttribute('onclick')) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const url = btn.getAttribute('data-url');
                    console.log('🔄 file-copy-link-btn clicked, url:', url);
                    
                    if (!url) {
                        console.error('❌ No URL found for file-copy-link-btn');
                        return;
                    }
                    
                    // Copy URL vào clipboard
                    copyToClipboard(url, this, 'Copy Link');
                });
            }
        });
    }

    // Re-initialize buttons after a short delay to ensure DOM is ready
    setTimeout(function() {
        initializeFbShareButtons();
        initializeCopyLinkButtons();
        
        // ==== Thêm logic cho Desktop buttons (cho cả đã đăng nhập và chưa đăng nhập) ====
        if (!document.documentElement.classList.contains('is-touch')) {
            console.log('🖥️ Adding Desktop button logic (for all users)');
            
            // Thêm event listener cho Desktop buttons
            document.addEventListener('click', function(e) {
                const btn = e.target.closest('.file-card .fb-share-btn, .file-card .file-copy-link-btn');
                if (!btn) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                if (btn.classList.contains('fb-share-btn')) {
                    const filename = btn.getAttribute('data-filename');
                    if (!filename) {
                        console.error('❌ No filename found for Desktop Facebook button');
                        return;
                    }
                    
                    const shareUrl = `${window.location.origin}/view_svg/${filename}`;
                    console.log('🖥️ Desktop Facebook Share URL:', shareUrl);
                    
                    // Sử dụng function copyToClipboard với custom feedback
                    copyToClipboardWithCustomFeedback(shareUrl, btn, 'Facebook', 'Đã copy!');
                    
                    console.log('✅ Desktop Facebook button: Link copied successfully');
                } else if (btn.classList.contains('file-copy-link-btn')) {
                    const url = btn.getAttribute('data-url');
                    if (!url) {
                        console.error('❌ No URL found for Desktop Copy Link button');
                        return;
                    }
                    
                    console.log('🖥️ Desktop Copy Link URL:', url);
                    
                    // Sử dụng function copyToClipboard
                    copyToClipboard(url, btn);
                    
                    console.log('✅ Desktop Copy Link button: Link copied successfully');
                }
            });
        }
    }, 100);

    // Đóng menu khi click bên ngoài
    document.addEventListener('click', function (e) {
        const activeCard = document.querySelector('.file-card.active');
        if (activeCard) {
            if (activeCard.dataset.preventClose === 'true') {
                return;
            }
            
            if (!activeCard.contains(e.target) && !e.target.closest('.Btn') && !e.target.closest('.action-toggle-btn')) {
                activeCard.classList.remove('active');
            }
        }
    });

    // ========== MAIN INITIALIZER: Gộp tất cả DOMContentLoaded vào đây ==========
    document.addEventListener('DOMContentLoaded', function() {
        // 1) Touch device detection
        if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
            document.documentElement.classList.add('is-touch');
        }

        // 2) Load SVG files
        loadSvgFiles();

        // 3) Mobile menu
        const menuToggle = document.getElementById('menu-toggle');
        const mobileMenu = document.getElementById('mobile-menu');
        const closeMenu = document.getElementById('close-menu');
        if (menuToggle && mobileMenu && closeMenu) {
            menuToggle.addEventListener('click', () => mobileMenu.classList.remove('hidden'));
            closeMenu.addEventListener('click', () => mobileMenu.classList.add('hidden'));
            mobileMenu.addEventListener('click', e => { if (e.target === mobileMenu) mobileMenu.classList.add('hidden'); });
        }

        // 4) Header login state + pending view svg injection
        updateHeaderLoginState();

        // 5) Setup require-login bindings, common listeners
        setupRequireLogin();
        initializeEventListeners();

        // 6) Smooth scroll hint + touch scroll (theo cấu trúc table-scroll-x)
        (function setupHorizontalScrollUX() {
            const mobileHint = document.getElementById('mobile-scroll-hint');
            const scrollHost = document.querySelector('.table-scroll-x');
            function showMobileScrollHint() {
                if (!mobileHint || !scrollHost) return;
                const isMobile = window.innerWidth <= 768;
                const hasScroll = scrollHost.scrollWidth > scrollHost.clientWidth;
                if (isMobile && hasScroll) {
                    mobileHint.style.display = 'block';
                    setTimeout(() => { mobileHint.style.opacity = '0.7'; }, 3000);
                    setTimeout(() => { mobileHint.style.display = 'none'; }, 8000);
                } else {
                    mobileHint.style.display = 'none';
                }
            }
            showMobileScrollHint();
            window.addEventListener('resize', showMobileScrollHint);
            if (scrollHost) {
                let isScrolling = false, startX = 0, scrollLeft = 0;
                scrollHost.addEventListener('touchstart', function(e) {
                    isScrolling = true;
                    startX = e.touches[0].pageX - scrollHost.offsetLeft;
                    scrollLeft = scrollHost.scrollLeft;
                }, { passive: true });
                scrollHost.addEventListener('touchmove', function(e) {
                    if (!isScrolling) return;
                    const x = e.touches[0].pageX - scrollHost.offsetLeft;
                    const walk = (x - startX) * 2;
                    scrollHost.scrollLeft = scrollLeft - walk;
                }, { passive: true });
                scrollHost.addEventListener('touchend', function() { isScrolling = false; }, { passive: true });
            }
        })();

        // 7) Init CodeMirror + preview real-time
        if (typeof initCodeMirrorAndBindings === 'function') {
            initCodeMirrorAndBindings();
        }

        // 8) Init highlight.js
        if (window.hljs) {
            hljs.highlightAll();
            if (hljs.initLineNumbersOnLoad) hljs.initLineNumbersOnLoad();
        }

        // 9) Modal login button
        const modalLoginBtn = document.getElementById('modal-login-btn');
        if (modalLoginBtn) {
            modalLoginBtn.addEventListener('click', function() {
                window.location.href = "{{ url_for('google.login') }}";
            });
        }

        // 10) Logout link
        const logoutLink = document.getElementById('logout-link');
        if (logoutLink) {
            logoutLink.addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = '/logout?next=/';
            });
        }

        // 11) Keyword modal behaviors
        if (typeof initKeywordModal === 'function') {
            initKeywordModal();
        }

        // 12) Touch events đã được xử lý trong initializeTouchBtnEvents cho tất cả users
        console.log('🔄 Touch events initialized for all users');

        console.log('DOMContentLoaded - appState.loggedIn:', window.appState && window.appState.loggedIn);

        // Nếu có code TikZ từ localStorage (từ View Mode), điền vào textarea chính
        // Thực thi sau khi tất cả đã được khởi tạo
        setTimeout(() => {
            const tikzFromStorage = localStorage.getItem('tikz_code_for_compile');
            if (tikzFromStorage) {
                console.log('Found tikz_code_for_compile in localStorage:', tikzFromStorage);
                // Điền code vào textarea chính
                if (window.cm && typeof window.cm.setValue === 'function') {
                    window.cm.setValue(tikzFromStorage);
                    console.log('Code set to CodeMirror successfully');
                } else {
                    const textarea = document.getElementById('code');
                    if (textarea) {
                        textarea.value = tikzFromStorage;
                        console.log('Code set to textarea successfully');
                    }
                }
                // Xóa dữ liệu đã sử dụng
                localStorage.removeItem('tikz_code_for_compile');
                console.log('tikz_code_for_compile removed from localStorage');
            }
        }, 100); // Delay 100ms để đảm bảo CodeMirror đã sẵn sàng
    });

    // Sau khi login → ép reload để đồng bộ session
    if (window.location.search.includes('login=1')) {
        window.location.href = window.location.pathname;
    }

</script>

    
    

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Hàm khởi tạo lại CodeMirror cho textarea id="code" -->
    <script>
        function ensureCodeMirror() {
            const textarea = document.getElementById('code');
            if (!textarea) return;
            // Nếu đã có CodeMirror instance, không khởi tạo lại
            if (textarea.nextSibling && textarea.nextSibling.classList && textarea.nextSibling.classList.contains('CodeMirror')) {
                return;
            }
            window.cm = CodeMirror.fromTextArea(textarea, {
                mode: 'stex',
                theme: 'material',
                lineNumbers: true,
                placeholder: 'Nhập code TikZ tại đây...'
            });
        }
    </script>

    <!-- ... trong submitTikzCodeAjax, sau khi cập nhật previewCol và resultToolsSection ... -->
    <!-- Thêm dòng này sau khi cập nhật DOM: -->
    <!-- ensureCodeMirror(); -->
</body>
</html>
