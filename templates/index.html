<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TikZ to SVG</title>
    <!-- Highlight.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material.min.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- File Card CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/file_card.css', v='1.1') }}">
    
    <!-- Navigation CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navigation.css', v='1.0') }}">
    
    <!-- Index Page CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css', v='1.0') }}">
    












</head>
<body>
    {% include '_navbar.html' %}
    
    <!-- Search Bar -->
    <div class="container" style="margin-top: 20px; margin-bottom: 20px; overflow: visible;">
        <div class="search-container" style="display: flex; justify-content: center; align-items: center; gap: 20px;">
            <h3 class="search-title">T√¨m ki·∫øm ·∫£nh SVG</h3>
            <div class="group">
                <svg viewBox="0 0 24 24" aria-hidden="true" class="icon">
                    <g>
                        <path d="M21.53 20.47l-3.66-3.66C19.195 15.24 20 13.214 20 11c0-4.97-4.03-9-9-9s-9 4.03-9 9 4.03 9 9 9c2.215 0 4.24-.804 5.808-2.13l3.66 3.66c.147.146.34.22.53.22s.385-.073.53-.22c.295-.293.295-.767.002-1.06zM3.5 11c0-4.135 3.365-7.5 7.5-7.5s7.5 3.365 7.5 7.5-3.365 7.5-7.5 7.5-7.5-3.365-7.5-7.5z"></path>
                    </g>
                </svg>
                <input class="input" type="search" placeholder="T√¨m ki·∫øm..." id="main-search-input" />
                <div id="search-suggestions" class="search-suggestions" style="display: none;"></div>
            </div>
        </div>
    </div>
    
    <!-- Block 2: Input-Preview Section -->
    <div class="input-preview-section container">
            <h2>Chuy·ªÉn ƒë·ªïi TikZ sang SVG/PNG/JPEG</h2>

            <!-- Truy·ªÅn tr·∫°ng th√°i login t·ª´ server v√†o JS (ƒë·ªÉ linter kh√¥ng b√°o l·ªói) -->
            <script id="app-state" type="application/json">{{ {
              'loggedIn': logged_in,
              'userEmail': user_email,
              'username': username,
              'avatar': avatar
            } | tojson | safe }}</script>
            <!-- Gi√° tr·ªã TikZ ban ƒë·∫ßu ƒë·ªÉ kh·ªüi t·∫°o CodeMirror -->
            <script id="initial-tikz" type="application/json">{{ tikz_code|default('')|tojson|safe }}</script>
            <script>
              window.appState = JSON.parse(document.getElementById('app-state').textContent);
            </script>

        <div class="table-scroll-x">
          <div class="table-content">
            <div class="col">
              <form id="tikz-form" method="post" onsubmit="console.log('Form submit event'); return submitTikzCodeAjax(event)">
                <textarea name="code" id="code" rows="12" placeholder="Nh·∫≠p code TikZ t·∫°i ƒë√¢y...">{{ tikz_code|default('') }}</textarea>
                <div class="d-flex justify-content-end align-items-center gap-2" id="compile-save-row">
                  <button type="submit" id="compile-btn" class="compile-save-row-btn" {% if not logged_in %}title="B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p Google ƒë·ªÉ s·ª≠ d·ª•ng"{% endif %}>Bi√™n d·ªãch</button>
                  <button
                    type="button"
                    id="save-server-btn"
                    class="compile-save-row-btn"
                    data-file-id="{{ svg_temp_id }}"
                    data-tikz-code="{{ tikz_code | e }}"
                    style="display: none;"
                  >
                    üíæ L∆∞u server
                  </button>
                </div>
              </form>
            </div>
            <div class="col">
              {% if error %}
                <div class="error">{{ error|safe }}</div>
              {% elif svg_temp_url %}
                <img src="{{ svg_temp_url }}" alt="SVG Preview" style="width:100%;height:100%;object-fit:contain;display:block;">
              {% else %}
                <div class="preview-placeholder">
                  <p>Nh·∫≠p code TikZ ƒë·ªÉ xem preview real-time</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
        <!-- Th√¥ng b√°o h∆∞·ªõng d·∫´n cho mobile -->
        <p id="mobile-scroll-hint" style="margin-top: 12px; color: #777; font-size: 0.9em; text-align: center; display: none;">
          üì± Tr√™n ƒëi·ªán tho·∫°i, vu·ªët ngang ƒë·ªÉ xem ƒë·ªß 2 c·ªôt
        </p>





{# Th√™m block n√†y NGAY SAU form, TR∆Ø·ªöC result-tools-section #}
{% if error %}
    <div class="result-section">
        <div class="error">{{ error|safe }}
            {% if error_log_full %}
                <br><button id="show-log-btn" style="margin-top:10px; background:#b71c1c; color:white; border:none; border-radius:4px; padding:6px 16px; cursor:pointer;">Hi·ªÉn th·ªã chi ti·∫øt log</button>
                <pre id="full-log" style="display:none; background:#fff0f0; color:#b71c1c; border:1px solid #f5c6cb; border-radius:4px; padding:12px; margin-top:10px; max-height:400px; overflow:auto;">{{ error_log_full }}</pre>
                <script>
                document.getElementById('show-log-btn').onclick = function() {
                    var log = document.getElementById('full-log');
                    if (log.style.display === 'none') {
                        log.style.display = 'block';
                        this.textContent = '·∫®n chi ti·∫øt log';
                    } else {
                        log.style.display = 'none';
                        this.textContent = 'Hi·ªÉn th·ªã chi ti·∫øt log';
                    }
                };
                </script>
            {% endif %}
        </div>
    </div>
{% endif %}

        {% if svg_temp_url and not error %}
    </div> <!-- ƒë√≥ng .input-preview-section tr∆∞·ªõc khi tools -->
    
    <div id="result-tools-section" class="container" style="margin-top: 16px;">
                <div class="export-section">
                    <h4>Xu·∫•t ·∫£nh PNG/JPEG</h4>
                    <form id="export-form" class="export-form">
                        <div class="export-pair">
                            <label for="export-format" class="export-label">ƒê·ªãnh d·∫°ng:</label>
                            <select id="export-format" class="export-input export-select">
                                <option value="png">PNG</option>
                                <option value="jpeg">JPEG</option>
                            </select>
                        </div>
                        <div class="export-pair">
                            <label for="export-dpi" class="export-label">DPI:</label>
                            <input type="number" id="export-dpi" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-pair">
                            <label for="export-width" class="export-label">Width (px):</label>
                            <input type="number" id="export-width" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-pair">
                            <label for="export-height" class="export-label">Height (px):</label>
                            <input type="number" id="export-height" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-btn-group">
                            <button id="export-btn" type="button" class="export-btn" data-file-id="{{ svg_temp_id }}">T·∫£i xu·ªëng</button>
                        </div>
                    </form>
                    <div id="export-msg" style="margin-top:5px; color:#388e3c;"></div>
                </div>

                {% if svg_content %}
                    <div class="code-section">
                        <button id="toggle-svg-code-btn" class="copy-btn" type="button">üìú Xem code SVG</button>
                        <div id="svg-code-container" style="display:none; margin-top:12px;">
                            <div class="code-header">
                                <span class="code-title">Code SVG:</span>
                                <button id="copy-svg-code-btn" class="copy-btn" type="button">üìã Copy Code</button>
                            </div>
                            <div class="code-block" id="svgCode">
                                <pre><code class="language-xml">{{ svg_content }}</code></pre>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        {% else %}
    </div> <!-- ƒë√≥ng .input-preview-section -->
        {% endif %}
    
    <!-- Block 3: Files Section -->
    <div class="files-section-container container files-section" data-is-owner="{{ 'true' if logged_in else 'false' }}">
        <h3 style="color:#1976d2; margin-bottom:24px;">üìÅ Files ƒë√£ l∆∞u</h3>
        <div id="files-container" class="files-grid">
            {% if svg_files %}
                {% for file in svg_files %}
                    {% include '_file_card.html' %}
                {% endfor %}
            {% else %}
                <div class="no-files">
                    <div class="no-files-icon">üìÅ</div>
                    <h4>Ch∆∞a c√≥ files n√†o</h4>
                    <p>H√£y t·∫°o file SVG ƒë·∫ßu ti√™n c·ªßa b·∫°n!</p>
                </div>
            {% endif %}
        </div>
    </div>

    <footer style='text-align:center;color:#888;font-size:14px;margin-top:40px;'>¬© 2024 TikZ2SVG - All rights reserved.</footer>

    <!-- Modal ƒëƒÉng nh·∫≠p cho n√∫t "Xem Code" -->
    <div id="login-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center;">
      <div style="background:white; padding:32px 40px; border-radius:12px; box-shadow:0 2px 16px rgba(0,0,0,0.15); min-width:320px; text-align:center;">
        <h3 style="margin-bottom:24px;">ƒêƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y</h3>
        <p style="margin-bottom:16px; color:#666;">Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ c√≥ th·ªÉ:</p>
        <ul style="margin-bottom:24px; color:#666; text-align:left; display:inline-block;">
          <li>üëÅÔ∏è Xem TikZ code</li>
          <li>üëç Like v√† unlike ·∫£nh</li>
          <li>üíæ L∆∞u ·∫£nh v√†o server</li>
          <li>üë• Theo d√µi ng∆∞·ªùi d√πng kh√°c</li>
        </ul>
        <p style="margin-bottom:24px; color:#1976d2; font-weight:500;">üí° B·∫°n v·∫´n c√≥ th·ªÉ s·ª≠ d·ª•ng Facebook Share v√† Copy Link m√† kh√¥ng c·∫ßn ƒëƒÉng nh·∫≠p!</p>
        
        <!-- Container cho c√°c n√∫t - cƒÉn gi·ªØa -->
        <div style="display:flex; justify-content:center; align-items:center; gap:12px; flex-wrap:wrap;">
          <button id="modal-login-btn" class="google-login-btn" style="margin:0;">
            <span class="google-login-content">
              <svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid" viewBox="0 0 256 262">
                <path fill="#4285F4" d="M255.878 133.451c0-10.734-.871-18.567-2.756-26.69H130.55v48.448h71.947c-1.45 12.04-9.283 30.172-26.69 42.356l-.244 1.622 38.755 30.023 2.685.268c24.659-22.774 38.875-56.282 38.875-96.027"></path>
                <path fill="#34A853" d="M130.55 261.1c35.248 0 64.839-11.605 86.453-31.622l-41.196-31.913c-11.024 7.688-25.82 13.055-45.257 13.055-34.523 0-63.824-22.773-74.269-54.25l-1.531.13-40.298 31.187-.527 1.465C35.393 231.798 79.49 261.1 130.55 261.1"></path>
                <path fill="#FBBC05" d="M56.281 156.37c-2.756-8.123-4.351-16.827-4.351-25.82 0-8.994 1.595-17.697 4.206-25.82l-.073-1.73L15.26 71.312l-1.335.635C5.077 89.644 0 109.517 0 130.55s5.077 40.905 13.925 58.602l42.356-32.782"></path>
                <path fill="#EB4335" d="M130.55 50.479c24.514 0 41.05 10.589 50.479 19.438l36.844-35.974C195.245 12.91 165.798 0 130.55 0 79.49 0 35.393 29.301 13.925 71.947l42.211 32.783c10.59-31.477 39.891-54.251 74.414-54.251"></path>
              </svg>
              ƒêƒÉng nh·∫≠p Google
            </span>
          </button>
          <button onclick="document.getElementById('login-modal').style.display='none'" style="background:#eee; color:#333; padding:12px 24px; border-radius:6px; border:none; font-weight:bold; margin:0;">Hu·ª∑</button>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- JavaScript Functions -->
    <script>
        // Function ƒë·ªÉ ƒëƒÉng nh·∫≠p v·ªõi Google
        function loginWithGoogle() {
            window.location.href = "{{ url_for('google.login') }}";
        }

        // File cards are now rendered server-side using Jinja2 partials
        // No need for loadSvgFiles() function anymore

        // Like functionality is now handled by file_card.js
        // No need for handleLikeClick() and setupFileCardButtons() functions anymore



        function updateHeaderLoginState() {
            // Logic m·ªõi: Header ƒë√£ ƒë∆∞·ª£c render t·ª´ server v·ªõi avatar/username
            // Ch·ªâ c·∫ßn x·ª≠ l√Ω c√°c logic b·ªï sung
            
            if (window.appState.loggedIn) {
                // Button states ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong file_card.js
                
                // Ki·ªÉm tra xem c√≥ ·∫£nh SVG ƒëang ch·ªù hi·ªÉn th·ªã sau khi ƒëƒÉng nh·∫≠p kh√¥ng

            }
        }

        // Function setupRequireLogin ƒë√£ ƒë∆∞·ª£c move v√†o file_card.js

        // H√†m kh·ªüi t·∫°o event listeners cho c√°c n√∫t
        // Function initializeEventListeners ƒë√£ ƒë∆∞·ª£c move v√†o file_card.js

        var cm; // Khai b√°o global ƒë·ªÉ c√°c h√†m kh√°c truy c·∫≠p ƒë∆∞·ª£c
        // Function copyToClipboard ƒë√£ ƒë∆∞·ª£c move v√†o file_card.js

        function copySvgCode() {
            const codeBlock = document.getElementById('svgCode');
            const copyBtn = document.querySelector('.copy-btn');
            copyToClipboard(codeBlock.textContent, copyBtn, 'üìã Copy Code');
        }

        // Function copyTikzCode ƒë√£ ƒë∆∞·ª£c move v√†o file_card.js

        

        // Kh·ªüi t·∫°o CodeMirror s·∫Ω ƒë∆∞·ª£c g·ªçi trong init ch√≠nh
        function initCodeMirrorAndBindings() {
            var tikzCode = document.getElementById('code');
            cm = CodeMirror.fromTextArea(tikzCode, {
                mode: 'stex',
                theme: 'material',
                lineNumbers: true,
                lineWrapping: true,
                placeholder: 'Nh·∫≠p code TikZ t·∫°i ƒë√¢y...'
            });
            // Gi√° tr·ªã ban ƒë·∫ßu t·ª´ server
            try {
                cm.setValue(JSON.parse(document.getElementById('initial-tikz')?.textContent || '""'));
            } catch(e) {
                cm.setValue('');
            }
            
            // Th√™m s·ª± ki·ªán click v√†o CodeMirror ƒë·ªÉ hi·ªán modal ƒëƒÉng nh·∫≠p n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
            if (!window.appState.loggedIn) {
                cm.on('mousedown', function() {
                    showLoginModal();
                });
            }
            
            // Th√™m s·ª± ki·ªán real-time preview cho form nh·∫≠p code
            let inputPreviewTimer;
            cm.on('change', function() {
                clearTimeout(inputPreviewTimer);
                inputPreviewTimer = setTimeout(() => {
                    updateInputPreview(cm.getValue());
                }, 1000); // Delay 1 gi√¢y sau khi ng·ª´ng g√µ
            });
            

            // S·ª± ki·ªán copy link Facebook
            document.querySelectorAll('.fb-share-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const filename = btn.getAttribute('data-filename');
                    const shareUrl = `${window.location.origin}/view_svg/${filename}`;
                    const textArea = document.createElement('textarea');
                    textArea.value = shareUrl;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = 0;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    btn.innerHTML = '‚úÖ ƒê√£ copy link Facebook!';
                    setTimeout(() => {
                        btn.innerHTML = 'üü¶ Copy link Facebook';
                    }, 2000);
                });
            });


            
            // Kh·ªüi t·∫°o preview n·∫øu c√≥ code TikZ ban ƒë·∫ßu
            const initialCode = cm.getValue();
            if (initialCode && initialCode.trim()) {
                updateInputPreview(initialCode);
            }
        }

        // Hi·ªÉn th·ªã l·ªói bi√™n d·ªãch TikZ, k√®m log chi ti·∫øt n·∫øu c√≥
        function displayCompileError(message, fullLog) {
            console.log('displayCompileError called with:', { message, hasFullLog: !!fullLog });
            // X√≥a T·∫§T C·∫¢ error sections c≈©
            document.querySelectorAll('.result-section, #result-section, #ajax-result-section').forEach(el => {
                if (el.querySelector('.error') || el.querySelector('#ajax-show-log-btn')) {
                    el.remove();
                }
            });
            // N·∫øu kh√¥ng c√≥ log chi ti·∫øt th√¨ ch·ªâ hi·ªán text l·ªói chung
            const section = document.createElement('div');
            section.id = 'ajax-result-section';
            section.className = 'result-section';
            let html = `<div class=\"error\">L·ªói khi bi√™n d·ªãch!</div>`;
            if (fullLog && fullLog.trim()) {
                html += `<button id=\"ajax-show-log-btn\" style=\"margin-top:10px; background:#b71c1c; color:white; border:none; border-radius:4px; padding:6px 16px; cursor:pointer;\">Hi·ªÉn th·ªã chi ti·∫øt log</button>`;
                html += `<button id=\"ajax-copy-log-btn\" style=\"display:none; margin-left:10px; background:#ffc107; color:#212529; border:none; border-radius:4px; padding:6px 16px; cursor:pointer; font-weight:bold;\">Copy log</button>`;
                html += `<pre id=\"ajax-full-log\" style=\"display:none; background:#fff0f0; color:#b71c1c; border:1px solid #f5c6cb; border-radius:4px; padding:12px; margin-top:10px; max-height:400px; overflow:auto;\">${fullLog}</pre>`;
            }
            section.innerHTML = html;
            // Insert OUTSIDE the scroll area: sau .table-scroll-x v√† sau mobile hint
            const tableScroll = document.querySelector('.table-scroll-x');
            const mobileHint = document.getElementById('mobile-scroll-hint');
            if (tableScroll && tableScroll.parentNode) {
                if (mobileHint && mobileHint.parentNode) {
                    // Insert error section sau mobile hint
                    mobileHint.parentNode.insertBefore(section, mobileHint.nextSibling);
                } else {
                    // Insert error section sau table-scroll-x
                    tableScroll.parentNode.insertBefore(section, tableScroll.nextSibling);
                }
            } else {
                // Fallback: sau form
                const form = document.getElementById('tikz-form');
                if (form && form.parentNode) {
                    form.parentNode.insertBefore(section, form.nextSibling);
                } else {
                    document.body.appendChild(section);
                }
            }
            // G√°n event handler
            const logBtn = document.getElementById('ajax-show-log-btn');
            const copyBtn = document.getElementById('ajax-copy-log-btn');
            if (logBtn) {
                logBtn.onclick = function() {
                    const log = document.getElementById('ajax-full-log');
                    if (log) {
                        if (log.style.display === 'none') {
                            log.style.display = 'block';
                            this.textContent = '·∫®n chi ti·∫øt log';
                            if (copyBtn) copyBtn.style.display = 'inline-block';
                        } else {
                            log.style.display = 'none';
                            this.textContent = 'Hi·ªÉn th·ªã chi ti·∫øt log';
                            if (copyBtn) copyBtn.style.display = 'none';
                        }
                    }
                };
                console.log('Log button event handler attached');
            }
            if (copyBtn) {
                copyBtn.onclick = function() {
                    const log = document.getElementById('ajax-full-log');
                    if (log) {
                        navigator.clipboard.writeText(log.textContent)
                            .then(() => {
                                copyBtn.textContent = '‚úÖ ƒê√£ copy!';
                                setTimeout(() => { copyBtn.textContent = 'Copy log'; }, 2000);
                            })
                            .catch(() => {
                                copyBtn.textContent = '‚ùå L·ªói copy!';
                                setTimeout(() => { copyBtn.textContent = 'Copy log'; }, 2000);
                            });
                    }
                };
            }
        }

        // H√†m AJAX m·ªõi ƒë·ªÉ submit kh√¥ng reload trang
        async function submitTikzCodeAjax(event) {
            console.log('AJAX submit started'); // Debug
            event.preventDefault(); // NgƒÉn form submit b√¨nh th∆∞·ªùng
            
            // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
            if (!window.appState.loggedIn) {
                showLoginModal();
                return false;
            }

            // L·∫•y code t·ª´ CodeMirror
            const tikzCode = cleanControlChars(cm.getValue());
            if (!tikzCode.trim()) {
                alert('Vui l√≤ng nh·∫≠p code TikZ');
                return false;
            }

            // Hi·ªÉn th·ªã loading
            const compileBtn = document.getElementById('compile-btn');
            const originalText = compileBtn.textContent;
            compileBtn.textContent = 'ƒêang bi√™n d·ªãch...';
            compileBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('code', tikzCode);

                const response = await fetch('/', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    // KI·ªÇM TRA L·ªñI CH√çNH X√ÅC H∆†N
                    // 1. Ki·ªÉm tra trong preview-col tr∆∞·ªõc
                    const previewColError = doc.querySelector('.preview-col .error');
                    // 2. Ki·ªÉm tra trong result-section 
                    const resultSectionError = doc.querySelector('.result-section .error');
                    // 3. Ki·ªÉm tra error ƒë·ªôc l·∫≠p
                    const standaloneError = doc.querySelector('.error');

                    // Debug ƒë·ªÉ ki·ªÉm tra error detection
                    console.log('Checking for errors in response...');
                    console.log('Preview col error:', previewColError);
                    console.log('Result section error:', resultSectionError);
                    console.log('Standalone error:', standaloneError);

                    const errorElement = previewColError || resultSectionError || standaloneError;
                    if (errorElement) {
                        const msg = errorElement.innerHTML;
                        // T√¨m full log trong c√πng document
                        const fullLogEl = doc.getElementById('full-log');
                        const fullLog = fullLogEl ? fullLogEl.textContent : '';
                        console.log('Error detected:', msg);
                        console.log('Full log:', fullLog ? 'Yes' : 'No');
                        displayCompileError(msg, fullLog);
                        return;
                    }

                    // C·∫≠p nh·∫≠t preview
                    const previewCol = document.querySelector('.preview-col');
                    const newPreviewCol = doc.querySelector('.preview-col');
                    if (previewCol && newPreviewCol) {
                        previewCol.innerHTML = newPreviewCol.innerHTML;
                    }

                    // C·∫≠p nh·∫≠t result-tools-section v√† ƒë·∫£m b·∫£o ƒë·∫∑t b√™n ngo√†i .table-scroll-x
                    const tableScroll = document.querySelector('.table-scroll-x');
                    const mobileHint = document.getElementById('mobile-scroll-hint');
                    const resultToolsSection = document.getElementById('result-tools-section');
                    const newResultToolsSection = doc.getElementById('result-tools-section');
                    
                    if (newResultToolsSection) {
                        if (resultToolsSection) {
                            resultToolsSection.innerHTML = newResultToolsSection.innerHTML;
                            resultToolsSection.style.display = 'block';
                            // Di chuy·ªÉn ra ngay sau mobile hint (n·∫øu c√≥), ng∆∞·ª£c l·∫°i ngay sau .table-scroll-x
                            if (mobileHint && mobileHint.parentNode) {
                                mobileHint.parentNode.insertBefore(resultToolsSection, mobileHint.nextSibling);
                            } else if (tableScroll && tableScroll.parentNode) {
                                tableScroll.parentNode.insertBefore(resultToolsSection, tableScroll.nextSibling);
                            }
                        } else {
                            // T·∫°o m·ªõi result-tools-section n·∫øu ch∆∞a c√≥ v√† ƒë·∫∑t sau mobile hint (n·∫øu c√≥) ho·∫∑c sau .table-scroll-x
                            const newSection = document.createElement('div');
                            newSection.id = 'result-tools-section';
                            newSection.innerHTML = newResultToolsSection.innerHTML;
                            if (mobileHint && mobileHint.parentNode) {
                                mobileHint.parentNode.insertBefore(newSection, mobileHint.nextSibling);
                            } else if (tableScroll && tableScroll.parentNode) {
                                tableScroll.parentNode.insertBefore(newSection, tableScroll.nextSibling);
                            } else {
                                // Fallback: th√™m cu·ªëi body n·∫øu kh√¥ng t√¨m th·∫•y .table-scroll-x
                                document.body.appendChild(newSection);
                            }
                        }
                        // ·∫®n ho·∫∑c x√≥a ajax-result-section n·∫øu c√≥
                        const ajaxResultSection = document.getElementById('ajax-result-section');
                        if (ajaxResultSection) {
                            ajaxResultSection.style.display = 'none';
                        }
                    } else if (resultToolsSection) {
                        resultToolsSection.style.display = 'none';
                    }

                    // Event listeners ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong file_card.js

                    // Kh·ªüi t·∫°o l·∫°i CodeMirror cho textarea id="code"
                    ensureCodeMirror();
                    
                    // Debug: Ki·ªÉm tra n√∫t save server c√≥ ƒë∆∞·ª£c g√°n event ch∆∞a
                    const saveServerBtn = document.getElementById('save-server-btn');
                    if (saveServerBtn) {
                        console.log('Save server button found after AJAX update');
                        console.log('Button onclick:', saveServerBtn.onclick);
                    } else {
                        console.log('Save server button not found after AJAX update');
                    }

                    // Hi·ªán n√∫t L∆∞u server sau khi bi√™n d·ªãch th√†nh c√¥ng
                    if (saveServerBtn && newResultToolsSection) {
                        // L·∫•y svg_temp_id m·ªõi t·ª´ n√∫t export-btn ho·∫∑c t·ª´ DOM m·ªõi
                        const exportBtn = (document.getElementById('result-tools-section') || newResultToolsSection)?.querySelector('#export-btn');
                        if (exportBtn) {
                            const newFileId = exportBtn.getAttribute('data-file-id');
                            if (newFileId) saveServerBtn.setAttribute('data-file-id', newFileId);
                        }
                        // L·∫•y code TikZ m·ªõi t·ª´ CodeMirror
                        if (window.cm && typeof window.cm.getValue === 'function') {
                            saveServerBtn.setAttribute('data-tikz-code', window.cm.getValue());
                        }
                        saveServerBtn.style.display = 'inline-block';
                    }
                } else {
                    // Handle HTTP errors
                    try {
                        const errorData = await response.json();
                        displayCompileError(errorData.error || 'L·ªói khi bi√™n d·ªãch', errorData.error_log_full || '');
                    } catch (e) {
                        displayCompileError('L·ªói k·∫øt n·ªëi v·ªõi server', '');
                    }
                }
            } catch (error) {
                console.error('AJAX Error:', error);
                displayCompileError('C√≥ l·ªói x·∫£y ra khi bi√™n d·ªãch: ' + error.message, '');
            } finally {
                // Kh√¥i ph·ª•c n√∫t
                compileBtn.textContent = originalText;
                compileBtn.disabled = false;
                console.log('AJAX submit completed'); // Debug
            }
            return false;
        }
        window.submitTikzCodeAjax = submitTikzCodeAjax;

            // B·ªé V√íNG L·∫∂P N√ÄY - Ch·ªâ kh·ªüi t·∫°o CodeMirror khi c·∫ßn trong toggleTikzCode
            // document.querySelectorAll('.tikz-cm').forEach(function(textarea) {
            //     if (!textarea.CodeMirror) {
            //         CodeMirror.fromTextArea(textarea, {
            //             mode: 'stex',
            //             theme: 'material',
            //             lineNumbers: true,
            //             readOnly: true,
            //             viewportMargin: Infinity
            //         });
            //     }
            // });
        // K·∫øt th√∫c initCodeMirrorAndBindings

        // (ƒê√£ lo·∫°i b·ªè kh·ªëi highlight TikZ input c≈© ƒë·ªÉ tr√°nh l·ªói linter v√† tr√πng ch·ª©c nƒÉng)

        // H√†m c·∫≠p nh·∫≠t preview real-time cho form nh·∫≠p code
        async function updateInputPreview(tikzCode) {
            if (!tikzCode.trim()) {
                const previewContainer = document.querySelector('.col:last-child');
                if (previewContainer) {
                    previewContainer.innerHTML = '<div class="preview-placeholder"><p>Nh·∫≠p code TikZ ƒë·ªÉ xem preview real-time</p></div>';
                }
                return;
            }
            
            const previewContainer = document.querySelector('.col:last-child');
            if (previewContainer) {
                // N·∫øu ƒëang c√≥ ·∫£nh SVG preview, l√†m m·ªù ·∫£nh thay v√¨ ·∫©n
                const previewImg = previewContainer.querySelector('img');
                if (previewImg) {
                    previewImg.style.opacity = '0.5';
                    previewImg.alt = 'ƒêang c·∫≠p nh·∫≠t preview...';
                } else {
                    previewContainer.innerHTML = '<div class="preview-placeholder"><p>ƒêang c·∫≠p nh·∫≠t preview...</p></div>';
                }
            }
            
            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `code=${encodeURIComponent(tikzCode)}`
                });
                
                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Ki·ªÉm tra l·ªói tr∆∞·ªõc khi t√¨m SVG
                    const previewColError = doc.querySelector('.preview-col .error');
                    const resultSectionError = doc.querySelector('.result-section .error');
                    const standaloneError = doc.querySelector('.error');
                    
                    const errorElement = previewColError || resultSectionError || standaloneError;
                    if (errorElement) {
                        if (previewContainer) {
                            previewContainer.innerHTML = '<div class="preview-placeholder"><p>Code c√≥ l·ªói - vui l√≤ng s·ª≠a</p></div>';
                        }
                        return;
                    }
                    
                    // T√¨m SVG trong preview-col
                    const newSvgUrl = doc.querySelector('.col:last-child img')?.src;
                    
                    if (newSvgUrl && previewContainer) {
                        // N·∫øu ƒë√£ c√≥ img, ch·ªâ c·∫≠p nh·∫≠t src v√† opacity
                        let previewImg = previewContainer.querySelector('img');
                        if (previewImg) {
                            previewImg.src = newSvgUrl;
                            previewImg.style.opacity = '1';
                            previewImg.alt = 'SVG Preview (Real-time)';
                        } else {
                            previewContainer.innerHTML = `<img src="${newSvgUrl}" alt="SVG Preview (Real-time)" style="width:100%;height:100%;object-fit:contain;display:block;">`;
                        }
                    } else if (previewContainer) {
                        previewContainer.innerHTML = '<div class="preview-placeholder"><p>Ch∆∞a c√≥ preview</p></div>';
                    }
                } else {
                    if (previewContainer) {
                        previewContainer.innerHTML = '<div class="preview-placeholder"><p>L·ªói khi t·∫°o preview</p></div>';
                    }
                }
            } catch (error) {
                console.log('Input preview update failed:', error);
                if (previewContainer) {
                    previewContainer.innerHTML = '<div class="preview-placeholder"><p>L·ªói k·∫øt n·ªëi</p></div>';
                }
            }
        }

        // H√†m c·∫≠p nh·∫≠t preview real-time cho view mode
        async function updateRealTimePreview(tikzCode) {
            if (!tikzCode.trim()) return;
            
            const previewImg = document.getElementById('view-svg-img');
            if (previewImg) {
                previewImg.style.opacity = '0.5';
                previewImg.alt = 'ƒêang c·∫≠p nh·∫≠t preview...';
            }
            
            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `code=${encodeURIComponent(tikzCode)}`
                });
                
                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    // T√¨m SVG trong preview-col thay v√¨ svg-preview
                    const newSvgUrl = doc.querySelector('.preview-col img')?.src;
                    
                    if (newSvgUrl && previewImg) {
                        previewImg.src = newSvgUrl;
                        previewImg.style.opacity = '1';
                        previewImg.alt = 'SVG Preview (Real-time)';
                        
                        // C·∫≠p nh·∫≠t link download v√† copy link cho preview m·ªõi
                        const downloadBtn = document.getElementById('view-download-svg-btn');
                        if (downloadBtn) {
                            downloadBtn.href = newSvgUrl;
                        }
                        
                        // C·∫≠p nh·∫≠t s·ª± ki·ªán copy link cho preview m·ªõi
                        const copyLinkBtn = document.getElementById('view-copy-link-btn');
                        if (copyLinkBtn) {
                            copyLinkBtn.onclick = function() {
                                copyToClipboard(newSvgUrl, this, 'üîó Copy Link');
                            };
                        }
                    }
                }
            } catch (error) {
                console.log('Preview update failed:', error);
                if (previewImg) {
                    previewImg.style.opacity = '1';
                    previewImg.alt = 'SVG Preview';
                }
            }
        }

        // Function toggleTikzCode ƒë√£ ƒë∆∞·ª£c move v√†o file_card.js
    </script>
    <!-- Highlight.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/latex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
    <script>
        // Initialize highlight.js s·∫Ω ƒë∆∞·ª£c g·ªçi trong init ch√≠nh
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/stex/stex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/display/placeholder.min.js"></script>
    
    <!-- File Card JavaScript (includes search results functionality) - Load tr∆∞·ªõc DOMContentLoaded -->
    <script src="{{ url_for('static', filename='js/file_card.js', v='1.2') }}"></script>
    <script>
    // H√†m lo·∫°i b·ªè k√Ω t·ª± ƒëi·ªÅu khi·ªÉn (tr·ª´ \n, \t)
    function cleanControlChars(str) {
        return str.replace(/[^\x09\x0A\x20-\x7E\xA0-\uFFFF]/g, '');
    }
    </script>


    <script>
        // Global variables
        // window.isLoggedIn ƒë∆∞·ª£c kh·ªüi t·∫°o t·ª´ window.appState.loggedIn
        window.isLoggedIn = window.appState.loggedIn;
        window.activeFeedbackCount = 0;
        
        // Suppress deprecated DOMNodeInserted warnings silently
        const originalAddEventListener = EventTarget.prototype.addEventListener;
        EventTarget.prototype.addEventListener = function(type, listener, options) {
            if (type === 'DOMNodeInserted' || type === 'DOMNodeRemoved' || type === 'DOMSubtreeModified') {
                // Silently suppress deprecated MutationEvents without logging
                return;
            }
            return originalAddEventListener.call(this, type, listener, options);
        };
        
// Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p t·ª´ backend (kh√¥ng d√πng tr·ª±c ti·∫øp ƒë·ªÉ tr√°nh linter)
// const isLoggedIn = {{ 'true' if user_email else 'false' }};
// G√°n s·ª± ki·ªán cho c√°c n√∫t c·∫ßn ƒëƒÉng nh·∫≠p trong files-section (ƒë√£ g·ªôp v√†o init ch√≠nh)
// ƒê√É G·ªòP V√ÄO INIT CH√çNH: ph·∫ßn d∆∞·ªõi gi·ªØ l·∫°i ƒë·ªÉ t∆∞∆°ng th√≠ch nh∆∞ng kh√¥ng th√™m listener m·ªõi
(function initFilesSectionBindingsOnce() {
  // Logic cho buttons ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong file_card.js v·ªõi data-action pattern
  
  // Debug: Ki·ªÉm tra c√°c n√∫t c√≥ s·∫µn (ƒë√£ ƒë∆∞·ª£c thay th·∫ø b·∫±ng data-action pattern)
  console.log('üîç File cards s·ª≠ d·ª•ng data-action pattern, kh√¥ng c·∫ßn debug c≈©');
  
  // Button states ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong file_card.js
  
  // Th√™m s·ª± ki·ªán cho n√∫t bi√™n d·ªãch n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
  const compileBtn = document.getElementById('compile-btn');
  if (compileBtn && !window.appState.loggedIn) {
    compileBtn.addEventListener('click', function(e) {
      e.preventDefault();
      showLoginModal();
    });
  }
  
  // Button logic ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong file_card.js v·ªõi data-action pattern
})();
function showLoginModal() {
  document.getElementById('login-modal').style.display = 'flex';
}

// Function updateButtonStates ƒë√£ ƒë∆∞·ª£c move v√†o file_card.js

// Th√™m s·ª± ki·ªán click cho n√∫t ƒëƒÉng nh·∫≠p Google trong modal s·∫Ω ƒë∆∞·ª£c g·ªçi trong init ch√≠nh
</script>
<script>
// Logout link s·∫Ω ƒë∆∞·ª£c g√°n trong init ch√≠nh
</script>

<!-- Modal nh·∫≠p t·ª´ kh√≥a Bootstrap -->
<div class="modal fade" id="keywordModal" tabindex="-1" aria-labelledby="keywordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="keywordModalLabel">Nh·∫≠p m√¥ t·∫£ / t·ª´ kh√≥a</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- ·∫¢nh SVG preview -->
          <div id="modal-svg-preview">
            <img id="modal-svg-img" src="" alt="SVG Preview">
          </div>
          <p>Nh·∫≠p c√°c t·ª´ kh√≥a, c√°ch nhau b·∫±ng d·∫•u ph·∫©y:</p>
          <div class="position-relative">
            <textarea id="keywordsInput" class="form-control" rows="4" placeholder="V√≠ d·ª•: to√°n h·ªçc, h√¨nh h·ªçc, ƒë·ªì th·ªã"></textarea>
            <div id="keywordSuggestions" 
                 class="list-group position-absolute w-100" 
                 style="z-index:9999; max-height:200px; overflow-y:auto; display:none;"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" class="btn btn-primary" id="confirmKeywordBtn">X√°c nh·∫≠n</button>
        </div>
      </div>
    </div>
  </div>
  

<!-- 
Script n√†y x·ª≠ l√Ω logic l∆∞u file SVG l√™n server v·ªõi m√¥ t·∫£/t·ª´ kh√≥a do ng∆∞·ªùi d√πng nh·∫≠p:

- Bi·∫øn `pendingFileId` v√† `pendingTikzCode` l∆∞u t·∫°m th√¥ng tin file SVG c·∫ßn l∆∞u.
- Khi ng∆∞·ªùi d√πng b·∫•m n√∫t "L∆∞u server" (`save-server-btn`):
    + L·∫•y `file_id` v√† `tikz_code` t·ª´ thu·ªôc t√≠nh c·ªßa n√∫t.
    + Reset √¥ nh·∫≠p t·ª´ kh√≥a trong modal.
    + Hi·ªán modal Bootstrap ƒë·ªÉ ng∆∞·ªùi d√πng nh·∫≠p m√¥ t·∫£/t·ª´ kh√≥a.
- Khi ng∆∞·ªùi d√πng b·∫•m "X√°c nh·∫≠n" trong modal (`confirmKeywordBtn`):
    + L·∫•y t·ª´ kh√≥a ng∆∞·ªùi d√πng nh·∫≠p.
    + Ki·ªÉm tra c√≥ `file_id` ch∆∞a, n·∫øu ch∆∞a th√¨ b√°o l·ªói.
    + G·ª≠i POST request l√™n `/save_svg` v·ªõi `file_id`, `tikz_code`, `keywords`.
    + N·∫øu l∆∞u th√†nh c√¥ng th√¨ b√°o th√†nh c√¥ng v√† reload v·ªÅ trang ch·ªß, n·∫øu l·ªói th√¨ b√°o l·ªói.
    + ƒê√≥ng modal sau khi g·ª≠i request.
-->
<script>
    // Bi·∫øn l∆∞u t·∫°m th√¥ng tin file c·∫ßn l∆∞u (g√°n trong init ch√≠nh)
    function initKeywordModal() {
        const confirmBtn = document.getElementById('confirmKeywordBtn');
        const keywordsInput = document.getElementById('keywordsInput');
        const suggestionsBox = document.getElementById('keywordSuggestions');

        let typingTimeout = null;

        // Kh·ªüi t·∫°o bi·∫øn global cho pending data
        window.pendingFileId = null;
        window.pendingTikzCode = "";

        // Khi g√µ trong √¥ textarea ‚Üí fetch g·ª£i √Ω
        keywordsInput.addEventListener('input', function() {
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                const text = keywordsInput.value.trim();
                const parts = text.split(',');
                const lastPart = parts[parts.length - 1].trim();

                if (lastPart.length < 1) {
                    suggestionsBox.style.display = 'none';
                    return;
                }

                fetch(`/api/keywords/search?q=${encodeURIComponent(lastPart)}`)
                    .then(res => res.json())
                    .then(data => {
                        suggestionsBox.innerHTML = '';
                        if (data.length === 0) {
                            suggestionsBox.style.display = 'none';
                            return;
                        }

                        data.forEach(word => {
                            const item = document.createElement('button');
                            item.type = 'button';
                            item.className = 'list-group-item list-group-item-action';
                            item.textContent = word;
                            item.addEventListener('click', () => {
                                // Thay th·∫ø ph·∫ßn cu·ªëi b·∫±ng t·ª´ ch·ªçn
                                parts[parts.length - 1] = word;
                                keywordsInput.value = parts.map(s => s.trim()).filter(s => s).join(', ') + ', ';
                                suggestionsBox.style.display = 'none';
                                keywordsInput.focus();
                            });
                            suggestionsBox.appendChild(item);
                        });
                        suggestionsBox.style.display = 'block';
                    })
                    .catch(err => {
                        console.error(err);
                        suggestionsBox.style.display = 'none';
                    });
            }, 300);
        });

        // Click ngo√†i suggestion ‚Üí ·∫©n
        document.addEventListener('click', function(event) {
            if (!keywordsInput.contains(event.target) && !suggestionsBox.contains(event.target)) {
                suggestionsBox.style.display = 'none';
            }
        });

        // Khi modal m·ªü ‚Üí load t·∫•t c·∫£ keywords ƒë·ªÉ hi·ªÉn th·ªã suggestions
        const keywordModal = document.getElementById('keywordModal');
        if (keywordModal) {
            keywordModal.addEventListener('shown.bs.modal', function() {
                // Load t·∫•t c·∫£ keywords khi modal m·ªü
                fetch('/api/keywords/search?q=')
                    .then(res => res.json())
                    .then(data => {
                        suggestionsBox.innerHTML = '';
                        if (data.length > 0) {
                            data.forEach(word => {
                                const item = document.createElement('button');
                                item.type = 'button';
                                item.className = 'list-group-item list-group-item-action';
                                item.textContent = word;
                                item.addEventListener('click', () => {
                                    const currentValue = keywordsInput.value.trim();
                                    const newValue = currentValue ? currentValue + ', ' + word : word;
                                    keywordsInput.value = newValue + ', ';
                                    suggestionsBox.style.display = 'none';
                                    keywordsInput.focus();
                                });
                                suggestionsBox.appendChild(item);
                            });
                            suggestionsBox.style.display = 'block';
                        }
                    })
                    .catch(err => {
                        console.error('Error loading keywords:', err);
                    });
            });
        }

        // Khi b·∫•m n√∫t "X√°c nh·∫≠n" trong modal
        if (confirmBtn) {
            confirmBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                const keywords = keywordsInput.value.trim();
                if (!keywords) {
                    alert('Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt t·ª´ kh√≥a!');
                    keywordsInput.focus();
                    return;
                }

                if (!window.pendingFileId) {
                    alert("L·ªói: kh√¥ng c√≥ file_id!");
                    return;
                }

                fetch('/save_svg', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        file_id: window.pendingFileId,
                        tikz_code: window.pendingTikzCode,
                        keywords: keywords
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
                        window.location.href = "/";
                    } else {
                        alert(data.error || "C√≥ l·ªói x·∫£y ra!");
                    }
                })
                .catch(err => {
                    alert("L·ªói m·∫°ng ho·∫∑c server!");
                });

                const modal = bootstrap.Modal.getInstance(document.getElementById('keywordModal'));
                modal.hide();
            });
        }

        // ==== Load files ====
        const filesSection = document.querySelector('.files-section');
        if (filesSection && filesSection.dataset.isOwner === 'true') {
            loadFiles();
            startFilesPolling();
        } else {
            // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p, load public files v√† v·∫´n polling
            loadFiles();
            startFilesPolling();
        }

        // ==== Touch events ƒë√£ ƒë∆∞·ª£c initialize trong file_card.js ====

        // ==== Initialize CodeMirror ====
        // Ki·ªÉm tra xem CodeMirror ƒë√£ ƒë∆∞·ª£c load ch∆∞a
        if (typeof CodeMirror !== 'undefined') {
            initializeCodeMirror();
        } else {
            // Th·ª≠ l·∫°i sau 1 gi√¢y
            setTimeout(() => {
                if (typeof CodeMirror !== 'undefined') {
                    initializeCodeMirror();
                } else {
                    console.error('‚ùå CodeMirror failed to load');
                }
            }, 1000);
        }
        
        // ==== Action buttons ƒë√£ ƒë∆∞·ª£c initialize trong file_card.js ====
        
        // ==== Start login status polling (ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p ƒë·ªãnh k·ª≥) ====
        setInterval(() => {
            refreshLoginStatusAndLoadFiles();
        }, 30000); // Ki·ªÉm tra m·ªói 30 gi√¢y
        
        // ==== Listen for login success events ====
        // Ki·ªÉm tra URL ƒë·ªÉ xem c√≥ ph·∫£i v·ª´a ƒëƒÉng nh·∫≠p th√†nh c√¥ng kh√¥ng
        if (window.location.search.includes('login_success=true')) {
            console.log('üîÑ Login success detected, switching to private files...');
            setTimeout(() => {
                stopFilesPolling();
                refreshLoginStatusAndLoadFiles();
            }, 1000); // Delay 1 gi√¢y ƒë·ªÉ ƒë·∫£m b·∫£o session ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t
        }
        
        // ==== Listen for page visibility changes ====
        // Khi user quay l·∫°i tab, ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                console.log('üîÑ Page became visible, checking login status...');
                refreshLoginStatusAndLoadFiles();
            }
        });
        
        // ==== Listen for focus events ====
        // Khi user focus v√†o window, ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        window.addEventListener('focus', () => {
            console.log('üîÑ Window focused, checking login status...');
            refreshLoginStatusAndLoadFiles();
        });
        
        // ==== Listen for storage events (cross-tab login/logout) ====
        // Khi user ƒëƒÉng nh·∫≠p/ƒëƒÉng xu·∫•t ·ªü tab kh√°c
        window.addEventListener('storage', (e) => {
            if (e.key === 'login_status') {
                console.log('üîÑ Login status changed in another tab, refreshing...');
                stopFilesPolling();
                refreshLoginStatusAndLoadFiles();
            }
        });
        
        // ==== Listen for online/offline events ====
        // Khi k·∫øt n·ªëi m·∫°ng thay ƒë·ªïi, ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        window.addEventListener('online', () => {
            console.log('üîÑ Network online, checking login status...');
            stopFilesPolling();
            refreshLoginStatusAndLoadFiles();
        });
        
        // ==== Listen for beforeunload events ====
        // Khi user s·∫Øp r·ªùi kh·ªèi trang, l∆∞u tr·∫°ng th√°i
        window.addEventListener('beforeunload', () => {
            localStorage.setItem('login_status', window.isLoggedIn ? 'logged_in' : 'logged_out');
        });
        
        // ==== Check stored login status on page load ====
        // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p ƒë√£ l∆∞u
        const storedLoginStatus = localStorage.getItem('login_status');
        if (storedLoginStatus && storedLoginStatus !== (window.isLoggedIn ? 'logged_in' : 'logged_out')) {
            console.log('üîÑ Stored login status differs from current, refreshing...');
            stopFilesPolling();
            refreshLoginStatusAndLoadFiles();
        }
        
        // ==== Initialize login status in localStorage ====
        // Kh·ªüi t·∫°o tr·∫°ng th√°i ƒëƒÉng nh·∫≠p trong localStorage
        localStorage.setItem('login_status', window.isLoggedIn ? 'logged_in' : 'logged_out');
        
        // ==== Log initial state ====
        console.log('üîÑ Initial login status:', window.isLoggedIn ? 'Logged in' : 'Not logged in');
        console.log('üîÑ Loading files for:', window.isLoggedIn ? 'logged in user' : 'public access');
        console.log('üîÑ Polling will be active for both logged in and public users');
    }

    // Refresh login status and load files if needed
    function refreshLoginStatusAndLoadFiles() {
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒëƒÉng nh·∫≠p t·ª´ server
        fetch('/api/check_login_status')
            .then(response => response.json())
            .then(data => {
                const wasLoggedIn = window.isLoggedIn;
                window.isLoggedIn = data.logged_in;
                
                // C·∫≠p nh·∫≠t localStorage
                localStorage.setItem('login_status', window.isLoggedIn ? 'logged_in' : 'logged_out');
                
                // N·∫øu tr·∫°ng th√°i ƒëƒÉng nh·∫≠p thay ƒë·ªïi, load files v√† restart polling
                if (!wasLoggedIn && window.isLoggedIn) {
                    console.log('üîÑ User logged in, switching to private files...');
                    stopFilesPolling();
                    loadFiles(true); // Force load khi user v·ª´a ƒëƒÉng nh·∫≠p
                    startFilesPolling();
                } else if (wasLoggedIn && !window.isLoggedIn) {
                    console.log('üîÑ User logged out, switching to public files...');
                    stopFilesPolling();
                    loadFiles(true); // Force load khi user v·ª´a ƒëƒÉng xu·∫•t
                    startFilesPolling();
                }
            })
            .catch(error => {
                console.error('Error checking login status:', error);
            });
    }

    // Load files from API
    function loadFiles(forceLoad = false) {
        console.log('üîÑ loadFiles called...', forceLoad ? '(forced)' : '');
        const container = document.getElementById('files-container');
        console.log('üîÑ Container found:', !!container);
        
        // Ki·ªÉm tra flag to√†n c·ª•c
        if (window.activeFeedbackCount > 0) {
            return;
        }
        
        // Ch·ªçn API endpoint d·ª±a tr√™n tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        const apiEndpoint = window.isLoggedIn ? '/api/files' : '/api/public/files';
        console.log('üîÑ Using API endpoint:', apiEndpoint);
        
        fetch(apiEndpoint)
            .then(response => {
                console.log('üîÑ Response status:', response.status);
                if (!response.ok) {
                    // N·∫øu ƒë√£ ki·ªÉm tra ƒëƒÉng nh·∫≠p tr∆∞·ªõc ƒë√≥, 401 kh√¥ng n√™n x·∫£y ra
                    // Nh∆∞ng v·∫´n x·ª≠ l√Ω ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n
                    if (response.status === 401) {
                        console.log('üîÑ Unexpected 401 response, user session may have expired');
                        container.innerHTML = `
                            <div class="no-files">
                                <div class="no-files-icon">üîí</div>
                                <h4>Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n</h4>
                                <p>Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i ƒë·ªÉ xem files ƒë√£ l∆∞u</p>
                            </div>
                        `;
                        return Promise.reject('Unauthorized'); // Prevent further processing
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // X·ª≠ l√Ω response format kh√°c nhau gi·ªØa /api/files v√† /api/public/files
                const files = window.isLoggedIn ? data : (data.files || []);
                return files;
            })
            .then(files => {
                if (!files) return;
                
                if (files.length === 0) {
                    const noFilesMessage = window.isLoggedIn 
                        ? 'H√£y t·∫°o v√† l∆∞u m·ªôt s·ªë file SVG ƒë·ªÉ xem ch√∫ng ·ªü ƒë√¢y'
                        : 'Hi·ªán t·∫°i ch∆∞a c√≥ file SVG n√†o ƒë∆∞·ª£c chia s·∫ª c√¥ng khai';
                    
                    container.innerHTML = `
                        <div class="no-files">
                            <div class="no-files-icon">üìÅ</div>
                            <h4>Ch∆∞a c√≥ file n√†o</h4>
                            <p>${noFilesMessage}</p>
                        </div>
                    `;
                    return;
                }
                
                // Render files
                const filesHTML = files.map(file => `
                    <div class="file-card" data-file-id="${file.id}">
                      <button class="action-toggle-btn" type="button" aria-label="Hi·ªán menu h√†nh ƒë·ªông">‚ãØ</button>
                      <div class="file-info">
                        <div class="file-creator" style="margin-bottom: 0; font-size: 12px;">
                          üë§ <a href="/profile/${file.creator_id}/svg-files" style="text-decoration: none; color: #1976d2; font-weight: 700; font-size: 13px;">
                            ${file.creator_username}
                          </a>
                          <span style="margin-left:8px; color: #666; font-size: 11px;">${file.created_time_vn || file.created_time}</span>
                        </div>
                      </div>
                      <div class="file-img-container">
                        <img src="${file.url}" alt="${file.filename}">
                        <div class="like-button-wrapper">
                          <div class="like-button">
                            <input id="heart-${file.id}" type="checkbox" ${file.is_liked_by_current_user ? 'checked' : ''} ${!window.isLoggedIn ? 'disabled' : ''} />
                            <label class="like" for="heart-${file.id}" ${!window.isLoggedIn ? 'style="opacity: 0.6; cursor: not-allowed;"' : ''}>
                              <svg class="like-icon" fill-rule="nonzero" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z"></path>
                              </svg>
                              <span class="like-text">Likes</span>
                            </label>
                            <span class="like-count one">${file.like_count}</span>
                            <span class="like-count two">${file.like_count}</span>
                          </div>
                        </div>
                      </div>
                      <div class="file-action-container">
                        <ul class="file-action-list">
                          <li class="file-action-item">
                            <button type="button" class="Btn" data-action="download-image" data-filename="${file.filename}">
                              <div class="sign">
                                <i class="fas fa-image logoIcon"></i>
                              </div>
                              <div class="text">T·∫£i ·∫£nh</div>
                            </button>
                          </li>
                         <li class="file-action-item">
                            <button type="button" class="Btn" data-action="share-facebook" data-filename="${file.filename}" data-has-feedback="true">
                              <div class="sign">
                                <i class="fab fa-facebook logoIcon"></i>
                              </div>
                              <div class="text">Facebook</div>
                            </button>
                          </li>
                          <li class="file-action-item">
                            <button type="button" class="Btn" data-action="copy-link" data-url="/static/${file.filename}" data-has-feedback="true">
                              <div class="sign">
                                <i class="fas fa-link logoIcon"></i>
                              </div>
                              <div class="text">Copy Link</div>
                            </button>
                          </li>
                          ${file.tikz_code ? `
                          <li class="file-action-item">
                            <button type="button" class="Btn" data-action="toggle-code">
                              <div class="sign">
                                <i class="fas fa-code logoIcon"></i>
                              </div>
                              <div class="text">Xem Code</div>
                            </button>
                          </li>
                          ` : ''}

                        </ul>
                      </div>
                      
                      <!-- TikZ Code Section -->
                      ${file.tikz_code ? `
                      <div class="tikz-code-block" style="display:none; margin-top:10px;">
                        <div class="tikz-code-header">
                          <span>Code TikZ:</span>
                          <button class="copy-btn" onclick="copyTikzCode(this)">üìã Copy</button>
                        </div>
                        <div class="code-block">
                          <textarea class="tikz-cm" readonly>${file.tikz_code}</textarea>
                        </div>
                      </div>
                      ` : ''}
                    </div>
                `).join('');
                
                container.innerHTML = filesHTML;
                
                // Like buttons ƒë√£ ƒë∆∞·ª£c initialize trong file_card.js
                
                // C·∫≠p nh·∫≠t currentFiles cho polling
                currentFiles = files;
                console.log('üîÑ Updated currentFiles for polling:', currentFiles.length, 'files');
                
                // Note: Event delegation ƒë√£ ƒë∆∞·ª£c setup trong DOMContentLoaded, 
                // n√™n kh√¥ng c·∫ßn re-initialize cho c√°c element m·ªõi ƒë∆∞·ª£c th√™m v√†o
            })
            .catch(error => {
                console.error('Error loading files:', error);
                
                // N·∫øu ƒë√£ x·ª≠ l√Ω 401 trong .then(), kh√¥ng hi·ªÉn th·ªã l·∫°i
                if (error === 'Unauthorized') {
                    return;
                }
                
                // N·∫øu force load v√† c√≥ l·ªói, c√≥ th·ªÉ user ch∆∞a ƒëƒÉng nh·∫≠p th·ª±c s·ª±
                if (forceLoad) {
                    console.log('üîÑ Force load failed, checking login status...');
                    refreshLoginStatusAndLoadFiles();
                    return;
                }
                
                // Th√¥ng b√°o l·ªói kh√°c nhau cho user ƒë√£ ƒëƒÉng nh·∫≠p v√† ch∆∞a ƒëƒÉng nh·∫≠p
                const errorMessage = window.isLoggedIn 
                    ? 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch files c·ªßa b·∫°n. Vui l√≤ng th·ª≠ l·∫°i sau.'
                    : 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch files c√¥ng khai. Vui l√≤ng th·ª≠ l·∫°i sau.';
                
                container.innerHTML = `
                    <div class="no-files">
                        <div class="no-files-icon">‚ùå</div>
                        <h4>Kh√¥ng th·ªÉ t·∫£i danh s√°ch files</h4>
                        <p>${errorMessage}</p>
                    </div>
                `;
            });
    }

    // Function initializeFileLikeButtons ƒë√£ ƒë∆∞·ª£c move v√†o file_card.js

    // Global variable to store current files for polling comparison
    let currentFiles = [];
    let pollingInterval = null;
    
    // Real-time synchronization for files via polling
    // Updated for server-side rendering - reload page instead of dynamic loading
    function startFilesPolling() {
        console.log('üîÑ Starting files polling...');
        const pollInterval = 15000; // 15 seconds
        
        pollingInterval = setInterval(function() {
            console.log('üîÑ Polling files...', new Date().toLocaleTimeString());
            
            // Ki·ªÉm tra flag to√†n c·ª•c
            if (window.activeFeedbackCount > 0) {
                return;
            }
            
            // Since files are now rendered server-side, reload the page to get updates
            console.log('üîÑ Files updated, reloading page...');
            location.reload();
        }, pollInterval);
        
        console.log('üîÑ Started files polling (15s interval) - page reload mode');
    }
    
    // Function to stop polling
    function stopFilesPolling() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
            console.log('üîÑ Stopped files polling');
        }
    }

    // Function initializeTouchBtnEvents ƒë√£ ƒë∆∞·ª£c move v√†o file_card.js

    // Switch statement ƒë√£ ƒë∆∞·ª£c move v√†o file_card.js
    // Function initializeTouchBtnEvents ƒë√£ ƒë∆∞·ª£c move v√†o file_card.js

    // Function x·ª≠ l√Ω touch events ƒë∆°n gi·∫£n cho tr∆∞·ªùng h·ª£p ch∆∞a ƒëƒÉng nh·∫≠p
    // ƒê√£ ƒë∆∞·ª£c g·ªôp v√†o initializeTouchBtnEvents ƒë·ªÉ x·ª≠ l√Ω cho t·∫•t c·∫£ users

    // Copy to clipboard functions ƒë√£ ƒë∆∞·ª£c move v√†o file_card.js

    // Function toggleTikzCode ƒë√£ ƒë∆∞·ª£c move v√†o file_card.js

    // Function copyTikzCode ƒë√£ ƒë∆∞·ª£c move v√†o file_card.js

    // Initialize CodeMirror for TikZ code blocks
    function initializeCodeMirror() {
        document.querySelectorAll('.tikz-cm').forEach(function(textarea) {
            if (!textarea.CodeMirror) {
                const codeBlock = textarea.closest('.tikz-code-block');
                if (codeBlock) {
                    const existingCm = codeBlock.querySelector('.CodeMirror');
                    if (existingCm) {
                        existingCm.remove();
                    }
                    
                    if (typeof CodeMirror !== 'undefined') {
                        try {
                            const cmInstance = CodeMirror.fromTextArea(textarea, {
                                mode: 'stex',
                                theme: 'material',
                                lineNumbers: true,
                                readOnly: true,
                                lineWrapping: true,
                                foldGutter: true,
                                gutters: ['CodeMirror-linenumbers'],
                                viewportMargin: Infinity
                            });
                            
                            // Refresh CodeMirror after a short delay
                            setTimeout(() => {
                                cmInstance.refresh();
                            }, 100);
                        } catch (error) {
                            console.error('‚ùå Error creating CodeMirror instance:', error);
                        }
                    } else {
                        console.error('‚ùå CodeMirror is not defined!');
                    }
                }
            } else {
                const cmInstance = textarea.CodeMirror;
                setTimeout(() => {
                    cmInstance.refresh();
                }, 100);
            }
        });
    }

    // Function initializeActionButtons ƒë√£ ƒë∆∞·ª£c move v√†o file_card.js

    // ƒê√≥ng menu khi click b√™n ngo√†i
    document.addEventListener('click', function (e) {
        const activeCard = document.querySelector('.file-card.active');
        if (activeCard) {
            if (activeCard.dataset.preventClose === 'true') {
                return;
            }
            
            if (!activeCard.contains(e.target) && !e.target.closest('.Btn') && !e.target.closest('.action-toggle-btn')) {
                activeCard.classList.remove('active');
            }
        }
    });

    // ========== SEARCH FUNCTIONALITY ==========
    function initializeSearch() {
        console.log('üîç initializeSearch() called');
        const searchInput = document.getElementById('main-search-input');
        const suggestionsBox = document.getElementById('search-suggestions');
        
        console.log('üîç searchInput:', searchInput);
        console.log('üîç suggestionsBox:', suggestionsBox);
        
        if (!searchInput || !suggestionsBox) {
            console.log('‚ùå Missing searchInput or suggestionsBox');
            return;
        }
        
        let typingTimeout = null;
        
        // Handle input changes
        searchInput.addEventListener('input', function() {
            console.log('üîç Search input event triggered');
            clearTimeout(typingTimeout);
            const query = this.value.trim();
            console.log('üîç Query:', query);
            
            if (query.length < 1) {
                console.log('üîç Query too short, hiding suggestions');
                suggestionsBox.style.display = 'none';
                return;
            }
            
            console.log('üîç Fetching suggestions for query:', query);
            typingTimeout = setTimeout(() => {
                fetch(`/api/keywords/search?q=${encodeURIComponent(query)}`)
                    .then(res => {
                        console.log('üîç API response status:', res.status);
                        return res.json();
                    })
                    .then(data => {
                        console.log('üîç API response data:', data);
                        suggestionsBox.innerHTML = '';
                        
                        if (data.length === 0) {
                            console.log('üîç No suggestions found');
                            suggestionsBox.style.display = 'none';
                            return;
                        }
                        
                        console.log('üîç Adding suggestions:', data);
                        data.forEach(keyword => {
                            const item = document.createElement('div');
                            item.className = 'search-suggestion-item';
                            item.textContent = keyword;
                            item.addEventListener('click', () => {
                                searchInput.value = keyword;
                                suggestionsBox.style.display = 'none';
                                // Navigate to search results page
                                window.location.href = `/search?q=${encodeURIComponent(keyword)}`;
                            });
                            suggestionsBox.appendChild(item);
                        });
                        
                        suggestionsBox.style.display = 'block';
                        console.log('üîç Suggestions displayed');
                    })
                    .catch(err => {
                        console.error('‚ùå Search error:', err);
                        suggestionsBox.style.display = 'none';
                    });
            }, 300);
        });
        
        // Handle Enter key
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const query = this.value.trim();
                if (query) {
                    suggestionsBox.style.display = 'none';
                    window.location.href = `/search?q=${encodeURIComponent(query)}`;
                }
            }
        });
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
                suggestionsBox.style.display = 'none';
            }
        });
    }
    
    // ========== MAIN INITIALIZER: G·ªôp t·∫•t c·∫£ DOMContentLoaded v√†o ƒë√¢y ==========
    document.addEventListener('DOMContentLoaded', function() {
        // 1) Touch device detection
        if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
            document.documentElement.classList.add('is-touch');
        }

        // 2) File cards are now rendered server-side - no need to load dynamically

        // 3) Mobile menu
        const menuToggle = document.getElementById('menu-toggle');
        const mobileMenu = document.getElementById('mobile-menu');
        const closeMenu = document.getElementById('close-menu');
        if (menuToggle && mobileMenu && closeMenu) {
            menuToggle.addEventListener('click', () => mobileMenu.classList.remove('hidden'));
            closeMenu.addEventListener('click', () => mobileMenu.classList.add('hidden'));
            mobileMenu.addEventListener('click', e => { if (e.target === mobileMenu) mobileMenu.classList.add('hidden'); });
        }

        // 4) Header login state + pending view svg injection
        updateHeaderLoginState();

        // 5) Event listeners ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong file_card.js

        // 6) Smooth scroll hint + touch scroll (theo c·∫•u tr√∫c table-scroll-x)
        (function setupHorizontalScrollUX() {
            const mobileHint = document.getElementById('mobile-scroll-hint');
            const scrollHost = document.querySelector('.table-scroll-x');
            function showMobileScrollHint() {
                if (!mobileHint || !scrollHost) return;
                const isMobile = window.innerWidth <= 768;
                const hasScroll = scrollHost.scrollWidth > scrollHost.clientWidth;
                if (isMobile && hasScroll) {
                    mobileHint.style.display = 'block';
                    setTimeout(() => { mobileHint.style.opacity = '0.7'; }, 3000);
                    setTimeout(() => { mobileHint.style.display = 'none'; }, 8000);
                } else {
                    mobileHint.style.display = 'none';
                }
            }
            showMobileScrollHint();
            window.addEventListener('resize', showMobileScrollHint);
            if (scrollHost) {
                let isScrolling = false, startX = 0, scrollLeft = 0;
                scrollHost.addEventListener('touchstart', function(e) {
                    isScrolling = true;
                    startX = e.touches[0].pageX - scrollHost.offsetLeft;
                    scrollLeft = scrollHost.scrollLeft;
                }, { passive: true });
                scrollHost.addEventListener('touchmove', function(e) {
                    if (!isScrolling) return;
                    const x = e.touches[0].pageX - scrollHost.offsetLeft;
                    const walk = (x - startX) * 2;
                    scrollHost.scrollLeft = scrollLeft - walk;
                }, { passive: true });
                scrollHost.addEventListener('touchend', function() { isScrolling = false; }, { passive: true });
            }
        })();

        // 7) Init CodeMirror + preview real-time
        if (typeof initCodeMirrorAndBindings === 'function') {
            initCodeMirrorAndBindings();
        }

        // 8) Init highlight.js
        if (window.hljs) {
            hljs.highlightAll();
            if (hljs.initLineNumbersOnLoad) hljs.initLineNumbersOnLoad();
        }

        // 9) Modal login button
        const modalLoginBtn = document.getElementById('modal-login-btn');
        if (modalLoginBtn) {
            modalLoginBtn.addEventListener('click', function() {
                window.location.href = "{{ url_for('google.login') }}";
            });
        }

        // 10) Logout link
        const logoutLink = document.getElementById('logout-link');
        if (logoutLink) {
            logoutLink.addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = '/logout?next=/';
            });
        }

        // 11) Keyword modal behaviors
        if (typeof initKeywordModal === 'function') {
            initKeywordModal();
        }
        
        // 12) Initialize search functionality
        initializeSearch();
        
        // 13) Action buttons ƒë√£ ƒë∆∞·ª£c initialize trong file_card.js

        // 14) Touch events ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong initializeTouchBtnEvents cho t·∫•t c·∫£ users
        console.log('üîÑ Touch events initialized for all users');

        console.log('DOMContentLoaded - appState.loggedIn:', window.appState && window.appState.loggedIn);

        // N·∫øu c√≥ code TikZ t·ª´ localStorage (t·ª´ View Mode), ƒëi·ªÅn v√†o textarea ch√≠nh
        // Th·ª±c thi sau khi t·∫•t c·∫£ ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o
        setTimeout(() => {
            const tikzFromStorage = localStorage.getItem('tikz_code_for_compile');
            if (tikzFromStorage) {
                console.log('Found tikz_code_for_compile in localStorage:', tikzFromStorage);
                // ƒêi·ªÅn code v√†o textarea ch√≠nh
                if (window.cm && typeof window.cm.setValue === 'function') {
                    window.cm.setValue(tikzFromStorage);
                    console.log('Code set to CodeMirror successfully');
                } else {
                    const textarea = document.getElementById('code');
                    if (textarea) {
                        textarea.value = tikzFromStorage;
                        console.log('Code set to textarea successfully');
                    }
                }
                // X√≥a d·ªØ li·ªáu ƒë√£ s·ª≠ d·ª•ng
                localStorage.removeItem('tikz_code_for_compile');
                console.log('tikz_code_for_compile removed from localStorage');
            }
        }, 100); // Delay 100ms ƒë·ªÉ ƒë·∫£m b·∫£o CodeMirror ƒë√£ s·∫µn s√†ng
    });

    // Sau khi login ‚Üí √©p reload ƒë·ªÉ ƒë·ªìng b·ªô session
    if (window.location.search.includes('login=1')) {
        window.location.href = window.location.pathname;
    }

</script>

    
    

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- H√†m kh·ªüi t·∫°o l·∫°i CodeMirror cho textarea id="code" -->
    <script>
        function ensureCodeMirror() {
            const textarea = document.getElementById('code');
            if (!textarea) return;
            // N·∫øu ƒë√£ c√≥ CodeMirror instance, kh√¥ng kh·ªüi t·∫°o l·∫°i
            if (textarea.nextSibling && textarea.nextSibling.classList && textarea.nextSibling.classList.contains('CodeMirror')) {
                return;
            }
            window.cm = CodeMirror.fromTextArea(textarea, {
                mode: 'stex',
                theme: 'material',
                lineNumbers: true,
                placeholder: 'Nh·∫≠p code TikZ t·∫°i ƒë√¢y...'
            });
        }
    </script>

    <!-- ... trong submitTikzCodeAjax, sau khi c·∫≠p nh·∫≠t previewCol v√† resultToolsSection ... -->
    <!-- Th√™m d√≤ng n√†y sau khi c·∫≠p nh·∫≠t DOM: -->
    <!-- ensureCodeMirror(); -->
</body>
</html>
