<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√†i ƒëƒÉng theo d√µi - TikZ to SVG</title>
    
    <!-- Global JavaScript variables -->
    <script>
        window.isLoggedIn = {{ 'true' if current_user.is_authenticated else 'false' }};
        window.activeFeedbackCount = 0;
        window.isOwner = {{ 'true' if is_owner else 'false' }};
    </script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          max-width: 800px;
          margin: 0 auto;
          padding: 20px;
          background-color: #f5f5f5;
        }
        
        .container {
          background: white;
          padding: 40px;
          border-radius: 12px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.1);
          max-width: 1200px;
        }
        
        .navbar-header-user {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        #logout-btn {
          background: #d32f2f;
          color: white;
          padding: 8px 16px;
          border-radius: 6px;
          text-decoration: none;
          font-weight: bold;
          font-size: 14px;
        }
        
        .navbar-user-info {
          padding: 6px 14px;
          border-radius: 6px;
          gap: 8px;
          background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
          color: white;
          font-size: 14px;
          display: flex;
          align-items: center;
          text-decoration: none;
          cursor: pointer;
        }
        
        .navbar-avatar,
        .navbar-avatar-placeholder {
          width: 28px;
          height: 28px;
          border-radius: 50%;
          border: 2px solid #fff;
          object-fit: cover;
          background: #eee;
          flex-shrink: 0;
        }
        
        .navbar-avatar-placeholder {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          font-size: 14px;
        }
        
        .navbar-username {
          font-weight: 500;
          font-size: 13.5px;
          max-width: 100px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        .google-login-btn {
          max-width: 320px;
          display: flex;
          padding: 8px 16px;
          font-size: 14px;
          font-weight: 700;
          text-align: center;
          align-items: center;
          justify-content: center;
          border-radius: 6px;
          border: 1px solid rgba(0, 0, 0, 0.25);
          gap: 0.75rem;
          color: rgb(65, 63, 63);
          background-color: #fff;
          cursor: pointer;
          min-height: 40px;
        }

        .google-login-btn svg {
          height: 24px;
          flex-shrink: 0;
        }

        .google-login-btn:hover {
          transform: scale(1.02);
          background-color: #1565c0;
          color: white;
        }
        
        /* Files Grid */
        .files-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
          gap: 20px;
          margin-top: 20px;
          padding: 0;
          list-style: none;
        }

        /* Individual File Card */
        .file-card {
          position: relative;
          min-height: 260px;
          display: flex;
          flex-direction: column;
          justify-content: flex-start;
          background: #fff;
          border: 1px solid #ddd;
          border-radius: 10px;
          box-shadow: 0 2px 6px rgba(0,0,0,0.08);
          transition: transform 0.2s ease;
        }

        .file-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        /* Image Section */
        .file-img-container {
          position: relative;
          overflow: hidden;
          border-radius: 10px 10px 0 0;
          background: #fff;
          height: 180px;
          width: 100%;
        }

        .file-img-container img {
          width: 100%;
          height: 100%;
          object-fit: contain;
          display: block;
          background-color: #fff;
          transition: transform 0.3s ease;
        }

        .file-card:hover .file-img-container img {
          transform: scale(1.03);
        }

        /* Overlay Action Menu */
        .file-action-container {
          display: none;
          opacity: 0;
          pointer-events: none;
          transform: translateX(-10px);
          transition: opacity 0.3s, transform 0.3s;
          position: absolute;
          left: 12px;
          top: 60px;
          z-index: 300;
        }

        /* Desktop hover logic */
        @media (hover: hover) and (pointer: fine) {
          .file-img-container:hover + .file-action-container,
          .file-action-container:hover,
          .file-card:hover .file-action-container {
            display: block;
            opacity: 1;
            pointer-events: auto;
            transform: translateX(0);
          }
        }

        /* Mobile/Touch: Ch·ªâ hi·ªán khi card c√≥ class active */
        .file-card.active .file-action-container {
          display: block !important;
          opacity: 1 !important;
          pointer-events: auto !important;
          transform: translateX(0) !important;
        }

        .copy-btn {
          padding: 6px 14px;
          font-size: 14px;
          border-radius: 6px;
          cursor: pointer;
          transition: background 0.25s ease;
          display: inline-flex;
          align-items: center;
          gap: 8px;
          background: #f5f5f5;
          border: 1px solid #ddd;
        }

        .copy-btn:hover {
          background: #e0e0e0;
        }

        /* Mobile: Hi·ªán n√∫t toggle ... */
        .action-toggle-btn {
          display: none;
          position: absolute;
          top: 10px;
          right: 10px;
          z-index: 200;
          border: none;
          background: rgba(255,255,255,0.95);
          border-radius: 50%;
          width: 38px;
          height: 38px;
          font-size: 22px;
          cursor: pointer;
          box-shadow: 0 2px 4px rgba(0,0,0,0.13);
        }

        @media (hover: none), (pointer: coarse) {
          .action-toggle-btn {
            display: block;
          }
        }

        .file-action-list {
          list-style: none;
          padding: 0;
          margin: 0;
          display: flex;
          flex-direction: column;
          gap: 8px;
          overflow: visible;
          width: auto;
        }

        .file-action-item {
          display: flex;
          justify-content: flex-start;
          width: 100%;
        }

        /* Button Styling */
        .Btn {
          display: flex;
          align-items: center;
          justify-content: flex-start;
          width: 35px;
          height: 35px;
          border: none;
          border-radius: 50%;
          cursor: pointer;
          position: relative;
          overflow: hidden;
          transition: all 0.3s ease;
          box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.199);
          background: linear-gradient(-50deg, rgb(39, 107, 255), rgb(112, 186, 255), rgb(39, 107, 255));
          background-size: 250%;
          background-position: left;
          min-width: 35px;
          flex-shrink: 0;
        }

        /* Icon container */
        .sign {
          width: 45px;
          height: 45px;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          justify-content: flex-start;
          padding-left: 4px;
          flex-shrink: 0;
          z-index: 2;
          position: relative;
        }

        .sign svg {
          width: 18px;
          height: 18px;
        }

        .sign svg path {
          fill: white;
        }

        .logoIcon {
          color: white;
          font-size: 16px;
        }

        /* Text label */
        .text {
          position: absolute;
          left: 20px;
          top: 50%;
          transform: translateY(-50%);
          width: 0;
          opacity: 0;
          color: white;
          font-size: 14px;
          font-weight: 600;
          transition: all 0.3s ease;
          white-space: nowrap;
          text-align: left;
          padding-left: 12px;
          z-index: 1;
        }

        /* Desktop hover effect */
        .Btn:hover {
          width: 140px;
          border-radius: 20px;
          background-position: right;
        }

        .Btn:hover .text {
          opacity: 1;
          width: auto;
          max-width: 85px;
        }

        /* File Info Styling */
        .file-info {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 0px;
            font-size: 13px;
            color: #555;
        }

        .file-meta {
            margin-bottom: 6px;
            font-weight: 400;
        }

        .file-meta .label {
            font-weight: 500;
            color: #333;
        }

        .file-creator {
            margin-top: 8px;
            font-size: 13px;
            font-weight: 400;
        }

        /* Like Button Styles */
        input[id^="followed-heart-"] {
            display: none;
        }

        .like-button {
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            height: 32px;
            width: 90px;
            border-radius: 8px;
            border: none;
            background-color: #2d2d2d;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            padding: 0 8px;
        }

        .like-button input[type="checkbox"] {
            display: none;
        }

        .like {
            display: flex;
            cursor: pointer;
            align-items: center;
            gap: 4px;
            flex: 1;
        }

        .like-icon {
            fill: #808080;
            height: 16px;
            width: 16px;
            transition: fill 0.2s ease;
        }

        .like-text {
            color: #e0e0e0;
            font-size: 12px;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 500;
        }

        .like-count {
            color: #808080;
            font-size: 12px;
            font-weight: 500;
            margin-left: 4px;
            transition: all 0.3s ease;
        }

        .like-count.two {
            position: absolute;
            right: 8px;
            transform: translateY(20px);
            opacity: 0;
        }

        .like-count.one {
            position: relative;
        }

        input[id^="followed-heart-"]:checked ~ .like .like-icon {
            fill: #ff4757;
            animation: heartBeat 0.3s ease;
        }

        input[id^="followed-heart-"]:checked ~ .like-count.one {
            transform: translateY(-20px);
            opacity: 0;
        }

        input[id^="followed-heart-"]:checked ~ .like-count.two {
            transform: translateY(0);
            opacity: 1;
            color: #ff4757;
        }

        @keyframes heartBeat {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.3);
            }
            100% {
                transform: scale(1);
            }
        }

        /* No Followed Posts */
        .no-followed-posts {
            text-align: center;
            color: #666;
            padding: 40px 20px;
            background: #f9f9f9;
            border-radius: 12px;
            border: 2px dashed #ddd;
        }

        .no-followed-posts-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
          .container {
            padding: 20px;
          }
        }
        </style>

</head>
<body>
            <!-- Navbar header user info -->
            <div class="navbar-header-user">
                <a href="/" class="btn btn-secondary" style="text-decoration: none; background: #6c757d; color: white; padding: 8px 16px; border-radius: 6px; font-weight: bold; font-size: 14px;">üè† V·ªÅ trang ch·ªß</a>
                <a href="/profile/{{ user_id }}" class="btn btn-secondary" style="text-decoration: none; background: #6c757d; color: white; padding: 8px 16px; border-radius: 6px; font-weight: bold; font-size: 14px;">üë§ H·ªì s∆°</a>
                <a href="/profile/{{ user_id }}/settings" class="btn btn-secondary" style="text-decoration: none; background: #6c757d; color: white; padding: 8px 16px; border-radius: 6px; font-weight: bold; font-size: 14px;">‚öôÔ∏è C√†i ƒë·∫∑t</a>
                <a href="/profile/{{ user_id }}/svg-files" class="btn btn-secondary" style="text-decoration: none; background: #6c757d; color: white; padding: 8px 16px; border-radius: 6px; font-weight: bold; font-size: 14px;">üìÇ File SVG</a>
                <button type="button" id="dark-mode-toggle" class="btn btn-secondary" style="background: #6c757d; color: white; padding: 8px 16px; border-radius: 6px; font-weight: bold; font-size: 14px; border: none; cursor: pointer;">üåô Dark Mode</button>
                    {% if current_user.is_authenticated %}
        <a href="/profile/me" class="navbar-user-info">
            <img src="{{ url_for('static', filename='avatars/' ~ current_avatar) if current_avatar else '' }}"
                 alt="Avatar" class="navbar-avatar"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            {% if not current_avatar %}
            <div class="navbar-avatar-placeholder">
                {{ current_user_email[0].upper() }}
            </div>
            {% endif %}
            <span class="navbar-username">
                {{ current_username or current_user_email.split('@')[0] }}
            </span>
        </a>
        <a id="logout-btn" href="#">ƒêƒÉng xu·∫•t</a>
    {% else %}
                    <button class="google-login-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid" viewBox="0 0 256 262">
                            <path fill="#4285F4" d="M255.878 133.451c0-10.734-.871-18.567-2.756-26.69H130.55v48.448h71.947c-1.45 12.04-9.283 30.172-26.69 42.356l-.244 1.622 38.755 30.023 2.685.268c24.659-22.774 38.875-56.282 38.875-96.027"></path>
                            <path fill="#34A853" d="M130.55 261.1c35.248 0 64.839-11.605 86.453-31.622l-41.196-31.913c-11.024 7.688-25.82 13.055-45.257 13.055-34.523 0-63.824-22.773-74.269-54.25l-1.531.13-40.298 31.187-.527 1.465C35.393 231.798 79.49 261.1 130.55 261.1"></path>
                            <path fill="#FBBC05" d="M56.281 156.37c-2.756-8.123-4.351-16.827-4.351-25.82 0-8.994 1.595-17.697 4.206-25.82l-.073-1.73L15.26 71.312l-1.335.635C5.077 89.644 0 109.517 0 130.55s5.077 40.905 13.925 58.602l42.356-32.782"></path>
                            <path fill="#EB4335" d="M130.55 50.479c24.514 0 41.05 10.589 50.479 19.438l36.844-35.974C195.245 12.91 165.798 0 130.55 0 79.49 0 35.393 29.301 13.925 71.947l42.211 32.783c10.59-31.477 39.891-54.251 74.414-54.251"></path>
                        </svg>
                        ƒêƒÉng nh·∫≠p Google
                    </button>
                {% endif %}
            </div>

    <div class="container">
        <!-- Section B√†i ƒëƒÉng theo d√µi -->
        <section class="followed-posts-section" data-is-owner="{{ 'true' if is_owner else 'false' }}">
            <h3 style="color:#1976d2; margin-bottom:24px;">üì∞ B√†i ƒëƒÉng t·ª´ ng∆∞·ªùi b·∫°n theo d√µi</h3>
            <div id="followed-posts-container" class="files-grid">
                <div class="loading-spinner" style="text-align: center; padding: 20px;">
                    <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #1976d2; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 10px; color: #666;">ƒêang t·∫£i b√†i ƒëƒÉng...</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Modal ƒëƒÉng xu·∫•t ch·ªâ render n·∫øu ƒë√£ login -->
    {% if user_email %}
    <div id="logout-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center;">
      <div style="background:white; padding:32px 40px; border-radius:12px; box-shadow:0 2px 16px rgba(0,0,0,0.15); min-width:320px; text-align:center;">
        <h3 style="margin-bottom:24px;">ƒêƒÉng xu·∫•t?</h3>
        <a href="/logout" style="display:inline-block; background:#d32f2f; color:white; padding:10px 28px; border-radius:6px; text-decoration:none; font-weight:bold;">ƒêƒÉng xu·∫•t</a>
        <button onclick="document.getElementById('logout-modal').style.display='none'" style="margin-left:18px; background:#eee; color:#333; padding:10px 28px; border-radius:6px; border:none; font-weight:bold;">Hu·ª∑</button>
      </div>
    </div>
    {% endif %}

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // ==== Logout button logic ====
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function (e) {
                e.preventDefault();
                const logoutModal = document.getElementById('logout-modal');
                if (logoutModal) logoutModal.style.display = 'flex';
            });
        }

        // ==== Google login button logic ====
        const googleLoginBtn = document.querySelector('.google-login-btn');
        if (googleLoginBtn) {
            googleLoginBtn.addEventListener('click', function (e) {
                e.preventDefault();
                const currentPath = window.location.pathname + window.location.search;
                fetch('/set_next_url?url=' + encodeURIComponent(currentPath))
                    .then(() => window.location.href = '/login/google')
                    .catch(error => {
                        console.error('Error setting next URL:', error);
                        window.location.href = '/login/google';
                    });
            });
        }

        // ==== Load followed posts ====
        const followedSection = document.querySelector('.followed-posts-section');
        if (followedSection && followedSection.dataset.isOwner === 'true') {
            loadFollowedPosts();
            startFollowedPostsPolling();
        }
    });

    // Load followed posts from API
    function loadFollowedPosts() {
        console.log('üîÑ loadFollowedPosts called...');
        const container = document.getElementById('followed-posts-container');
        console.log('üîÑ Container found:', !!container);
        
        // Ki·ªÉm tra flag to√†n c·ª•c
        if (window.activeFeedbackCount > 0) {
            return;
        }
        
        fetch('/api/followed_posts')
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        // User not logged in
                        container.innerHTML = `
                            <div class="no-followed-posts">
                                <div class="no-followed-posts-icon">üîí</div>
                                <h4>Ch∆∞a ƒëƒÉng nh·∫≠p</h4>
                                <p>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem b√†i ƒëƒÉng t·ª´ ng∆∞·ªùi b·∫°n theo d√µi</p>
                            </div>
                        `;
                        return;
                    }
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(posts => {
                if (!posts) return;
                
                if (posts.length === 0) {
                    container.innerHTML = `
                        <div class="no-followed-posts">
                            <div class="no-followed-posts-icon">üë•</div>
                            <h4>Ch∆∞a c√≥ b√†i ƒëƒÉng n√†o</h4>
                            <p>H√£y theo d√µi m·ªôt s·ªë ng∆∞·ªùi d√πng ƒë·ªÉ xem b√†i ƒëƒÉng c·ªßa h·ªç ·ªü ƒë√¢y</p>
                        </div>
                    `;
                    return;
                }
                
                // Render posts
                const postsHTML = posts.map(post => `
                    <div class="file-card followed-post-card" data-post-id="${post.id}">
                      <button class="action-toggle-btn" type="button" aria-label="Hi·ªán menu h√†nh ƒë·ªông">‚ãØ</button>
                      <div class="file-info">
                        <div class="file-creator" style="margin-bottom: 0; font-size: 12px;">
                          üë§ <a href="/profile/${post.creator_id}" style="text-decoration: none; color: #1976d2; font-weight: 700; font-size: 13px;">
                            ${post.creator_username}
                          </a>
                          <span style="margin-left:8px; color: #666; font-size: 11px;">${post.created_time_vn}</span>
                        </div>
                      </div>
                      <div class="file-img-container">
                        <img src="${post.url}" alt="${post.filename}">
                      </div>
                      <div class="like-button-wrapper" style="position: absolute; bottom: 8px; right: 8px; z-index: 100;">
                        <div class="like-button">
                          <input id="followed-heart-${post.id}" type="checkbox" ${post.is_liked_by_current_user ? 'checked' : ''} />
                          <label class="like" for="followed-heart-${post.id}">
                            <svg class="like-icon" fill-rule="nonzero" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                              <path d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z"></path>
                            </svg>
                            <span class="like-text">Likes</span>
                          </label>
                          <span class="like-count one">${post.like_count}</span>
                          <span class="like-count two">${post.like_count}</span>
                        </div>
                      </div>
                      <div class="file-action-container">
                        <ul class="file-action-list">
                          <li class="file-action-item">
                            <button type="button" class="Btn" data-filename="${post.filename}">
                              <div class="sign">
                                <i class="fas fa-image logoIcon"></i>
                              </div>
                              <div class="text">T·∫£i ·∫£nh</div>
                            </button>
                          </li>
                         <li class="file-action-item">
                            <button type="button" class="Btn fb-share-btn" data-filename="${post.filename}" data-has-feedback="true">
                              <div class="sign">
                                <i class="fab fa-facebook logoIcon"></i>
                              </div>
                              <div class="text">Facebook</div>
                            </button>
                          </li>
                          <li class="file-action-item">
                            <button type="button" class="Btn file-copy-link-btn" data-url="https://tikz2svg.mathlib.io.vn/static/${post.filename}" data-has-feedback="true">
                              <div class="sign">
                                <i class="fas fa-link logoIcon"></i>
                              </div>
                              <div class="text">Copy Link</div>
                            </button>
                          </li>
                          ${post.tikz_code ? `
                          <li class="file-action-item">
                            <button type="button" class="Btn">
                              <div class="sign">
                                <i class="fas fa-code logoIcon"></i>
                              </div>
                              <div class="text">Xem Code</div>
                            </button>
                          </li>
                          ` : ''}

                        </ul>
                      </div>
                      
                      <!-- TikZ Code Section -->
                      ${post.tikz_code ? `
                      <div class="tikz-code-block" style="display:none; margin-top:10px;">
                        <div class="tikz-code-header">
                          <span>Code TikZ:</span>
                          <button class="copy-btn" onclick="copyTikzCode(this)">üìã Copy</button>
                        </div>
                        <div class="code-block">
                          <textarea class="tikz-cm" readonly>${post.tikz_code}</textarea>
                        </div>
                      </div>
                      ` : ''}
                    </div>
                `).join('');
                
                container.innerHTML = postsHTML;
                
                // Initialize like buttons for followed posts
                initializeFollowedPostLikeButtons();
            })
            .catch(error => {
                console.error('Error loading followed posts:', error);
                container.innerHTML = `
                    <div class="no-followed-posts">
                        <div class="no-followed-posts-icon">‚ùå</div>
                        <h4>L·ªói t·∫£i d·ªØ li·ªáu</h4>
                        <p>C√≥ l·ªói x·∫£y ra khi t·∫£i b√†i ƒëƒÉng. Vui l√≤ng th·ª≠ l·∫°i sau.</p>
                    </div>
                `;
            });
    }

    // Initialize like buttons for followed posts
    function initializeFollowedPostLikeButtons() {
        // Ch·ªâ kh·ªüi t·∫°o like buttons n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p
        if (!window.isLoggedIn) {
            return;
        }
        
        // Initialize like buttons
        document.querySelectorAll('input[id^="followed-heart-"]').forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                const fileId = this.id.replace('followed-heart-', '');
                const isLiked = this.checked;
                const likeButton = this.closest('.like-button');
                const currentNumber = likeButton.querySelector('.like-count.one');
                const moveNumber = likeButton.querySelector('.like-count.two');
                
                // Prevent double click
                this.disabled = true;
                
                // Send AJAX request to backend
                fetch('/like_svg', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        svg_id: fileId,
                        action: isLiked ? 'like' : 'unlike'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update UI with new like count
                        const newCount = data.like_count;
                        currentNumber.textContent = newCount;
                        moveNumber.textContent = newCount;
                        
                        // Update checkbox state based on server response
                        this.checked = data.is_liked;
                        
                        console.log(`‚úÖ Followed post ${data.message}: ${newCount} likes`);
                    } else {
                        // Revert UI if backend failed
                        this.checked = !isLiked;
                        console.log(`‚ùå Followed post ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Revert UI on error
                    this.checked = !isLiked;
                    alert('C√≥ l·ªói k·∫øt n·ªëi!');
                })
                .finally(() => {
                    this.disabled = false;
                });
            });
        });
    }

    // Real-time synchronization for followed posts via polling
    function startFollowedPostsPolling() {
        console.log('üîÑ Starting followed posts polling...');
        const pollInterval = 15000; // 15 seconds
        
        setInterval(function() {
            console.log('üîÑ Polling followed posts...', new Date().toLocaleTimeString());
            const container = document.getElementById('followed-posts-container');
            if (!container) {
                console.log('‚ùå Container not found, stopping polling');
                return;
            }
            
            // Ki·ªÉm tra flag to√†n c·ª•c
            if (window.activeFeedbackCount > 0) {
                return;
            }
            
            // Fetch updated followed posts
            console.log('üîÑ Fetching /api/followed_posts...');
            fetch('/api/followed_posts')
                .then(response => {
                    console.log('üîÑ API response status:', response.status);
                    if (!response.ok) {
                        if (response.status === 401) {
                            console.log('‚ùå User not logged in, stopping polling');
                            return null;
                        }
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(posts => {
                    if (!posts) return;
                    
                    // Check if there are new posts or updates
                    const hasNewPosts = posts.length !== currentPosts.length;
                    const hasUpdates = posts.some((post, index) => {
                        const currentPost = currentPosts[index];
                        return !currentPost || 
                               currentPost.like_count !== post.like_count ||
                               currentPost.is_liked_by_current_user !== post.is_liked_by_current_user;
                    });
                    
                    if (hasNewPosts || hasUpdates) {
                        console.log('üîÑ Followed posts updated, refreshing...');
                        loadFollowedPosts();
                    }
                })
                .catch(error => {
                    console.error('Followed posts polling error:', error);
                });
        }, pollInterval);
        
        console.log('üîÑ Started followed posts polling (15s interval)');
    }
    </script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 