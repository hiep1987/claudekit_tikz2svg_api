<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√†i ƒëƒÉng theo d√µi - TikZ to SVG</title>
    
    <!-- Global JavaScript variables -->
    <script>
        window.isLoggedIn = {{ 'true' if current_user.is_authenticated else 'false' }};
        window.activeFeedbackCount = 0;
        window.isOwner = {{ 'true' if is_owner else 'false' }};
    </script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
    
    <!-- Custom Tailwind-like CSS - Production Ready -->
    <style>
        /* Tailwind-like utility classes for production */
        .w-full { width: 100%; }
        .max-w-7xl { max-width: 80rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .bg-white\/80 { background-color: rgba(255, 255, 255, 0.8); }
        .backdrop-blur { backdrop-filter: blur(8px); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .rounded-2xl { border-radius: 1rem; }
        .p-3 { padding: 0.75rem; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .mb-8 { margin-bottom: 2rem; }
        .gap-2 { gap: 0.5rem; }
        .bg-gradient-to-br { background-image: linear-gradient(to bottom right, var(--tw-gradient-stops)); }
        .from-blue-500 { --tw-gradient-from: #3b82f6; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(59, 130, 246, 0)); }
        .to-yellow-400 { --tw-gradient-to: #fbbf24; }
        .p-1\.5 { padding: 0.375rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .text-white { color: #ffffff; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-gray-800 { color: #1f2937; }
        .font-bold { font-weight: 700; }
        .hidden { display: none; }
        .md\:flex { }
        .gap-6 { gap: 1.5rem; }
        .font-medium { font-weight: 500; }
        .text-gray-700 { color: #374151; }
        .relative { position: relative; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .cursor-pointer { cursor: pointer; }
        .transition { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .hover\:text-blue-600:hover { color: #2563eb; }
        .block { display: block; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .md\:block { }
        .bg-gradient-to-r { background-image: linear-gradient(to right, var(--tw-gradient-stops)); }
        .from-red-400 { --tw-gradient-from: #f87171; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(248, 113, 113, 0)); }
        .to-red-600 { --tw-gradient-to: #dc2626; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .py-1\.5 { padding-top: 0.375rem; padding-bottom: 0.375rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .hover\:scale-105:hover { transform: scale(1.05); }
        .font-semibold { font-weight: 600; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .from-blue-400 { --tw-gradient-from: #60a5fa; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(96, 165, 250, 0)); }
        .to-yellow-400 { --tw-gradient-to: #fbbf24; }
        .md\:hidden { }
        .p-1\.5 { padding: 0.375rem; }
        .hover\:bg-blue-100:hover { background-color: #dbeafe; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-gray-500 { color: #6b7280; }
        .hover\:text-blue-400:hover { color: #60a5fa; }
        .fixed { position: fixed; }
        .top-0 { top: 0px; }
        .left-0 { left: 0px; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .bg-black\/50 { background-color: rgba(0, 0, 0, 0.5); }
        .z-40 { z-index: 40; }
        .absolute { position: absolute; }
        .right-0 { right: 0px; }
        .w-60 { width: 15rem; }
        .bg-white { background-color: #ffffff; }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .flex-col { flex-direction: column; }
        .p-6 { padding: 1.5rem; }
        .gap-3 { gap: 0.75rem; }
        .self-end { align-self: flex-end; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5px; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .text-gray-700 { color: #374151; }
        .font-medium { font-weight: 500; }
        .hover\:bg-blue-100:hover { background-color: #dbeafe; }
        .mt-2 { margin-top: 0.5rem; }
        .text-center { text-align: center; }
        .mt-8 { margin-top: 2rem; }
        .w-6 { width: 1.5rem; }
        .h-6 { height: 1.5rem; }
        .rounded-full { border-radius: 9999px; }
        .bg-gradient-to-br { background-image: linear-gradient(to bottom right, var(--tw-gradient-stops)); }
        .from-blue-500 { --tw-gradient-from: #3b82f6; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(59, 130, 246, 0)); }
        .to-purple-600 { --tw-gradient-to: #9333ea; }
        .justify-center { justify-content: center; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .text-gray-700 { color: #374151; }
        
        /* Responsive breakpoints */
        @media (min-width: 768px) {
            .md\:flex { display: flex; }
            .md\:block { display: block; }
            .md\:hidden { display: none; }
        }
    </style>
    
    <!-- CodeMirror libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/stex/stex.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material.min.css">
    <style>
        body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          margin: 0 auto;
          padding: 20px;
          background-color: #f5f5f5;
        }
        
        /* New Navigation Styles */
        .menu-underline {
          transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
          height: 3px;
          width: 0;
          background: linear-gradient(90deg, #fbbf24, #38bdf8);
          border-radius: 2px;
          margin: 0 auto;
          position: absolute;
          bottom: -2px;
          left: 50%;
          transform: translateX(-50%);
        }
        .menu-item:hover .menu-underline, .menu-item.active .menu-underline {
          width: 80%;
        }
        
        /* Override custom CSS for menu items to remove unwanted styling */
        .menu-item {
          list-style: none !important;
        }
        
        .menu-item a {
          text-decoration: none !important;
          color: #374151 !important;
        }
        
        .menu-item:hover a {
          color: #2563eb !important;
        }
        
        /* Remove any bullet points or underlines from menu */
        .hidden.md\\:flex {
          list-style: none !important;
          padding: 0 !important;
          margin: 0 !important;
        }
        
        .hidden.md\\:flex li {
          list-style: none !important;
        }
        
        .hidden.md\\:flex li a {
          text-decoration: none !important;
        }
        
        /* Fix mobile menu styling */
        #mobile-menu a {
          text-decoration: none !important;
          color: #374151 !important;
        }
        
        #mobile-menu a:hover {
          color: #2563eb !important;
        }
        
        .container {
          background: white;
          padding: 40px;
          border-radius: 12px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.1);
          max-width: 1200px;
        }
        
        .navbar-header-user {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        #logout-btn {
          background: #d32f2f;
          color: white;
          padding: 8px 16px;
          border-radius: 6px;
          text-decoration: none;
          font-weight: bold;
          font-size: 14px;
        }
        
        .navbar-user-info {
          padding: 6px 14px;
          border-radius: 6px;
          gap: 8px;
          background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
          color: white;
          font-size: 14px;
          display: flex;
          align-items: center;
          text-decoration: none;
          cursor: pointer;
        }
        
        .navbar-avatar,
        .navbar-avatar-placeholder {
          width: 28px;
          height: 28px;
          border-radius: 50%;
          border: 2px solid #fff;
          object-fit: cover;
          background: #eee;
          flex-shrink: 0;
        }
        
        .navbar-avatar-placeholder {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          font-size: 14px;
        }
        
        .navbar-username {
          font-weight: 500;
          font-size: 13.5px;
          max-width: 100px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        .google-login-btn {
          max-width: 320px;
          display: flex;
          padding: 8px 16px;
          font-size: 14px;
          font-weight: 700;
          text-align: center;
          align-items: center;
          justify-content: center;
          border-radius: 6px;
          border: 1px solid rgba(0, 0, 0, 0.25);
          gap: 0.75rem;
          color: rgb(65, 63, 63);
          background-color: #fff;
          cursor: pointer;
          min-height: 40px;
        }

        .google-login-btn svg {
          height: 24px;
          flex-shrink: 0;
        }

        .google-login-btn:hover {
          transform: scale(1.02);
          background-color: #1565c0;
          color: white;
        }
        
        /* Files Grid */
        .files-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
          gap: 20px;
          margin-top: 20px;
          padding: 0;
          list-style: none;
        }

        /* Individual File Card */
        .file-card {
          position: relative;
          min-height: 260px;
          display: flex;
          flex-direction: column;
          justify-content: flex-start;
          background: #fff;
          border: 1px solid #ddd;
          border-radius: 10px;
          box-shadow: 0 2px 6px rgba(0,0,0,0.08);
          transition: transform 0.2s ease;
        }

        .file-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        /* Image Section */
        .file-img-container {
          position: relative;
          overflow: hidden;
          border-radius: 10px 10px 0 0;
          background: #fff;
          height: 180px;
          width: 100%;
        }

        .file-img-container img {
          width: 100%;
          height: 100%;
          object-fit: contain;
          display: block;
          background-color: #fff;
          transition: transform 0.3s ease;
        }

        .file-card:hover .file-img-container img {
          transform: scale(1.03);
        }

        /* Overlay Action Menu */
        .file-action-container {
          display: none;
          opacity: 0;
          pointer-events: none;
          transform: translateX(-10px);
          transition: opacity 0.3s, transform 0.3s;
          position: absolute;
          left: 12px;
          top: 60px;
          z-index: 300;
        }

        /* Desktop hover logic */
        @media (hover: hover) and (pointer: fine) {
          .file-img-container:hover + .file-action-container,
          .file-action-container:hover,
          .file-card:hover .file-action-container {
            display: block;
            opacity: 1;
            pointer-events: auto;
            transform: translateX(0);
          }
        }

        /* Mobile/Touch: Ch·ªâ hi·ªán khi card c√≥ class active */
        .file-card.active .file-action-container {
          display: block !important;
          opacity: 1 !important;
          pointer-events: auto !important;
          transform: translateX(0) !important;
        }

        .copy-btn {
          padding: 6px 14px;
          font-size: 14px;
          border-radius: 6px;
          cursor: pointer;
          transition: background 0.25s ease;
          display: inline-flex;
          align-items: center;
          gap: 8px;
          background: #f5f5f5;
          border: 1px solid #ddd;
        }

        .copy-btn:hover {
          background: #e0e0e0;
        }

        /* Mobile: Hi·ªán n√∫t toggle ... */
        .action-toggle-btn {
          display: none;
          position: absolute;
          top: 10px;
          right: 10px;
          z-index: 200;
          border: none;
          background: rgba(255,255,255,0.95);
          border-radius: 50%;
          width: 38px;
          height: 38px;
          font-size: 22px;
          cursor: pointer;
          box-shadow: 0 2px 4px rgba(0,0,0,0.13);
        }

        @media (hover: none), (pointer: coarse) {
          .action-toggle-btn {
            display: block;
          }
          /* V√¥ hi·ªáu h√≥a hover tr√™n mobile */
          .file-img-container:hover + .file-action-container {
            display: none !important;
            opacity: 0 !important;
            pointer-events: none !important;
          }
          .file-card.active .file-action-container .Btn.individual-active,
          .file-card.active .file-action-container .Btn.ready-to-execute,
          .file-card.active .file-action-container .Btn.mobile-hover {
            background: linear-gradient(-50deg, rgb(39, 107, 255), rgb(112, 186, 255), rgb(39, 107, 255)) !important;
            width: 120px !important; /* ƒê·ªô r·ªông n√∫t tr∆∞·ªõc hover */
            transition: width 0.3s cubic-bezier(0.4,0,0.2,1);
          }

          .file-card.active .file-action-container .Btn.individual-active .text,
          .file-card.active .file-action-container .Btn.ready-to-execute .text,
          .file-card.active .file-action-container .Btn.mobile-hover .text {
            opacity: 1 !important;
            width: auto !important;
            max-width: 85px !important;
            color: #ffffff !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
          }

          /* Override opacity for active buttons */
          .file-card.active .file-action-container .Btn.individual-active .text,
          .file-card.active .file-action-container .Btn.ready-to-execute .text {
            opacity: 1 !important;
          }

          .file-card.active .file-action-container .Btn:not(.individual-active):not(.ready-to-execute):not(.mobile-hover) {
            background: linear-gradient(-50deg, rgb(39, 107, 255), rgb(112, 186, 255), rgb(39, 107, 255)) !important;
            max-width: 10px !important;
            border-radius: 18px !important;
          }

          .file-card.active .file-action-container .Btn .text {
            opacity: 0.5 !important;
            width: auto !important;
            max-width: 120px !important;
            color: #ffffff !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
          }
        }

        .file-action-list {
          list-style: none;
          padding: 0;
          margin: 0;
          display: flex;
          flex-direction: column;
          gap: 8px;
          overflow: visible;
          width: auto;
        }

        .file-action-item {
          display: flex;
          justify-content: flex-start;
          width: 100%;
        }

        /* Button Styling */
        .Btn {
          display: flex;
          align-items: center;
          justify-content: flex-start;
          width: 35px;
          height: 35px;
          border: none;
          border-radius: 50%;
          cursor: pointer;
          position: relative;
          overflow: hidden;
          transition: all 0.3s ease;
          box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.199);
          background: linear-gradient(-50deg, rgb(39, 107, 255), rgb(112, 186, 255), rgb(39, 107, 255));
          background-size: 250%;
          background-position: left;
          min-width: 35px;
          flex-shrink: 0;
        }

        /* Icon container */
        .sign {
          width: 45px;
          height: 45px;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          justify-content: flex-start;
          padding-left: 4px;
          flex-shrink: 0;
          z-index: 2;
          position: relative;
        }

        .sign svg {
          width: 18px;
          height: 18px;
        }

        .sign svg path {
          fill: white;
        }

        .logoIcon {
          color: white;
          font-size: 16px;
        }

        /* Text label */
        .text {
          position: absolute;
          left: 20px;
          top: 50%;
          transform: translateY(-50%);
          width: 0;
          opacity: 0;
          color: white;
          font-size: 14px;
          font-weight: 600;
          transition: all 0.3s ease;
          white-space: nowrap;
          text-align: left;
          padding-left: 12px;
          z-index: 1;
        }

        /* Desktop hover effect */
        .Btn:hover {
          width: 140px;
          border-radius: 20px;
          background-position: right;
        }

        .Btn:hover .text {
          opacity: 1;
          width: auto;
          max-width: 85px;
          color: #ffffff;
          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* Button states for touch devices */
        .Btn.individual-active {
          background: linear-gradient(-50deg, rgb(39, 107, 255), rgb(112, 186, 255), rgb(39, 107, 255)) !important;
          width: 120px !important;
          border-radius: 20px !important;
        }

        .Btn.ready-to-execute {
          background: linear-gradient(-50deg, rgb(39, 107, 255), rgb(112, 186, 255), rgb(39, 107, 255)) !important;
          width: 120px !important;
          border-radius: 20px !important;
        }

        .Btn.individual-active .text,
        .Btn.ready-to-execute .text {
          opacity: 1 !important;
          width: auto !important;
          max-width: 85px !important;
          color: #ffffff !important;
          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
        }

        /* File Info Styling */
        .file-info {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 0px;
            font-size: 13px;
            color: #555;
        }

        .file-meta {
            margin-bottom: 6px;
            font-weight: 400;
        }

        .file-meta .label {
            font-weight: 500;
            color: #333;
        }

        .file-creator {
            margin-top: 8px;
            font-size: 13px;
            font-weight: 400;
        }

        /* Like Button Styles */
        input[id^="followed-heart-"] {
            display: none;
        }

        .like-button {
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            height: 32px;
            width: 90px;
            border-radius: 8px;
            border: none;
            background-color: #2d2d2d;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            padding: 0 8px;
        }

        .like-button input[type="checkbox"] {
            display: none;
        }

        .like {
            display: flex;
            cursor: pointer;
            align-items: center;
            gap: 4px;
            flex: 1;
        }

        .like-icon {
            fill: #808080;
            height: 16px;
            width: 16px;
            transition: fill 0.2s ease;
        }

        .like-text {
            color: #e0e0e0;
            font-size: 12px;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 500;
        }

        .like-count {
            color: #808080;
            font-size: 12px;
            font-weight: 500;
            margin-left: 4px;
            transition: all 0.3s ease;
        }

        .like-count.two {
            position: absolute;
            right: 8px;
            transform: translateY(20px);
            opacity: 0;
        }

        .like-count.one {
            position: relative;
        }

        input[id^="followed-heart-"]:checked ~ .like .like-icon {
            fill: #ff4757;
            animation: heartBeat 0.3s ease;
        }

        input[id^="followed-heart-"]:checked ~ .like-count.one {
            transform: translateY(-20px);
            opacity: 0;
        }

        input[id^="followed-heart-"]:checked ~ .like-count.two {
            transform: translateY(0);
            opacity: 1;
            color: #ff4757;
        }

        @keyframes heartBeat {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.3);
            }
            100% {
                transform: scale(1);
            }
        }

        /* No Followed Posts */
        .no-followed-posts {
            text-align: center;
            color: #666;
            padding: 40px 20px;
            background: #f9f9f9;
            border-radius: 12px;
            border: 2px dashed #ddd;
        }

        .no-followed-posts-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
          .container {
            padding: 20px;
          }
          
          /* Ensure white text for mobile hover states */
          .file-card.active .file-action-container .Btn.individual-active .text,
          .file-card.active .file-action-container .Btn.ready-to-execute .text {
            color: #ffffff !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
            opacity: 1 !important;
          }
        }

        /* CodeMirror styles cho TikZ code block */
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            position: relative;
        }
        .code-block pre {
            margin: 0;
            padding: 15px;
            background: transparent;
        }
        .code-block code {
            background: transparent;
            padding: 0;
        }
        .CodeMirror {
            height: 220px;
            font-size: 15px;
            border-radius: 6px;
            border: 1.5px solid #bbb;
            background: #f8f9fa;
            overflow: auto;
        }
        .tikz-code-block .CodeMirror {
            max-height: 300px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 5px;
            width: 100%;
        }
        .tikz-code-block {
            width: 100%;
        }
        .tikz-code-block .code-block {
            width: 100%;
        }
        .tikz-code-block .tikz-cm {
            display: none;
        }
        .CodeMirror-placeholder {
            color: #bbb !important;
            font-style: italic;
        }
        .CodeMirror-gutter, .CodeMirror-gutters, .CodeMirror-linenumbers {
            width: 2.5em !important;
            min-width: 2.5em !important;
        }
        .CodeMirror-linenumber, .CodeMirror-gutter-elt {
            min-width: 2em !important;
            width: 2em !important;
            text-align: right !important;
            padding-right: 0.5em !important;
            box-sizing: content-box !important;
        }

        /* TikZ code block header and copy button */
        .tikz-code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            border-radius: 5px 5px 0 0;
            font-weight: bold;
            color: #333;
        }

        .copy-btn {
            padding: 6px 14px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.25s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #f5f5f5;
            border: 1px solid #ddd;
        }

        .copy-btn:hover {
            background: #e0e0e0;
        }
        </style>

</head>
<body>
    <!-- New Navigation Bar -->
    <nav class="w-full max-w-7xl mx-auto bg-white/80 backdrop-blur shadow-lg rounded-2xl p-3 flex items-center justify-between mb-8">
        <!-- Logo -->
        <div class="flex items-center gap-2">
            <span class="bg-gradient-to-br from-blue-500 to-yellow-400 p-1.5 rounded-lg">
                <i class="fa-solid fa-meteor text-white text-lg"></i>
            </span>
            <span class="text-lg font-bold text-gray-800">TikZ to SVG</span>
        </div>
        
        <!-- Menu - Centered -->
        <ul class="hidden md:flex gap-6 items-center font-medium text-gray-700" style="margin: 0; padding: 0;">
            <li class="menu-item relative px-2 py-1 cursor-pointer transition hover:text-blue-600">
                <a href="/" class="block text-sm" style="line-height: 1;">Trang ch·ªß</a>
                <div class="menu-underline"></div>
            </li>
            <li class="menu-item relative px-2 py-1 cursor-pointer transition hover:text-blue-600">
                <a href="/profile/{{ current_user.id if current_user.is_authenticated else user_id }}/settings" class="block text-sm" style="line-height: 1;">H·ªì s∆°</a>
                <div class="menu-underline"></div>
            </li>
            <li class="menu-item relative px-2 py-1 cursor-pointer transition hover:text-blue-600">
                <a href="/profile/{{ user_id }}/svg-files" class="block text-sm" style="line-height: 1;">File SVG</a>
                <div class="menu-underline"></div>
            </li>
            <li class="menu-item relative px-2 py-1 cursor-pointer transition hover:text-blue-600">
                <a href="/profile/{{ user_id }}/followed-posts" class="block text-sm" style="line-height: 1;">B√†i ƒëƒÉng</a>
                <div class="menu-underline"></div>
            </li>
        </ul>
        
        <!-- Avatar/User or Login -->
        <div class="flex items-center gap-2">
            {% if current_user.is_authenticated %}
                <div class="flex items-center gap-2">
                    <div class="flex items-center gap-2 bg-gray-100 px-2 py-1.5 rounded-lg">
                        {% if current_avatar %}
                            <img src="{{ url_for('static', filename='avatars/' ~ current_avatar) }}" 
                                 alt="Avatar" class="w-6 h-6 rounded-full"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        {% endif %}
                        {% if not current_avatar %}
                            <div class="w-6 h-6 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-xs">
                                {{ current_user_email[0].upper() if current_user_email else 'U' }}
                            </div>
                        {% endif %}
                        <span class="text-xs font-medium text-gray-700">{{ current_username or current_user_email.split('@')[0] }}</span>
                    </div>
                    <a href="/logout" class="hidden md:block bg-gradient-to-r from-red-400 to-red-600 text-white px-3 py-1.5 rounded-xl shadow hover:scale-105 transition font-semibold text-xs" style="text-decoration: none;">ƒêƒÉng xu·∫•t</a>
                </div>
            {% else %}
                <button class="hidden md:block bg-gradient-to-r from-blue-400 to-yellow-400 text-white px-3 py-1.5 rounded-xl shadow hover:scale-105 transition font-semibold text-sm" onclick="window.location.href='/login/google'">ƒêƒÉng nh·∫≠p</button>
            {% endif %}
            <!-- Hamburger (mobile) -->
            <button id="menu-toggle" class="md:hidden p-1.5 rounded-lg hover:bg-blue-100 transition">
                <i class="fa-solid fa-bars text-lg"></i>
            </button>
        </div>
    </nav>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="fixed top-0 left-0 w-full h-full bg-black/50 z-40 hidden">
        <div class="absolute right-0 top-0 w-60 bg-white h-full shadow-lg flex flex-col p-6 gap-3">
            <button id="close-menu" class="self-end text-2xl text-gray-500 hover:text-blue-400">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <a href="/" class="py-2 px-3 rounded-lg text-gray-700 font-medium hover:bg-blue-100 transition">Trang ch·ªß</a>
            <a href="/profile/{{ current_user.id if current_user.is_authenticated else user_id }}/settings" class="py-2 px-3 rounded-lg text-gray-700 font-medium hover:bg-blue-100 transition">H·ªì s∆°</a>
            <a href="/profile/{{ user_id }}/svg-files" class="py-2 px-3 rounded-lg text-gray-700 font-medium hover:bg-blue-100 transition">File SVG</a>
            <a href="/profile/{{ user_id }}/followed-posts" class="py-2 px-3 rounded-lg text-gray-700 font-medium hover:bg-blue-100 transition">B√†i ƒëƒÉng</a>
            {% if current_user.is_authenticated %}
                <a href="/logout" class="bg-gradient-to-r from-red-400 to-red-600 text-white px-4 py-2 rounded-xl shadow font-semibold mt-2 text-center" style="text-decoration: none;">ƒêƒÉng xu·∫•t</a>
            {% else %}
                <button class="bg-gradient-to-r from-blue-400 to-yellow-400 text-white px-4 py-2 rounded-xl shadow font-semibold mt-8" onclick="window.location.href='/login/google'">ƒêƒÉng nh·∫≠p</button>
            {% endif %}
        </div>
    </div>

    <div class="container">
        <!-- Section B√†i ƒëƒÉng theo d√µi -->
        <section class="followed-posts-section" data-is-owner="{{ 'true' if is_owner else 'false' }}">
            <h3 style="color:#1976d2; margin-bottom:24px;">üì∞ B√†i ƒëƒÉng t·ª´ ng∆∞·ªùi b·∫°n theo d√µi</h3>
            <div id="followed-posts-container" class="files-grid">
                <div class="loading-spinner" style="text-align: center; padding: 20px;">
                    <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #1976d2; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 10px; color: #666;">ƒêang t·∫£i b√†i ƒëƒÉng...</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Modal ƒëƒÉng xu·∫•t ch·ªâ render n·∫øu ƒë√£ login -->
    {% if user_email %}
    <div id="logout-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center;">
      <div style="background:white; padding:32px 40px; border-radius:12px; box-shadow:0 2px 16px rgba(0,0,0,0.15); min-width:320px; text-align:center;">
        <h3 style="margin-bottom:24px;">ƒêƒÉng xu·∫•t?</h3>
        <a href="/logout" style="display:inline-block; background:#d32f2f; color:white; padding:10px 28px; border-radius:6px; text-decoration:none; font-weight:bold;">ƒêƒÉng xu·∫•t</a>
        <button onclick="document.getElementById('logout-modal').style.display='none'" style="margin-left:18px; background:#eee; color:#333; padding:10px 28px; border-radius:6px; border:none; font-weight:bold;">Hu·ª∑</button>
      </div>
    </div>
    {% endif %}

    <script>
    // Suppress deprecated DOMNodeInserted warnings silently
    const originalAddEventListener = EventTarget.prototype.addEventListener;
    EventTarget.prototype.addEventListener = function(type, listener, options) {
        if (type === 'DOMNodeInserted' || type === 'DOMNodeRemoved' || type === 'DOMSubtreeModified') {
            // Silently suppress deprecated MutationEvents without logging
            return;
        }
        return originalAddEventListener.call(this, type, listener, options);
    };
    
    // ==== MAIN DOMContentLoaded Event Listener ====
    document.addEventListener('DOMContentLoaded', function () {
        console.log('üöÄ Main DOMContentLoaded event listener initialized');
        
        // ==== Logout button logic ====
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function (e) {
                e.preventDefault();
                const logoutModal = document.getElementById('logout-modal');
                if (logoutModal) logoutModal.style.display = 'flex';
            });
        }

        // ==== Google login button logic ====
        const googleLoginBtn = document.querySelector('.google-login-btn');
        if (googleLoginBtn) {
            googleLoginBtn.addEventListener('click', function (e) {
                e.preventDefault();
                const currentPath = window.location.pathname + window.location.search;
                fetch('/set_next_url?url=' + encodeURIComponent(currentPath))
                    .then(() => window.location.href = '/login/google')
                    .catch(error => {
                        console.error('Error setting next URL:', error);
                        window.location.href = '/login/google';
                    });
            });
        }

        // ==== Load followed posts ====
        const followedSection = document.querySelector('.followed-posts-section');
        if (followedSection && followedSection.dataset.isOwner === 'true') {
            loadFollowedPosts();
            startFollowedPostsPolling();
        }

        // ==== Initialize button logic for followed posts ====
        // Touch device detection
        if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
            document.documentElement.classList.add('is-touch');
        }

        // ==== Initialize touch events for buttons ====
        initializeTouchBtnEvents();
        
        // ==== Initialize simple touch events for not logged in users ====
        if (!window.isLoggedIn) {
            initializeSimpleTouchEventsForNotLoggedIn();
        }

        // ==== Initialize CodeMirror ====
        // Ki·ªÉm tra xem CodeMirror ƒë√£ ƒë∆∞·ª£c load ch∆∞a
        if (typeof CodeMirror !== 'undefined') {
            initializeCodeMirror();
        } else {
            // Th·ª≠ l·∫°i sau 1 gi√¢y
            setTimeout(() => {
                if (typeof CodeMirror !== 'undefined') {
                    initializeCodeMirror();
                } else {
                    console.error('‚ùå CodeMirror failed to load');
                }
            }, 1000);
        }
        
        // ==== Initialize Facebook share buttons and copy link buttons ====
        initializeFbShareButtons();
        initializeCopyLinkButtons();
        
        // ==== Start polling for real-time updates ====
        if (window.isLoggedIn) {
            startLikePolling();
        }
        
        // ==== Mobile Menu Toggle ====
        const menuToggle = document.getElementById('menu-toggle');
        const mobileMenu = document.getElementById('mobile-menu');
        const closeMenu = document.getElementById('close-menu');
        
        if (menuToggle && mobileMenu && closeMenu) {
            menuToggle.addEventListener('click', () => mobileMenu.classList.remove('hidden'));
            closeMenu.addEventListener('click', () => mobileMenu.classList.add('hidden'));
            // Optional: click outside to close
            mobileMenu.addEventListener('click', e => {
                if(e.target === mobileMenu) mobileMenu.classList.add('hidden');
            });
        }
        
        // ==== ƒê√≥ng menu khi click b√™n ngo√†i ====
        document.addEventListener('click', function (e) {
            const activeCard = document.querySelector('.file-card.active');
            if (activeCard) {
                if (activeCard.dataset.preventClose === 'true') {
                    return;
                }
                
                if (!activeCard.contains(e.target) && !e.target.closest('.Btn') && !e.target.closest('.action-toggle-btn')) {
                    activeCard.classList.remove('active');
                }
            }
        });
        
        // ==== Check if CodeMirror is available ====
        if (typeof CodeMirror !== 'undefined') {
            console.log('‚úÖ CodeMirror loaded successfully');
        } else {
            console.warn('‚ö†Ô∏è CodeMirror not loaded, retrying...');
            // Retry loading CodeMirror if needed
            setTimeout(function() {
                if (typeof CodeMirror !== 'undefined') {
                    console.log('‚úÖ CodeMirror loaded on retry');
                } else {
                    console.error('‚ùå CodeMirror failed to load');
                }
            }, 1000);
        }
        
        // ==== Check if Bootstrap is available ====
        if (typeof bootstrap !== 'undefined') {
            console.log('‚úÖ Bootstrap loaded successfully');
        } else {
            console.warn('‚ö†Ô∏è Bootstrap not loaded');
        }
        
        console.log('‚úÖ All initialization completed successfully');
        
        // ==== Debug: Add event listener to track clicks on file-creator links ====
        document.addEventListener('click', function(e) {
            const link = e.target.closest('.file-creator a');
            if (link) {
                console.log('üîó Debug: Clicked on file-creator link:', link.href);
                console.log('üîó Debug: Link target:', link);
                console.log('üîó Debug: Event target:', e.target);
            }
        });
    });

    // Load followed posts from API
    function loadFollowedPosts() {
        console.log('üîÑ loadFollowedPosts called...');
        const container = document.getElementById('followed-posts-container');
        console.log('üîÑ Container found:', !!container);
        
        // Ki·ªÉm tra flag to√†n c·ª•c
        if (window.activeFeedbackCount > 0) {
            return;
        }
        
        fetch('/api/followed_posts')
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        // User not logged in
                        container.innerHTML = `
                            <div class="no-followed-posts">
                                <div class="no-followed-posts-icon">üîí</div>
                                <h4>Ch∆∞a ƒëƒÉng nh·∫≠p</h4>
                                <p>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem b√†i ƒëƒÉng t·ª´ ng∆∞·ªùi b·∫°n theo d√µi</p>
                            </div>
                        `;
                        return;
                    }
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(posts => {
                if (!posts) return;
                
                if (posts.length === 0) {
                    container.innerHTML = `
                        <div class="no-followed-posts">
                            <div class="no-followed-posts-icon">üë•</div>
                            <h4>Ch∆∞a c√≥ b√†i ƒëƒÉng n√†o</h4>
                            <p>H√£y theo d√µi m·ªôt s·ªë ng∆∞·ªùi d√πng ƒë·ªÉ xem b√†i ƒëƒÉng c·ªßa h·ªç ·ªü ƒë√¢y</p>
                        </div>
                    `;
                    return;
                }
                
                // Render posts
                const postsHTML = posts.map(post => `
                    <div class="file-card followed-post-card" data-post-id="${post.id}">
                      <button class="action-toggle-btn" type="button" aria-label="Hi·ªán menu h√†nh ƒë·ªông">‚ãØ</button>
                      <div class="file-info">
                        <div class="file-creator" style="margin-bottom: 0; font-size: 12px;">
                          üë§ <a href="/profile/${post.creator_id}/svg-files" style="text-decoration: none; color: #1976d2; font-weight: 700; font-size: 13px;" onclick="console.log('üîó Clicked on creator link:', '${post.creator_username}', '->', '/profile/${post.creator_id}/svg-files');">
                            ${post.creator_username}
                          </a>
                          <span style="margin-left:8px; color: #666; font-size: 11px;">${post.created_time_vn}</span>
                        </div>
                      </div>
                      <div class="file-img-container">
                        <img src="${post.url}" alt="${post.filename}">
                      </div>
                      <div class="like-button-wrapper" style="position: absolute; bottom: 8px; right: 8px; z-index: 100;">
                        <div class="like-button">
                          <input id="followed-heart-${post.id}" type="checkbox" ${post.is_liked_by_current_user ? 'checked' : ''} />
                          <label class="like" for="followed-heart-${post.id}">
                            <svg class="like-icon" fill-rule="nonzero" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                              <path d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z"></path>
                            </svg>
                            <span class="like-text">Likes</span>
                          </label>
                          <span class="like-count one">${post.like_count}</span>
                          <span class="like-count two">${post.like_count}</span>
                        </div>
                      </div>
                      <div class="file-action-container">
                        <ul class="file-action-list">
                          <li class="file-action-item">
                            <button type="button" class="Btn" data-filename="${post.filename}" onclick="window.location.href='/?view_svg=${post.filename}'">
                              <div class="sign">
                                <i class="fas fa-image logoIcon"></i>
                              </div>
                              <div class="text">T·∫£i ·∫£nh</div>
                            </button>
                          </li>
                         <li class="file-action-item">
                            <button type="button" class="Btn fb-share-btn" data-filename="${post.filename}" data-has-feedback="true">
                              <div class="sign">
                                <i class="fab fa-facebook logoIcon"></i>
                              </div>
                              <div class="text">Facebook</div>
                            </button>
                          </li>
                          <li class="file-action-item">
                            <button type="button" class="Btn file-copy-link-btn" data-url="https://tikz2svg.mathlib.io.vn/static/${post.filename}" data-has-feedback="true">
                              <div class="sign">
                                <i class="fas fa-link logoIcon"></i>
                              </div>
                              <div class="text">Copy Link</div>
                            </button>
                          </li>
                          ${post.tikz_code ? `
                          <li class="file-action-item">
                            <button type="button" class="Btn" onclick="toggleTikzCode(this)">
                              <div class="sign">
                                <i class="fas fa-code logoIcon"></i>
                              </div>
                              <div class="text">Xem Code</div>
                            </button>
                          </li>
                          ` : ''}

                        </ul>
                      </div>
                      
                      <!-- TikZ Code Section -->
                      ${post.tikz_code ? `
                      <div class="tikz-code-block" style="display:none; margin-top:10px;">
                        <div class="tikz-code-header">
                          <span>Code TikZ:</span>
                          <button class="copy-btn" onclick="copyTikzCode(this)">üìã Copy</button>
                        </div>
                        <div class="code-block">
                          <textarea class="tikz-cm" readonly>${post.tikz_code}</textarea>
                        </div>
                      </div>
                      ` : ''}
                    </div>
                `).join('');
                
                container.innerHTML = postsHTML;
                
                // Initialize like buttons for followed posts
                initializeFollowedPostLikeButtons();
                
                // Note: Event delegation ƒë√£ ƒë∆∞·ª£c setup trong DOMContentLoaded, 
                // n√™n kh√¥ng c·∫ßn re-initialize cho c√°c element m·ªõi ƒë∆∞·ª£c th√™m v√†o
            })
            .catch(error => {
                console.error('Error loading followed posts:', error);
                container.innerHTML = `
                    <div class="no-followed-posts">
                        <div class="no-followed-posts-icon">‚ùå</div>
                        <h4>L·ªói t·∫£i d·ªØ li·ªáu</h4>
                        <p>C√≥ l·ªói x·∫£y ra khi t·∫£i b√†i ƒëƒÉng. Vui l√≤ng th·ª≠ l·∫°i sau.</p>
                    </div>
                `;
            });
    }

    // Initialize like buttons for followed posts
    function initializeFollowedPostLikeButtons() {
        // Ch·ªâ kh·ªüi t·∫°o like buttons n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p
        if (!window.isLoggedIn) {
            return;
        }
        
        // Initialize like buttons
        document.querySelectorAll('input[id^="followed-heart-"]').forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                const fileId = this.id.replace('followed-heart-', '');
                const isLiked = this.checked;
                const likeButton = this.closest('.like-button');
                const currentNumber = likeButton.querySelector('.like-count.one');
                const moveNumber = likeButton.querySelector('.like-count.two');
                
                // Prevent double click
                this.disabled = true;
                
                // Send AJAX request to backend
                fetch('/like_svg', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        svg_id: fileId,
                        action: isLiked ? 'like' : 'unlike'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update UI with new like count
                        const newCount = data.like_count;
                        currentNumber.textContent = newCount;
                        moveNumber.textContent = newCount;
                        
                        // Update checkbox state based on server response
                        this.checked = data.is_liked;
                        
                        console.log(`‚úÖ Followed post ${data.message}: ${newCount} likes`);
                    } else {
                        // Revert UI if backend failed
                        this.checked = !isLiked;
                        console.log(`‚ùå Followed post ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Revert UI on error
                    this.checked = !isLiked;
                    alert('C√≥ l·ªói k·∫øt n·ªëi!');
                })
                .finally(() => {
                    this.disabled = false;
                });
            });
        });
    }

    // Real-time synchronization for followed posts via polling
    function startFollowedPostsPolling() {
        console.log('üîÑ Starting followed posts polling...');
        const pollInterval = 15000; // 15 seconds
        
        setInterval(function() {
            console.log('üîÑ Polling followed posts...', new Date().toLocaleTimeString());
            const container = document.getElementById('followed-posts-container');
            if (!container) {
                console.log('‚ùå Container not found, stopping polling');
                return;
            }
            
            // Ki·ªÉm tra flag to√†n c·ª•c
            if (window.activeFeedbackCount > 0) {
                return;
            }
            
            // Fetch updated followed posts
            console.log('üîÑ Fetching /api/followed_posts...');
            fetch('/api/followed_posts')
                .then(response => {
                    console.log('üîÑ API response status:', response.status);
                    if (!response.ok) {
                        if (response.status === 401) {
                            console.log('‚ùå User not logged in, stopping polling');
                            return null;
                        }
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(posts => {
                    if (!posts) return;
                    
                    // Check if there are new posts or updates
                    const hasNewPosts = posts.length !== currentPosts.length;
                    const hasUpdates = posts.some((post, index) => {
                        const currentPost = currentPosts[index];
                        return !currentPost || 
                               currentPost.like_count !== post.like_count ||
                               currentPost.is_liked_by_current_user !== post.is_liked_by_current_user;
                    });
                    
                    if (hasNewPosts || hasUpdates) {
                        console.log('üîÑ Followed posts updated, refreshing...');
                        loadFollowedPosts();
                    }
                })
                .catch(error => {
                    console.error('Followed posts polling error:', error);
                });
        }, pollInterval);
        
        console.log('üîÑ Started followed posts polling (15s interval)');
    }

    // Touch events for buttons (2-tap logic)
    function initializeTouchBtnEvents() {
        if (!document.documentElement.classList.contains('is-touch')) return;

        const originalHandlers = new Map();

        // S·ª≠ d·ª•ng event delegation thay v√¨ g·∫Øn tr·ª±c ti·∫øp
        document.addEventListener('click', function(e) {
            // ==== X·ª≠ l√Ω action-toggle-btn (n√∫t ...) ====
            const actionToggleBtn = e.target.closest('.action-toggle-btn');
            if (actionToggleBtn) {
                const card = actionToggleBtn.closest('.file-card');
                if (card) {
                    // ƒê√≥ng t·∫•t c·∫£ card kh√°c
                    document.querySelectorAll('.file-card.active').forEach(other => {
                        if (other !== card) other.classList.remove('active');
                    });
                    // Toggle card hi·ªán t·∫°i
                    card.classList.toggle('active');
                }
                return;
            }
            
            // ==== X·ª≠ l√Ω c√°c n√∫t .Btn ====
            const btn = e.target.closest('.Btn');
            if (!btn) return;
            
            // X·ª≠ l√Ω c√°c n√∫t .Btn trong card c√≥ class active
            if (btn.classList.contains('Btn')) {
                const card = btn.closest('.file-card');
                if (!card || !card.classList.contains('active')) return;

                // L·∫•y ho·∫∑c t·∫°o tapCount
                if (!btn.dataset.tapCount) btn.dataset.tapCount = '0';
                
                const currentTapCount = parseInt(btn.dataset.tapCount);
                
                if (currentTapCount === 0) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();

                    // Reset c√°c n√∫t kh√°c
                    card.querySelectorAll('.Btn').forEach(otherBtn => {
                        if (otherBtn !== btn) {
                            otherBtn.classList.remove('individual-active', 'ready-to-execute');
                            otherBtn.dataset.tapCount = '0';
                        }
                    });

                    btn.classList.add('individual-active', 'ready-to-execute');
                    btn.dataset.tapCount = '1';

                    // Auto reset sau 5s
                    setTimeout(() => {
                        if (btn.dataset.tapCount === '1') {
                            btn.classList.remove('individual-active', 'ready-to-execute');
                            btn.dataset.tapCount = '0';
                        }
                    }, 5000);
                    
                    return false;
                } 
                else if (currentTapCount === 1) {
                    // TAP 2: Execute action
                    
                    // L·∫•y onclick handler
                    let originalHandler;
                    const onclickAttr = btn.getAttribute('onclick');
                    if (onclickAttr) {
                        originalHandler = new Function(onclickAttr);
                    } else if (originalHandlers.has(btn)) {
                        originalHandler = originalHandlers.get(btn);
                    }

                    if (originalHandler) {
                        try {
                            originalHandler.call(btn, e);
                        } catch (error) {
                            console.error('Error executing handler:', error);
                        }
                    }

                    // ‚úÖ X·ª≠ l√Ω cho n√∫t "Facebook" (kh√¥ng c√≥ onclick)
                    if (btn.classList.contains('fb-share-btn') && btn.hasAttribute('data-filename')) {
                        const filename = btn.getAttribute('data-filename');
                        const shareUrl = `${window.location.origin}/view_svg/${filename}`;
                        copyToClipboardWithCustomFeedback(shareUrl, btn, 'Facebook', 'ƒê√£ copy!');
                        
                        // Gi·ªØ feedback hi·ªÉn th·ªã 2 gi√¢y tr∆∞·ªõc khi reset
                        setTimeout(() => {
                            btn.dataset.tapCount = '0';
                            btn.classList.remove('individual-active', 'ready-to-execute');
                        }, 2000);
                    }

                    // ‚úÖ X·ª≠ l√Ω cho n√∫t "Copy Link" (kh√¥ng c√≥ onclick)
                    else if (btn.classList.contains('file-copy-link-btn') && btn.hasAttribute('data-url')) {
                        const url = btn.getAttribute('data-url');
                        copyToClipboard(url, btn);
                        
                        // Gi·ªØ feedback hi·ªÉn th·ªã 2 gi√¢y tr∆∞·ªõc khi reset
                        setTimeout(() => {
                            btn.dataset.tapCount = '0';
                            btn.classList.remove('individual-active', 'ready-to-execute');
                        }, 2000);
                    }

                    // ‚úÖ Th√™m x·ª≠ l√Ω cho n√∫t "T·∫£i ·∫£nh" (kh√¥ng c√≥ onclick)
                    else if (btn.querySelector('.text')?.textContent === 'T·∫£i ·∫£nh') {
                        const filename = btn.getAttribute('data-filename');
                        if (filename) {
                            window.location.href = `/?view_svg=${filename}`;
                        } else {
                            console.error('Kh√¥ng t√¨m th·∫•y data-filename cho n√∫t T·∫£i ·∫£nh');
                        }
                        // Reset tr·∫°ng th√°i cho n√∫t T·∫£i ·∫£nh ngay l·∫≠p t·ª©c v√¨ s·∫Ω navigate
                        btn.dataset.tapCount = '0';
                        btn.classList.remove('individual-active', 'ready-to-execute');
                    }
                    
                    // ‚úÖ Th√™m x·ª≠ l√Ω cho n√∫t "Xem Code"
                    else if (btn.querySelector('.text')?.textContent === 'Xem Code' || btn.querySelector('.text')?.textContent === '·∫®n code') {
                        // G·ªçi function toggleTikzCode ƒë·ªÉ hi·ªÉn th·ªã/·∫©n code
                        toggleTikzCode(btn);
                        
                        // Gi·ªØ feedback hi·ªÉn th·ªã 1 gi√¢y tr∆∞·ªõc khi reset
                        setTimeout(() => {
                            btn.dataset.tapCount = '0';
                            btn.classList.remove('individual-active', 'ready-to-execute');
                        }, 1000);
                    } 
                    else {
                        // C√°c n√∫t kh√°c: Gi·ªØ feedback hi·ªÉn th·ªã 1 gi√¢y
                        setTimeout(() => {
                            btn.dataset.tapCount = '0';
                            btn.classList.remove('individual-active', 'ready-to-execute');
                        }, 1000);
                    }
                    
                    return false;
                }
            }
        }, true); // Capture phase
    }

    // Function x·ª≠ l√Ω touch events ƒë∆°n gi·∫£n cho tr∆∞·ªùng h·ª£p ch∆∞a ƒëƒÉng nh·∫≠p
    function initializeSimpleTouchEventsForNotLoggedIn() {
        if (!document.documentElement.classList.contains('is-touch')) return;
        if (window.isLoggedIn) return; // Ch·ªâ x·ª≠ l√Ω cho tr∆∞·ªùng h·ª£p ch∆∞a ƒëƒÉng nh·∫≠p

        // Logic 2-tap gi·ªëng nh∆∞ ƒë√£ ƒëƒÉng nh·∫≠p
        document.addEventListener('click', function(e) {
            // ==== X·ª≠ l√Ω action-toggle-btn (n√∫t ...) cho tr∆∞·ªùng h·ª£p ch∆∞a ƒëƒÉng nh·∫≠p ====
            const actionToggleBtn = e.target.closest('.action-toggle-btn');
            if (actionToggleBtn) {
                const card = actionToggleBtn.closest('.file-card');
                if (card) {
                    // ƒê√≥ng t·∫•t c·∫£ card kh√°c
                    document.querySelectorAll('.file-card.active').forEach(other => {
                        if (other !== card) other.classList.remove('active');
                    });
                    // Toggle card hi·ªán t·∫°i
                    card.classList.toggle('active');
                }
                return;
            }
            
            // ==== X·ª≠ l√Ω c√°c n√∫t .Btn ====
            const btn = e.target.closest('.Btn');
            if (!btn) return;
            
            const card = btn.closest('.file-card');
            if (!card) return;

            if (!card.classList.contains('active')) {
                // M·ªü menu tr∆∞·ªõc, kh√¥ng th·ª±c thi l·ªánh ngay
                document.querySelectorAll('.file-card.active').forEach(other => {
                    if (other !== card) {
                        other.classList.remove('active');
                    }
                });
                card.classList.add('active');
                // Ch·ªâ m·ªü menu, ch·ªù tap ti·∫øp theo m·ªõi th·ª±c thi l·ªánh
                return;
            }
            
            // Ch·ªâ x·ª≠ l√Ω cho tr∆∞·ªùng h·ª£p ch∆∞a ƒëƒÉng nh·∫≠p
            if (window.isLoggedIn) return;
            
            // L·∫•y ho·∫∑c t·∫°o tapCount
            if (!btn.dataset.tapCount) btn.dataset.tapCount = '0';
            const currentTapCount = parseInt(btn.dataset.tapCount);
            
            if (currentTapCount === 0) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();

                // Reset c√°c n√∫t kh√°c
                card.querySelectorAll('.Btn').forEach(otherBtn => {
                    if (otherBtn !== btn) {
                        otherBtn.classList.remove('individual-active', 'ready-to-execute');
                        otherBtn.dataset.tapCount = '0';
                    }
                });

                btn.classList.add('individual-active', 'ready-to-execute');
                btn.dataset.tapCount = '1';

                // Auto reset sau 5s
                setTimeout(() => {
                    if (btn.dataset.tapCount === '1') {
                        btn.classList.remove('individual-active', 'ready-to-execute');
                        btn.dataset.tapCount = '0';
                    }
                }, 5000);
                
                return false;
            } 
            else if (currentTapCount === 1) {
                // TAP 2: Hi·ªÉn th·ªã modal ƒëƒÉng nh·∫≠p
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();

                // Hi·ªÉn th·ªã modal ƒëƒÉng nh·∫≠p
                const loginModal = document.getElementById('login-modal');
                if (loginModal) {
                    loginModal.style.display = 'flex';
                } else {
                    // Fallback: redirect to login
                    window.location.href = '/login/google';
                }

                // Gi·ªØ feedback hi·ªÉn th·ªã 1 gi√¢y tr∆∞·ªõc khi reset
                setTimeout(() => {
                    btn.dataset.tapCount = '0';
                    btn.classList.remove('individual-active', 'ready-to-execute');
                }, 1000);
                
                return false;
            }
        }, true); // Capture phase
    }

    // Copy to clipboard functions
    function copyToClipboard(url, btn) {
        const card = btn.closest('.file-card');
        const actionContainer = card ? card.querySelector('.file-action-container') : null;
        
        // Ki·ªÉm tra xem c√≥ ph·∫£i HTTPS ho·∫∑c localhost kh√¥ng
        const isSecureContext = window.isSecureContext || window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        // Th·ª≠ s·ª≠ d·ª•ng navigator.clipboard tr∆∞·ªõc (ch·ªâ khi c√≥ quy·ªÅn)
        if (navigator.clipboard && isSecureContext) {
            navigator.clipboard.writeText(url).then(function() {
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = 'ƒê√£ copy!';
                    window.activeFeedbackCount++; // TƒÉng counter
                    setTimeout(() => { 
                        textDiv.textContent = 'Copy Link'; 
                        window.activeFeedbackCount--; // Gi·∫£m counter
                    }, 3000);
                }
            }).catch(function(err) {
                console.error('‚ùå Clipboard API failed:', err);
                console.log('üîÑ Falling back to execCommand method');
                // Fallback to execCommand
                fallbackCopyToClipboard(url, btn);
            });
        } else {
            // Fallback cho c√°c tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Clipboard API ho·∫∑c kh√¥ng c√≥ quy·ªÅn
            console.log('üîÑ Using fallback copy method (no clipboard permission)');
            fallbackCopyToClipboard(url, btn);
        }
    }

    function fallbackCopyToClipboard(url, btn) {
        console.log('üîÑ Executing fallback copy method for URL:', url);
        
        const textArea = document.createElement('textarea');
        textArea.value = url;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        
        try {
            textArea.focus();
            textArea.select();
            console.log('üîÑ Text selected, attempting to copy...');
            
            const successful = document.execCommand('copy');
            console.log('üîÑ execCommand result:', successful);
            
            if (successful) {
                console.log('‚úÖ Fallback copy successful');
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = 'ƒê√£ copy!';
                    window.activeFeedbackCount++; // TƒÉng counter
                    setTimeout(() => { 
                        textDiv.textContent = 'Copy Link'; 
                        window.activeFeedbackCount--; // Gi·∫£m counter
                    }, 3000);
                }
            } else {
                console.error('‚ùå execCommand copy failed');
                // Th·ª≠ hi·ªÉn th·ªã feedback ngay c·∫£ khi copy th·∫•t b·∫°i
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = 'Copy th·∫•t b·∫°i';
                    setTimeout(() => { 
                        textDiv.textContent = 'Copy Link'; 
                    }, 3000);
                }
                alert('Kh√¥ng th·ªÉ copy link. Vui l√≤ng copy th·ªß c√¥ng: ' + url);
            }
        } catch (err) {
            console.error('‚ùå execCommand copy error:', err);
            // Th·ª≠ hi·ªÉn th·ªã feedback ngay c·∫£ khi c√≥ l·ªói
            const textDiv = btn.querySelector('.text');
            if (textDiv) {
                textDiv.textContent = 'Copy th·∫•t b·∫°i';
                setTimeout(() => { 
                    textDiv.textContent = 'Copy Link'; 
                }, 3000);
            }
            alert('Kh√¥ng th·ªÉ copy link. Vui l√≤ng copy th·ªß c√¥ng: ' + url);
        } finally {
            // Lu√¥n cleanup textarea
            if (document.body.contains(textArea)) {
                document.body.removeChild(textArea);
            }
        }
    }

    function copyToClipboardWithCustomFeedback(url, btn, originalText, feedbackText) {
        const card = btn.closest('.file-card');
        const actionContainer = card ? card.querySelector('.file-action-container') : null;
        
        // Ki·ªÉm tra xem c√≥ ph·∫£i HTTPS ho·∫∑c localhost kh√¥ng
        const isSecureContext = window.isSecureContext || window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        // Th·ª≠ s·ª≠ d·ª•ng navigator.clipboard tr∆∞·ªõc (ch·ªâ khi c√≥ quy·ªÅn)
        if (navigator.clipboard && isSecureContext) {
            navigator.clipboard.writeText(url).then(function() {
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = feedbackText;
                    window.activeFeedbackCount++; // TƒÉng counter
                    
                    setTimeout(() => { 
                        textDiv.textContent = originalText; 
                        window.activeFeedbackCount--; // Gi·∫£m counter
                    }, 3000);
                }
            }).catch(function(err) {
                console.error('‚ùå Clipboard API failed (custom feedback):', err);
                // Fallback to execCommand
                fallbackCopyToClipboardWithCustomFeedback(url, btn, originalText, feedbackText);
            });
        } else {
            // Fallback cho c√°c tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Clipboard API ho·∫∑c kh√¥ng c√≥ quy·ªÅn
            console.log('üîÑ Using fallback copy method with custom feedback (no clipboard permission)');
            fallbackCopyToClipboardWithCustomFeedback(url, btn, originalText, feedbackText);
        }
    }

    function fallbackCopyToClipboardWithCustomFeedback(url, btn, originalText, feedbackText) {
        const textArea = document.createElement('textarea');
        textArea.value = url;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            
            if (successful) {
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = feedbackText;
                    window.activeFeedbackCount++; // TƒÉng counter
                    
                    setTimeout(() => { 
                        textDiv.textContent = originalText; 
                        window.activeFeedbackCount--; // Gi·∫£m counter
                    }, 3000);
                }
            } else {
                console.error('‚ùå execCommand copy failed (custom feedback)');
                // Th·ª≠ hi·ªÉn th·ªã feedback ngay c·∫£ khi copy th·∫•t b·∫°i
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = 'Copy th·∫•t b·∫°i';
                    setTimeout(() => { 
                        textDiv.textContent = originalText; 
                    }, 3000);
                }
                alert('Kh√¥ng th·ªÉ copy link. Vui l√≤ng copy th·ªß c√¥ng: ' + url);
            }
        } catch (err) {
            console.error('‚ùå execCommand copy error (custom feedback):', err);
            // Th·ª≠ hi·ªÉn th·ªã feedback ngay c·∫£ khi c√≥ l·ªói
            const textDiv = btn.querySelector('.text');
            if (textDiv) {
                textDiv.textContent = 'Copy th·∫•t b·∫°i';
                setTimeout(() => { 
                    textDiv.textContent = originalText; 
                }, 3000);
            }
            alert('Kh√¥ng th·ªÉ copy link. Vui l√≤ng copy th·ªß c√¥ng: ' + url);
        }
        
        document.body.removeChild(textArea);
    }

    // Toggle TikZ code function
    function toggleTikzCode(btn) {
        console.log('üîç toggleTikzCode function called');
        console.log('üîç btn:', btn);
        
        const card = btn.closest('.file-card');
        const codeBlock = card.querySelector('.tikz-code-block');
        const textDiv = btn.querySelector('.text');
        
        console.log('üîç card:', card);
        console.log('üîç codeBlock:', codeBlock);
        console.log('üîç textDiv:', textDiv);
        
        if (codeBlock.style.display === 'none' || !codeBlock.style.display) {
            codeBlock.style.display = 'block';
            textDiv.textContent = '·∫®n code';
            
            // Initialize CodeMirror when showing the code block
            setTimeout(() => {
                const textarea = codeBlock.querySelector('.tikz-cm');
                
                if (textarea && !textarea.CodeMirror) {
                    const existingCm = codeBlock.querySelector('.CodeMirror');
                    if (existingCm) {
                        existingCm.remove();
                    }
                    
                    if (typeof CodeMirror !== 'undefined') {
                        try {
                            const cmInstance = CodeMirror.fromTextArea(textarea, {
                                mode: 'stex',
                                theme: 'material',
                                lineNumbers: true,
                                readOnly: true,
                                lineWrapping: true,
                                foldGutter: true,
                                gutters: ['CodeMirror-linenumbers'],
                                viewportMargin: Infinity
                            });
                            
                            // Refresh CodeMirror after a short delay
                            setTimeout(() => {
                                cmInstance.refresh();
                            }, 100);
                        } catch (error) {
                            console.error('‚ùå Error creating CodeMirror instance:', error);
                        }
                    } else {
                        console.error('‚ùå CodeMirror is not defined!');
                    }
                }
            }, 50);
        } else {
            codeBlock.style.display = 'none';
            textDiv.textContent = 'Xem Code';
        }
    }

    // Copy TikZ code function
    function copyTikzCode(btn) {
        const card = btn.closest('.file-card');
        const textarea = card.querySelector('.tikz-cm');
        
        // L·∫•y code t·ª´ CodeMirror instance n·∫øu c√≥, n·∫øu kh√¥ng th√¨ t·ª´ textarea g·ªëc
        let code = textarea.value;
        
        // ∆Øu ti√™n l·∫•y t·ª´ CodeMirror instance
        if (textarea.CodeMirror) {
            code = textarea.CodeMirror.getValue();
            console.log('Getting code from CodeMirror instance');
        } else {
            console.log('Getting code from original textarea');
        }
        
        // Ki·ªÉm tra xem c√≥ ph·∫£i HTTPS ho·∫∑c localhost kh√¥ng
        const isSecureContext = window.isSecureContext || window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        if (navigator.clipboard && isSecureContext) {
            navigator.clipboard.writeText(code).then(function() {
                btn.textContent = 'ƒê√£ copy!';
                setTimeout(() => { 
                    btn.textContent = 'üìã Copy'; 
                }, 2000);
            }).catch(function(err) {
                console.error('‚ùå Clipboard API failed:', err);
                fallbackCopyTikzCode(code, btn);
            });
        } else {
            console.log('üîÑ Using fallback copy method for TikZ code (no clipboard permission)');
            fallbackCopyTikzCode(code, btn);
        }
    }

    function fallbackCopyTikzCode(code, btn) {
        const textArea = document.createElement('textarea');
        textArea.value = code;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                btn.textContent = 'ƒê√£ copy!';
                setTimeout(() => { 
                    btn.textContent = 'üìã Copy'; 
                }, 2000);
            } else {
                alert('Kh√¥ng th·ªÉ copy code. Vui l√≤ng copy th·ªß c√¥ng.');
            }
        } catch (err) {
            console.error('‚ùå execCommand copy error:', err);
            alert('Kh√¥ng th·ªÉ copy code. Vui l√≤ng copy th·ªß c√¥ng.');
        }
        
        document.body.removeChild(textArea);
    }

    // Initialize CodeMirror for TikZ code blocks
    function initializeCodeMirror() {
        document.querySelectorAll('.tikz-cm').forEach(function(textarea) {
            if (!textarea.CodeMirror) {
                const codeBlock = textarea.closest('.tikz-code-block');
                if (codeBlock) {
                    const existingCm = codeBlock.querySelector('.CodeMirror');
                    if (existingCm) {
                        existingCm.remove();
                    }
                    
                    if (typeof CodeMirror !== 'undefined') {
                        try {
                            const cmInstance = CodeMirror.fromTextArea(textarea, {
                                mode: 'stex',
                                theme: 'material',
                                lineNumbers: true,
                                readOnly: true,
                                lineWrapping: true,
                                foldGutter: true,
                                gutters: ['CodeMirror-linenumbers'],
                                viewportMargin: Infinity
                            });
                            
                            // Refresh CodeMirror after a short delay
                            setTimeout(() => {
                                cmInstance.refresh();
                            }, 100);
                        } catch (error) {
                            console.error('‚ùå Error creating CodeMirror instance:', error);
                        }
                    } else {
                        console.error('‚ùå CodeMirror is not defined!');
                    }
                }
            } else {
                const cmInstance = textarea.CodeMirror;
                setTimeout(() => {
                    cmInstance.refresh();
                }, 100);
            }
        });
    }

    // Function to initialize Facebook share buttons
    function initializeFbShareButtons() {
        // Initialize Facebook share buttons for followed post cards
        const followedFbShareBtns = document.querySelectorAll('.followed-post-card .fb-share-btn');
        console.log('üîÑ Initializing: Found', followedFbShareBtns.length, 'followed post fb-share-btn buttons');
        
        // Ch·ªâ th√™m event listener cho desktop khi ch∆∞a ƒëƒÉng nh·∫≠p (mobile s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi initializeTouchBtnEvents)
        if (!document.documentElement.classList.contains('is-touch') && !window.isLoggedIn) {
            followedFbShareBtns.forEach(function(btn) {
                // Ki·ªÉm tra xem button c√≥ ƒëang hi·ªÉn th·ªã feedback kh√¥ng
                const textDiv = btn.querySelector('.text');
                const isShowingFeedback = textDiv && textDiv.textContent === 'ƒê√£ copy!';
                
                if (!isShowingFeedback) {
                    // Remove existing event listeners
                    btn.replaceWith(btn.cloneNode(true));
                    const newBtn = document.querySelector(`[data-filename="${btn.getAttribute('data-filename')}"]`);
                    
                    if (newBtn) {
                        newBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            const filename = newBtn.getAttribute('data-filename');
                            console.log('üîÑ fb-share-btn clicked (desktop, not logged in), filename:', filename);
                            
                            if (!filename) {
                                console.error('‚ùå No filename found for fb-share-btn');
                                return;
                            }
                            
                            // Hi·ªÉn th·ªã modal ƒëƒÉng nh·∫≠p
                            const loginModal = document.getElementById('login-modal');
                            if (loginModal) {
                                loginModal.style.display = 'flex';
                            } else {
                                // Fallback: redirect to login
                                window.location.href = '/login/google';
                            }
                        });
                    }
                } else {
                    console.log('üîÑ Skipping fb-share-btn initialization - button is showing feedback');
                }
            });
        } else {
            console.log('üîÑ Skipping fb-share-btn initialization - mobile will be handled by initializeTouchBtnEvents, desktop logged in will be handled by Desktop logic');
        }
    }

    // Function to initialize copy link buttons
    function initializeCopyLinkButtons() {
        const followedCopyLinkBtns = document.querySelectorAll('.followed-post-card .file-copy-link-btn');
        console.log('üîÑ Initializing: Found', followedCopyLinkBtns.length, 'followed post file-copy-link-btn buttons');
        
        // Ch·ªâ th√™m event listener cho desktop khi ch∆∞a ƒëƒÉng nh·∫≠p (mobile s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi initializeTouchBtnEvents)
        if (!document.documentElement.classList.contains('is-touch') && !window.isLoggedIn) {
            followedCopyLinkBtns.forEach(function(btn) {
                // Th√™m event listener n·∫øu ch∆∞a c√≥ onclick attribute
                if (!btn.hasAttribute('onclick')) {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const url = btn.getAttribute('data-url');
                        console.log('üîÑ file-copy-link-btn clicked (desktop, not logged in), url:', url);
                        
                        if (!url) {
                            console.error('‚ùå No URL found for file-copy-link-btn');
                            return;
                        }
                        
                        // Hi·ªÉn th·ªã modal ƒëƒÉng nh·∫≠p
                        const loginModal = document.getElementById('login-modal');
                        if (loginModal) {
                            loginModal.style.display = 'flex';
                        } else {
                            // Fallback: redirect to login
                            window.location.href = '/login/google';
                        }
                    });
                }
            });
        } else {
            console.log('üîÑ Skipping copy link button initialization - mobile will be handled by initializeTouchBtnEvents, desktop logged in will be handled by Desktop logic');
        }
    }

    // Re-initialize buttons after a short delay to ensure DOM is ready
    setTimeout(function() {
        initializeFbShareButtons();
        initializeCopyLinkButtons();
        
        // ==== Th√™m logic cho Desktop buttons (ƒë√£ ƒëƒÉng nh·∫≠p) ====
        if (!document.documentElement.classList.contains('is-touch') && window.isLoggedIn) {
            console.log('üñ•Ô∏è Adding Desktop button logic (logged in)');
            
            // Th√™m event listener cho Desktop buttons
            document.addEventListener('click', function(e) {
                const btn = e.target.closest('.followed-post-card .fb-share-btn, .followed-post-card .file-copy-link-btn');
                if (!btn) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                if (btn.classList.contains('fb-share-btn')) {
                    const filename = btn.getAttribute('data-filename');
                    if (!filename) {
                        console.error('‚ùå No filename found for Desktop Facebook button');
                        return;
                    }
                    
                    const shareUrl = `${window.location.origin}/view_svg/${filename}`;
                    console.log('üñ•Ô∏è Desktop Facebook Share URL:', shareUrl);
                    
                    // S·ª≠ d·ª•ng function copyToClipboard v·ªõi custom feedback
                    copyToClipboardWithCustomFeedback(shareUrl, btn, 'Facebook', 'ƒê√£ copy!');
                    
                    console.log('‚úÖ Desktop Facebook button: Link copied successfully');
                } else if (btn.classList.contains('file-copy-link-btn')) {
                    const url = btn.getAttribute('data-url');
                    if (!url) {
                        console.error('‚ùå No URL found for Desktop Copy Link button');
                        return;
                    }
                    
                    console.log('üñ•Ô∏è Desktop Copy Link URL:', url);
                    
                    // S·ª≠ d·ª•ng function copyToClipboard
                    copyToClipboard(url, btn);
                    
                    console.log('‚úÖ Desktop Copy Link button: Link copied successfully');
                }
            });
        }
    }, 100);

    // Real-time synchronization via polling for followed posts
    function startLikePolling() {
        const pollInterval = 10000; // 10 seconds
        let lastUpdateTime = Date.now();
        
        console.log('üîÑ startLikePolling initialized with interval:', pollInterval, 'ms');
        
        setInterval(function() {
            // Get all file IDs on the page
            const fileCards = document.querySelectorAll('.followed-post-card');
            const fileIds = Array.from(fileCards).map(card => {
                return card.dataset.postId;
            }).filter(id => id); // Filter out undefined
            
            if (fileIds.length === 0) {
                console.log('üîÑ No followed post cards found for polling');
                return;
            }
            
            console.log('üîÑ Polling for', fileIds.length, 'followed posts:', fileIds);
            
            // Fetch updated like counts
            fetch('/api/like_counts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    ids: fileIds
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data && typeof data === 'object') {
                    // Update UI for changed files
                    Object.keys(data).forEach(fileId => {
                        const fileData = data[fileId];
                        const fileCard = document.querySelector(`.followed-post-card[data-post-id="${fileId}"]`);
                        
                        if (fileCard && fileData) {
                            const likeButton = fileCard.querySelector('.like-button');
                            const likeCountSpan = fileCard.querySelector('.like-count.one');
                            const moveNumber = fileCard.querySelector('.like-count.two');
                            
                            // C·∫≠p nh·∫≠t cho tr∆∞·ªùng h·ª£p ƒë√£ ƒëƒÉng nh·∫≠p (c√≥ like-button)
                            if (likeButton && likeCountSpan && moveNumber) {
                                const currentCount = parseInt(likeCountSpan.textContent) || 0;
                                const newLikeCount = fileData.like_count || 0;
                                
                                // Update like count if changed
                                if (currentCount !== newLikeCount) {
                                    likeCountSpan.textContent = newLikeCount;
                                    moveNumber.textContent = newLikeCount;
                                    console.log(`üîÑ Real-time update: Followed post ${fileId} now has ${newLikeCount} likes (logged in)`);
                                    
                                    // Add visual feedback
                                    likeButton.style.animation = 'pulse 0.5s ease-in-out';
                                    setTimeout(() => {
                                        likeButton.style.animation = '';
                                    }, 500);
                                }
                                
                                // Update checkbox state if changed
                                const checkbox = likeButton.querySelector('input[type="checkbox"]');
                                if (checkbox && fileData.is_liked_by_current_user !== undefined) {
                                    const currentChecked = checkbox.checked;
                                    const newChecked = fileData.is_liked_by_current_user;
                                    
                                    if (currentChecked !== newChecked) {
                                        checkbox.checked = newChecked;
                                        console.log(`üîÑ Real-time update: Followed post ${fileId} like status changed to ${newChecked}`);
                                        
                                        // Trigger change event to update UI styling
                                        const event = new Event('change', { bubbles: true });
                                        checkbox.dispatchEvent(event);
                                    }
                                }
                            }
                        }
                    });
                    
                    lastUpdateTime = Date.now();
                }
            })
            .catch(error => {
                console.error('Followed posts polling error:', error);
            });
        }, pollInterval);
    }
    </script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>

<!-- Production-ready script loading -->
<script>
    // Modern event handling to avoid deprecated warnings
    if (typeof window !== 'undefined') {
        // Use modern APIs instead of deprecated ones
        window.addEventListener('load', function() {
            console.log('‚úÖ Page loaded successfully');
        });
        
        // Replace deprecated DOMNodeInserted with MutationObserver
        if (typeof MutationObserver !== 'undefined') {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        // Handle DOM changes here if needed
                        // This replaces the deprecated DOMNodeInserted event
                    }
                });
            });
            
            // Start observing
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            console.log('‚úÖ Modern MutationObserver initialized');
        }
    }
</script>
</body>
</html> 