{% extends "base.html" %}

{# Configuration flags #}
{% set include_highlight_js = true %}
{% set include_codemirror = true %}
{% set include_file_card = true %}
{% set include_navigation = true %}
{% set include_login_modal = true %}
{% set include_navbar = true %}

{# Page Title #}
{% block title %}K·∫øt qu·∫£ t√¨m ki·∫øm - TikZ to SVG{% endblock %}

{# Body attributes for authentication #}
{% block body_attrs %} data-is-logged-in="{% if user_email %}true{% else %}false{% endif %}" data-set-next-url="{{ url_for('set_next_url') }}" data-search-query="{{ search_query }}" data-results-count="{{ results_count }}"{% endblock %}

{# Page-specific CSS #}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/search_results.css', v='1.0') }}">
{% endblock %}

{# Page Content #}
{% block content %}
<!-- Search Results Header -->
<div class="search-results-header">
    <h1>üîç K·∫øt qu·∫£ t√¨m ki·∫øm</h1>
    <div class="search-query">{{ search_type_description }}: "{{ search_query }}"</div>
    <div class="results-count">
        T√¨m th·∫•y {{ results_count }} k·∫øt qu·∫£
    </div>
    <a href="/" class="back-to-home">
        <i class="fas fa-arrow-left"></i> V·ªÅ trang ch·ªß
    </a>
</div>

<!-- Search Results Section -->
<div class="files-section-container files-section" data-is-owner="{{ 'true' if user_email else 'false' }}">
    <div id="search-results-container" class="files-grid">
        {% if search_results %}
            {% for file in search_results %}
                {% include 'partials/_file_card.html' %}
            {% endfor %}
        {% else %}
            <div class="no-files">
                <div class="no-files-icon">üîç</div>
                <h4>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</h4>
                <p>Kh√¥ng c√≥ ·∫£nh SVG n√†o kh·ªõp v·ªõi {{ search_type_description|lower }} "{{ search_query }}"</p>
                <p class="back-link">
                    <a href="/">‚Üê Quay v·ªÅ trang ch·ªß</a>
                </p>
            </div>
        {% endif %}
    </div>
    
    <!-- =====================================================
         OPTIMIZATION: PAGINATION UI (Same as index & other pages)
         ===================================================== -->
    {% if search_results and total_pages > 1 %}
    <div class="pagination-container" style="margin-top: 2rem; display: flex; justify-content: center; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
        <!-- Previous Button -->
        {% if has_prev %}
            <a href="?q={{ search_query }}&type={{ search_type }}&page={{ page - 1 }}" class="pagination-btn pagination-btn-prev" title="Trang tr∆∞·ªõc">
                ‚Üê Tr∆∞·ªõc
            </a>
        {% else %}
            <span class="pagination-btn pagination-btn-prev pagination-btn-disabled">
                ‚Üê Tr∆∞·ªõc
            </span>
        {% endif %}
        
        <!-- Page Numbers -->
        <div class="pagination-numbers" style="display: flex; gap: 0.25rem;">
            {% for page_num in page_numbers %}
                {% if page_num == '...' %}
                    <span class="pagination-ellipsis">...</span>
                {% elif page_num == page %}
                    <span class="pagination-btn pagination-btn-active">{{ page_num }}</span>
                {% else %}
                    <a href="?q={{ search_query }}&type={{ search_type }}&page={{ page_num }}" class="pagination-btn">{{ page_num }}</a>
                {% endif %}
            {% endfor %}
        </div>
        
        <!-- Next Button -->
        {% if has_next %}
            <a href="?q={{ search_query }}&type={{ search_type }}&page={{ page + 1 }}" class="pagination-btn pagination-btn-next" title="Trang sau">
                Sau ‚Üí
            </a>
        {% else %}
            <span class="pagination-btn pagination-btn-next pagination-btn-disabled">
                Sau ‚Üí
            </span>
        {% endif %}
    </div>
    
    <!-- Pagination Info -->
    <div class="pagination-info" style="text-align: center; margin-top: 1rem; color: #666; font-size: 0.9rem;">
        Trang {{ page }} / {{ total_pages }} ‚Ä¢ Hi·ªÉn th·ªã {{ search_results|length }} / {{ total_items }} k·∫øt qu·∫£
    </div>
    {% endif %}
</div>
{% endblock %}

{# Page-specific JavaScript #}
{% block extra_js %}
<!-- Page-specific JavaScript only - libraries loaded in base.html -->
<script>
    // Initialize window.appState for file_card.js compatibility
    window.appState = {
        loggedIn: {% if user_email %}true{% else %}false{% endif %},
        userEmail: {% if user_email %}'{{ user_email }}'{% else %}null{% endif %}
    };
    
    // Track search results page view
    document.addEventListener('DOMContentLoaded', function() {
        if (window.analytics) {
            const searchQuery = document.body.getAttribute('data-search-query');
            const resultCount = parseInt(document.body.getAttribute('data-results-count') || '0');
            
            // Track search results page view
            window.analytics.trackSearch(searchQuery, 'results_page_view', resultCount);
            
            // Track search performance (success/failure)
            if (resultCount > 0) {
                window.analytics.trackUserAction('search_success', {
                    'query': searchQuery,
                    'result_count': resultCount
                });
            } else {
                window.analytics.trackUserAction('search_no_results', {
                    'query': searchQuery
                });
            }
        }
    });
</script>
<script src="{{ url_for('static', filename='js/file_card.js', v='1.3') }}"></script>
{% endblock %}