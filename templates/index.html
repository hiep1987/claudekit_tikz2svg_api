{% extends "base.html" %}

{% block title %}TikZ to SVG{% endblock %}

{% block extra_css %}
<!-- Index Page CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css', v='2.0') }}">
{% endblock %}

{% block head_js %}
<!-- Truy·ªÅn tr·∫°ng th√°i login t·ª´ server v√†o JS (ƒë·ªÉ linter kh√¥ng b√°o l·ªói) -->
<script id="app-state" type="application/json">{{ {
  'loggedIn': logged_in,
  'userEmail': user_email,
  'username': username,
  'avatar': avatar,
  'loginUrl': url_for('google.login')
} | tojson | safe }}</script>
<!-- Gi√° tr·ªã TikZ ban ƒë·∫ßu ƒë·ªÉ kh·ªüi t·∫°o CodeMirror -->
<script id="initial-tikz" type="application/json">{{ tikz_code|default('')|tojson|safe }}</script>
<script>
  window.appState = JSON.parse(document.getElementById('app-state').textContent);
</script>
{% endblock %}

{% block extra_js %}
<!-- Application JavaScript -->
<script src="{{ url_for('static', filename='js/navigation.js', v='1.0') }}"></script>
<script src="{{ url_for('static', filename='js/file_card.js', v='1.2') }}"></script>
<script src="{{ url_for('static', filename='js/index.js', v='1.0') }}"></script>
{% endblock %}

{% set include_highlight_js = true %}
{% set include_codemirror = true %}
{% set include_file_card = true %}
{% set include_navigation = true %}
{% set include_navbar = true %}
{% set include_login_modal = true %}

{% block content %}
<!-- Search Bar -->
<div class="search-container page-container index-top-container">
    <h3 class="search-title">T√¨m ki·∫øm ·∫£nh SVG</h3>

    <!-- Search Type Selection -->
    <div class="search-type-selector">
        <button type="button" class="search-type-option active" id="search-type-keywords" data-type="keywords">
            <span class="radio-label">T·ª´ kh√≥a</span>
        </button>
        <button type="button" class="search-type-option" id="search-type-username" data-type="username">
            <span class="radio-label">T√™n t√†i kho·∫£n</span>
        </button>
    </div>

    <div class="group">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" class="icon">
            <path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607z"/>
        </svg>
        <input class="input" type="search" placeholder="T√¨m theo t·ª´ kh√≥a..." id="main-search-input" />
        <div id="search-suggestions" class="search-suggestions"></div>
    </div>
</div>

<!-- Search Blur Overlay -->
<div id="search-blur-overlay" class="search-blur-overlay"></div>

<!-- Block 2: Input-Preview Section -->
<div class="input-preview-section page-container">
    <h2 class="index-title">Chuy·ªÉn ƒë·ªïi TikZ sang SVG/PNG/JPEG</h2>

    <div class="table-scroll-x">
      <div class="table-content">
        <div class="col">
          <form id="tikz-form" method="post" onsubmit="console.log('Form submit event'); return submitTikzCodeAjax(event)">
            <textarea name="code" id="code" class="tikz-code-textarea" rows="12" placeholder="Nh·∫≠p code TikZ t·∫°i ƒë√¢y...">{{ tikz_code|default('') }}</textarea>
            <div class="d-flex justify-content-start align-items-center gap-2" id="compile-save-row">
              <button type="submit" id="compile-btn" class="compile-save-row-btn" {% if not logged_in %}title="B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p Google ƒë·ªÉ s·ª≠ d·ª•ng"{% endif %}>Bi√™n d·ªãch</button>
              <button
                type="button"
                id="save-server-btn"
                class="compile-save-row-btn"
                data-file-id="{{ svg_temp_id }}"
                data-tikz-code="{{ tikz_code | e }}"
                style="display: none;"
              >
                üíæ L∆∞u server
              </button>
            </div>
          </form>
        </div>
        <div class="col">
          {% if error %}
            <div class="error">{{ error|safe }}</div>
          {% elif svg_temp_url %}
            <img src="{{ svg_temp_url }}" alt="SVG Preview" class="preview-img">
          {% else %}
            <div class="preview-placeholder">
              <p>Nh·∫≠p code TikZ ƒë·ªÉ xem preview real-time</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
    <!-- Th√¥ng b√°o h∆∞·ªõng d·∫´n cho mobile - Enhanced UX -->
    <div id="mobile-scroll-hint" class="mobile-scroll-hint">
      <div class="hint-content">
        <span class="hint-icon">üëÜ</span>
        <span class="hint-text">Vu·ªët ngang ƒë·ªÉ xem ƒë·ªß 2 c·ªôt</span>
        <button class="hint-dismiss" aria-label="ƒê√≥ng th√¥ng b√°o">√ó</button>
      </div>
    </div>

    {# Th√™m block n√†y NGAY SAU form, TR∆Ø·ªöC result-tools-section #}
    {% if error %}
        <div class="result-section">
            <div class="error">{{ error|safe }}
                {% if error_log_full %}
                    <br><button id="show-log-btn">Hi·ªÉn th·ªã chi ti·∫øt log</button>
                    <pre id="full-log">{{ error_log_full }}</pre>
                {% endif %}
            </div>
        </div>
    {% endif %}

    {% if svg_temp_url and not error %}
</div> <!-- ƒë√≥ng .input-preview-section tr∆∞·ªõc khi tools -->

<div id="result-tools-section" class="page-container">
            <div class="export-section">
                <h4>Xu·∫•t ·∫£nh PNG/JPEG</h4>
                <form id="export-form" class="export-form">
                    <div class="export-pair">
                        <label for="export-format" class="export-label">ƒê·ªãnh d·∫°ng:</label>
                        <select id="export-format" class="export-input export-select">
                            <option value="png">PNG</option>
                            <option value="jpeg">JPEG</option>
                        </select>
                    </div>
                    <div class="export-pair">
                        <label for="export-dpi" class="export-label">DPI:</label>
                        <input type="number" id="export-dpi" min="1" class="export-input export-number" placeholder="Auto">
                    </div>
                    <div class="export-pair">
                        <label for="export-width" class="export-label">Width (px):</label>
                        <input type="number" id="export-width" min="1" class="export-input export-number" placeholder="Auto">
                    </div>
                    <div class="export-pair">
                        <label for="export-height" class="export-label">Height (px):</label>
                        <input type="number" id="export-height" min="1" class="export-input export-number" placeholder="Auto">
                    </div>
                    <div class="export-btn-group">
                        <button id="export-btn" type="button" class="export-btn" data-file-id="{{ svg_temp_id }}">T·∫£i xu·ªëng</button>
                    </div>
                </form>
                <div id="export-msg"></div>
            </div>

            {% if svg_content %}
                <div class="code-section">
                    <button id="toggle-svg-code-btn" class="copy-btn" type="button">üìú Xem code SVG</button>
                    <div id="svg-code-container">
                        <div class="code-header">
                            <span class="code-title">Code SVG:</span>
                            <button id="copy-svg-code-btn" class="copy-btn" type="button">üìã Copy Code</button>
                        </div>
                        <div class="code-block" id="svg-code">
                            <pre><code class="language-xml">{{ svg_content }}</code></pre>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    {% else %}
</div> <!-- ƒë√≥ng .input-preview-section -->
    {% endif %}

<!-- Block 3: Files Section -->
<div class="files-section-container files-section" data-is-owner="{{ 'true' if logged_in else 'false' }}">
    <h3 class="files-section-title">üìÅ Files ƒë√£ l∆∞u</h3>
    <div id="files-container" class="files-grid">
        {% if svg_files %}
            {% for file in svg_files %}
                {% include 'partials/_file_card.html' %}
            {% endfor %}
        {% else %}
            <div class="no-files">
                <div class="no-files-icon">üìÅ</div>
                <h4>Ch∆∞a c√≥ files n√†o</h4>
                <p>H√£y t·∫°o file SVG ƒë·∫ßu ti√™n c·ªßa b·∫°n!</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Modal nh·∫≠p t·ª´ kh√≥a Bootstrap -->
<div class="modal fade" id="keywordModal" tabindex="-1" aria-labelledby="keywordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="keywordModalLabel">Nh·∫≠p m√¥ t·∫£ / t·ª´ kh√≥a</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- ·∫¢nh SVG preview -->
          <div id="modal-svg-preview">
            <img id="modal-svg-img" src="" alt="SVG Preview">
          </div>
          <p>Nh·∫≠p c√°c t·ª´ kh√≥a, c√°ch nhau b·∫±ng d·∫•u ph·∫©y:</p>
          <div class="position-relative">
            <textarea id="keywordsInput" class="form-control" rows="4" placeholder="V√≠ d·ª•: to√°n h·ªçc, h√¨nh h·ªçc, ƒë·ªì th·ªã"></textarea>
            <div id="keyword-suggestions" 
                 class="list-group position-absolute w-100"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" class="btn btn-primary" id="confirmKeywordBtn">X√°c nh·∫≠n</button>
        </div>
      </div>
    </div>
</div>
{% endblock %}