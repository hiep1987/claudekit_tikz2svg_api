Ki·ªÉm tra ti·∫øp
Duplicate Route Registration

python
# ‚ùå ƒêƒÉng k√Ω blueprint 2 l·∫ßn
@google_bp.route("/authorized")
def after_auth():
    # ...
app.register_blueprint(google_bp, url_prefix="/login")
Kh·∫Øc ph·ª•c:

python
# ‚úÖ Ch·ªâ ƒëƒÉng k√Ω blueprint m·ªôt l·∫ßn v√† s·ª≠ d·ª•ng decorator ƒë√∫ng c√°ch
@app.route('/auth/google/callback')
def google_callback():
    if not google.authorized:
        flash('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i', 'error')
        return redirect(url_for('index'))
    
    # X·ª≠ l√Ω callback logic...

    t√¥i ƒëang g·∫∑p m·ªôt v·∫•n ƒë·ªÅ nghi·ªám tr·ªçng sau, trong cSDL c·ªßa t√¥i hi·ªán t·∫°i c√≥ 2 user, 
trong gg consol ƒë√£ th√™m email test l√† hiep.data.tk@gmail.com
khi truy c·∫≠p trang https://tikz2svg.mathlib.io.vn/ ch·ªçn 2 t√†i kho·∫£n gg ƒë√£ c√≥ trong CSDL, web ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng, truy xu·∫•t v√† ghi CSDL ok, th·ªÉ hi·ªán: s·ª≠a t√™n t√†i kho·∫£n,l∆∞u,load ok.
khi ch·ªçn t√†i kho·∫£n gg hiep.data.tk@gmail.com th√¨ c√≥ 2 l·ªói sau:
+Kh√¥ng t·∫°o ƒë∆∞·ª£c user m·ªõi trong CSDL.
+C√°c ch·ª©c nƒÉng d√†nh cho t√†i kho·∫£n ƒëƒÉng nh·∫≠p kh√¥ng ho·∫°t ƒë·ªông
+ƒë·∫∑c bi·ªát truy c·∫≠p v√† ch·ªçn 2 t√†i kho·∫£n gg ƒë√£ c√≥ trong CSDL c≈©ng kh√¥ng ho·∫°t ƒë·ªông, th·ªÉ hi·ªán: kh√¥ng hi·ªán t√™n t√†i kho·∫£n v√† s·ª≠ d·ª•ng c√°C ch·ª©c nƒÉng kh√¥ng ƒë∆∞·ª£c.
+truy c·∫≠p https://tikz2svg.mathlib.io.vn/force_logout_dance m·ªõi kh√¥i ph·ª•c tr·∫°ng th√°i ƒë∆∞·ª£c ban ƒë·∫ßu
@app.route("/force_logout_dance")
def force_logout_dance():
    print("DEBUG: Force logout Dance endpoint accessed.", flush=True)
    if hasattr(google, 'token'):
        print("DEBUG: Deleting google.token.", flush=True)
        del google.token
    else:
        print("DEBUG: google.token not found.", flush=True)

    if 'user_email' in session:
        print(f"DEBUG: Popping user_email: {session['user_email']}.", flush=True)
        session.pop('user_email')
    if 'google_id' in session:
        print(f"DEBUG: Popping google_id: {session['google_id']}.", flush=True)
        session.pop('google_id')

    session.clear() # ƒê·∫£m b·∫£o to√†n b·ªô session ƒë∆∞·ª£c d·ªçn d·∫πp
    session.modified = True # ƒê·∫£m b·∫£o Flask l∆∞u thay ƒë·ªïi
    print("DEBUG: Session cleared completely.", flush=True)
    flash("T·∫•t c·∫£ session v√† token Flask-Dance ƒë√£ ƒë∆∞·ª£c x√≥a. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.", "info")
    return redirect(url_for("index"))

    T√¥i s·∫Ω li·ªát k√™ t·∫•t c·∫£ code li√™n quan ƒë·∫øn OAuth trong file app.py:
T·∫•t c·∫£ Code Li√™n Quan ƒê·∫øn OAuth
1. Import v√† C·∫•u h√¨nh
# Import Flask-Dance
from flask_dance.contrib.google import make_google_blueprint, google

# C·∫•u h√¨nh b·∫£o m·∫≠t session
app.config.update(
    SESSION_COOKIE_SECURE=True,
    SESSION_COOKIE_HTTPONLY=True,
    SESSION_COOKIE_SAMESITE='Lax'
)

# Secret key cho session
app.secret_key = os.environ.get('FLASK_SECRET_KEY', 'FLASK_SECRET_KEY')
2. T·∫°o Google OAuth Blueprint
google_bp = make_google_blueprint(
    client_id=os.environ.get('GOOGLE_CLIENT_ID', 'GOOGLE_CLIENT_ID'),
    client_secret=os.environ.get('GOOGLE_CLIENT_SECRET', 'GOOGLE_CLIENT_SECRET'),
    scope=["openid", "https://www.googleapis.com/auth/userinfo.profile", "https://www.googleapis.com/auth/userinfo.email"],
    reprompt_select_account=True 
)
app.register_blueprint(google_bp, url_prefix="/login")
3. Route ƒêƒÉng Nh·∫≠p
@google_bp.route("/login")
def login_with_google():
    return redirect(url_for("google.authorize"))
4. Route Callback Sau Khi ·ª¶y Quy·ªÅn
@google_bp.route("/authorized")
def after_auth():
    print("DEBUG: Entering /login/google/authorized", flush=True)
    try:
        resp = google.get("/oauth2/v2/userinfo")
        if resp.ok:
            info = resp.json()
            user_email = info["email"]
            google_id = info["id"]
            
            # L∆∞u th√¥ng tin user v√†o session
            session["user_email"] = user_email
            session["google_id"] = google_id
            session.modified = True 
            
            print(f"DEBUG: after_auth - User {user_email} from Google. Session content: {session}", flush=True)
            flash(f"Ch√†o m·ª´ng, {user_email}!", category="success") 

            # ƒê·ªìng b·ªô CSDL
            try:
                conn = mysql.connector.connect(
                    host=os.environ.get('DB_HOST', 'localhost'),
                    user=os.environ.get('DB_USER', 'hiep1987'),
                    password=os.environ.get('DB_PASSWORD', ''),
                    database=os.environ.get('DB_NAME', 'tikz2svg')
                )
                cursor = conn.cursor()
                cursor.execute("SELECT id FROM user WHERE email = %s", (user_email,))
                user_exists = cursor.fetchone()
                
                if not user_exists:
                    default_username = user_email.split('@')[0]
                    cursor.execute("INSERT INTO user (email, google_id, username) VALUES (%s, %s, %s)", 
                                 (user_email, google_id, default_username))
                    conn.commit()
                    print(f"DEBUG: User {user_email} added to database.", flush=True)
                else:
                    print(f"DEBUG: User {user_email} already in database.", flush=True)
                
                cursor.close()
                conn.close()
            except Exception as db_e:
                print(f"ERROR: Database synchronization failed for {user_email}: {db_e}", flush=True)
                flash("L·ªói ƒë·ªìng b·ªô CSDL, vui l√≤ng th·ª≠ l·∫°i.", "warning")
                session.clear()
                if hasattr(google, 'token'):
                    del google.token
                return redirect(url_for("google.login"))

            return redirect(url_for("index")) 

        else:
            print(f"DEBUG: after_auth - Google API response not OK: {resp.status_code} {resp.text}", flush=True)
            if hasattr(google, 'token'):
                del google.token
            flash("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i.", category="error")
            return redirect(url_for("google.login"))
            
    except Exception as e: 
        print(f"DEBUG: after_auth - Exception: {e}", flush=True) 
        session.clear()
        if hasattr(google, 'token'):
            del google.token
        flash(f"L·ªói ƒëƒÉng nh·∫≠p nghi√™m tr·ªçng: {e}", category="error")
        return redirect(url_for("google.login"))
5. Force Logout (X√≥a Token v√† Session)
@app.route("/force_logout_dance")
def force_logout_dance():
    print("DEBUG: Force logout Dance endpoint accessed.", flush=True)
    if hasattr(google, 'token'):
        print("DEBUG: Deleting google.token.", flush=True)
        del google.token
    else:
        print("DEBUG: google.token not found.", flush=True)

    if 'user_email' in session:
        print(f"DEBUG: Popping user_email: {session['user_email']}.", flush=True)
        session.pop('user_email')
    if 'google_id' in session:
        print(f"DEBUG: Popping google_id: {session['google_id']}.", flush=True)
        session.pop('google_id')

    session.clear() # ƒê·∫£m b·∫£o to√†n b·ªô session ƒë∆∞·ª£c d·ªçn d·∫πp
    session.modified = True # ƒê·∫£m b·∫£o Flask l∆∞u thay ƒë·ªïi
    print("DEBUG: Session cleared completely.", flush=True)
    flash("T·∫•t c·∫£ session v√† token Flask-Dance ƒë√£ ƒë∆∞·ª£c x√≥a. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.", "info")
    return redirect(url_for("index"))
6. H√†m Ki·ªÉm Tra ƒêƒÉng Nh·∫≠p
def is_logged_in():
    return google.authorized
7. Before Request - Ph·ª•c H·ªìi Session
@app.before_request
def load_user_info_if_missing():
    # B·ªè qua logic n√†y cho c√°c route li√™n quan ƒë·∫øn qu√° tr√¨nh OAuth ban ƒë·∫ßu
    # ho·∫∑c c√°c file tƒ©nh ƒë·ªÉ tr√°nh xung ƒë·ªôt v√† v√≤ng l·∫∑p.
    if request.path.startswith('/login/google/authorized') or \
       request.path.startswith('/login/google/login') or \
       request.path.startswith('/static/') or \
       request.path.startswith('/temp_svg/') or \
       request.path.startswith('/temp_img/') or \
       request.path.startswith('/logout'): # C√≥ th·ªÉ th√™m /logout n·∫øu b·∫°n c√≥
        return

    # N·∫øu ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c ·ªßy quy·ªÅn (ƒë√£ ƒëƒÉng nh·∫≠p Google qua OAuth)
    # NH∆ØNG 'user_email' l·∫°i kh√¥ng c√≥ trong session (v√≠ d·ª•: do session cookie ch∆∞a ƒë∆∞·ª£c g·ª≠i ƒë√∫ng ·ªü l·∫ßn ƒë·∫ßu,
    # ho·∫∑c session ƒë√£ h·∫øt h·∫°n/b·ªã x√≥a sau ƒë√≥)
    if google.authorized and "user_email" not in session:
        print("DEBUG: User authorized but user_email missing from session. Attempting to re-fetch userinfo.", flush=True)
        try:
            resp = google.get("/oauth2/v2/userinfo")
            if resp.ok:
                info = resp.json()
                session["user_email"] = info["email"]
                session["google_id"] = info["id"]
                session.modified = True
                print("DEBUG: Userinfo re-fetched and session updated successfully.", flush=True)
            else:
                # N·∫øu kh√¥ng th·ªÉ re-fetch (v√≠ d·ª•: token h·∫øt h·∫°n), x√≥a token v√† ƒë·ªÉ ·ª©ng d·ª•ng x·ª≠ l√Ω
                del google.token
                print("DEBUG: Failed to re-fetch userinfo. Google token might be invalid, clearing.", flush=True)
                # KH√îNG REDIRECT ·ªû ƒê√ÇY. ƒê·ªÉ c√°c route ri√™ng l·∫ª ki·ªÉm tra google.authorized v√† t·ª± redirect n·∫øu c·∫ßn.
        except Exception as e:
            del google.token
            print(f"DEBUG: Exception during userinfo re-fetch: {e}. Clearing token.", flush=True)
            # KH√îNG REDIRECT ·ªû ƒê√ÇY.
8. B·∫£o V·ªá Route Ch√≠nh
@app.route("/", methods=["GET", "POST"])
def index():
    logged_in = 'user_email' in session
    # --- Ch·∫∑n bi√™n d·ªãch n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p ---
    if request.method == "POST" and not logged_in:
        return redirect(url_for("google.login"))
9. Route Logout Th√¥ng Th∆∞·ªùng
@app.route('/logout')
def logout():
    session.clear()
    next_url = request.args.get('next') or url_for('index')
    return redirect(next_url)
10. B·∫£o V·ªá Route Profile
@app.route('/profile', methods=['GET', 'POST'])
def profile():
    # Ph·∫£i login Google r·ªìi m·ªõi cho v√†o
    if 'user_email' not in session:
        flash("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p tr∆∞·ªõc.", "error")
        return redirect(url_for('google.login'))
11. Context Processor - Truy·ªÅn Th√¥ng Tin User
@app.context_processor
def inject_user_info():
    """Context processor ƒë·ªÉ truy·ªÅn th√¥ng tin user ra m·ªçi template"""
    user_email = session.get('user_email')
    if user_email:
        user = get_user_by_email(user_email)
        if user:
            return {
                'user_email': user_email,
                'username': user.get('username', ''),
                'avatar': user.get('avatar', '')  # <-- ch·ªâ l√† t√™n file!
            }
    return {
        'user_email': None,
        'username': None,
        'avatar': None
    }
12. H√†m L·∫•y Th√¥ng Tin User T·ª´ Database
def get_user_by_email(email):
    """L·∫•y th√¥ng tin user t·ª´ database theo email"""
    try:
        conn = mysql.connector.connect(
            host=os.environ.get('DB_HOST', 'localhost'),
            user=os.environ.get('DB_USER', 'hiep1987'),
            password=os.environ.get('DB_PASSWORD', ''),
            database=os.environ.get('DB_NAME', 'tikz2svg')
        )
        cursor = conn.cursor(dictionary=True)
        cursor.execute("SELECT username, avatar FROM user WHERE email = %s", (email,))
        user_data = cursor.fetchone()
        cursor.close()
        conn.close()
        return user_data
    except Exception as e:
        print(f"Error getting user data: {e}")
        return None
T·ªïng k·∫øt: H·ªá th·ªëng OAuth ho√†n ch·ªânh v·ªõi 12 th√†nh ph·∫ßn ch√≠nh, bao g·ªìm c·∫•u h√¨nh, ƒëƒÉng nh·∫≠p, callback, qu·∫£n l√Ω session, b·∫£o v·ªá route, v√† t√≠ch h·ª£p database.

code hi·ªán t·∫°i.
T√¥i mu·ªën n√¢ng c·∫•p th√™m:
Khi ƒëƒÉng nh·∫≠p th√†nh c√¥ng,
Ng∆∞·ªùi d√πng bi√™n d·ªãch th√†nh c√¥ng code tikz, khi nh·∫•n n√∫t l∆∞u server, th·ª±c hi·ªán th√™m
+L∆∞u v√†o CSDL b·∫£ng svg_image; keyword ;user
+T√™n file 131213080725.svg s·∫Ω ƒë∆∞·ª£c l∆∞u tr√™n server
<div id="profile-content" class="profile-content show">
                <div class="header">
                    <h1>üë§ H·ªì s∆° c√° nh√¢n</h1>
                    <p>Qu·∫£n l√Ω th√¥ng tin t√†i kho·∫£n c·ªßa b·∫°n</p>
                </div>

                <!-- Flash Messages -->
                
                    
                

                <form method="POST" enctype="multipart/form-data">
                    <div class="profile-section">
                        <!-- Avatar Section -->
                        <div class="avatar-section">
                            <div class="avatar-container">
                                
                                    <img src="/static/avatars/avatar_2de74228358b4add9401f11be264069c.png" alt="Avatar" class="avatar" id="avatar-preview">
                                
                            </div>
                            <div class="avatar-upload">
                                <input type="file" id="avatar-input" name="avatar" accept="image/*" onchange="openCropperModal(this)">
                                <label for="avatar-input">üì∑ Ch·ªçn ·∫£nh ƒë·∫°i di·ªán</label>
                            </div>
                            <p style="font-size: 12px; color: #666; margin-top: 10px;">
                                H·ªó tr·ª£: JPG, PNG, GIF (t·ªëi ƒëa 5MB)
                            </p>
                        </div>

                        <!-- Info Section -->
                        <div class="info-section">
                            <div class="info-group">
                                <label for="email">üìß Email:
                                    
                                        <span style="color: orange; font-size: 13px;">‚ö† Ch∆∞a x√°c th·ª±c</span>
                                    
                                </label>
                                <input type="email" id="email" value="datahiep93@gmail.com" class="readonly" readonly="">
                                <small style="color: #666; font-size: 12px;">Email kh√¥ng th·ªÉ thay ƒë·ªïi</small>
                            </div>

                            <div class="info-group">
                                <label for="username">üë§ T√™n hi·ªÉn th·ªã:</label>
                                <input type="text" id="username" name="username" value="Hi·ªáp 541987" placeholder="Nh·∫≠p t√™n hi·ªÉn th·ªã c·ªßa b·∫°n" maxlength="50">
                                <small style="color: #666; font-size: 12px;">T√™n s·∫Ω hi·ªÉn th·ªã trong ·ª©ng d·ª•ng</small>
                            </div>

                            <div class="info-group">
                                <label for="bio">üìù M√¥ t·∫£ / Gi·ªõi thi·ªáu:</label>
                                <textarea id="bio" name="bio" rows="4" placeholder="Gi·ªõi thi·ªáu b·∫£n th√¢n" maxlength="500"></textarea>
                                <small style="color: #666; font-size: 12px;">B·∫°n c√≥ th·ªÉ chia s·∫ª v·ªÅ m√¨nh</small>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="avatar-cropped-blob" name="avatar_cropped" value="">

                    <div class="actions">
                        <button type="submit" class="btn btn-primary">üíæ L∆∞u thay ƒë·ªïi</button>
                    </div>
                </form>
            </div>