<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>TikZ to SVG</title>
    <!-- Highlight.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h2 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
        }
        textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .file-info {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .file-info h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
        .file-info p {
            margin: 5px 0;
            color: #333;
        }
        .svg-preview {
            text-align: center;
            margin-bottom: 20px;
        }
        .svg-preview img {
            max-width: 100%;
            border: 2px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .code-section {
            margin-top: 20px;
        }
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .code-title {
            font-weight: bold;
            color: #333;
        }
        .copy-btn {
            background-color: #28a745;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .copy-btn:hover {
            background-color: #218838;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            position: relative;
        }
        .code-block pre {
            margin: 0;
            padding: 15px;
            background: transparent;
        }
        .code-block code {
            background: transparent;
            padding: 0;
        }
        .download-link {
            display: inline-block;
            background-color: #17a2b8;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            margin-top: 10px;
        }
        .download-link:hover {
            background-color: #138496;
        }
        .copy-link-btn {
            display: inline-block;
            background-color: #ffc107;
            color: #212529;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            margin-top: 10px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
        }
        .copy-link-btn:hover {
            background-color: #e0a800;
        }
        .error {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 5px;
        }
        .files-section {
            margin-top: 40px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .files-section h3 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        .file-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .file-card img {
            width: 100%;
            height: 150px;
            object-fit: contain;
            border: 1px solid #eee;
            border-radius: 3px;
            margin-bottom: 10px;
        }
        .file-card h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 14px;
        }
        .file-card p {
            margin: 3px 0;
            font-size: 12px;
            color: #666;
        }
        .file-actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .file-actions a, .file-actions button {
            padding: 5px 10px;
            text-decoration: none;
            border-radius: 3px;
            font-size: 11px;
            flex: 1;
            text-align: center;
        }
        .view-btn {
            background-color: #007bff;
            color: white;
        }
        .download-btn {
            background-color: #28a745;
            color: white;
        }
        .file-copy-link-btn {
            background-color: #ffc107;
            color: #212529;
            border: none;
        }
        .no-files {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        .export-section {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .export-section h4 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }
        .export-form {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            margin-bottom: 10px;
        }
        .export-label {
            font-weight: bold;
            color: #555;
        }
        .export-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .export-select {
            width: 100px;
        }
        .export-number {
            width: 100px;
        }
        .export-btn {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .export-btn:hover {
            background-color: #218838;
        }
        .export-msg {
            margin-top: 5px;
            color: #388e3c;
            font-weight: bold;
        }
        /* Th√™m layout 2 c·ªôt cho ch·∫ø ƒë·ªô xem */
        #view-mode-row {
            display: flex;
            gap: 32px;
            margin-bottom: 24px;
        }
        #view-mode-row .view-col {
            flex: 1;
            min-width: 0;
        }
        #view-svg-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            border: 1.5px solid #eee;
            border-radius: 8px;
            min-height: 320px;
            min-width: 200px;
            padding: 16px;
        }
        #view-svg-preview img {
            max-width: 100%;
            max-height: 400px;
            display: block;
            margin: 0 auto;
        }
        @media (max-width: 900px) {
            #view-mode-row { flex-direction: column; gap: 16px; }
            #view-svg-preview { min-height: 180px; }
        }
        /* Line numbers */
        .hljs-ln-numbers {
            text-align: right;
            color: #999;
            border-right: 1px solid #ddd;
            vertical-align: top;
            padding-right: 8px !important;
            min-width: 25px;
            }
        .hljs-ln-code {
            padding-left: 8px !important;
        }
        /* View mode code editor */
        #view-tikz-code {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            position: relative;
        }
        #view-tikz-code pre {
            margin: 0;
            padding: 15px;
            background: transparent;
        }
        #view-tikz-code code {
            background: transparent;
            padding: 0;
        }
        .CodeMirror {
            height: 220px;
            font-size: 15px;
            border-radius: 6px;
            border: 1.5px solid #bbb;
            background: #f8f9fa;
        }
        .CodeMirror-placeholder {
            color: #bbb !important;
            font-style: italic;
        }
        /* Fix gutter/line number width for CodeMirror */
        .CodeMirror-gutter, .CodeMirror-gutters, .CodeMirror-linenumbers {
            width: 2.5em !important;
            min-width: 2.5em !important;
        }
        .CodeMirror-linenumber, .CodeMirror-gutter-elt {
            min-width: 2em !important;
            width: 2em !important;
            text-align: right !important;
            padding-right: 0.5em !important;
            box-sizing: content-box !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Chuy·ªÉn ƒë·ªïi TikZ sang SVG</h2>
        
        <form method="post" onsubmit="return submitTikzCode()">
            <div class="form-group">
                <label for="code">Nh·∫≠p code TikZ:</label>
                <textarea name="code" id="code" rows="12" placeholder="Nh·∫≠p code TikZ t·∫°i ƒë√¢y..." style="display:none"></textarea>
            </div>
            <button type="submit">Bi√™n d·ªãch</button>
        </form>

        {% if svg_temp_url and not error %}
            <div class="result-section">
                <div class="svg-preview">
                    <h3>K·∫øt qu·∫£ SVG:</h3>
                    <img src="{{ svg_temp_url }}" alt="SVG Preview">
                    <br>
                    <a href="{{ svg_temp_url }}" download class="download-link">T·∫£i xu·ªëng SVG</a>
                    <button id="save-server-btn" class="copy-link-btn">üíæ L∆∞u server</button>
                </div>
                <div class="export-section">
                    <h4>Xu·∫•t ·∫£nh PNG/JPEG</h4>
                    <form id="export-form" style="display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-bottom:10px;">
                        <label for="export-format" class="export-label">ƒê·ªãnh d·∫°ng:</label>
                        <select id="export-format" class="export-input export-select">
                            <option value="png">PNG</option>
                            <option value="jpeg">JPEG</option>
                        </select>
                        <label for="export-width" class="export-label">Width (px):</label>
                        <input type="number" id="export-width" min="1" class="export-input export-number" placeholder="Auto">
                        <label for="export-height" class="export-label">Height (px):</label>
                        <input type="number" id="export-height" min="1" class="export-input export-number" placeholder="Auto">
                        <label for="export-dpi" class="export-label">DPI:</label>
                        <input type="number" id="export-dpi" min="1" class="export-input export-number" placeholder="Auto">
                        <button id="export-btn" type="button" class="export-btn">T·∫£i xu·ªëng</button>
                    </form>
                    <div id="export-msg" style="margin-top:5px; color:#388e3c;"></div>
                </div>
                {% if svg_content %}
                    <div class="code-section">
                        <div class="code-header">
                            <span class="code-title">Code SVG:</span>
                            <button class="copy-btn" onclick="copySvgCode()">üìã Copy Code</button>
                        </div>
                    <div class="code-block" id="svgCode">
                        <pre><code class="language-xml">{{ svg_content }}</code></pre>
                    </div>
                    </div>
                {% endif %}
            </div>
        {% endif %}

        {% if error %}
            <div class="result-section">
                <div class="error">{{ error|safe }}
                    {% if error_log_full %}
                        <br><button id="show-log-btn" style="margin-top:10px; background:#b71c1c; color:white; border:none; border-radius:4px; padding:6px 16px; cursor:pointer;">Hi·ªÉn th·ªã chi ti·∫øt log</button>
                        <pre id="full-log" style="display:none; background:#fff0f0; color:#b71c1c; border:1px solid #f5c6cb; border-radius:4px; padding:12px; margin-top:10px; max-height:400px; overflow:auto;">{{ error_log_full }}</pre>
                        <script>
                        document.getElementById('show-log-btn').onclick = function() {
                            var log = document.getElementById('full-log');
                            if (log.style.display === 'none') {
                                log.style.display = 'block';
                                this.textContent = '·∫®n chi ti·∫øt log';
                            } else {
                                log.style.display = 'none';
                                this.textContent = 'Hi·ªÉn th·ªã chi ti·∫øt log';
                            }
                        };
                        </script>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        {% if svg_files %}
            <div class="files-section">
            <h3>üìÇ C√°c file SVG ƒë√£ t·∫°o</h3>
            <div class="files-grid">
                    {% for file in svg_files %}
                        <div class="file-card" data-tikz-code="{{ file.tikz_code | tojson | safe }}">
                            <img src="{{ file.url }}" alt="{{ file.filename }}" onerror="this.style.display='none'">
                            <h4>{{ file.filename }}</h4>
                            <p><strong>K√≠ch th∆∞·ªõc:</strong> {{ file.size }} KB</p>
                            <p><strong>T·∫°o l√∫c:</strong> {{ file.created_time }}</p>
                            <div class="file-actions">
                                <a href="{{ file.url }}" target="_blank" class="view-btn">üëÅÔ∏è Xem</a>
                                <button class="fb-share-btn" data-filename="{{ file.filename }}" style="background:#1877f3;color:white;font-weight:bold;">üü¶ Copy link Facebook</button>
                                <button class="file-copy-link-btn" onclick="copyToClipboard('{{ request.host_url.rstrip('/') ~ file.url }}', this, 'üîó Copy Link')">üîó Copy Link</button>
                                {% if file.tikz_code %}
                                    <button class="copy-btn" onclick="toggleTikzCode(this)">üìù Xem code TikZ</button>
                                {% endif %}
                            </div>
                            {% if file.tikz_code %}
                                <div class="tikz-code-block" style="display:none; margin-top:10px;">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                        <span style="font-weight:bold; color:#333;">Code TikZ:</span>
                                        <button class="copy-btn" style="padding:4px 10px; font-size:12px;" onclick="copyTikzCode(this)">üìã Copy</button>
                                    </div>
                                    <div class="code-block" style="margin:0;">
                                        <textarea class="tikz-cm" readonly>{{ file.tikz_code | e }}</textarea>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
                {% else %}
            <div class="files-section">
                <h3>üìÇ C√°c file SVG ƒë√£ t·∫°o</h3>
                    <div class="no-files">
                        Ch∆∞a c√≥ file SVG n√†o ƒë∆∞·ª£c t·∫°o. H√£y th·ª≠ chuy·ªÉn ƒë·ªïi m·ªôt code TikZ!
                    </div>
            </div>
        {% endif %}
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        var cm; // Khai b√°o global ƒë·ªÉ c√°c h√†m kh√°c truy c·∫≠p ƒë∆∞·ª£c
        function copyToClipboard(text, buttonElement, originalText) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = 0;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            if (buttonElement) {
                const originalContent = buttonElement.innerHTML;
                buttonElement.innerHTML = '‚úÖ ƒê√£ copy!';
                setTimeout(() => {
                    buttonElement.innerHTML = originalContent;
                }, 2000);
            }
        }

        function copySvgCode() {
            const codeBlock = document.getElementById('svgCode');
            const copyBtn = document.querySelector('.copy-btn');
            copyToClipboard(codeBlock.textContent, copyBtn, 'üìã Copy Code');
        }

        function copyTikzCode(btn) {
            // L·∫•y code t·ª´ CodeMirror instance
            const codeBlock = btn.closest('.tikz-code-block').querySelector('.tikz-cm');
            let code = codeBlock.value;
            // Lo·∫°i b·ªè d√≤ng tr·∫Øng ·ªü ƒë·∫ßu v√† cu·ªëi, ch·ªâ gi·ªØ t·ªëi ƒëa 1 d√≤ng tr·∫Øng li√™n ti·∫øp
            let lines = code.split('\n');
            while (lines.length && lines[0].trim() === '') lines.shift();
            while (lines.length && lines[lines.length - 1].trim() === '') lines.pop();
            let cleaned = [];
            let lastBlank = false;
            for (let line of lines) {
                if (line.trim() === '') {
                    if (!lastBlank) cleaned.push('');
                    lastBlank = true;
                } else {
                    cleaned.push(line);
                    lastBlank = false;
                }
            }
            copyToClipboard(cleaned.join('\n'), btn, 'üìã Copy');
        }

        function showViewMode(tikzCode, svgFilename) {
            // X√≥a block view mode c≈© n·∫øu c√≥
            let viewRow = document.getElementById('view-mode-row');
            if (viewRow) viewRow.remove();
            // X√≥a block export-section c≈© n·∫øu c√≥
            let oldExport = document.getElementById('view-export-section');
            if (oldExport) oldExport.remove();
            // ·∫®n form nh·∫≠p code TikZ v√† n√∫t Bi√™n d·ªãch c≈©
            const form = document.querySelector('form');
            if (form) form.style.display = 'none';
            // T·∫°o layout 2 c·ªôt
            viewRow = document.getElementById('view-mode-row');
            if (!viewRow) {
                viewRow = document.createElement('div');
                viewRow.id = 'view-mode-row';
                viewRow.innerHTML = `
                    <div class="view-col">
                        <label for="code" style="font-weight:bold;">Nh·∫≠p code TikZ:</label>
                        <div class="code-block" style="margin:0;">
                            <textarea id="view-tikz-textarea" style="width:100%;min-height:200px;border:none;background:transparent;font-family:'Courier New',monospace;font-size:15px;resize:vertical;outline:none;"></textarea>
                        </div>
                        <button id="view-compile-btn" class="export-btn" style="margin-top:12px;">Bi√™n d·ªãch</button>
                    </div>
                    <div class="view-col" id="view-svg-preview">
                        <img id="view-svg-img" src="/static/${svgFilename}" alt="SVG Preview">
                    </div>
                `;
                // Th√™m v√†o ƒë√∫ng v·ªã tr√≠ ph√≠a tr√™n form ho·∫∑c files-section
                const container = document.querySelector('.container');
                const filesSection = document.querySelector('.files-section');
                if (container && form && form.parentNode === container) {
                    container.insertBefore(viewRow, form);
                } else if (container && filesSection) {
                    container.insertBefore(viewRow, filesSection);
                } else if (container) {
                    container.appendChild(viewRow);
                }
            } else {
                viewRow.style.display = '';
                document.getElementById('view-svg-img').src = '/static/' + svgFilename;
            }
            // ƒê∆∞a code TikZ v√†o textarea m·ªõi v√† kh·ªüi t·∫°o CodeMirror
            const textareaElement = document.querySelector('#view-tikz-textarea');
            textareaElement.value = tikzCode;
            
            // Kh·ªüi t·∫°o CodeMirror cho textarea v·ªõi ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
            const viewCm = CodeMirror.fromTextArea(textareaElement, {
                mode: 'stex',
                theme: 'material',
                lineNumbers: true,
                lineWrapping: true,
                viewportMargin: Infinity,
                placeholder: 'Nh·∫≠p code TikZ t·∫°i ƒë√¢y...'
            });
            
            // Th√™m s·ª± ki·ªán real-time preview
            let previewTimer;
            viewCm.on('change', function() {
                clearTimeout(previewTimer);
                previewTimer = setTimeout(() => {
                    updateRealTimePreview(viewCm.getValue());
                }, 1000); // Delay 1 gi√¢y sau khi ng·ª´ng g√µ
            });
            // G√°n l·∫°i logic cho n√∫t Bi√™n d·ªãch m·ªõi
            document.getElementById('view-compile-btn').onclick = function() {
                // L·∫•y code t·ª´ CodeMirror v√† submit
                const newTikzCode = viewCm.getValue();
                if (form) {
                    const oldTextarea = form.querySelector('textarea[name="code"]');
                    if (oldTextarea) oldTextarea.value = newTikzCode;
                    // N·∫øu c√≥ CodeMirror g·ªëc (cm), c·∫≠p nh·∫≠t lu√¥n
                    if (window.cm && typeof window.cm.setValue === 'function') {
                        window.cm.setValue(newTikzCode);
                    }
                    form.style.display = 'block';
                    viewRow.style.display = 'none';
                    // Th√™m delay nh·ªè ƒë·ªÉ DOM c·∫≠p nh·∫≠t tr∆∞·ªõc khi submit
                    setTimeout(function() {
                        form.querySelector('button[type="submit"]').click();
                    }, 10);
                }
            };
            // Cu·ªôn l√™n khung nh·∫≠p code
            viewRow.scrollIntoView({behavior: 'smooth', block: 'center'});
            // Hi·ªán kh·ªëi chuy·ªÉn ƒë·ªïi PNG/JPEG cho file ƒë√£ l∆∞u
            let exportSection = document.getElementById('view-export-section');
            if (!exportSection) {
                exportSection = document.createElement('div');
                exportSection.id = 'view-export-section';
                exportSection.innerHTML = `
                <div class="export-section">
                    <h4>Xu·∫•t ·∫£nh PNG/JPEG</h4>
                    <form id="view-export-form" style="display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-bottom:10px;">
                        <label for="view-export-format" class="export-label">ƒê·ªãnh d·∫°ng:</label>
                        <select id="view-export-format" class="export-input export-select">
                            <option value="png">PNG</option>
                            <option value="jpeg">JPEG</option>
                        </select>
                        <label for="view-export-width" class="export-label">Width (px):</label>
                        <input type="number" id="view-export-width" min="1" class="export-input export-number" placeholder="Auto">
                        <label for="view-export-height" class="export-label">Height (px):</label>
                        <input type="number" id="view-export-height" min="1" class="export-input export-number" placeholder="Auto">
                        <label for="view-export-dpi" class="export-label">DPI:</label>
                        <input type="number" id="view-export-dpi" min="1" class="export-input export-number" placeholder="Auto">
                        <button id="view-export-btn" type="button" class="export-btn">T·∫£i xu·ªëng</button>
                    </form>
                    <div id="view-export-msg" style="margin-top:5px; color:#388e3c;"></div>
                </div>
                `;
                // Th√™m v√†o sau viewRow
                viewRow.parentNode.insertBefore(exportSection, viewRow.nextSibling);
            }
            exportSection.style.display = '';
            // ·∫®n n√∫t L∆∞u server n·∫øu c√≥
            const saveBtn = document.getElementById('save-server-btn');
            if (saveBtn) saveBtn.style.display = 'none';
            // G√°n l·∫°i logic xu·∫•t PNG/JPEG cho file ƒë√£ l∆∞u
            setTimeout(function() {
                const exportBtn = document.getElementById('view-export-btn');
            if (exportBtn) {
                    exportBtn.onclick = async function() {
                        const format = document.getElementById('view-export-format').value;
                        const widthVal = document.getElementById('view-export-width').value;
                        const heightVal = document.getElementById('view-export-height').value;
                        const dpiVal = document.getElementById('view-export-dpi').value;
                        const msg = document.getElementById('view-export-msg');
                    msg.textContent = '';
                    if ((widthVal && widthVal <= 0) || (heightVal && heightVal <= 0) || (dpiVal && dpiVal <= 0)) {
                        msg.textContent = 'Width, Height, DPI ph·∫£i l√† s·ªë d∆∞∆°ng!';
                        return;
                    }
                    exportBtn.disabled = true;
                    exportBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
                    try {
                        const res = await fetch('/convert', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                    filename: svgFilename,
                                    fmt: format,
                                    width: widthVal || undefined,
                                    height: heightVal || undefined,
                                    dpi: dpiVal || undefined
                                })
                            });
                            const data = await res.json();
                            if (data.url) {
                                msg.innerHTML = `<a href="${data.url}" download style="color:#388e3c;font-weight:bold;">T·∫£i v·ªÅ ${format.toUpperCase()}</a>`;
                            } else {
                                msg.textContent = data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh!';
                            }
                        } catch (err) {
                            msg.textContent = 'L·ªói k·∫øt n·ªëi ho·∫∑c m√°y ch·ªß!';
                        }
                        exportBtn.disabled = false;
                        exportBtn.textContent = 'T·∫£i xu·ªëng';
                    };
                }
            }, 100);
        }

        document.addEventListener('DOMContentLoaded', function() {
            var tikzCode = document.getElementById('code');
            cm = CodeMirror.fromTextArea(tikzCode, {
                mode: 'stex',
                theme: 'material',
                lineNumbers: true,
                lineWrapping: true,
                placeholder: 'Nh·∫≠p code TikZ t·∫°i ƒë√¢y...'
            });
            cm.setValue({{ tikz_code|default('')|tojson|safe }});
            // ... c√°c code kh√°c li√™n quan ƒë·∫øn cm ...
            // G√°n s·ª± ki·ªán cho n√∫t üëÅÔ∏è Xem
            document.querySelectorAll('.view-btn').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const card = btn.closest('.file-card');
                    // ∆Øu ti√™n l·∫•y code TikZ t·ª´ data-tikz-code ho·∫∑c textarea
                    let tikzCode = card.getAttribute('data-tikz-code') || '';
                    if (!tikzCode) {
                        const textarea = card.querySelector('.tikz-cm');
                        if (textarea) tikzCode = textarea.value;
                    }
                    const svgFilename = card.querySelector('h4').textContent.trim();
                    showViewMode(tikzCode, svgFilename);
                });
            });
            // S·ª± ki·ªán copy link Facebook
            document.querySelectorAll('.fb-share-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const filename = btn.getAttribute('data-filename');
                    const shareUrl = `${window.location.origin}/view_svg/${filename}`;
                    const textArea = document.createElement('textarea');
                    textArea.value = shareUrl;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = 0;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    btn.innerHTML = '‚úÖ ƒê√£ copy link Facebook!';
                    setTimeout(() => {
                        btn.innerHTML = 'üü¶ Copy link Facebook';
                    }, 2000);
                });
            });

            // N·∫øu c√≥ code TikZ t·ª´ localStorage (t·ª´ n√∫t üëÅÔ∏è Xem v√† Bi√™n d·ªãch), t·ª± ƒë·ªông show giao di·ªán nh∆∞ nh·∫•n üëÅÔ∏è Xem
            const tikzFromStorage = localStorage.getItem('tikz_code_for_compile');
            if (tikzFromStorage) {
                const textarea = document.getElementById('code');
                if (textarea) textarea.value = tikzFromStorage;
                // T√¨m file SVG ƒë·∫ßu ti√™n c√≥ code TikZ tr√πng v·ªõi tikzFromStorage
                let found = false;
                document.querySelectorAll('.file-card').forEach(function(card) {
                    const codeBlock = card.querySelector('.tikz-code-block pre');
                    if (codeBlock && codeBlock.textContent.trim() === tikzFromStorage.trim()) {
                        const svgFilename = card.querySelector('h4').textContent.trim();
                        showViewMode(tikzFromStorage, svgFilename);
                        found = true;
                    }
                });
                // N·∫øu kh√¥ng t√¨m th·∫•y SVG c≈©, ch·ªâ ƒëi·ªÅn code v√†o textarea
                localStorage.removeItem('tikz_code_for_compile');
            }

            // Highlight v√† s·ªë d√≤ng khi nh·∫≠p code
            function highlightTikzInput() {
                const code = tikzCode;
                // X√≥a c√°c span line-number c≈© n·∫øu c√≥
                code.querySelectorAll('.hljs-ln-numbers, .hljs-ln-code').forEach(e => e.remove());
                hljs.highlightElement(code);
            }
            tikzCode.addEventListener('input', function() {
                clearTimeout(window.tikzInputTimer);
                window.tikzInputTimer = setTimeout(highlightTikzInput, 120);
            });
            // X·ª≠ l√Ω paste gi·ªØ xu·ªëng d√≤ng v√† highlight l·∫°i
            tikzCode.addEventListener('paste', function(e) {
                e.preventDefault();
                var text = (e.clipboardData || window.clipboardData).getData('text');
                // Ch√®n t·ª´ng d√≤ng v·ªõi <br>
                document.execCommand('insertHTML', false, text.replace(/\n/g, '<br>'));
                setTimeout(function() {
                    highlightTikzInput();
                }, 10);
            });
            // Submit: copy code v√†o textarea ·∫©n
            function submitTikzCode() {
                tikzCode.value = cleanControlChars(cm.getValue());
                return true;
            }
            // Highlight v√† placeholder ban ƒë·∫ßu
            highlightTikzInput();

            // B·ªé V√íNG L·∫∂P N√ÄY - Ch·ªâ kh·ªüi t·∫°o CodeMirror khi c·∫ßn trong toggleTikzCode
            // document.querySelectorAll('.tikz-cm').forEach(function(textarea) {
            //     if (!textarea.CodeMirror) {
            //         CodeMirror.fromTextArea(textarea, {
            //             mode: 'stex',
            //             theme: 'material',
            //             lineNumbers: true,
            //             readOnly: true,
            //             viewportMargin: Infinity
            //         });
            //     }
            // });
        });

        (function() {
            const svgTempId = '{{ svg_temp_id or "" }}';
            const tikzCode = document.getElementById('code') ? document.getElementById('code').value : '';
            if (svgTempId) {
                // L∆∞u server
                const saveBtn = document.getElementById('save-server-btn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', function() {
                        saveBtn.disabled = true;
                        saveBtn.textContent = 'ƒêang l∆∞u...';
                        // L·∫•y code TikZ t·ª´ CodeMirror (lu√¥n ƒë√∫ng, kh√¥ng b·ªã l·ªói escape)
                        let tikzCodeToSave = cm.getValue();
                        fetch('/save_svg', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ file_id: svgTempId, tikz_code: tikzCodeToSave })
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                window.location.href = "/"; // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ch·ªß b·∫±ng GET, kh√¥ng reload l·∫°i POST
                            } else {
                                saveBtn.textContent = 'L·ªói!';
                                alert(data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh!');
                            }
                        })
                        .catch(() => {
                            saveBtn.textContent = 'L·ªói!';
                            alert('L·ªói k·∫øt n·ªëi!');
                        });
                    });
                }
                // X√≥a file t·∫°m khi r·ªùi trang ho·∫∑c reload
                window.addEventListener('beforeunload', function(e) {
                    navigator.sendBeacon('/delete_temp_svg', JSON.stringify({ file_id: svgTempId }));
                });
                // Chuy·ªÉn ƒë·ªïi PNG/JPEG
                const exportBtn = document.getElementById('export-btn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', async function() {
                        const format = document.getElementById('export-format').value;
                        const widthVal = document.getElementById('export-width').value;
                        const heightVal = document.getElementById('export-height').value;
                        const dpiVal = document.getElementById('export-dpi').value;
                        const msg = document.getElementById('export-msg');
                        msg.textContent = '';
                        if ((widthVal && widthVal <= 0) || (heightVal && heightVal <= 0) || (dpiVal && dpiVal <= 0)) {
                            msg.textContent = 'Width, Height, DPI ph·∫£i l√† s·ªë d∆∞∆°ng!';
                            return;
                        }
                        exportBtn.disabled = true;
                        exportBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
                        try {
                            const res = await fetch('/temp_convert', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    file_id: svgTempId,
                                fmt: format,
                                width: widthVal || undefined,
                                height: heightVal || undefined,
                                dpi: dpiVal || undefined
                            })
                        });
                        const data = await res.json();
                        if (data.url) {
                            msg.innerHTML = `<a href="${data.url}" download style="color:#388e3c;font-weight:bold;">T·∫£i v·ªÅ ${format.toUpperCase()}</a>`;
                        } else {
                            msg.textContent = data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh!';
                        }
                    } catch (err) {
                        msg.textContent = 'L·ªói k·∫øt n·ªëi ho·∫∑c m√°y ch·ªß!';
                    }
                    exportBtn.disabled = false;
                    exportBtn.textContent = 'T·∫£i xu·ªëng';
                });
            }
            }
        })();

        // ƒê∆∞a code ban ƒë·∫ßu v√†o code block (gi·ªØ xu·ªëng d√≤ng)
        var tikzCodeInit = `{{ tikz_code|e }}`;
        var tikzInput = document.getElementById('code');
        if (tikzCodeInit && tikzCodeInit.trim() !== '') tikzInput.value = tikzCodeInit;
        // Highlight v√† s·ªë d√≤ng khi nh·∫≠p code
        function highlightTikzInput() {
            const code = tikzInput;
            // X√≥a c√°c span line-number c≈© n·∫øu c√≥
            code.querySelectorAll('.hljs-ln-numbers, .hljs-ln-code').forEach(e => e.remove());
            hljs.highlightElement(code);
        }
        tikzInput.addEventListener('input', function() {
            clearTimeout(window.tikzInputTimer);
            window.tikzInputTimer = setTimeout(highlightTikzInput, 120);
        });
        // X·ª≠ l√Ω paste gi·ªØ xu·ªëng d√≤ng v√† highlight l·∫°i
        tikzInput.addEventListener('paste', function(e) {
            e.preventDefault();
            var text = (e.clipboardData || window.clipboardData).getData('text');
            // Ch√®n t·ª´ng d√≤ng v·ªõi <br>
            document.execCommand('insertHTML', false, text.replace(/\n/g, '<br>'));
            setTimeout(function() {
                highlightTikzInput();
            }, 10);
        });
        // Submit: copy code v√†o textarea ·∫©n
        function submitTikzCode() {
            tikzInput.value = cleanControlChars(cm.getValue());
            return true;
        }
        // Highlight v√† placeholder ban ƒë·∫ßu
        highlightTikzInput();

        // H√†m c·∫≠p nh·∫≠t preview real-time
        async function updateRealTimePreview(tikzCode) {
            if (!tikzCode.trim()) return;
            
            const previewImg = document.getElementById('view-svg-img');
            if (previewImg) {
                previewImg.style.opacity = '0.5';
                previewImg.alt = 'ƒêang c·∫≠p nh·∫≠t preview...';
            }
            
            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `code=${encodeURIComponent(tikzCode)}`
                });
                
                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newSvgUrl = doc.querySelector('.svg-preview img')?.src;
                    
                    if (newSvgUrl && previewImg) {
                        previewImg.src = newSvgUrl;
                        previewImg.style.opacity = '1';
                        previewImg.alt = 'SVG Preview (Real-time)';
                    }
                }
            } catch (error) {
                console.log('Preview update failed:', error);
                if (previewImg) {
                    previewImg.style.opacity = '1';
                    previewImg.alt = 'SVG Preview';
                }
            }
        }

        function toggleTikzCode(btn) {
            const card = btn.closest('.file-card');
            const codeBlock = card.querySelector('.tikz-code-block');
            const textarea = codeBlock.querySelector('.tikz-cm');

            if (codeBlock.style.display === 'none') {
                // 1. **Hi·ªÉn th·ªã v√πng ch·ª©a CodeMirror tr∆∞·ªõc.**
                //    V√πng ch·ª©a cho CodeMirror (`.tikz-code-block`) ph·∫£i hi·ªÉn th·ªã TR∆Ø·ªöC KHI b·∫°n y√™u c·∫ßu CodeMirror l√†m m·ªõi.
                //    N·∫øu n√≥ v·∫´n l√† `display: none`, CodeMirror s·∫Ω kh√¥ng th·ªÉ t√≠nh to√°n k√≠ch th∆∞·ªõc c·ªßa n√≥ m·ªôt c√°ch ch√≠nh x√°c.
                codeBlock.style.display = 'block';

                // 2. **Ki·ªÉm tra xem ƒë√£ c√≥ th·ªÉ hi·ªán CodeMirror cho textarea n√†y ch∆∞a.**
                //    N·∫øu ch∆∞a, h√£y t·∫°o n√≥. CodeMirror s·∫Ω ƒë√≠nh k√®m th·ªÉ hi·ªán c·ªßa n√≥ v√†o textarea.
                let cmInstance = textarea.CodeMirror;
                if (!cmInstance) {
                    cmInstance = CodeMirror.fromTextArea(textarea, {
                        mode: 'stex',
                        theme: 'material',
                        lineNumbers: true,
                        readOnly: true,
                        viewportMargin: Infinity // Cho ph√©p CodeMirror hi·ªÉn th·ªã t·∫•t c·∫£ c√°c d√≤ng
                    });
                    // B·ªé D√íNG N√ÄY: textarea.CodeMirror = cmInstance; // D√≤ng n√†y kh√¥ng c·∫ßn thi·∫øt, CodeMirror t·ª± l√†m
                }

                // 3. **QUAN TR·ªåNG: L√†m m·ªõi CodeMirror sau khi n√≥ hi·ªÉn th·ªã ho·∫∑c v·ª´a ƒë∆∞·ª£c kh·ªüi t·∫°o.**
                //    S·ª≠ d·ª•ng `requestAnimationFrame` ƒë·ªÉ ƒë·∫£m b·∫£o tr√¨nh duy·ªát ƒë√£ ho√†n t·∫•t vi·ªác b·ªë c·ª•c ph·∫ßn t·ª≠.
                requestAnimationFrame(() => {
                    if (cmInstance) {
                        cmInstance.refresh();
                        // (T√πy ch·ªçn) Focus v√†o editor sau khi l√†m m·ªõi
                        // cmInstance.focus();
                    }
                });

                btn.innerHTML = '·∫®n code TikZ';
            } else {
                codeBlock.style.display = 'none';
                btn.innerHTML = 'üìù Xem code TikZ';
            }
        }
    </script>
    <!-- Highlight.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/latex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
    <script>
        // Initialize highlight.js
        document.addEventListener('DOMContentLoaded', function() {
            hljs.highlightAll();
            hljs.initLineNumbersOnLoad();
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/stex/stex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/display/placeholder.min.js"></script>
    <script>
    // H√†m lo·∫°i b·ªè k√Ω t·ª± ƒëi·ªÅu khi·ªÉn (tr·ª´ \n, \t)
    function cleanControlChars(str) {
        return str.replace(/[^\x09\x0A\x20-\x7E\xA0-\uFFFF]/g, '');
    }
    </script>
</body>
</html>
