{% extends "base.html" %}

{# Configuration flags #}
{% set include_highlight_js = false %}
{% set include_codemirror = false %}
{% set include_file_card = false %}
{% set include_navigation = true %}
{% set include_login_modal = true %}
{% set include_navbar = true %}

{# Page Title #}
{% block title %}C√†i ƒë·∫∑t h·ªì s∆° - TikZ to SVG{% endblock %}

{# Custom Meta Tags #}
{% block meta %}
<meta name="description" content="C√†i ƒë·∫∑t v√† qu·∫£n l√Ω h·ªì s∆° ng∆∞·ªùi d√πng TikZ to SVG">
<meta name="keywords" content="TikZ, SVG, profile settings, user settings">
<meta name="author" content="TikZ to SVG">
<meta name="robots" content="index, follow">
<meta property="og:title" content="C√†i ƒë·∫∑t h·ªì s∆° - TikZ to SVG">
<meta property="og:description" content="C√†i ƒë·∫∑t v√† qu·∫£n l√Ω h·ªì s∆° ng∆∞·ªùi d√πng TikZ to SVG">
<meta property="og:type" content="website">
<meta property="og:locale" content="vi_VN">
{% endblock %}

{# External Libraries CSS #}
{% block extra_css %}
<!-- Cropper.js CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">

<!-- Quill Editor CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<!-- Bio Editor Custom CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/bio-editor.css', v='1.0') }}">

<!-- Profile Settings Custom CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile_settings.css', v='1.0') }}">

<!-- Verification Enhancement Styles -->
<style>
.resend-verification-container {
    margin: 15px 0;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

#resend-verification-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

#countdown-text {
    font-weight: bold;
    color: #dc3545;
}

.verification-info-highlight {
    color: #28a745;
    font-weight: bold;
}

.verification-expired {
    color: #dc3545;
    font-weight: bold;
}
</style>
{% endblock %}

{% block content %}

    <!-- Profile Settings Content -->
    <div id="profile-content" class="profile-content show profile-content-container">
            <div class="header">
                <h1>üë§ H·ªì s∆° c√° nh√¢n</h1>
                <p>Qu·∫£n l√Ω th√¥ng tin t√†i kho·∫£n c·ªßa b·∫°n</p>
            </div>

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="flash-messages">
                        {% for category, message in messages %}
                            <div class="flash flash-{{ 'success' if category == 'success' else 'error' }}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <form method="POST" enctype="multipart/form-data">
                <div class="profile-section">
                    <!-- Avatar Section -->
                    <div class="avatar-section">
                        <div class="avatar-container">
                            {% if avatar %}
                                <img src="{{ url_for('static', filename='avatars/' ~ avatar) }}" alt="Avatar" class="avatar" id="avatar-preview">
                            {% else %}
                                <div class="avatar-placeholder" id="avatar-placeholder">
                                    {{ user_email[0].upper() if user_email else 'U' }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="avatar-upload">
                            <input type="file" id="avatar-input" name="avatar" accept="image/*">
                            <label for="avatar-input">üì∑ Ch·ªçn ·∫£nh ƒë·∫°i di·ªán</label>
                        </div>
                        <p class="text-small">
                            H·ªó tr·ª£: JPG, PNG, GIF (t·ªëi ƒëa 5MB)
                        </p>
                    </div>

                    <!-- Info Section -->
                    <div class="info-section">
                        <div class="info-group">
                            <label for="email">üìß Email:
                                {% if email_verified %}
                                    <span class="text-success">‚úî ƒê√£ x√°c th·ª±c</span>
                                {% else %}
                                    <span class="text-warning">‚ö† Ch∆∞a x√°c th·ª±c</span>
                                {% endif %}
                            </label>
                            <input type="email" id="email" value="{{ user_email }}" class="readonly" readonly>
                            <small class="text-muted">Email kh√¥ng th·ªÉ thay ƒë·ªïi</small>
                        </div>

                        <div class="info-group">
                            <label>üîê X√°c th·ª±c danh t√≠nh:
                                {% if identity_verified %}
                                    <span class="text-success">‚úî ƒê√£ x√°c th·ª±c</span>
                                    <img src="{{ url_for('static', filename='identity-verification-icon.svg') }}" alt="Verified" class="verification-icon">
                                {% else %}
                                    <span class="text-warning">‚ö† Ch∆∞a x√°c th·ª±c</span>
                                {% endif %}
                            </label>
                            {% if not identity_verified %}
                                <div class="verification-button-container">
                                    <a href="{{ url_for('profile_verification') }}" class="btn btn-primary verification-button">
                                        üîê X√°c th·ª±c t√†i kho·∫£n
                                    </a>
                                    <small class="text-muted-block">
                                        X√°c th·ª±c ƒë·ªÉ m·ªü kh√≥a ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng v√† nh·∫≠n badge x√°c th·ª±c
                                    </small>
                                </div>
                            {% else %}
                                <div class="verification-success">
                                    <strong>‚úÖ T√†i kho·∫£n ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c!</strong><br>
                                    <small>B·∫°n c√≥ th·ªÉ truy c·∫≠p ƒë·∫ßy ƒë·ªß c√°c t√≠nh nƒÉng c·ªßa n·ªÅn t·∫£ng.</small>
                                </div>
                            {% endif %}
                        </div>

                        <div class="info-group">
                            <label for="username">üë§ T√™n hi·ªÉn th·ªã:</label>
                            <input type="text" id="username" name="username" value="{{ username or '' }}" 
                                   placeholder="Nh·∫≠p t√™n hi·ªÉn th·ªã c·ªßa b·∫°n" maxlength="50">
                            <small class="text-muted">T√™n s·∫Ω hi·ªÉn th·ªã trong ·ª©ng d·ª•ng</small>
                        </div>

                        <div class="info-group">
                            <label for="bio">üìù M√¥ t·∫£ / Gi·ªõi thi·ªáu:</label>
                            <!-- Quill Editor Container -->
                            <div id="bio-editor">{{ bio|safe }}</div>
                            <input type="hidden" name="bio" id="bio-hidden">
                            <small class="text-muted">B·∫°n c√≥ th·ªÉ chia s·∫ª v·ªÅ m√¨nh (h·ªó tr·ª£ ƒë·ªãnh d·∫°ng: B, I, U, bullets, m√†u s·∫Øc)</small>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="avatar-cropped-blob" name="avatar_cropped" value="">

                <div class="actions" id="save-button-section">
                    <button type="submit" class="btn btn-primary">üíæ L∆∞u thay ƒë·ªïi</button>
                    
                    <!-- UX: Status message when verification form is hidden -->
                    {% if has_pending_verification and not show_verification_form %}
                    <div class="alert alert-info mt-3">
                        <strong>üîê X√°c th·ª±c ƒë√£ ho√†n t·∫•t!</strong><br>
                        <small>B·∫°n c√≥ th·ªÉ ti·∫øp t·ª•c thay ƒë·ªïi profile m√† kh√¥ng c·∫ßn nh·∫≠p m√£ x√°c th·ª±c. 
                        M√£ hi·ªán t·∫°i c√≤n {{ 5 - usage_count }} l∆∞·ª£t s·ª≠ d·ª•ng.</small>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Form x√°c th·ª±c -->
                <div id="verification-section" class="verification-section{% if show_verification_form %} show{% endif %}">
                    <h3 class="verification-title">üîê X√°c th·ª±c thay ƒë·ªïi</h3>
                    <p class="verification-text">
                        Ch√∫ng t√¥i ƒë√£ g·ª≠i m√£ x√°c th·ª±c ƒë·∫øn email c·ªßa b·∫°n. Vui l√≤ng nh·∫≠p m√£ ƒë·ªÉ ho√†n t·∫•t thay ƒë·ªïi.
                        <br><small class="verification-note">üí° <strong>L∆∞u √Ω:</strong> Email c√≥ th·ªÉ n·∫±m trong th∆∞ m·ª•c Spam/Junk.</small>
                    </p>
                    
                    <!-- Resend Verification Button with Countdown -->
                    <div class="resend-verification-container">
                        <button type="button" id="resend-verification-btn" class="btn btn-outline-secondary" disabled>
                            <span id="resend-text">üìß G·ª≠i l·∫°i m√£ x√°c th·ª±c</span>
                            <span id="countdown-text"> (60s)</span>
                        </button>
                            <small class="text-muted d-block mt-1">
                                <span id="verification-info">M√£ hi·ªán t·∫°i c√≥ hi·ªáu l·ª±c trong 10 ph√∫t v√† ƒë∆∞·ª£c s·ª≠ d·ª•ng t·ªëi ƒëa 5 l·∫ßn.</span>
                                <br><span id="resend-attempts-info" class="text-warning">C√≤n l·∫°i <span id="remaining-resend-attempts">3</span> l·∫ßn g·ª≠i l·∫°i m√£.</span>
                            </small>
                    </div>
                    
                    {% if verification_attempts > 0 %}
                    <div class="verification-alert {% if verification_attempts >= 4 %}verification-alert-danger{% else %}verification-alert-warning{% endif %}">
                        <p class="{% if verification_attempts >= 4 %}verification-alert-text-danger{% else %}verification-alert-text-warning{% endif %}">
                            {% if verification_attempts >= 4 %}
                            üö® <strong>C·∫£nh b√°o:</strong> B·∫°n ƒë√£ nh·∫≠p sai {{ verification_attempts }} l·∫ßn. C√≤n {{ 5 - verification_attempts }} l·∫ßn th·ª≠ cu·ªëi c√πng!
                            {% else %}
                            ‚ö†Ô∏è B·∫°n ƒë√£ nh·∫≠p sai {{ verification_attempts }} l·∫ßn. C√≤n {{ 5 - verification_attempts }} l·∫ßn th·ª≠.
                            {% endif %}
                        </p>
                        {% if verification_attempts >= 3 %}
                        <p class="verification-alert-hint {% if verification_attempts >= 4 %}verification-alert-text-danger{% else %}verification-alert-text-warning{% endif %}">
                            üí° <strong>G·ª£i √Ω:</strong> Ki·ªÉm tra l·∫°i email, bao g·ªìm th∆∞ m·ª•c Spam/Junk. Ho·∫∑c nh·∫•n "H·ªßy b·ªè" ƒë·ªÉ th·ª≠ l·∫°i t·ª´ ƒë·∫ßu.
                        </p>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <div class="info-group">
                        <label for="verification_code">üìß M√£ x√°c th·ª±c:</label>
                        <input type="text" id="verification_code" name="verification_code" 
                               placeholder="Nh·∫≠p m√£ 6 s·ªë t·ª´ email" maxlength="6" 
                               autocomplete="one-time-code" inputmode="numeric" pattern="[0-9]*" enterkeyhint="done"
                               autocapitalize="off" autocorrect="off" spellcheck="false"
                               class="verification-code-input">
                        <small class="text-muted">
                            <span id="code-usage-info">M√£ c√≥ hi·ªáu l·ª±c trong 10 ph√∫t, c√≤n l·∫°i <span id="remaining-uses">5</span> l·∫ßn s·ª≠ d·ª•ng</span>
                        </small>
                    </div>
                    
                    <div class="actions">
                        <button type="submit" class="btn btn-primary">‚úÖ X√°c nh·∫≠n thay ƒë·ªïi</button>
                        <button type="button" id="cancel-verification-btn" class="btn btn-secondary">‚ùå H·ªßy b·ªè</button>
                    </div>
                </div>
            </form>
    </div>



    <!-- Modal cropper avatar -->
    <div id="avatar-cropper-modal" class="avatar-cropper-modal">
      <div class="cropper-modal-content">
        <h3 class="cropper-modal-title">Ch·ªânh s·ª≠a ·∫£nh ƒë·∫°i di·ªán</h3>
        <div class="cropper-preview-container">
          <div class="cropper-preview">
            <img id="cropper-image" src="" class="cropper-image" alt="Cropper Preview">
          </div>
        </div>
        <div class="cropper-actions">
          <button type="button" id="crop-avatar-btn" class="btn btn-primary">C·∫Øt & L∆∞u</button>
          <button type="button" id="close-cropper-btn" class="btn btn-secondary">Hu·ª∑</button>
        </div>
      </div>
    </div>
{% endblock %}

{# External Libraries JavaScript #}
{% block extra_js %}
<!-- Navigation JavaScript -->
<script src="{{ url_for('static', filename='js/navigation.js', v='1.0') }}"></script>

<!-- Cropper.js JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<!-- Quill Editor JavaScript -->
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<!-- Profile Settings JavaScript -->
<script src="{{ url_for('static', filename='js/profile_settings.js', v='1.0') }}"></script>

<!-- Verification Enhancement JavaScript -->
<script>
// Verification Enhancement Logic
class VerificationEnhancer {
        constructor() {
            this.countdownTimer = null;
            this.countdownSeconds = 60;
            this.maxUses = 5;
            this.remainingUses = 5;
            this.codeValidMinutes = 10;
            this.codeIssuedTime = null;
            this.maxResendAttempts = 3;
            this.resendAttempts = 0;
            
            this.initializeElements();
            this.startCountdown();
            this.bindEvents();
        }
    
    initializeElements() {
        this.resendBtn = document.getElementById('resend-verification-btn');
        this.countdownText = document.getElementById('countdown-text');
        this.resendText = document.getElementById('resend-text');
        this.remainingUsesSpan = document.getElementById('remaining-uses');
        this.verificationInfo = document.getElementById('verification-info');
        this.codeUsageInfo = document.getElementById('code-usage-info');
        this.remainingResendAttemptsSpan = document.getElementById('remaining-resend-attempts');
        
        // Set initial values
        if (this.remainingUsesSpan) {
            this.remainingUsesSpan.textContent = this.remainingUses;
        }
        
        // Initialize remaining resend attempts display
        if (this.remainingResendAttemptsSpan) {
            this.remainingResendAttemptsSpan.textContent = this.maxResendAttempts - this.resendAttempts;
        }
        
        // Mark code issued time (simulate from server)
        this.codeIssuedTime = new Date();
    }
    
    startCountdown() {
        if (!this.resendBtn || !this.countdownText) return;
        
        this.resendBtn.disabled = true;
        this.countdownTimer = setInterval(() => {
            this.countdownSeconds--;
            this.countdownText.textContent = ` (${this.countdownSeconds}s)`;
            
            if (this.countdownSeconds <= 0) {
                this.enableResendButton();
            }
        }, 1000);
    }
    
    enableResendButton() {
        if (this.countdownTimer) {
            clearInterval(this.countdownTimer);
            this.countdownTimer = null;
        }
        
        if (this.resendBtn && this.countdownText) {
            this.resendBtn.disabled = false;
            this.countdownText.textContent = '';
            this.resendBtn.classList.remove('btn-outline-secondary');
            this.resendBtn.classList.add('btn-outline-primary');
        }
    }
    
    bindEvents() {
        if (this.resendBtn) {
            this.resendBtn.addEventListener('click', () => {
                this.handleResendClick();
            });
        }
        
        // Monitor form submissions to track usage
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', (e) => {
                const verificationSection = document.getElementById('verification-section');
                if (verificationSection && verificationSection.classList.contains('show')) {
                    this.handleVerificationSubmit();
                }
            });
        }
    }
    
    async handleResendClick() {
        if (this.resendBtn.disabled) return;
        
        // Security check: Limit resend attempts
        if (this.resendAttempts >= this.maxResendAttempts) {
            this.hideVerificationForm();
            return;
        }
        
        // Increment attempt counter
        this.resendAttempts++;
        
        // Show loading state
        const originalText = this.resendText.textContent;
        this.resendText.textContent = '‚è≥ ƒêang g·ª≠i...';
        this.resendBtn.disabled = true;
        
        try {
            // Get user ID from URL
            const userIdMatch = window.location.pathname.match(/\/profile\/(\d+)\/settings/);
            const userId = userIdMatch ? userIdMatch[1] : null;
            
            if (!userId) {
                throw new Error('Kh√¥ng t√¨m th·∫•y user ID');
            }
            
            // Make AJAX call to backend
            const response = await fetch(`/profile/${userId}/resend-verification`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Reset countdown and usage
                this.countdownSeconds = 60;
                this.remainingUses = data.remaining_uses || this.maxUses;
                this.codeIssuedTime = new Date();
                
                // Update UI
                if (this.remainingUsesSpan) {
                    this.remainingUsesSpan.textContent = this.remainingUses;
                }
                
                // Show success message
                this.showMessage(data.message, 'success');
                
                // Reset button text back to original
                this.resendText.textContent = 'üìß G·ª≠i l·∫°i m√£ x√°c th·ª±c';
                
                // Update remaining resend attempts display
                if (this.remainingResendAttemptsSpan) {
                    const remaining = this.maxResendAttempts - this.resendAttempts;
                    this.remainingResendAttemptsSpan.textContent = remaining;
                    
                    // Change color if getting low
                    const resendAttemptsInfo = document.getElementById('resend-attempts-info');
                    if (remaining <= 1 && resendAttemptsInfo) {
                        resendAttemptsInfo.className = 'text-danger';
                    }
                }
                
                // Restart countdown
                this.startCountdown();
                
                console.log('‚úÖ Verification code resent successfully');
            } else {
                throw new Error(data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
            }
            
        } catch (error) {
            console.error('‚ùå Error resending verification:', error);
            this.showMessage(`‚ùå L·ªói: ${error.message}`, 'danger');
            
            // Restore button state on error
            this.resendText.textContent = 'üìß G·ª≠i l·∫°i m√£ x√°c th·ª±c';
            this.resendBtn.disabled = false;
            this.resendBtn.classList.remove('btn-outline-secondary');
            this.resendBtn.classList.add('btn-outline-primary');
        }
    }
    
    handleVerificationSubmit() {
        if (this.remainingUses > 0) {
            this.remainingUses--;
            if (this.remainingUsesSpan) {
                this.remainingUsesSpan.textContent = this.remainingUses;
            }
            
            if (this.remainingUses === 0) {
                this.showMessage('‚ö†Ô∏è M√£ x√°c th·ª±c ƒë√£ h·∫øt l∆∞·ª£t s·ª≠ d·ª•ng. Vui l√≤ng g·ª≠i l·∫°i m√£ m·ªõi.', 'warning');
            }
        }
    }
    
    showMessage(message, type) {
        // Create temporary message
        const messageDiv = document.createElement('div');
        messageDiv.className = `alert alert-${type} alert-dismissible fade show`;
        messageDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insert before verification section
        const verificationSection = document.getElementById('verification-section');
        if (verificationSection && verificationSection.parentNode) {
            verificationSection.parentNode.insertBefore(messageDiv, verificationSection);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }
    }
    
    checkCodeExpiry() {
        if (!this.codeIssuedTime) return;
        
        const now = new Date();
        const elapsed = (now - this.codeIssuedTime) / (1000 * 60); // minutes
        
        if (elapsed >= this.codeValidMinutes) {
            if (this.codeUsageInfo) {
                this.codeUsageInfo.innerHTML = '<span class="verification-expired">‚ö†Ô∏è M√£ x√°c th·ª±c ƒë√£ h·∫øt h·∫°n. Vui l√≤ng g·ª≠i l·∫°i m√£ m·ªõi.</span>';
            }
            return true;
        }
        
        return false;
    }
    
    hideVerificationForm() {
        // Hide the entire verification section
        const verificationSection = document.getElementById('verification-section');
        if (verificationSection) {
            verificationSection.style.display = 'none';
        }
        
        // Show security warning message
        this.showMessage(
            `üîí <strong>B·∫£o m·∫≠t:</strong> B·∫°n ƒë√£ v∆∞·ª£t qu√° gi·ªõi h·∫°n ${this.maxResendAttempts} l·∫ßn g·ª≠i l·∫°i m√£ x√°c th·ª±c. 
            Form x√°c th·ª±c ƒë√£ ƒë∆∞·ª£c ƒë√≥ng ƒë·ªÉ b·∫£o v·ªá t√†i kho·∫£n. Vui l√≤ng t·∫£i l·∫°i trang ƒë·ªÉ th·ª≠ l·∫°i.`, 
            'warning'
        );
        
        // Clear any running timers
        if (this.countdownTimer) {
            clearInterval(this.countdownTimer);
            this.countdownTimer = null;
        }
        
        console.log(`üîí Security: Verification form hidden after ${this.resendAttempts} resend attempts`);
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('verification-section')) {
        window.verificationEnhancer = new VerificationEnhancer();
        
        // Check expiry every minute
        setInterval(() => {
            if (window.verificationEnhancer) {
                window.verificationEnhancer.checkCodeExpiry();
            }
        }, 60000);
    }
});
</script>
{% endblock %} 