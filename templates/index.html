<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TikZ to SVG</title>
    <!-- Highlight.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material.min.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- File Card CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/file_card.css', v='1.1') }}">
    
    <!-- Navigation CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navigation.css', v='1.0') }}">
    
    <!-- Index Page CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css', v='1.0') }}">
    












</head>
<body>
    {% include '_navbar.html' %}
    
    <!-- Search Bar -->
    <div class="container" style="margin-top: 20px; margin-bottom: 20px; overflow: visible;">
        <div class="search-container" style="display: flex; justify-content: center; align-items: center; gap: 20px;">
            <h3 class="search-title">T√¨m ki·∫øm ·∫£nh SVG</h3>
            <div class="group">
                <svg viewBox="0 0 24 24" aria-hidden="true" class="icon">
                    <g>
                        <path d="M21.53 20.47l-3.66-3.66C19.195 15.24 20 13.214 20 11c0-4.97-4.03-9-9-9s-9 4.03-9 9 4.03 9 9 9c2.215 0 4.24-.804 5.808-2.13l3.66 3.66c.147.146.34.22.53.22s.385-.073.53-.22c.295-.293.295-.767.002-1.06zM3.5 11c0-4.135 3.365-7.5 7.5-7.5s7.5 3.365 7.5 7.5-3.365 7.5-7.5 7.5-7.5-3.365-7.5-7.5z"></path>
                    </g>
                </svg>
                <input class="input" type="search" placeholder="T√¨m ki·∫øm..." id="main-search-input" />
                <div id="search-suggestions" class="search-suggestions" style="display: none;"></div>
            </div>
        </div>
    </div>
    
    <!-- Block 2: Input-Preview Section -->
    <div class="input-preview-section container">
            <h2>Chuy·ªÉn ƒë·ªïi TikZ sang SVG/PNG/JPEG</h2>

            <!-- Truy·ªÅn tr·∫°ng th√°i login t·ª´ server v√†o JS (ƒë·ªÉ linter kh√¥ng b√°o l·ªói) -->
            <script id="app-state" type="application/json">{{ {
              'loggedIn': logged_in,
              'userEmail': user_email,
              'username': username,
              'avatar': avatar
            } | tojson | safe }}</script>
            <!-- Gi√° tr·ªã TikZ ban ƒë·∫ßu ƒë·ªÉ kh·ªüi t·∫°o CodeMirror -->
            <script id="initial-tikz" type="application/json">{{ tikz_code|default('')|tojson|safe }}</script>
            <script>
              window.appState = JSON.parse(document.getElementById('app-state').textContent);
            </script>

        <div class="table-scroll-x">
          <div class="table-content">
            <div class="col">
              <form id="tikz-form" method="post" onsubmit="console.log('Form submit event'); return submitTikzCodeAjax(event)">
                <textarea name="code" id="code" rows="12" placeholder="Nh·∫≠p code TikZ t·∫°i ƒë√¢y...">{{ tikz_code|default('') }}</textarea>
                <div class="d-flex justify-content-end align-items-center gap-2" id="compile-save-row">
                  <button type="submit" id="compile-btn" class="compile-save-row-btn" {% if not logged_in %}title="B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p Google ƒë·ªÉ s·ª≠ d·ª•ng"{% endif %}>Bi√™n d·ªãch</button>
                  <button
                    type="button"
                    id="save-server-btn"
                    class="compile-save-row-btn"
                    data-file-id="{{ svg_temp_id }}"
                    data-tikz-code="{{ tikz_code | e }}"
                    style="display: none;"
                  >
                    üíæ L∆∞u server
                  </button>
                </div>
              </form>
            </div>
            <div class="col">
              {% if error %}
                <div class="error">{{ error|safe }}</div>
              {% elif svg_temp_url %}
                <img src="{{ svg_temp_url }}" alt="SVG Preview" style="width:100%;height:100%;object-fit:contain;display:block;">
              {% else %}
                <div class="preview-placeholder">
                  <p>Nh·∫≠p code TikZ ƒë·ªÉ xem preview real-time</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
        <!-- Th√¥ng b√°o h∆∞·ªõng d·∫´n cho mobile -->
        <p id="mobile-scroll-hint" style="margin-top: 12px; color: #777; font-size: 0.9em; text-align: center; display: none;">
          üì± Tr√™n ƒëi·ªán tho·∫°i, vu·ªët ngang ƒë·ªÉ xem ƒë·ªß 2 c·ªôt
        </p>





{# Th√™m block n√†y NGAY SAU form, TR∆Ø·ªöC result-tools-section #}
{% if error %}
    <div class="result-section">
        <div class="error">{{ error|safe }}
            {% if error_log_full %}
                <br><button id="show-log-btn" style="margin-top:10px; background:#b71c1c; color:white; border:none; border-radius:4px; padding:6px 16px; cursor:pointer;">Hi·ªÉn th·ªã chi ti·∫øt log</button>
                <pre id="full-log" style="display:none; background:#fff0f0; color:#b71c1c; border:1px solid #f5c6cb; border-radius:4px; padding:12px; margin-top:10px; max-height:400px; overflow:auto;">{{ error_log_full }}</pre>
                <script>
                document.getElementById('show-log-btn').onclick = function() {
                    var log = document.getElementById('full-log');
                    if (log.style.display === 'none') {
                        log.style.display = 'block';
                        this.textContent = '·∫®n chi ti·∫øt log';
                    } else {
                        log.style.display = 'none';
                        this.textContent = 'Hi·ªÉn th·ªã chi ti·∫øt log';
                    }
                };
                </script>
            {% endif %}
        </div>
    </div>
{% endif %}

        {% if svg_temp_url and not error %}
    </div> <!-- ƒë√≥ng .input-preview-section tr∆∞·ªõc khi tools -->
    
    <div id="result-tools-section" class="container" style="margin-top: 16px;">
                <div class="export-section">
                    <h4>Xu·∫•t ·∫£nh PNG/JPEG</h4>
                    <form id="export-form" class="export-form">
                        <div class="export-pair">
                            <label for="export-format" class="export-label">ƒê·ªãnh d·∫°ng:</label>
                            <select id="export-format" class="export-input export-select">
                                <option value="png">PNG</option>
                                <option value="jpeg">JPEG</option>
                            </select>
                        </div>
                        <div class="export-pair">
                            <label for="export-dpi" class="export-label">DPI:</label>
                            <input type="number" id="export-dpi" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-pair">
                            <label for="export-width" class="export-label">Width (px):</label>
                            <input type="number" id="export-width" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-pair">
                            <label for="export-height" class="export-label">Height (px):</label>
                            <input type="number" id="export-height" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-btn-group">
                            <button id="export-btn" type="button" class="export-btn" data-file-id="{{ svg_temp_id }}">T·∫£i xu·ªëng</button>
                        </div>
                    </form>
                    <div id="export-msg" style="margin-top:5px; color:#388e3c;"></div>
                </div>

                {% if svg_content %}
                    <div class="code-section">
                        <button id="toggle-svg-code-btn" class="copy-btn" type="button">üìú Xem code SVG</button>
                        <div id="svg-code-container" style="display:none; margin-top:12px;">
                            <div class="code-header">
                                <span class="code-title">Code SVG:</span>
                                <button id="copy-svg-code-btn" class="copy-btn" type="button">üìã Copy Code</button>
                            </div>
                            <div class="code-block" id="svgCode">
                                <pre><code class="language-xml">{{ svg_content }}</code></pre>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        {% else %}
    </div> <!-- ƒë√≥ng .input-preview-section -->
        {% endif %}
    
    <!-- Block 3: Files Section -->
    <div class="files-section-container container files-section" data-is-owner="{{ 'true' if logged_in else 'false' }}">
                <h3 style="color:#1976d2; margin-bottom:24px;">üìÅ Files ƒë√£ l∆∞u</h3>
                <div id="files-container" class="files-grid">
                    <div class="loading-spinner" style="text-align: center; padding: 20px;">
                        <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #1976d2; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 10px; color: #666;">ƒêang t·∫£i files...</p>
                    </div>
                </div>
    </div>

    <footer style='text-align:center;color:#888;font-size:14px;margin-top:40px;'>¬© 2024 TikZ2SVG - All rights reserved.</footer>

    <!-- Modal ƒëƒÉng nh·∫≠p cho n√∫t "Xem Code" -->
    <div id="login-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center;">
      <div style="background:white; padding:32px 40px; border-radius:12px; box-shadow:0 2px 16px rgba(0,0,0,0.15); min-width:320px; text-align:center;">
        <h3 style="margin-bottom:24px;">ƒêƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y</h3>
        <p style="margin-bottom:16px; color:#666;">Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ c√≥ th·ªÉ:</p>
        <ul style="margin-bottom:24px; color:#666; text-align:left; display:inline-block;">
          <li>üëÅÔ∏è Xem TikZ code</li>
          <li>üëç Like v√† unlike ·∫£nh</li>
          <li>üíæ L∆∞u ·∫£nh v√†o server</li>
          <li>üë• Theo d√µi ng∆∞·ªùi d√πng kh√°c</li>
        </ul>
        <p style="margin-bottom:24px; color:#1976d2; font-weight:500;">üí° B·∫°n v·∫´n c√≥ th·ªÉ s·ª≠ d·ª•ng Facebook Share v√† Copy Link m√† kh√¥ng c·∫ßn ƒëƒÉng nh·∫≠p!</p>
        
        <!-- Container cho c√°c n√∫t - cƒÉn gi·ªØa -->
        <div style="display:flex; justify-content:center; align-items:center; gap:12px; flex-wrap:wrap;">
          <button id="modal-login-btn" class="google-login-btn" style="margin:0;">
            <span class="google-login-content">
              <svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid" viewBox="0 0 256 262">
                <path fill="#4285F4" d="M255.878 133.451c0-10.734-.871-18.567-2.756-26.69H130.55v48.448h71.947c-1.45 12.04-9.283 30.172-26.69 42.356l-.244 1.622 38.755 30.023 2.685.268c24.659-22.774 38.875-56.282 38.875-96.027"></path>
                <path fill="#34A853" d="M130.55 261.1c35.248 0 64.839-11.605 86.453-31.622l-41.196-31.913c-11.024 7.688-25.82 13.055-45.257 13.055-34.523 0-63.824-22.773-74.269-54.25l-1.531.13-40.298 31.187-.527 1.465C35.393 231.798 79.49 261.1 130.55 261.1"></path>
                <path fill="#FBBC05" d="M56.281 156.37c-2.756-8.123-4.351-16.827-4.351-25.82 0-8.994 1.595-17.697 4.206-25.82l-.073-1.73L15.26 71.312l-1.335.635C5.077 89.644 0 109.517 0 130.55s5.077 40.905 13.925 58.602l42.356-32.782"></path>
                <path fill="#EB4335" d="M130.55 50.479c24.514 0 41.05 10.589 50.479 19.438l36.844-35.974C195.245 12.91 165.798 0 130.55 0 79.49 0 35.393 29.301 13.925 71.947l42.211 32.783c10.59-31.477 39.891-54.251 74.414-54.251"></path>
              </svg>
              ƒêƒÉng nh·∫≠p Google
            </span>
          </button>
          <button onclick="document.getElementById('login-modal').style.display='none'" style="background:#eee; color:#333; padding:12px 24px; border-radius:6px; border:none; font-weight:bold; margin:0;">Hu·ª∑</button>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- JavaScript Functions -->
    <script>
        // Function ƒë·ªÉ ƒëƒÉng nh·∫≠p v·ªõi Google
        function loginWithGoogle() {
            window.location.href = "{{ url_for('google.login') }}";
        }

        // Function ƒë·ªÉ load SVG files
        async function loadSvgFiles() {
            const filesContainer = document.getElementById('files-container');
            if (!filesContainer) return;

            try {
                const response = await fetch('/api/public/files');
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.files && data.files.length > 0) {
                        filesContainer.innerHTML = data.files.map(file => `
                            <div class="file-card" data-file-id="${file.id}">
                              <button class="action-toggle-btn" type="button" aria-label="Hi·ªán menu h√†nh ƒë·ªông">‚ãØ</button>
                              <div class="file-info">
                                <div class="file-creator" style="margin-bottom: 0; font-size: 12px;">
                                  üë§ <a href="/profile/${file.creator_id}/svg-files" style="text-decoration: none; color: #1976d2; font-weight: 700; font-size: 13px;">
                                    ${file.creator_username}
                                  </a>
                                  <span style="margin-left:8px; color: #666; font-size: 11px;">${file.created_time}</span>
                                </div>
                              </div>
                              <div class="file-img-container">
                                <img src="${file.url}" alt="${file.filename}">
                                <div class="like-button-wrapper">
                                  <div class="like-button">
                                    <input id="heart-${file.id}" type="checkbox" ${file.is_liked_by_current_user ? 'checked' : ''} />
                                    <label class="like" for="heart-${file.id}">
                                      <svg class="like-icon" fill-rule="nonzero" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z"></path>
                                      </svg>
                                      <span class="like-text">Likes</span>
                                    </label>
                                    <span class="like-count one">${file.like_count}</span>
                                    <span class="like-count two">${file.like_count}</span>
                                  </div>
                                </div>
                              </div>
                              <div class="file-action-container">
                                <ul class="file-action-list">
                                  <li class="file-action-item">
                                    <button type="button" class="Btn" data-action="download-image" data-filename="${file.filename}">
                                      <div class="sign">
                                        <i class="fas fa-image logoIcon"></i>
                                      </div>
                                      <div class="text">T·∫£i ·∫£nh</div>
                                    </button>
                                  </li>
                                 <li class="file-action-item">
                                    <button type="button" class="Btn" data-action="share-facebook" data-filename="${file.filename}" data-has-feedback="true">
                                      <div class="sign">
                                        <i class="fab fa-facebook logoIcon"></i>
                                      </div>
                                      <div class="text">Facebook</div>
                                    </button>
                                  </li>
                                  <li class="file-action-item">
                                    <button type="button" class="Btn" data-action="copy-link" data-url="/static/${file.filename}" data-has-feedback="true">
                                      <div class="sign">
                                        <i class="fas fa-link logoIcon"></i>
                                      </div>
                                      <div class="text">Copy Link</div>
                                    </button>
                                  </li>
                                  ${file.tikz_code ? `
                                  <li class="file-action-item">
                                    <button type="button" class="Btn" data-action="toggle-code">
                                      <div class="sign">
                                        <i class="fas fa-code logoIcon"></i>
                                      </div>
                                      <div class="text">Xem Code</div>
                                    </button>
                                  </li>
                                  ` : ''}
                                </ul>
                              </div>
                              
                              <!-- TikZ Code Section -->
                              ${file.tikz_code ? `
                              <div class="tikz-code-block" style="display:none; margin-top:10px;">
                                <div class="tikz-code-header">
                                  <span>Code TikZ:</span>
                                  <button class="copy-btn" onclick="copyTikzCode(this)">üìã Copy</button>
                                </div>
                                <div class="code-block">
                                  <textarea class="tikz-cm" readonly>${file.tikz_code}</textarea>
                                </div>
                              </div>
                              ` : ''}
                            </div>
                        `).join('');
                        
                        // Setup buttons sau khi t·∫°o HTML
                        setupFileCardButtons();
                    } else {
                        filesContainer.innerHTML = `
                            <div class="no-files">
                                <p>Ch∆∞a c√≥ file SVG n√†o ƒë∆∞·ª£c t·∫°o. H√£y th·ª≠ chuy·ªÉn ƒë·ªïi m·ªôt code TikZ!</p>
                            </div>
                        `;
                    }
                } else {
                    filesContainer.innerHTML = `
                        <div class="no-files">
                            <p>Kh√¥ng th·ªÉ t·∫£i danh s√°ch files. Vui l√≤ng th·ª≠ l·∫°i sau.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading SVG files:', error);
                filesContainer.innerHTML = `
                    <div class="no-files">
                        <p>L·ªói khi t·∫£i danh s√°ch files: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Function x·ª≠ l√Ω click like
        function handleLikeClick(btn, svgId) {
            if (!window.appState.loggedIn) {
                // Hi·ªÉn th·ªã modal ƒëƒÉng nh·∫≠p n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
                const loginModal = document.getElementById('login-modal');
                if (loginModal) {
                    loginModal.style.display = 'flex';
                } else {
                    window.location.href = '/login/google';
                }
                return;
            }
            
            // Logic like/unlike cho ng∆∞·ªùi ƒë√£ ƒëƒÉng nh·∫≠p
            fetch('/like_svg', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    svg_id: svgId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // C·∫≠p nh·∫≠t UI
                    const currentText = btn.textContent;
                    const likeCount = parseInt(currentText.match(/\d+/)[0]);
                    const newCount = data.liked ? likeCount + 1 : likeCount - 1;
                    btn.textContent = `‚ù§Ô∏è Likes ${newCount}`;
                    btn.style.background = data.liked ? '#e74c3c' : '#6c757d';
                }
            })
            .catch(error => {
                console.error('Error liking SVG:', error);
            });
        }

        // Function x·ª≠ l√Ω c√°c n√∫t khi ch∆∞a ƒëƒÉng nh·∫≠p
        function setupFileCardButtons() {
            // Kh√¥ng c·∫ßn x·ª≠ l√Ω ri√™ng n·ªØa v√¨ initializeActionButtons ƒë√£ x·ª≠ l√Ω t·∫•t c·∫£
            // Logic ƒë√£ ƒë∆∞·ª£c chuy·ªÉn sang s·ª≠ d·ª•ng data-action attributes
        }

        // Load SVG files s·∫Ω ƒë∆∞·ª£c g·ªçi trong main initializer

        function updateHeaderLoginState() {
            // Logic m·ªõi: Header ƒë√£ ƒë∆∞·ª£c render t·ª´ server v·ªõi avatar/username
            // Ch·ªâ c·∫ßn x·ª≠ l√Ω c√°c logic b·ªï sung
            
            if (window.appState.loggedIn) {
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t sau khi ƒëƒÉng nh·∫≠p
                updateButtonStates();
                
                // Ki·ªÉm tra xem c√≥ ·∫£nh SVG ƒëang ch·ªù hi·ªÉn th·ªã sau khi ƒëƒÉng nh·∫≠p kh√¥ng

            }
        }

        function setupRequireLogin() {
            // Ch·ªâ x·ª≠ l√Ω c√°c n√∫t kh√°c, kh√¥ng x·ª≠ l√Ω view-btn v√¨ ƒë√£ x·ª≠ l√Ω ri√™ng
            document.querySelectorAll('.files-section .file-copy-link-btn, .files-section .copy-btn').forEach(function(btn) {
                btn.onclick = function(e) {
                    if (!window.appState.loggedIn) {
                        e.preventDefault();
                        showLoginModal();
                    }
                };
            });
        }

        // H√†m kh·ªüi t·∫°o event listeners cho c√°c n√∫t
        function initializeEventListeners() {
            // ----------------------------------------------
            // 1. Copy link (üîó Copy Link)
            // ----------------------------------------------
            document.querySelectorAll('.copy-link-btn').forEach(btn => {
                btn.onclick = function() {
                    const link = this.getAttribute('data-link');
                    if (link) {
                        navigator.clipboard.writeText(link)
                            .then(() => showFeedback(this, '‚úÖ ƒê√£ copy!'))
                            .catch(() => showFeedback(this, '‚ùå L·ªói copy!'));
                    }
                };
            });

            // ----------------------------------------------
            // 2. Copy Facebook link (üü¶ Copy link Facebook)
            // ----------------------------------------------
            document.querySelectorAll('.copy-fb-link-btn').forEach(btn => {
                btn.onclick = function() {
                    const link = this.getAttribute('data-link');
                    if (link) {
                        const fbLink = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`;
                        navigator.clipboard.writeText(fbLink)
                            .then(() => showFeedback(this, '‚úÖ ƒê√£ copy link Facebook!'))
                            .catch(() => showFeedback(this, '‚ùå L·ªói copy!'));
                    }
                };
            });

            // ----------------------------------------------
            // 3. Xem code TikZ (üìù Xem code TikZ)
            // ----------------------------------------------
            document.querySelectorAll('.view-tikz-btn').forEach(btn => {
                btn.onclick = function() {
                    const tikzCode = this.getAttribute('data-tikz-code');
                    if (tikzCode) {
                        showTikzCodeModal(tikzCode);
                    }
                };
            });

            // ----------------------------------------------
            // 4. N√∫t l∆∞u server (üíæ L∆∞u server)
            // ----------------------------------------------
            document.querySelectorAll('#save-server-btn').forEach(btn => {
                btn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const fileId = this.getAttribute('data-file-id');
                    const tikzCode = this.getAttribute('data-tikz-code') || "";
                    
                    if (!fileId) {
                        alert("L·ªói: kh√¥ng c√≥ file_id!");
                        return;
                    }

                    // Reset modal
                    const keywordsInput = document.getElementById('keywordsInput');
                    const suggestionsBox = document.getElementById('keywordSuggestions');
                    if (keywordsInput) keywordsInput.value = "";
                    if (suggestionsBox) {
                        suggestionsBox.innerHTML = '';
                        suggestionsBox.style.display = 'none';
                    }

                    // L·∫•y URL ·∫£nh SVG t·ª´ preview hi·ªán t·∫°i
                    const currentPreview = document.querySelector('.preview-col img');
                    const modalSvgImg = document.getElementById('modal-svg-img');
                    if (currentPreview && modalSvgImg) {
                        modalSvgImg.src = currentPreview.src;
                        modalSvgImg.style.display = 'block';
                    } else if (modalSvgImg) {
                        modalSvgImg.style.display = 'none';
                    }

                    // Ki·ªÉm tra xem c√≥ file_id h·ª£p l·ªá kh√¥ng (t·ª©c l√† ƒë√£ bi√™n d·ªãch th√†nh c√¥ng)
                    if (!fileId || fileId === 'None' || fileId === '') {
                        alert('‚ö†Ô∏è C·∫£nh b√°o: Ch∆∞a c√≥ ·∫£nh SVG ƒë∆∞·ª£c bi√™n d·ªãch th√†nh c√¥ng.\n\nVui l√≤ng nh·∫•n n√∫t "Bi√™n d·ªãch" tr∆∞·ªõc khi l∆∞u server.');
                        return;
                    }

                    // Ki·ªÉm tra xem code TikZ hi·ªán t·∫°i c√≥ kh·ªõp v·ªõi code TikZ ƒë√£ ƒë∆∞·ª£c bi√™n d·ªãch kh√¥ng
                    const currentTikzCode = window.cm ? window.cm.getValue() : document.getElementById('code').value;
                    const compiledTikzCode = this.getAttribute('data-tikz-code') || "";
                    
                    // Debug: Log ƒë·ªÉ ki·ªÉm tra
                    console.log('Current TikZ Code:', currentTikzCode.trim());
                    console.log('Compiled TikZ Code:', compiledTikzCode.trim());
                    console.log('Are they equal?', currentTikzCode.trim() === compiledTikzCode.trim());
                    
                    if (currentTikzCode.trim() !== compiledTikzCode.trim()) {
                        alert('‚ö†Ô∏è C·∫£nh b√°o: Code TikZ hi·ªán t·∫°i kh√°c v·ªõi code TikZ ƒë√£ ƒë∆∞·ª£c bi√™n d·ªãch.\n\n·∫¢nh hi·ªÉn th·ªã: t·ª´ code TikZ hi·ªán t·∫°i\n·∫¢nh s·∫Ω ƒë∆∞·ª£c l∆∞u: t·ª´ code TikZ ƒë√£ bi√™n d·ªãch\n\nVui l√≤ng nh·∫•n n√∫t "Bi√™n d·ªãch" ƒë·ªÉ c·∫≠p nh·∫≠t tr∆∞·ªõc khi l∆∞u server.');
                        return;
                    }

                    // L∆∞u th√¥ng tin t·∫°m th·ªùi
                    window.pendingFileId = fileId;
                    window.pendingTikzCode = tikzCode;

                    // Hi·ªán modal Bootstrap
                    const modal = new bootstrap.Modal(document.getElementById('keywordModal'));
                    modal.show();
                };
            });

            // ----------------------------------------------
            // 5. N√∫t export PNG/JPEG (T·∫£i xu·ªëng)
            // ----------------------------------------------
            const exportBtn = document.getElementById('export-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', async function() {
                    const svgTempId = exportBtn.getAttribute('data-file-id') || '';
                    const format = document.getElementById('export-format').value;
                    const widthVal = document.getElementById('export-width').value;
                    const heightVal = document.getElementById('export-height').value;
                    const dpiVal = document.getElementById('export-dpi').value;
                    const msg = document.getElementById('export-msg');

                    // Reset message area
                    msg.textContent = '';
                    msg.className = '';

                    if ((widthVal && widthVal <= 0) || (heightVal && heightVal <= 0) || (dpiVal && dpiVal <= 0)) {
                        msg.textContent = 'Width, Height, DPI ph·∫£i l√† s·ªë d∆∞∆°ng!';
                        return;
                    }

                    exportBtn.disabled = true;
                    exportBtn.textContent = 'ƒêang x·ª≠ l√Ω...';

                    try {
                        const res = await fetch('/temp_convert', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                file_id: svgTempId,
                                fmt: format,
                                width: widthVal || undefined,
                                height: heightVal || undefined,
                                dpi: dpiVal || undefined
                            })
                        });
                        const data = await res.json();
                        if (data.url) {
                            // Container to make layout clean like view_svg
                            const container = document.createElement('div');
                            container.style.display = 'flex';
                            container.style.flexDirection = 'column';
                            container.style.alignItems = 'center';
                            container.style.gap = '6px';

                            // Build link safely
                            const link = document.createElement('a');
                            link.href = data.url;
                            link.download = '';
                            link.className = 'export-download-link';
                            link.textContent = `T·∫£i v·ªÅ ${format.toUpperCase()}`;
                            container.appendChild(link);

                            // Optional: show file info if backend returns it (align with view_svg.html)
                            if (data.file_size || data.actual_size) {
                                const info = document.createElement('div');
                                info.style.marginTop = '8px';
                                info.style.fontSize = '12px';
                                info.style.color = '#666';
                                info.style.textAlign = 'center';
                                info.style.fontWeight = 'bold';

                                const parts = [];
                                if (data.file_size) {
                                    const sizeKB = (data.file_size / 1024).toFixed(1);
                                    parts.push(`Dung l∆∞·ª£ng: ${sizeKB} KB`);
                                }
                                if (data.actual_size) {
                                    parts.push(`K√≠ch th∆∞·ªõc: ${data.actual_size}`);
                                }
                                info.textContent = parts.join(' | ');
                                container.appendChild(info);
                            }

                            msg.appendChild(container);
                        } else {
                            msg.textContent = data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh!';
                        }
                    } catch (err) {
                        msg.textContent = 'L·ªói k·∫øt n·ªëi ho·∫∑c m√°y ch·ªß!';
                    }

                    exportBtn.disabled = false;
                    exportBtn.textContent = 'T·∫£i xu·ªëng';
                });
            }

            // ----------------------------------------------
            // 6. Toggle SVG Code (üìú Xem code SVG)
            // ----------------------------------------------
            const toggleSvgCodeBtn = document.getElementById('toggle-svg-code-btn');
            if (toggleSvgCodeBtn) {
                toggleSvgCodeBtn.onclick = function() {
                    const container = document.getElementById('svg-code-container');
                    if (container) {
                        const currentlyHidden = container.style.display === 'none' || container.style.display === '';
                        container.style.display = currentlyHidden ? 'block' : 'none';
                        toggleSvgCodeBtn.textContent = currentlyHidden ? '‚ùå ·∫®n code SVG' : 'üìú Xem code SVG';
                    }
                };
            }

            // ----------------------------------------------
            // 7. Copy SVG Code (üìã Copy Code)
            // ----------------------------------------------
            const copySvgCodeBtn = document.getElementById('copy-svg-code-btn');
            if (copySvgCodeBtn) {
                copySvgCodeBtn.onclick = function() {
                    const codeBlock = document.getElementById('svgCode');
                    if (codeBlock) {
                        const text = codeBlock.innerText.trim();
                        navigator.clipboard.writeText(text).then(() => {
                            copySvgCodeBtn.textContent = '‚úÖ ƒê√£ copy!';
                            setTimeout(() => {
                                copySvgCodeBtn.textContent = 'üìã Copy Code';
                            }, 2000);
                        }).catch(() => {
                            copySvgCodeBtn.textContent = '‚ùå L·ªói copy!';
                            setTimeout(() => {
                                copySvgCodeBtn.textContent = 'üìã Copy Code';
                            }, 2000);
                        });
                    }
                };
            }
        }

        var cm; // Khai b√°o global ƒë·ªÉ c√°c h√†m kh√°c truy c·∫≠p ƒë∆∞·ª£c
        function copyToClipboard(text, buttonElement, originalText) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = 0;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            if (buttonElement) {
                const originalContent = buttonElement.innerHTML;
                buttonElement.innerHTML = '‚úÖ ƒê√£ copy!';
                setTimeout(() => {
                    buttonElement.innerHTML = originalContent;
                }, 2000);
            }
        }

        function copySvgCode() {
            const codeBlock = document.getElementById('svgCode');
            const copyBtn = document.querySelector('.copy-btn');
            copyToClipboard(codeBlock.textContent, copyBtn, 'üìã Copy Code');
        }

        function copyTikzCode(btn) {
            // L·∫•y code t·ª´ CodeMirror instance n·∫øu c√≥, n·∫øu kh√¥ng th√¨ t·ª´ textarea g·ªëc
            const codeBlock = btn.closest('.tikz-code-block');
            const textarea = codeBlock.querySelector('.tikz-cm');
            let code = '';
            
            // ∆Øu ti√™n l·∫•y t·ª´ CodeMirror instance
            if (textarea.CodeMirror) {
                code = textarea.CodeMirror.getValue();
                console.log('Getting code from CodeMirror instance');
            } else {
                // Fallback: l·∫•y t·ª´ textarea g·ªëc
                code = textarea.value;
                console.log('Getting code from original textarea');
            }
            
            // Lo·∫°i b·ªè d√≤ng tr·∫Øng ·ªü ƒë·∫ßu v√† cu·ªëi, ch·ªâ gi·ªØ t·ªëi ƒëa 1 d√≤ng tr·∫Øng li√™n ti·∫øp
            let lines = code.split('\n');
            while (lines.length && lines[0].trim() === '') lines.shift();
            while (lines.length && lines[lines.length - 1].trim() === '') lines.pop();
            let cleaned = [];
            let lastBlank = false;
            for (let line of lines) {
                if (line.trim() === '') {
                    if (!lastBlank) cleaned.push('');
                    lastBlank = true;
                } else {
                    cleaned.push(line);
                    lastBlank = false;
                }
            }
            
            const finalCode = cleaned.join('\n');
            console.log('Copying code:', finalCode.substring(0, 100) + '...');
            copyToClipboard(finalCode, btn, 'üìã Copy');
        }

        

        // Kh·ªüi t·∫°o CodeMirror s·∫Ω ƒë∆∞·ª£c g·ªçi trong init ch√≠nh
        function initCodeMirrorAndBindings() {
            var tikzCode = document.getElementById('code');
            cm = CodeMirror.fromTextArea(tikzCode, {
                mode: 'stex',
                theme: 'material',
                lineNumbers: true,
                lineWrapping: true,
                placeholder: 'Nh·∫≠p code TikZ t·∫°i ƒë√¢y...'
            });
            // Gi√° tr·ªã ban ƒë·∫ßu t·ª´ server
            try {
                cm.setValue(JSON.parse(document.getElementById('initial-tikz')?.textContent || '""'));
            } catch(e) {
                cm.setValue('');
            }
            
            // Th√™m s·ª± ki·ªán click v√†o CodeMirror ƒë·ªÉ hi·ªán modal ƒëƒÉng nh·∫≠p n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
            if (!window.appState.loggedIn) {
                cm.on('mousedown', function() {
                    showLoginModal();
                });
            }
            
            // Th√™m s·ª± ki·ªán real-time preview cho form nh·∫≠p code
            let inputPreviewTimer;
            cm.on('change', function() {
                clearTimeout(inputPreviewTimer);
                inputPreviewTimer = setTimeout(() => {
                    updateInputPreview(cm.getValue());
                }, 1000); // Delay 1 gi√¢y sau khi ng·ª´ng g√µ
            });
            

            // S·ª± ki·ªán copy link Facebook
            document.querySelectorAll('.fb-share-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const filename = btn.getAttribute('data-filename');
                    const shareUrl = `${window.location.origin}/view_svg/${filename}`;
                    const textArea = document.createElement('textarea');
                    textArea.value = shareUrl;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = 0;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    btn.innerHTML = '‚úÖ ƒê√£ copy link Facebook!';
                    setTimeout(() => {
                        btn.innerHTML = 'üü¶ Copy link Facebook';
                    }, 2000);
                });
            });


            
            // Kh·ªüi t·∫°o preview n·∫øu c√≥ code TikZ ban ƒë·∫ßu
            const initialCode = cm.getValue();
            if (initialCode && initialCode.trim()) {
                updateInputPreview(initialCode);
            }
        }

        // Hi·ªÉn th·ªã l·ªói bi√™n d·ªãch TikZ, k√®m log chi ti·∫øt n·∫øu c√≥
        function displayCompileError(message, fullLog) {
            console.log('displayCompileError called with:', { message, hasFullLog: !!fullLog });
            // X√≥a T·∫§T C·∫¢ error sections c≈©
            document.querySelectorAll('.result-section, #result-section, #ajax-result-section').forEach(el => {
                if (el.querySelector('.error') || el.querySelector('#ajax-show-log-btn')) {
                    el.remove();
                }
            });
            // N·∫øu kh√¥ng c√≥ log chi ti·∫øt th√¨ ch·ªâ hi·ªán text l·ªói chung
            const section = document.createElement('div');
            section.id = 'ajax-result-section';
            section.className = 'result-section';
            let html = `<div class=\"error\">L·ªói khi bi√™n d·ªãch!</div>`;
            if (fullLog && fullLog.trim()) {
                html += `<button id=\"ajax-show-log-btn\" style=\"margin-top:10px; background:#b71c1c; color:white; border:none; border-radius:4px; padding:6px 16px; cursor:pointer;\">Hi·ªÉn th·ªã chi ti·∫øt log</button>`;
                html += `<button id=\"ajax-copy-log-btn\" style=\"display:none; margin-left:10px; background:#ffc107; color:#212529; border:none; border-radius:4px; padding:6px 16px; cursor:pointer; font-weight:bold;\">Copy log</button>`;
                html += `<pre id=\"ajax-full-log\" style=\"display:none; background:#fff0f0; color:#b71c1c; border:1px solid #f5c6cb; border-radius:4px; padding:12px; margin-top:10px; max-height:400px; overflow:auto;\">${fullLog}</pre>`;
            }
            section.innerHTML = html;
            // Insert OUTSIDE the scroll area: sau .table-scroll-x v√† sau mobile hint
            const tableScroll = document.querySelector('.table-scroll-x');
            const mobileHint = document.getElementById('mobile-scroll-hint');
            if (tableScroll && tableScroll.parentNode) {
                if (mobileHint && mobileHint.parentNode) {
                    // Insert error section sau mobile hint
                    mobileHint.parentNode.insertBefore(section, mobileHint.nextSibling);
                } else {
                    // Insert error section sau table-scroll-x
                    tableScroll.parentNode.insertBefore(section, tableScroll.nextSibling);
                }
            } else {
                // Fallback: sau form
                const form = document.getElementById('tikz-form');
                if (form && form.parentNode) {
                    form.parentNode.insertBefore(section, form.nextSibling);
                } else {
                    document.body.appendChild(section);
                }
            }
            // G√°n event handler
            const logBtn = document.getElementById('ajax-show-log-btn');
            const copyBtn = document.getElementById('ajax-copy-log-btn');
            if (logBtn) {
                logBtn.onclick = function() {
                    const log = document.getElementById('ajax-full-log');
                    if (log) {
                        if (log.style.display === 'none') {
                            log.style.display = 'block';
                            this.textContent = '·∫®n chi ti·∫øt log';
                            if (copyBtn) copyBtn.style.display = 'inline-block';
                        } else {
                            log.style.display = 'none';
                            this.textContent = 'Hi·ªÉn th·ªã chi ti·∫øt log';
                            if (copyBtn) copyBtn.style.display = 'none';
                        }
                    }
                };
                console.log('Log button event handler attached');
            }
            if (copyBtn) {
                copyBtn.onclick = function() {
                    const log = document.getElementById('ajax-full-log');
                    if (log) {
                        navigator.clipboard.writeText(log.textContent)
                            .then(() => {
                                copyBtn.textContent = '‚úÖ ƒê√£ copy!';
                                setTimeout(() => { copyBtn.textContent = 'Copy log'; }, 2000);
                            })
                            .catch(() => {
                                copyBtn.textContent = '‚ùå L·ªói copy!';
                                setTimeout(() => { copyBtn.textContent = 'Copy log'; }, 2000);
                            });
                    }
                };
            }
        }

        // H√†m AJAX m·ªõi ƒë·ªÉ submit kh√¥ng reload trang
        async function submitTikzCodeAjax(event) {
            console.log('AJAX submit started'); // Debug
            event.preventDefault(); // NgƒÉn form submit b√¨nh th∆∞·ªùng
            
            // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
            if (!window.appState.loggedIn) {
                showLoginModal();
                return false;
            }

            // L·∫•y code t·ª´ CodeMirror
            const tikzCode = cleanControlChars(cm.getValue());
            if (!tikzCode.trim()) {
                alert('Vui l√≤ng nh·∫≠p code TikZ');
                return false;
            }

            // Hi·ªÉn th·ªã loading
            const compileBtn = document.getElementById('compile-btn');
            const originalText = compileBtn.textContent;
            compileBtn.textContent = 'ƒêang bi√™n d·ªãch...';
            compileBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('code', tikzCode);

                const response = await fetch('/', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    // KI·ªÇM TRA L·ªñI CH√çNH X√ÅC H∆†N
                    // 1. Ki·ªÉm tra trong preview-col tr∆∞·ªõc
                    const previewColError = doc.querySelector('.preview-col .error');
                    // 2. Ki·ªÉm tra trong result-section 
                    const resultSectionError = doc.querySelector('.result-section .error');
                    // 3. Ki·ªÉm tra error ƒë·ªôc l·∫≠p
                    const standaloneError = doc.querySelector('.error');

                    // Debug ƒë·ªÉ ki·ªÉm tra error detection
                    console.log('Checking for errors in response...');
                    console.log('Preview col error:', previewColError);
                    console.log('Result section error:', resultSectionError);
                    console.log('Standalone error:', standaloneError);

                    const errorElement = previewColError || resultSectionError || standaloneError;
                    if (errorElement) {
                        const msg = errorElement.innerHTML;
                        // T√¨m full log trong c√πng document
                        const fullLogEl = doc.getElementById('full-log');
                        const fullLog = fullLogEl ? fullLogEl.textContent : '';
                        console.log('Error detected:', msg);
                        console.log('Full log:', fullLog ? 'Yes' : 'No');
                        displayCompileError(msg, fullLog);
                        return;
                    }

                    // C·∫≠p nh·∫≠t preview
                    const previewCol = document.querySelector('.preview-col');
                    const newPreviewCol = doc.querySelector('.preview-col');
                    if (previewCol && newPreviewCol) {
                        previewCol.innerHTML = newPreviewCol.innerHTML;
                    }

                    // C·∫≠p nh·∫≠t result-tools-section v√† ƒë·∫£m b·∫£o ƒë·∫∑t b√™n ngo√†i .table-scroll-x
                    const tableScroll = document.querySelector('.table-scroll-x');
                    const mobileHint = document.getElementById('mobile-scroll-hint');
                    const resultToolsSection = document.getElementById('result-tools-section');
                    const newResultToolsSection = doc.getElementById('result-tools-section');
                    
                    if (newResultToolsSection) {
                        if (resultToolsSection) {
                            resultToolsSection.innerHTML = newResultToolsSection.innerHTML;
                            resultToolsSection.style.display = 'block';
                            // Di chuy·ªÉn ra ngay sau mobile hint (n·∫øu c√≥), ng∆∞·ª£c l·∫°i ngay sau .table-scroll-x
                            if (mobileHint && mobileHint.parentNode) {
                                mobileHint.parentNode.insertBefore(resultToolsSection, mobileHint.nextSibling);
                            } else if (tableScroll && tableScroll.parentNode) {
                                tableScroll.parentNode.insertBefore(resultToolsSection, tableScroll.nextSibling);
                            }
                        } else {
                            // T·∫°o m·ªõi result-tools-section n·∫øu ch∆∞a c√≥ v√† ƒë·∫∑t sau mobile hint (n·∫øu c√≥) ho·∫∑c sau .table-scroll-x
                            const newSection = document.createElement('div');
                            newSection.id = 'result-tools-section';
                            newSection.innerHTML = newResultToolsSection.innerHTML;
                            if (mobileHint && mobileHint.parentNode) {
                                mobileHint.parentNode.insertBefore(newSection, mobileHint.nextSibling);
                            } else if (tableScroll && tableScroll.parentNode) {
                                tableScroll.parentNode.insertBefore(newSection, tableScroll.nextSibling);
                            } else {
                                // Fallback: th√™m cu·ªëi body n·∫øu kh√¥ng t√¨m th·∫•y .table-scroll-x
                                document.body.appendChild(newSection);
                            }
                        }
                        // ·∫®n ho·∫∑c x√≥a ajax-result-section n·∫øu c√≥
                        const ajaxResultSection = document.getElementById('ajax-result-section');
                        if (ajaxResultSection) {
                            ajaxResultSection.style.display = 'none';
                        }
                    } else if (resultToolsSection) {
                        resultToolsSection.style.display = 'none';
                    }

                    // Kh·ªüi t·∫°o l·∫°i c√°c event listeners cho c√°c n√∫t m·ªõi
                    initializeEventListeners();

                    // Kh·ªüi t·∫°o l·∫°i CodeMirror cho textarea id="code"
                    ensureCodeMirror();
                    
                    // Debug: Ki·ªÉm tra n√∫t save server c√≥ ƒë∆∞·ª£c g√°n event ch∆∞a
                    const saveServerBtn = document.getElementById('save-server-btn');
                    if (saveServerBtn) {
                        console.log('Save server button found after AJAX update');
                        console.log('Button onclick:', saveServerBtn.onclick);
                    } else {
                        console.log('Save server button not found after AJAX update');
                    }

                    // Hi·ªán n√∫t L∆∞u server sau khi bi√™n d·ªãch th√†nh c√¥ng
                    if (saveServerBtn && newResultToolsSection) {
                        // L·∫•y svg_temp_id m·ªõi t·ª´ n√∫t export-btn ho·∫∑c t·ª´ DOM m·ªõi
                        const exportBtn = (document.getElementById('result-tools-section') || newResultToolsSection)?.querySelector('#export-btn');
                        if (exportBtn) {
                            const newFileId = exportBtn.getAttribute('data-file-id');
                            if (newFileId) saveServerBtn.setAttribute('data-file-id', newFileId);
                        }
                        // L·∫•y code TikZ m·ªõi t·ª´ CodeMirror
                        if (window.cm && typeof window.cm.getValue === 'function') {
                            saveServerBtn.setAttribute('data-tikz-code', window.cm.getValue());
                        }
                        saveServerBtn.style.display = 'inline-block';
                    }
                } else {
                    // Handle HTTP errors
                    try {
                        const errorData = await response.json();
                        displayCompileError(errorData.error || 'L·ªói khi bi√™n d·ªãch', errorData.error_log_full || '');
                    } catch (e) {
                        displayCompileError('L·ªói k·∫øt n·ªëi v·ªõi server', '');
                    }
                }
            } catch (error) {
                console.error('AJAX Error:', error);
                displayCompileError('C√≥ l·ªói x·∫£y ra khi bi√™n d·ªãch: ' + error.message, '');
            } finally {
                // Kh√¥i ph·ª•c n√∫t
                compileBtn.textContent = originalText;
                compileBtn.disabled = false;
                console.log('AJAX submit completed'); // Debug
            }
            return false;
        }
        window.submitTikzCodeAjax = submitTikzCodeAjax;

            // B·ªé V√íNG L·∫∂P N√ÄY - Ch·ªâ kh·ªüi t·∫°o CodeMirror khi c·∫ßn trong toggleTikzCode
            // document.querySelectorAll('.tikz-cm').forEach(function(textarea) {
            //     if (!textarea.CodeMirror) {
            //         CodeMirror.fromTextArea(textarea, {
            //             mode: 'stex',
            //             theme: 'material',
            //             lineNumbers: true,
            //             readOnly: true,
            //             viewportMargin: Infinity
            //         });
            //     }
            // });
        // K·∫øt th√∫c initCodeMirrorAndBindings

        // (ƒê√£ lo·∫°i b·ªè kh·ªëi highlight TikZ input c≈© ƒë·ªÉ tr√°nh l·ªói linter v√† tr√πng ch·ª©c nƒÉng)

        // H√†m c·∫≠p nh·∫≠t preview real-time cho form nh·∫≠p code
        async function updateInputPreview(tikzCode) {
            if (!tikzCode.trim()) {
                const previewContainer = document.querySelector('.col:last-child');
                if (previewContainer) {
                    previewContainer.innerHTML = '<div class="preview-placeholder"><p>Nh·∫≠p code TikZ ƒë·ªÉ xem preview real-time</p></div>';
                }
                return;
            }
            
            const previewContainer = document.querySelector('.col:last-child');
            if (previewContainer) {
                // N·∫øu ƒëang c√≥ ·∫£nh SVG preview, l√†m m·ªù ·∫£nh thay v√¨ ·∫©n
                const previewImg = previewContainer.querySelector('img');
                if (previewImg) {
                    previewImg.style.opacity = '0.5';
                    previewImg.alt = 'ƒêang c·∫≠p nh·∫≠t preview...';
                } else {
                    previewContainer.innerHTML = '<div class="preview-placeholder"><p>ƒêang c·∫≠p nh·∫≠t preview...</p></div>';
                }
            }
            
            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `code=${encodeURIComponent(tikzCode)}`
                });
                
                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Ki·ªÉm tra l·ªói tr∆∞·ªõc khi t√¨m SVG
                    const previewColError = doc.querySelector('.preview-col .error');
                    const resultSectionError = doc.querySelector('.result-section .error');
                    const standaloneError = doc.querySelector('.error');
                    
                    const errorElement = previewColError || resultSectionError || standaloneError;
                    if (errorElement) {
                        if (previewContainer) {
                            previewContainer.innerHTML = '<div class="preview-placeholder"><p>Code c√≥ l·ªói - vui l√≤ng s·ª≠a</p></div>';
                        }
                        return;
                    }
                    
                    // T√¨m SVG trong preview-col
                    const newSvgUrl = doc.querySelector('.col:last-child img')?.src;
                    
                    if (newSvgUrl && previewContainer) {
                        // N·∫øu ƒë√£ c√≥ img, ch·ªâ c·∫≠p nh·∫≠t src v√† opacity
                        let previewImg = previewContainer.querySelector('img');
                        if (previewImg) {
                            previewImg.src = newSvgUrl;
                            previewImg.style.opacity = '1';
                            previewImg.alt = 'SVG Preview (Real-time)';
                        } else {
                            previewContainer.innerHTML = `<img src="${newSvgUrl}" alt="SVG Preview (Real-time)" style="width:100%;height:100%;object-fit:contain;display:block;">`;
                        }
                    } else if (previewContainer) {
                        previewContainer.innerHTML = '<div class="preview-placeholder"><p>Ch∆∞a c√≥ preview</p></div>';
                    }
                } else {
                    if (previewContainer) {
                        previewContainer.innerHTML = '<div class="preview-placeholder"><p>L·ªói khi t·∫°o preview</p></div>';
                    }
                }
            } catch (error) {
                console.log('Input preview update failed:', error);
                if (previewContainer) {
                    previewContainer.innerHTML = '<div class="preview-placeholder"><p>L·ªói k·∫øt n·ªëi</p></div>';
                }
            }
        }

        // H√†m c·∫≠p nh·∫≠t preview real-time cho view mode
        async function updateRealTimePreview(tikzCode) {
            if (!tikzCode.trim()) return;
            
            const previewImg = document.getElementById('view-svg-img');
            if (previewImg) {
                previewImg.style.opacity = '0.5';
                previewImg.alt = 'ƒêang c·∫≠p nh·∫≠t preview...';
            }
            
            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `code=${encodeURIComponent(tikzCode)}`
                });
                
                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    // T√¨m SVG trong preview-col thay v√¨ svg-preview
                    const newSvgUrl = doc.querySelector('.preview-col img')?.src;
                    
                    if (newSvgUrl && previewImg) {
                        previewImg.src = newSvgUrl;
                        previewImg.style.opacity = '1';
                        previewImg.alt = 'SVG Preview (Real-time)';
                        
                        // C·∫≠p nh·∫≠t link download v√† copy link cho preview m·ªõi
                        const downloadBtn = document.getElementById('view-download-svg-btn');
                        if (downloadBtn) {
                            downloadBtn.href = newSvgUrl;
                        }
                        
                        // C·∫≠p nh·∫≠t s·ª± ki·ªán copy link cho preview m·ªõi
                        const copyLinkBtn = document.getElementById('view-copy-link-btn');
                        if (copyLinkBtn) {
                            copyLinkBtn.onclick = function() {
                                copyToClipboard(newSvgUrl, this, 'üîó Copy Link');
                            };
                        }
                    }
                }
            } catch (error) {
                console.log('Preview update failed:', error);
                if (previewImg) {
                    previewImg.style.opacity = '1';
                    previewImg.alt = 'SVG Preview';
                }
            }
        }

        function toggleTikzCode(btn) {
            try {
                const card = btn.closest('.file-card');
                if (!card) return;
                const codeBlock = card.querySelector('.tikz-code-block');
                const textarea = codeBlock ? codeBlock.querySelector('.tikz-cm') : null;
                if (!codeBlock || !textarea) return;

                const isHidden = window.getComputedStyle(codeBlock).display === 'none';
                if (isHidden) {
                    codeBlock.style.display = 'block';

                    let cmInstance = textarea.CodeMirror;
                    if (!cmInstance) {
                        const existingCm = codeBlock.querySelector('.CodeMirror');
                        if (existingCm) existingCm.remove();
                        cmInstance = CodeMirror.fromTextArea(textarea, {
                            mode: 'stex',
                            theme: 'material',
                            lineNumbers: true,
                            readOnly: true,
                            viewportMargin: Infinity,
                            scrollbarStyle: 'native'
                        });
                    }
                    setTimeout(() => cmInstance && cmInstance.refresh && cmInstance.refresh(), 80);
                    btn.innerHTML = '·∫®n code TikZ';
                    // ƒê∆∞a code block v√†o v√πng nh√¨n th·∫•y
                    codeBlock.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    codeBlock.style.display = 'none';
                    btn.innerHTML = 'üìù Xem code TikZ';
                }
            } catch (err) {
                console.error('toggleTikzCode error:', err);
            }
        }
    </script>
    <!-- Highlight.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/latex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
    <script>
        // Initialize highlight.js s·∫Ω ƒë∆∞·ª£c g·ªçi trong init ch√≠nh
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/stex/stex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/display/placeholder.min.js"></script>
    <script>
    // H√†m lo·∫°i b·ªè k√Ω t·ª± ƒëi·ªÅu khi·ªÉn (tr·ª´ \n, \t)
    function cleanControlChars(str) {
        return str.replace(/[^\x09\x0A\x20-\x7E\xA0-\uFFFF]/g, '');
    }
    </script>


    <script>
        // Global variables
        // window.isLoggedIn ƒë∆∞·ª£c kh·ªüi t·∫°o t·ª´ window.appState.loggedIn
        window.isLoggedIn = window.appState.loggedIn;
        window.activeFeedbackCount = 0;
        
        // Suppress deprecated DOMNodeInserted warnings silently
        const originalAddEventListener = EventTarget.prototype.addEventListener;
        EventTarget.prototype.addEventListener = function(type, listener, options) {
            if (type === 'DOMNodeInserted' || type === 'DOMNodeRemoved' || type === 'DOMSubtreeModified') {
                // Silently suppress deprecated MutationEvents without logging
                return;
            }
            return originalAddEventListener.call(this, type, listener, options);
        };
        
// Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p t·ª´ backend (kh√¥ng d√πng tr·ª±c ti·∫øp ƒë·ªÉ tr√°nh linter)
// const isLoggedIn = {{ 'true' if user_email else 'false' }};
// G√°n s·ª± ki·ªán cho c√°c n√∫t c·∫ßn ƒëƒÉng nh·∫≠p trong files-section (ƒë√£ g·ªôp v√†o init ch√≠nh)
// ƒê√É G·ªòP V√ÄO INIT CH√çNH: ph·∫ßn d∆∞·ªõi gi·ªØ l·∫°i ƒë·ªÉ t∆∞∆°ng th√≠ch nh∆∞ng kh√¥ng th√™m listener m·ªõi
(function initFilesSectionBindingsOnce() {
  // Logic cho n√∫t "üîó Copy Link" - c·∫ßn ƒëƒÉng nh·∫≠p
  document.querySelectorAll('.files-section .file-copy-link-btn').forEach(function(btn) {
    if (!window.appState.loggedIn) {
      // L∆∞u onclick g·ªëc
      const originalOnclick = btn.getAttribute('onclick');
      btn.setAttribute('data-original-onclick', originalOnclick);
      btn.onclick = function(e) {
        e.preventDefault();
        showLoginModal();
      };
    }
  });
  
  // Logic cho n√∫t "üìù Xem code TikZ" - c·∫ßn ƒëƒÉng nh·∫≠p
  document.querySelectorAll('.files-section .copy-btn[onclick*="toggleTikzCode"]').forEach(function(btn) {
    if (!window.appState.loggedIn) {
      // L∆∞u onclick g·ªëc
      const originalOnclick = btn.getAttribute('onclick');
      btn.setAttribute('data-original-onclick', originalOnclick);
      btn.onclick = function(e) {
        e.preventDefault();
        showLoginModal();
      };
    }
  });
  
  // Logic cho n√∫t "üìã Copy" trong tikz-code-block - c·∫ßn ƒëƒÉng nh·∫≠p
  document.querySelectorAll('.tikz-code-block .copy-btn[onclick*="copyTikzCode"]').forEach(function(btn) {
    if (!window.appState.loggedIn) {
      // L∆∞u onclick g·ªëc
      const originalOnclick = btn.getAttribute('onclick');
      btn.setAttribute('data-original-onclick', originalOnclick);
      btn.onclick = function(e) {
        e.preventDefault();
        showLoginModal();
      };
    }
  });
  
  // Debug: Ki·ªÉm tra c√°c n√∫t c√≥ s·∫µn
  console.log('Ki·ªÉm tra c√°c n√∫t:');
  console.log('View buttons:', document.querySelectorAll('.files-section .view-btn').length);
  console.log('Copy link buttons:', document.querySelectorAll('.files-section .file-copy-link-btn').length);
  console.log('Copy buttons:', document.querySelectorAll('.files-section .copy-btn').length);
  console.log('Toggle TikZ buttons:', document.querySelectorAll('.files-section .copy-btn[onclick*="toggleTikzCode"]').length);
  console.log('Copy TikZ buttons:', document.querySelectorAll('.tikz-code-block .copy-btn[onclick*="copyTikzCode"]').length);
  
  // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p
  updateButtonStates();
  
  // Th√™m s·ª± ki·ªán cho n√∫t bi√™n d·ªãch n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
  const compileBtn = document.getElementById('compile-btn');
  if (compileBtn && !window.appState.loggedIn) {
    compileBtn.addEventListener('click', function(e) {
      e.preventDefault();
      showLoginModal();
    });
  }
  
  // ƒê·∫£m b·∫£o t·∫•t c·∫£ n√∫t "üîó Copy Link" ƒë·ªÅu c√≥ th√¥ng b√°o khi click
  document.querySelectorAll('.files-section .file-copy-link-btn').forEach(function(btn) {
    if (window.appState.loggedIn) {
      // N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p, ƒë·∫£m b·∫£o onclick c√≥ th√¥ng b√°o
      const currentOnclick = btn.getAttribute('onclick');
      if (currentOnclick && currentOnclick.includes('copyToClipboard')) {
        const url = currentOnclick.match(/copyToClipboard\('([^']+)'/)[1];
        btn.onclick = function() {
          copyToClipboard(url, this, 'üîó Copy Link');
        };
      }
    }
  });
  
  // ƒê·∫£m b·∫£o t·∫•t c·∫£ n√∫t "üìù Xem code TikZ" ƒë·ªÅu ho·∫°t ƒë·ªông khi ƒë√£ ƒëƒÉng nh·∫≠p
  document.querySelectorAll('.files-section .copy-btn[onclick*="toggleTikzCode"]').forEach(function(btn) {
    if (window.appState.loggedIn) {
      // N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p, ƒë·∫£m b·∫£o onclick ho·∫°t ƒë·ªông
      btn.onclick = function() {
        toggleTikzCode(this);
      };
    }
  });
  
  // ƒê·∫£m b·∫£o t·∫•t c·∫£ n√∫t "üìã Copy" trong tikz-code-block ƒë·ªÅu ho·∫°t ƒë·ªông khi ƒë√£ ƒëƒÉng nh·∫≠p
  document.querySelectorAll('.tikz-code-block .copy-btn[onclick*="copyTikzCode"]').forEach(function(btn) {
    if (window.appState.loggedIn) {
      // N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p, ƒë·∫£m b·∫£o onclick ho·∫°t ƒë·ªông
      btn.onclick = function() {
        copyTikzCode(this);
      };
    }
  });
})();
function showLoginModal() {
  document.getElementById('login-modal').style.display = 'flex';
}

// H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t sau khi ƒëƒÉng nh·∫≠p
function updateButtonStates() {
  if (window.appState.loggedIn) {
    // N√∫t "üì∏ T·∫£i ·∫£nh PNG/JPEG" ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong ph·∫ßn kh·ªüi t·∫°o CodeMirror
    // Kh√¥ng c·∫ßn x·ª≠ l√Ω ·ªü ƒë√¢y v√¨ event listener g·ªëc ƒë√£ c√≥ ki·ªÉm tra ƒëƒÉng nh·∫≠p
    
    // Kh√¥i ph·ª•c n√∫t "üîó Copy Link" - kh√¥i ph·ª•c onclick g·ªëc
    document.querySelectorAll('.files-section .file-copy-link-btn').forEach(function(btn) {
      const originalOnclick = btn.getAttribute('data-original-onclick');
      if (originalOnclick) {
        // T·∫°o l·∫°i onclick function ƒë·ªÉ ƒë·∫£m b·∫£o th√¥ng b√°o hi·ªÉn th·ªã
        const url = originalOnclick.match(/copyToClipboard\('([^']+)'/)[1];
        btn.onclick = function() {
          copyToClipboard(url, this, 'üîó Copy Link');
        };
        btn.removeAttribute('data-original-onclick');
      }
    });
    
    // Kh√¥i ph·ª•c n√∫t "üìù Xem code TikZ" - KH√îNG C·∫¶N KH√îI PH·ª§C N·ªÆA V√å toggleTikzCode ƒê√É T·ª∞ KI·ªÇM TRA
    // Function toggleTikzCode ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªÉ t·ª± ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
    
    // Kh√¥i ph·ª•c n√∫t "üìã Copy" trong tikz-code-block - KH√îNG C·∫¶N KH√îI PH·ª§C N·ªÆA V√å copyTikzCode ƒê√É T·ª∞ KI·ªÇM TRA
    // Function copyTikzCode ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªÉ t·ª± ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
    
    // Kh√¥i ph·ª•c CodeMirror - x√≥a s·ª± ki·ªán mousedown
    if (window.cm && typeof window.cm.off === 'function') {
      window.cm.off('mousedown');
    }
    
    // Kh√¥i ph·ª•c n√∫t bi√™n d·ªãch - x√≥a s·ª± ki·ªán click
    const compileBtn = document.getElementById('compile-btn');
    if (compileBtn) {
      compileBtn.removeEventListener('click', showLoginModal);
    }
  }
}

// Th√™m s·ª± ki·ªán click cho n√∫t ƒëƒÉng nh·∫≠p Google trong modal s·∫Ω ƒë∆∞·ª£c g·ªçi trong init ch√≠nh
</script>
<script>
// Logout link s·∫Ω ƒë∆∞·ª£c g√°n trong init ch√≠nh
</script>

<!-- Modal nh·∫≠p t·ª´ kh√≥a Bootstrap -->
<div class="modal fade" id="keywordModal" tabindex="-1" aria-labelledby="keywordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="keywordModalLabel">Nh·∫≠p m√¥ t·∫£ / t·ª´ kh√≥a</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- ·∫¢nh SVG preview -->
          <div id="modal-svg-preview">
            <img id="modal-svg-img" src="" alt="SVG Preview">
          </div>
          <p>Nh·∫≠p c√°c t·ª´ kh√≥a, c√°ch nhau b·∫±ng d·∫•u ph·∫©y:</p>
          <div class="position-relative">
            <textarea id="keywordsInput" class="form-control" rows="4" placeholder="V√≠ d·ª•: to√°n h·ªçc, h√¨nh h·ªçc, ƒë·ªì th·ªã"></textarea>
            <div id="keywordSuggestions" 
                 class="list-group position-absolute w-100" 
                 style="z-index:9999; max-height:200px; overflow-y:auto; display:none;"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" class="btn btn-primary" id="confirmKeywordBtn">X√°c nh·∫≠n</button>
        </div>
      </div>
    </div>
  </div>
  

<!-- 
Script n√†y x·ª≠ l√Ω logic l∆∞u file SVG l√™n server v·ªõi m√¥ t·∫£/t·ª´ kh√≥a do ng∆∞·ªùi d√πng nh·∫≠p:

- Bi·∫øn `pendingFileId` v√† `pendingTikzCode` l∆∞u t·∫°m th√¥ng tin file SVG c·∫ßn l∆∞u.
- Khi ng∆∞·ªùi d√πng b·∫•m n√∫t "L∆∞u server" (`save-server-btn`):
    + L·∫•y `file_id` v√† `tikz_code` t·ª´ thu·ªôc t√≠nh c·ªßa n√∫t.
    + Reset √¥ nh·∫≠p t·ª´ kh√≥a trong modal.
    + Hi·ªán modal Bootstrap ƒë·ªÉ ng∆∞·ªùi d√πng nh·∫≠p m√¥ t·∫£/t·ª´ kh√≥a.
- Khi ng∆∞·ªùi d√πng b·∫•m "X√°c nh·∫≠n" trong modal (`confirmKeywordBtn`):
    + L·∫•y t·ª´ kh√≥a ng∆∞·ªùi d√πng nh·∫≠p.
    + Ki·ªÉm tra c√≥ `file_id` ch∆∞a, n·∫øu ch∆∞a th√¨ b√°o l·ªói.
    + G·ª≠i POST request l√™n `/save_svg` v·ªõi `file_id`, `tikz_code`, `keywords`.
    + N·∫øu l∆∞u th√†nh c√¥ng th√¨ b√°o th√†nh c√¥ng v√† reload v·ªÅ trang ch·ªß, n·∫øu l·ªói th√¨ b√°o l·ªói.
    + ƒê√≥ng modal sau khi g·ª≠i request.
-->
<script>
    // Bi·∫øn l∆∞u t·∫°m th√¥ng tin file c·∫ßn l∆∞u (g√°n trong init ch√≠nh)
    function initKeywordModal() {
        const confirmBtn = document.getElementById('confirmKeywordBtn');
        const keywordsInput = document.getElementById('keywordsInput');
        const suggestionsBox = document.getElementById('keywordSuggestions');

        let typingTimeout = null;

        // Kh·ªüi t·∫°o bi·∫øn global cho pending data
        window.pendingFileId = null;
        window.pendingTikzCode = "";

        // Khi g√µ trong √¥ textarea ‚Üí fetch g·ª£i √Ω
        keywordsInput.addEventListener('input', function() {
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                const text = keywordsInput.value.trim();
                const parts = text.split(',');
                const lastPart = parts[parts.length - 1].trim();

                if (lastPart.length < 1) {
                    suggestionsBox.style.display = 'none';
                    return;
                }

                fetch(`/api/keywords/search?q=${encodeURIComponent(lastPart)}`)
                    .then(res => res.json())
                    .then(data => {
                        suggestionsBox.innerHTML = '';
                        if (data.length === 0) {
                            suggestionsBox.style.display = 'none';
                            return;
                        }

                        data.forEach(word => {
                            const item = document.createElement('button');
                            item.type = 'button';
                            item.className = 'list-group-item list-group-item-action';
                            item.textContent = word;
                            item.addEventListener('click', () => {
                                // Thay th·∫ø ph·∫ßn cu·ªëi b·∫±ng t·ª´ ch·ªçn
                                parts[parts.length - 1] = word;
                                keywordsInput.value = parts.map(s => s.trim()).filter(s => s).join(', ') + ', ';
                                suggestionsBox.style.display = 'none';
                                keywordsInput.focus();
                            });
                            suggestionsBox.appendChild(item);
                        });
                        suggestionsBox.style.display = 'block';
                    })
                    .catch(err => {
                        console.error(err);
                        suggestionsBox.style.display = 'none';
                    });
            }, 300);
        });

        // Click ngo√†i suggestion ‚Üí ·∫©n
        document.addEventListener('click', function(event) {
            if (!keywordsInput.contains(event.target) && !suggestionsBox.contains(event.target)) {
                suggestionsBox.style.display = 'none';
            }
        });

        // Khi modal m·ªü ‚Üí load t·∫•t c·∫£ keywords ƒë·ªÉ hi·ªÉn th·ªã suggestions
        const keywordModal = document.getElementById('keywordModal');
        if (keywordModal) {
            keywordModal.addEventListener('shown.bs.modal', function() {
                // Load t·∫•t c·∫£ keywords khi modal m·ªü
                fetch('/api/keywords/search?q=')
                    .then(res => res.json())
                    .then(data => {
                        suggestionsBox.innerHTML = '';
                        if (data.length > 0) {
                            data.forEach(word => {
                                const item = document.createElement('button');
                                item.type = 'button';
                                item.className = 'list-group-item list-group-item-action';
                                item.textContent = word;
                                item.addEventListener('click', () => {
                                    const currentValue = keywordsInput.value.trim();
                                    const newValue = currentValue ? currentValue + ', ' + word : word;
                                    keywordsInput.value = newValue + ', ';
                                    suggestionsBox.style.display = 'none';
                                    keywordsInput.focus();
                                });
                                suggestionsBox.appendChild(item);
                            });
                            suggestionsBox.style.display = 'block';
                        }
                    })
                    .catch(err => {
                        console.error('Error loading keywords:', err);
                    });
            });
        }

        // Khi b·∫•m n√∫t "X√°c nh·∫≠n" trong modal
        if (confirmBtn) {
            confirmBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                const keywords = keywordsInput.value.trim();
                if (!keywords) {
                    alert('Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt t·ª´ kh√≥a!');
                    keywordsInput.focus();
                    return;
                }

                if (!window.pendingFileId) {
                    alert("L·ªói: kh√¥ng c√≥ file_id!");
                    return;
                }

                fetch('/save_svg', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        file_id: window.pendingFileId,
                        tikz_code: window.pendingTikzCode,
                        keywords: keywords
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
                        window.location.href = "/";
                    } else {
                        alert(data.error || "C√≥ l·ªói x·∫£y ra!");
                    }
                })
                .catch(err => {
                    alert("L·ªói m·∫°ng ho·∫∑c server!");
                });

                const modal = bootstrap.Modal.getInstance(document.getElementById('keywordModal'));
                modal.hide();
            });
        }

        // ==== Load files ====
        const filesSection = document.querySelector('.files-section');
        if (filesSection && filesSection.dataset.isOwner === 'true') {
            loadFiles();
            startFilesPolling();
        } else {
            // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p, load public files v√† v·∫´n polling
            loadFiles();
            startFilesPolling();
        }

        // ==== Initialize touch events for buttons ====
        initializeTouchBtnEvents();
        
        // ==== Initialize touch events for all users ====
        // Touch events ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong initializeTouchBtnEvents cho t·∫•t c·∫£ users

        // ==== Initialize CodeMirror ====
        // Ki·ªÉm tra xem CodeMirror ƒë√£ ƒë∆∞·ª£c load ch∆∞a
        if (typeof CodeMirror !== 'undefined') {
            initializeCodeMirror();
        } else {
            // Th·ª≠ l·∫°i sau 1 gi√¢y
            setTimeout(() => {
                if (typeof CodeMirror !== 'undefined') {
                    initializeCodeMirror();
                } else {
                    console.error('‚ùå CodeMirror failed to load');
                }
            }, 1000);
        }
        
        // ==== Initialize action buttons using data-action ====
        // Kh·ªüi t·∫°o cho c·∫£ user ƒë√£ ƒëƒÉng nh·∫≠p v√† ch∆∞a ƒëƒÉng nh·∫≠p
        initializeActionButtons();
        
        // ==== Start login status polling (ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p ƒë·ªãnh k·ª≥) ====
        setInterval(() => {
            refreshLoginStatusAndLoadFiles();
        }, 30000); // Ki·ªÉm tra m·ªói 30 gi√¢y
        
        // ==== Listen for login success events ====
        // Ki·ªÉm tra URL ƒë·ªÉ xem c√≥ ph·∫£i v·ª´a ƒëƒÉng nh·∫≠p th√†nh c√¥ng kh√¥ng
        if (window.location.search.includes('login_success=true')) {
            console.log('üîÑ Login success detected, switching to private files...');
            setTimeout(() => {
                stopFilesPolling();
                refreshLoginStatusAndLoadFiles();
            }, 1000); // Delay 1 gi√¢y ƒë·ªÉ ƒë·∫£m b·∫£o session ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t
        }
        
        // ==== Listen for page visibility changes ====
        // Khi user quay l·∫°i tab, ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                console.log('üîÑ Page became visible, checking login status...');
                refreshLoginStatusAndLoadFiles();
            }
        });
        
        // ==== Listen for focus events ====
        // Khi user focus v√†o window, ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        window.addEventListener('focus', () => {
            console.log('üîÑ Window focused, checking login status...');
            refreshLoginStatusAndLoadFiles();
        });
        
        // ==== Listen for storage events (cross-tab login/logout) ====
        // Khi user ƒëƒÉng nh·∫≠p/ƒëƒÉng xu·∫•t ·ªü tab kh√°c
        window.addEventListener('storage', (e) => {
            if (e.key === 'login_status') {
                console.log('üîÑ Login status changed in another tab, refreshing...');
                stopFilesPolling();
                refreshLoginStatusAndLoadFiles();
            }
        });
        
        // ==== Listen for online/offline events ====
        // Khi k·∫øt n·ªëi m·∫°ng thay ƒë·ªïi, ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        window.addEventListener('online', () => {
            console.log('üîÑ Network online, checking login status...');
            stopFilesPolling();
            refreshLoginStatusAndLoadFiles();
        });
        
        // ==== Listen for beforeunload events ====
        // Khi user s·∫Øp r·ªùi kh·ªèi trang, l∆∞u tr·∫°ng th√°i
        window.addEventListener('beforeunload', () => {
            localStorage.setItem('login_status', window.isLoggedIn ? 'logged_in' : 'logged_out');
        });
        
        // ==== Check stored login status on page load ====
        // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p ƒë√£ l∆∞u
        const storedLoginStatus = localStorage.getItem('login_status');
        if (storedLoginStatus && storedLoginStatus !== (window.isLoggedIn ? 'logged_in' : 'logged_out')) {
            console.log('üîÑ Stored login status differs from current, refreshing...');
            stopFilesPolling();
            refreshLoginStatusAndLoadFiles();
        }
        
        // ==== Initialize login status in localStorage ====
        // Kh·ªüi t·∫°o tr·∫°ng th√°i ƒëƒÉng nh·∫≠p trong localStorage
        localStorage.setItem('login_status', window.isLoggedIn ? 'logged_in' : 'logged_out');
        
        // ==== Log initial state ====
        console.log('üîÑ Initial login status:', window.isLoggedIn ? 'Logged in' : 'Not logged in');
        console.log('üîÑ Loading files for:', window.isLoggedIn ? 'logged in user' : 'public access');
        console.log('üîÑ Polling will be active for both logged in and public users');
    }

    // Refresh login status and load files if needed
    function refreshLoginStatusAndLoadFiles() {
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒëƒÉng nh·∫≠p t·ª´ server
        fetch('/api/check_login_status')
            .then(response => response.json())
            .then(data => {
                const wasLoggedIn = window.isLoggedIn;
                window.isLoggedIn = data.logged_in;
                
                // C·∫≠p nh·∫≠t localStorage
                localStorage.setItem('login_status', window.isLoggedIn ? 'logged_in' : 'logged_out');
                
                // N·∫øu tr·∫°ng th√°i ƒëƒÉng nh·∫≠p thay ƒë·ªïi, load files v√† restart polling
                if (!wasLoggedIn && window.isLoggedIn) {
                    console.log('üîÑ User logged in, switching to private files...');
                    stopFilesPolling();
                    loadFiles(true); // Force load khi user v·ª´a ƒëƒÉng nh·∫≠p
                    startFilesPolling();
                } else if (wasLoggedIn && !window.isLoggedIn) {
                    console.log('üîÑ User logged out, switching to public files...');
                    stopFilesPolling();
                    loadFiles(true); // Force load khi user v·ª´a ƒëƒÉng xu·∫•t
                    startFilesPolling();
                }
            })
            .catch(error => {
                console.error('Error checking login status:', error);
            });
    }

    // Load files from API
    function loadFiles(forceLoad = false) {
        console.log('üîÑ loadFiles called...', forceLoad ? '(forced)' : '');
        const container = document.getElementById('files-container');
        console.log('üîÑ Container found:', !!container);
        
        // Ki·ªÉm tra flag to√†n c·ª•c
        if (window.activeFeedbackCount > 0) {
            return;
        }
        
        // Ch·ªçn API endpoint d·ª±a tr√™n tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        const apiEndpoint = window.isLoggedIn ? '/api/files' : '/api/public/files';
        console.log('üîÑ Using API endpoint:', apiEndpoint);
        
        fetch(apiEndpoint)
            .then(response => {
                console.log('üîÑ Response status:', response.status);
                if (!response.ok) {
                    // N·∫øu ƒë√£ ki·ªÉm tra ƒëƒÉng nh·∫≠p tr∆∞·ªõc ƒë√≥, 401 kh√¥ng n√™n x·∫£y ra
                    // Nh∆∞ng v·∫´n x·ª≠ l√Ω ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n
                    if (response.status === 401) {
                        console.log('üîÑ Unexpected 401 response, user session may have expired');
                        container.innerHTML = `
                            <div class="no-files">
                                <div class="no-files-icon">üîí</div>
                                <h4>Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n</h4>
                                <p>Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i ƒë·ªÉ xem files ƒë√£ l∆∞u</p>
                            </div>
                        `;
                        return Promise.reject('Unauthorized'); // Prevent further processing
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // X·ª≠ l√Ω response format kh√°c nhau gi·ªØa /api/files v√† /api/public/files
                const files = window.isLoggedIn ? data : (data.files || []);
                return files;
            })
            .then(files => {
                if (!files) return;
                
                if (files.length === 0) {
                    const noFilesMessage = window.isLoggedIn 
                        ? 'H√£y t·∫°o v√† l∆∞u m·ªôt s·ªë file SVG ƒë·ªÉ xem ch√∫ng ·ªü ƒë√¢y'
                        : 'Hi·ªán t·∫°i ch∆∞a c√≥ file SVG n√†o ƒë∆∞·ª£c chia s·∫ª c√¥ng khai';
                    
                    container.innerHTML = `
                        <div class="no-files">
                            <div class="no-files-icon">üìÅ</div>
                            <h4>Ch∆∞a c√≥ file n√†o</h4>
                            <p>${noFilesMessage}</p>
                        </div>
                    `;
                    return;
                }
                
                // Render files
                const filesHTML = files.map(file => `
                    <div class="file-card" data-file-id="${file.id}">
                      <button class="action-toggle-btn" type="button" aria-label="Hi·ªán menu h√†nh ƒë·ªông">‚ãØ</button>
                      <div class="file-info">
                        <div class="file-creator" style="margin-bottom: 0; font-size: 12px;">
                          üë§ <a href="/profile/${file.creator_id}/svg-files" style="text-decoration: none; color: #1976d2; font-weight: 700; font-size: 13px;">
                            ${file.creator_username}
                          </a>
                          <span style="margin-left:8px; color: #666; font-size: 11px;">${file.created_time_vn || file.created_time}</span>
                        </div>
                      </div>
                      <div class="file-img-container">
                        <img src="${file.url}" alt="${file.filename}">
                        <div class="like-button-wrapper">
                          <div class="like-button">
                            <input id="heart-${file.id}" type="checkbox" ${file.is_liked_by_current_user ? 'checked' : ''} ${!window.isLoggedIn ? 'disabled' : ''} />
                            <label class="like" for="heart-${file.id}" ${!window.isLoggedIn ? 'style="opacity: 0.6; cursor: not-allowed;"' : ''}>
                              <svg class="like-icon" fill-rule="nonzero" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z"></path>
                              </svg>
                              <span class="like-text">Likes</span>
                            </label>
                            <span class="like-count one">${file.like_count}</span>
                            <span class="like-count two">${file.like_count}</span>
                          </div>
                        </div>
                      </div>
                      <div class="file-action-container">
                        <ul class="file-action-list">
                          <li class="file-action-item">
                            <button type="button" class="Btn" data-action="download-image" data-filename="${file.filename}">
                              <div class="sign">
                                <i class="fas fa-image logoIcon"></i>
                              </div>
                              <div class="text">T·∫£i ·∫£nh</div>
                            </button>
                          </li>
                         <li class="file-action-item">
                            <button type="button" class="Btn" data-action="share-facebook" data-filename="${file.filename}" data-has-feedback="true">
                              <div class="sign">
                                <i class="fab fa-facebook logoIcon"></i>
                              </div>
                              <div class="text">Facebook</div>
                            </button>
                          </li>
                          <li class="file-action-item">
                            <button type="button" class="Btn" data-action="copy-link" data-url="/static/${file.filename}" data-has-feedback="true">
                              <div class="sign">
                                <i class="fas fa-link logoIcon"></i>
                              </div>
                              <div class="text">Copy Link</div>
                            </button>
                          </li>
                          ${file.tikz_code ? `
                          <li class="file-action-item">
                            <button type="button" class="Btn" data-action="toggle-code">
                              <div class="sign">
                                <i class="fas fa-code logoIcon"></i>
                              </div>
                              <div class="text">Xem Code</div>
                            </button>
                          </li>
                          ` : ''}

                        </ul>
                      </div>
                      
                      <!-- TikZ Code Section -->
                      ${file.tikz_code ? `
                      <div class="tikz-code-block" style="display:none; margin-top:10px;">
                        <div class="tikz-code-header">
                          <span>Code TikZ:</span>
                          <button class="copy-btn" onclick="copyTikzCode(this)">üìã Copy</button>
                        </div>
                        <div class="code-block">
                          <textarea class="tikz-cm" readonly>${file.tikz_code}</textarea>
                        </div>
                      </div>
                      ` : ''}
                    </div>
                `).join('');
                
                container.innerHTML = filesHTML;
                
                // Initialize like buttons for files (ch·ªâ khi ƒë√£ ƒëƒÉng nh·∫≠p)
                if (window.isLoggedIn) {
                    initializeFileLikeButtons();
                }
                
                // C·∫≠p nh·∫≠t currentFiles cho polling
                currentFiles = files;
                console.log('üîÑ Updated currentFiles for polling:', currentFiles.length, 'files');
                
                // Note: Event delegation ƒë√£ ƒë∆∞·ª£c setup trong DOMContentLoaded, 
                // n√™n kh√¥ng c·∫ßn re-initialize cho c√°c element m·ªõi ƒë∆∞·ª£c th√™m v√†o
            })
            .catch(error => {
                console.error('Error loading files:', error);
                
                // N·∫øu ƒë√£ x·ª≠ l√Ω 401 trong .then(), kh√¥ng hi·ªÉn th·ªã l·∫°i
                if (error === 'Unauthorized') {
                    return;
                }
                
                // N·∫øu force load v√† c√≥ l·ªói, c√≥ th·ªÉ user ch∆∞a ƒëƒÉng nh·∫≠p th·ª±c s·ª±
                if (forceLoad) {
                    console.log('üîÑ Force load failed, checking login status...');
                    refreshLoginStatusAndLoadFiles();
                    return;
                }
                
                // Th√¥ng b√°o l·ªói kh√°c nhau cho user ƒë√£ ƒëƒÉng nh·∫≠p v√† ch∆∞a ƒëƒÉng nh·∫≠p
                const errorMessage = window.isLoggedIn 
                    ? 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch files c·ªßa b·∫°n. Vui l√≤ng th·ª≠ l·∫°i sau.'
                    : 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch files c√¥ng khai. Vui l√≤ng th·ª≠ l·∫°i sau.';
                
                container.innerHTML = `
                    <div class="no-files">
                        <div class="no-files-icon">‚ùå</div>
                        <h4>Kh√¥ng th·ªÉ t·∫£i danh s√°ch files</h4>
                        <p>${errorMessage}</p>
                    </div>
                `;
            });
    }

    // Initialize like buttons for files
    function initializeFileLikeButtons() {
        // Ch·ªâ kh·ªüi t·∫°o like buttons n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p
        if (!window.isLoggedIn) {
            return;
        }
        
        // Initialize like buttons
        document.querySelectorAll('input[id^="heart-"]').forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                const fileId = this.id.replace('heart-', '');
                const isLiked = this.checked;
                const likeButton = this.closest('.like-button');
                const currentNumber = likeButton.querySelector('.like-count.one');
                const moveNumber = likeButton.querySelector('.like-count.two');
                
                // Prevent double click
                this.disabled = true;
                
                // Send AJAX request to backend
                fetch('/like_svg', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        svg_id: fileId,
                        action: isLiked ? 'like' : 'unlike'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update UI with new like count
                        const newCount = data.like_count;
                        currentNumber.textContent = newCount;
                        moveNumber.textContent = newCount;
                        
                        // Update checkbox state based on server response
                        this.checked = data.is_liked;
                        
                        console.log(`‚úÖ File ${data.message}: ${newCount} likes`);
                    } else {
                        // Revert UI if backend failed
                        this.checked = !isLiked;
                        console.log(`‚ùå File ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Revert UI on error
                    this.checked = !isLiked;
                    alert('C√≥ l·ªói k·∫øt n·ªëi!');
                })
                .finally(() => {
                    this.disabled = false;
                });
            });
        });
    }

    // Global variable to store current files for polling comparison
    let currentFiles = [];
    let pollingInterval = null;
    
    // Real-time synchronization for files via polling
    function startFilesPolling() {
        console.log('üîÑ Starting files polling...');
        const pollInterval = 15000; // 15 seconds
        
        pollingInterval = setInterval(function() {
            console.log('üîÑ Polling files...', new Date().toLocaleTimeString());
            const container = document.getElementById('files-container');
            if (!container) {
                console.log('‚ùå Container not found, stopping polling');
                return;
            }
            
            // Ki·ªÉm tra flag to√†n c·ª•c
            if (window.activeFeedbackCount > 0) {
                return;
            }
            
            // Ch·ªçn API endpoint d·ª±a tr√™n tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
            const apiEndpoint = window.isLoggedIn ? '/api/files' : '/api/public/files';
            console.log('üîÑ Polling API endpoint:', apiEndpoint);
            
            // Fetch updated files
            fetch(apiEndpoint)
                .then(response => {
                    console.log('üîÑ API response status:', response.status);
                    if (!response.ok) {
                        if (response.status === 401) {
                            console.log('‚ùå User not logged in, switching to public API');
                            // Th·ª≠ l·∫°i v·ªõi public API
                            return fetch('/api/public/files');
                        }
                        throw new Error('Network response was not ok');
                    }
                    return response;
                })
                .then(response => {
                    if (!response) return null;
                    return response.json();
                })
                .then(data => {
                    if (!data) return;
                    
                    // X·ª≠ l√Ω response format kh√°c nhau
                    const files = window.isLoggedIn ? data : (data.files || []);
                    
                    // Check if there are new files or updates
                    const hasNewFiles = files.length !== currentFiles.length;
                    const hasUpdates = files.some((file, index) => {
                        const currentFile = currentFiles[index];
                        return !currentFile || 
                               currentFile.like_count !== file.like_count ||
                               (window.isLoggedIn && currentFile.is_liked_by_current_user !== file.is_liked_by_current_user);
                    });
                    
                    if (hasNewFiles || hasUpdates) {
                        console.log('üîÑ Files updated, refreshing...');
                        loadFiles();
                    }
                })
                .catch(error => {
                    console.error('Files polling error:', error);
                });
        }, pollInterval);
        
        console.log('üîÑ Started files polling (15s interval)');
    }
    
    // Function to stop polling
    function stopFilesPolling() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
            console.log('üîÑ Stopped files polling');
        }
    }

    // Touch events for buttons (2-tap logic)
    function initializeTouchBtnEvents() {
        if (!document.documentElement.classList.contains('is-touch')) return;

        const originalHandlers = new Map();

        // S·ª≠ d·ª•ng event delegation thay v√¨ g·∫Øn tr·ª±c ti·∫øp
        document.addEventListener('click', function(e) {
            // ==== X·ª≠ l√Ω action-toggle-btn (n√∫t ...) ====
            const actionToggleBtn = e.target.closest('.action-toggle-btn');
            if (actionToggleBtn) {
                const card = actionToggleBtn.closest('.file-card');
                if (card) {
                    // ƒê√≥ng t·∫•t c·∫£ card kh√°c
                    document.querySelectorAll('.file-card.active').forEach(other => {
                        if (other !== card) other.classList.remove('active');
                    });
                    // Toggle card hi·ªán t·∫°i
                    card.classList.toggle('active');
                }
                return;
            }
            
            // ==== X·ª≠ l√Ω c√°c n√∫t .Btn ====
            const btn = e.target.closest('.Btn');
            if (!btn) return;
            
            // X·ª≠ l√Ω c√°c n√∫t .Btn trong card c√≥ class active
            if (btn.classList.contains('Btn')) {
                const card = btn.closest('.file-card');
                if (!card || !card.classList.contains('active')) return;

                // L·∫•y ho·∫∑c t·∫°o tapCount
                if (!btn.dataset.tapCount) btn.dataset.tapCount = '0';
                
                const currentTapCount = parseInt(btn.dataset.tapCount);
                
                if (currentTapCount === 0) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();

                    // Reset c√°c n√∫t kh√°c
                    card.querySelectorAll('.Btn').forEach(otherBtn => {
                        if (otherBtn !== btn) {
                            otherBtn.classList.remove('individual-active', 'ready-to-execute');
                            otherBtn.dataset.tapCount = '0';
                        }
                    });

                    btn.classList.add('individual-active', 'ready-to-execute');
                    btn.dataset.tapCount = '1';

                    // Auto reset sau 5s
                    setTimeout(() => {
                        if (btn.dataset.tapCount === '1') {
                            btn.classList.remove('individual-active', 'ready-to-execute');
                            btn.dataset.tapCount = '0';
                        }
                    }, 5000);
                    
                    return false;
                } 
                else if (currentTapCount === 1) {
                    // TAP 2: Execute action
                    
                    // L·∫•y onclick handler
                    let originalHandler;
                    const onclickAttr = btn.getAttribute('onclick');
                    if (onclickAttr) {
                        originalHandler = new Function(onclickAttr);
                    } else if (originalHandlers.has(btn)) {
                        originalHandler = originalHandlers.get(btn);
                    }

                    if (originalHandler) {
                        try {
                            originalHandler.call(btn, e);
                        } catch (error) {
                            console.error('Error executing handler:', error);
                        }
                    }

                    // Execute based on data-action attribute
                    const action = btn.dataset.action;
                    
                    if (!action) {
                        // Fallback for buttons without data-action
                        setTimeout(() => {
                            btn.dataset.tapCount = '0';
                            btn.classList.remove('individual-active', 'ready-to-execute');
                        }, 1000);
                        return;
                    }

                    // Prevent default behavior
                    e.preventDefault();
                    e.stopPropagation();
                    if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();

                    switch (action) {
                        case 'share-facebook':
                            const filename = btn.getAttribute('data-filename');
                            const shareUrl = `${window.location.origin}/view_svg/${filename}`;
                            copyToClipboardWithCustomFeedback(shareUrl, btn, 'Facebook', 'ƒê√£ copy!');
                            setTimeout(() => {
                                btn.dataset.tapCount = '0';
                                btn.classList.remove('individual-active', 'ready-to-execute');
                            }, 2000);
                            break;
                            
                        case 'copy-link':
                            const url = btn.getAttribute('data-url');
                            // Create full URL for copy link functionality
                            const fullUrl = `${window.location.origin}${url}`;
                            copyToClipboard(fullUrl, btn, 'Copy Link', 'ƒê√£ copy!');
                            setTimeout(() => {
                                btn.dataset.tapCount = '0';
                                btn.classList.remove('individual-active', 'ready-to-execute');
                            }, 2000);
                            break;
                            
                        case 'download-image':
                            const downloadFilename = btn.getAttribute('data-filename');
                            if (downloadFilename) window.location.href = `/view_svg/${downloadFilename}`;
                            btn.dataset.tapCount = '0';
                            btn.classList.remove('individual-active', 'ready-to-execute');
                            break;
                            
                        case 'toggle-code':
                            // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
                            if (window.isLoggedIn) {
                                toggleTikzCode(btn);
                            } else {
                                // Hi·ªÉn th·ªã modal ƒëƒÉng nh·∫≠p cho user ch∆∞a ƒëƒÉng nh·∫≠p
                                const loginModal = document.getElementById('login-modal');
                                if (loginModal) {
                                    loginModal.style.display = 'flex';
                                } else {
                                    // Fallback: redirect to login
                                    window.location.href = '/login/google';
                                }
                            }
                            setTimeout(() => {
                                btn.dataset.tapCount = '0';
                                btn.classList.remove('individual-active', 'ready-to-execute');
                            }, 1000);
                            break;
                            
                        default:
                            // Unknown action, reset after 1 second
                            setTimeout(() => {
                                btn.dataset.tapCount = '0';
                                btn.classList.remove('individual-active', 'ready-to-execute');
                            }, 1000);
                            break;
                    }
                    
                    return false;
                }
            }
        }, true); // Capture phase
    }

    // Function x·ª≠ l√Ω touch events ƒë∆°n gi·∫£n cho tr∆∞·ªùng h·ª£p ch∆∞a ƒëƒÉng nh·∫≠p
    // ƒê√£ ƒë∆∞·ª£c g·ªôp v√†o initializeTouchBtnEvents ƒë·ªÉ x·ª≠ l√Ω cho t·∫•t c·∫£ users

    // Copy to clipboard functions
    function copyToClipboard(url, btn, originalText = 'Copy Link', feedbackText = 'ƒê√£ copy!') {
        const card = btn.closest('.file-card');
        const actionContainer = card ? card.querySelector('.file-action-container') : null;
        
        // Ki·ªÉm tra xem c√≥ ph·∫£i HTTPS ho·∫∑c localhost kh√¥ng
        const isSecureContext = window.isSecureContext || window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        // Th·ª≠ s·ª≠ d·ª•ng navigator.clipboard tr∆∞·ªõc (ch·ªâ khi c√≥ quy·ªÅn)
        if (navigator.clipboard && isSecureContext) {
            navigator.clipboard.writeText(url).then(function() {
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = feedbackText;
                    window.activeFeedbackCount++; // TƒÉng counter
                    setTimeout(() => { 
                        textDiv.textContent = originalText; 
                        window.activeFeedbackCount--; // Gi·∫£m counter
                    }, 3000);
                }
            }).catch(function(err) {
                console.error('‚ùå Clipboard API failed:', err);
                console.log('üîÑ Falling back to execCommand method');
                // Fallback to execCommand
                fallbackCopyToClipboard(url, btn, originalText, feedbackText);
            });
        } else {
            // Fallback cho c√°c tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Clipboard API ho·∫∑c kh√¥ng c√≥ quy·ªÅn
            console.log('üîÑ Using fallback copy method (no clipboard permission)');
            fallbackCopyToClipboard(url, btn, originalText, feedbackText);
        }
    }

    function fallbackCopyToClipboard(url, btn, originalText = 'Copy Link', feedbackText = 'ƒê√£ copy!') {
        console.log('üîÑ Executing fallback copy method for URL:', url);
        
        const textArea = document.createElement('textarea');
        textArea.value = url;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        
        try {
            textArea.focus();
            textArea.select();
            console.log('üîÑ Text selected, attempting to copy...');
            
            const successful = document.execCommand('copy');
            console.log('üîÑ execCommand result:', successful);
            
            if (successful) {
                console.log('‚úÖ Fallback copy successful');
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = feedbackText;
                    window.activeFeedbackCount++; // TƒÉng counter
                    setTimeout(() => { 
                        textDiv.textContent = originalText; 
                        window.activeFeedbackCount--; // Gi·∫£m counter
                    }, 3000);
                }
            } else {
                console.error('‚ùå execCommand copy failed');
                // Th·ª≠ hi·ªÉn th·ªã feedback ngay c·∫£ khi copy th·∫•t b·∫°i
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = 'Copy th·∫•t b·∫°i';
                    setTimeout(() => { 
                        textDiv.textContent = 'Copy Link'; 
                    }, 3000);
                }
                alert('Kh√¥ng th·ªÉ copy link. Vui l√≤ng copy th·ªß c√¥ng: ' + url);
            }
        } catch (err) {
            console.error('‚ùå execCommand copy error:', err);
            // Th·ª≠ hi·ªÉn th·ªã feedback ngay c·∫£ khi c√≥ l·ªói
            const textDiv = btn.querySelector('.text');
            if (textDiv) {
                textDiv.textContent = 'Copy th·∫•t b·∫°i';
                setTimeout(() => { 
                    textDiv.textContent = 'Copy Link'; 
                }, 3000);
            }
            alert('Kh√¥ng th·ªÉ copy link. Vui l√≤ng copy th·ªß c√¥ng: ' + url);
        } finally {
            // Lu√¥n cleanup textarea
            if (document.body.contains(textArea)) {
                document.body.removeChild(textArea);
            }
        }
    }

    function copyToClipboardWithCustomFeedback(url, btn, originalText, feedbackText) {
        const card = btn.closest('.file-card');
        const actionContainer = card ? card.querySelector('.file-action-container') : null;
        
        // Ki·ªÉm tra xem c√≥ ph·∫£i HTTPS ho·∫∑c localhost kh√¥ng
        const isSecureContext = window.isSecureContext || window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        // Th·ª≠ s·ª≠ d·ª•ng navigator.clipboard tr∆∞·ªõc (ch·ªâ khi c√≥ quy·ªÅn)
        if (navigator.clipboard && isSecureContext) {
            navigator.clipboard.writeText(url).then(function() {
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = feedbackText;
                    window.activeFeedbackCount++; // TƒÉng counter
                    
                    setTimeout(() => { 
                        textDiv.textContent = originalText; 
                        window.activeFeedbackCount--; // Gi·∫£m counter
                    }, 3000);
                }
            }).catch(function(err) {
                console.error('‚ùå Clipboard API failed (custom feedback):', err);
                // Fallback to execCommand
                fallbackCopyToClipboardWithCustomFeedback(url, btn, originalText, feedbackText);
            });
        } else {
            // Fallback cho c√°c tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Clipboard API ho·∫∑c kh√¥ng c√≥ quy·ªÅn
            console.log('üîÑ Using fallback copy method with custom feedback (no clipboard permission)');
            fallbackCopyToClipboardWithCustomFeedback(url, btn, originalText, feedbackText);
        }
    }

    function fallbackCopyToClipboardWithCustomFeedback(url, btn, originalText, feedbackText) {
        const textArea = document.createElement('textarea');
        textArea.value = url;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            
            if (successful) {
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = feedbackText;
                    window.activeFeedbackCount++; // TƒÉng counter
                    
                    setTimeout(() => { 
                        textDiv.textContent = originalText; 
                        window.activeFeedbackCount--; // Gi·∫£m counter
                    }, 3000);
                }
            } else {
                console.error('‚ùå execCommand copy failed (custom feedback)');
                // Th·ª≠ hi·ªÉn th·ªã feedback ngay c·∫£ khi copy th·∫•t b·∫°i
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = 'Copy th·∫•t b·∫°i';
                    setTimeout(() => { 
                        textDiv.textContent = originalText; 
                    }, 3000);
                }
                alert('Kh√¥ng th·ªÉ copy link. Vui l√≤ng copy th·ªß c√¥ng: ' + url);
            }
        } catch (err) {
            console.error('‚ùå execCommand copy error (custom feedback):', err);
            // Th·ª≠ hi·ªÉn th·ªã feedback ngay c·∫£ khi c√≥ l·ªói
            const textDiv = btn.querySelector('.text');
            if (textDiv) {
                textDiv.textContent = 'Copy th·∫•t b·∫°i';
                setTimeout(() => { 
                    textDiv.textContent = originalText; 
                }, 3000);
            }
            alert('Kh√¥ng th·ªÉ copy link. Vui l√≤ng copy th·ªß c√¥ng: ' + url);
        }
        
        document.body.removeChild(textArea);
    }

    // Toggle TikZ code function
    function toggleTikzCode(btn) {
        console.log('üîç toggleTikzCode function called');
        console.log('üîç btn:', btn);
        
        // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi hi·ªÉn th·ªã code
        if (!window.appState.loggedIn) {
            console.log('üîç User not logged in, showing login modal');
            const loginModal = document.getElementById('login-modal');
            if (loginModal) {
                loginModal.style.display = 'flex';
            } else {
                window.location.href = '/login/google';
            }
            return;
        }
        
        const card = btn.closest('.file-card');
        const codeBlock = card.querySelector('.tikz-code-block');
        const textDiv = btn.querySelector('.text');
        
        console.log('üîç card:', card);
        console.log('üîç codeBlock:', codeBlock);
        console.log('üîç textDiv:', textDiv);
        
        if (codeBlock.style.display === 'none' || !codeBlock.style.display) {
            codeBlock.style.display = 'block';
            textDiv.textContent = '·∫®n code';
            
            // Initialize CodeMirror when showing the code block
            setTimeout(() => {
                const textarea = codeBlock.querySelector('.tikz-cm');
                
                if (textarea && !textarea.CodeMirror) {
                    const existingCm = codeBlock.querySelector('.CodeMirror');
                    if (existingCm) {
                        existingCm.remove();
                    }
                    
                    if (typeof CodeMirror !== 'undefined') {
                        try {
                            const cmInstance = CodeMirror.fromTextArea(textarea, {
                                mode: 'stex',
                                theme: 'material',
                                lineNumbers: true,
                                readOnly: true,
                                lineWrapping: true,
                                foldGutter: true,
                                gutters: ['CodeMirror-linenumbers'],
                                viewportMargin: Infinity
                            });
                            
                            // Refresh CodeMirror after a short delay
                            setTimeout(() => {
                                cmInstance.refresh();
                            }, 100);
                        } catch (error) {
                            console.error('‚ùå Error creating CodeMirror instance:', error);
                        }
                    } else {
                        console.error('‚ùå CodeMirror is not defined!');
                    }
                }
            }, 50);
        } else {
            codeBlock.style.display = 'none';
            textDiv.textContent = 'Xem Code';
        }
    }

    // Copy TikZ code function
    function copyTikzCode(btn) {
        // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi copy code
        if (!window.appState.loggedIn) {
            console.log('üîç User not logged in, showing login modal');
            const loginModal = document.getElementById('login-modal');
            if (loginModal) {
                loginModal.style.display = 'flex';
            } else {
                window.location.href = '/login/google';
            }
            return;
        }
        
        const card = btn.closest('.file-card');
        const textarea = card.querySelector('.tikz-cm');
        
        // L·∫•y code t·ª´ CodeMirror instance n·∫øu c√≥, n·∫øu kh√¥ng th√¨ t·ª´ textarea g·ªëc
        let code = textarea.value;
        
        // ∆Øu ti√™n l·∫•y t·ª´ CodeMirror instance
        if (textarea.CodeMirror) {
            code = textarea.CodeMirror.getValue();
            console.log('Getting code from CodeMirror instance');
        } else {
            console.log('Getting code from original textarea');
        }
        
        // Ki·ªÉm tra xem c√≥ ph·∫£i HTTPS ho·∫∑c localhost kh√¥ng
        const isSecureContext = window.isSecureContext || window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        if (navigator.clipboard && isSecureContext) {
            navigator.clipboard.writeText(code).then(function() {
                btn.textContent = 'ƒê√£ copy!';
                setTimeout(() => { 
                    btn.textContent = 'üìã Copy'; 
                }, 2000);
            }).catch(function(err) {
                console.error('‚ùå Clipboard API failed:', err);
                fallbackCopyTikzCode(code, btn);
            });
        } else {
            console.log('üîÑ Using fallback copy method for TikZ code (no clipboard permission)');
            fallbackCopyTikzCode(code, btn);
        }
    }

    function fallbackCopyTikzCode(code, btn) {
        const textArea = document.createElement('textarea');
        textArea.value = code;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                btn.textContent = 'ƒê√£ copy!';
                setTimeout(() => { 
                    btn.textContent = 'üìã Copy'; 
                }, 2000);
            } else {
                alert('Kh√¥ng th·ªÉ copy code. Vui l√≤ng copy th·ªß c√¥ng.');
            }
        } catch (err) {
            console.error('‚ùå execCommand copy error:', err);
            alert('Kh√¥ng th·ªÉ copy code. Vui l√≤ng copy th·ªß c√¥ng.');
        }
        
        document.body.removeChild(textArea);
    }

    // Initialize CodeMirror for TikZ code blocks
    function initializeCodeMirror() {
        document.querySelectorAll('.tikz-cm').forEach(function(textarea) {
            if (!textarea.CodeMirror) {
                const codeBlock = textarea.closest('.tikz-code-block');
                if (codeBlock) {
                    const existingCm = codeBlock.querySelector('.CodeMirror');
                    if (existingCm) {
                        existingCm.remove();
                    }
                    
                    if (typeof CodeMirror !== 'undefined') {
                        try {
                            const cmInstance = CodeMirror.fromTextArea(textarea, {
                                mode: 'stex',
                                theme: 'material',
                                lineNumbers: true,
                                readOnly: true,
                                lineWrapping: true,
                                foldGutter: true,
                                gutters: ['CodeMirror-linenumbers'],
                                viewportMargin: Infinity
                            });
                            
                            // Refresh CodeMirror after a short delay
                            setTimeout(() => {
                                cmInstance.refresh();
                            }, 100);
                        } catch (error) {
                            console.error('‚ùå Error creating CodeMirror instance:', error);
                        }
                    } else {
                        console.error('‚ùå CodeMirror is not defined!');
                    }
                }
            } else {
                const cmInstance = textarea.CodeMirror;
                setTimeout(() => {
                    cmInstance.refresh();
                }, 100);
            }
        });
    }

    // Function to initialize action buttons using data-action
    function initializeActionButtons() {
        // Handle all action buttons using data-action
        document.addEventListener('click', function(e) {
            const btn = e.target.closest('.Btn[data-action]');
            if (!btn) return;
            
            e.preventDefault();
            const action = btn.dataset.action;
            
            switch (action) {
                case 'share-facebook':
                    const filename = btn.getAttribute('data-filename');
                    const shareUrl = `${window.location.origin}/view_svg/${filename}`;
                    copyToClipboardWithCustomFeedback(shareUrl, btn, 'Facebook', 'ƒê√£ copy!');
                    break;
                    
                case 'copy-link':
                    const url = btn.getAttribute('data-url');
                    // Create full URL for copy link functionality
                    const fullUrl = `${window.location.origin}${url}`;
                    copyToClipboard(fullUrl, btn, 'Copy Link', 'ƒê√£ copy!');
                    break;
                    
                case 'download-image':
                    const downloadFilename = btn.getAttribute('data-filename');
                    window.location.href = `/view_svg/${downloadFilename}`;
                    break;
                    
                case 'toggle-code':
                    toggleTikzCode(btn);
                    break;
            }
        });
    }

    // Re-initialize buttons after a short delay to ensure DOM is ready
    setTimeout(function() {
        initializeActionButtons();
    }, 100);

    // ƒê√≥ng menu khi click b√™n ngo√†i
    document.addEventListener('click', function (e) {
        const activeCard = document.querySelector('.file-card.active');
        if (activeCard) {
            if (activeCard.dataset.preventClose === 'true') {
                return;
            }
            
            if (!activeCard.contains(e.target) && !e.target.closest('.Btn') && !e.target.closest('.action-toggle-btn')) {
                activeCard.classList.remove('active');
            }
        }
    });

    // ========== SEARCH FUNCTIONALITY ==========
    function initializeSearch() {
        const searchInput = document.getElementById('main-search-input');
        const suggestionsBox = document.getElementById('search-suggestions');
        
        if (!searchInput || !suggestionsBox) return;
        
        let typingTimeout = null;
        
        // Handle input changes
        searchInput.addEventListener('input', function() {
            clearTimeout(typingTimeout);
            const query = this.value.trim();
            
            if (query.length < 1) {
                suggestionsBox.style.display = 'none';
                return;
            }
            
            typingTimeout = setTimeout(() => {
                fetch(`/api/keywords/search?q=${encodeURIComponent(query)}`)
                    .then(res => res.json())
                    .then(data => {
                        suggestionsBox.innerHTML = '';
                        
                        if (data.length === 0) {
                            suggestionsBox.style.display = 'none';
                            return;
                        }
                        
                        data.forEach(keyword => {
                            const item = document.createElement('div');
                            item.className = 'search-suggestion-item';
                            item.textContent = keyword;
                            item.addEventListener('click', () => {
                                searchInput.value = keyword;
                                suggestionsBox.style.display = 'none';
                                // Navigate to search results page
                                window.location.href = `/search?q=${encodeURIComponent(keyword)}`;
                            });
                            suggestionsBox.appendChild(item);
                        });
                        
                        suggestionsBox.style.display = 'block';
                    })
                    .catch(err => {
                        console.error('Search error:', err);
                        suggestionsBox.style.display = 'none';
                    });
            }, 300);
        });
        
        // Handle Enter key
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const query = this.value.trim();
                if (query) {
                    suggestionsBox.style.display = 'none';
                    window.location.href = `/search?q=${encodeURIComponent(query)}`;
                }
            }
        });
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
                suggestionsBox.style.display = 'none';
            }
        });
    }
    
    // ========== MAIN INITIALIZER: G·ªôp t·∫•t c·∫£ DOMContentLoaded v√†o ƒë√¢y ==========
    document.addEventListener('DOMContentLoaded', function() {
        // 1) Touch device detection
        if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
            document.documentElement.classList.add('is-touch');
        }

        // 2) Load SVG files
        loadSvgFiles();

        // 3) Mobile menu
        const menuToggle = document.getElementById('menu-toggle');
        const mobileMenu = document.getElementById('mobile-menu');
        const closeMenu = document.getElementById('close-menu');
        if (menuToggle && mobileMenu && closeMenu) {
            menuToggle.addEventListener('click', () => mobileMenu.classList.remove('hidden'));
            closeMenu.addEventListener('click', () => mobileMenu.classList.add('hidden'));
            mobileMenu.addEventListener('click', e => { if (e.target === mobileMenu) mobileMenu.classList.add('hidden'); });
        }

        // 4) Header login state + pending view svg injection
        updateHeaderLoginState();

        // 5) Setup require-login bindings, common listeners
        setupRequireLogin();
        initializeEventListeners();

        // 6) Smooth scroll hint + touch scroll (theo c·∫•u tr√∫c table-scroll-x)
        (function setupHorizontalScrollUX() {
            const mobileHint = document.getElementById('mobile-scroll-hint');
            const scrollHost = document.querySelector('.table-scroll-x');
            function showMobileScrollHint() {
                if (!mobileHint || !scrollHost) return;
                const isMobile = window.innerWidth <= 768;
                const hasScroll = scrollHost.scrollWidth > scrollHost.clientWidth;
                if (isMobile && hasScroll) {
                    mobileHint.style.display = 'block';
                    setTimeout(() => { mobileHint.style.opacity = '0.7'; }, 3000);
                    setTimeout(() => { mobileHint.style.display = 'none'; }, 8000);
                } else {
                    mobileHint.style.display = 'none';
                }
            }
            showMobileScrollHint();
            window.addEventListener('resize', showMobileScrollHint);
            if (scrollHost) {
                let isScrolling = false, startX = 0, scrollLeft = 0;
                scrollHost.addEventListener('touchstart', function(e) {
                    isScrolling = true;
                    startX = e.touches[0].pageX - scrollHost.offsetLeft;
                    scrollLeft = scrollHost.scrollLeft;
                }, { passive: true });
                scrollHost.addEventListener('touchmove', function(e) {
                    if (!isScrolling) return;
                    const x = e.touches[0].pageX - scrollHost.offsetLeft;
                    const walk = (x - startX) * 2;
                    scrollHost.scrollLeft = scrollLeft - walk;
                }, { passive: true });
                scrollHost.addEventListener('touchend', function() { isScrolling = false; }, { passive: true });
            }
        })();

        // 7) Init CodeMirror + preview real-time
        if (typeof initCodeMirrorAndBindings === 'function') {
            initCodeMirrorAndBindings();
        }

        // 8) Init highlight.js
        if (window.hljs) {
            hljs.highlightAll();
            if (hljs.initLineNumbersOnLoad) hljs.initLineNumbersOnLoad();
        }

        // 9) Modal login button
        const modalLoginBtn = document.getElementById('modal-login-btn');
        if (modalLoginBtn) {
            modalLoginBtn.addEventListener('click', function() {
                window.location.href = "{{ url_for('google.login') }}";
            });
        }

        // 10) Logout link
        const logoutLink = document.getElementById('logout-link');
        if (logoutLink) {
            logoutLink.addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = '/logout?next=/';
            });
        }

        // 11) Keyword modal behaviors
        if (typeof initKeywordModal === 'function') {
            initKeywordModal();
        }
        
        // 12) Initialize search functionality
        initializeSearch();
        
        // 13) Initialize action buttons using data-action
            initializeActionButtons();

        // 14) Touch events ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong initializeTouchBtnEvents cho t·∫•t c·∫£ users
        console.log('üîÑ Touch events initialized for all users');

        console.log('DOMContentLoaded - appState.loggedIn:', window.appState && window.appState.loggedIn);

        // N·∫øu c√≥ code TikZ t·ª´ localStorage (t·ª´ View Mode), ƒëi·ªÅn v√†o textarea ch√≠nh
        // Th·ª±c thi sau khi t·∫•t c·∫£ ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o
        setTimeout(() => {
            const tikzFromStorage = localStorage.getItem('tikz_code_for_compile');
            if (tikzFromStorage) {
                console.log('Found tikz_code_for_compile in localStorage:', tikzFromStorage);
                // ƒêi·ªÅn code v√†o textarea ch√≠nh
                if (window.cm && typeof window.cm.setValue === 'function') {
                    window.cm.setValue(tikzFromStorage);
                    console.log('Code set to CodeMirror successfully');
                } else {
                    const textarea = document.getElementById('code');
                    if (textarea) {
                        textarea.value = tikzFromStorage;
                        console.log('Code set to textarea successfully');
                    }
                }
                // X√≥a d·ªØ li·ªáu ƒë√£ s·ª≠ d·ª•ng
                localStorage.removeItem('tikz_code_for_compile');
                console.log('tikz_code_for_compile removed from localStorage');
            }
        }, 100); // Delay 100ms ƒë·ªÉ ƒë·∫£m b·∫£o CodeMirror ƒë√£ s·∫µn s√†ng
    });

    // Sau khi login ‚Üí √©p reload ƒë·ªÉ ƒë·ªìng b·ªô session
    if (window.location.search.includes('login=1')) {
        window.location.href = window.location.pathname;
    }

</script>

    
    

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- File Card JavaScript -->
    <script src="{{ url_for('static', filename='js/file_card.js', v='1.1') }}"></script>

    <!-- H√†m kh·ªüi t·∫°o l·∫°i CodeMirror cho textarea id="code" -->
    <script>
        function ensureCodeMirror() {
            const textarea = document.getElementById('code');
            if (!textarea) return;
            // N·∫øu ƒë√£ c√≥ CodeMirror instance, kh√¥ng kh·ªüi t·∫°o l·∫°i
            if (textarea.nextSibling && textarea.nextSibling.classList && textarea.nextSibling.classList.contains('CodeMirror')) {
                return;
            }
            window.cm = CodeMirror.fromTextArea(textarea, {
                mode: 'stex',
                theme: 'material',
                lineNumbers: true,
                placeholder: 'Nh·∫≠p code TikZ t·∫°i ƒë√¢y...'
            });
        }
    </script>

    <!-- ... trong submitTikzCodeAjax, sau khi c·∫≠p nh·∫≠t previewCol v√† resultToolsSection ... -->
    <!-- Th√™m d√≤ng n√†y sau khi c·∫≠p nh·∫≠t DOM: -->
    <!-- ensureCodeMirror(); -->
</body>
</html>
