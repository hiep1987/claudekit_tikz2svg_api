<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªì s∆° c√° nh√¢n - TikZ to SVG</title>
    
    <!-- Global JavaScript variables -->
    <script>
        window.isLoggedIn = {{ 'true' if current_user.is_authenticated else 'false' }};
        window.activeFeedbackCount = 0;
        window.isOwner = {{ 'true' if is_owner else 'false' }};
    </script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* ======== Base layout ======== */
        body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          max-width: 800px;
          margin: 0 auto;
          padding: 20px;
          background-color: #f5f5f5;
          transition: all 0.3s ease;
        }
        
        .container {
          background: white;
          padding: 40px;
          border-radius: 12px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.1);
          transition: all 0.3s ease;
          max-width: 1200px;
        }
        
        .header {
          text-align: center;
          margin-bottom: 40px;
        }
        
        .header h1 {
          color: #1976d2;
          margin-bottom: 10px;
        }
        
        .header p {
          color: #666;
          font-size: 16px;
        }
        
        /* ======== Profile section grid ======== */
        .profile-section {
          display: grid;
          grid-template-columns: 1fr 2fr;
          gap: 40px;
          margin-bottom: 40px;
        }
        
        .avatar-section {
          text-align: center;
        }
        
        .avatar-container {
          position: relative;
          display: inline-block;
          margin-bottom: 20px;
        }
        
        .avatar,
        .avatar-placeholder {
          width: 150px;
          height: 150px;
          border-radius: 50%;
          object-fit: cover;
          border: 4px solid #e0e0e0;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .avatar-placeholder {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-size: 48px;
          font-weight: bold;
        }
        
        .avatar-upload {
          margin-top: 15px;
        }
        
        .avatar-upload input[type="file"] {
          display: none;
        }
        
        .avatar-upload label {
          background: #1976d2;
          color: white;
          padding: 10px 20px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
          transition: background 0.3s;
        }
        
        .avatar-upload label:hover {
          background: #1565c0;
        }
        
        /* ======== Animations ======== */
        @keyframes fadeIn {
          from {
            opacity: 0.7;
            transform: scale(0.95);
          }
          to {
            opacity: 1;
            transform: scale(1);
          }
        }
        
        .fade-in {
          animation: fadeIn 0.3s ease-in-out;
        }
        
        /* ======== Info Section ======== */
        .info-section {
          padding: 20px;
          background: #f8f9fa;
          border-radius: 8px;
        }
        
        .info-group {
          margin-bottom: 25px;
        }
        
        .info-group label {
          display: block;
          font-weight: bold;
          color: #333;
          margin-bottom: 8px;
          font-size: 14px;
        }
        
        .info-group input,
        .info-group textarea {
          width: 100%;
          padding: 12px;
          border: 2px solid #ddd;
          border-radius: 6px;
          font-size: 16px;
          box-sizing: border-box;
        }
        
        .info-group input:focus,
        .info-group textarea:focus {
          outline: none;
          border-color: #1976d2;
        }
        
        .info-group .readonly {
          background: #f5f5f5;
          color: #666;
          cursor: not-allowed;
          border-color: #ddd;
        }
        
        /* ======== Buttons ======== */
        .actions {
          text-align: center;
          margin-top: 30px;
        }
        
        .btn {
          padding: 12px 30px;
          border: none;
          border-radius: 6px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s;
          margin: 0 10px;
        }
        
        .btn-primary {
          background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
          color: white;
        }
        
        .btn-primary:hover {
          background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
        }
        
        .btn-secondary {
          background: #6c757d;
          color: white;
        }
        
        .btn-secondary:hover {
          background: #5a6268;
        }
        
        /* ======== Flash Messages ======== */
        .flash-messages {
          margin-bottom: 20px;
        }
        
        .flash {
          padding: 12px 20px;
          border-radius: 6px;
          margin-bottom: 10px;
          font-weight: bold;
          transition: opacity 0.3s ease;
        }
        
        .flash-success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
        }
        
        .flash-error {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
        }
        
        /* ======== Dark Mode ======== */
        .dark-mode {
          background-color: #121212;
          color: #eee;
        }
        
        .dark-mode .container {
          background-color: #1e1e1e;
          color: #eee;
        }
        
        .dark-mode .info-section {
          background: #2d2d2d;
        }
        
        .dark-mode .info-group input,
        .dark-mode .info-group textarea {
          background: #3d3d3d;
          color: #eee;
          border-color: #555;
        }
        
        .dark-mode .info-group .readonly {
          background: #2a2a2a;
          color: #aaa;
        }
        
        .dark-mode .info-group label {
          color: #e0e0e0;
        }
        
        /* ======== Toggle Section ======== */
        .profile-toggle-section {
          margin-bottom: 30px;
        }
        
        .profile-toggle-btn {
          width: 100%;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          padding: 16px 24px;
          border-radius: 12px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: space-between;
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
          transition: all 0.3s ease;
        }
        
        .profile-toggle-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .profile-toggle-btn .toggle-icon {
          font-size: 20px;
        }
        
        .profile-toggle-btn .toggle-text {
          flex: 1;
          text-align: left;
          margin-left: 12px;
        }
        
        .profile-toggle-btn .toggle-arrow {
          font-size: 14px;
          transition: transform 0.3s ease;
        }
        
        .profile-toggle-btn.active .toggle-arrow {
          transform: rotate(180deg);
        }
        
        .profile-content {
          max-height: 0;
          overflow: hidden;
          transition: max-height 0.5s ease;
          background: white;
          border-radius: 12px;
          margin-top: 10px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .profile-content.show {
          max-height: 2000px;
          padding: 30px;
        }
        
        .dark-mode .profile-content {
          background-color: #1e1e1e;
        }
        
        /* ======== Navbar Header User ======== */
        .navbar-header-user {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            box-sizing: border-box;
        }

        
        /* √âp n√∫t ƒëƒÉng xu·∫•t gi·ªëng index */
        #logout-btn {
          background: #d32f2f;
          color: white;
          padding: 8px 16px;
          border-radius: 6px;
          text-decoration: none;
          font-weight: bold;
          font-size: 14px;
          box-sizing: border-box;
        }
        
        /* ======== Navbar User Info ======== */
        .navbar-user-info {
          padding: 6px 14px;
          border-radius: 6px;
          gap: 8px;
          background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
          color: white;
          font-size: 14px;
          display: flex;
          align-items: center;
          box-shadow: 0 2px 4px rgba(25, 118, 210, 0.2);
          text-decoration: none;
          cursor: pointer;
          transition: all 0.2s ease;
        }
        
        .navbar-user-info:hover {
          background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
          box-shadow: 0 4px 8px rgba(25, 118, 210, 0.3);
        }
        
        .navbar-avatar,
        .navbar-avatar-placeholder {
          width: 28px;
          height: 28px;
          border-radius: 50%;
          border: 2px solid #fff;
          object-fit: cover;
          background: #eee;
          flex-shrink: 0;
        }
        
        .navbar-avatar-placeholder {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          font-size: 14px;
        }
        
        .navbar-username {
          font-weight: 500;
          font-size: 13.5px;
          max-width: 100px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        /* Google Login Button Styles */
        .google-login-btn {
          max-width: 320px;
          display: flex;
          padding: 8px 16px;
          font-size: 14px;
          line-height: 1.25rem;
          font-weight: 700;
          text-align: center;
          text-transform: uppercase;
          align-items: center;
          justify-content: center;
          border-radius: 6px;
          border: 1px solid rgba(0, 0, 0, 0.25);
          gap: 0.75rem;
          color: rgb(65, 63, 63);
          background-color: #fff;
          cursor: pointer;
          transition: all .6s ease;
          min-height: 40px;
        }

        .google-login-btn svg {
          height: 24px;
          flex-shrink: 0;
        }

        .google-login-btn:hover {
          transform: scale(1.02);
          background-color: #1565c0;
          color: white;
        }
        
        /* ======== Responsive ======== */
        @media (max-width: 768px) {
          .profile-section {
            grid-template-columns: 1fr;
            gap: 20px;
          }
        
          .container {
            padding: 20px;
          }
        }
        
        /* More responsive tweaks (example) */
        @media (max-width: 600px) {
            .navbar-header-user {
                flex-direction: column;
                align-items: center;
                gap: 8px;
                margin-bottom: 12px;
            }
            
            .navbar-user-info {
                padding: 8px 12px;
                gap: 6px;
                border-radius: 6px;
                justify-content: center;
            }

            .navbar-avatar,
            .navbar-avatar-placeholder {
                width: 26px;
                height: 26px;
            }

            .navbar-username {
                font-size: 13px;
                max-width: 90px;
            }
            
            .container {
            padding: 4vw;
          }
        
          .avatar, .avatar-placeholder {
            width: 80px;
            height: 80px;
            font-size: 32px;
          }
        
          .btn, .btn-primary, .btn-secondary {
            width: 100%;
            font-size: 17px;
            margin: 8px 0;
            padding: 14px 0;
          }
          
          /* Google login button responsive */
          .google-login-btn {
            max-width: 280px;
            padding: 8px 16px;
            font-size: 14px;
            min-height: 40px;
            margin: 0 auto;
          }
          
          .google-login-btn svg {
            height: 20px;
          }
        }

        
       /* ======== Files Grid ======== */
.files-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 20px;
  margin-top: 20px;
  padding: 0;
  list-style: none;
}

/* ======== Individual File Card ======== */
.file-card {
  position: relative;
  min-height: 260px;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  transition: transform 0.2s ease;
}

.file-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.12);
}

/* ======== Image Section ======== */
.file-img-container {
  position: relative;
  overflow: hidden;
  border-radius: 10px 10px 0 0;
  background: #fff;
  height: 180px;
  width: 100%;
}

.file-img-container img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  display: block;
  background-color: #fff;
  transition: transform 0.3s ease;
}

.file-card:hover .file-img-container img {
  transform: scale(1.03);
}

/* ======== Overlay Action Menu (FIXED) ======== */
.file-action-container {
  display: none;
  opacity: 0;
  pointer-events: none;
  transform: translateX(-10px);
  transition: opacity 0.3s, transform 0.3s;
  position: absolute;
  left: 12px;
  top: 2px;
  z-index: 300;
}

/* V·ªã tr√≠ menu ri√™ng cho followed-post-card */
.followed-post-card .file-action-container {
  top: 60px;
}

/* Desktop hover logic */
@media (hover: hover) and (pointer: fine) {
  .file-img-container:hover + .file-action-container,
  .file-action-container:hover,
  .file-card:hover .file-action-container {
    display: block;
    opacity: 1;
    pointer-events: auto;
    transform: translateX(0);
  }
  
  /* Hover logic for followed-post-card */
  .followed-post-card:hover .file-action-container {
    display: block;
    opacity: 1;
    pointer-events: auto;
    transform: translateX(0);
  }
}

/* Mobile/Touch: Ch·ªâ hi·ªán khi card c√≥ class active */
.file-card.active .file-action-container {
  display: block !important;
  opacity: 1 !important;
  pointer-events: auto !important;
  transform: translateX(0) !important;
}

/* Mobile/Touch for followed-post-card */
.followed-post-card.active .file-action-container {
  display: block !important;
  opacity: 1 !important;
  pointer-events: auto !important;
  transform: translateX(0) !important;
}

.copy-btn {
  padding: 6px 14px;
  font-size: 14px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.25s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: #f5f5f5;
  border: 1px solid #ddd;
}

.copy-btn:hover {
  background: #e0e0e0;
}

/* Mobile: Hi·ªán n√∫t toggle ... */
.action-toggle-btn {
  display: none;
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 200;
  border: none;
  background: rgba(255,255,255,0.95);
  border-radius: 50%;
  width: 38px;
  height: 38px;
  font-size: 22px;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.13);
}



@media (hover: none), (pointer: coarse) {
  .action-toggle-btn {
    display: block;
  }
  /* V√¥ hi·ªáu h√≥a hover tr√™n mobile */
  .file-img-container:hover + .file-action-container {
    display: none !important;
    opacity: 0 !important;
    pointer-events: none !important;
  }
  .file-card.active .file-action-container .Btn.individual-active,
  .file-card.active .file-action-container .Btn.ready-to-execute,
  .file-card.active .file-action-container .Btn.mobile-hover {
    background: linear-gradient(-50deg, rgb(39, 107, 255), rgb(112, 186, 255), rgb(39, 107, 255)) !important;
    width: 120px !important; /* ƒê·ªô r·ªông n√∫t tr∆∞·ªõc hover */
    transition: width 0.3s cubic-bezier(0.4,0,0.2,1);
  }

  .file-card.active .file-action-container .Btn:not(.individual-active):not(.ready-to-execute):not(.mobile-hover) {
    background: linear-gradient(-50deg, rgb(39, 107, 255), rgb(112, 186, 255), rgb(39, 107, 255)) !important;
    max-width: 10px !important;
  border-radius: 18px !important;
}

  .file-card.active .file-action-container .Btn .text {
    opacity: 0.5 !important;
    width: auto !important;
    max-width: 120px !important;
  }
}

/* Force show on touch devices khi c√≥ class is-touch */
.is-touch .action-toggle-btn {
  display: block !important;
}

/* ƒê·∫£m b·∫£o file-action-container hi·ªÉn th·ªã khi card active (cho mobile khi ch∆∞a ƒëƒÉng nh·∫≠p) */
@media (max-width: 768px) {
  .file-card.active .file-action-container {
    display: flex !important;
    opacity: 1 !important;
    pointer-events: auto !important;
  }
}

/* Action toggle button styling */
.action-toggle-btn {
  transition: all 0.2s ease;
}

.action-toggle-btn:hover {
  background: rgba(39, 107, 255, 0.9) !important;
  color: white !important;
  transform: scale(1.05);
}

.file-action-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column; /* S·∫Øp x·∫øp theo 1 c·ªôt */
  gap: 8px; /* Reduce gap for better fit */
  overflow: visible;
  width: auto; /* Kh√¥ng c·∫ßn width 100% n·ªØa */
}

.file-action-item {
  display: flex;
  justify-content: flex-start;
  width: 100%;
}

/* ======== Button Styling (FIXED) ======== */
.Btn {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  width: 35px;
  height: 35px;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: all 0.3s ease;
  box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.199);
  background: linear-gradient(-50deg, rgb(39, 107, 255), rgb(112, 186, 255), rgb(39, 107, 255));
  background-size: 250%;
  background-position: left;
  min-width: 35px;
  flex-shrink: 0;
}

/* Icon container */
.sign {
  width: 45px;
  height: 45px;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  padding-left: 4px;
  flex-shrink: 0;
  z-index: 2;
  position: relative;
}

.sign svg {
  width: 18px;
  height: 18px;
}

.sign svg path {
  fill: white;
}

.logoIcon {
  color: white;
  font-size: 16px;
}

/* Text label */
.text {
  position: absolute;
  left: 20px; /* Start right after icon */
  top: 50%;
  transform: translateY(-50%);
  width: 0;
  opacity: 0;
  color: white;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s ease;
  white-space: nowrap;
  text-align: left;
  padding-left: 12px; /* Small gap from icon */
  z-index: 1;
}

/* Desktop hover effect */
.Btn:hover {
  width: 140px;
  border-radius: 20px;
  background-position: right;
}

.Btn:hover .text {
  opacity: 1;
  width: auto; /* Let text take natural width */
  max-width: 85px; /* Limit max width */
}

/* Mobile active state */
.file-card.active .file-action-container .Btn {
  width: 140px !important;
  border-radius: 25px !important;
  background-position: right !important;
}

.file-card.active .file-action-container .Btn .text {
  opacity: 1 !important;
  width: auto !important;
  max-width: 85px !important;
}

/* Alternative mobile hover class */
.Btn.mobile-hover {
  width: 140px !important;
  border-radius: 25px !important;
  background-position: right !important;
}

.Btn.mobile-hover .text {
  opacity: 1 !important;
  width: auto !important;
  max-width: 85px !important;
}

/* Button active effect */
.Btn:active {
  transform: translate(1px, 1px);
}

/* Remove text decoration */
.logoIcon, .sign {
  text-decoration: none !important;
}

/* Touch feedback for mobile */
.Btn.touched {
  box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.4);
  outline: none;
  background-position: right;
}

/* Tr·∫°ng th√°i active cho t·ª´ng n√∫t ri√™ng bi·ªát */
.Btn.individual-active {
  width: 140px !important;
  border-radius: 25px !important;
  background-position: right !important;
  box-shadow: 0 0 0 2px rgba(39, 107, 255, 0.4) !important;
  transform: scale(1.02);
}

.Btn.individual-active .text {
  opacity: 1 !important;
  width: auto !important;
  max-width: 85px !important;
  animation: textFadeIn 0.3s ease-in-out;
}

@keyframes textFadeIn {
  from {
    opacity: 0;
    transform: translateX(-10px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* Override l·∫°i mobile hover ƒë·ªÉ kh√¥ng √°p d·ª•ng cho t·∫•t c·∫£ n√∫t */
.file-card.active .file-action-container .Btn:not(.individual-active) {
  width: 45px !important; /* Tr·ªü v·ªÅ k√≠ch th∆∞·ªõc g·ªëc */
  border-radius: 50% !important;
  background-position: left !important;
  opacity: 0.7; /* L√†m m·ªù m·ªôt ch√∫t */
  transition: all 0.3s ease;
}

.file-card.active .file-action-container .Btn:not(.individual-active) .text {
  opacity: 0 !important;
  width: 0 !important;
}

/* Tr·∫°ng th√°i s·∫µn s√†ng th·ª±c thi (sau tap 1) */
.Btn.ready-to-execute {
  box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.4) !important;
  animation: readyToPulse 1.5s infinite;
}

@keyframes readyToPulse {
  0%, 100% {
    transform: scale(1.02);
    box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.4);
  }
  50% {
    transform: scale(1.05);
    box-shadow: 0 0 0 5px rgba(76, 175, 80, 0.6);
  }
}

/* Visual indicator tr√™n text */
.Btn.ready-to-execute .text::after {
  content: " üëÜ";
  animation: blink 1s infinite;
}

@keyframes blink {
  0%, 50% { opacity: 1; }
  51%, 100% { opacity: 0; }
}


        /* ======== Animations ======== */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ======== File Info Styling ======== */
        .file-info {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 0px;
            font-size: 13px;
            color: #555;
        }

        .file-meta {
            margin-bottom: 6px;
            font-weight: 400; /* Gi·∫£m ƒë·ªô ƒë·∫≠m t·ª´ bold xu·ªëng normal */
        }

        .file-meta .label {
            font-weight: 500; /* Gi·∫£m ƒë·ªô ƒë·∫≠m c·ªßa label t·ª´ bold xu·ªëng medium */
            color: #333;
        }

        .file-creator {
            margin-top: 8px;
            font-size: 13px;
            font-weight: 400;
        }

        /* ======== No Followed Posts ======== */
        .no-followed-posts {
            text-align: center;
            color: #666;
            padding: 40px 20px;
            background: #f9f9f9;
            border-radius: 12px;
            border: 2px dashed #ddd;
        }

        .no-followed-posts-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* ======== Smart Follow Button ======== */
        .smart-follow-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: transparent;
            color: #3b82f6;
            border: 2px solid #3b82f6;
            font-weight: 600;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .smart-follow-btn .follow-icon,
        .smart-follow-btn .following-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
            font-size: 16px;
            /* Debug: ƒë·∫£m b·∫£o icon hi·ªÉn th·ªã */
            display: block !important;
            width: 16px;
            height: 16px;
            text-align: center;
            line-height: 16px;
        }

        .smart-follow-btn .following-icon {
            color: white;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.5);
            /* Debug: ƒë·∫£m b·∫£o icon hi·ªÉn th·ªã */
            display: block !important;
        }

        /* Tr·∫°ng th√°i ƒë√£ follow - t√¥ n·ªÅn */
        .smart-follow-btn.following {
            background: #3b82f6;
            color: white;
        }

        .smart-follow-btn.following .follow-icon {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.5);
        }

        .smart-follow-btn.following .following-icon {
            opacity: 1 !important;
            transform: translate(-50%, -50%) scale(1);
            color: white !important;
        }

        /* Hover effect khi ƒë√£ follow */
        .smart-follow-btn.following:hover {
            background: #dc2626;
            border-color: #dc2626;
        }

        /* Hover effect khi ch∆∞a follow */
        .smart-follow-btn:hover:not(.following) {
            background: rgba(59, 130, 246, 0.1);
        }

        /* ======== Like Button Styles ======== */
        /* From Uiverse.io by Priyanshu02020 - Updated for compact design */ 
        input[id^="heart-"] {
            display: none;
        }

        .like-button {
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            height: 32px;
            width: 90px;
            border-radius: 8px;
            border: none;
            background-color: #2d2d2d;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            padding: 0 8px;
        }

        /* ·∫®n checkbox trong like button */
        .like-button input[type="checkbox"] {
            display: none;
        }

        .like {
            display: flex;
            cursor: pointer;
            align-items: center;
            gap: 4px;
            flex: 1;
        }

        .like-icon {
            fill: #808080;
            height: 16px;
            width: 16px;
            transition: fill 0.2s ease;
        }

        .like-text {
            color: #e0e0e0;
            font-size: 12px;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 500;
        }

        .like-count {
            color: #808080;
            font-size: 12px;
            font-weight: 500;
            margin-left: 4px;
            transition: all 0.3s ease;
        }

        .like-count.two {
            position: absolute;
            right: 8px;
            transform: translateY(20px);
            opacity: 0;
        }

        .like-count.one {
            position: relative;
        }

        input[id^="heart-"]:checked ~ .like .like-icon,
        input[id^="followed-heart-"]:checked ~ .like .like-icon {
            fill: #ff4757;
            animation: heartBeat 0.3s ease;
        }

        input[id^="heart-"]:checked ~ .like-count.one,
        input[id^="followed-heart-"]:checked ~ .like-count.one {
            transform: translateY(-20px);
            opacity: 0;
        }

        input[id^="heart-"]:checked ~ .like-count.two,
        input[id^="followed-heart-"]:checked ~ .like-count.two {
            transform: translateY(0);
            opacity: 1;
            color: #ff4757;
        }

        @keyframes heartBeat {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.3);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }
        </style>

</head>
<body>
            <!-- Navbar header user info gi·ªëng trang index -->
            <div class="navbar-header-user">
                <a href="/" class="btn btn-secondary" style="text-decoration: none; background: #6c757d; color: white; padding: 8px 16px; border-radius: 6px; font-weight: bold; font-size: 14px;">üè† V·ªÅ trang ch·ªß</a>
                <button type="button" id="dark-mode-toggle" class="btn btn-secondary" style="background: #6c757d; color: white; padding: 8px 16px; border-radius: 6px; font-weight: bold; font-size: 14px; border: none; cursor: pointer;">üåô Dark Mode</button>
                    {% if current_user.is_authenticated %}
        <a href="/profile/me" class="navbar-user-info">
            <img src="{{ url_for('static', filename='avatars/' ~ current_avatar) if current_avatar else '' }}"
                 alt="Avatar" class="navbar-avatar"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            {% if not current_avatar %}
            <div class="navbar-avatar-placeholder">
                {{ current_user_email[0].upper() }}
            </div>
            {% endif %}
            <span class="navbar-username">
                {{ current_username or current_user_email.split('@')[0] }}
            </span>
        </a>
        <a id="logout-btn" href="#">ƒêƒÉng xu·∫•t</a>
    {% else %}
                    <button class="google-login-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid" viewBox="0 0 256 262">
                            <path fill="#4285F4" d="M255.878 133.451c0-10.734-.871-18.567-2.756-26.69H130.55v48.448h71.947c-1.45 12.04-9.283 30.172-26.69 42.356l-.244 1.622 38.755 30.023 2.685.268c24.659-22.774 38.875-56.282 38.875-96.027"></path>
                            <path fill="#34A853" d="M130.55 261.1c35.248 0 64.839-11.605 86.453-31.622l-41.196-31.913c-11.024 7.688-25.82 13.055-45.257 13.055-34.523 0-63.824-22.773-74.269-54.25l-1.531.13-40.298 31.187-.527 1.465C35.393 231.798 79.49 261.1 130.55 261.1"></path>
                            <path fill="#FBBC05" d="M56.281 156.37c-2.756-8.123-4.351-16.827-4.351-25.82 0-8.994 1.595-17.697 4.206-25.82l-.073-1.73L15.26 71.312l-1.335.635C5.077 89.644 0 109.517 0 130.55s5.077 40.905 13.925 58.602l42.356-32.782"></path>
                            <path fill="#EB4335" d="M130.55 50.479c24.514 0 41.05 10.589 50.479 19.438l36.844-35.974C195.245 12.91 165.798 0 130.55 0 79.49 0 35.393 29.301 13.925 71.947l42.211 32.783c10.59-31.477 39.891-54.251 74.414-54.251"></path>
                        </svg>
                        ƒêƒÉng nh·∫≠p Google
                    </button>
                {% endif %}
            </div>

    <div class="container">
    {% if not is_owner %}
    <div class="public-profile-header" style="text-align: center; margin-bottom: 40px;">
        <div class="avatar-container" style="margin: 0 auto 12px; text-align: center;">
            {% if avatar %}
                <img src="{{ url_for('static', filename='avatars/' ~ avatar) }}" alt="Avatar" class="avatar" style="width: 120px; height: 120px;">
            {% else %}
                <div class="avatar-placeholder" style="width: 120px; height: 120px; font-size: 48px;">
                    {{ username[0].upper() if username else '?' }}
                </div>
            {% endif %}
            <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-top: 10px;">
                <h2 style="margin: 0; color: #1976d2;">{{ username }}</h2>
                <!-- Follower count display - ch·ªâ hi·ªÉn th·ªã khi kh√¥ng ph·∫£i owner ho·∫∑c ch∆∞a ƒëƒÉng nh·∫≠p -->
                {% if not is_owner or not current_user.is_authenticated %}
                <div id="follower-count-display" data-user-id="{{ user_id }}" style="display: flex; align-items: center; gap: 8px; background: #f8f9fa; padding: 6px 12px; border-radius: 20px; border: 1px solid #e9ecef;">
                    <span style="font-size: 14px; color: #6c757d;">üë•</span>
                    <span id="follower-count-text" style="font-weight: 600; color: #495057;">{{ follower_count | default('0') }} followers</span>
                </div>
                {% endif %}
                <!-- Follow button for public profile view (not owner) -->
                {% if current_user.is_authenticated and not is_owner %}
                <button 
                    class="follow-btn smart-follow-btn{% if is_followed %} following{% endif %}" 
                    id="public-follow-btn"
                    data-followed="{{ 'true' if is_followed else 'false' }}" 
                    data-count="{{ follower_count or 0 }}"
                    data-user-id="{{ user_id }}"
                    onclick="toggleFollow(this)"
                    title="{{ 'Unfollow' if is_followed else 'Follow' }}"
                >
                    <i class="fas fa-user-plus follow-icon"></i>
                    <i class="fas fa-check following-icon"></i>
                </button>
                {% endif %}
            </div>
        </div>
        {% if bio %}
        <div class="profile-bio" style="max-width: 640px; margin: 0 auto 24px; padding: 16px 24px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; color: #444; list-style-position: inside; padding-left: 0;">
            {{ bio|safe }}
        </div>
        {% endif %}
    </div>
    {% endif %}
        <!-- Profile Settings Toggle -->
        {% if is_owner %}
        <div class="profile-toggle-section">
            <button type="button" id="profile-toggle-btn" class="profile-toggle-btn">
                <span class="toggle-icon">‚öôÔ∏è</span>
                <span class="toggle-text">C√†i ƒë·∫∑t h·ªì s∆°</span>
                <span class="toggle-arrow">‚ñº</span>
            </button>
            
            <div id="profile-content" class="profile-content">
                <div class="header">
                    <h1>üë§ H·ªì s∆° c√° nh√¢n</h1>
                    <p>Qu·∫£n l√Ω th√¥ng tin t√†i kho·∫£n c·ªßa b·∫°n</p>
                </div>

                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <div class="flash-messages">
                            {% for category, message in messages %}
                                <div class="flash flash-{{ 'success' if category == 'success' else 'error' }}">
                                    {{ message }}
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}

                <form method="POST" enctype="multipart/form-data">
                    <div class="profile-section">
                        <!-- Avatar Section -->
                        <div class="avatar-section">
                            <div class="avatar-container">
                                {% if avatar %}
                                    <img src="{{ url_for('static', filename='avatars/' ~ avatar) }}" alt="Avatar" class="avatar" id="avatar-preview">
                                {% else %}
                                    <div class="avatar-placeholder" id="avatar-placeholder">
                                        {{ user_email[0].upper() if user_email else 'U' }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="avatar-upload">
                                <input type="file" id="avatar-input" name="avatar" accept="image/*" onchange="openCropperModal(this)">
                                <label for="avatar-input">üì∑ Ch·ªçn ·∫£nh ƒë·∫°i di·ªán</label>
                            </div>
                            <!-- Smart Follow Button (hide for owner) -->
                            <p style="font-size: 12px; color: #666; margin-top: 10px;">
                                H·ªó tr·ª£: JPG, PNG, GIF (t·ªëi ƒëa 5MB)
                            </p>
                        </div>

                        <!-- Info Section -->
                        <div class="info-section">
                            <div class="info-group">
                                <label for="email">üìß Email:
                                    {% if email_verified %}
                                        <span style="color: green; font-size: 13px;">‚úî ƒê√£ x√°c th·ª±c</span>
                                    {% else %}
                                        <span style="color: orange; font-size: 13px;">‚ö† Ch∆∞a x√°c th·ª±c</span>
                                    {% endif %}
                                </label>
                                <input type="email" id="email" value="{{ user_email }}" class="readonly" readonly>
                                <small style="color: #666; font-size: 12px;">Email kh√¥ng th·ªÉ thay ƒë·ªïi</small>
                            </div>

                            <div class="info-group">
                                <label for="username">üë§ T√™n hi·ªÉn th·ªã:</label>
                                <input type="text" id="username" name="username" value="{{ username or '' }}" 
                                       placeholder="Nh·∫≠p t√™n hi·ªÉn th·ªã c·ªßa b·∫°n" maxlength="50">
                                <small style="color: #666; font-size: 12px;">T√™n s·∫Ω hi·ªÉn th·ªã trong ·ª©ng d·ª•ng</small>
                            </div>

                            <div class="info-group">
                                <label for="bio">üìù M√¥ t·∫£ / Gi·ªõi thi·ªáu:</label>
                                <!-- Quill Editor Container -->
                                <div id="bio-editor" style="background:white; min-height:120px;">{{ bio|safe }}</div>
                                <input type="hidden" name="bio" id="bio-hidden">
                                <small style="color: #666; font-size: 12px;">B·∫°n c√≥ th·ªÉ chia s·∫ª v·ªÅ m√¨nh (h·ªó tr·ª£ ƒë·ªãnh d·∫°ng: B, I, U, bullets, m√†u s·∫Øc)</small>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="avatar-cropped-blob" name="avatar_cropped" value="">

                    <div class="actions">
                        <button type="submit" class="btn btn-primary">üíæ L∆∞u thay ƒë·ªïi</button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}

<section class="svg-files-section" style="margin-top:60px;">
    <h3 style="color:#1976d2; margin-bottom:24px;">
        {% if is_owner %}
            üìÇ C√°c file SVG b·∫°n ƒë√£ t·∫°o
        {% else %}
            üìÇ Danh s√°ch c√°c file SVG ƒë√£ t·∫°o
        {% endif %}
    </h3>
    {% if svg_files %}
    <div class="files-grid">
        {% for file in svg_files %}
        <div class="file-card" data-id="{{ file.id }}">
          <button class="action-toggle-btn" type="button" aria-label="Hi·ªán menu h√†nh ƒë·ªông">‚ãØ</button>
          <div class="file-img-container">
            <img src="{{ file.url }}" alt="{{ file.filename }}">
          </div>
          
          <!-- N√∫t Like m·ªõi (From Uiverse.io by Priyanshu02020) - ch·ªâ hi·ªÉn th·ªã khi ƒë√£ ƒëƒÉng nh·∫≠p -->
          {% if current_user.is_authenticated %}
          <div class="like-button-wrapper" style="position: absolute; bottom: 8px; right: 8px; z-index: 100;">
            <div class="like-button">
              <input id="heart-{{ file.id }}" type="checkbox" {% if file.is_liked_by_current_user %}checked{% endif %} />
              <label class="like" for="heart-{{ file.id }}">
                <svg
                  class="like-icon"
                  fill-rule="nonzero"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z"
                  ></path>
                </svg>
                <span class="like-text">Likes</span>
              </label>
              <span class="like-count one">{{ file.like_count }}</span>
              <span class="like-count two">{{ file.like_count }}</span>
            </div>
          </div>
          {% else %}
          <!-- Hi·ªÉn th·ªã s·ªë like khi ch∆∞a ƒëƒÉng nh·∫≠p -->
          <div style="position: absolute; bottom: 8px; right: 8px; z-index: 100; background: rgba(0,0,0,0.8); color: white; padding: 6px 10px; border-radius: 16px; font-size: 13px; display: flex; align-items: center; gap: 6px; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1);">
            <span style="color: #ff4757; font-size: 14px;">‚ù§Ô∏è</span>
            <span style="font-weight: 600;">{{ file.like_count }}</span>
          </div>
          {% endif %}

          <div class="file-action-container">
            <ul class="file-action-list">
              <li class="file-action-item">
                <button type="button" class="Btn" data-filename="{{ file.filename }}">
                  <div class="sign">
                    <i class="fas fa-image logoIcon"></i>
                  </div>
                  <div class="text">T·∫£i ·∫£nh</div>
                </button>
              </li>
              <li class="file-action-item">
                <button type="button" class="Btn fb-share-btn" data-filename="{{ file.filename }}" data-has-feedback="true">
                  <div class="sign">
                    <i class="fab fa-facebook logoIcon"></i>
                  </div>
                  <div class="text">Facebook</div>
                </button>
              </li>
              <li class="file-action-item">
                <button type="button" class="Btn file-copy-link-btn" data-url="{{ request.host_url.rstrip('/') ~ file.url }}" data-has-feedback="true">
                  <div class="sign">
                    <i class="fas fa-link logoIcon"></i>
                  </div>
                  <div class="text">Copy Link</div>
                </button>
              </li>
              {% if file.tikz_code %}
              <li class="file-action-item">
                <button type="button" class="Btn">
                  <div class="sign">
                    <i class="fas fa-code logoIcon"></i>
                  </div>
                  <div class="text">Xem Code</div>
                </button>
              </li>
              {% endif %}
              <!-- N√∫t x√≥a ch·ªâ hi·ªÉn th·ªã khi user xem profile c·ªßa ch√≠nh m√¨nh -->
              {% if is_owner %}
              <li class="file-action-item">
                <button type="button" class="Btn delete-btn">
                  <div class="sign">
                    <i class="fas fa-trash logoIcon"></i>
                  </div>
                  <div class="text">X√≥a ·∫£nh</div>
                </button>
              </li>
              {% endif %}
            </ul>
          </div>
          

          <!-- Info Section -->
          <div class="file-info">
            <div class="file-meta">
              <span class="label">T·∫°o l√∫c:</span> {{ file.created_time }}
            </div>
            {% if file.size %}
              <div class="file-meta">
                <span class="label">K√≠ch th∆∞·ªõc:</span> {{ file.size }} KB
              </div>
            {% else %}
              <div class="file-meta">
                <span class="label">K√≠ch th∆∞·ªõc:</span> Kh√¥ng x√°c ƒë·ªãnh
              </div>
            {% endif %}
            {% if file.creator_id and file.creator_username %}
              <div class="file-creator">
                üë§ <a href="/profile/{{ file.creator_id }}" style="text-decoration: none; color: #1976d2; font-weight: 500;">
                  {{ file.creator_username }}
                </a>
              </div>
            {% endif %}
          </div>

          <!-- TikZ Code Section -->
          {% if file.tikz_code %}
          <div class="tikz-code-block" style="display:none; margin-top:10px;">
            <div class="tikz-code-header">
              <span>Code TikZ:</span>
              <button class="copy-btn" onclick="copyTikzCode(this)">üìã Copy</button>
            </div>
            <div class="code-block">
              <textarea class="tikz-cm" readonly>{{ file.tikz_code | e }}</textarea>
            </div>
          </div>
          {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div style="color:#666; margin-top:18px;">Ch∆∞a c√≥ file SVG n√†o ƒë∆∞·ª£c t·∫°o. H√£y th·ª≠ chuy·ªÉn ƒë·ªïi m·ªôt code TikZ!</div>
    {% endif %}
</section>

{% if is_owner %}
<!-- Section B√†i ƒëƒÉng theo d√µi -->
<section class="followed-posts-section" style="margin-top:60px;" data-is-owner="{{ 'true' if is_owner else 'false' }}">
    <h3 style="color:#1976d2; margin-bottom:24px;">üì∞ B√†i ƒëƒÉng t·ª´ ng∆∞·ªùi b·∫°n theo d√µi</h3>
    <div id="followed-posts-container" class="files-grid">
        <div class="loading-spinner" style="text-align: center; padding: 20px;">
            <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #1976d2; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 10px; color: #666;">ƒêang t·∫£i b√†i ƒëƒÉng...</p>
        </div>
    </div>
</section>
{% endif %}



<script>
function toggleCode(btn) {
    const block = btn.parentNode.parentNode.querySelector('.tikz-code-block');
    if (block.style.display === 'none' || !block.style.display) {
        block.style.display = 'block';
        btn.innerHTML = '<span style="font-size:18px;">üìù</span> ·∫®n code';
    } else {
        block.style.display = 'none';
        btn.innerHTML = '<span style="font-size:18px;">üìù</span> Xem code TikZ';
    }
}
function copyToClipboard(url, btn) {
    const card = btn.closest('.file-card');
    const actionContainer = card ? card.querySelector('.file-action-container') : null;
    
    // Th·ª≠ s·ª≠ d·ª•ng navigator.clipboard tr∆∞·ªõc
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(url).then(function() {
            const textDiv = btn.querySelector('.text');
            if (textDiv) {
                textDiv.textContent = 'ƒê√£ copy!';
                window.activeFeedbackCount++; // TƒÉng counter
                setTimeout(() => { 
                    textDiv.textContent = 'Copy Link'; 
                    window.activeFeedbackCount--; // Gi·∫£m counter
                }, 3000);
            }
        }).catch(function(err) {
            console.error('‚ùå Clipboard API failed:', err);
            // Fallback to execCommand
            fallbackCopyToClipboard(url, btn);
        });
    } else {
        // Fallback cho c√°c tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Clipboard API
        fallbackCopyToClipboard(url, btn);
    }
}

function fallbackCopyToClipboard(url, btn) {
    const textArea = document.createElement('textarea');
    textArea.value = url;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        
        if (successful) {
            const textDiv = btn.querySelector('.text');
            if (textDiv) {
                textDiv.textContent = 'ƒê√£ copy!';
                window.activeFeedbackCount++; // TƒÉng counter
                setTimeout(() => { 
                    textDiv.textContent = 'Copy Link'; 
                    window.activeFeedbackCount--; // Gi·∫£m counter
                }, 3000);
            }
        } else {
            console.error('‚ùå execCommand copy failed');
            // Th·ª≠ hi·ªÉn th·ªã feedback ngay c·∫£ khi copy th·∫•t b·∫°i
            const textDiv = btn.querySelector('.text');
            if (textDiv) {
                textDiv.textContent = 'Copy th·∫•t b·∫°i';
                setTimeout(() => { 
                    textDiv.textContent = 'Copy Link'; 
                }, 3000);
            }
            alert('Kh√¥ng th·ªÉ copy link. Vui l√≤ng copy th·ªß c√¥ng: ' + url);
        }
    } catch (err) {
        console.error('‚ùå execCommand copy error:', err);
        // Th·ª≠ hi·ªÉn th·ªã feedback ngay c·∫£ khi c√≥ l·ªói
        const textDiv = btn.querySelector('.text');
        if (textDiv) {
            textDiv.textContent = 'Copy th·∫•t b·∫°i';
            setTimeout(() => { 
                textDiv.textContent = 'Copy Link'; 
            }, 3000);
        }
        alert('Kh√¥ng th·ªÉ copy link. Vui l√≤ng copy th·ªß c√¥ng: ' + url);
    }
    
    document.body.removeChild(textArea);
}

function copyToClipboardWithCustomFeedback(url, btn, originalText, feedbackText) {
    const card = btn.closest('.file-card');
    const actionContainer = card ? card.querySelector('.file-action-container') : null;
    
    // Th·ª≠ s·ª≠ d·ª•ng navigator.clipboard tr∆∞·ªõc
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(url).then(function() {
            const textDiv = btn.querySelector('.text');
            if (textDiv) {
                textDiv.textContent = feedbackText;
                window.activeFeedbackCount++; // TƒÉng counter
                
                setTimeout(() => { 
                    textDiv.textContent = originalText; 
                    window.activeFeedbackCount--; // Gi·∫£m counter
                }, 3000);
            }
        }).catch(function(err) {
            console.error('‚ùå Clipboard API failed (custom feedback):', err);
            // Fallback to execCommand
            fallbackCopyToClipboardWithCustomFeedback(url, btn, originalText, feedbackText);
        });
    } else {
        // Fallback cho c√°c tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Clipboard API
        fallbackCopyToClipboardWithCustomFeedback(url, btn, originalText, feedbackText);
    }
}

function fallbackCopyToClipboardWithCustomFeedback(url, btn, originalText, feedbackText) {
    const textArea = document.createElement('textarea');
    textArea.value = url;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        
        if (successful) {
            const textDiv = btn.querySelector('.text');
            if (textDiv) {
                textDiv.textContent = feedbackText;
                window.activeFeedbackCount++; // TƒÉng counter
                setTimeout(() => { 
                    textDiv.textContent = originalText; 
                    window.activeFeedbackCount--; // Gi·∫£m counter
                }, 3000);
            }
        } else {
            console.error('‚ùå execCommand copy failed (custom feedback)');
            // Th·ª≠ hi·ªÉn th·ªã feedback ngay c·∫£ khi copy th·∫•t b·∫°i
            const textDiv = btn.querySelector('.text');
            if (textDiv) {
                textDiv.textContent = 'Copy th·∫•t b·∫°i';
                setTimeout(() => { 
                    textDiv.textContent = originalText; 
                }, 3000);
            }
            alert('Kh√¥ng th·ªÉ copy link. Vui l√≤ng copy th·ªß c√¥ng: ' + url);
        }
    } catch (err) {
        console.error('‚ùå execCommand copy error (custom feedback):', err);
        // Th·ª≠ hi·ªÉn th·ªã feedback ngay c·∫£ khi c√≥ l·ªói
        const textDiv = btn.querySelector('.text');
        if (textDiv) {
            textDiv.textContent = 'Copy th·∫•t b·∫°i';
            setTimeout(() => { 
                textDiv.textContent = originalText; 
            }, 3000);
        }
        alert('Kh√¥ng th·ªÉ copy link. Vui l√≤ng copy th·ªß c√¥ng: ' + url);
    }
    
    document.body.removeChild(textArea);
}
function copyToFacebook(url) {
    const fbUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
    navigator.clipboard.writeText(fbUrl).then(function() {
        alert('ƒê√£ copy link!');
    });
}

function toggleTikzCode(btn) {
    console.log('üîç toggleTikzCode ƒë∆∞·ª£c g·ªçi v·ªõi btn:', btn);
    console.log('üîç window.isLoggedIn:', window.isLoggedIn);
    
    // Ki·ªÉm tra ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi hi·ªÉn th·ªã code
    if (!window.isLoggedIn) {
        console.log('üîç Ch∆∞a ƒëƒÉng nh·∫≠p, hi·ªÉn th·ªã modal');
        // Hi·ªÉn th·ªã modal ƒëƒÉng nh·∫≠p
        showLoginModal();
        return;
    }
    
    console.log('üîç ƒê√£ ƒëƒÉng nh·∫≠p, ti·∫øp t·ª•c logic');
    
    // N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p, ti·∫øp t·ª•c logic c≈©
    const card = btn.closest('.file-card');
    console.log('üîç Card found:', card);
    
    const codeBlock = card.querySelector('.tikz-code-block');
    console.log('üîç Code block found:', codeBlock);
    
    const textarea = codeBlock ? codeBlock.querySelector('.tikz-cm') : null;
    console.log('üîç Textarea found:', textarea);
    
    if (!codeBlock || !textarea) {
        console.error('üîç Kh√¥ng t√¨m th·∫•y codeBlock ho·∫∑c textarea');
        return;
    }
    const textDiv = btn.querySelector('.text');
    console.log('üîç Code block display:', codeBlock.style.display);
    
    if (codeBlock.style.display === 'none' || !codeBlock.style.display) {
        console.log('üîç Hi·ªÉn th·ªã code block');
        codeBlock.style.display = 'block';
        let cmInstance = textarea.CodeMirror;
        if (!cmInstance) {
            console.log('üîç T·∫°o CodeMirror instance m·ªõi');
            const existingCm = codeBlock.querySelector('.CodeMirror');
            if (existingCm) existingCm.remove();
            cmInstance = CodeMirror.fromTextArea(textarea, {
                mode: 'stex',
                theme: 'material',
                lineNumbers: true,
                readOnly: true,
                viewportMargin: Infinity,
                scrollbarStyle: 'native'
            });
        } else {
            console.log('üîç S·ª≠ d·ª•ng CodeMirror instance hi·ªán c√≥');
        }
        setTimeout(() => {
            if (cmInstance && typeof cmInstance.refresh === 'function') {
                console.log('üîç Refresh CodeMirror');
                cmInstance.refresh();
            }
        }, 100);
        if (textDiv) {
            textDiv.textContent = '·∫®n code';
            console.log('üîç ƒê√£ ƒë·ªïi text th√†nh "·∫®n code"');
        }
    } else {
        console.log('üîç ·∫®n code block');
        codeBlock.style.display = 'none';
        if (textDiv) {
            textDiv.textContent = 'Xem Code';
            console.log('üîç ƒê√£ ƒë·ªïi text th√†nh "Xem Code"');
        }
    }
}

// H√†m hi·ªÉn th·ªã modal ƒëƒÉng nh·∫≠p
function showLoginModal() {
    document.getElementById('login-modal').style.display = 'flex';
}

// H√†m ƒë√≥ng modal ƒëƒÉng nh·∫≠p
function closeLoginModal() {
    document.getElementById('login-modal').style.display = 'none';
}

function copyTikzCode(btn) {
    // L·∫•y code t·ª´ CodeMirror instance n·∫øu c√≥, n·∫øu kh√¥ng th√¨ t·ª´ textarea g·ªëc
    const codeBlock = btn.closest('.tikz-code-block');
    const textarea = codeBlock.querySelector('.tikz-cm');
    let code = '';
    
    // ∆Øu ti√™n l·∫•y t·ª´ CodeMirror instance
    if (textarea.CodeMirror) {
        code = textarea.CodeMirror.getValue();
        console.log('Getting code from CodeMirror instance');
    } else {
        // Fallback: l·∫•y t·ª´ textarea g·ªëc
        code = textarea.value;
        console.log('Getting code from original textarea');
    }
    
    // Lo·∫°i b·ªè d√≤ng tr·∫Øng ·ªü ƒë·∫ßu v√† cu·ªëi, ch·ªâ gi·ªØ t·ªëi ƒëa 1 d√≤ng tr·∫Øng li√™n ti·∫øp
    let lines = code.split('\n');
    while (lines.length && lines[0].trim() === '') lines.shift();
    while (lines.length && lines[lines.length - 1].trim() === '') lines.pop();
    let cleaned = [];
    let lastBlank = false;
    for (let line of lines) {
        if (line.trim() === '') {
            if (!lastBlank) cleaned.push('');
            lastBlank = true;
        } else {
            cleaned.push(line);
            lastBlank = false;
        }
    }
    
    const finalCode = cleaned.join('\n');
    console.log('Copying code:', finalCode.substring(0, 100) + '...');
    
    // Copy code v√† hi·ªÉn th·ªã feedback
    const textArea = document.createElement('textarea');
    textArea.value = finalCode;
    textArea.style.position = 'fixed';
    textArea.style.opacity = 0;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    
    // Hi·ªÉn th·ªã feedback
    btn.innerHTML = '‚úÖ ƒê√£ copy!';
    setTimeout(() => {
        btn.innerHTML = 'üìã Copy';
    }, 3000);
}

function showDeleteModal(btn) {
  const card = btn.closest('.file-card');
  deleteCardElem = card;
  deleteSvgId = card.getAttribute('data-id');
  document.getElementById('delete-confirm-modal').style.display = 'flex';
}
</script>

    <!-- Modal ƒëƒÉng nh·∫≠p ƒë·ªÉ xem code -->
    <div id="login-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
      <div style="background:white; padding:32px 40px; border-radius:12px; box-shadow:0 4px 24px rgba(0,0,0,0.2); min-width:360px; text-align:center; max-width:90vw;">
        <div style="margin-bottom:24px;">
          <div style="font-size:48px; margin-bottom:16px;">üîí</div>
          <h3 style="margin-bottom:12px; color:#1976d2;">ƒêƒÉng nh·∫≠p ƒë·ªÉ xem code</h3>
          <p style="color:#666; font-size:14px; line-height:1.5;">B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem code TikZ g·ªëc c·ªßa h√¨nh ·∫£nh n√†y.</p>
        </div>
        <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
          <button id="modal-login-btn" style="display:flex; align-items:center; gap:8px; background:#1976d2; color:white; padding:12px 24px; border-radius:8px; border:none; font-weight:600; cursor:pointer; transition:background 0.2s;">
            <svg width="18" height="18" viewBox="0 0 24 24">
              <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            ƒêƒÉng nh·∫≠p v·ªõi Google
          </button>
          <button onclick="closeLoginModal()" style="background:#f5f5f5; color:#666; padding:12px 24px; border-radius:8px; border:none; font-weight:600; cursor:pointer; transition:background 0.2s;">Hu·ª∑</button>
        </div>
      </div>
    </div>

    <!-- Modal ƒëƒÉng xu·∫•t ch·ªâ render n·∫øu ƒë√£ login -->
    {% if user_email %}
    <div id="logout-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center;">
      <div style="background:white; padding:32px 40px; border-radius:12px; box-shadow:0 2px 16px rgba(0,0,0,0.15); min-width:320px; text-align:center;">
        <h3 style="margin-bottom:24px;">ƒêƒÉng xu·∫•t?</h3>
        <a href="/logout" style="display:inline-block; background:#d32f2f; color:white; padding:10px 28px; border-radius:6px; text-decoration:none; font-weight:bold;">ƒêƒÉng xu·∫•t</a>
        <button onclick="document.getElementById('logout-modal').style.display='none'" style="margin-left:18px; background:#eee; color:#333; padding:10px 28px; border-radius:6px; border:none; font-weight:bold;">Hu·ª∑</button>
      </div>
    </div>
    {% endif %}

    <!-- Modal cropper avatar -->
    <div id="avatar-cropper-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:10000; align-items:center; justify-content:center;">
      <div style="background:white; padding:32px 24px; border-radius:14px; box-shadow:0 2px 16px rgba(0,0,0,0.18); min-width:320px; text-align:center; position:relative;">
        <h3 style="margin-bottom:18px;">Ch·ªânh s·ª≠a ·∫£nh ƒë·∫°i di·ªán</h3>
        <div style="display:flex; justify-content:center; align-items:center;">
          <div style="width:220px; height:220px; border-radius:50%; overflow:hidden; background:#eee; display:flex; align-items:center; justify-content:center;">
            <img id="cropper-image" src="" style="max-width:100%; min-width:100%; min-height:100%; display:block;" alt="Cropper Preview">
          </div>
        </div>
        <div style="margin-top:18px;">
          <button type="button" id="crop-avatar-btn" class="btn btn-primary">C·∫Øt & L∆∞u</button>
          <button type="button" onclick="closeCropperModal()" class="btn btn-secondary">Hu·ª∑</button>
        </div>
      </div>
    </div>

    <!-- Modal x√°c nh·∫≠n x√≥a ·∫£nh -->
<div id="delete-confirm-modal" style="display:none; position:fixed; z-index:99999; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:10px; padding:32px 24px; min-width:300px; text-align:center; box-shadow:0 2px 16px rgba(0,0,0,0.18);">
    <h3 style="margin-bottom:18px;">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh n√†y?</h3>
    <div style="margin-bottom:18px; color:#d32f2f;">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</div>
    <button id="confirm-delete-btn" class="btn btn-primary" style="background:#d32f2f; color:#fff; margin-right:12px;">X√≥a</button>
    <button id="cancel-delete-btn" class="btn btn-secondary" style="background:#eee; color:#333;">H·ªßy</button>
  </div>
</div>

<script>

let deleteSvgId = null;
let deleteCardElem = null;

function showDeleteModal(btn) {
  const card = btn.closest('.file-card');
  deleteCardElem = card;
  deleteSvgId = card.getAttribute('data-id');
  document.getElementById('delete-confirm-modal').style.display = 'flex';
}

// X·ª≠ l√Ω khi nh·∫•n n√∫t "X√≥a" trong modal
document.getElementById('confirm-delete-btn').addEventListener('click', function() {
  if (deleteSvgId && deleteCardElem) {
    // G·ª≠i request x√≥a ·∫£nh
    fetch('/delete_svg', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({
        svg_image_id: deleteSvgId
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // X√≥a card kh·ªèi DOM
        deleteCardElem.remove();
        // ·∫®n modal
        document.getElementById('delete-confirm-modal').style.display = 'none';
        // Reset bi·∫øn
        deleteSvgId = null;
        deleteCardElem = null;
        // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
        alert('ƒê√£ x√≥a ·∫£nh th√†nh c√¥ng!');
      } else {
        alert(data.message || 'C√≥ l·ªói x·∫£y ra khi x√≥a ·∫£nh!');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('C√≥ l·ªói k·∫øt n·ªëi khi x√≥a ·∫£nh!');
    });
  }
});

// X·ª≠ l√Ω khi nh·∫•n n√∫t "H·ªßy" trong modal
document.getElementById('cancel-delete-btn').addEventListener('click', function() {
  // ·∫®n modal
  document.getElementById('delete-confirm-modal').style.display = 'none';
  // Reset bi·∫øn
  deleteSvgId = null;
  deleteCardElem = null;
});

// X·ª≠ l√Ω khi click b√™n ngo√†i modal ƒë·ªÉ ƒë√≥ng
document.getElementById('delete-confirm-modal').addEventListener('click', function(e) {
  if (e.target === this) {
    // ·∫®n modal
    this.style.display = 'none';
    // Reset bi·∫øn
    deleteSvgId = null;
    deleteCardElem = null;
  }
});
</script>

    <!-- JavaScript cho header -->
    <!-- ƒê√£ g·ªôp DOMContentLoaded v√†o cu·ªëi file -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
    
    <!-- CodeMirror libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/stex/stex.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material.min.css">
    <script>
    let cropper = null;
    let selectedFile = null;

    function openCropperModal(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                alert('File qu√° l·ªõn! Vui l√≤ng ch·ªçn file nh·ªè h∆°n 5MB.');
                input.value = '';
                return;
            }
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                alert('Ch·ªâ ch·∫•p nh·∫≠n file ·∫£nh: JPG, PNG, GIF');
                input.value = '';
                return;
            }
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('cropper-image');
                img.src = e.target.result;
                document.getElementById('avatar-cropper-modal').style.display = 'flex';
                // Destroy old cropper if exists
                if (cropper) cropper.destroy();
                cropper = new Cropper(img, {
                    aspectRatio: 1,
                    viewMode: 1,
                    dragMode: 'move',
                    background: false,
                    guides: false,
                    autoCropArea: 1,
                    movable: true,
                    zoomable: true,
                    rotatable: false,
                    scalable: false,
                    cropBoxResizable: false,
                    cropBoxMovable: false,
                    minContainerWidth: 220,
                    minContainerHeight: 220,
                    ready() {
                        // Cropper is ready
                    }
                });
            };
            reader.readAsDataURL(file);
        }
    }
    function closeCropperModal() {
        document.getElementById('avatar-cropper-modal').style.display = 'none';
        if (cropper) cropper.destroy();
        cropper = null;
        selectedFile = null;
        document.getElementById('avatar-input').value = '';
    }
    document.getElementById('crop-avatar-btn').addEventListener('click', function() {
        if (cropper) {
            // L·∫•y canvas h√¨nh tr√≤n
            const canvas = cropper.getCroppedCanvas({ width: 300, height: 300, imageSmoothingQuality: 'high' });
            // T·∫°o canvas tr√≤n
            const circleCanvas = document.createElement('canvas');
            circleCanvas.width = 300;
            circleCanvas.height = 300;
            const ctx = circleCanvas.getContext('2d');
            ctx.save();
            ctx.beginPath();
            ctx.arc(150, 150, 150, 0, 2 * Math.PI);
            ctx.closePath();
            ctx.clip();
            ctx.drawImage(canvas, 0, 0, 300, 300);
            ctx.restore();
            // Preview l√™n avatar
            const avatarPreview = document.getElementById('avatar-preview');
            if (avatarPreview) {
                avatarPreview.src = circleCanvas.toDataURL('image/png');
            } else {
                // N·∫øu ch∆∞a c√≥ img, thay th·∫ø placeholder
                const avatarPlaceholder = document.getElementById('avatar-placeholder');
                if (avatarPlaceholder) {
                    const newImg = document.createElement('img');
                    newImg.src = circleCanvas.toDataURL('image/png');
                    newImg.alt = 'Avatar Preview';
                    newImg.className = 'avatar';
                    newImg.id = 'avatar-preview';
                    avatarPlaceholder.parentNode.replaceChild(newImg, avatarPlaceholder);
                }
            }
            // T·∫°o file blob ƒë·ªÉ submit
            circleCanvas.toBlob(function(blob) {
                // T·∫°o file input ·∫©n ƒë·ªÉ submit
                let hiddenInput = document.getElementById('avatar-cropped-blob');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'avatar_cropped';
                    hiddenInput.id = 'avatar-cropped-blob';
                    document.querySelector('form').appendChild(hiddenInput);
                }
                // ƒê·ªçc blob th√†nh base64
                const reader = new FileReader();
                reader.onloadend = function() {
                    hiddenInput.value = reader.result;
                };
                reader.readAsDataURL(blob);
            }, 'image/png');
            closeCropperModal();
        }
    });
    </script>

<!-- ƒê√£ g·ªôp DOMContentLoaded v√†o cu·ªëi file -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
<script>
  function formatNumber(num) {
    if (num >= 1_000_000) return (num / 1_000_000).toFixed(1).replace(/\.0$/, '') + 'M';
    if (num >= 1_000) return (num / 1_000).toFixed(1).replace(/\.0$/, '') + 'K';
    return num.toString();
  }

  // ƒê√£ g·ªôp DOMContentLoaded v√†o cu·ªëi file
</script>
</body>
    <!-- Socket.IO Client (disabled for now) -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script> -->
    
    <!-- Quill Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script>
    // ƒê√£ g·ªôp DOMContentLoaded v√†o cu·ªëi file
</script>
</script>

<!-- G·ªòP T·∫§T C·∫¢ DOMContentLoaded V√ÄO ƒê√ÇY -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // ==== Logout button logic ====
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function (e) {
            e.preventDefault();
            const logoutModal = document.getElementById('logout-modal');
            if (logoutModal) logoutModal.style.display = 'flex';
        });
    }

    // ==== Google login button logic ====
    const googleLoginBtn = document.querySelector('.google-login-btn');
    if (googleLoginBtn) {
        googleLoginBtn.addEventListener('click', function (e) {
            e.preventDefault();
            const currentPath = window.location.pathname + window.location.search;
            fetch('/set_next_url?url=' + encodeURIComponent(currentPath))
                .then(() => window.location.href = '/login/google')
                .catch(error => {
                    console.error('Error setting next URL:', error);
                    window.location.href = '/login/google';
                });
        });
    }

    // ==== Profile toggle button logic ====
    const profileToggleBtn = document.getElementById('profile-toggle-btn');
    if (profileToggleBtn) {
        profileToggleBtn.addEventListener('click', function () {
            const profileContent = document.getElementById('profile-content');
            if (profileContent) {
                profileContent.classList.toggle('show');
                this.classList.toggle('active');
                const arrow = this.querySelector('.toggle-arrow');
                if (arrow) {
                    arrow.textContent = profileContent.classList.contains('show') ? '‚ñ≤' : '‚ñº';
                }
            }
        });
    }

    // ==== Quill Editor Initialization ====
    let quill;
    const bioEditor = document.getElementById('bio-editor');
    if (bioEditor) {
        quill = new Quill('#bio-editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline'],
                    [{ list: 'ordered' }, { list: 'bullet' }],
                    [{
                        color: [
                            '#000000', // ƒêen
                            '#ff0000', // ƒê·ªè
                            '#0000ff', // Xanh d∆∞∆°ng
                            '#008000', // Xanh l√°
                            '#ffa500', // Cam
                            '#800080', // T√≠m
                            '#ffc0cb', // H·ªìng
                            '#ffff00', // V√†ng
                            '#00ffff', // Cyan
                            '#ff4500', // Orange Red
                            '#32cd32', // Lime Green
                            '#4169e1', // Royal Blue
                            '#dc143c', // Crimson
                            '#20b2aa', // Light Sea Green
                            '#ff69b4', // Hot Pink
                            '#daa520'  // Goldenrod
                        ]
                    }],
                    ['clean']
                ]
            },
            placeholder: 'Vi·∫øt g√¨ ƒë√≥ v·ªÅ b·∫£n th√¢n...'
        });
        quill.on('text-change', function () {
            const bioHidden = document.getElementById('bio-hidden');
            if (bioHidden) bioHidden.value = quill.root.innerHTML;
        });
    }

    // ==== Profile form submission logic ====
    const profileForm = document.querySelector('form[method="POST"]');
    if (profileForm) {
        profileForm.addEventListener('submit', function () {
            if (quill) {
                const bioHidden = document.getElementById('bio-hidden');
                if (bioHidden) bioHidden.value = quill.root.innerHTML;
            }
            // Kh√¥ng prevent default ƒë·ªÉ form submit b√¨nh th∆∞·ªùng
            // Sau khi submit th√†nh c√¥ng, trang s·∫Ω reload v√† hi·ªÉn th·ªã t√™n m·ªõi
            console.log('Profile form submitted - page will reload to update username');
        });
    }

    // ==== X·ª≠ l√Ω touch device ====
    const isTouchDevice =
        ('ontouchstart' in window) ||
        (navigator.maxTouchPoints > 0) ||
        window.matchMedia('(hover: none)').matches ||
        window.matchMedia('(pointer: coarse)').matches;

    if (isTouchDevice) {
        document.documentElement.classList.add('is-touch');
        if (window.isLoggedIn) {
            initializeTouchBtnEvents();
        } else {
            initializeSimpleTouchEventsForNotLoggedIn();
        }
    }

    // ==== Init follow button UI state on load ====
    const followBtn = document.getElementById('public-follow-btn');
    if (followBtn) {
        const followed = followBtn.dataset.followed === "true";
        const followText = followBtn.querySelector('.follow-text');
        const followingText = followBtn.querySelector('.following-text');
        const followIcon = followBtn.querySelector('.follow-icon');
        const followingIcon = followBtn.querySelector('.following-icon');
        if (followed) {
            followBtn.classList.add('following');
            if (followText) followText.style.display = 'none';
            if (followingText) followingText.style.display = '';
            if (followIcon) followIcon.style.display = 'none';
            if (followingIcon) followingIcon.style.display = '';
        } else {
            followBtn.classList.remove('following');
            if (followText) followText.style.display = '';
            if (followingText) followingText.style.display = 'none';
            if (followIcon) followIcon.style.display = '';
            if (followingIcon) followingIcon.style.display = 'none';
        }
    }

    // ==== Like buttons for file-card ====
    initializeLikeButtons();

    // ==== Like buttons for followed-post-card ====
    initializeFollowedPostLikeButtons();

    // ==== Event delegation cho action-toggle-btn (ho·∫°t ƒë·ªông tr√™n c·∫£ desktop v√† mobile) ====
    document.addEventListener('click', function (e) {
        const btn = e.target.closest('.action-toggle-btn');
        if (btn) {
            const card = btn.closest('.file-card');
            if (card) {
                document.querySelectorAll('.file-card.active').forEach(other => {
                    if (other !== card) other.classList.remove('active');
                });
                card.classList.toggle('active');
            }
        }
    });

    // ==== ƒê√≥ng menu khi click b√™n ngo√†i (ch·ªâ khi kh√¥ng ph·∫£i l√† tap v√†o n√∫t trong menu) ====
    document.addEventListener('click', function (e) {
        const activeCard = document.querySelector('.file-card.active');
        if (activeCard) {
            // Ki·ªÉm tra flag preventClose
            if (activeCard.dataset.preventClose === 'true') {
                console.log('üîç NgƒÉn ƒë√≥ng menu do flag preventClose');
                return;
            }
            
            // N·∫øu click b√™n ngo√†i active card v√† kh√¥ng ph·∫£i l√† n√∫t .Btn ho·∫∑c .action-toggle-btn
            if (!activeCard.contains(e.target) && !e.target.closest('.Btn') && !e.target.closest('.action-toggle-btn')) {
                console.log('üîç ƒê√≥ng menu do click b√™n ngo√†i');
                activeCard.classList.remove('active');
            }
        }
    });

    // ==== Like polling cho t·∫•t c·∫£ file-card v√† followed-post-card ====
    startLikePolling();

    // ==== Follower count polling ====
    startFollowerCountPolling();

    // ==== Polling cho followed posts n·∫øu l√† ch·ªß profile ====
    const followedSection = document.querySelector('.followed-posts-section');
    if (followedSection && followedSection.dataset.isOwner === 'true') {
        loadFollowedPosts();
        startFollowedPostsPolling();
    }

    // ==== C·∫≠p nh·∫≠t like khi tab active l·∫°i ====
    document.addEventListener('visibilitychange', function () {
        if (!document.hidden) {
            const fileCards = document.querySelectorAll('.file-card');
            const fileIds = Array.from(fileCards)
                .map(card => card.dataset.id || card.dataset.postId)
                .filter(id => id);
            if (fileIds.length > 0) {
                fetch('/api/like_counts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ ids: fileIds })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data && typeof data === 'object') {
                            Object.keys(data).forEach(fileId => {
                                const fileData = data[fileId];
                                const fileCard = document.querySelector(`.file-card[data-id="${fileId}"]`)
                                    || document.querySelector(`.file-card[data-post-id="${fileId}"]`);
                                if (fileCard && fileData) {
                                    const likeButton = fileCard.querySelector('.like-button');
                                    if (likeButton) {
                                        const currentNumber = likeButton.querySelector('.like-count.one');
                                        const moveNumber = likeButton.querySelector('.like-count.two');
                                        const checkbox = likeButton.querySelector('input[type="checkbox"]');
                                        if (currentNumber && moveNumber) {
                                            const currentCount = parseInt(currentNumber.textContent) || 0;
                                            const newLikeCount = fileData.like_count || 0;
                                            if (currentCount !== newLikeCount) {
                                                currentNumber.textContent = newLikeCount;
                                                moveNumber.textContent = newLikeCount;
                                            }
                                            if (checkbox && fileData.is_liked_by_current_user !== undefined) {
                                                const currentChecked = checkbox.checked;
                                                const newChecked = fileData.is_liked_by_current_user;
                                                if (currentChecked !== newChecked) {
                                                    checkbox.checked = newChecked;
                                                    const event = new Event('change', { bubbles: true });
                                                    checkbox.dispatchEvent(event);
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    });
            }
        }
    });

    // ==== Event listener cho n√∫t "T·∫£i ·∫£nh" tr√™n Desktop (kh√¥ng ph·∫£i thi·∫øt b·ªã touch) ====
    document.addEventListener('click', function(e) {
        // Ch·ªâ √°p d·ª•ng cho desktop
        if (document.documentElement.classList.contains('is-touch')) return;

        // Debug: Log t·∫•t c·∫£ click events
        console.log('üîç Desktop click detected:', e.target);

        // Ch·ªâ √°p d·ª•ng cho n√∫t "T·∫£i ·∫£nh" trong file-card ho·∫∑c followed-post-card
        const btn = e.target.closest('.file-card .Btn[data-filename]');
        console.log('üîç Found button:', btn);
        
        if (btn) {
            console.log('üîç Button text:', btn.querySelector('.text')?.textContent);
            console.log('üîç Button filename:', btn.getAttribute('data-filename'));
            console.log('üîç Button has fb-share-btn class:', btn.classList.contains('fb-share-btn'));
        }
        
        // Ki·ªÉm tra ch√≠nh x√°c: ph·∫£i l√† n√∫t "T·∫£i ·∫£nh" v√† KH√îNG ph·∫£i n√∫t Facebook
        if (btn && 
            btn.querySelector('.text')?.textContent.trim() === 'T·∫£i ·∫£nh' && 
            !btn.classList.contains('fb-share-btn')) {
            
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            
            const filename = btn.getAttribute('data-filename');
            console.log('üîç Executing download for filename:', filename);
            if (filename) {
                window.location.href = `/?view_svg=${filename}`;
            }
        }
    }, true); // Th√™m capture phase ƒë·ªÉ g·ªçi tr∆∞·ªõc
});
// ... existing code ...
</script>
</html> 
<script>
// Follow/Unfollow AJAX logic
function toggleFollow(btn) {
    if (!btn) return;
    // Extract info
    const followeeId = btn.dataset.userId;
    let followed = btn.dataset.followed === "true";
    let count = parseInt(btn.dataset.count || "0");
    // Prevent double click
    btn.disabled = true;
    // Determine action and endpoint
    let url, action;
    if (!followed) {
        url = `/follow/${followeeId}`; // Use dynamic followee ID
        action = "follow";
    } else {
        url = `/unfollow/${followeeId}`; // Use dynamic followee ID
        action = "unfollow";
    }
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        body: JSON.stringify({})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Update UI
            followed = !followed;
            btn.dataset.followed = followed ? "true" : "false";
            if (followed) {
                count += 1;
            } else {
                count = Math.max(0, count - 1);
            }
            btn.dataset.count = count;
            // C·∫≠p nh·∫≠t follower count display
            const followerCountText = document.getElementById('follower-count-text');
            if (followerCountText) {
                followerCountText.textContent = count + ' followers';
            }
            if (followed) {
                btn.classList.add('following');
                btn.title = 'Unfollow';
            } else {
                btn.classList.remove('following');
                btn.title = 'Follow';
            }
        } else {
            alert(data.message || 'C√≥ l·ªói x·∫£y ra!');
        }
    })
    .catch(() => {
        alert('C√≥ l·ªói x·∫£y ra khi k·∫øt n·ªëi!');
    })
    .finally(() => {
        btn.disabled = false;
    });
}

// ‚úÖ ƒê√É G·ªòP V√ÄO DOMContentLoaded CH√çNH

// Like/Unlike functionality
function initializeLikeButtons() {
    document.querySelectorAll('input[id^="heart-"]').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const fileId = this.id.replace('heart-', '');
            const isLiked = this.checked;
            const likeButton = this.closest('.like-button');
            const currentNumber = likeButton.querySelector('.like-count.one');
            const moveNumber = likeButton.querySelector('.like-count.two');
            
            // Prevent double click
            this.disabled = true;
            
            // Send AJAX request to backend
            fetch('/like_svg', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    svg_id: fileId,
                    action: isLiked ? 'like' : 'unlike'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update UI with new like count
                    const newCount = data.like_count;
                    currentNumber.textContent = newCount;
                    moveNumber.textContent = newCount;
                    
                    // Update checkbox state based on server response
                    this.checked = data.is_liked;
                    
                    console.log(`‚úÖ ${data.message}: ${newCount} likes`);
                } else {
                    // Revert UI if backend failed
                    this.checked = !isLiked;
                    console.log(`‚ùå ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Revert UI on error
                this.checked = !isLiked;
                alert('C√≥ l·ªói k·∫øt n·ªëi!');
            })
            .finally(() => {
                this.disabled = false;
            });
        });
    });
    
    // ‚úÖ POLLING ƒê√É ƒê∆Ø·ª¢C CHUY·ªÇN V√ÄO DOMContentLoaded

}

// Load followed posts from API
function loadFollowedPosts() {
    console.log('üîÑ loadFollowedPosts called...');
    const container = document.getElementById('followed-posts-container');
    console.log('üîÑ Container found:', !!container);
    
    // Ki·ªÉm tra flag to√†n c·ª•c
    if (window.activeFeedbackCount > 0) {
        return;
    }
    
    fetch('/api/followed_posts')
        .then(response => {
            if (!response.ok) {
                if (response.status === 401) {
                    // User not logged in
                    container.innerHTML = `
                        <div class="no-followed-posts">
                            <div class="no-followed-posts-icon">üîí</div>
                            <h4>Ch∆∞a ƒëƒÉng nh·∫≠p</h4>
                            <p>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem b√†i ƒëƒÉng t·ª´ ng∆∞·ªùi b·∫°n theo d√µi</p>
                        </div>
                    `;
                    return;
                }
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(posts => {
            if (!posts) return;
            
            if (posts.length === 0) {
                container.innerHTML = `
                    <div class="no-followed-posts">
                        <div class="no-followed-posts-icon">üë•</div>
                        <h4>Ch∆∞a c√≥ b√†i ƒëƒÉng n√†o</h4>
                        <p>H√£y theo d√µi m·ªôt s·ªë ng∆∞·ªùi d√πng ƒë·ªÉ xem b√†i ƒëƒÉng c·ªßa h·ªç ·ªü ƒë√¢y</p>
                    </div>
                `;
                return;
            }
            
            // Render posts
            const postsHTML = posts.map(post => `
                <div class="file-card followed-post-card" data-post-id="${post.id}">
                  <button class="action-toggle-btn" type="button" aria-label="Hi·ªán menu h√†nh ƒë·ªông">‚ãØ</button>
                  <div class="file-info">
                    <div class="file-creator" style="margin-bottom: 0; font-size: 12px;">
                      üë§ <a href="/profile/${post.creator_id}" style="text-decoration: none; color: #1976d2; font-weight: 700; font-size: 13px;">
                        ${post.creator_username}
                      </a>
                      <span style="margin-left:8px; color: #666; font-size: 11px;">${post.created_time_vn}</span>
                    </div>
                  </div>
                  <div class="file-img-container">
                    <img src="${post.url}" alt="${post.filename}">
                  </div>
                  <div class="like-button-wrapper" style="position: absolute; bottom: 8px; right: 8px; z-index: 100;">
                    <div class="like-button">
                      <input id="followed-heart-${post.id}" type="checkbox" ${post.is_liked_by_current_user ? 'checked' : ''} />
                      <label class="like" for="followed-heart-${post.id}">
                        <svg class="like-icon" fill-rule="nonzero" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                          <path d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z"></path>
                        </svg>
                        <span class="like-text">Likes</span>
                      </label>
                      <span class="like-count one">${post.like_count}</span>
                      <span class="like-count two">${post.like_count}</span>
                    </div>
                  </div>
                  <div class="file-action-container">
                    <ul class="file-action-list">
                      <li class="file-action-item">
                        <button type="button" class="Btn" data-filename="${post.filename}">
                          <div class="sign">
                            <i class="fas fa-image logoIcon"></i>
                          </div>
                          <div class="text">T·∫£i ·∫£nh</div>
                        </button>
                      </li>
                     <li class="file-action-item">
                        <button type="button" class="Btn fb-share-btn" data-filename="${post.filename}" data-has-feedback="true">
                          <div class="sign">
                            <i class="fab fa-facebook logoIcon"></i>
                          </div>
                          <div class="text">Facebook</div>
                        </button>
                      </li>
                      <li class="file-action-item">
                        <button type="button" class="Btn file-copy-link-btn" data-url="https://tikz2svg.mathlib.io.vn/static/${post.filename}" data-has-feedback="true">
                          <div class="sign">
                            <i class="fas fa-link logoIcon"></i>
                          </div>
                          <div class="text">Copy Link</div>
                        </button>
                      </li>
                      ${post.tikz_code ? `
                      <li class="file-action-item">
                        <button type="button" class="Btn">
                          <div class="sign">
                            <i class="fas fa-code logoIcon"></i>
                          </div>
                          <div class="text">Xem Code</div>
                        </button>
                      </li>
                      ` : ''}

                    </ul>
                  </div>
                  
                  <!-- TikZ Code Section -->
                  ${post.tikz_code ? `
                  <div class="tikz-code-block" style="display:none; margin-top:10px;">
                    <div class="tikz-code-header">
                      <span>Code TikZ:</span>
                      <button class="copy-btn" onclick="copyTikzCode(this)">üìã Copy</button>
                    </div>
                    <div class="code-block">
                      <textarea class="tikz-cm" readonly>${post.tikz_code}</textarea>
                    </div>
                  </div>
                  ` : ''}
                </div>
            `).join('');
            
            container.innerHTML = postsHTML;
            
            // Initialize like buttons for followed posts
            initializeFollowedPostLikeButtons();
        })
        .catch(error => {
            console.error('Error loading followed posts:', error);
            container.innerHTML = `
                <div class="no-followed-posts">
                    <div class="no-followed-posts-icon">‚ùå</div>
                    <h4>L·ªói t·∫£i d·ªØ li·ªáu</h4>
                    <p>C√≥ l·ªói x·∫£y ra khi t·∫£i b√†i ƒëƒÉng. Vui l√≤ng th·ª≠ l·∫°i sau.</p>
                </div>
            `;
        });
}

// Toggle like for followed posts
function toggleFollowedPostLike(postId, button) {
    const isLiked = button.classList.contains('liked');
    const action = isLiked ? 'unlike' : 'like';
    
    fetch('/like_svg', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            svg_id: postId,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update button state
            if (data.is_liked) {
                button.classList.add('liked');
            } else {
                button.classList.remove('liked');
            }
            
            // Update like count
            const likeText = button.textContent.split(' ')[1]; // Get current count
            button.innerHTML = `‚ù§Ô∏è ${data.like_count} likes`;
            
            console.log(`‚úÖ ${data.message}: ${data.like_count} likes`);
        } else {
            console.log(`‚ùå ${data.message}`);
        }
    })
    .catch(error => {
        console.error('Error toggling like:', error);
        alert('C√≥ l·ªói khi thao t√°c like!');
    });
}



// Real-time synchronization via polling
function startLikePolling() {
    const pollInterval = 10000; // 10 seconds
    let lastUpdateTime = Date.now();
    
    console.log('üîÑ startLikePolling initialized with interval:', pollInterval, 'ms');
    
    setInterval(function() {
        // Get all file IDs on the page (both own files and followed posts)
        const fileCards = document.querySelectorAll('.file-card');
        const fileIds = Array.from(fileCards).map(card => {
            // Get ID from either data-id (regular files) or data-post-id (followed posts)
            return card.dataset.id || card.dataset.postId;
        }).filter(id => id); // Filter out undefined
        
        if (fileIds.length === 0) {
            console.log('üîÑ No file cards found for polling');
            return;
        }
        
        console.log('üîÑ Polling for', fileIds.length, 'files:', fileIds);
        
        // Fetch updated like counts
        fetch('/api/like_counts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                ids: fileIds // ‚úÖ S·ª≠a t·ª´ file_ids th√†nh ids ƒë·ªÉ match API
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data && typeof data === 'object') {
                // Update UI for changed files
                Object.keys(data).forEach(fileId => {
                    const fileData = data[fileId];
                    // Check both regular files (data-id) and followed posts (data-post-id)
                    const fileCard = document.querySelector(`.file-card[data-id="${fileId}"]`) || 
                                   document.querySelector(`.file-card[data-post-id="${fileId}"]`);
                    
                    if (fileCard && fileData) {
                        const likeButton = fileCard.querySelector('.like-button');
                        const likeCountSpan = fileCard.querySelector('.like-count.one');
                        const moveNumber = fileCard.querySelector('.like-count.two');
                        
                        // C·∫≠p nh·∫≠t cho tr∆∞·ªùng h·ª£p ƒë√£ ƒëƒÉng nh·∫≠p (c√≥ like-button)
                        if (likeButton && likeCountSpan && moveNumber) {
                            const currentCount = parseInt(likeCountSpan.textContent) || 0;
                            const newLikeCount = fileData.like_count || 0;
                            
                            // Update like count if changed
                            if (currentCount !== newLikeCount) {
                                likeCountSpan.textContent = newLikeCount;
                                moveNumber.textContent = newLikeCount;
                                console.log(`üîÑ Real-time update: File ${fileId} now has ${newLikeCount} likes (logged in)`);
                                
                                // Add visual feedback
                                likeButton.style.animation = 'pulse 0.5s ease-in-out';
                                setTimeout(() => {
                                    likeButton.style.animation = '';
                                }, 500);
                            }
                            
                            // Update checkbox state if changed
                            const checkbox = likeButton.querySelector('input[type="checkbox"]');
                            if (checkbox && fileData.is_liked_by_current_user !== undefined) {
                                const currentChecked = checkbox.checked;
                                const newChecked = fileData.is_liked_by_current_user;
                                
                                if (currentChecked !== newChecked) {
                                    checkbox.checked = newChecked;
                                    console.log(`üîÑ Real-time update: File ${fileId} like status changed to ${newChecked}`);
                                    
                                    // Trigger change event to update UI styling
                                    const event = new Event('change', { bubbles: true });
                                    checkbox.dispatchEvent(event);
                                }
                            }
                        }
                        // C·∫≠p nh·∫≠t cho tr∆∞·ªùng h·ª£p ch∆∞a ƒëƒÉng nh·∫≠p (kh√¥ng c√≥ like-button)
                        else {
                            const likeDisplayDiv = fileCard.querySelector('div[style*="position: absolute"][style*="bottom: 8px"][style*="right: 8px"]');
                            if (likeDisplayDiv) {
                                const likeCountText = likeDisplayDiv.querySelector('span[style*="font-weight: 600"]');
                                if (likeCountText) {
                                    const currentCount = parseInt(likeCountText.textContent) || 0;
                                    const newLikeCount = fileData.like_count || 0;
                                    
                                    // Update like count if changed
                                    if (currentCount !== newLikeCount) {
                                        likeCountText.textContent = newLikeCount;
                                        console.log(`üîÑ Real-time update: File ${fileId} now has ${newLikeCount} likes (not logged in)`);
                                        
                                        // Add visual feedback
                                        likeDisplayDiv.style.animation = 'pulse 0.5s ease-in-out';
                                        setTimeout(() => {
                                            likeDisplayDiv.style.animation = '';
                                        }, 500);
                                    }
                                }
                            }
                        }
                    }
                });
                
                lastUpdateTime = Date.now();
            }
        })
        .catch(error => {
            console.error('Polling error:', error);
        });
    }, pollInterval);
}

// Real-time follower count synchronization via polling
function startFollowerCountPolling() {
    // Ch·ªâ poll n·∫øu c√≥ follower count display v√† kh√¥ng ph·∫£i owner
    const followerCountDisplay = document.getElementById('follower-count-display');
    if (!followerCountDisplay) {
        console.log('üîÑ No follower count display found, skipping follower polling');
        return;
    }
    
    const pollInterval = 15000; // 15 seconds - √≠t th∆∞·ªùng xuy√™n h∆°n like
    let lastFollowerCount = null;
    
    // L·∫•y gi√° tr·ªã ban ƒë·∫ßu t·ª´ DOM
    const followerCountText = document.getElementById('follower-count-text');
    if (followerCountText) {
        const initialText = followerCountText.textContent;
        const match = initialText.match(/(\d+)\s+followers/);
        if (match) {
            lastFollowerCount = parseInt(match[1]);
            console.log('üîÑ Initial follower count from DOM:', lastFollowerCount);
        }
    }
    
    console.log('üîÑ startFollowerCountPolling initialized with interval:', pollInterval, 'ms');
    
    setInterval(function() {
        // L·∫•y user_id t·ª´ follower-count-display ho·∫∑c t·ª´ button follow
        const followerCountDisplay = document.getElementById('follower-count-display');
        const followBtn = document.getElementById('public-follow-btn');
        const userId = followerCountDisplay ? followerCountDisplay.dataset.userId : 
                      (followBtn ? followBtn.dataset.userId : null);
        
        if (!userId) {
            console.log('üîÑ No user ID found for follower polling');
            return;
        }
        
        console.log('üîÑ Polling follower count for user:', userId);
        
        // Fetch updated follower count
        fetch(`/api/follower_count/${userId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('üîÑ Follower API response:', data);
            if (data && data.success) {
                const newFollowerCount = data.follower_count || 0;
                console.log(`üîÑ Current follower count: ${lastFollowerCount}, New follower count: ${newFollowerCount}`);
                
                // C·∫≠p nh·∫≠t n·∫øu s·ªë follower thay ƒë·ªïi
                if (lastFollowerCount !== null && lastFollowerCount !== newFollowerCount) {
                    const followerCountText = document.getElementById('follower-count-text');
                    if (followerCountText) {
                        followerCountText.textContent = newFollowerCount + ' followers';
                        console.log(`üîÑ Real-time update: Follower count changed from ${lastFollowerCount} to ${newFollowerCount}`);
                        
                        // Th√™m hi·ªáu ·ª©ng visual
                        followerCountDisplay.style.animation = 'pulse 0.5s ease-in-out';
                        setTimeout(() => {
                            followerCountDisplay.style.animation = '';
                        }, 500);
                    }
                }
                
                lastFollowerCount = newFollowerCount;
            }
        })
        .catch(error => {
            console.error('Follower polling error:', error);
        });
    }, pollInterval);
}

// ‚úÖ ƒê√É G·ªòP V√ÄO DOMContentLoaded CH√çNH

// Real-time synchronization for followed posts via polling
function startFollowedPostsPolling() {
    console.log('üîÑ Starting followed posts polling...');
    const pollInterval = 15000; // 15 seconds - less frequent than like updates
    let lastFollowedPostsUpdate = Date.now();
    let currentPosts = [];
    
    setInterval(function() {
        console.log('üîÑ Polling followed posts...', new Date().toLocaleTimeString());
        const container = document.getElementById('followed-posts-container');
        if (!container) {
            console.log('‚ùå Container not found, stopping polling');
            return;
        }
        
        // Ki·ªÉm tra flag to√†n c·ª•c
        if (window.activeFeedbackCount > 0) {
            return;
        }
        
        // Fetch updated followed posts
        console.log('üîÑ Fetching /api/followed_posts...');
        fetch('/api/followed_posts')
            .then(response => {
                console.log('üîÑ API response status:', response.status);
                if (!response.ok) {
                    if (response.status === 401) {
                        console.log('‚ùå User not logged in, stopping polling');
                        // User logged out, stop polling
                        return null;
                    }
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(posts => {
                if (!posts) return;
                
                // Check if there are new posts or updates
                const hasNewPosts = posts.length !== currentPosts.length;
                const hasUpdates = posts.some((post, index) => {
                    const currentPost = currentPosts[index];
                    return !currentPost || 
                           currentPost.like_count !== post.like_count ||
                           currentPost.is_liked_by_current_user !== post.is_liked_by_current_user;
                });
                
                if (hasNewPosts || hasUpdates) {
                    console.log('üîÑ Followed posts updated, refreshing...');
                    
                    if (posts.length === 0) {
                        container.innerHTML = `
                            <div class="no-followed-posts">
                                <div class="no-followed-posts-icon">üë•</div>
                                <h4>Ch∆∞a c√≥ b√†i ƒëƒÉng n√†o</h4>
                                <p>H√£y theo d√µi m·ªôt s·ªë ng∆∞·ªùi d√πng ƒë·ªÉ xem b√†i ƒëƒÉng c·ªßa h·ªç ·ªü ƒë√¢y</p>
                            </div>
                        `;
                    } else {
                        // Render updated posts
                        const postsHTML = posts.map(post => `
                            <div class="file-card followed-post-card" data-post-id="${post.id}">
                              <button class="action-toggle-btn" type="button" aria-label="Hi·ªán menu h√†nh ƒë·ªông">‚ãØ</button>
                              <div class="file-info" style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                                <div class="file-creator" style="margin-bottom: 0; font-size: 12px;">
                                  üë§ <a href="/profile/${post.creator_id}" style="text-decoration: none; color: #1976d2; font-weight: 700; font-size: 13px;">
                                    ${post.creator_username}
                                  </a>
                                  <span style="margin-left:8px; color: #666; font-size: 11px;">${post.created_time_vn}</span>
                                </div>
                              </div>
                              <div class="file-img-container">
                                <img src="${post.url}" alt="${post.filename}">
                              </div>
                              <div class="like-button-wrapper" style="position: absolute; bottom: 8px; right: 8px; z-index: 100;">
                                <div class="like-button">
                                  <input id="followed-heart-${post.id}" type="checkbox" ${post.is_liked_by_current_user ? 'checked' : ''} />
                                  <label class="like" for="followed-heart-${post.id}">
                                    <svg class="like-icon" fill-rule="nonzero" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                      <path d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z"></path>
                                    </svg>
                                    <span class="like-text">Likes</span>
                                  </label>
                                  <span class="like-count one">${post.like_count}</span>
                                  <span class="like-count two">${post.like_count}</span>
                                </div>
                              </div>
                              <div class="file-action-container">
                                <ul class="file-action-list">
                                  <li class="file-action-item">
                                    <button type="button" class="Btn" data-filename="${post.filename}">
                                      <div class="sign">
                                        <i class="fas fa-image logoIcon"></i>
                                      </div>
                                      <div class="text">T·∫£i ·∫£nh</div>
                                    </button>
                                  </li>
                                  <li class="file-action-item">
                                    <button type="button" class="Btn fb-share-btn" data-filename="${post.filename}" data-has-feedback="true">
                                      <div class="sign">
                                        <i class="fab fa-facebook logoIcon"></i>
                                      </div>
                                      <div class="text">Facebook</div>
                                    </button>
                                  </li>
                                  <li class="file-action-item">
                                    <button type="button" class="Btn file-copy-link-btn" data-url="https://tikz2svg.mathlib.io.vn/static/${post.filename}" data-has-feedback="true">
                                      <div class="sign">
                                        <i class="fas fa-link logoIcon"></i>
                                      </div>
                                      <div class="text">Copy Link</div>
                                    </button>
                                  </li>
                                  ${post.tikz_code ? `
                                  <li class="file-action-item">
                                    <button type="button" class="Btn">
                                      <div class="sign">
                                        <i class="fas fa-code logoIcon"></i>
                                      </div>
                                      <div class="text">Xem Code</div>
                                    </button>
                                  </li>
                                  ` : ''}

                                </ul>
                              </div>
                              
                              <!-- TikZ Code Section -->
                              ${post.tikz_code ? `
                              <div class="tikz-code-block" style="display:none; margin-top:10px;">
                                <div class="tikz-code-header">
                                  <span>Code TikZ:</span>
                                  <button class="copy-btn" onclick="copyTikzCode(this)">üìã Copy</button>
                                </div>
                                <div class="code-block">
                                  <textarea class="tikz-cm" readonly>${post.tikz_code}</textarea>
                                </div>
                              </div>
                              ` : ''}
                            </div>
                        `).join('');
                        
                        container.innerHTML = postsHTML;
                        
                        // Initialize like buttons for new posts
                        initializeFollowedPostLikeButtons();
                        initializeTouchBtnEvents();  // üëà Th√™m d√≤ng n√†y
                        // Add visual feedback for updates
                        container.style.animation = 'fadeIn 0.5s ease-in-out';
                        setTimeout(() => {
                            container.style.animation = '';
                        }, 500);
                    }
                    
                    currentPosts = posts;
                    lastFollowedPostsUpdate = Date.now();
                    console.log(`‚úÖ Followed posts refreshed: ${posts.length} posts`);
                }
            })
            .catch(error => {
                console.error('Followed posts polling error:', error);
            });
    }, pollInterval);
    
    console.log('üîÑ Started followed posts polling (15s interval)');
}

// Initialize like buttons for followed posts
function initializeFollowedPostLikeButtons() {
    // Ch·ªâ kh·ªüi t·∫°o like buttons n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p
    if (!window.isLoggedIn) {
        return; // Kh√¥ng kh·ªüi t·∫°o n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
    }
    
    // Initialize like buttons
    document.querySelectorAll('input[id^="followed-heart-"]').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const fileId = this.id.replace('followed-heart-', '');
            const isLiked = this.checked;
            const likeButton = this.closest('.like-button');
            const currentNumber = likeButton.querySelector('.like-count.one');
            const moveNumber = likeButton.querySelector('.like-count.two');
            
            // Prevent double click
            this.disabled = true;
            
            // Send AJAX request to backend
            fetch('/like_svg', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    svg_id: fileId,
                    action: isLiked ? 'like' : 'unlike'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update UI with new like count
                    const newCount = data.like_count;
                    currentNumber.textContent = newCount;
                    moveNumber.textContent = newCount;
                    
                    // Update checkbox state based on server response
                    this.checked = data.is_liked;
                    
                    console.log(`‚úÖ Followed post ${data.message}: ${newCount} likes`);
                } else {
                    // Revert UI if backend failed
                    this.checked = !isLiked;
                    console.log(`‚ùå Followed post ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Revert UI on error
                this.checked = !isLiked;
                alert('C√≥ l·ªói k·∫øt n·ªëi!');
            })
            .finally(() => {
                this.disabled = false;
            });
        });
    });
    
    // Initialize Facebook share buttons for followed posts (ch·ªâ khi ƒë√£ ƒëƒÉng nh·∫≠p)
    if (window.isLoggedIn) {
        const followedFbShareBtns = document.querySelectorAll('.followed-post-card .fb-share-btn');
        console.log('üîÑ Found', followedFbShareBtns.length, 'followed-post fb-share-btn buttons');
        
        followedFbShareBtns.forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const filename = btn.getAttribute('data-filename');
                console.log('üîÑ followed-post fb-share-btn clicked, filename:', filename);
                
                if (!filename) {
                    console.error('‚ùå No filename found for followed-post fb-share-btn');
                    return;
                }
                
                const shareUrl = `${window.location.origin}/view_svg/${filename}`;
                console.log('üîÑ Followed-post Share URL:', shareUrl);
                
                // S·ª≠ d·ª•ng function copyToClipboard v·ªõi custom feedback
                copyToClipboardWithCustomFeedback(shareUrl, btn, 'Facebook', 'ƒê√£ copy!');
                
                console.log('‚úÖ followed-post fb-share-btn: Link copied successfully');
            });
        });
    }
    
    // Initialize copy link buttons for followed posts
    document.querySelectorAll('.followed-post-card .file-copy-link-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const url = this.getAttribute('data-url');
            copyToClipboard(url, this);
        });
    });
    
    // ==== Initialize Facebook share buttons for regular file cards (ho·∫°t ƒë·ªông cho c·∫£ ƒë√£ ƒëƒÉng nh·∫≠p v√† ch∆∞a ƒëƒÉng nh·∫≠p) ====
    // ƒê√É X√ìA LOGIC N√ÄY ƒê·ªÇ TR√ÅNH XUNG ƒê·ªòT V·ªöI LOGIC 2-TAP
    // const regularFbShareBtns = document.querySelectorAll('.file-card:not(.followed-post-card) .fb-share-btn');
    // console.log('üîÑ Initializing: Found', regularFbShareBtns.length, 'regular fb-share-btn buttons');
    
    // regularFbShareBtns.forEach(function(btn) {
    //     // Ki·ªÉm tra xem button c√≥ ƒëang hi·ªÉn th·ªã feedback kh√¥ng
    //     const textDiv = btn.querySelector('.text');
    //     const isShowingFeedback = textDiv && textDiv.textContent === 'ƒê√£ copy!';
        
    //     if (!isShowingFeedback) {
    //         // Ch·ªâ th√™m event listener n·∫øu button kh√¥ng ƒëang hi·ªÉn th·ªã feedback
    //         btn.addEventListener('click', function(e) {
    //             e.preventDefault();
    //             e.stopPropagation();
                
    //             const filename = btn.getAttribute('data-filename');
    //             console.log('üîÑ Initial fb-share-btn clicked, filename:', filename);
                
    //             if (!filename) {
    //                 console.error('‚ùå No filename found for initial fb-share-btn');
    //                 return;
    //             }
                
    //             const shareUrl = `${window.location.origin}/view_svg/${filename}`;
    //             console.log('üîÑ Initial Share URL:', shareUrl);
                
    //             // S·ª≠ d·ª•ng function copyToClipboard v·ªõi custom feedback
    //             copyToClipboardWithCustomFeedback(shareUrl, btn, 'Facebook', 'ƒê√£ copy!');
                
    //             console.log('‚úÖ Initial fb-share-btn: Link copied successfully');
    //         });
    //     } else {
    //         console.log('üîÑ Skipping fb-share-btn initialization - button is showing feedback');
    //     }
    // });
    
    // ==== Initialize Copy Link buttons for regular file cards (ho·∫°t ƒë·ªông cho c·∫£ ƒë√£ ƒëƒÉng nh·∫≠p v√† ch∆∞a ƒëƒÉng nh·∫≠p) ====
    const regularCopyLinkBtns = document.querySelectorAll('.file-card:not(.followed-post-card) .file-copy-link-btn');
    console.log('üîÑ Initializing: Found', regularCopyLinkBtns.length, 'regular file-copy-link-btn buttons');
    
    regularCopyLinkBtns.forEach(function(btn) {
        // Th√™m event listener n·∫øu ch∆∞a c√≥ onclick attribute
        if (!btn.hasAttribute('onclick')) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const url = btn.getAttribute('data-url') || btn.getAttribute('onclick');
                console.log('üîÑ Initial file-copy-link-btn clicked, url:', url);
                
                if (!url) {
                    console.error('‚ùå No URL found for initial file-copy-link-btn');
                    return;
                }
                
                // S·ª≠ d·ª•ng function copyToClipboard
                copyToClipboard(url, btn);
                
                console.log('‚úÖ Initial file-copy-link-btn: Link copied successfully');
            });
        }
    });
    

    
    // ==== Initialize touch button events ====
    initializeTouchBtnEvents();
    
    // ==== Universal copy button handler for mobile (backup) ====
    // ƒê√É X√ìA LOGIC N√ÄY ƒê·ªÇ TR√ÅNH XUNG ƒê·ªòT V·ªöI LOGIC TAP 2
    // document.addEventListener('click', function(e) {
    //     const btn = e.target.closest('.Btn');
    //     if (!btn) return;
    //     
    //     // Ch·ªâ x·ª≠ l√Ω tr√™n mobile v√† khi ch∆∞a ƒëƒÉng nh·∫≠p
    //     if (window.innerWidth <= 768 && !window.isLoggedIn) {
    //         // K√≠ch ho·∫°t card n·∫øu ch∆∞a active
    //         const card = btn.closest('.file-card');
    //         if (card && !card.classList.contains('active')) {
    //             document.querySelectorAll('.file-card.active').forEach(other => {
    //                 if (other !== card) other.classList.remove('active');
    //             });
    //             card.classList.add('active');
    //         }
    //         
    //         // X·ª≠ l√Ω fb-share-btn v·ªõi 1-tap logic (gi·ªëng ƒë√£ ƒëƒÉng nh·∫≠p)
    //         if (btn.classList.contains('fb-share-btn') && btn.hasAttribute('data-filename')) {
    //             e.preventDefault();
    //             e.stopPropagation();
    //             
    //             // Th·ª±c hi·ªán copy ngay l·∫≠p t·ª©c (1-tap)
    //             const filename = btn.getAttribute('data-filename');
    //             const shareUrl = `${window.location.origin}/view_svg/${filename}`;
    //             copyToClipboardWithCustomFeedback(shareUrl, btn, 'Facebook', 'ƒê√£ copy!');
    //             
    //             // KH√îNG reset tr·∫°ng th√°i, KH√îNG remove .active, KH√îNG remove hover
    //             // btn.dataset.tapCount = '0';
    //             // btn.classList.remove('individual-active', 'ready-to-execute');
    //             return;
    //         }
    //             
    //         // X·ª≠ l√Ω file-copy-link-btn v·ªõi 2-tap logic
    //         if (btn.classList.contains('file-copy-link-btn')) {
    //             e.preventDefault();
    //             e.stopPropagation();
    //             
    //             // L·∫•y ho·∫∑c t·∫°o tapCount
    //             if (!btn.dataset.tapCount) btn.dataset.tapCount = '0';
    //             const currentTapCount = parseInt(btn.dataset.tapCount);
    //             
    //             if (currentTapCount === 0) {
    //                 // TAP 1: Activate button
    //                 btn.classList.add('individual-active', 'ready-to-execute');
    //                 btn.dataset.tapCount = '1';
    //                 
    //                 // Auto reset sau 5s
    //                 setTimeout(() => {
    //                     if (btn.dataset.tapCount === '1') {
    //                         btn.classList.remove('individual-active', 'ready-to-execute');
    //                         btn.dataset.tapCount = '0';
    //                     }
    //                 }, 5000);
    //                 
    //                 return false;
    //             } else if (currentTapCount === 1) {
    //                 // TAP 2: Execute copy
    //                 let url = btn.getAttribute('data-url');
    //                 if (!url && btn.hasAttribute('onclick')) {
    //                     // Extract URL from onclick attribute
    //                     const onclickAttr = btn.getAttribute('onclick');
    //                     const match = onclickAttr.match(/copyToClipboard\('([^']+)'/);
    //                     if (match) {
    //                         url = match[1];
    //                     }
    //                 }
    //                 
    //                 if (url) {
    //                     copyToClipboard(url, btn);
    //                 }
    //                 
    //                 // Reset tap count nh∆∞ng KH√îNG remove class active ƒë·ªÉ gi·ªØ menu hi·ªÉn th·ªã
    //                 btn.dataset.tapCount = '0';
    //                 btn.classList.remove('individual-active', 'ready-to-execute');
    //                 // KH√îNG return ƒë·ªÉ ti·∫øp t·ª•c x·ª≠ l√Ω ·ªü logic th·ª© hai
    //             }
    //         }
    //     }
    // });
    
        // ==== Close active cards when clicking outside (for mobile when not logged in) ====
    // ƒê√É X√ìA LOGIC N√ÄY ƒê·ªÇ MENU KH√îNG T·ª∞ ƒê√ìNG
    // document.addEventListener('click', function(e) {
    //     // Ch·ªâ x·ª≠ l√Ω tr√™n mobile v√† khi ch∆∞a ƒëƒÉng nh·∫≠p
    //     if (window.innerWidth <= 768 && !window.isLoggedIn) {
    //         const clickedElement = e.target;
    //         const activeCard = document.querySelector('.file-card.active');
    //         
    //         // N·∫øu click b√™n ngo√†i active card v√† kh√¥ng ph·∫£i l√† n√∫t .Btn
    //         if (activeCard && !activeCard.contains(clickedElement) && !clickedElement.closest('.Btn')) {
    //             // Ki·ªÉm tra feedback tr∆∞·ªõc khi x√≥a active
    //             if (window.activeFeedbackCount > 0) {
    //                 return;
    //             }
    //             activeCard.classList.remove('active');
    //             // Reset t·∫•t c·∫£ n√∫t trong card
    //             activeCard.querySelectorAll('.Btn').forEach(btn => {
    //                 btn.classList.remove('individual-active', 'ready-to-execute');
    //                 btn.dataset.tapCount = '0';
    //             });
    //         }
    //     }
    // });
    
    // ==== Th√™m event listener ƒë·ªÉ theo d√µi t·∫•t c·∫£ c√°c thay ƒë·ªïi class active ====
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                const target = mutation.target;
                if (target.classList.contains('file-card')) {
                    // Observer ƒë·ªÉ theo d√µi thay ƒë·ªïi class (c√≥ th·ªÉ d√πng ƒë·ªÉ debug n·∫øu c·∫ßn)
                }
            }
        });
    });
    
    // B·∫Øt ƒë·∫ßu theo d√µi t·∫•t c·∫£ file-card
    document.querySelectorAll('.file-card').forEach(card => {
        observer.observe(card, { attributes: true, attributeFilter: ['class'] });
    });
    
    // ==== Re-initialize fb-share-btn after a short delay to ensure DOM is ready ====
    setTimeout(function() {
        initializeFbShareButtons();
    }, 100);
}

// Function to initialize Facebook share buttons
function initializeFbShareButtons() {
    // Initialize Facebook share buttons for regular file cards
    const regularFbShareBtns = document.querySelectorAll('.file-card:not(.followed-post-card) .fb-share-btn');
    console.log('üîÑ Re-initializing: Found', regularFbShareBtns.length, 'regular fb-share-btn buttons');
    
    regularFbShareBtns.forEach(function(btn) {
        // Ki·ªÉm tra xem button c√≥ ƒëang hi·ªÉn th·ªã feedback kh√¥ng
        const textDiv = btn.querySelector('.text');
        const isShowingFeedback = textDiv && textDiv.textContent === 'ƒê√£ copy!';
        
        if (!isShowingFeedback) {
            // Remove existing event listeners
            btn.replaceWith(btn.cloneNode(true));
            const newBtn = document.querySelector(`[data-filename="${btn.getAttribute('data-filename')}"]`);
            
            if (newBtn) {
                newBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const filename = newBtn.getAttribute('data-filename');
                    console.log('üîÑ Re-initialized fb-share-btn clicked, filename:', filename);
                    
                    if (!filename) {
                        console.error('‚ùå No filename found for re-initialized fb-share-btn');
                        return;
                    }
                    
                    const shareUrl = `${window.location.origin}/view_svg/${filename}`;
                    console.log('üîÑ Re-initialized Share URL:', shareUrl);
                    
                    // S·ª≠ d·ª•ng function copyToClipboard v·ªõi custom feedback
                    copyToClipboardWithCustomFeedback(shareUrl, newBtn, 'Facebook', 'ƒê√£ copy!');
                    
                    console.log('‚úÖ Re-initialized fb-share-btn: Link copied successfully');
                });
            }
        } else {
            console.log('üîÑ Skipping fb-share-btn re-initialization - button is showing feedback');
        }
    });
    
    // ==== Th√™m logic cho Desktop Facebook buttons (ƒë√£ ƒëƒÉng nh·∫≠p) ====
    if (!document.documentElement.classList.contains('is-touch')) {
        console.log('üñ•Ô∏è Adding Desktop Facebook button logic (logged in)');
        
        // Th√™m event listener cho Desktop Facebook buttons
        document.addEventListener('click', function(e) {
            const btn = e.target.closest('.file-card:not(.followed-post-card) .fb-share-btn');
            if (!btn) return;
            
            console.log('üñ•Ô∏è Desktop Facebook button clicked (logged in)');
            
            e.preventDefault();
            e.stopPropagation();
            
            const filename = btn.getAttribute('data-filename');
            if (!filename) {
                console.error('‚ùå No filename found for Desktop Facebook button');
                return;
            }
            
            const shareUrl = `${window.location.origin}/view_svg/${filename}`;
            console.log('üñ•Ô∏è Desktop Facebook Share URL:', shareUrl);
            
            // S·ª≠ d·ª•ng function copyToClipboard v·ªõi custom feedback
            copyToClipboardWithCustomFeedback(shareUrl, btn, 'Facebook', 'ƒê√£ copy!');
            
            console.log('‚úÖ Desktop Facebook button: Link copied successfully');
        });
    }
}

function initializeTouchBtnEvents() {
  if (!document.documentElement.classList.contains('is-touch')) return;

  const originalHandlers = new Map();

  // S·ª≠ d·ª•ng event delegation thay v√¨ g·∫Øn tr·ª±c ti·∫øp
  document.addEventListener('click', function(e) {
    const btn = e.target.closest('.Btn');
    if (!btn) return;
    
    // X·ª≠ l√Ω c√°c n√∫t .Btn trong card c√≥ class active
    if (btn.classList.contains('Btn')) {
      const card = btn.closest('.file-card');
      if (!card || !card.classList.contains('active')) return;

      // L·∫•y ho·∫∑c t·∫°o tapCount
      if (!btn.dataset.tapCount) btn.dataset.tapCount = '0';
      
      const currentTapCount = parseInt(btn.dataset.tapCount);
      
      if (currentTapCount === 0) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();

        // Reset c√°c n√∫t kh√°c
        card.querySelectorAll('.Btn').forEach(otherBtn => {
          if (otherBtn !== btn) {
            otherBtn.classList.remove('individual-active', 'ready-to-execute');
            otherBtn.dataset.tapCount = '0';
          }
        });

        btn.classList.add('individual-active', 'ready-to-execute');
        btn.dataset.tapCount = '1';

        // Auto reset sau 5s
        setTimeout(() => {
          if (btn.dataset.tapCount === '1') {
            btn.classList.remove('individual-active', 'ready-to-execute');
            btn.dataset.tapCount = '0';
          }
        }, 5000);
        
        return false;
      } 
      else if (currentTapCount === 1) {
        // TAP 2: Execute action
        
        // L·∫•y onclick handler
        let originalHandler;
        const onclickAttr = btn.getAttribute('onclick');
        if (onclickAttr) {
          originalHandler = new Function(onclickAttr);
        } else if (originalHandlers.has(btn)) {
          originalHandler = originalHandlers.get(btn);
        }

        if (originalHandler) {
          try {
            originalHandler.call(btn, e);
          } catch (error) {
            console.error('Error executing handler:', error);
          }
        }

        // ‚úÖ X·ª≠ l√Ω cho n√∫t "Facebook" (kh√¥ng c√≥ onclick)
        if (btn.classList.contains('fb-share-btn') && btn.hasAttribute('data-filename')) {
          const filename = btn.getAttribute('data-filename');
          const shareUrl = `${window.location.origin}/view_svg/${filename}`;
          copyToClipboardWithCustomFeedback(shareUrl, btn, 'Facebook', 'ƒê√£ copy!');
        }

        // ‚úÖ X·ª≠ l√Ω cho n√∫t "Copy Link" trong followed-post-card (kh√¥ng c√≥ onclick)
        if (btn.classList.contains('file-copy-link-btn') && btn.hasAttribute('data-url')) {
          const url = btn.getAttribute('data-url');
          copyToClipboard(url, btn);
        }

        // ‚úÖ X·ª≠ l√Ω cho n√∫t "X√≥a ·∫£nh" (kh√¥ng c√≥ onclick)
        if (btn.classList.contains('delete-btn')) {
          showDeleteModal(btn);
        }

        // ‚úÖ Th√™m x·ª≠ l√Ω cho n√∫t "T·∫£i ·∫£nh" (kh√¥ng c√≥ onclick)
        if (btn.querySelector('.text')?.textContent === 'T·∫£i ·∫£nh') {
          const filename = btn.getAttribute('data-filename');
          if (filename) {
            window.location.href = `/?view_svg=${filename}`;
          } else {
            console.error('Kh√¥ng t√¨m th·∫•y data-filename cho n√∫t T·∫£i ·∫£nh');
          }
          // Reset tr·∫°ng th√°i cho n√∫t T·∫£i ·∫£nh
          btn.dataset.tapCount = '0';
          btn.classList.remove('individual-active', 'ready-to-execute');
        }
        
        // ‚úÖ Th√™m x·ª≠ l√Ω cho n√∫t "Xem Code"
        const codeBtn = btn.querySelector('.text')?.textContent === 'Xem Code' || btn.querySelector('.text')?.textContent === '·∫®n code';
        
        if (btn.classList.contains('file-copy-link-btn')) {
          // X·ª≠ l√Ω feedback cho Copy Link (kh√¥ng c√≥ onclick)
          const textDiv = btn.querySelector('.text');
          if (textDiv) {
            const originalText = textDiv.textContent;
            textDiv.textContent = 'ƒê√£ copy!';
            
            setTimeout(() => {
              textDiv.textContent = originalText;
            }, 5000);
          }
          
          btn.dataset.tapCount = '0';
          btn.classList.remove('individual-active', 'ready-to-execute');
          
          // KH√îNG remove class active ƒë·ªÉ gi·ªØ nguy√™n file-action-container hi·ªÉn th·ªã
          // Gi·ªëng nh∆∞ fb-share-btn
        } 
        // ‚úÖ X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho n√∫t "Xem Code" - KH√îNG ·∫©n menu
        else if (codeBtn) {
          // G·ªçi function toggleTikzCode ƒë·ªÉ hi·ªÉn th·ªã/·∫©n code
          toggleTikzCode(btn);
          
          btn.dataset.tapCount = '0';
          btn.classList.remove('individual-active', 'ready-to-execute');
          
          // KH√îNG ·∫©n menu, ƒë·ªÉ user c√≥ th·ªÉ ti·∫øp t·ª•c thao t√°c
          // Menu s·∫Ω t·ª± ·∫©n khi user click b√™n ngo√†i
        } 
        else {
          // C√°c n√∫t kh√°c: KH√îNG ·∫©n menu ƒë·ªÉ user c√≥ th·ªÉ ti·∫øp t·ª•c thao t√°c
          btn.dataset.tapCount = '0';
          btn.classList.remove('individual-active', 'ready-to-execute');
          
          // ƒê√É X√ìA LOGIC T·ª∞ ƒê√ìNG MENU
          // setTimeout(() => {
          //   // Ki·ªÉm tra feedback tr∆∞·ªõc khi x√≥a active
          //   if (window.activeFeedbackCount > 0) {
          //     return;
          //   }
          //   card.classList.remove('active');
          //   card.querySelectorAll('.Btn').forEach(b => {
          //     b.classList.remove('individual-active', 'ready-to-execute');
          //     b.dataset.tapCount = '0';
          //   });
          // }, 500);
        }
        
        return false;
      }
    }
  }, true); // Capture phase
}

// Function x·ª≠ l√Ω touch events ƒë∆°n gi·∫£n cho tr∆∞·ªùng h·ª£p ch∆∞a ƒëƒÉng nh·∫≠p
function initializeSimpleTouchEventsForNotLoggedIn() {
  if (!document.documentElement.classList.contains('is-touch')) return;
  if (window.isLoggedIn) return; // Ch·ªâ x·ª≠ l√Ω cho tr∆∞·ªùng h·ª£p ch∆∞a ƒëƒÉng nh·∫≠p

  // Logic 2-tap gi·ªëng nh∆∞ ƒë√£ ƒëƒÉng nh·∫≠p
  document.addEventListener('click', function(e) {
    const btn = e.target.closest('.Btn');
    if (!btn) return;
    
    const card = btn.closest('.file-card');
    if (!card) return;

    if (!card.classList.contains('active')) {
        // M·ªü menu tr∆∞·ªõc, kh√¥ng th·ª±c thi l·ªánh ngay
        document.querySelectorAll('.file-card.active').forEach(other => {
            if (other !== card) {
                other.classList.remove('active');
            }
        });
        card.classList.add('active');
        // Ch·ªâ m·ªü menu, ch·ªù tap ti·∫øp theo m·ªõi th·ª±c thi l·ªánh
        return;
    }
    
    // Ch·ªâ x·ª≠ l√Ω cho tr∆∞·ªùng h·ª£p ch∆∞a ƒëƒÉng nh·∫≠p
    if (window.isLoggedIn) return;
    
    // L·∫•y ho·∫∑c t·∫°o tapCount
    if (!btn.dataset.tapCount) btn.dataset.tapCount = '0';
    const currentTapCount = parseInt(btn.dataset.tapCount);
    
    if (currentTapCount === 0) {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();

      // Reset c√°c n√∫t kh√°c
      card.querySelectorAll('.Btn').forEach(otherBtn => {
        if (otherBtn !== btn) {
          otherBtn.classList.remove('individual-active', 'ready-to-execute');
          otherBtn.dataset.tapCount = '0';
        }
      });

      btn.classList.add('individual-active', 'ready-to-execute');
      btn.dataset.tapCount = '1';

      // Auto reset sau 5s
      setTimeout(() => {
        if (btn.dataset.tapCount === '1') {
          btn.classList.remove('individual-active', 'ready-to-execute');
          btn.dataset.tapCount = '0';
        }
      }, 5000);
      
      return false;
    } 
    else if (currentTapCount === 1) {
      // TAP 2: Execute action
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      console.log('üîç TAP 2: B·∫Øt ƒë·∫ßu th·ª±c thi l·ªánh');
      
      // X·ª≠ l√Ω c√°c n√∫t theo lo·∫°i
      if (btn.classList.contains('fb-share-btn') && btn.hasAttribute('data-filename')) {
        console.log('üîç TAP 2: X·ª≠ l√Ω n√∫t Facebook');
        const filename = btn.getAttribute('data-filename');
        const shareUrl = `${window.location.origin}/view_svg/${filename}`;
        copyToClipboardWithCustomFeedback(shareUrl, btn, 'Facebook', 'ƒê√£ copy!');
        console.log('üîç TAP 2: ƒê√£ g·ªçi copyToClipboardWithCustomFeedback');
      }
      else if (btn.classList.contains('file-copy-link-btn')) {
        console.log('üîç TAP 2: X·ª≠ l√Ω n√∫t Copy Link');
        let url = btn.getAttribute('data-url');
        if (!url && btn.hasAttribute('onclick')) {
          const onclickAttr = btn.getAttribute('onclick');
          const match = onclickAttr.match(/copyToClipboard\('([^']+)'/);
          if (match) url = match[1];
        }
        if (url) {
          copyToClipboardWithCustomFeedback(url, btn, 'Copy Link', 'ƒê√£ copy!');
          console.log('üîç TAP 2: ƒê√£ g·ªçi copyToClipboardWithCustomFeedback cho Copy Link');
        }
      }
      else if (btn.classList.contains('delete-btn')) {
        console.log('üîç TAP 2: X·ª≠ l√Ω n√∫t Delete');
        showDeleteModal(btn);
      }
      else if (btn.querySelector('.text')?.textContent === 'Xem Code' || btn.querySelector('.text')?.textContent === '·∫®n code') {
        console.log('üîç TAP 2: X·ª≠ l√Ω n√∫t Xem Code');
        toggleTikzCode(btn);
      }
      else if (btn.querySelector('.text')?.textContent === 'T·∫£i ·∫£nh') {
        console.log('üîç TAP 2: X·ª≠ l√Ω n√∫t T·∫£i ·∫£nh');
        const filename = btn.getAttribute('data-filename');
        if (filename) {
          window.location.href = `/?view_svg=${filename}`;
        } else {
          console.error('üîç TAP 2: Kh√¥ng t√¨m th·∫•y data-filename cho n√∫t T·∫£i ·∫£nh');
        }
      }

      // Reset tap count nh∆∞ng KH√îNG remove classes ƒë·ªÉ gi·ªØ highlight cho feedback
      btn.dataset.tapCount = '0';
      // KH√îNG remove classes ngay - ƒë·ªÉ copyToClipboardWithCustomFeedback t·ª± x·ª≠ l√Ω
      // btn.classList.remove('individual-active', 'ready-to-execute');
      
      console.log('üîç TAP 2: ƒê√£ reset tr·∫°ng th√°i, ki·ªÉm tra menu c√≥ c√≤n active kh√¥ng');
      console.log('üîç TAP 2: Card active:', card.classList.contains('active'));
      
      // Delay reset ƒë·ªÉ tr√°nh conflict v·ªõi CSS animation
      setTimeout(() => {
        console.log('üîç TAP 2: Sau 100ms - Card active:', card.classList.contains('active'));
        
        // Ki·ªÉm tra file-action-container
        const actionContainer = card.querySelector('.file-action-container');
        if (actionContainer) {
          const computedStyle = window.getComputedStyle(actionContainer);
          console.log('üîç TAP 2: file-action-container display:', computedStyle.display);
          console.log('üîç TAP 2: file-action-container opacity:', computedStyle.opacity);
          console.log('üîç TAP 2: file-action-container visibility:', computedStyle.visibility);
        }
      }, 100);
      
      // Th√™m flag ƒë·ªÉ ngƒÉn ƒë√≥ng menu trong 500ms
      card.dataset.preventClose = 'true';
      setTimeout(() => {
        delete card.dataset.preventClose;
        console.log('üîç TAP 2: ƒê√£ x√≥a flag preventClose');
      }, 500);
      
      // KH√îNG remove class active ƒë·ªÉ gi·ªØ nguy√™n file-action-container hi·ªÉn th·ªã
      return false;
    }
  });
}

// G√°n s·ª± ki·ªán cho n√∫t ƒëƒÉng nh·∫≠p trong modal
const modalLoginBtn = document.getElementById('modal-login-btn');
if (modalLoginBtn) {
    modalLoginBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const currentUrl = window.location.pathname;
        window.location.href = "{{ url_for('set_next_url') }}?url=" + encodeURIComponent(currentUrl);
    });
}

// ==== Th√™m logic cho Desktop buttons (ch∆∞a ƒëƒÉng nh·∫≠p) ====
// Ch·ªâ th√™m logic n√†y n·∫øu th·ª±c s·ª± l√† Desktop (kh√¥ng ph·∫£i touch device)
if (!document.documentElement.classList.contains('is-touch') && !window.isLoggedIn) {
    console.log('üñ•Ô∏è Adding Desktop button logic (not logged in)');
    
    // Th√™m event listener cho Desktop Facebook buttons khi ch∆∞a ƒëƒÉng nh·∫≠p
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.file-card:not(.followed-post-card) .fb-share-btn');
        if (!btn) return;
        
        // Ki·ªÉm tra l·∫°i xem c√≥ ph·∫£i Desktop kh√¥ng (ƒë·ªÉ tr√°nh conflict v·ªõi mobile)
        if (document.documentElement.classList.contains('is-touch')) {
            console.log('üñ•Ô∏è Skipping Desktop logic - detected touch device');
            return;
        }
        
        console.log('üñ•Ô∏è Desktop Facebook button clicked (not logged in)');
        
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        const filename = btn.getAttribute('data-filename');
        if (!filename) {
            console.error('‚ùå No filename found for Desktop Facebook button (not logged in)');
            return;
        }
        
        const shareUrl = `${window.location.origin}/view_svg/${filename}`;
        console.log('üñ•Ô∏è Desktop Facebook Share URL (not logged in):', shareUrl);
        
        // S·ª≠ d·ª•ng function copyToClipboard v·ªõi custom feedback
        copyToClipboardWithCustomFeedback(shareUrl, btn, 'Facebook', 'ƒê√£ copy!');
        
        console.log('‚úÖ Desktop Facebook button (not logged in): Link copied successfully');
    });
    
    // Th√™m event listener cho Desktop Copy Link buttons khi ch∆∞a ƒëƒÉng nh·∫≠p
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.file-card:not(.followed-post-card) .file-copy-link-btn');
        if (!btn) return;
        
        // Ki·ªÉm tra l·∫°i xem c√≥ ph·∫£i Desktop kh√¥ng (ƒë·ªÉ tr√°nh conflict v·ªõi mobile)
        if (document.documentElement.classList.contains('is-touch')) {
            console.log('üñ•Ô∏è Skipping Desktop logic - detected touch device');
            return;
        }
        
        console.log('üñ•Ô∏è Desktop Copy Link button clicked (not logged in)');
        
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        const url = btn.getAttribute('data-url');
        if (!url) {
            console.error('‚ùå No URL found for Desktop Copy Link button (not logged in)');
            return;
        }
        
        console.log('üñ•Ô∏è Desktop Copy Link URL (not logged in):', url);
        
        // S·ª≠ d·ª•ng function copyToClipboard v·ªõi custom feedback
        copyToClipboardWithCustomFeedback(url, btn, 'Copy Link', 'ƒê√£ copy!');
        
        console.log('‚úÖ Desktop Copy Link button (not logged in): Link copied successfully');
    });
}
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>