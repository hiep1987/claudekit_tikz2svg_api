{% extends "base.html" %}

{# Configuration flags #}
{% set include_highlight_js = true %}
{% set include_codemirror = true %}
{% set include_navigation = true %}
{% set include_login_modal = true %}
{% set include_navbar = true %}
{% set include_mathjax = true %}

{# Page-specific meta tags #}
{% block meta %}
<meta name="description" content="Xem v√† chia s·∫ª h√¨nh TikZ SVG tr·ª±c tuy·∫øn - {{ display_name }}">
<meta property="og:title" content="TikZ to SVG - {{ display_name }}" />
<meta property="og:type" content="website" />
<meta property="og:image" content="{{ request.host_url.rstrip('/') ~ png_url }}" />
<meta property="og:url" content="{{ request.host_url.rstrip('/') ~ url_for('view_svg', filename=filename) }}" />
<meta property="og:description" content="Xem v√† chia s·∫ª h√¨nh TikZ SVG tr·ª±c tuy·∫øn." />
{% endblock %}

{# Page title #}
{% block title %}Xem SVG - {{ display_name }}{% endblock %}

{# Body attributes for authentication #}
{% block body_attrs %} data-is-logged-in="{% if user_email %}true{% else %}false{% endif %}" data-set-next-url="{{ url_for('set_next_url') }}"{% endblock %}

{# Additional CSS #}
{% block extra_css %}
<!-- View SVG Page CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/view_svg.css', v='2.0') }}">
{% endblock %}

{# Main content #}
{% block content %}

<!-- View SVG Section -->
<div class="view-svg-container">
    <h2 class="view-svg-title">{{ display_name }}</h2>
    
    <div id="view-mode-row">
        <div class="view-col">
            <div id="view-svg-preview">
                <img id="view-svg-img" src="{{ svg_url }}" alt="Xem tr∆∞·ªõc h√¨nh ·∫£nh SVG - {{ display_name }}" aria-describedby="svg-description">
            </div>
            <div id="view-svg-actions">
                <button id="view-copy-link-btn" class="view-action-btn" aria-label="Sao ch√©p li√™n k·∫øt ƒë·∫øn file SVG n√†y">üîó Copy Link</button>
                <button id="view-download-svg-btn" class="view-action-btn view-download-btn" aria-label="T·∫£i xu·ªëng file SVG">üì• T·∫£i xu·ªëng SVG</button>
            </div>
        </div>
        <div class="view-col">
            <div class="actions-header">
                <div class="actions-list">
                    <button id="view-back-to-edit-btn" aria-label="Quay v·ªÅ trang ch·ªânh s·ª≠a code TikZ">‚Ü©Ô∏è Quay v·ªÅ ch·ªânh s·ª≠a code TikZ</button>
                </div>
            </div>
            <div id="view-export-section">
                <div class="export-section">
                    <h4>Xu·∫•t ·∫£nh PNG/JPEG</h4>
                    <form id="view-export-form" class="export-form">
                        <div class="export-pair">
                            <label for="view-export-format" class="export-label">ƒê·ªãnh d·∫°ng:</label>
                            <select id="view-export-format" class="export-input export-select">
                                <option value="png">PNG</option>
                                <option value="jpeg">JPEG</option>
                            </select>
                        </div>
                        <div class="export-pair">
                            <label for="view-export-dpi" class="export-label">DPI:</label>
                            <input type="number" id="view-export-dpi" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-pair">
                            <label for="view-export-width" class="export-label">Width (px):</label>
                            <input type="number" id="view-export-width" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-pair">
                            <label for="view-export-height" class="export-label">Height (px):</label>
                            <input type="number" id="view-export-height" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-btn-group">
                            <button id="view-export-btn" type="button" class="export-btn" aria-label="T·∫£i xu·ªëng file ·∫£nh PNG ho·∫∑c JPEG">T·∫£i xu·ªëng</button>
                        </div>
                    </form>
                    <div id="view-export-msg" class="export-msg"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Caption Section -->
<div class="image-caption-section">
    <h3 class="caption-section-title">
        <span class="caption-icon">üìù</span> M√¥ t·∫£ ·∫£nh
    </h3>
    
    <!-- Caption Display Mode -->
    <div id="caption-display" class="caption-content" {% if not caption or not caption.strip() %}style="display: none;"{% endif %}>
        <div class="caption-text">{{ caption|safe if caption else '' }}</div>
    </div>
    
    <!-- Empty State (when no caption) -->
    <div id="caption-empty" class="caption-empty" {% if caption and caption.strip() %}style="display: none;"{% endif %}>
        <p class="caption-empty-text">
            {% if user_email and user_id and current_user.is_authenticated and user_id == current_user.id %}
                Ch∆∞a c√≥ m√¥ t·∫£. Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ th√™m m√¥ t·∫£ cho ·∫£nh.
            {% else %}
                ·∫¢nh n√†y ch∆∞a c√≥ m√¥ t·∫£.
            {% endif %}
        </p>
    </div>
    
    <!-- Edit Form (only visible when editing) -->
    <div id="caption-edit-form" class="caption-edit-form" style="display: none;">
        <textarea 
            id="caption-input" 
            class="caption-textarea"
            placeholder="Th√™m m√¥ t·∫£ cho ·∫£nh c·ªßa b·∫°n. H·ªó tr·ª£ c√¥ng th·ª©c to√°n: $x^2$, $$\int_{0}^{1} x dx$$"
            maxlength="5000"
        >{{ caption if caption else '' }}</textarea>
        <div class="caption-form-footer">
            <div class="caption-char-count">
                <span id="caption-char-current">{{ caption|length if caption else 0 }}</span>/5000 k√Ω t·ª±
            </div>
            <div class="caption-actions">
                <button id="cancel-caption-btn" class="caption-btn caption-btn-cancel">
                    ‚ùå H·ªßy
                </button>
                <button id="save-caption-btn" class="caption-btn caption-btn-save">
                    ‚úÖ L∆∞u
                </button>
            </div>
        </div>
        <div class="caption-preview">
            <h4>Preview (v·ªõi MathJax):</h4>
            <div id="caption-preview-content" class="caption-preview-content"></div>
        </div>
    </div>
    
    <!-- Edit Button (only for owner) -->
    {% if user_email and user_id and current_user.is_authenticated and user_id == current_user.id %}
    <button id="edit-caption-btn" class="edit-caption-btn">
        <span class="edit-icon">‚úèÔ∏è</span> 
        <span class="edit-text">{{ 'Ch·ªânh s·ª≠a m√¥ t·∫£' if caption else 'Th√™m m√¥ t·∫£' }}</span>
    </button>
    {% endif %}
    
    <!-- Messages -->
    <div id="caption-message" class="caption-message"></div>
</div>

<!-- Inject TikZ code as JSON to avoid inline Jinja inside JS -->
<script id="tikz-code-json" type="application/json">{{ tikz_code|default("")|tojson|safe }}</script>

<!-- Inject caption data for JavaScript -->
<script id="caption-data-json" type="application/json">
{
    "filename": {{ filename|tojson|safe }},
    "caption": {{ caption|tojson|safe }},
    "isOwner": {% if user_email and user_id and current_user.is_authenticated and user_id == current_user.id %}true{% else %}false{% endif %}
}
</script>
{% endblock %}

{# Additional JavaScript #}
{% block extra_js %}
<!-- Application JavaScript -->
<script src="{{ url_for('static', filename='js/view_svg.js', v='1.0') }}"></script>
{% endblock %}