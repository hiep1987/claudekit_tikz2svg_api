<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TikZ to SVG</title>
    <!-- Highlight.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material.min.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
    
    <!-- Custom Tailwind-like CSS for Navigation Bar -->
    <style>
        /* Tailwind-like utility classes for production */
        .w-full { width: 100%; }
        .max-w-7xl { max-width: 80rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .bg-white\/80 { background-color: rgba(255, 255, 255, 0.8); }
        .backdrop-blur { backdrop-filter: blur(8px); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .rounded-2xl { border-radius: 1rem; }
        .p-3 { padding: 0.75rem; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .mb-8 { margin-bottom: 2rem; }
        .gap-2 { gap: 0.5rem; }
        .bg-gradient-to-br { background-image: linear-gradient(to bottom right, var(--tw-gradient-stops)); }
        .from-blue-500 { --tw-gradient-from: #3b82f6; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(59, 130, 246, 0)); }
        .to-yellow-400 { --tw-gradient-to: #fbbf24; }
        .p-1\.5 { padding: 0.375rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .text-white { color: #ffffff; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-gray-800 { color: #1f2937; }
        .font-bold { font-weight: 700; }
        .hidden { display: none; }
        .md\:flex { }
        .gap-6 { gap: 1.5rem; }
        .font-medium { font-weight: 500; }
        .text-gray-700 { color: #374151; }
        .relative { position: relative; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .cursor-pointer { cursor: pointer; }
        .transition { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .hover\:text-blue-600:hover { color: #2563eb; }
        .block { display: block; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .md\:block { }
        .bg-gradient-to-r { background-image: linear-gradient(to right, var(--tw-gradient-stops)); }
        .from-red-400 { --tw-gradient-from: #f87171; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(248, 113, 113, 0)); }
        .to-red-600 { --tw-gradient-to: #dc2626; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .py-1\.5 { padding-top: 0.375rem; padding-bottom: 0.375rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .hover\:scale-105:hover { transform: scale(1.05); }
        .font-semibold { font-weight: 600; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .from-blue-400 { --tw-gradient-from: #60a5fa; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(96, 165, 250, 0)); }
        .to-yellow-400 { --tw-gradient-to: #fbbf24; }
        .md\:hidden { }
        .hover\:bg-blue-100:hover { background-color: #dbeafe; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-gray-500 { color: #6b7280; }
        .hover\:text-blue-400:hover { color: #60a5fa; }
        .fixed { position: fixed; }
        .top-0 { top: 0px; }
        .left-0 { left: 0px; }
        .h-full { height: 100%; }
        .bg-black\/50 { background-color: rgba(0, 0, 0, 0.5); }
        .z-40 { z-index: 40; }
        .absolute { position: absolute; }
        .right-0 { right: 0px; }
        .w-60 { width: 15rem; }
        .bg-white { background-color: #ffffff; }
        .flex-col { flex-direction: column; }
        .p-6 { padding: 1.5rem; }
        .gap-3 { gap: 0.75rem; }
        .self-end { align-self: flex-end; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5px; }
        .mt-2 { margin-top: 0.5rem; }
        .text-center { text-align: center; }
        .mt-8 { margin-top: 2rem; }
        .w-6 { width: 1.5rem; }
        .h-6 { height: 1.5rem; }
        .rounded-full { border-radius: 9999px; }
        .to-purple-600 { --tw-gradient-to: #9333ea; }
        .justify-center { justify-content: center; }
        
        /* Responsive breakpoints */
        @media (min-width: 768px) {
            .md\:flex { display: flex; }
            .md\:block { display: block; }
            .md\:hidden { display: none; }
        }
        
        /* New Navigation Styles */
        .menu-underline {
          transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
          height: 3px;
          width: 0;
          background: linear-gradient(90deg, #fbbf24, #38bdf8);
          border-radius: 2px;
          margin: 0 auto;
          position: absolute;
          bottom: -2px;
          left: 50%;
          transform: translateX(-50%);
        }
        .menu-item:hover .menu-underline, .menu-item.active .menu-underline {
          width: 80%;
        }
        
        /* Override custom CSS for menu items to remove unwanted styling */
        .menu-item {
          list-style: none !important;
        }
        
        .menu-item a {
          text-decoration: none !important;
          color: #374151 !important;
        }
        
        .menu-item:hover a {
          color: #2563eb !important;
        }
        
        /* Remove any bullet points or underlines from menu */
        .hidden.md\\:flex {
          list-style: none !important;
          padding: 0 !important;
          margin: 0 !important;
        }
        
        .hidden.md\\:flex li {
          list-style: none !important;
        }
        
        .hidden.md\\:flex li a {
          text-decoration: none !important;
        }
        
        /* Fix mobile menu styling */
        #mobile-menu a {
          text-decoration: none !important;
          color: #374151 !important;
        }
        
        #mobile-menu a:hover {
          color: #2563eb !important;
        }
    </style>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        h2 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
        }
        textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        /* ==== N√∫t ch√≠nh: Bi√™n d·ªãch, L∆∞u server, T·∫£i xu·ªëng, Xem code SVG, Copy Code ==== */
        .btn-action,
        .compile-save-row-btn,
        .export-btn,
        .copy-btn {
          background: linear-gradient(90deg, #1976d2 0%, #2196f3 100%);
          color: #fff;
          padding: 12px 28px;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          text-decoration: none;
          box-shadow: 0 2px 8px rgba(25, 118, 210, 0.1);
          transition: background 0.3s, box-shadow 0.2s, transform 0.15s;
          width: auto;
          height: auto;
        }

        .btn-action:hover,
        .compile-save-row-btn:hover,
        .export-btn:hover,
        .copy-btn:hover {
          background: linear-gradient(90deg, #1565c0 0%, #42a5f5 100%);
          color: #fff;
          box-shadow: 0 4px 16px rgba(25, 118, 210, 0.18);
          transform: translateY(-2px) scale(1.03);
          outline: none;
          text-decoration: none;
        }

        /* ==== Responsive (mobile) ==== */
        @media (max-width: 1000px) {
          .compile-save-row-btn {
            width: 100%;
            min-width: 0;
            font-size: 16px;
            padding: 14px 0;
            border-radius: 8px;
            margin-bottom: 10px;
            height: 48px;
            box-sizing: border-box;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
          }
        }
        
        @media (max-width: 600px) {
          .btn-action,
          .compile-save-row-btn,
          .export-btn,
          .copy-btn {
            width: 100%;
            min-width: 0;
            font-size: 17px;
            padding: 14px 0;
            border-radius: 8px;
            margin-bottom: 10px;
            height: 48px;
            box-sizing: border-box;
          }
        }
        button:hover {
            background-color: #0056b3;
        }
        .result-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .file-info {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .file-info h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
        .file-info p {
            margin: 5px 0;
            color: #333;
        }
        .svg-preview {
            text-align: center;
            margin-bottom: 20px;
        }
        .svg-preview img {
            max-width: 100%;
            border: 2px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .code-section {
            margin-top: 4px;
            text-align: center;
        }
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .code-title {
            font-weight: bold;
            color: #333;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            position: relative;
        }
        .code-block pre {
            margin: 0;
            padding: 15px;
            background: transparent;
        }
        .code-block code {
            background: transparent;
            padding: 0;
        }
        .download-link {
            display: inline-block;
            background-color: #17a2b8;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            margin-top: 10px;
        }
        .download-link:hover {
            background-color: #138496;
        }
        .copy-link-btn {
            display: inline-block;
            background-color: #ffc107;
            color: #212529;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            margin-top: 10px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
        }
        .copy-link-btn:hover {
            background-color: #e0a800;
        }
        .error {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 5px;
        }
        .files-section {
            margin-top: 40px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .files-section h3 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            width: 100%;
            box-sizing: border-box;
        }
        .file-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .file-card img {
            width: 100%;
            height: 150px;
            object-fit: contain;
            border: 1px solid #eee;
            border-radius: 3px;
            margin-bottom: 10px;
        }
        .file-card h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 14px;
        }
        .file-card p {
            margin: 3px 0;
            font-size: 12px;
            color: #666;
        }
        .file-actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .file-actions a, .file-actions button {
            padding: 5px 10px;
            text-decoration: none;
            border-radius: 3px;
            font-size: 11px;
            flex: 1;
            text-align: center;
        }
        .view-btn {
            background-color: #007bff;
            color: white;
        }
        .view-btn:hover {
            background-color: #0056b3;
        }
        .fb-share-btn:hover {
            background-color: #1464c7 !important;
        }
        .download-btn {
            background-color: #28a745;
            color: white;
        }
        .file-copy-link-btn {
            background-color: #ffc107;
            color: #212529;
            border: none;
        }
        .file-copy-link-btn:hover {
            background-color: #e0a800;
        }
        /* Hover effects cho n√∫t trong view-mode-row */
        #view-copy-link-btn:hover {
            background-color: #e0a800 !important;
        }
        #view-download-svg-btn:hover {
            background-color: #138496 !important;
        }
        .no-files {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        .export-section {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .export-section h4 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }
        .export-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px 32px;
            align-items: start;
            margin-bottom: 10px;
        }
        @media (min-width: 1000px) {
            .export-form {
                grid-template-columns: 1fr 1fr 1fr 1fr;
            }
        }
        .export-pair {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .export-form .export-btn-group {
            grid-column: 1/-1;
            display: flex;
            justify-content: center;
            margin-top: 8px;
        }
        .export-form .export-btn {
            min-width: 160px;
        }
        .export-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .export-select {
            width: 90%;
            min-width: 120px;
            max-width: 180px;
            height: 40px;
            padding: 8px 12px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            box-sizing: border-box;
            vertical-align: middle;
        }
        .export-number {
            width: 100px;
        }
        .export-msg {
            margin-top: 5px;
            color: #388e3c;
            font-weight: bold;
            text-align: center;
            width: 100%;
            display: flex;
            justify-content: center;
        }
        #export-msg, #view-export-msg {
            margin-top: 0;
            text-align: center;
            width: 100%;
            display: flex;
            justify-content: center;
        }
        /* Layout 2 c·ªôt cho ch·∫ø ƒë·ªô nh·∫≠p v√† xem - C·∫£i ti·∫øn responsive */
        #input-preview-row, #view-mode-row {
            display: flex;
            gap: 32px;
            margin-bottom: 24px;
            /* Th√™m overflow-x cho mobile scroll */
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #ccc transparent;
        }
        
        /* Form kh√¥ng c√≥ vi·ªÅn ƒë·ªÉ t·ªëi gi·∫£n nh∆∞ y√™u c·∫ßu */
        #tikz-form {
            background: transparent;
            padding: 0;
            margin-bottom: 0;
            border: none;
            border-radius: 0;
            box-shadow: none;
        }
        
        /* T√πy ch·ªânh scrollbar cho webkit browsers */
        #input-preview-row::-webkit-scrollbar, #view-mode-row::-webkit-scrollbar {
            height: 8px;
        }
        
        #input-preview-row::-webkit-scrollbar-track, #view-mode-row::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        #input-preview-row::-webkit-scrollbar-thumb, #view-mode-row::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        #input-preview-row::-webkit-scrollbar-thumb:hover, #view-mode-row::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Firefox scrollbar */
        #input-preview-row, #view-mode-row {
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 #f1f1f1;
        }
        
        #input-preview-row .input-col, #input-preview-row .preview-col, #view-mode-row .view-col {
            flex: 1;
            min-width: 0;
            /* Th√™m min-width cho mobile */
            min-width: 300px;
        }
        #input-preview-row .preview-col, #view-svg-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            border: 1.5px solid #eee;
            border-radius: 8px;
            min-height: 320px;
            min-width: 200px;
            padding: 16px;
            /* Th√™m chi·ªÅu cao t·ªëi ƒëa v√† t·ªëi thi·ªÉu gi·ªëng .preview-col */
            height: 400px;
            max-height: 100%;
            width: 100%;
            box-sizing: border-box;
        }
        #input-preview-row .preview-col img, #view-svg-preview img {
            max-width: 100%;
            max-height: 100%;
            min-height: 200px;
            min-width: 200px;
            display: block;
            margin: 0 auto;
            object-fit: contain;
        }
        /* TƒÉng chi·ªÅu cao CodeMirror trong view-mode-row */
        #view-mode-row .CodeMirror {
            height: 320px !important;
            min-height: 320px !important;
            max-height: 100% !important;
        }
        /* TƒÉng chi·ªÅu cao CodeMirror trong input-preview-row */
        #input-preview-row .CodeMirror {
            height: 320px !important;
            min-height: 320px !important;
            max-height: 100% !important;
        }
        /* CSS cho result-tools-section */
        #result-tools-section {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .preview-placeholder {
            text-align: center;
            color: #999;
            font-style: italic;
        }
        .preview-placeholder p {
            margin: 0;
            font-size: 16px;
        }
        /* Responsive cho input-preview-row v√† view-mode-row */
        @media (max-width: 768px) {
            #input-preview-row, #view-mode-row {
                gap: 16px;
                margin-bottom: 16px;
                /* ƒê·∫£m b·∫£o c√≥ th·ªÉ scroll ngang */
                min-width: calc(100vw - 40px);
                max-width: none;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 10px; /* Th√™m space cho scrollbar */
                padding: 16px;
            }
            
            #tikz-form { padding: 0; box-shadow: none; }
            
            /* Container b√™n ngo√†i kh√¥ng c√≥ vi·ªÅn */
            .input-preview-section .container {
                padding: 20px;
                margin: 0;
                background: #fff;
            }
            
            #input-preview-row .input-col, #input-preview-row .preview-col, #view-mode-row .view-col {
                min-width: 300px;
                flex-shrink: 0;
                flex-basis: 300px;
            }
            
            /* TƒÉng font size cho CodeMirror tr√™n mobile */
            #input-preview-row .CodeMirror, #view-mode-row .CodeMirror {
                font-size: 16px !important;
            }
            
            /* TƒÉng padding cho preview col tr√™n mobile */
            #input-preview-row .preview-col, #view-svg-preview {
                padding: 12px;
                min-height: 280px;
            }
        }
        
        @media (max-width: 480px) {
            #input-preview-row, #view-mode-row {
                gap: 12px;
                min-width: calc(100vw - 30px);
                padding-bottom: 8px;
                border: 2px solid #3e9f06;
                border-radius: 8px;
                padding: 12px;
                background: #fff;
                box-shadow: 0 2px 8px rgba(62, 159, 6, 0.2);
            }
            
            #input-preview-row .input-col, #input-preview-row .preview-col, #view-mode-row .view-col {
                min-width: 280px;
                flex-basis: 280px;
            }
            
            #input-preview-row .preview-col, #view-svg-preview {
                padding: 8px;
                min-height: 250px;
            }
            
            /* C·∫£i thi·ªán touch targets tr√™n mobile */
            .compile-save-row-btn {
                min-height: 44px;
                font-size: 16px;
                padding: 12px 20px;
            }
            
            /* TƒÉng k√≠ch th∆∞·ªõc n√∫t tr√™n mobile */
            .btn-action, .export-btn, .copy-btn {
                min-height: 44px;
                font-size: 16px;
                padding: 12px 20px;
            }
        }
        
        /* C·∫£i thi·ªán tr·∫£i nghi·ªám touch cho CodeMirror */
        .CodeMirror {
            touch-action: manipulation;
        }
        
        /* Th√™m transition cho mobile hint */
        #mobile-scroll-hint {
            transition: opacity 0.3s ease;
        }
        
        /* CSS cho 3 block layout m·ªõi */
        .input-preview-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 40px 0;
            margin-bottom: 0;
            border-bottom: 1px solid #e1e8ed;
            overflow-x: hidden; /* NgƒÉn horizontal scroll c·ªßa section */
        }
        
        /* CSS theo demo - table-scroll-x */
        .table-scroll-x {
            overflow-x: auto;
            width: 100%;
            -webkit-overflow-scrolling: touch;
            border: 1px solid #3e9f06;
            border-radius: 6px;
            background: #fff;
        }
        
        .table-content {
            display: flex;
            min-width: 900px;
        }
        
        .col {
            flex: 0 0 450px;
            max-width: 450px;
            min-width: 450px;
            height: 450px;
            min-height: 450px;
            max-height: 450px;
            padding: 16px;
            border-right: 1px solid #eee;
            box-sizing: border-box;
            overflow: auto;
        }

        /* Make the left column form layout fill the 450px height with CodeMirror + controls */
        .table-scroll-x .table-content .col form#tikz-form {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        /* Fallback: tr∆∞·ªõc khi CodeMirror kh·ªüi t·∫°o, cho textarea chi·∫øm kh√¥ng gian */
        .table-scroll-x .table-content .col form#tikz-form textarea#code {
            flex: 1 1 auto;
        }
        .table-scroll-x .table-content .col form#tikz-form .CodeMirror {
            flex: 1 1 auto;
            height: auto !important;
            min-height: 0 !important;
            max-height: none !important;
        }
        /* 4px gap between CodeMirror and the compile/save row */
        #compile-save-row {
            margin-top: 4px;
        }
        /* ƒê·∫£m b·∫£o c·ªôt tr√°i (Code + n√∫t) d√πng tr·ªçn 450px chi·ªÅu cao n·ªôi dung */
        .table-scroll-x .table-content .col:first-child {
            padding-top: 0;
            padding-bottom: 0;
            padding-left: 16px;
            padding-right: 16px;
        }
        
        .col:last-child {
            border-right: none;
        }
        
        @media (max-width: 950px) {
            .table-content {
                min-width: 100vw;
            }
        }
        
        .files-section-container {
            background: #f8f9fa;
            padding: 40px 0;
            border-top: 1px solid #e1e8ed;
        }
        
        /* Responsive cho c√°c block */
        @media (max-width: 768px) {
            .input-preview-section,
            .files-section-container {
                padding: 20px 0;
            }
        }
        
        @media (max-width: 480px) {
            .input-preview-section,
            .files-section-container {
                padding: 15px 0;
            }
        }
        
        /* Responsive cho files-section */
        @media (max-width: 768px) {
            .files-section {
                margin-top: 20px;
                padding: 15px;
            }
            
            .files-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 12px;
            }
            
            .file-card {
                padding: 12px;
            }
            
            .file-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .file-actions a, .file-actions button {
                padding: 8px 12px;
                font-size: 12px;
                min-height: 36px;
            }
        }
        
        @media (max-width: 600px) {
            .files-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .file-card {
                padding: 15px;
            }
            
            .file-card img {
                height: 120px;
            }
        }
        
        @media (max-width: 480px) {
            .files-section {
                margin-top: 15px;
                padding: 10px;
            }
            
            .files-grid {
                gap: 10px;
            }
            
            .file-card {
                padding: 12px;
            }
            
            .file-card img {
                height: 100px;
            }
            
            .file-actions {
                gap: 6px;
            }
            
            .file-actions a, .file-actions button {
                padding: 6px 10px;
                font-size: 11px;
                min-height: 32px;
            }
            
            .container {
                padding: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .input-preview-section .container {
                overflow-x: visible; /* Cho ph√©p scroll ngang trong container */
                padding-left: 10px;
                padding-right: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .input-preview-section .container {
                padding: 15px;
                margin: 0;
                background: #fff;
            }
            
            #input-preview-row, #view-mode-row {
                padding: 12px;
            }
            
            #tikz-form { padding: 0; box-shadow: none; }
        }
        
        /* Responsive export-form: ch·ªâ 1 c·ªôt khi max-width: 600px */
        @media (max-width: 600px) {
            .export-form {
                grid-template-columns: 1fr;
            }
        }
        /* Line numbers */
        .hljs-ln-numbers {
            text-align: right;
            color: #999;
            border-right: 1px solid #ddd;
            vertical-align: top;
            padding-right: 8px !important;
            min-width: 25px;
            }
        .hljs-ln-code {
            padding-left: 8px !important;
        }
        /* View mode code editor */
        #view-tikz-code {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            position: relative;
        }
        #view-tikz-code pre {
            margin: 0;
            padding: 15px;
            background: transparent;
        }
        #view-tikz-code code {
            background: transparent;
            padding: 0;
        }
        .CodeMirror {
            height: 220px;
            font-size: 15px;
            border-radius: 6px;
            border: 1.5px solid #bbb;
            background: #f8f9fa;
            overflow: auto;
        }
        
        /* ƒê·∫£m b·∫£o CodeMirror trong tikz-code-block c√≥ scrollbar ƒë·∫πp */
        .tikz-code-block .CodeMirror {
            max-height: 300px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 5px;
        }
        
        /* T√πy ch·ªânh scrollbar cho CodeMirror */
        .tikz-code-block .CodeMirror-scrollbar-filler {
            background-color: #f0f0f0;
        }
        
        .tikz-code-block .CodeMirror-simplescroll-horizontal div,
        .tikz-code-block .CodeMirror-simplescroll-vertical div {
            background-color: #c1c1c1;
            border-radius: 10px;
        }
        
        /* ·∫®n textarea g·ªëc khi CodeMirror ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o */
        .tikz-code-block .tikz-cm {
            display: none;
        }
        .CodeMirror-placeholder {
            color: #bbb !important;
            font-style: italic;
        }
        /* Fix gutter/line number width for CodeMirror */
        .CodeMirror-gutter, .CodeMirror-gutters, .CodeMirror-linenumbers {
            width: 2.5em !important;
            min-width: 2.5em !important;
        }
        .CodeMirror-linenumber, .CodeMirror-gutter-elt {
            min-width: 2em !important;
            width: 2em !important;
            text-align: right !important;
            padding-right: 0.5em !important;
            box-sizing: content-box !important;
        }
        .export-form .export-col:first-child {
            max-width: 220px;
        }
        @media (max-width: 900px) {
            .export-select {
                min-width: 100px;
                max-width: 100%;
            }
        }

        .preview-col {
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            border-radius: 8px;
        }
        .compile-save-row-btn {
            min-width: 160px;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 5px;
            height: 48px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        #compile-btn.compile-save-row-btn {
            background-color: #007bff;
            color: white;
            border: none;
        }
        #compile-btn.compile-save-row-btn:hover {
            background-color: #0056b3;
        }
        #save-server-btn.compile-save-row-btn:hover {
            background-color: #e0a800;
        }
        .export-download-link {
            display: inline-block;
            background: linear-gradient(90deg, #17a2b8 0%, #138496 100%);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(23,162,184,0.2);
            margin-top: 8px;
        }

        .export-download-link:hover {
            background: linear-gradient(90deg, #138496 0%, #117a8b 100%);
            box-shadow: 0 4px 12px rgba(23,162,184,0.3);
            transform: translateY(-2px);
            color: white;
            text-decoration: none;
        }
        .export-btn-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #export-msg {
            margin-top: 0;
            text-align: center;
        }
        .export-btn-group {
            width: 100%;
        }
        #svg-code-container {
          transition: all 0.3s ease;
        }
        
        /* Hover effects cho c√°c n√∫t trong view mode */
        #view-copy-link-btn:hover {
            background: #e0a800 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,193,7,0.3) !important;
        }
        
        #view-download-svg-btn:hover {
            background: #138496 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(23,162,184,0.3) !important;
            text-decoration: none;
        }
        
        #view-back-to-edit-btn:hover {
            background: linear-gradient(90deg, #218838 0%, #1ea085 100%) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40,167,69,0.3) !important;
        }
        /* Layout 2 h√†ng cho export-form trong view mode */
        #view-export-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        #view-export-form .export-btn-group {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            margin-top: 16px;
        }
        #view-export-form .export-btn {
            min-width: 140px;
        }
        /* Responsive cho export-form trong view mode */
        @media (max-width: 1000px) {
            #view-export-form {
                grid-template-columns: 1fr;
                justify-items: center;
                gap: 16px;
            }
            #view-export-form .export-pair {
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: center;
                gap: 12px;
                width: 100%;
                max-width: 300px;
            }
            #view-export-form .export-label {
                text-align: right;
                font-weight: 600;
                color: #333;
                min-width: 80px;
                flex-shrink: 0;
            }
            #view-export-form .export-input,
            #view-export-form .export-select,
            #view-export-form .export-number {
                width: 120px;
                text-align: center;
                flex-shrink: 0;
            }
        }
        /* CSS cho c√°c n√∫t thao t√°c trong c·ªôt ph·∫£i view mode */
        #view-svg-actions {
            margin-top: 16px;
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        #view-svg-actions .view-action-btn {
            background: #ffc107;
            color: #212529;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(255,193,7,0.2);
            transition: all 0.2s;
            text-decoration: none;
        }
        #view-svg-actions .view-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,193,7,0.3);
        }
        #view-svg-actions .view-download-btn {
            background: #17a2b8;
            color: white;
        }
        #view-svg-actions .view-download-btn:hover {
            box-shadow: 0 4px 12px rgba(23,162,184,0.3);
        }
        /* Responsive cho c√°c n√∫t thao t√°c */
        @media (max-width: 800px) {
            #view-svg-actions {
                flex-direction: column;
                gap: 8px;
            }
        }
        #modal-svg-preview {
          text-align: center;
        }
        #modal-svg-img {
          display: inline-block;
          margin: 0 auto;
          max-width: 100%;
          max-height: 200px;
          object-fit: contain;
          border: 1px solid #ddd;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Google Login Button Styles */
        .google-login-btn {
          max-width: 320px;
          display: flex;
          padding: 8px 16px;
          font-size: 14px;
          line-height: 1.25rem;
          font-weight: 700;
          text-align: center;
          text-transform: uppercase;
          align-items: center;
          justify-content: center;
          border-radius: 6px;
          border: 1px solid rgba(0, 0, 0, 0.25);
          gap: 0.75rem;
          color: rgb(65, 63, 63);
          background-color: #fff;
          cursor: pointer;
          transition: all .6s ease;
          min-height: 40px;
        }

        .google-login-btn svg {
          height: 24px;
          flex-shrink: 0;
        }

        .google-login-btn:hover {
          transform: scale(1.02);
          background-color: #1565c0;
          color: white;
        }
        #logout-btn {
          background: #d32f2f;
          color: white;
          padding: 8px 16px;
          border-radius: 6px;
          text-decoration: none;
          font-weight: bold;
          font-size: 14px;
          box-sizing: border-box;
        }
    </style>
</head>
<body>
    <!-- New Navigation Bar -->
    <nav class="w-full max-w-7xl mx-auto bg-white/80 backdrop-blur shadow-lg rounded-2xl p-3 flex items-center justify-between mb-8">
        <!-- Logo -->
        <div class="flex items-center gap-2">
            <span class="bg-gradient-to-br from-blue-500 to-yellow-400 p-1.5 rounded-lg">
                <i class="fa-solid fa-meteor text-white text-lg"></i>
            </span>
            <span class="text-lg font-bold text-gray-800">TikZ to SVG</span>
        </div>
        
        <!-- Menu - Centered -->
        <ul class="hidden md:flex gap-6 items-center font-medium text-gray-700" style="margin: 0; padding: 0;">
            <li class="menu-item relative px-2 py-1 cursor-pointer transition hover:text-blue-600">
                <a href="/" class="block text-sm" style="line-height: 1;">Trang ch·ªß</a>
                <div class="menu-underline"></div>
            </li>
            {% if current_user.is_authenticated %}
            <li class="menu-item relative px-2 py-1 cursor-pointer transition hover:text-blue-600">
                <a href="/profile/{{ current_user.id }}/settings" class="block text-sm" style="line-height: 1;">H·ªì s∆°</a>
                <div class="menu-underline"></div>
            </li>
            <li class="menu-item relative px-2 py-1 cursor-pointer transition hover:text-blue-600">
                <a href="/profile/{{ current_user.id }}/svg-files" class="block text-sm" style="line-height: 1;">File SVG</a>
                <div class="menu-underline"></div>
            </li>
            <li class="menu-item relative px-2 py-1 cursor-pointer transition hover:text-blue-600">
                <a href="/profile/{{ current_user.id }}/followed-posts" class="block text-sm" style="line-height: 1;">B√†i ƒëƒÉng</a>
                <div class="menu-underline"></div>
            </li>
            {% endif %}
        </ul>
        
        <!-- Avatar/User or Login -->
        <div class="flex items-center gap-2">
            {% if current_user.is_authenticated %}
                <div class="flex items-center gap-2">
                    <div class="flex items-center gap-2 bg-gray-100 px-2 py-1.5 rounded-lg">
                        {% if avatar %}
                            <img src="{{ url_for('static', filename='avatars/' ~ avatar) }}" 
                                 alt="Avatar" class="w-6 h-6 rounded-full"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        {% endif %}
                        {% if not avatar %}
                            <div class="w-6 h-6 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-xs">
                                {{ user_email[0].upper() if user_email else 'U' }}
                            </div>
                        {% endif %}
                        <span class="text-xs font-medium text-gray-700">{{ username or user_email.split('@')[0] }}</span>
                    </div>
                    <a href="/logout" class="hidden md:block bg-gradient-to-r from-red-400 to-red-600 text-white px-3 py-1.5 rounded-xl shadow hover:scale-105 transition font-semibold text-xs" style="text-decoration: none;">ƒêƒÉng xu·∫•t</a>
                </div>
            {% else %}
                <button class="hidden md:block bg-gradient-to-r from-blue-400 to-yellow-400 text-white px-3 py-1.5 rounded-xl shadow hover:scale-105 transition font-semibold text-sm" onclick="loginWithGoogle()">ƒêƒÉng nh·∫≠p</button>
            {% endif %}
            <!-- Hamburger (mobile) -->
            <button id="menu-toggle" class="md:hidden p-1.5 rounded-lg hover:bg-blue-100 transition">
                <i class="fa-solid fa-bars text-lg"></i>
            </button>
        </div>
    </nav>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="fixed top-0 left-0 w-full h-full bg-black/50 z-40 hidden">
        <div class="absolute right-0 top-0 w-60 bg-white h-full shadow-lg flex flex-col p-6 gap-3">
            <button id="close-menu" class="self-end text-2xl text-gray-500 hover:text-blue-400">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <a href="/" class="py-2 px-3 rounded-lg text-gray-700 font-medium hover:bg-blue-100 transition">Trang ch·ªß</a>
            {% if current_user.is_authenticated %}
            <a href="/profile/{{ current_user.id }}/settings" class="py-2 px-3 rounded-lg text-gray-700 font-medium hover:bg-blue-100 transition">H·ªì s∆°</a>
            <a href="/profile/{{ current_user.id }}/svg-files" class="py-2 px-3 rounded-lg text-gray-700 font-medium hover:bg-blue-100 transition">File SVG</a>
            <a href="/profile/{{ current_user.id }}/followed-posts" class="py-2 px-3 rounded-lg text-gray-700 font-medium hover:bg-blue-100 transition">B√†i ƒëƒÉng</a>
            {% endif %}
            {% if current_user.is_authenticated %}
                <a href="/logout" class="bg-gradient-to-r from-red-400 to-red-600 text-white px-4 py-2 rounded-xl shadow font-semibold mt-2 text-center" style="text-decoration: none;">ƒêƒÉng xu·∫•t</a>
            {% else %}
                <button class="bg-gradient-to-r from-blue-400 to-yellow-400 text-white px-4 py-2 rounded-xl shadow font-semibold mt-8" onclick="loginWithGoogle()">ƒêƒÉng nh·∫≠p</button>
            {% endif %}
        </div>
    </div>
    <!-- Block 2: Input-Preview Section -->
    <div class="input-preview-section">
        <div class="container">
            <h2>Chuy·ªÉn ƒë·ªïi TikZ sang SVG/PNG/JPEG</h2>

            <!-- Truy·ªÅn tr·∫°ng th√°i login t·ª´ server v√†o JS (ƒë·ªÉ linter kh√¥ng b√°o l·ªói) -->
            <script id="app-state" type="application/json">{{ {
              'loggedIn': logged_in,
              'userEmail': user_email,
              'username': username,
              'avatar': avatar
            } | tojson | safe }}</script>
            <!-- Gi√° tr·ªã TikZ ban ƒë·∫ßu ƒë·ªÉ kh·ªüi t·∫°o CodeMirror -->
            <script id="initial-tikz" type="application/json">{{ tikz_code|default('')|tojson|safe }}</script>
            <script>
              window.appState = JSON.parse(document.getElementById('app-state').textContent);
            </script>

        <div class="table-scroll-x">
          <div class="table-content">
            <div class="col">
              <form id="tikz-form" method="post" onsubmit="console.log('Form submit event'); return submitTikzCodeAjax(event)">
                <textarea name="code" id="code" rows="12" placeholder="Nh·∫≠p code TikZ t·∫°i ƒë√¢y...">{{ tikz_code|default('') }}</textarea>
                <div class="d-flex justify-content-end align-items-center gap-2" id="compile-save-row">
                  <button type="submit" id="compile-btn" class="compile-save-row-btn" {% if not logged_in %}title="B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p Google ƒë·ªÉ s·ª≠ d·ª•ng"{% endif %}>Bi√™n d·ªãch</button>
                  <button
                    type="button"
                    id="save-server-btn"
                    class="compile-save-row-btn"
                    data-file-id="{{ svg_temp_id }}"
                    data-tikz-code="{{ tikz_code | e }}"
                    style="display: none;"
                  >
                    üíæ L∆∞u server
                  </button>
                </div>
              </form>
            </div>
            <div class="col">
              {% if error %}
                <div class="error">{{ error|safe }}</div>
              {% elif svg_temp_url %}
                <img src="{{ svg_temp_url }}" alt="SVG Preview" style="width:100%;height:100%;object-fit:contain;display:block;">
              {% else %}
                <div class="preview-placeholder">
                  <p>Nh·∫≠p code TikZ ƒë·ªÉ xem preview real-time</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
        <!-- Th√¥ng b√°o h∆∞·ªõng d·∫´n cho mobile -->
        <p id="mobile-scroll-hint" style="margin-top: 12px; color: #777; font-size: 0.9em; text-align: center; display: none;">
          üì± Tr√™n ƒëi·ªán tho·∫°i, vu·ªët ngang ƒë·ªÉ xem ƒë·ªß 2 c·ªôt
        </p>

        <script>
// Function ƒë·ªÉ ƒëƒÉng nh·∫≠p v·ªõi Google
function loginWithGoogle() {
    window.location.href = "{{ url_for('google.login') }}";
}

// Mobile menu functionality s·∫Ω ƒë∆∞·ª£c g·ªçi trong init ch√≠nh

function updateHeaderLoginState() {
    // Logic m·ªõi: Header ƒë√£ ƒë∆∞·ª£c render t·ª´ server v·ªõi avatar/username
    // Ch·ªâ c·∫ßn x·ª≠ l√Ω c√°c logic b·ªï sung
    
    if (window.appState.loggedIn) {
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t sau khi ƒëƒÉng nh·∫≠p
        updateButtonStates();
        
        // Ki·ªÉm tra xem c√≥ ·∫£nh SVG ƒëang ch·ªù hi·ªÉn th·ªã sau khi ƒëƒÉng nh·∫≠p kh√¥ng
        const pendingViewSvg = localStorage.getItem('pending_view_svg');
        if (pendingViewSvg) {
            try {
                const pendingData = JSON.parse(pendingViewSvg);
                if (pendingData.tikzCode && pendingData.svgFilename) {
                    // Hi·ªÉn th·ªã ·∫£nh SVG ƒë√£ l∆∞u (t·ª´ c·∫£ n√∫t üì∏ T·∫£i ·∫£nh PNG/JPEG v√† t·ª´ trang view_svg.html)
                    showViewMode(pendingData.tikzCode, pendingData.svgFilename);
                    // X√≥a d·ªØ li·ªáu ƒë√£ s·ª≠ d·ª•ng
                    localStorage.removeItem('pending_view_svg');
                    
                                // ƒê·∫£m b·∫£o view-mode-row lu√¥n n·∫±m trong input-preview-section
            setTimeout(() => {
                const inputPreviewSection = document.querySelector('.input-preview-section .container');
                const viewModeRow = document.getElementById('view-mode-row');
                if (inputPreviewSection && viewModeRow) {
                    // Di chuy·ªÉn view-mode-row: ƒë·∫∑t ngay sau mobile hint n·∫øu c√≥, ng∆∞·ª£c l·∫°i sau .table-scroll-x
                    const tableScrollX = inputPreviewSection.querySelector('.table-scroll-x');
                    const mobileHint = document.getElementById('mobile-scroll-hint');
                    if (mobileHint && mobileHint.parentNode === inputPreviewSection) {
                        mobileHint.parentNode.insertBefore(viewModeRow, mobileHint.nextSibling);
                    } else if (tableScrollX) {
                        tableScrollX.parentNode.insertBefore(viewModeRow, tableScrollX.nextSibling);
                    } else {
                        inputPreviewSection.appendChild(viewModeRow);
                    }
                }
            }, 100);
                }
            } catch (error) {
                console.error('Error parsing pending view SVG data:', error);
                localStorage.removeItem('pending_view_svg');
            }
        }
    }
}
// S·∫Ω g·ªçi updateHeaderLoginState trong init ch√≠nh

// Sau khi login ‚Üí √©p reload ƒë·ªÉ ƒë·ªìng b·ªô session
if (window.location.search.includes('login=1')) {
  window.location.href = window.location.pathname;
}

// X·ª≠ l√Ω view_svg s·∫Ω ƒë∆∞·ª£c g·ªçi trong init ch√≠nh
// ========== MAIN INITIALIZER: G·ªôp t·∫•t c·∫£ DOMContentLoaded v√†o ƒë√¢y ==========
document.addEventListener('DOMContentLoaded', function() {
  // 1) Mobile menu
  const menuToggle = document.getElementById('menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');
  const closeMenu = document.getElementById('close-menu');
  if (menuToggle && mobileMenu && closeMenu) {
    menuToggle.addEventListener('click', () => mobileMenu.classList.remove('hidden'));
    closeMenu.addEventListener('click', () => mobileMenu.classList.add('hidden'));
    mobileMenu.addEventListener('click', e => { if (e.target === mobileMenu) mobileMenu.classList.add('hidden'); });
  }

  // 2) Header login state + pending view svg injection
  updateHeaderLoginState();

  // 3) X·ª≠ l√Ω view_svg param
  (function handleViewSvgParam() {
    const urlParams = new URLSearchParams(window.location.search);
    const viewSvgFilename = urlParams.get('view_svg');
    if (!viewSvgFilename) return;
    const fileCards = document.querySelectorAll('.file-card');
    for (let card of fileCards) {
      const filename = card.getAttribute('data-filename');
      if (filename === viewSvgFilename) {
        let tikzCode = card.getAttribute('data-tikz-code') || '';
        if (!tikzCode) {
          const textarea = card.querySelector('.tikz-cm');
          if (textarea) tikzCode = textarea.value;
        }
        if (!window.appState.loggedIn) {
          localStorage.setItem('pending_view_svg', JSON.stringify({ tikzCode, svgFilename: viewSvgFilename }));
          showLoginModal();
          return;
        }
        showViewMode(tikzCode, viewSvgFilename);
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
        break;
      }
    }
  })();

  // 4) Setup require-login bindings, common listeners
  setupRequireLogin();
  initializeEventListeners();

  // 5) Smooth scroll hint + touch scroll (theo c·∫•u tr√∫c table-scroll-x)
  (function setupHorizontalScrollUX() {
    const mobileHint = document.getElementById('mobile-scroll-hint');
    const scrollHost = document.querySelector('.table-scroll-x');
    function showMobileScrollHint() {
      if (!mobileHint || !scrollHost) return;
      const isMobile = window.innerWidth <= 768;
      const hasScroll = scrollHost.scrollWidth > scrollHost.clientWidth;
      if (isMobile && hasScroll) {
        mobileHint.style.display = 'block';
        setTimeout(() => { mobileHint.style.opacity = '0.7'; }, 3000);
        setTimeout(() => { mobileHint.style.display = 'none'; }, 8000);
      } else {
        mobileHint.style.display = 'none';
      }
    }
    showMobileScrollHint();
    window.addEventListener('resize', showMobileScrollHint);
    if (scrollHost) {
      let isScrolling = false, startX = 0, scrollLeft = 0;
      scrollHost.addEventListener('touchstart', function(e) {
        isScrolling = true;
        startX = e.touches[0].pageX - scrollHost.offsetLeft;
        scrollLeft = scrollHost.scrollLeft;
      }, { passive: true });
      scrollHost.addEventListener('touchmove', function(e) {
        if (!isScrolling) return;
        const x = e.touches[0].pageX - scrollHost.offsetLeft;
        const walk = (x - startX) * 2;
        scrollHost.scrollLeft = scrollLeft - walk;
      }, { passive: true });
      scrollHost.addEventListener('touchend', function() { isScrolling = false; }, { passive: true });
    }
  })();

  // 6) Init CodeMirror + preview real-time
  if (typeof initCodeMirrorAndBindings === 'function') {
    initCodeMirrorAndBindings();
  }

  // 7) Init highlight.js
  if (window.hljs) {
    hljs.highlightAll();
    if (hljs.initLineNumbersOnLoad) hljs.initLineNumbersOnLoad();
  }

  // 8) Modal login button
  const modalLoginBtn = document.getElementById('modal-login-btn');
  if (modalLoginBtn) {
    modalLoginBtn.addEventListener('click', function() {
      window.location.href = "{{ url_for('google.login') }}";
    });
  }

  // 9) Logout link
  const logoutLink = document.getElementById('logout-link');
  if (logoutLink) {
    logoutLink.addEventListener('click', function(e) {
      e.preventDefault();
      window.location.href = '/logout?next=/';
    });
  }

  // 10) Keyword modal behaviors
  if (typeof initKeywordModal === 'function') {
    initKeywordModal();
  }

  console.log('DOMContentLoaded - appState.loggedIn:', window.appState && window.appState.loggedIn);
});

</script>

<script>
function setupRequireLogin() {
  // Ch·ªâ x·ª≠ l√Ω c√°c n√∫t kh√°c, kh√¥ng x·ª≠ l√Ω view-btn v√¨ ƒë√£ x·ª≠ l√Ω ri√™ng
  document.querySelectorAll('.files-section .file-copy-link-btn, .files-section .copy-btn').forEach(function(btn) {
    btn.onclick = function(e) {
      if (!window.appState.loggedIn) {
        e.preventDefault();
        showLoginModal();
      }
    };
  });
}
        // S·∫Ω ƒë∆∞·ª£c g·ªçi trong init ch√≠nh

        // H√†m kh·ªüi t·∫°o event listeners cho c√°c n√∫t
        function initializeEventListeners() {
    // ----------------------------------------------
    // 1. Copy link (üîó Copy Link)
    // ----------------------------------------------
    document.querySelectorAll('.copy-link-btn').forEach(btn => {
        btn.onclick = function() {
            const link = this.getAttribute('data-link');
            if (link) {
                navigator.clipboard.writeText(link)
                    .then(() => showFeedback(this, '‚úÖ ƒê√£ copy!'))
                    .catch(() => showFeedback(this, '‚ùå L·ªói copy!'));
            }
        };
    });

    // ----------------------------------------------
    // 2. Copy Facebook link (üü¶ Copy link Facebook)
    // ----------------------------------------------
    document.querySelectorAll('.copy-fb-link-btn').forEach(btn => {
        btn.onclick = function() {
            const link = this.getAttribute('data-link');
            if (link) {
                const fbLink = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`;
                navigator.clipboard.writeText(fbLink)
                    .then(() => showFeedback(this, '‚úÖ ƒê√£ copy link Facebook!'))
                    .catch(() => showFeedback(this, '‚ùå L·ªói copy!'));
            }
        };
    });

    // ----------------------------------------------
    // 3. Xem code TikZ (üìù Xem code TikZ)
    // ----------------------------------------------
    document.querySelectorAll('.view-tikz-btn').forEach(btn => {
        btn.onclick = function() {
            const tikzCode = this.getAttribute('data-tikz-code');
            if (tikzCode) {
                showTikzCodeModal(tikzCode);
            }
        };
    });

    // ----------------------------------------------
    // 4. N√∫t l∆∞u server (üíæ L∆∞u server)
    // ----------------------------------------------
    document.querySelectorAll('#save-server-btn').forEach(btn => {
        btn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();

            const fileId = this.getAttribute('data-file-id');
            const tikzCode = this.getAttribute('data-tikz-code') || "";
            
            if (!fileId) {
                alert("L·ªói: kh√¥ng c√≥ file_id!");
                return;
            }

            // Reset modal
            const keywordsInput = document.getElementById('keywordsInput');
            const suggestionsBox = document.getElementById('keywordSuggestions');
            if (keywordsInput) keywordsInput.value = "";
            if (suggestionsBox) {
                suggestionsBox.innerHTML = '';
                suggestionsBox.style.display = 'none';
            }

            // L·∫•y URL ·∫£nh SVG t·ª´ preview hi·ªán t·∫°i
            const currentPreview = document.querySelector('.preview-col img');
            const modalSvgImg = document.getElementById('modal-svg-img');
            if (currentPreview && modalSvgImg) {
                modalSvgImg.src = currentPreview.src;
                modalSvgImg.style.display = 'block';
            } else if (modalSvgImg) {
                modalSvgImg.style.display = 'none';
            }

            // Ki·ªÉm tra xem c√≥ file_id h·ª£p l·ªá kh√¥ng (t·ª©c l√† ƒë√£ bi√™n d·ªãch th√†nh c√¥ng)
            if (!fileId || fileId === 'None' || fileId === '') {
                alert('‚ö†Ô∏è C·∫£nh b√°o: Ch∆∞a c√≥ ·∫£nh SVG ƒë∆∞·ª£c bi√™n d·ªãch th√†nh c√¥ng.\n\nVui l√≤ng nh·∫•n n√∫t "Bi√™n d·ªãch" tr∆∞·ªõc khi l∆∞u server.');
                return;
            }

            // Ki·ªÉm tra xem code TikZ hi·ªán t·∫°i c√≥ kh·ªõp v·ªõi code TikZ ƒë√£ ƒë∆∞·ª£c bi√™n d·ªãch kh√¥ng
            const currentTikzCode = window.cm ? window.cm.getValue() : document.getElementById('code').value;
            const compiledTikzCode = this.getAttribute('data-tikz-code') || "";
            
            // Debug: Log ƒë·ªÉ ki·ªÉm tra
            console.log('Current TikZ Code:', currentTikzCode.trim());
            console.log('Compiled TikZ Code:', compiledTikzCode.trim());
            console.log('Are they equal?', currentTikzCode.trim() === compiledTikzCode.trim());
            
            if (currentTikzCode.trim() !== compiledTikzCode.trim()) {
                alert('‚ö†Ô∏è C·∫£nh b√°o: Code TikZ hi·ªán t·∫°i kh√°c v·ªõi code TikZ ƒë√£ ƒë∆∞·ª£c bi√™n d·ªãch.\n\n·∫¢nh hi·ªÉn th·ªã: t·ª´ code TikZ hi·ªán t·∫°i\n·∫¢nh s·∫Ω ƒë∆∞·ª£c l∆∞u: t·ª´ code TikZ ƒë√£ bi√™n d·ªãch\n\nVui l√≤ng nh·∫•n n√∫t "Bi√™n d·ªãch" ƒë·ªÉ c·∫≠p nh·∫≠t tr∆∞·ªõc khi l∆∞u server.');
                return;
            }

            // L∆∞u th√¥ng tin t·∫°m th·ªùi
            window.pendingFileId = fileId;
            window.pendingTikzCode = tikzCode;

            // Hi·ªán modal Bootstrap
            const modal = new bootstrap.Modal(document.getElementById('keywordModal'));
            modal.show();
        };
    });

    // ----------------------------------------------
    // 5. N√∫t export PNG/JPEG (T·∫£i xu·ªëng)
    // ----------------------------------------------
    const exportBtn = document.getElementById('export-btn');
    if (exportBtn) {
        exportBtn.addEventListener('click', async function() {
            const svgTempId = exportBtn.getAttribute('data-file-id') || '';
            const format = document.getElementById('export-format').value;
            const widthVal = document.getElementById('export-width').value;
            const heightVal = document.getElementById('export-height').value;
            const dpiVal = document.getElementById('export-dpi').value;
            const msg = document.getElementById('export-msg');

            msg.textContent = '';
            if ((widthVal && widthVal <= 0) || (heightVal && heightVal <= 0) || (dpiVal && dpiVal <= 0)) {
                msg.textContent = 'Width, Height, DPI ph·∫£i l√† s·ªë d∆∞∆°ng!';
                return;
            }

            exportBtn.disabled = true;
            exportBtn.textContent = 'ƒêang x·ª≠ l√Ω...';

            try {
                const res = await fetch('/temp_convert', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_id: svgTempId,
                        fmt: format,
                        width: widthVal || undefined,
                        height: heightVal || undefined,
                        dpi: dpiVal || undefined
                    })
                });
                const data = await res.json();
                if (data.url) {
                    msg.innerHTML = `<a href="${data.url}" download class="export-download-link">T·∫£i v·ªÅ ${format.toUpperCase()}</a>`;
                } else {
                    msg.textContent = data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh!';
                }
            } catch (err) {
                msg.textContent = 'L·ªói k·∫øt n·ªëi ho·∫∑c m√°y ch·ªß!';
            }

            exportBtn.disabled = false;
            exportBtn.textContent = 'T·∫£i xu·ªëng';
        }); // K·∫øt th√∫c initCodeMirrorAndBindings
    }

    // ----------------------------------------------
    // 6. Toggle SVG Code (üìú Xem code SVG)
    // ----------------------------------------------
    const toggleSvgCodeBtn = document.getElementById('toggle-svg-code-btn');
    if (toggleSvgCodeBtn) {
        toggleSvgCodeBtn.onclick = function() {
            const container = document.getElementById('svg-code-container');
            if (container) {
                const currentlyHidden = container.style.display === 'none' || container.style.display === '';
                container.style.display = currentlyHidden ? 'block' : 'none';
                toggleSvgCodeBtn.textContent = currentlyHidden ? '‚ùå ·∫®n code SVG' : 'üìú Xem code SVG';
            }
        };
    }

    // ----------------------------------------------
    // 7. Copy SVG Code (üìã Copy Code)
    // ----------------------------------------------
    const copySvgCodeBtn = document.getElementById('copy-svg-code-btn');
    if (copySvgCodeBtn) {
        copySvgCodeBtn.onclick = function() {
            const codeBlock = document.getElementById('svgCode');
            if (codeBlock) {
                const text = codeBlock.innerText.trim();
                navigator.clipboard.writeText(text).then(() => {
                    copySvgCodeBtn.textContent = '‚úÖ ƒê√£ copy!';
                    setTimeout(() => {
                        copySvgCodeBtn.textContent = 'üìã Copy Code';
                    }, 2000);
                }).catch(() => {
                    copySvgCodeBtn.textContent = '‚ùå L·ªói copy!';
                    setTimeout(() => {
                        copySvgCodeBtn.textContent = 'üìã Copy Code';
                    }, 2000);
                });
            }
        };
    }
}
</script>



{# Th√™m block n√†y NGAY SAU form, TR∆Ø·ªöC result-tools-section #}
{% if error %}
    <div class="result-section">
        <div class="error">{{ error|safe }}
            {% if error_log_full %}
                <br><button id="show-log-btn" style="margin-top:10px; background:#b71c1c; color:white; border:none; border-radius:4px; padding:6px 16px; cursor:pointer;">Hi·ªÉn th·ªã chi ti·∫øt log</button>
                <pre id="full-log" style="display:none; background:#fff0f0; color:#b71c1c; border:1px solid #f5c6cb; border-radius:4px; padding:12px; margin-top:10px; max-height:400px; overflow:auto;">{{ error_log_full }}</pre>
                <script>
                document.getElementById('show-log-btn').onclick = function() {
                    var log = document.getElementById('full-log');
                    if (log.style.display === 'none') {
                        log.style.display = 'block';
                        this.textContent = '·∫®n chi ti·∫øt log';
                    } else {
                        log.style.display = 'none';
                        this.textContent = 'Hi·ªÉn th·ªã chi ti·∫øt log';
                    }
                };
                </script>
            {% endif %}
        </div>
    </div>
{% endif %}

        {% if svg_temp_url and not error %}
        </div> <!-- ƒë√≥ng .container c·ªßa input-preview-section tr∆∞·ªõc khi tools -->
    </div> <!-- ƒë√≥ng .input-preview-section tr∆∞·ªõc khi tools -->
    
    <div id="result-tools-section" class="container" style="margin-top: 16px;">
                <div class="export-section">
                    <h4>Xu·∫•t ·∫£nh PNG/JPEG</h4>
                    <form id="export-form" class="export-form">
                        <div class="export-pair">
                            <label for="export-format" class="export-label">ƒê·ªãnh d·∫°ng:</label>
                            <select id="export-format" class="export-input export-select">
                                <option value="png">PNG</option>
                                <option value="jpeg">JPEG</option>
                            </select>
                        </div>
                        <div class="export-pair">
                            <label for="export-dpi" class="export-label">DPI:</label>
                            <input type="number" id="export-dpi" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-pair">
                            <label for="export-width" class="export-label">Width (px):</label>
                            <input type="number" id="export-width" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-pair">
                            <label for="export-height" class="export-label">Height (px):</label>
                            <input type="number" id="export-height" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-btn-group">
                            <button id="export-btn" type="button" class="export-btn" data-file-id="{{ svg_temp_id }}">T·∫£i xu·ªëng</button>
                        </div>
                    </form>
                    <div id="export-msg" style="margin-top:5px; color:#388e3c;"></div>
                </div>

                {% if svg_content %}
                    <div class="code-section">
                        <button id="toggle-svg-code-btn" class="copy-btn" type="button">üìú Xem code SVG</button>
                        <div id="svg-code-container" style="display:none; margin-top:12px;">
                            <div class="code-header">
                                <span class="code-title">Code SVG:</span>
                                <button id="copy-svg-code-btn" class="copy-btn" type="button">üìã Copy Code</button>
                            </div>
                            <div class="code-block" id="svgCode">
                                <pre><code class="language-xml">{{ svg_content }}</code></pre>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        {% endif %}
    <!-- M·ªü l·∫°i block 2 container ƒë√£ ƒë√≥ng ·ªü tr√™n n·∫øu c·∫ßn ch√®n n·ªôi dung sau -->
    <div class="input-preview-section"><div class="container">

    <!-- Block 3: Files Section -->
    <div class="files-section-container">
        <div class="container">
            {% if svg_files %}
                <div class="files-section">
                <h3>üìÇ C√°c file SVG ƒë√£ t·∫°o</h3>
                <div class="files-grid">
                        {% for file in svg_files %}
                            <div class="file-card" data-filename="{{ file.filename }}" data-tikz-code="{{ file.tikz_code | tojson | safe }}">
                                <img src="{{ file.url }}" alt="{{ file.filename }}" onerror="this.style.display='none'">
                                <h4>
                                  {% if file.owner_id %}
                                  <a href="/profile/{{ file.owner_id }}" style="text-decoration:none; color:inherit;">
                                    <strong>{{ file.display_name }}</strong>
                                  </a>
                                  {% else %}
                                  <strong>{{ file.display_name }}</strong>
                                  {% endif %}
                                </h4>
                                <p><strong>K√≠ch th∆∞·ªõc:</strong> {{ file.size }} KB</p>
                                <p><strong>T·∫°o l√∫c:</strong> {{ file.created_time }}</p>
                                <div class="file-actions">
                                    <a href="{{ file.url }}" target="_blank" class="view-btn">üì∏ T·∫£i ·∫£nh PNG/JPEG</a>
                                    <button class="fb-share-btn" data-filename="{{ file.filename }}" style="background:#1877f3;color:white;font-weight:bold;">üü¶ Copy link Facebook</button>
                                    <button class="file-copy-link-btn" onclick="copyToClipboard('{{ request.host_url.rstrip('/') ~ file.url }}', this, 'üîó Copy Link')">üîó Copy Link</button>
                                    {% if file.tikz_code %}
                                        <button class="copy-btn" onclick="toggleTikzCode(this)">üìù Xem code TikZ</button>
                                    {% endif %}
                                </div>
                                {% if file.tikz_code %}
                                    <div class="tikz-code-block" style="display:none; margin-top:10px;">
                                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                            <span style="font-weight:bold; color:#333;">Code TikZ:</span>
                                            <button class="copy-btn" style="padding:4px 10px; font-size:12px;" onclick="copyTikzCode(this)">üìã Copy</button>
                                        </div>
                                        <div class="code-block" style="margin:0;">
                                            <textarea class="tikz-cm" readonly>{{ file.tikz_code | e }}</textarea>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
                    {% else %}
                <div class="files-section">
                    <h3>üìÇ C√°c file SVG ƒë√£ t·∫°o</h3>
                        <div class="no-files">
                            Ch∆∞a c√≥ file SVG n√†o ƒë∆∞·ª£c t·∫°o. H√£y th·ª≠ chuy·ªÉn ƒë·ªïi m·ªôt code TikZ!
                        </div>
                </div>
            {% endif %}
        </div>
    </div>

    <footer style='text-align:center;color:#888;font-size:14px;margin-top:40px;'>¬© 2024 TikZ2SVG - All rights reserved.</footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        var cm; // Khai b√°o global ƒë·ªÉ c√°c h√†m kh√°c truy c·∫≠p ƒë∆∞·ª£c
        function copyToClipboard(text, buttonElement, originalText) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = 0;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            if (buttonElement) {
                const originalContent = buttonElement.innerHTML;
                buttonElement.innerHTML = '‚úÖ ƒê√£ copy!';
                setTimeout(() => {
                    buttonElement.innerHTML = originalContent;
                }, 2000);
            }
        }

        function copySvgCode() {
            const codeBlock = document.getElementById('svgCode');
            const copyBtn = document.querySelector('.copy-btn');
            copyToClipboard(codeBlock.textContent, copyBtn, 'üìã Copy Code');
        }

        function copyTikzCode(btn) {
            // L·∫•y code t·ª´ CodeMirror instance n·∫øu c√≥, n·∫øu kh√¥ng th√¨ t·ª´ textarea g·ªëc
            const codeBlock = btn.closest('.tikz-code-block');
            const textarea = codeBlock.querySelector('.tikz-cm');
            let code = '';
            
            // ∆Øu ti√™n l·∫•y t·ª´ CodeMirror instance
            if (textarea.CodeMirror) {
                code = textarea.CodeMirror.getValue();
                console.log('Getting code from CodeMirror instance');
            } else {
                // Fallback: l·∫•y t·ª´ textarea g·ªëc
                code = textarea.value;
                console.log('Getting code from original textarea');
            }
            
            // Lo·∫°i b·ªè d√≤ng tr·∫Øng ·ªü ƒë·∫ßu v√† cu·ªëi, ch·ªâ gi·ªØ t·ªëi ƒëa 1 d√≤ng tr·∫Øng li√™n ti·∫øp
            let lines = code.split('\n');
            while (lines.length && lines[0].trim() === '') lines.shift();
            while (lines.length && lines[lines.length - 1].trim() === '') lines.pop();
            let cleaned = [];
            let lastBlank = false;
            for (let line of lines) {
                if (line.trim() === '') {
                    if (!lastBlank) cleaned.push('');
                    lastBlank = true;
                } else {
                    cleaned.push(line);
                    lastBlank = false;
                }
            }
            
            const finalCode = cleaned.join('\n');
            console.log('Copying code:', finalCode.substring(0, 100) + '...');
            copyToClipboard(finalCode, btn, 'üìã Copy');
        }

        function showViewMode(tikzCode, svgFilename) {
            // X√≥a block view mode c≈© n·∫øu c√≥
            let viewRow = document.getElementById('view-mode-row');
            if (viewRow) viewRow.remove();
            // X√≥a block export-section c≈© n·∫øu c√≥
            let oldExport = document.getElementById('view-export-section');
            if (oldExport) oldExport.remove();
            // ·∫®n form nh·∫≠p code TikZ v√† n√∫t Bi√™n d·ªãch c≈©
            const form = document.querySelector('form');
            if (form) form.style.display = 'none';
            // ·∫®n result-tools-section n·∫øu c√≥
            const resultToolsSection = document.getElementById('result-tools-section');
            if (resultToolsSection) resultToolsSection.style.display = 'none';
            // T·∫°o layout 2 c·ªôt m·ªõi
            viewRow = document.getElementById('view-mode-row');
            if (!viewRow) {
                viewRow = document.createElement('div');
                viewRow.id = 'view-mode-row';
                viewRow.innerHTML = `
                    <div class="view-col">
                        <div style="margin-bottom:20px;">
                            <h4 style="color:#333; margin-bottom:15px;">C√°c thao t√°c</h4>
                            <div style="display:flex; flex-direction:column; gap:10px;">
                                <button id="view-back-to-edit-btn" style="background:linear-gradient(90deg, #28a745 0%, #20c997 100%);color:white;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 2px 8px rgba(40,167,69,0.2);transition:all 0.2s;">
                                    ‚Ü©Ô∏è Quay v·ªÅ ch·ªânh s·ª≠a code TikZ
                                </button>
                            </div>
                        </div>
                        <div id="view-export-section">
                            <div class="export-section">
                                <h4>Xu·∫•t ·∫£nh PNG/JPEG</h4>
                                <form id="view-export-form" class="export-form">
                                    <div class="export-pair">
                                        <label for="view-export-format" class="export-label">ƒê·ªãnh d·∫°ng:</label>
                                        <select id="view-export-format" class="export-input export-select">
                                            <option value="png">PNG</option>
                                            <option value="jpeg">JPEG</option>
                                        </select>
                                    </div>
                                    <div class="export-pair">
                                        <label for="view-export-dpi" class="export-label">DPI:</label>
                                        <input type="number" id="view-export-dpi" min="1" class="export-input export-number" placeholder="Auto">
                                    </div>
                                    <div class="export-pair">
                                        <label for="view-export-width" class="export-label">Width (px):</label>
                                        <input type="number" id="view-export-width" min="1" class="export-input export-number" placeholder="Auto">
                                    </div>
                                    <div class="export-pair">
                                        <label for="view-export-height" class="export-label">Height (px):</label>
                                        <input type="number" id="view-export-height" min="1" class="export-input export-number" placeholder="Auto">
                                    </div>
                                    <div class="export-btn-group">
                                        <button id="view-export-btn" type="button" class="export-btn">T·∫£i xu·ªëng</button>
                                    </div>
                                </form>
                                <div id="view-export-msg" style="margin-top:5px; color:#388e3c;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="view-col">
                        <div id="view-svg-preview">
                            <img id="view-svg-img" src="/static/${svgFilename}" alt="SVG Preview" style="width:100%;height:100%;display:block;margin:0 auto;object-fit:contain;border:1px solid #eee;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                        </div>
                        <div id="view-svg-actions">
                            <button id="view-copy-link-btn" class="view-action-btn">
                                üîó Copy Link
                            </button>
                            <a id="view-download-svg-btn" href="/static/${svgFilename}" download class="view-action-btn view-download-btn">
                                üì• T·∫£i xu·ªëng SVG
                            </a>
                        </div>
                    </div>
                `;
                // Th√™m v√†o input-preview-section
                const inputPreviewSection = document.querySelector('.input-preview-section .container');
                if (inputPreviewSection) {
                    inputPreviewSection.appendChild(viewRow);
                }
            } else {
                viewRow.style.display = '';
                document.getElementById('view-svg-img').src = '/static/' + svgFilename;
                // C·∫≠p nh·∫≠t link download v√† copy link
                const downloadBtn = document.getElementById('view-download-svg-btn');
                if (downloadBtn) {
                    downloadBtn.href = '/static/' + svgFilename;
                }
            }
            // L∆∞u code TikZ v√†o bi·∫øn ƒë·ªÉ s·ª≠ d·ª•ng cho n√∫t "Quay v·ªÅ ch·ªânh s·ª≠a"
            window.currentViewTikzCode = tikzCode;
            
            // G√°n s·ª± ki·ªán cho n√∫t Copy Link
            const copyLinkBtn = document.getElementById('view-copy-link-btn');
            if (copyLinkBtn) {
                copyLinkBtn.onclick = function() {
                    const svgUrl = window.location.origin + '/static/' + svgFilename;
                    copyToClipboard(svgUrl, this, 'üîó Copy Link');
                };
            }
            
            // G√°n s·ª± ki·ªán cho n√∫t "‚Ü©Ô∏è Quay v·ªÅ ch·ªânh s·ª≠a code TikZ"
            const backToEditBtn = document.getElementById('view-back-to-edit-btn');
            if (backToEditBtn) {
                backToEditBtn.onclick = function() {
                    // L·∫•y code TikZ ƒë√£ l∆∞u
                    const currentCode = window.currentViewTikzCode || tikzCode;
                    
                    // L∆∞u code v√†o localStorage ƒë·ªÉ trang ch·ªß c√≥ th·ªÉ ƒë·ªçc
                    localStorage.setItem('tikz_code_for_compile', currentCode);
                    
                    // Reload trang ch·ªß
                    window.location.href = '/';
                };
            }
            // Cu·ªôn l√™n khung nh·∫≠p code
            viewRow.scrollIntoView({behavior: 'smooth', block: 'center'});
            // ·∫®n n√∫t L∆∞u server n·∫øu c√≥
            const saveBtn = document.getElementById('save-server-btn');
            if (saveBtn) saveBtn.style.display = 'none';
            // G√°n l·∫°i logic xu·∫•t PNG/JPEG cho file ƒë√£ l∆∞u
            setTimeout(function() {
                const exportBtn = document.getElementById('view-export-btn');
            if (exportBtn) {
                    exportBtn.onclick = async function() {
                        const format = document.getElementById('view-export-format').value;
                        const widthVal = document.getElementById('view-export-width').value;
                        const heightVal = document.getElementById('view-export-height').value;
                        const dpiVal = document.getElementById('view-export-dpi').value;
                        const msg = document.getElementById('view-export-msg');
                    msg.textContent = '';
                    if ((widthVal && widthVal <= 0) || (heightVal && heightVal <= 0) || (dpiVal && dpiVal <= 0)) {
                        msg.textContent = 'Width, Height, DPI ph·∫£i l√† s·ªë d∆∞∆°ng!';
                        return;
                    }
                    exportBtn.disabled = true;
                    exportBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
                    try {
                        const res = await fetch('/convert', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                    filename: svgFilename,
                                    fmt: format,
                                    width: widthVal || undefined,
                                    height: heightVal || undefined,
                                    dpi: dpiVal || undefined
                                })
                            });
                            const data = await res.json();
                            if (data.url) {
                                msg.innerHTML = `<a href="${data.url}" download class="export-download-link">T·∫£i v·ªÅ ${format.toUpperCase()}</a>`;
                            } else {
                                msg.textContent = data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh!';
                            }
                        } catch (err) {
                            msg.textContent = 'L·ªói k·∫øt n·ªëi ho·∫∑c m√°y ch·ªß!';
                        }
                        exportBtn.disabled = false;
                        exportBtn.textContent = 'T·∫£i xu·ªëng';
                    };
                }
            }, 100);
        }

        // Kh·ªüi t·∫°o CodeMirror s·∫Ω ƒë∆∞·ª£c g·ªçi trong init ch√≠nh
        function initCodeMirrorAndBindings() {
            var tikzCode = document.getElementById('code');
            cm = CodeMirror.fromTextArea(tikzCode, {
                mode: 'stex',
                theme: 'material',
                lineNumbers: true,
                lineWrapping: true,
                placeholder: 'Nh·∫≠p code TikZ t·∫°i ƒë√¢y...'
            });
            // Gi√° tr·ªã ban ƒë·∫ßu t·ª´ server
            try {
                cm.setValue(JSON.parse(document.getElementById('initial-tikz')?.textContent || '""'));
            } catch(e) {
                cm.setValue('');
            }
            
            // Th√™m s·ª± ki·ªán click v√†o CodeMirror ƒë·ªÉ hi·ªán modal ƒëƒÉng nh·∫≠p n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
            if (!window.appState.loggedIn) {
                cm.on('mousedown', function() {
                    showLoginModal();
                });
            }
            
            // Th√™m s·ª± ki·ªán real-time preview cho form nh·∫≠p code
            let inputPreviewTimer;
            cm.on('change', function() {
                clearTimeout(inputPreviewTimer);
                inputPreviewTimer = setTimeout(() => {
                    updateInputPreview(cm.getValue());
                }, 1000); // Delay 1 gi√¢y sau khi ng·ª´ng g√µ
            });
            
            // G√°n s·ª± ki·ªán cho n√∫t üì∏ T·∫£i ·∫£nh PNG/JPEG
            document.querySelectorAll('.view-btn').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const card = btn.closest('.file-card');
                    // L·∫•y ƒë√∫ng t√™n file SVG th·∫≠t t·ª´ data-filename
                    const svgFilename = card.getAttribute('data-filename');
                    // ∆Øu ti√™n l·∫•y code TikZ t·ª´ data-tikz-code ho·∫∑c textarea
                    let tikzCode = card.getAttribute('data-tikz-code') || '';
                    if (!tikzCode) {
                        const textarea = card.querySelector('.tikz-cm');
                        if (textarea) tikzCode = textarea.value;
                    }
                    // Ki·ªÉm tra ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi hi·ªÉn th·ªã view mode
                    if (!window.appState.loggedIn) {
                        // L∆∞u th√¥ng tin ·∫£nh SVG v√†o localStorage ƒë·ªÉ hi·ªÉn th·ªã sau khi ƒëƒÉng nh·∫≠p
                        localStorage.setItem('pending_view_svg', JSON.stringify({
                            tikzCode: tikzCode,
                            svgFilename: svgFilename
                        }));
                        showLoginModal();
                        return;
                    }
                    showViewMode(tikzCode, svgFilename);
                });
            });
            // S·ª± ki·ªán copy link Facebook
            document.querySelectorAll('.fb-share-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const filename = btn.getAttribute('data-filename');
                    const shareUrl = `${window.location.origin}/view_svg/${filename}`;
                    const textArea = document.createElement('textarea');
                    textArea.value = shareUrl;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = 0;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    btn.innerHTML = '‚úÖ ƒê√£ copy link Facebook!';
                    setTimeout(() => {
                        btn.innerHTML = 'üü¶ Copy link Facebook';
                    }, 2000);
                });
            });

            // N·∫øu c√≥ code TikZ t·ª´ localStorage (t·ª´ View Mode), ƒëi·ªÅn v√†o textarea ch√≠nh
            const tikzFromStorage = localStorage.getItem('tikz_code_for_compile');
            if (tikzFromStorage) {
                // ƒêi·ªÅn code v√†o textarea ch√≠nh
                if (window.cm && typeof window.cm.setValue === 'function') {
                    window.cm.setValue(tikzFromStorage);
                } else {
                    const textarea = document.getElementById('code');
                    if (textarea) textarea.value = tikzFromStorage;
                }
                // X√≥a d·ªØ li·ªáu ƒë√£ s·ª≠ d·ª•ng
                localStorage.removeItem('tikz_code_for_compile');
            }
            
            // Ki·ªÉm tra xem c√≥ ·∫£nh SVG ƒëang ch·ªù hi·ªÉn th·ªã sau khi ƒëƒÉng nh·∫≠p kh√¥ng
            const pendingViewSvg = localStorage.getItem('pending_view_svg');
            if (pendingViewSvg) {
                try {
                    const pendingData = JSON.parse(pendingViewSvg);
                    if (pendingData.tikzCode && pendingData.svgFilename) {
                        if (window.appState.loggedIn) {
                            // ƒê√£ ƒëƒÉng nh·∫≠p: hi·ªÉn th·ªã ·∫£nh SVG ƒë√£ l∆∞u
                            showViewMode(pendingData.tikzCode, pendingData.svgFilename);
                            // X√≥a d·ªØ li·ªáu ƒë√£ s·ª≠ d·ª•ng
                            localStorage.removeItem('pending_view_svg');
                        } else {
                            // Ch∆∞a ƒëƒÉng nh·∫≠p: hi·ªÉn th·ªã modal ƒëƒÉng nh·∫≠p
                            showLoginModal();
                        }
                    }
                } catch (error) {
                    console.error('Error parsing pending view SVG data:', error);
                    localStorage.removeItem('pending_view_svg');
                }
            }
            
            // ƒê·∫£m b·∫£o view-mode-row lu√¥n n·∫±m trong input-preview-section n·∫øu c√≥ pending_view_svg
            const hasPendingViewSvg = localStorage.getItem('pending_view_svg');
            if (hasPendingViewSvg && window.appState.loggedIn) {
                const inputPreviewSection = document.querySelector('.input-preview-section .container');
                const viewModeRow = document.getElementById('view-mode-row');
                if (inputPreviewSection && viewModeRow) {
                    // Di chuy·ªÉn view-mode-row v√†o input-preview-section
                    inputPreviewSection.appendChild(viewModeRow);
                }
            }
            
            // Kh·ªüi t·∫°o preview n·∫øu c√≥ code TikZ ban ƒë·∫ßu
            const initialCode = cm.getValue();
            if (initialCode && initialCode.trim()) {
                updateInputPreview(initialCode);
            }
        }

        // Hi·ªÉn th·ªã l·ªói bi√™n d·ªãch TikZ, k√®m log chi ti·∫øt n·∫øu c√≥
        function displayCompileError(message, fullLog) {
            console.log('displayCompileError called with:', { message, hasFullLog: !!fullLog });
            // X√≥a T·∫§T C·∫¢ error sections c≈©
            document.querySelectorAll('.result-section, #result-section, #ajax-result-section').forEach(el => {
                if (el.querySelector('.error') || el.querySelector('#ajax-show-log-btn')) {
                    el.remove();
                }
            });
            // N·∫øu kh√¥ng c√≥ log chi ti·∫øt th√¨ ch·ªâ hi·ªán text l·ªói chung
            const section = document.createElement('div');
            section.id = 'ajax-result-section';
            section.className = 'result-section';
            let html = `<div class=\"error\">L·ªói khi bi√™n d·ªãch!</div>`;
            if (fullLog && fullLog.trim()) {
                html += `<button id=\"ajax-show-log-btn\" style=\"margin-top:10px; background:#b71c1c; color:white; border:none; border-radius:4px; padding:6px 16px; cursor:pointer;\">Hi·ªÉn th·ªã chi ti·∫øt log</button>`;
                html += `<button id=\"ajax-copy-log-btn\" style=\"display:none; margin-left:10px; background:#ffc107; color:#212529; border:none; border-radius:4px; padding:6px 16px; cursor:pointer; font-weight:bold;\">Copy log</button>`;
                html += `<pre id=\"ajax-full-log\" style=\"display:none; background:#fff0f0; color:#b71c1c; border:1px solid #f5c6cb; border-radius:4px; padding:12px; margin-top:10px; max-height:400px; overflow:auto;\">${fullLog}</pre>`;
            }
            section.innerHTML = html;
            // Insert sau form
            const form = document.getElementById('tikz-form');
            if (form && form.parentNode) {
                form.parentNode.insertBefore(section, form.nextSibling);
            }
            // G√°n event handler
            const logBtn = document.getElementById('ajax-show-log-btn');
            const copyBtn = document.getElementById('ajax-copy-log-btn');
            if (logBtn) {
                logBtn.onclick = function() {
                    const log = document.getElementById('ajax-full-log');
                    if (log) {
                        if (log.style.display === 'none') {
                            log.style.display = 'block';
                            this.textContent = '·∫®n chi ti·∫øt log';
                            if (copyBtn) copyBtn.style.display = 'inline-block';
                        } else {
                            log.style.display = 'none';
                            this.textContent = 'Hi·ªÉn th·ªã chi ti·∫øt log';
                            if (copyBtn) copyBtn.style.display = 'none';
                        }
                    }
                };
                console.log('Log button event handler attached');
            }
            if (copyBtn) {
                copyBtn.onclick = function() {
                    const log = document.getElementById('ajax-full-log');
                    if (log) {
                        navigator.clipboard.writeText(log.textContent)
                            .then(() => {
                                copyBtn.textContent = '‚úÖ ƒê√£ copy!';
                                setTimeout(() => { copyBtn.textContent = 'Copy log'; }, 2000);
                            })
                            .catch(() => {
                                copyBtn.textContent = '‚ùå L·ªói copy!';
                                setTimeout(() => { copyBtn.textContent = 'Copy log'; }, 2000);
                            });
                    }
                };
            }
        }

        // H√†m AJAX m·ªõi ƒë·ªÉ submit kh√¥ng reload trang
        async function submitTikzCodeAjax(event) {
            console.log('AJAX submit started'); // Debug
            event.preventDefault(); // NgƒÉn form submit b√¨nh th∆∞·ªùng
            
            // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
            if (!window.appState.loggedIn) {
                showLoginModal();
                return false;
            }

            // L·∫•y code t·ª´ CodeMirror
            const tikzCode = cleanControlChars(cm.getValue());
            if (!tikzCode.trim()) {
                alert('Vui l√≤ng nh·∫≠p code TikZ');
                return false;
            }

            // Hi·ªÉn th·ªã loading
            const compileBtn = document.getElementById('compile-btn');
            const originalText = compileBtn.textContent;
            compileBtn.textContent = 'ƒêang bi√™n d·ªãch...';
            compileBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('code', tikzCode);

                const response = await fetch('/', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    // KI·ªÇM TRA L·ªñI CH√çNH X√ÅC H∆†N
                    // 1. Ki·ªÉm tra trong preview-col tr∆∞·ªõc
                    const previewColError = doc.querySelector('.preview-col .error');
                    // 2. Ki·ªÉm tra trong result-section 
                    const resultSectionError = doc.querySelector('.result-section .error');
                    // 3. Ki·ªÉm tra error ƒë·ªôc l·∫≠p
                    const standaloneError = doc.querySelector('.error');

                    // Debug ƒë·ªÉ ki·ªÉm tra error detection
                    console.log('Checking for errors in response...');
                    console.log('Preview col error:', previewColError);
                    console.log('Result section error:', resultSectionError);
                    console.log('Standalone error:', standaloneError);

                    const errorElement = previewColError || resultSectionError || standaloneError;
                    if (errorElement) {
                        const msg = errorElement.innerHTML;
                        // T√¨m full log trong c√πng document
                        const fullLogEl = doc.getElementById('full-log');
                        const fullLog = fullLogEl ? fullLogEl.textContent : '';
                        console.log('Error detected:', msg);
                        console.log('Full log:', fullLog ? 'Yes' : 'No');
                        displayCompileError(msg, fullLog);
                        return;
                    }

                    // C·∫≠p nh·∫≠t preview
                    const previewCol = document.querySelector('.preview-col');
                    const newPreviewCol = doc.querySelector('.preview-col');
                    if (previewCol && newPreviewCol) {
                        previewCol.innerHTML = newPreviewCol.innerHTML;
                    }

                    // C·∫≠p nh·∫≠t result-tools-section v√† ƒë·∫£m b·∫£o ƒë·∫∑t b√™n ngo√†i .table-scroll-x
                    const tableScroll = document.querySelector('.table-scroll-x');
                    const mobileHint = document.getElementById('mobile-scroll-hint');
                    const resultToolsSection = document.getElementById('result-tools-section');
                    const newResultToolsSection = doc.getElementById('result-tools-section');

                    if (newResultToolsSection) {
                        if (resultToolsSection) {
                            resultToolsSection.innerHTML = newResultToolsSection.innerHTML;
                            resultToolsSection.style.display = 'block';
                            // Di chuy·ªÉn ra ngay sau mobile hint (n·∫øu c√≥), ng∆∞·ª£c l·∫°i ngay sau .table-scroll-x
                            if (mobileHint && mobileHint.parentNode) {
                                mobileHint.parentNode.insertBefore(resultToolsSection, mobileHint.nextSibling);
                            } else if (tableScroll && tableScroll.parentNode) {
                                tableScroll.parentNode.insertBefore(resultToolsSection, tableScroll.nextSibling);
                            }
                        } else {
                            // T·∫°o m·ªõi result-tools-section n·∫øu ch∆∞a c√≥ v√† ƒë·∫∑t sau mobile hint (n·∫øu c√≥) ho·∫∑c sau .table-scroll-x
                            const newSection = document.createElement('div');
                            newSection.id = 'result-tools-section';
                            newSection.innerHTML = newResultToolsSection.innerHTML;
                            if (mobileHint && mobileHint.parentNode) {
                                mobileHint.parentNode.insertBefore(newSection, mobileHint.nextSibling);
                            } else if (tableScroll && tableScroll.parentNode) {
                                tableScroll.parentNode.insertBefore(newSection, tableScroll.nextSibling);
                            } else {
                                // Fallback: th√™m cu·ªëi body n·∫øu kh√¥ng t√¨m th·∫•y .table-scroll-x
                                document.body.appendChild(newSection);
                            }
                        }
                        // ·∫®n ho·∫∑c x√≥a ajax-result-section n·∫øu c√≥
                        const ajaxResultSection = document.getElementById('ajax-result-section');
                        if (ajaxResultSection) {
                            ajaxResultSection.style.display = 'none';
                        }
                    } else if (resultToolsSection) {
                        resultToolsSection.style.display = 'none';
                    }

                    // Kh·ªüi t·∫°o l·∫°i c√°c event listeners cho c√°c n√∫t m·ªõi
                    initializeEventListeners();

                    // Kh·ªüi t·∫°o l·∫°i CodeMirror cho textarea id="code"
                    ensureCodeMirror();
                    
                    // Debug: Ki·ªÉm tra n√∫t save server c√≥ ƒë∆∞·ª£c g√°n event ch∆∞a
                    const saveServerBtn = document.getElementById('save-server-btn');
                    if (saveServerBtn) {
                        console.log('Save server button found after AJAX update');
                        console.log('Button onclick:', saveServerBtn.onclick);
                    } else {
                        console.log('Save server button not found after AJAX update');
                    }

                    // Hi·ªán n√∫t L∆∞u server sau khi bi√™n d·ªãch th√†nh c√¥ng
                    if (saveServerBtn && newResultToolsSection) {
                        // L·∫•y svg_temp_id m·ªõi t·ª´ n√∫t export-btn ho·∫∑c t·ª´ DOM m·ªõi
                        const exportBtn = (document.getElementById('result-tools-section') || newResultToolsSection)?.querySelector('#export-btn');
                        if (exportBtn) {
                            const newFileId = exportBtn.getAttribute('data-file-id');
                            if (newFileId) saveServerBtn.setAttribute('data-file-id', newFileId);
                        }
                        // L·∫•y code TikZ m·ªõi t·ª´ CodeMirror
                        if (window.cm && typeof window.cm.getValue === 'function') {
                            saveServerBtn.setAttribute('data-tikz-code', window.cm.getValue());
                        }
                        saveServerBtn.style.display = 'inline-block';
                    }
                } else {
                    // Handle HTTP errors
                    try {
                        const errorData = await response.json();
                        displayCompileError(errorData.error || 'L·ªói khi bi√™n d·ªãch', errorData.error_log_full || '');
                    } catch (e) {
                        displayCompileError('L·ªói k·∫øt n·ªëi v·ªõi server', '');
                    }
                }
            } catch (error) {
                console.error('AJAX Error:', error);
                displayCompileError('C√≥ l·ªói x·∫£y ra khi bi√™n d·ªãch: ' + error.message, '');
            } finally {
                // Kh√¥i ph·ª•c n√∫t
                compileBtn.textContent = originalText;
                compileBtn.disabled = false;
                console.log('AJAX submit completed'); // Debug
            }
            return false;
        }
        window.submitTikzCodeAjax = submitTikzCodeAjax;

            // B·ªé V√íNG L·∫∂P N√ÄY - Ch·ªâ kh·ªüi t·∫°o CodeMirror khi c·∫ßn trong toggleTikzCode
            // document.querySelectorAll('.tikz-cm').forEach(function(textarea) {
            //     if (!textarea.CodeMirror) {
            //         CodeMirror.fromTextArea(textarea, {
            //             mode: 'stex',
            //             theme: 'material',
            //             lineNumbers: true,
            //             readOnly: true,
            //             viewportMargin: Infinity
            //         });
            //     }
            // });
        // K·∫øt th√∫c initCodeMirrorAndBindings

        // (ƒê√£ lo·∫°i b·ªè kh·ªëi highlight TikZ input c≈© ƒë·ªÉ tr√°nh l·ªói linter v√† tr√πng ch·ª©c nƒÉng)

        // H√†m c·∫≠p nh·∫≠t preview real-time cho form nh·∫≠p code
        async function updateInputPreview(tikzCode) {
            if (!tikzCode.trim()) {
                const previewContainer = document.querySelector('.col:last-child');
                if (previewContainer) {
                    previewContainer.innerHTML = '<div class="preview-placeholder"><p>Nh·∫≠p code TikZ ƒë·ªÉ xem preview real-time</p></div>';
                }
                return;
            }
            
            const previewContainer = document.querySelector('.col:last-child');
            if (previewContainer) {
                // N·∫øu ƒëang c√≥ ·∫£nh SVG preview, l√†m m·ªù ·∫£nh thay v√¨ ·∫©n
                const previewImg = previewContainer.querySelector('img');
                if (previewImg) {
                    previewImg.style.opacity = '0.5';
                    previewImg.alt = 'ƒêang c·∫≠p nh·∫≠t preview...';
                } else {
                    previewContainer.innerHTML = '<div class="preview-placeholder"><p>ƒêang c·∫≠p nh·∫≠t preview...</p></div>';
                }
            }
            
            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `code=${encodeURIComponent(tikzCode)}`
                });
                
                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Ki·ªÉm tra l·ªói tr∆∞·ªõc khi t√¨m SVG
                    const previewColError = doc.querySelector('.preview-col .error');
                    const resultSectionError = doc.querySelector('.result-section .error');
                    const standaloneError = doc.querySelector('.error');
                    
                    const errorElement = previewColError || resultSectionError || standaloneError;
                    if (errorElement) {
                        if (previewContainer) {
                            previewContainer.innerHTML = '<div class="preview-placeholder"><p>Code c√≥ l·ªói - vui l√≤ng s·ª≠a</p></div>';
                        }
                        return;
                    }
                    
                    // T√¨m SVG trong preview-col
                    const newSvgUrl = doc.querySelector('.col:last-child img')?.src;
                    
                    if (newSvgUrl && previewContainer) {
                        // N·∫øu ƒë√£ c√≥ img, ch·ªâ c·∫≠p nh·∫≠t src v√† opacity
                        let previewImg = previewContainer.querySelector('img');
                        if (previewImg) {
                            previewImg.src = newSvgUrl;
                            previewImg.style.opacity = '1';
                            previewImg.alt = 'SVG Preview (Real-time)';
                        } else {
                            previewContainer.innerHTML = `<img src="${newSvgUrl}" alt="SVG Preview (Real-time)" style="width:100%;height:100%;object-fit:contain;display:block;">`;
                        }
                    } else if (previewContainer) {
                        previewContainer.innerHTML = '<div class="preview-placeholder"><p>Ch∆∞a c√≥ preview</p></div>';
                    }
                } else {
                    if (previewContainer) {
                        previewContainer.innerHTML = '<div class="preview-placeholder"><p>L·ªói khi t·∫°o preview</p></div>';
                    }
                }
            } catch (error) {
                console.log('Input preview update failed:', error);
                if (previewContainer) {
                    previewContainer.innerHTML = '<div class="preview-placeholder"><p>L·ªói k·∫øt n·ªëi</p></div>';
                }
            }
        }

        // H√†m c·∫≠p nh·∫≠t preview real-time cho view mode
        async function updateRealTimePreview(tikzCode) {
            if (!tikzCode.trim()) return;
            
            const previewImg = document.getElementById('view-svg-img');
            if (previewImg) {
                previewImg.style.opacity = '0.5';
                previewImg.alt = 'ƒêang c·∫≠p nh·∫≠t preview...';
            }
            
            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `code=${encodeURIComponent(tikzCode)}`
                });
                
                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    // T√¨m SVG trong preview-col thay v√¨ svg-preview
                    const newSvgUrl = doc.querySelector('.preview-col img')?.src;
                    
                    if (newSvgUrl && previewImg) {
                        previewImg.src = newSvgUrl;
                        previewImg.style.opacity = '1';
                        previewImg.alt = 'SVG Preview (Real-time)';
                        
                        // C·∫≠p nh·∫≠t link download v√† copy link cho preview m·ªõi
                        const downloadBtn = document.getElementById('view-download-svg-btn');
                        if (downloadBtn) {
                            downloadBtn.href = newSvgUrl;
                        }
                        
                        // C·∫≠p nh·∫≠t s·ª± ki·ªán copy link cho preview m·ªõi
                        const copyLinkBtn = document.getElementById('view-copy-link-btn');
                        if (copyLinkBtn) {
                            copyLinkBtn.onclick = function() {
                                copyToClipboard(newSvgUrl, this, 'üîó Copy Link');
                            };
                        }
                    }
                }
            } catch (error) {
                console.log('Preview update failed:', error);
                if (previewImg) {
                    previewImg.style.opacity = '1';
                    previewImg.alt = 'SVG Preview';
                }
            }
        }

        function toggleTikzCode(btn) {
            try {
                const card = btn.closest('.file-card');
                if (!card) return;
                const codeBlock = card.querySelector('.tikz-code-block');
                const textarea = codeBlock ? codeBlock.querySelector('.tikz-cm') : null;
                if (!codeBlock || !textarea) return;

                const isHidden = window.getComputedStyle(codeBlock).display === 'none';
                if (isHidden) {
                    codeBlock.style.display = 'block';

                    let cmInstance = textarea.CodeMirror;
                    if (!cmInstance) {
                        const existingCm = codeBlock.querySelector('.CodeMirror');
                        if (existingCm) existingCm.remove();
                        cmInstance = CodeMirror.fromTextArea(textarea, {
                            mode: 'stex',
                            theme: 'material',
                            lineNumbers: true,
                            readOnly: true,
                            viewportMargin: Infinity,
                            scrollbarStyle: 'native'
                        });
                    }
                    setTimeout(() => cmInstance && cmInstance.refresh && cmInstance.refresh(), 80);
                    btn.innerHTML = '·∫®n code TikZ';
                    // ƒê∆∞a code block v√†o v√πng nh√¨n th·∫•y
                    codeBlock.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    codeBlock.style.display = 'none';
                    btn.innerHTML = 'üìù Xem code TikZ';
                }
            } catch (err) {
                console.error('toggleTikzCode error:', err);
            }
        }
    </script>
    <!-- Highlight.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/latex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
    <script>
        // Initialize highlight.js s·∫Ω ƒë∆∞·ª£c g·ªçi trong init ch√≠nh
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/stex/stex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/display/placeholder.min.js"></script>
    <script>
    // H√†m lo·∫°i b·ªè k√Ω t·ª± ƒëi·ªÅu khi·ªÉn (tr·ª´ \n, \t)
    function cleanControlChars(str) {
        return str.replace(/[^\x09\x0A\x20-\x7E\xA0-\uFFFF]/g, '');
    }
    </script>
    <!-- Modal ƒëƒÉng nh·∫≠p -->
<div id="login-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:white; padding:32px; border-radius:8px; text-align:center; max-width:90vw; margin:100px auto; box-shadow:0 4px 32px rgba(0,0,0,0.15);">
    <p style="font-size:18px; color:#1976d2; margin-bottom:20px;">C·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y</p>
    <button id="modal-login-btn" class="google-login-btn" style="width:80%;margin:12px auto;display:block;">
      <svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid" viewBox="0 0 256 262">
        <path fill="#4285F4" d="M255.878 133.451c0-10.734-.871-18.567-2.756-26.69H130.55v48.448h71.947c-1.45 12.04-9.283 30.172-26.69 42.356l-.244 1.622 38.755 30.023 2.685.268c24.659-22.774 38.875-56.282 38.875-96.027"></path>
        <path fill="#34A853" d="M130.55 261.1c35.248 0 64.839-11.605 86.453-31.622l-41.196-31.913c-11.024 7.688-25.82 13.055-45.257 13.055-34.523 0-63.824-22.773-74.269-54.25l-1.531.13-40.298 31.187-.527 1.465C35.393 231.798 79.49 261.1 130.55 261.1"></path>
        <path fill="#FBBC05" d="M56.281 156.37c-2.756-8.123-4.351-16.827-4.351-25.82 0-8.994 1.595-17.697 4.206-25.82l-.073-1.73L15.26 71.312l-1.335.635C5.077 89.644 0 109.517 0 130.55s5.077 40.905 13.925 58.602l42.356-32.782"></path>
        <path fill="#EB4335" d="M130.55 50.479c24.514 0 41.05 10.589 50.479 19.438l36.844-35.974C195.245 12.91 165.798 0 130.55 0 79.49 0 35.393 29.301 13.925 71.947l42.211 32.783c10.59-31.477 39.891-54.251 74.414-54.251"></path>
      </svg>
      ƒêƒÉng nh·∫≠p Google
    </button>
    <br><br>
    <button onclick="document.getElementById('login-modal').style.display='none'" style="margin-top:10px; padding:8px 18px; border-radius:6px; border:none; background:#eee; color:#1976d2; font-weight:bold; cursor:pointer;">ƒê√≥ng</button>
  </div>
</div>

    <script>
// Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p t·ª´ backend (kh√¥ng d√πng tr·ª±c ti·∫øp ƒë·ªÉ tr√°nh linter)
// const isLoggedIn = {{ 'true' if user_email else 'false' }};
// G√°n s·ª± ki·ªán cho c√°c n√∫t c·∫ßn ƒëƒÉng nh·∫≠p trong files-section (ƒë√£ g·ªôp v√†o init ch√≠nh)
// ƒê√É G·ªòP V√ÄO INIT CH√çNH: ph·∫ßn d∆∞·ªõi gi·ªØ l·∫°i ƒë·ªÉ t∆∞∆°ng th√≠ch nh∆∞ng kh√¥ng th√™m listener m·ªõi
(function initFilesSectionBindingsOnce() {
  // Logic cho n√∫t "üîó Copy Link" - c·∫ßn ƒëƒÉng nh·∫≠p
  document.querySelectorAll('.files-section .file-copy-link-btn').forEach(function(btn) {
    if (!window.appState.loggedIn) {
      // L∆∞u onclick g·ªëc
      const originalOnclick = btn.getAttribute('onclick');
      btn.setAttribute('data-original-onclick', originalOnclick);
      btn.onclick = function(e) {
        e.preventDefault();
        showLoginModal();
      };
    }
  });
  
  // Logic cho n√∫t "üìù Xem code TikZ" - c·∫ßn ƒëƒÉng nh·∫≠p
  document.querySelectorAll('.files-section .copy-btn[onclick*="toggleTikzCode"]').forEach(function(btn) {
    if (!window.appState.loggedIn) {
      // L∆∞u onclick g·ªëc
      const originalOnclick = btn.getAttribute('onclick');
      btn.setAttribute('data-original-onclick', originalOnclick);
      btn.onclick = function(e) {
        e.preventDefault();
        showLoginModal();
      };
    }
  });
  
  // Logic cho n√∫t "üìã Copy" trong tikz-code-block - c·∫ßn ƒëƒÉng nh·∫≠p
  document.querySelectorAll('.tikz-code-block .copy-btn[onclick*="copyTikzCode"]').forEach(function(btn) {
    if (!window.appState.loggedIn) {
      // L∆∞u onclick g·ªëc
      const originalOnclick = btn.getAttribute('onclick');
      btn.setAttribute('data-original-onclick', originalOnclick);
      btn.onclick = function(e) {
        e.preventDefault();
        showLoginModal();
      };
    }
  });
  
  // Debug: Ki·ªÉm tra c√°c n√∫t c√≥ s·∫µn
  console.log('Ki·ªÉm tra c√°c n√∫t:');
  console.log('View buttons:', document.querySelectorAll('.files-section .view-btn').length);
  console.log('Copy link buttons:', document.querySelectorAll('.files-section .file-copy-link-btn').length);
  console.log('Copy buttons:', document.querySelectorAll('.files-section .copy-btn').length);
  console.log('Toggle TikZ buttons:', document.querySelectorAll('.files-section .copy-btn[onclick*="toggleTikzCode"]').length);
  console.log('Copy TikZ buttons:', document.querySelectorAll('.tikz-code-block .copy-btn[onclick*="copyTikzCode"]').length);
  
  // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p
  updateButtonStates();
  
  // Th√™m s·ª± ki·ªán cho n√∫t bi√™n d·ªãch n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
  const compileBtn = document.getElementById('compile-btn');
  if (compileBtn && !window.appState.loggedIn) {
    compileBtn.addEventListener('click', function(e) {
      e.preventDefault();
      showLoginModal();
    });
  }
  
  // ƒê·∫£m b·∫£o t·∫•t c·∫£ n√∫t "üîó Copy Link" ƒë·ªÅu c√≥ th√¥ng b√°o khi click
  document.querySelectorAll('.files-section .file-copy-link-btn').forEach(function(btn) {
    if (window.appState.loggedIn) {
      // N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p, ƒë·∫£m b·∫£o onclick c√≥ th√¥ng b√°o
      const currentOnclick = btn.getAttribute('onclick');
      if (currentOnclick && currentOnclick.includes('copyToClipboard')) {
        const url = currentOnclick.match(/copyToClipboard\('([^']+)'/)[1];
        btn.onclick = function() {
          copyToClipboard(url, this, 'üîó Copy Link');
        };
      }
    }
  });
  
  // ƒê·∫£m b·∫£o t·∫•t c·∫£ n√∫t "üìù Xem code TikZ" ƒë·ªÅu ho·∫°t ƒë·ªông khi ƒë√£ ƒëƒÉng nh·∫≠p
  document.querySelectorAll('.files-section .copy-btn[onclick*="toggleTikzCode"]').forEach(function(btn) {
    if (window.appState.loggedIn) {
      // N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p, ƒë·∫£m b·∫£o onclick ho·∫°t ƒë·ªông
      btn.onclick = function() {
        toggleTikzCode(this);
      };
    }
  });
  
  // ƒê·∫£m b·∫£o t·∫•t c·∫£ n√∫t "üìã Copy" trong tikz-code-block ƒë·ªÅu ho·∫°t ƒë·ªông khi ƒë√£ ƒëƒÉng nh·∫≠p
  document.querySelectorAll('.tikz-code-block .copy-btn[onclick*="copyTikzCode"]').forEach(function(btn) {
    if (window.appState.loggedIn) {
      // N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p, ƒë·∫£m b·∫£o onclick ho·∫°t ƒë·ªông
      btn.onclick = function() {
        copyTikzCode(this);
      };
    }
  });
})();
function showLoginModal() {
  document.getElementById('login-modal').style.display = 'flex';
}

// H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t sau khi ƒëƒÉng nh·∫≠p
function updateButtonStates() {
  if (window.appState.loggedIn) {
    // N√∫t "üì∏ T·∫£i ·∫£nh PNG/JPEG" ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong ph·∫ßn kh·ªüi t·∫°o CodeMirror
    // Kh√¥ng c·∫ßn x·ª≠ l√Ω ·ªü ƒë√¢y v√¨ event listener g·ªëc ƒë√£ c√≥ ki·ªÉm tra ƒëƒÉng nh·∫≠p
    
    // Kh√¥i ph·ª•c n√∫t "üîó Copy Link" - kh√¥i ph·ª•c onclick g·ªëc
    document.querySelectorAll('.files-section .file-copy-link-btn').forEach(function(btn) {
      const originalOnclick = btn.getAttribute('data-original-onclick');
      if (originalOnclick) {
        // T·∫°o l·∫°i onclick function ƒë·ªÉ ƒë·∫£m b·∫£o th√¥ng b√°o hi·ªÉn th·ªã
        const url = originalOnclick.match(/copyToClipboard\('([^']+)'/)[1];
        btn.onclick = function() {
          copyToClipboard(url, this, 'üîó Copy Link');
        };
        btn.removeAttribute('data-original-onclick');
      }
    });
    
    // Kh√¥i ph·ª•c n√∫t "üìù Xem code TikZ" - kh√¥i ph·ª•c onclick g·ªëc
    document.querySelectorAll('.files-section .copy-btn[data-original-onclick]').forEach(function(btn) {
      const originalOnclick = btn.getAttribute('data-original-onclick');
      if (originalOnclick) {
        // T·∫°o l·∫°i onclick function ƒë·ªÉ ƒë·∫£m b·∫£o ho·∫°t ƒë·ªông
        btn.onclick = function() {
          toggleTikzCode(this);
        };
        btn.removeAttribute('data-original-onclick');
      }
    });
    
    // Kh√¥i ph·ª•c n√∫t "üìã Copy" trong tikz-code-block - kh√¥i ph·ª•c onclick g·ªëc
    document.querySelectorAll('.tikz-code-block .copy-btn[data-original-onclick]').forEach(function(btn) {
      const originalOnclick = btn.getAttribute('data-original-onclick');
      if (originalOnclick) {
        // T·∫°o l·∫°i onclick function ƒë·ªÉ ƒë·∫£m b·∫£o ho·∫°t ƒë·ªông
        btn.onclick = function() {
          copyTikzCode(this);
        };
        btn.removeAttribute('data-original-onclick');
      }
    });
    
    // Kh√¥i ph·ª•c CodeMirror - x√≥a s·ª± ki·ªán mousedown
    if (window.cm && typeof window.cm.off === 'function') {
      window.cm.off('mousedown');
    }
    
    // Kh√¥i ph·ª•c n√∫t bi√™n d·ªãch - x√≥a s·ª± ki·ªán click
    const compileBtn = document.getElementById('compile-btn');
    if (compileBtn) {
      compileBtn.removeEventListener('click', showLoginModal);
    }
  }
}

// Th√™m s·ª± ki·ªán click cho n√∫t ƒëƒÉng nh·∫≠p Google trong modal s·∫Ω ƒë∆∞·ª£c g·ªçi trong init ch√≠nh
</script>
<script>
// Logout link s·∫Ω ƒë∆∞·ª£c g√°n trong init ch√≠nh
</script>

<!-- Modal nh·∫≠p t·ª´ kh√≥a Bootstrap -->
<div class="modal fade" id="keywordModal" tabindex="-1" aria-labelledby="keywordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="keywordModalLabel">Nh·∫≠p m√¥ t·∫£ / t·ª´ kh√≥a</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- ·∫¢nh SVG preview -->
          <div id="modal-svg-preview">
            <img id="modal-svg-img" src="" alt="SVG Preview">
          </div>
          <p>Nh·∫≠p c√°c t·ª´ kh√≥a, c√°ch nhau b·∫±ng d·∫•u ph·∫©y:</p>
          <div class="position-relative">
            <textarea id="keywordsInput" class="form-control" rows="4" placeholder="V√≠ d·ª•: to√°n h·ªçc, h√¨nh h·ªçc, ƒë·ªì th·ªã"></textarea>
            <div id="keywordSuggestions" 
                 class="list-group position-absolute w-100" 
                 style="z-index:9999; max-height:200px; overflow-y:auto; display:none;"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" class="btn btn-primary" id="confirmKeywordBtn">X√°c nh·∫≠n</button>
        </div>
      </div>
    </div>
  </div>
  

<!-- 
Script n√†y x·ª≠ l√Ω logic l∆∞u file SVG l√™n server v·ªõi m√¥ t·∫£/t·ª´ kh√≥a do ng∆∞·ªùi d√πng nh·∫≠p:

- Bi·∫øn `pendingFileId` v√† `pendingTikzCode` l∆∞u t·∫°m th√¥ng tin file SVG c·∫ßn l∆∞u.
- Khi ng∆∞·ªùi d√πng b·∫•m n√∫t "L∆∞u server" (`save-server-btn`):
    + L·∫•y `file_id` v√† `tikz_code` t·ª´ thu·ªôc t√≠nh c·ªßa n√∫t.
    + Reset √¥ nh·∫≠p t·ª´ kh√≥a trong modal.
    + Hi·ªán modal Bootstrap ƒë·ªÉ ng∆∞·ªùi d√πng nh·∫≠p m√¥ t·∫£/t·ª´ kh√≥a.
- Khi ng∆∞·ªùi d√πng b·∫•m "X√°c nh·∫≠n" trong modal (`confirmKeywordBtn`):
    + L·∫•y t·ª´ kh√≥a ng∆∞·ªùi d√πng nh·∫≠p.
    + Ki·ªÉm tra c√≥ `file_id` ch∆∞a, n·∫øu ch∆∞a th√¨ b√°o l·ªói.
    + G·ª≠i POST request l√™n `/save_svg` v·ªõi `file_id`, `tikz_code`, `keywords`.
    + N·∫øu l∆∞u th√†nh c√¥ng th√¨ b√°o th√†nh c√¥ng v√† reload v·ªÅ trang ch·ªß, n·∫øu l·ªói th√¨ b√°o l·ªói.
    + ƒê√≥ng modal sau khi g·ª≠i request.
-->
<script>
    // Bi·∫øn l∆∞u t·∫°m th√¥ng tin file c·∫ßn l∆∞u (g√°n trong init ch√≠nh)
    function initKeywordModal() {
        const confirmBtn = document.getElementById('confirmKeywordBtn');
        const keywordsInput = document.getElementById('keywordsInput');
        const suggestionsBox = document.getElementById('keywordSuggestions');

        let typingTimeout = null;

        // Kh·ªüi t·∫°o bi·∫øn global cho pending data
        window.pendingFileId = null;
        window.pendingTikzCode = "";

        // Khi g√µ trong √¥ textarea ‚Üí fetch g·ª£i √Ω
        keywordsInput.addEventListener('input', function() {
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                const text = keywordsInput.value.trim();
                const parts = text.split(',');
                const lastPart = parts[parts.length - 1].trim();

                if (lastPart.length < 1) {
                    suggestionsBox.style.display = 'none';
                    return;
                }

                fetch(`/api/keywords/search?q=${encodeURIComponent(lastPart)}`)
                    .then(res => res.json())
                    .then(data => {
                        suggestionsBox.innerHTML = '';
                        if (data.length === 0) {
                            suggestionsBox.style.display = 'none';
                            return;
                        }

                        data.forEach(word => {
                            const item = document.createElement('button');
                            item.type = 'button';
                            item.className = 'list-group-item list-group-item-action';
                            item.textContent = word;
                            item.addEventListener('click', () => {
                                // Thay th·∫ø ph·∫ßn cu·ªëi b·∫±ng t·ª´ ch·ªçn
                                parts[parts.length - 1] = word;
                                keywordsInput.value = parts.map(s => s.trim()).filter(s => s).join(', ') + ', ';
                                suggestionsBox.style.display = 'none';
                                keywordsInput.focus();
                            });
                            suggestionsBox.appendChild(item);
                        });
                        suggestionsBox.style.display = 'block';
                    })
                    .catch(err => {
                        console.error(err);
                        suggestionsBox.style.display = 'none';
                    });
            }, 300);
        });

        // Click ngo√†i suggestion ‚Üí ·∫©n
        document.addEventListener('click', function(event) {
            if (!keywordsInput.contains(event.target) && !suggestionsBox.contains(event.target)) {
                suggestionsBox.style.display = 'none';
            }
        });

        // Khi b·∫•m n√∫t "X√°c nh·∫≠n" trong modal
        if (confirmBtn) {
            confirmBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                const keywords = keywordsInput.value.trim();
                if (!keywords) {
                    alert('Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt t·ª´ kh√≥a!');
                    keywordsInput.focus();
                    return;
                }

                if (!window.pendingFileId) {
                    alert("L·ªói: kh√¥ng c√≥ file_id!");
                    return;
                }

                fetch('/save_svg', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        file_id: window.pendingFileId,
                        tikz_code: window.pendingTikzCode,
                        keywords: keywords
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
                        window.location.href = "/";
                    } else {
                        alert(data.error || "C√≥ l·ªói x·∫£y ra!");
                    }
                })
                .catch(err => {
                    alert("L·ªói m·∫°ng ho·∫∑c server!");
                });

                const modal = bootstrap.Modal.getInstance(document.getElementById('keywordModal'));
                modal.hide();
            });
        }
    }
</script>

    
    

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- H√†m kh·ªüi t·∫°o l·∫°i CodeMirror cho textarea id="code" -->
    <script>
        function ensureCodeMirror() {
            const textarea = document.getElementById('code');
            if (!textarea) return;
            // N·∫øu ƒë√£ c√≥ CodeMirror instance, kh√¥ng kh·ªüi t·∫°o l·∫°i
            if (textarea.nextSibling && textarea.nextSibling.classList && textarea.nextSibling.classList.contains('CodeMirror')) {
                return;
            }
            window.cm = CodeMirror.fromTextArea(textarea, {
                mode: 'stex',
                theme: 'material',
                lineNumbers: true,
                placeholder: 'Nh·∫≠p code TikZ t·∫°i ƒë√¢y...'
            });
        }
    </script>

    <!-- ... trong submitTikzCodeAjax, sau khi c·∫≠p nh·∫≠t previewCol v√† resultToolsSection ... -->
    <!-- Th√™m d√≤ng n√†y sau khi c·∫≠p nh·∫≠t DOM: -->
    <!-- ensureCodeMirror(); -->
</body>
</html>
