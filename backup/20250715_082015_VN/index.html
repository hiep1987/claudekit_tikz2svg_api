<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>TikZ to SVG</title>
    <!-- Highlight.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material.min.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h2 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
        }
        textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        /* ==== N√∫t ch√≠nh: Bi√™n d·ªãch, L∆∞u server, T·∫£i xu·ªëng, Xem code SVG, Copy Code ==== */
        .btn-action,
        .compile-save-row-btn,
        .export-btn,
        .copy-btn {
          background: linear-gradient(90deg, #1976d2 0%, #2196f3 100%);
          color: #fff;
          padding: 12px 28px;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          text-decoration: none;
          box-shadow: 0 2px 8px rgba(25, 118, 210, 0.1);
          transition: background 0.3s, box-shadow 0.2s, transform 0.15s;
          width: auto;
          height: auto;
        }

        .btn-action:hover,
        .compile-save-row-btn:hover,
        .export-btn:hover,
        .copy-btn:hover {
          background: linear-gradient(90deg, #1565c0 0%, #42a5f5 100%);
          color: #fff;
          box-shadow: 0 4px 16px rgba(25, 118, 210, 0.18);
          transform: translateY(-2px) scale(1.03);
          outline: none;
          text-decoration: none;
        }

        /* ==== Responsive (mobile) ==== */
        @media (max-width: 1000px) {
          .compile-save-row-btn {
            width: 100%;
            min-width: 0;
            font-size: 16px;
            padding: 14px 0;
            border-radius: 8px;
            margin-bottom: 10px;
            height: 48px;
            box-sizing: border-box;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
          }
        }
        
        @media (max-width: 600px) {
          .btn-action,
          .compile-save-row-btn,
          .export-btn,
          .copy-btn {
            width: 100%;
            min-width: 0;
            font-size: 17px;
            padding: 14px 0;
            border-radius: 8px;
            margin-bottom: 10px;
            height: 48px;
            box-sizing: border-box;
          }
        }
        button:hover {
            background-color: #0056b3;
        }
        .result-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .file-info {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .file-info h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
        .file-info p {
            margin: 5px 0;
            color: #333;
        }
        .svg-preview {
            text-align: center;
            margin-bottom: 20px;
        }
        .svg-preview img {
            max-width: 100%;
            border: 2px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .code-section {
            margin-top: 20px;
            text-align: center;
        }
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .code-title {
            font-weight: bold;
            color: #333;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            position: relative;
        }
        .code-block pre {
            margin: 0;
            padding: 15px;
            background: transparent;
        }
        .code-block code {
            background: transparent;
            padding: 0;
        }
        .download-link {
            display: inline-block;
            background-color: #17a2b8;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            margin-top: 10px;
        }
        .download-link:hover {
            background-color: #138496;
        }
        .copy-link-btn {
            display: inline-block;
            background-color: #ffc107;
            color: #212529;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            margin-top: 10px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
        }
        .copy-link-btn:hover {
            background-color: #e0a800;
        }
        .error {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 5px;
        }
        .files-section {
            margin-top: 40px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .files-section h3 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        .file-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .file-card img {
            width: 100%;
            height: 150px;
            object-fit: contain;
            border: 1px solid #eee;
            border-radius: 3px;
            margin-bottom: 10px;
        }
        .file-card h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 14px;
        }
        .file-card p {
            margin: 3px 0;
            font-size: 12px;
            color: #666;
        }
        .file-actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .file-actions a, .file-actions button {
            padding: 5px 10px;
            text-decoration: none;
            border-radius: 3px;
            font-size: 11px;
            flex: 1;
            text-align: center;
        }
        .view-btn {
            background-color: #007bff;
            color: white;
        }
        .view-btn:hover {
            background-color: #0056b3;
        }
        .fb-share-btn:hover {
            background-color: #1464c7 !important;
        }
        .download-btn {
            background-color: #28a745;
            color: white;
        }
        .file-copy-link-btn {
            background-color: #ffc107;
            color: #212529;
            border: none;
        }
        .file-copy-link-btn:hover {
            background-color: #e0a800;
        }
        /* Hover effects cho n√∫t trong view-mode-row */
        #view-copy-link-btn:hover {
            background-color: #e0a800 !important;
        }
        #view-download-svg-btn:hover {
            background-color: #138496 !important;
        }
        .no-files {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        .export-section {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .export-section h4 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }
        .export-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px 32px;
            align-items: start;
            margin-bottom: 10px;
        }
        @media (min-width: 1000px) {
            .export-form {
                grid-template-columns: 1fr 1fr 1fr 1fr;
            }
        }
        .export-pair {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .export-form .export-btn-group {
            grid-column: 1/-1;
            display: flex;
            justify-content: center;
            margin-top: 8px;
        }
        .export-form .export-btn {
            min-width: 160px;
        }
        .export-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .export-select {
            width: 90%;
            min-width: 120px;
            max-width: 180px;
            height: 40px;
            padding: 8px 12px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            box-sizing: border-box;
            vertical-align: middle;
        }
        .export-number {
            width: 100px;
        }
        .export-msg {
            margin-top: 5px;
            color: #388e3c;
            font-weight: bold;
            text-align: center;
            width: 100%;
            display: flex;
            justify-content: center;
        }
        #export-msg, #view-export-msg {
            margin-top: 0;
            text-align: center;
            width: 100%;
            display: flex;
            justify-content: center;
        }
        /* Layout 2 c·ªôt cho ch·∫ø ƒë·ªô nh·∫≠p v√† xem */
        #input-preview-row, #view-mode-row {
            display: flex;
            gap: 32px;
            margin-bottom: 24px;
        }
        #input-preview-row .input-col, #input-preview-row .preview-col, #view-mode-row .view-col {
            flex: 1;
            min-width: 0;
        }
        #input-preview-row .preview-col, #view-svg-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            border: 1.5px solid #eee;
            border-radius: 8px;
            min-height: 320px;
            min-width: 200px;
            padding: 16px;
            /* Th√™m chi·ªÅu cao t·ªëi ƒëa v√† t·ªëi thi·ªÉu gi·ªëng .preview-col */
            height: 400px;
            max-height: 100%;
            width: 100%;
            box-sizing: border-box;
        }
        #input-preview-row .preview-col img, #view-svg-preview img {
            max-width: 100%;
            max-height: 100%;
            min-height: 200px;
            min-width: 200px;
            display: block;
            margin: 0 auto;
            object-fit: contain;
        }
        /* TƒÉng chi·ªÅu cao CodeMirror trong view-mode-row */
        #view-mode-row .CodeMirror {
            height: 320px !important;
            min-height: 320px !important;
            max-height: 100% !important;
        }
        /* TƒÉng chi·ªÅu cao CodeMirror trong input-preview-row */
        #input-preview-row .CodeMirror {
            height: 320px !important;
            min-height: 320px !important;
            max-height: 100% !important;
        }
        /* CSS cho result-tools-section */
        #result-tools-section {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .preview-placeholder {
            text-align: center;
            color: #999;
            font-style: italic;
        }
        .preview-placeholder p {
            margin: 0;
            font-size: 16px;
        }
        /* Responsive export-form: ch·ªâ 1 c·ªôt khi max-width: 600px */
        @media (max-width: 600px) {
            .export-form {
                grid-template-columns: 1fr;
            }
        }
        /* Line numbers */
        .hljs-ln-numbers {
            text-align: right;
            color: #999;
            border-right: 1px solid #ddd;
            vertical-align: top;
            padding-right: 8px !important;
            min-width: 25px;
            }
        .hljs-ln-code {
            padding-left: 8px !important;
        }
        /* View mode code editor */
        #view-tikz-code {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            position: relative;
        }
        #view-tikz-code pre {
            margin: 0;
            padding: 15px;
            background: transparent;
        }
        #view-tikz-code code {
            background: transparent;
            padding: 0;
        }
        .CodeMirror {
            height: 220px;
            font-size: 15px;
            border-radius: 6px;
            border: 1.5px solid #bbb;
            background: #f8f9fa;
            overflow: auto;
        }
        
        /* ƒê·∫£m b·∫£o CodeMirror trong tikz-code-block c√≥ scrollbar ƒë·∫πp */
        .tikz-code-block .CodeMirror {
            max-height: 300px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 5px;
        }
        
        /* T√πy ch·ªânh scrollbar cho CodeMirror */
        .tikz-code-block .CodeMirror-scrollbar-filler {
            background-color: #f0f0f0;
        }
        
        .tikz-code-block .CodeMirror-simplescroll-horizontal div,
        .tikz-code-block .CodeMirror-simplescroll-vertical div {
            background-color: #c1c1c1;
            border-radius: 10px;
        }
        
        /* ·∫®n textarea g·ªëc khi CodeMirror ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o */
        .tikz-code-block .tikz-cm {
            display: none;
        }
        .CodeMirror-placeholder {
            color: #bbb !important;
            font-style: italic;
        }
        /* Fix gutter/line number width for CodeMirror */
        .CodeMirror-gutter, .CodeMirror-gutters, .CodeMirror-linenumbers {
            width: 2.5em !important;
            min-width: 2.5em !important;
        }
        .CodeMirror-linenumber, .CodeMirror-gutter-elt {
            min-width: 2em !important;
            width: 2em !important;
            text-align: right !important;
            padding-right: 0.5em !important;
            box-sizing: content-box !important;
        }
        .export-form .export-col:first-child {
            max-width: 220px;
        }
        @media (max-width: 900px) {
            .export-select {
                min-width: 100px;
                max-width: 100%;
            }
        }
        .navbar-header-user {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            /* Kh√¥ng d√πng position:absolute */
        }
        
        /* Navbar user info styles */
        .navbar-user-info {
            padding: 6px 14px;
            border-radius: 6px;
            gap: 8px;
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(25, 118, 210, 0.2);
            transition: all 0.2s ease;
            text-decoration: none;
            cursor: pointer;
        }

        .navbar-user-info:hover {
            background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
            box-shadow: 0 4px 8px rgba(25, 118, 210, 0.3);
        }

        .navbar-avatar,
        .navbar-avatar-placeholder {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid #fff;
            object-fit: cover;
            background: #eee;
            flex-shrink: 0;
        }
        
        .navbar-avatar-placeholder {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .navbar-username {
            font-weight: 500;
            font-size: 13.5px;
            max-width: 100px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        @media (max-width: 600px) {
            .navbar-header-user {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
                margin-bottom: 12px;
            }
            
            .navbar-user-info {
                padding: 8px 12px;
                gap: 6px;
                border-radius: 6px;
                justify-content: center;
            }

            .navbar-avatar,
            .navbar-avatar-placeholder {
                width: 26px;
                height: 26px;
            }

            .navbar-username {
                font-size: 13px;
                max-width: 90px;
            }
        }
        .preview-col {
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            border-radius: 8px;
        }
        .compile-save-row-btn {
            min-width: 160px;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 5px;
            height: 48px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        #compile-btn.compile-save-row-btn {
            background-color: #007bff;
            color: white;
            border: none;
        }
        #compile-btn.compile-save-row-btn:hover {
            background-color: #0056b3;
        }
        #save-server-btn.compile-save-row-btn:hover {
            background-color: #e0a800;
        }
        .export-download-link {
            display: inline-block;
            background: linear-gradient(90deg, #17a2b8 0%, #138496 100%);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(23,162,184,0.2);
            margin-top: 8px;
        }

        .export-download-link:hover {
            background: linear-gradient(90deg, #138496 0%, #117a8b 100%);
            box-shadow: 0 4px 12px rgba(23,162,184,0.3);
            transform: translateY(-2px);
            color: white;
            text-decoration: none;
        }
        .export-btn-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #export-msg {
            margin-top: 0;
            text-align: center;
        }
        .export-btn-group {
            width: 100%;
        }
        #svg-code-container {
          transition: all 0.3s ease;
        }
        
        /* Hover effects cho c√°c n√∫t trong view mode */
        #view-copy-link-btn:hover {
            background: #e0a800 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,193,7,0.3) !important;
        }
        
        #view-download-svg-btn:hover {
            background: #138496 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(23,162,184,0.3) !important;
            text-decoration: none;
        }
        
        #view-back-to-edit-btn:hover {
            background: linear-gradient(90deg, #218838 0%, #1ea085 100%) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40,167,69,0.3) !important;
        }
        /* Layout 2 h√†ng cho export-form trong view mode */
        #view-export-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        #view-export-form .export-btn-group {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            margin-top: 16px;
        }
        #view-export-form .export-btn {
            min-width: 140px;
        }
        /* Responsive cho export-form trong view mode */
        @media (max-width: 1000px) {
            #view-export-form {
                grid-template-columns: 1fr;
                justify-items: center;
                gap: 16px;
            }
            #view-export-form .export-pair {
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: center;
                gap: 12px;
                width: 100%;
                max-width: 300px;
            }
            #view-export-form .export-label {
                text-align: right;
                font-weight: 600;
                color: #333;
                min-width: 80px;
                flex-shrink: 0;
            }
            #view-export-form .export-input,
            #view-export-form .export-select,
            #view-export-form .export-number {
                width: 120px;
                text-align: center;
                flex-shrink: 0;
            }
        }
        /* CSS cho c√°c n√∫t thao t√°c trong c·ªôt ph·∫£i view mode */
        #view-svg-actions {
            margin-top: 16px;
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        #view-svg-actions .view-action-btn {
            background: #ffc107;
            color: #212529;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(255,193,7,0.2);
            transition: all 0.2s;
            text-decoration: none;
        }
        #view-svg-actions .view-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,193,7,0.3);
        }
        #view-svg-actions .view-download-btn {
            background: #17a2b8;
            color: white;
        }
        #view-svg-actions .view-download-btn:hover {
            box-shadow: 0 4px 12px rgba(23,162,184,0.3);
        }
        /* Responsive cho c√°c n√∫t thao t√°c */
        @media (max-width: 800px) {
            #view-svg-actions {
                flex-direction: column;
                gap: 8px;
            }
        }
        #modal-svg-preview {
          text-align: center;
        }
        #modal-svg-img {
          display: inline-block;
          margin: 0 auto;
          max-width: 100%;
          max-height: 200px;
          object-fit: contain;
          border: 1px solid #ddd;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- Header navbar v·ªõi avatar, username v√† n√∫t profile -->
    <div class="navbar-header-user">
        {% if user_email %}
            <a href="/profile" class="navbar-user-info">
                <img src="{{ url_for('static', filename='avatars/' ~ avatar) if avatar else '' }}"
                     alt="Avatar" class="navbar-avatar"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                {% if not avatar %}
                <div class="navbar-avatar-placeholder">
                    {{ user_email[0].upper() }}
                </div>
                {% endif %}
                <span class="navbar-username">
                    {{ username or user_email.split('@')[0] }}
                </span>
            </a>
            <a id="logout-btn" href="#" style="background:#d32f2f; color:white; padding:8px 16px; border-radius:6px; text-decoration:none; font-weight:bold; font-size:14px;">ƒêƒÉng xu·∫•t</a>
        {% else %}
            <a id="user-email-btn" class="btn-header-login" style="background:#1976d2; color:white; padding:8px 18px; border-radius:6px; text-decoration:none; font-weight:bold; min-width:180px; text-align:center;">ƒêƒÉng nh·∫≠p Google</a>
        {% endif %}
    </div>
    <div class="container">
        <h2>Chuy·ªÉn ƒë·ªïi TikZ sang SVG/PNG/JPEG</h2>

        <!-- Truy·ªÅn tr·∫°ng th√°i login t·ª´ server v√†o JS -->
        <script>
          window.appState = {
            loggedIn: {{ 'true' if user_email else 'false' }},
            userEmail: "{{ user_email or '' }}",
            username: "{{ username or '' }}",
            avatar: "{{ avatar or '' }}"
          };
        </script>

        <script>
function updateHeaderLoginState() {
    // Logic m·ªõi: Header ƒë√£ ƒë∆∞·ª£c render t·ª´ server v·ªõi avatar/username
    // Ch·ªâ c·∫ßn x·ª≠ l√Ω c√°c logic b·ªï sung
    
    if (window.appState.loggedIn) {
        // G√°n s·ª± ki·ªán cho n√∫t ƒëƒÉng xu·∫•t
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.onclick = () => document.getElementById('logout-modal').style.display = 'flex';
        }
        
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t sau khi ƒëƒÉng nh·∫≠p
        updateButtonStates();
        
        // Ki·ªÉm tra xem c√≥ ·∫£nh SVG ƒëang ch·ªù hi·ªÉn th·ªã sau khi ƒëƒÉng nh·∫≠p kh√¥ng
        const pendingViewSvg = localStorage.getItem('pending_view_svg');
        if (pendingViewSvg) {
            try {
                const pendingData = JSON.parse(pendingViewSvg);
                if (pendingData.tikzCode && pendingData.svgFilename) {
                    // Hi·ªÉn th·ªã ·∫£nh SVG ƒë√£ l∆∞u (t·ª´ c·∫£ n√∫t üì∏ T·∫£i ·∫£nh PNG/JPEG v√† t·ª´ trang view_svg.html)
                    showViewMode(pendingData.tikzCode, pendingData.svgFilename);
                    // X√≥a d·ªØ li·ªáu ƒë√£ s·ª≠ d·ª•ng
                    localStorage.removeItem('pending_view_svg');
                    
                    // ƒê·∫£m b·∫£o view-mode-row lu√¥n n·∫±m tr√™n result-section
                    setTimeout(() => {
                        const resultSection = document.querySelector('.result-section');
                        const viewModeRow = document.getElementById('view-mode-row');
                        if (resultSection && viewModeRow) {
                            // Di chuy·ªÉn view-mode-row l√™n tr√™n result-section
                            resultSection.parentNode.insertBefore(viewModeRow, resultSection);
                        }
                    }, 100);
                }
            } catch (error) {
                console.error('Error parsing pending view SVG data:', error);
                localStorage.removeItem('pending_view_svg');
            }
        }
    } else {
        // G√°n s·ª± ki·ªán cho n√∫t ƒëƒÉng nh·∫≠p
        const loginBtn = document.getElementById('user-email-btn');
        if (loginBtn) {
            loginBtn.href = "/login/google";
            loginBtn.onclick = null;
        }
    }
}
document.addEventListener('DOMContentLoaded', updateHeaderLoginState);

// Sau khi login ‚Üí √©p reload ƒë·ªÉ ƒë·ªìng b·ªô session
if (window.location.search.includes('login=1')) {
  window.location.href = window.location.pathname;
}

// X·ª≠ l√Ω view_svg parameter t·ª´ profile page
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const viewSvgFilename = urlParams.get('view_svg');
    
    if (viewSvgFilename) {
        // T√¨m file card t∆∞∆°ng ·ª©ng
        const fileCards = document.querySelectorAll('.file-card');
        for (let card of fileCards) {
            const filename = card.getAttribute('data-filename');
            if (filename === viewSvgFilename) {
                // L·∫•y code TikZ t·ª´ data attribute
                let tikzCode = card.getAttribute('data-tikz-code') || '';
                if (!tikzCode) {
                    const textarea = card.querySelector('.tikz-cm');
                    if (textarea) tikzCode = textarea.value;
                }
                
                // Ki·ªÉm tra ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi hi·ªÉn th·ªã view mode
                if (!window.appState.loggedIn) {
                    // L∆∞u th√¥ng tin ·∫£nh SVG v√†o localStorage ƒë·ªÉ hi·ªÉn th·ªã sau khi ƒëƒÉng nh·∫≠p
                    localStorage.setItem('pending_view_svg', JSON.stringify({
                        tikzCode: tikzCode,
                        svgFilename: viewSvgFilename
                    }));
                    showLoginModal();
                    return;
                }
                
                // Hi·ªÉn th·ªã view mode
                showViewMode(tikzCode, viewSvgFilename);
                
                // X√≥a parameter kh·ªèi URL
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
                break;
            }
        }
    }
});
</script>

<script>
function setupRequireLogin() {
  // Ch·ªâ x·ª≠ l√Ω c√°c n√∫t kh√°c, kh√¥ng x·ª≠ l√Ω view-btn v√¨ ƒë√£ x·ª≠ l√Ω ri√™ng
  document.querySelectorAll('.files-section .file-copy-link-btn, .files-section .copy-btn').forEach(function(btn) {
    btn.onclick = function(e) {
      if (!window.appState.loggedIn) {
        e.preventDefault();
        showLoginModal();
      }
    };
  });
}
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded'); // Debug
            setupRequireLogin();
            initializeEventListeners(); // Kh·ªüi t·∫°o event listeners ban ƒë·∫ßu
        });

        // H√†m kh·ªüi t·∫°o event listeners cho c√°c n√∫t
        function initializeEventListeners() {
    // ----------------------------------------------
    // 1. Copy link (üîó Copy Link)
    // ----------------------------------------------
    document.querySelectorAll('.copy-link-btn').forEach(btn => {
        btn.onclick = function() {
            const link = this.getAttribute('data-link');
            if (link) {
                navigator.clipboard.writeText(link)
                    .then(() => showFeedback(this, '‚úÖ ƒê√£ copy!'))
                    .catch(() => showFeedback(this, '‚ùå L·ªói copy!'));
            }
        };
    });

    // ----------------------------------------------
    // 2. Copy Facebook link (üü¶ Copy link Facebook)
    // ----------------------------------------------
    document.querySelectorAll('.copy-fb-link-btn').forEach(btn => {
        btn.onclick = function() {
            const link = this.getAttribute('data-link');
            if (link) {
                const fbLink = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`;
                navigator.clipboard.writeText(fbLink)
                    .then(() => showFeedback(this, '‚úÖ ƒê√£ copy link Facebook!'))
                    .catch(() => showFeedback(this, '‚ùå L·ªói copy!'));
            }
        };
    });

    // ----------------------------------------------
    // 3. Xem code TikZ (üìù Xem code TikZ)
    // ----------------------------------------------
    document.querySelectorAll('.view-tikz-btn').forEach(btn => {
        btn.onclick = function() {
            const tikzCode = this.getAttribute('data-tikz-code');
            if (tikzCode) {
                showTikzCodeModal(tikzCode);
            }
        };
    });

    // ----------------------------------------------
    // 4. N√∫t l∆∞u server (üíæ L∆∞u server)
    // ----------------------------------------------
    document.querySelectorAll('#save-server-btn').forEach(btn => {
        btn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();

            const fileId = this.getAttribute('data-file-id');
            const tikzCode = this.getAttribute('data-tikz-code') || "";
            
            if (!fileId) {
                alert("L·ªói: kh√¥ng c√≥ file_id!");
                return;
            }

            // Reset modal
            const keywordsInput = document.getElementById('keywordsInput');
            const suggestionsBox = document.getElementById('keywordSuggestions');
            if (keywordsInput) keywordsInput.value = "";
            if (suggestionsBox) {
                suggestionsBox.innerHTML = '';
                suggestionsBox.style.display = 'none';
            }

            // L·∫•y URL ·∫£nh SVG t·ª´ preview hi·ªán t·∫°i
            const currentPreview = document.querySelector('.preview-col img');
            const modalSvgImg = document.getElementById('modal-svg-img');
            if (currentPreview && modalSvgImg) {
                modalSvgImg.src = currentPreview.src;
                modalSvgImg.style.display = 'block';
            } else if (modalSvgImg) {
                modalSvgImg.style.display = 'none';
            }

            // Ki·ªÉm tra xem c√≥ file_id h·ª£p l·ªá kh√¥ng (t·ª©c l√† ƒë√£ bi√™n d·ªãch th√†nh c√¥ng)
            if (!fileId || fileId === 'None' || fileId === '') {
                alert('‚ö†Ô∏è C·∫£nh b√°o: Ch∆∞a c√≥ ·∫£nh SVG ƒë∆∞·ª£c bi√™n d·ªãch th√†nh c√¥ng.\n\nVui l√≤ng nh·∫•n n√∫t "Bi√™n d·ªãch" tr∆∞·ªõc khi l∆∞u server.');
                return;
            }

            // Ki·ªÉm tra xem code TikZ hi·ªán t·∫°i c√≥ kh·ªõp v·ªõi code TikZ ƒë√£ ƒë∆∞·ª£c bi√™n d·ªãch kh√¥ng
            const currentTikzCode = window.cm ? window.cm.getValue() : document.getElementById('code').value;
            const compiledTikzCode = this.getAttribute('data-tikz-code') || "";
            
            // Debug: Log ƒë·ªÉ ki·ªÉm tra
            console.log('Current TikZ Code:', currentTikzCode.trim());
            console.log('Compiled TikZ Code:', compiledTikzCode.trim());
            console.log('Are they equal?', currentTikzCode.trim() === compiledTikzCode.trim());
            
            if (currentTikzCode.trim() !== compiledTikzCode.trim()) {
                alert('‚ö†Ô∏è C·∫£nh b√°o: Code TikZ hi·ªán t·∫°i kh√°c v·ªõi code TikZ ƒë√£ ƒë∆∞·ª£c bi√™n d·ªãch.\n\n·∫¢nh hi·ªÉn th·ªã: t·ª´ code TikZ hi·ªán t·∫°i\n·∫¢nh s·∫Ω ƒë∆∞·ª£c l∆∞u: t·ª´ code TikZ ƒë√£ bi√™n d·ªãch\n\nVui l√≤ng nh·∫•n n√∫t "Bi√™n d·ªãch" ƒë·ªÉ c·∫≠p nh·∫≠t tr∆∞·ªõc khi l∆∞u server.');
                return;
            }

            // L∆∞u th√¥ng tin t·∫°m th·ªùi
            window.pendingFileId = fileId;
            window.pendingTikzCode = tikzCode;

            // Hi·ªán modal Bootstrap
            const modal = new bootstrap.Modal(document.getElementById('keywordModal'));
            modal.show();
        };
    });

    // ----------------------------------------------
    // 5. N√∫t export PNG/JPEG (T·∫£i xu·ªëng)
    // ----------------------------------------------
    const exportBtn = document.getElementById('export-btn');
    if (exportBtn) {
        exportBtn.addEventListener('click', async function() {
            const svgTempId = exportBtn.getAttribute('data-file-id') || '';
            const format = document.getElementById('export-format').value;
            const widthVal = document.getElementById('export-width').value;
            const heightVal = document.getElementById('export-height').value;
            const dpiVal = document.getElementById('export-dpi').value;
            const msg = document.getElementById('export-msg');

            msg.textContent = '';
            if ((widthVal && widthVal <= 0) || (heightVal && heightVal <= 0) || (dpiVal && dpiVal <= 0)) {
                msg.textContent = 'Width, Height, DPI ph·∫£i l√† s·ªë d∆∞∆°ng!';
                return;
            }

            exportBtn.disabled = true;
            exportBtn.textContent = 'ƒêang x·ª≠ l√Ω...';

            try {
                const res = await fetch('/temp_convert', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_id: svgTempId,
                        fmt: format,
                        width: widthVal || undefined,
                        height: heightVal || undefined,
                        dpi: dpiVal || undefined
                    })
                });
                const data = await res.json();
                if (data.url) {
                    msg.innerHTML = `<a href="${data.url}" download class="export-download-link">T·∫£i v·ªÅ ${format.toUpperCase()}</a>`;
                } else {
                    msg.textContent = data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh!';
                }
            } catch (err) {
                msg.textContent = 'L·ªói k·∫øt n·ªëi ho·∫∑c m√°y ch·ªß!';
            }

            exportBtn.disabled = false;
            exportBtn.textContent = 'T·∫£i xu·ªëng';
        });
    }

    // ----------------------------------------------
    // 6. Toggle SVG Code (üìú Xem code SVG)
    // ----------------------------------------------
    const toggleSvgCodeBtn = document.getElementById('toggle-svg-code-btn');
    if (toggleSvgCodeBtn) {
        toggleSvgCodeBtn.onclick = function() {
            const container = document.getElementById('svg-code-container');
            if (container) {
                const currentlyHidden = container.style.display === 'none' || container.style.display === '';
                container.style.display = currentlyHidden ? 'block' : 'none';
                toggleSvgCodeBtn.textContent = currentlyHidden ? '‚ùå ·∫®n code SVG' : 'üìú Xem code SVG';
            }
        };
    }

    // ----------------------------------------------
    // 7. Copy SVG Code (üìã Copy Code)
    // ----------------------------------------------
    const copySvgCodeBtn = document.getElementById('copy-svg-code-btn');
    if (copySvgCodeBtn) {
        copySvgCodeBtn.onclick = function() {
            const codeBlock = document.getElementById('svgCode');
            if (codeBlock) {
                const text = codeBlock.innerText.trim();
                navigator.clipboard.writeText(text).then(() => {
                    copySvgCodeBtn.textContent = '‚úÖ ƒê√£ copy!';
                    setTimeout(() => {
                        copySvgCodeBtn.textContent = 'üìã Copy Code';
                    }, 2000);
                }).catch(() => {
                    copySvgCodeBtn.textContent = '‚ùå L·ªói copy!';
                    setTimeout(() => {
                        copySvgCodeBtn.textContent = 'üìã Copy Code';
                    }, 2000);
                });
            }
        };
    }
}
</script>

<!-- Modal ƒëƒÉng xu·∫•t ch·ªâ render n·∫øu ƒë√£ login -->
{% if user_email %}
<div id="logout-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:white; padding:32px 40px; border-radius:12px; box-shadow:0 2px 16px rgba(0,0,0,0.15); min-width:320px; text-align:center;">
    <h3 style="margin-bottom:24px;">ƒêƒÉng xu·∫•t?</h3>
    <a href="/logout" style="display:inline-block; background:#d32f2f; color:white; padding:10px 28px; border-radius:6px; text-decoration:none; font-weight:bold;">ƒêƒÉng xu·∫•t</a>
    <button onclick="document.getElementById('logout-modal').style.display='none'" style="margin-left:18px; background:#eee; color:#333; padding:10px 28px; border-radius:6px; border:none; font-weight:bold;">Hu·ª∑</button>
  </div>
</div>
{% endif %}

        <form id="tikz-form" method="post" onsubmit="console.log('Form submit event'); return submitTikzCodeAjax(event)">
          <div id="input-preview-row" class="flex-container">
            <!-- C·ªôt tr√°i: nh·∫≠p code -->
            <div class="input-col">
              <div class="form-group">
                <label for="code">Nh·∫≠p code TikZ:</label>
                <textarea name="code" id="code" rows="12" placeholder="Nh·∫≠p code TikZ t·∫°i ƒë√¢y...">{{ tikz_code|default('') }}</textarea>
              </div>
              <div class="d-flex justify-content-end align-items-center gap-2" id="compile-save-row">
                <button type="submit" id="compile-btn" class="compile-save-row-btn" {% if not logged_in %}title="B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p Google ƒë·ªÉ s·ª≠ d·ª•ng"{% endif %}>Bi√™n d·ªãch</button>
                <button
                  type="button"
                  id="save-server-btn"
                  class="compile-save-row-btn"
                  data-file-id="{{ svg_temp_id }}"
                  data-tikz-code="{{ tikz_code | e }}"
                  style="display: none;"
                >
                  üíæ L∆∞u server
                </button>
              </div>
            </div>
            <!-- C·ªôt ph·∫£i: preview -->
            <div class="preview-col">
              {% if error %}
                <div class="error">{{ error|safe }}</div>
              {% elif svg_temp_url %}
                <img src="{{ svg_temp_url }}" alt="SVG Preview" style="width:100%;height:100%;object-fit:contain;display:block;">
              {% else %}
                <div class="preview-placeholder">
                  <p>Nh·∫≠p code TikZ ƒë·ªÉ xem preview real-time</p>
                </div>
              {% endif %}
            </div>
          </div>
        </form>

        {% if svg_temp_url and not error %}
          <div id="result-tools-section">
                <div class="export-section">
                    <h4>Xu·∫•t ·∫£nh PNG/JPEG</h4>
                    <form id="export-form" class="export-form">
                        <div class="export-pair">
                            <label for="export-format" class="export-label">ƒê·ªãnh d·∫°ng:</label>
                            <select id="export-format" class="export-input export-select">
                                <option value="png">PNG</option>
                                <option value="jpeg">JPEG</option>
                            </select>
                        </div>
                        <div class="export-pair">
                            <label for="export-dpi" class="export-label">DPI:</label>
                            <input type="number" id="export-dpi" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-pair">
                            <label for="export-width" class="export-label">Width (px):</label>
                            <input type="number" id="export-width" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-pair">
                            <label for="export-height" class="export-label">Height (px):</label>
                            <input type="number" id="export-height" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-btn-group">
                            <button id="export-btn" type="button" class="export-btn" data-file-id="{{ svg_temp_id }}">T·∫£i xu·ªëng</button>
                        </div>
                    </form>
                    <div id="export-msg" style="margin-top:5px; color:#388e3c;"></div>
                </div>

                {% if svg_content %}
                    <div class="code-section">
                        <button id="toggle-svg-code-btn" class="copy-btn" type="button">üìú Xem code SVG</button>
                        <div id="svg-code-container" style="display:none; margin-top:12px;">
                            <div class="code-header">
                                <span class="code-title">Code SVG:</span>
                                <button id="copy-svg-code-btn" class="copy-btn" type="button">üìã Copy Code</button>
                            </div>
                            <div class="code-block" id="svgCode">
                                <pre><code class="language-xml">{{ svg_content }}</code></pre>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        {% endif %}

        {% if error %}
            <div class="result-section">
                <div class="error">{{ error|safe }}
                    {% if error_log_full %}
                        <br><button id="show-log-btn" style="margin-top:10px; background:#b71c1c; color:white; border:none; border-radius:4px; padding:6px 16px; cursor:pointer;">Hi·ªÉn th·ªã chi ti·∫øt log</button>
                        <pre id="full-log" style="display:none; background:#fff0f0; color:#b71c1c; border:1px solid #f5c6cb; border-radius:4px; padding:12px; margin-top:10px; max-height:400px; overflow:auto;">{{ error_log_full }}</pre>
                        <script>
                        document.getElementById('show-log-btn').onclick = function() {
                            var log = document.getElementById('full-log');
                            if (log.style.display === 'none') {
                                log.style.display = 'block';
                                this.textContent = '·∫®n chi ti·∫øt log';
                            } else {
                                log.style.display = 'none';
                                this.textContent = 'Hi·ªÉn th·ªã chi ti·∫øt log';
                            }
                        };
                        </script>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        {% if svg_files %}
            <div class="files-section">
            <h3>üìÇ C√°c file SVG ƒë√£ t·∫°o</h3>
            <div class="files-grid">
                    {% for file in svg_files %}
                        <div class="file-card" data-filename="{{ file.filename }}" data-tikz-code="{{ file.tikz_code | tojson | safe }}">
                            <img src="{{ file.url }}" alt="{{ file.filename }}" onerror="this.style.display='none'">
                            <h4><strong>{{ file.display_name }}</strong></h4>
                            <p><strong>K√≠ch th∆∞·ªõc:</strong> {{ file.size }} KB</p>
                            <p><strong>T·∫°o l√∫c:</strong> {{ file.created_time }}</p>
                            <div class="file-actions">
                                <a href="{{ file.url }}" target="_blank" class="view-btn">üì∏ T·∫£i ·∫£nh PNG/JPEG</a>
                                <button class="fb-share-btn" data-filename="{{ file.filename }}" style="background:#1877f3;color:white;font-weight:bold;">üü¶ Copy link Facebook</button>
                                <button class="file-copy-link-btn" onclick="copyToClipboard('{{ request.host_url.rstrip('/') ~ file.url }}', this, 'üîó Copy Link')">üîó Copy Link</button>
                                {% if file.tikz_code %}
                                    <button class="copy-btn" onclick="toggleTikzCode(this)">üìù Xem code TikZ</button>
                                {% endif %}
                            </div>
                            {% if file.tikz_code %}
                                <div class="tikz-code-block" style="display:none; margin-top:10px;">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                        <span style="font-weight:bold; color:#333;">Code TikZ:</span>
                                        <button class="copy-btn" style="padding:4px 10px; font-size:12px;" onclick="copyTikzCode(this)">üìã Copy</button>
                                    </div>
                                    <div class="code-block" style="margin:0;">
                                        <textarea class="tikz-cm" readonly>{{ file.tikz_code | e }}</textarea>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
                {% else %}
            <div class="files-section">
                <h3>üìÇ C√°c file SVG ƒë√£ t·∫°o</h3>
                    <div class="no-files">
                        Ch∆∞a c√≥ file SVG n√†o ƒë∆∞·ª£c t·∫°o. H√£y th·ª≠ chuy·ªÉn ƒë·ªïi m·ªôt code TikZ!
                    </div>
            </div>
        {% endif %}
    </div>

    <footer style='text-align:center;color:#888;font-size:14px;margin-top:40px;'>¬© 2024 TikZ2SVG - All rights reserved.</footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        var cm; // Khai b√°o global ƒë·ªÉ c√°c h√†m kh√°c truy c·∫≠p ƒë∆∞·ª£c
        function copyToClipboard(text, buttonElement, originalText) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = 0;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            if (buttonElement) {
                const originalContent = buttonElement.innerHTML;
                buttonElement.innerHTML = '‚úÖ ƒê√£ copy!';
                setTimeout(() => {
                    buttonElement.innerHTML = originalContent;
                }, 2000);
            }
        }

        function copySvgCode() {
            const codeBlock = document.getElementById('svgCode');
            const copyBtn = document.querySelector('.copy-btn');
            copyToClipboard(codeBlock.textContent, copyBtn, 'üìã Copy Code');
        }

        function copyTikzCode(btn) {
            // L·∫•y code t·ª´ CodeMirror instance n·∫øu c√≥, n·∫øu kh√¥ng th√¨ t·ª´ textarea g·ªëc
            const codeBlock = btn.closest('.tikz-code-block');
            const textarea = codeBlock.querySelector('.tikz-cm');
            let code = '';
            
            // ∆Øu ti√™n l·∫•y t·ª´ CodeMirror instance
            if (textarea.CodeMirror) {
                code = textarea.CodeMirror.getValue();
                console.log('Getting code from CodeMirror instance');
            } else {
                // Fallback: l·∫•y t·ª´ textarea g·ªëc
                code = textarea.value;
                console.log('Getting code from original textarea');
            }
            
            // Lo·∫°i b·ªè d√≤ng tr·∫Øng ·ªü ƒë·∫ßu v√† cu·ªëi, ch·ªâ gi·ªØ t·ªëi ƒëa 1 d√≤ng tr·∫Øng li√™n ti·∫øp
            let lines = code.split('\n');
            while (lines.length && lines[0].trim() === '') lines.shift();
            while (lines.length && lines[lines.length - 1].trim() === '') lines.pop();
            let cleaned = [];
            let lastBlank = false;
            for (let line of lines) {
                if (line.trim() === '') {
                    if (!lastBlank) cleaned.push('');
                    lastBlank = true;
                } else {
                    cleaned.push(line);
                    lastBlank = false;
                }
            }
            
            const finalCode = cleaned.join('\n');
            console.log('Copying code:', finalCode.substring(0, 100) + '...');
            copyToClipboard(finalCode, btn, 'üìã Copy');
        }

        function showViewMode(tikzCode, svgFilename) {
            // X√≥a block view mode c≈© n·∫øu c√≥
            let viewRow = document.getElementById('view-mode-row');
            if (viewRow) viewRow.remove();
            // X√≥a block export-section c≈© n·∫øu c√≥
            let oldExport = document.getElementById('view-export-section');
            if (oldExport) oldExport.remove();
            // ·∫®n form nh·∫≠p code TikZ v√† n√∫t Bi√™n d·ªãch c≈©
            const form = document.querySelector('form');
            if (form) form.style.display = 'none';
            // ·∫®n result-tools-section n·∫øu c√≥
            const resultToolsSection = document.getElementById('result-tools-section');
            if (resultToolsSection) resultToolsSection.style.display = 'none';
            // T·∫°o layout 2 c·ªôt m·ªõi
            viewRow = document.getElementById('view-mode-row');
            if (!viewRow) {
                viewRow = document.createElement('div');
                viewRow.id = 'view-mode-row';
                viewRow.innerHTML = `
                    <div class="view-col">
                        <div style="margin-bottom:20px;">
                            <h4 style="color:#333; margin-bottom:15px;">C√°c thao t√°c</h4>
                            <div style="display:flex; flex-direction:column; gap:10px;">
                                <button id="view-back-to-edit-btn" style="background:linear-gradient(90deg, #28a745 0%, #20c997 100%);color:white;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 2px 8px rgba(40,167,69,0.2);transition:all 0.2s;">
                                    ‚Ü©Ô∏è Quay v·ªÅ ch·ªânh s·ª≠a code TikZ
                                </button>
                            </div>
                        </div>
                        <div id="view-export-section">
                            <div class="export-section">
                                <h4>Xu·∫•t ·∫£nh PNG/JPEG</h4>
                                <form id="view-export-form" class="export-form">
                                    <div class="export-pair">
                                        <label for="view-export-format" class="export-label">ƒê·ªãnh d·∫°ng:</label>
                                        <select id="view-export-format" class="export-input export-select">
                                            <option value="png">PNG</option>
                                            <option value="jpeg">JPEG</option>
                                        </select>
                                    </div>
                                    <div class="export-pair">
                                        <label for="view-export-dpi" class="export-label">DPI:</label>
                                        <input type="number" id="view-export-dpi" min="1" class="export-input export-number" placeholder="Auto">
                                    </div>
                                    <div class="export-pair">
                                        <label for="view-export-width" class="export-label">Width (px):</label>
                                        <input type="number" id="view-export-width" min="1" class="export-input export-number" placeholder="Auto">
                                    </div>
                                    <div class="export-pair">
                                        <label for="view-export-height" class="export-label">Height (px):</label>
                                        <input type="number" id="view-export-height" min="1" class="export-input export-number" placeholder="Auto">
                                    </div>
                                    <div class="export-btn-group">
                                        <button id="view-export-btn" type="button" class="export-btn">T·∫£i xu·ªëng</button>
                                    </div>
                                </form>
                                <div id="view-export-msg" style="margin-top:5px; color:#388e3c;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="view-col">
                        <div id="view-svg-preview">
                            <img id="view-svg-img" src="/static/${svgFilename}" alt="SVG Preview" style="width:100%;height:100%;display:block;margin:0 auto;object-fit:contain;border:1px solid #eee;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                        </div>
                        <div id="view-svg-actions">
                            <button id="view-copy-link-btn" class="view-action-btn">
                                üîó Copy Link
                            </button>
                            <a id="view-download-svg-btn" href="/static/${svgFilename}" download class="view-action-btn view-download-btn">
                                üì• T·∫£i xu·ªëng SVG
                            </a>
                        </div>
                    </div>
                `;
                // Th√™m v√†o ƒë√∫ng v·ªã tr√≠ ph√≠a tr√™n form ho·∫∑c files-section
                const container = document.querySelector('.container');
                const filesSection = document.querySelector('.files-section');
                if (container && form && form.parentNode === container) {
                    container.insertBefore(viewRow, form);
                } else if (container && filesSection) {
                    container.insertBefore(viewRow, filesSection);
                } else if (container) {
                    container.appendChild(viewRow);
                }
            } else {
                viewRow.style.display = '';
                document.getElementById('view-svg-img').src = '/static/' + svgFilename;
                // C·∫≠p nh·∫≠t link download v√† copy link
                const downloadBtn = document.getElementById('view-download-svg-btn');
                if (downloadBtn) {
                    downloadBtn.href = '/static/' + svgFilename;
                }
            }
            // L∆∞u code TikZ v√†o bi·∫øn ƒë·ªÉ s·ª≠ d·ª•ng cho n√∫t "Quay v·ªÅ ch·ªânh s·ª≠a"
            window.currentViewTikzCode = tikzCode;
            
            // G√°n s·ª± ki·ªán cho n√∫t Copy Link
            const copyLinkBtn = document.getElementById('view-copy-link-btn');
            if (copyLinkBtn) {
                copyLinkBtn.onclick = function() {
                    const svgUrl = window.location.origin + '/static/' + svgFilename;
                    copyToClipboard(svgUrl, this, 'üîó Copy Link');
                };
            }
            
            // G√°n s·ª± ki·ªán cho n√∫t "‚Ü©Ô∏è Quay v·ªÅ ch·ªânh s·ª≠a code TikZ"
            const backToEditBtn = document.getElementById('view-back-to-edit-btn');
            if (backToEditBtn) {
                backToEditBtn.onclick = function() {
                    // L·∫•y code TikZ ƒë√£ l∆∞u
                    const currentCode = window.currentViewTikzCode || tikzCode;
                    
                    // L∆∞u code v√†o localStorage ƒë·ªÉ trang ch·ªß c√≥ th·ªÉ ƒë·ªçc
                    localStorage.setItem('tikz_code_for_compile', currentCode);
                    
                    // Reload trang ch·ªß
                    window.location.href = '/';
                };
            }
            // Cu·ªôn l√™n khung nh·∫≠p code
            viewRow.scrollIntoView({behavior: 'smooth', block: 'center'});
            // ·∫®n n√∫t L∆∞u server n·∫øu c√≥
            const saveBtn = document.getElementById('save-server-btn');
            if (saveBtn) saveBtn.style.display = 'none';
            // G√°n l·∫°i logic xu·∫•t PNG/JPEG cho file ƒë√£ l∆∞u
            setTimeout(function() {
                const exportBtn = document.getElementById('view-export-btn');
            if (exportBtn) {
                    exportBtn.onclick = async function() {
                        const format = document.getElementById('view-export-format').value;
                        const widthVal = document.getElementById('view-export-width').value;
                        const heightVal = document.getElementById('view-export-height').value;
                        const dpiVal = document.getElementById('view-export-dpi').value;
                        const msg = document.getElementById('view-export-msg');
                    msg.textContent = '';
                    if ((widthVal && widthVal <= 0) || (heightVal && heightVal <= 0) || (dpiVal && dpiVal <= 0)) {
                        msg.textContent = 'Width, Height, DPI ph·∫£i l√† s·ªë d∆∞∆°ng!';
                        return;
                    }
                    exportBtn.disabled = true;
                    exportBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
                    try {
                        const res = await fetch('/convert', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                    filename: svgFilename,
                                    fmt: format,
                                    width: widthVal || undefined,
                                    height: heightVal || undefined,
                                    dpi: dpiVal || undefined
                                })
                            });
                            const data = await res.json();
                            if (data.url) {
                                msg.innerHTML = `<a href="${data.url}" download class="export-download-link">T·∫£i v·ªÅ ${format.toUpperCase()}</a>`;
                            } else {
                                msg.textContent = data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh!';
                            }
                        } catch (err) {
                            msg.textContent = 'L·ªói k·∫øt n·ªëi ho·∫∑c m√°y ch·ªß!';
                        }
                        exportBtn.disabled = false;
                        exportBtn.textContent = 'T·∫£i xu·ªëng';
                    };
                }
            }, 100);
        }

        document.addEventListener('DOMContentLoaded', function() {
            var tikzCode = document.getElementById('code');
            cm = CodeMirror.fromTextArea(tikzCode, {
                mode: 'stex',
                theme: 'material',
                lineNumbers: true,
                lineWrapping: true,
                placeholder: 'Nh·∫≠p code TikZ t·∫°i ƒë√¢y...'
            });
            cm.setValue({{ tikz_code|default('')|tojson|safe }});
            
            // Th√™m s·ª± ki·ªán click v√†o CodeMirror ƒë·ªÉ hi·ªán modal ƒëƒÉng nh·∫≠p n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
            if (!window.appState.loggedIn) {
                cm.on('mousedown', function() {
                    showLoginModal();
                });
            }
            
            // Th√™m s·ª± ki·ªán real-time preview cho form nh·∫≠p code
            let inputPreviewTimer;
            cm.on('change', function() {
                clearTimeout(inputPreviewTimer);
                inputPreviewTimer = setTimeout(() => {
                    updateInputPreview(cm.getValue());
                }, 1000); // Delay 1 gi√¢y sau khi ng·ª´ng g√µ
            });
            
            // G√°n s·ª± ki·ªán cho n√∫t üì∏ T·∫£i ·∫£nh PNG/JPEG
            document.querySelectorAll('.view-btn').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const card = btn.closest('.file-card');
                    // L·∫•y ƒë√∫ng t√™n file SVG th·∫≠t t·ª´ data-filename
                    const svgFilename = card.getAttribute('data-filename');
                    // ∆Øu ti√™n l·∫•y code TikZ t·ª´ data-tikz-code ho·∫∑c textarea
                    let tikzCode = card.getAttribute('data-tikz-code') || '';
                    if (!tikzCode) {
                        const textarea = card.querySelector('.tikz-cm');
                        if (textarea) tikzCode = textarea.value;
                    }
                    // Ki·ªÉm tra ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi hi·ªÉn th·ªã view mode
                    if (!window.appState.loggedIn) {
                        // L∆∞u th√¥ng tin ·∫£nh SVG v√†o localStorage ƒë·ªÉ hi·ªÉn th·ªã sau khi ƒëƒÉng nh·∫≠p
                        localStorage.setItem('pending_view_svg', JSON.stringify({
                            tikzCode: tikzCode,
                            svgFilename: svgFilename
                        }));
                        showLoginModal();
                        return;
                    }
                    showViewMode(tikzCode, svgFilename);
                });
            });
            // S·ª± ki·ªán copy link Facebook
            document.querySelectorAll('.fb-share-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const filename = btn.getAttribute('data-filename');
                    const shareUrl = `${window.location.origin}/view_svg/${filename}`;
                    const textArea = document.createElement('textarea');
                    textArea.value = shareUrl;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = 0;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    btn.innerHTML = '‚úÖ ƒê√£ copy link Facebook!';
                    setTimeout(() => {
                        btn.innerHTML = 'üü¶ Copy link Facebook';
                    }, 2000);
                });
            });

            // N·∫øu c√≥ code TikZ t·ª´ localStorage (t·ª´ View Mode), ƒëi·ªÅn v√†o textarea ch√≠nh
            const tikzFromStorage = localStorage.getItem('tikz_code_for_compile');
            if (tikzFromStorage) {
                // ƒêi·ªÅn code v√†o textarea ch√≠nh
                if (window.cm && typeof window.cm.setValue === 'function') {
                    window.cm.setValue(tikzFromStorage);
                } else {
                    const textarea = document.getElementById('code');
                    if (textarea) textarea.value = tikzFromStorage;
                }
                // X√≥a d·ªØ li·ªáu ƒë√£ s·ª≠ d·ª•ng
                localStorage.removeItem('tikz_code_for_compile');
            }
            
            // Ki·ªÉm tra xem c√≥ ·∫£nh SVG ƒëang ch·ªù hi·ªÉn th·ªã sau khi ƒëƒÉng nh·∫≠p kh√¥ng
            const pendingViewSvg = localStorage.getItem('pending_view_svg');
            if (pendingViewSvg) {
                try {
                    const pendingData = JSON.parse(pendingViewSvg);
                    if (pendingData.tikzCode && pendingData.svgFilename) {
                        if (window.appState.loggedIn) {
                            // ƒê√£ ƒëƒÉng nh·∫≠p: hi·ªÉn th·ªã ·∫£nh SVG ƒë√£ l∆∞u
                            showViewMode(pendingData.tikzCode, pendingData.svgFilename);
                            // X√≥a d·ªØ li·ªáu ƒë√£ s·ª≠ d·ª•ng
                            localStorage.removeItem('pending_view_svg');
                        } else {
                            // Ch∆∞a ƒëƒÉng nh·∫≠p: hi·ªÉn th·ªã modal ƒëƒÉng nh·∫≠p
                            showLoginModal();
                        }
                    }
                } catch (error) {
                    console.error('Error parsing pending view SVG data:', error);
                    localStorage.removeItem('pending_view_svg');
                }
            }
            
            // ƒê·∫£m b·∫£o view-mode-row lu√¥n n·∫±m tr√™n result-section n·∫øu c√≥ pending_view_svg
            const hasPendingViewSvg = localStorage.getItem('pending_view_svg');
            if (hasPendingViewSvg && window.appState.loggedIn) {
                const resultSection = document.querySelector('.result-section');
                const viewModeRow = document.getElementById('view-mode-row');
                if (resultSection && viewModeRow) {
                    // Di chuy·ªÉn view-mode-row l√™n tr√™n result-section
                    resultSection.parentNode.insertBefore(viewModeRow, resultSection);
                }
            }
            
            // Kh·ªüi t·∫°o preview n·∫øu c√≥ code TikZ ban ƒë·∫ßu
            const initialCode = cm.getValue();
            if (initialCode && initialCode.trim()) {
                updateInputPreview(initialCode);
            }

            // Highlight v√† s·ªë d√≤ng khi nh·∫≠p code
            function highlightTikzInput() {
                const code = tikzCode;
                // X√≥a c√°c span line-number c≈© n·∫øu c√≥
                code.querySelectorAll('.hljs-ln-numbers, .hljs-ln-code').forEach(e => e.remove());
                hljs.highlightElement(code);
            }
            tikzCode.addEventListener('input', function() {
                clearTimeout(window.tikzInputTimer);
                window.tikzInputTimer = setTimeout(highlightTikzInput, 120);
            });
            // X·ª≠ l√Ω paste gi·ªØ xu·ªëng d√≤ng v√† highlight l·∫°i
            tikzCode.addEventListener('paste', function(e) {
                e.preventDefault();
                var text = (e.clipboardData || window.clipboardData).getData('text');
                // Ch√®n t·ª´ng d√≤ng v·ªõi <br>
                document.execCommand('insertHTML', false, text.replace(/\n/g, '<br>'));
                setTimeout(function() {
                    highlightTikzInput();
                }, 10);
            });
            // Submit: copy code v√†o textarea ·∫©n
                    function submitTikzCode() {
            // Ki·ªÉm tra ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi submit
            if (!window.appState.loggedIn) {
                showLoginModal();
                return false;
            }
            tikzCode.value = cleanControlChars(cm.getValue());
            return true;
        }

        // H√†m AJAX m·ªõi ƒë·ªÉ submit kh√¥ng reload trang
        async function submitTikzCodeAjax(event) {
            console.log('AJAX submit started'); // Debug
            event.preventDefault(); // NgƒÉn form submit b√¨nh th∆∞·ªùng
            
            // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
            if (!window.appState.loggedIn) {
                showLoginModal();
                return false;
            }

            // L·∫•y code t·ª´ CodeMirror
            const tikzCode = cleanControlChars(cm.getValue());
            if (!tikzCode.trim()) {
                alert('Vui l√≤ng nh·∫≠p code TikZ');
                return false;
            }

            // Hi·ªÉn th·ªã loading
            const compileBtn = document.getElementById('compile-btn');
            const originalText = compileBtn.textContent;
            compileBtn.textContent = 'ƒêang bi√™n d·ªãch...';
            compileBtn.disabled = true;

            try {
                // G·ª≠i request AJAX
                const formData = new FormData();
                formData.append('code', tikzCode);

                const response = await fetch('/', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    // C·∫≠p nh·∫≠t preview
                    const previewCol = document.querySelector('.preview-col');
                    const newPreviewCol = doc.querySelector('.preview-col');
                    if (previewCol && newPreviewCol) {
                        previewCol.innerHTML = newPreviewCol.innerHTML;
                    }

                    // C·∫≠p nh·∫≠t result-tools-section
                    const resultToolsSection = document.getElementById('result-tools-section');
                    const newResultToolsSection = doc.getElementById('result-tools-section');
                    
                    if (newResultToolsSection) {
                        if (resultToolsSection) {
                            resultToolsSection.innerHTML = newResultToolsSection.innerHTML;
                            resultToolsSection.style.display = 'block';
                        } else {
                            // T·∫°o m·ªõi result-tools-section n·∫øu ch∆∞a c√≥
                            const newSection = document.createElement('div');
                            newSection.id = 'result-tools-section';
                            newSection.innerHTML = newResultToolsSection.innerHTML;
                            document.querySelector('form').after(newSection);
                        }
                    } else if (resultToolsSection) {
                        resultToolsSection.style.display = 'none';
                    }

                    // Kh·ªüi t·∫°o l·∫°i c√°c event listeners cho c√°c n√∫t m·ªõi
                    initializeEventListeners();

                    // Kh·ªüi t·∫°o l·∫°i CodeMirror cho textarea id="code"
                    ensureCodeMirror();
                    
                    // Debug: Ki·ªÉm tra n√∫t save server c√≥ ƒë∆∞·ª£c g√°n event ch∆∞a
                    const saveServerBtn = document.getElementById('save-server-btn');
                    if (saveServerBtn) {
                        console.log('Save server button found after AJAX update');
                        console.log('Button onclick:', saveServerBtn.onclick);
                    } else {
                        console.log('Save server button not found after AJAX update');
                    }

                    // Hi·ªán n√∫t L∆∞u server sau khi bi√™n d·ªãch th√†nh c√¥ng
                    if (saveServerBtn && newResultToolsSection) {
                        // L·∫•y svg_temp_id m·ªõi t·ª´ n√∫t export-btn ho·∫∑c t·ª´ DOM m·ªõi
                        const exportBtn = newResultToolsSection.querySelector('#export-btn');
                        if (exportBtn) {
                            const newFileId = exportBtn.getAttribute('data-file-id');
                            if (newFileId) saveServerBtn.setAttribute('data-file-id', newFileId);
                        }
                        // L·∫•y code TikZ m·ªõi t·ª´ CodeMirror
                        if (window.cm && typeof window.cm.getValue === 'function') {
                            saveServerBtn.setAttribute('data-tikz-code', window.cm.getValue());
                        }
                        saveServerBtn.style.display = 'inline-block';
                    }
                } else {
                    throw new Error('L·ªói server');
                }
            } catch (error) {
                console.error('L·ªói bi√™n d·ªãch:', error);
                alert('C√≥ l·ªói x·∫£y ra khi bi√™n d·ªãch. Vui l√≤ng th·ª≠ l·∫°i.');
            } finally {
                // Kh√¥i ph·ª•c n√∫t
                compileBtn.textContent = originalText;
                compileBtn.disabled = false;
                console.log('AJAX submit completed'); // Debug
            }

            return false;
        }
        window.submitTikzCodeAjax = submitTikzCodeAjax;
            // Highlight v√† placeholder ban ƒë·∫ßu
            highlightTikzInput();

            // B·ªé V√íNG L·∫∂P N√ÄY - Ch·ªâ kh·ªüi t·∫°o CodeMirror khi c·∫ßn trong toggleTikzCode
            // document.querySelectorAll('.tikz-cm').forEach(function(textarea) {
            //     if (!textarea.CodeMirror) {
            //         CodeMirror.fromTextArea(textarea, {
            //             mode: 'stex',
            //             theme: 'material',
            //             lineNumbers: true,
            //             readOnly: true,
            //             viewportMargin: Infinity
            //         });
            //     }
            // });
        });

        // ƒê∆∞a code ban ƒë·∫ßu v√†o code block (gi·ªØ xu·ªëng d√≤ng)
        var tikzCodeInit = `{{ tikz_code|e }}`;
        var tikzInput = document.getElementById('code');
        if (tikzCodeInit && tikzCodeInit.trim() !== '') tikzInput.value = tikzCodeInit;
        // Highlight v√† s·ªë d√≤ng khi nh·∫≠p code
        function highlightTikzInput() {
            const code = tikzInput;
            // X√≥a c√°c span line-number c≈© n·∫øu c√≥
            code.querySelectorAll('.hljs-ln-numbers, .hljs-ln-code').forEach(e => e.remove());
            hljs.highlightElement(code);
        }
        tikzInput.addEventListener('input', function() {
            clearTimeout(window.tikzInputTimer);
            window.tikzInputTimer = setTimeout(highlightTikzInput, 120);
        });
        // X·ª≠ l√Ω paste gi·ªØ xu·ªëng d√≤ng v√† highlight l·∫°i
        tikzInput.addEventListener('paste', function(e) {
            e.preventDefault();
            var text = (e.clipboardData || window.clipboardData).getData('text');
            // Ch√®n t·ª´ng d√≤ng v·ªõi <br>
            document.execCommand('insertHTML', false, text.replace(/\n/g, '<br>'));
            setTimeout(function() {
                highlightTikzInput();
            }, 10);
        });
        // Submit: copy code v√†o textarea ·∫©n (cho real-time preview)
        function submitTikzCodeForPreview() {
            tikzInput.value = cleanControlChars(cm.getValue());
            return true;
        }
        // Highlight v√† placeholder ban ƒë·∫ßu
        highlightTikzInput();

        // H√†m c·∫≠p nh·∫≠t preview real-time cho form nh·∫≠p code
        async function updateInputPreview(tikzCode) {
            if (!tikzCode.trim()) {
                const previewContainer = document.querySelector('#input-preview-row .preview-col');
                if (previewContainer) {
                    previewContainer.innerHTML = '<div class="preview-placeholder"><p>Nh·∫≠p code TikZ ƒë·ªÉ xem preview real-time</p></div>';
                }
                return;
            }
            
            const previewContainer = document.querySelector('#input-preview-row .preview-col');
            if (previewContainer) {
                previewContainer.innerHTML = '<div class="preview-placeholder"><p>ƒêang c·∫≠p nh·∫≠t preview...</p></div>';
            }
            
            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `code=${encodeURIComponent(tikzCode)}`
                });
                
                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    // T√¨m SVG trong preview-col thay v√¨ svg-preview
                    const newSvgUrl = doc.querySelector('.preview-col img')?.src;
                    
                    if (newSvgUrl && previewContainer) {
                        previewContainer.innerHTML = `<img src="${newSvgUrl}" alt="SVG Preview (Real-time)" style="width:100%;height:100%;object-fit:contain;display:block;">`;
                    } else if (previewContainer) {
                        previewContainer.innerHTML = '<div class="preview-placeholder"><p>Kh√¥ng th·ªÉ t·∫°o preview</p></div>';
                    }
                } else {
                    if (previewContainer) {
                        previewContainer.innerHTML = '<div class="preview-placeholder"><p>L·ªói khi t·∫°o preview</p></div>';
                    }
                }
            } catch (error) {
                console.log('Input preview update failed:', error);
                if (previewContainer) {
                    previewContainer.innerHTML = '<div class="preview-placeholder"><p>L·ªói k·∫øt n·ªëi</p></div>';
                }
            }
        }

        // H√†m c·∫≠p nh·∫≠t preview real-time cho view mode
        async function updateRealTimePreview(tikzCode) {
            if (!tikzCode.trim()) return;
            
            const previewImg = document.getElementById('view-svg-img');
            if (previewImg) {
                previewImg.style.opacity = '0.5';
                previewImg.alt = 'ƒêang c·∫≠p nh·∫≠t preview...';
            }
            
            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `code=${encodeURIComponent(tikzCode)}`
                });
                
                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    // T√¨m SVG trong preview-col thay v√¨ svg-preview
                    const newSvgUrl = doc.querySelector('.preview-col img')?.src;
                    
                    if (newSvgUrl && previewImg) {
                        previewImg.src = newSvgUrl;
                        previewImg.style.opacity = '1';
                        previewImg.alt = 'SVG Preview (Real-time)';
                        
                        // C·∫≠p nh·∫≠t link download v√† copy link cho preview m·ªõi
                        const downloadBtn = document.getElementById('view-download-svg-btn');
                        if (downloadBtn) {
                            downloadBtn.href = newSvgUrl;
                        }
                        
                        // C·∫≠p nh·∫≠t s·ª± ki·ªán copy link cho preview m·ªõi
                        const copyLinkBtn = document.getElementById('view-copy-link-btn');
                        if (copyLinkBtn) {
                            copyLinkBtn.onclick = function() {
                                copyToClipboard(newSvgUrl, this, 'üîó Copy Link');
                            };
                        }
                    }
                }
            } catch (error) {
                console.log('Preview update failed:', error);
                if (previewImg) {
                    previewImg.style.opacity = '1';
                    previewImg.alt = 'SVG Preview';
                }
            }
        }

        function toggleTikzCode(btn) {
            console.log('toggleTikzCode called');
            const card = btn.closest('.file-card');
            const codeBlock = card.querySelector('.tikz-code-block');
            const textarea = codeBlock.querySelector('.tikz-cm');

            console.log('Card:', card);
            console.log('CodeBlock:', codeBlock);
            console.log('Textarea:', textarea);
            console.log('Textarea value:', textarea ? textarea.value : 'null');

            if (!codeBlock || !textarea) {
                console.error('Kh√¥ng t√¨m th·∫•y code block ho·∫∑c textarea');
                return;
            }

            if (codeBlock.style.display === 'none') {
                // 1. **Hi·ªÉn th·ªã v√πng ch·ª©a CodeMirror tr∆∞·ªõc.**
                codeBlock.style.display = 'block';

                // 2. **Ki·ªÉm tra xem ƒë√£ c√≥ th·ªÉ hi·ªán CodeMirror cho textarea n√†y ch∆∞a.**
                let cmInstance = textarea.CodeMirror;
                if (!cmInstance) {
                    try {
                        // X√≥a b·∫•t k·ª≥ CodeMirror instance n√†o ƒë√£ t·ªìn t·∫°i trong codeBlock
                        const existingCm = codeBlock.querySelector('.CodeMirror');
                        if (existingCm) {
                            existingCm.remove();
                        }
                        
                        cmInstance = CodeMirror.fromTextArea(textarea, {
                            mode: 'stex',
                            theme: 'material',
                            lineNumbers: true,
                            readOnly: true,
                            viewportMargin: Infinity,
                            scrollbarStyle: 'native'
                        });
                        console.log('CodeMirror initialized for textarea');
                    } catch (error) {
                        console.error('Error initializing CodeMirror:', error);
                        return;
                    }
                } else {
                    console.log('CodeMirror already exists, reusing instance');
                }

                // 3. **L√†m m·ªõi CodeMirror sau khi n√≥ hi·ªÉn th·ªã ho·∫∑c v·ª´a ƒë∆∞·ª£c kh·ªüi t·∫°o.**
                setTimeout(() => {
                    if (cmInstance && typeof cmInstance.refresh === 'function') {
                        cmInstance.refresh();
                        console.log('CodeMirror refreshed');
                    }
                }, 100);

                btn.innerHTML = '·∫®n code TikZ';
            } else {
                // ·∫®n code block nh∆∞ng gi·ªØ nguy√™n CodeMirror instance
                codeBlock.style.display = 'none';
                btn.innerHTML = 'üìù Xem code TikZ';
                console.log('Code block hidden (CodeMirror instance preserved)');
            }
        }
    </script>
    <!-- Highlight.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/latex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
    <script>
        // Initialize highlight.js
        document.addEventListener('DOMContentLoaded', function() {
            hljs.highlightAll();
            hljs.initLineNumbersOnLoad();
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/stex/stex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/display/placeholder.min.js"></script>
    <script>
    // H√†m lo·∫°i b·ªè k√Ω t·ª± ƒëi·ªÅu khi·ªÉn (tr·ª´ \n, \t)
    function cleanControlChars(str) {
        return str.replace(/[^\x09\x0A\x20-\x7E\xA0-\uFFFF]/g, '');
    }
    </script>
    <!-- Modal ƒëƒÉng nh·∫≠p -->
<div id="login-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:white; padding:32px; border-radius:8px; text-align:center; max-width:90vw; margin:100px auto; box-shadow:0 4px 32px rgba(0,0,0,0.15);">
    <p style="font-size:18px; color:#1976d2; margin-bottom:20px;">C·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y</p>
    <button id="modal-login-btn" style="background:#1976d2;color:white;padding:10px 24px;border-radius:6px;font-weight:bold;width:80%;margin:12px auto;display:block;">ƒêƒÉng nh·∫≠p Google</button>
    <br><br>
    <button onclick="document.getElementById('login-modal').style.display='none'" style="margin-top:10px; padding:8px 18px; border-radius:6px; border:none; background:#eee; color:#1976d2; font-weight:bold; cursor:pointer;">ƒê√≥ng</button>
  </div>
</div>

    <script>
// Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p t·ª´ backend
const isLoggedIn = {{ 'true' if user_email else 'false' }};
// G√°n s·ª± ki·ªán cho c√°c n√∫t c·∫ßn ƒëƒÉng nh·∫≠p trong files-section
window.addEventListener('DOMContentLoaded', function() {
  console.log('DOMContentLoaded - appState.loggedIn:', window.appState.loggedIn);
  
                  // Logic cho n√∫t "üì∏ T·∫£i ·∫£nh PNG/JPEG" - c·∫ßn ƒëƒÉng nh·∫≠p (ƒë√£ x·ª≠ l√Ω trong ph·∫ßn kh·ªüi t·∫°o CodeMirror)
  // Kh√¥ng c·∫ßn x·ª≠ l√Ω ·ªü ƒë√¢y v√¨ ƒë√£ c√≥ ki·ªÉm tra ƒëƒÉng nh·∫≠p trong event listener g·ªëc
  
  // Logic cho n√∫t "üîó Copy Link" - c·∫ßn ƒëƒÉng nh·∫≠p
  document.querySelectorAll('.files-section .file-copy-link-btn').forEach(function(btn) {
    if (!window.appState.loggedIn) {
      // L∆∞u onclick g·ªëc
      const originalOnclick = btn.getAttribute('onclick');
      btn.setAttribute('data-original-onclick', originalOnclick);
      btn.onclick = function(e) {
        e.preventDefault();
        showLoginModal();
      };
    }
  });
  
  // Logic cho n√∫t "üìù Xem code TikZ" - c·∫ßn ƒëƒÉng nh·∫≠p
  document.querySelectorAll('.files-section .copy-btn[onclick*="toggleTikzCode"]').forEach(function(btn) {
    if (!window.appState.loggedIn) {
      // L∆∞u onclick g·ªëc
      const originalOnclick = btn.getAttribute('onclick');
      btn.setAttribute('data-original-onclick', originalOnclick);
      btn.onclick = function(e) {
        e.preventDefault();
        showLoginModal();
      };
    }
  });
  
  // Logic cho n√∫t "üìã Copy" trong tikz-code-block - c·∫ßn ƒëƒÉng nh·∫≠p
  document.querySelectorAll('.tikz-code-block .copy-btn[onclick*="copyTikzCode"]').forEach(function(btn) {
    if (!window.appState.loggedIn) {
      // L∆∞u onclick g·ªëc
      const originalOnclick = btn.getAttribute('onclick');
      btn.setAttribute('data-original-onclick', originalOnclick);
      btn.onclick = function(e) {
        e.preventDefault();
        showLoginModal();
      };
    }
  });
  
  // Debug: Ki·ªÉm tra c√°c n√∫t c√≥ s·∫µn
  console.log('Ki·ªÉm tra c√°c n√∫t:');
  console.log('View buttons:', document.querySelectorAll('.files-section .view-btn').length);
  console.log('Copy link buttons:', document.querySelectorAll('.files-section .file-copy-link-btn').length);
  console.log('Copy buttons:', document.querySelectorAll('.files-section .copy-btn').length);
  console.log('Toggle TikZ buttons:', document.querySelectorAll('.files-section .copy-btn[onclick*="toggleTikzCode"]').length);
  console.log('Copy TikZ buttons:', document.querySelectorAll('.tikz-code-block .copy-btn[onclick*="copyTikzCode"]').length);
  
  // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p
  updateButtonStates();
  
  // Th√™m s·ª± ki·ªán cho n√∫t bi√™n d·ªãch n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
  const compileBtn = document.getElementById('compile-btn');
  if (compileBtn && !window.appState.loggedIn) {
    compileBtn.addEventListener('click', function(e) {
      e.preventDefault();
      showLoginModal();
    });
  }
  
  // ƒê·∫£m b·∫£o t·∫•t c·∫£ n√∫t "üîó Copy Link" ƒë·ªÅu c√≥ th√¥ng b√°o khi click
  document.querySelectorAll('.files-section .file-copy-link-btn').forEach(function(btn) {
    if (window.appState.loggedIn) {
      // N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p, ƒë·∫£m b·∫£o onclick c√≥ th√¥ng b√°o
      const currentOnclick = btn.getAttribute('onclick');
      if (currentOnclick && currentOnclick.includes('copyToClipboard')) {
        const url = currentOnclick.match(/copyToClipboard\('([^']+)'/)[1];
        btn.onclick = function() {
          copyToClipboard(url, this, 'üîó Copy Link');
        };
      }
    }
  });
  
  // ƒê·∫£m b·∫£o t·∫•t c·∫£ n√∫t "üìù Xem code TikZ" ƒë·ªÅu ho·∫°t ƒë·ªông khi ƒë√£ ƒëƒÉng nh·∫≠p
  document.querySelectorAll('.files-section .copy-btn[onclick*="toggleTikzCode"]').forEach(function(btn) {
    if (window.appState.loggedIn) {
      // N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p, ƒë·∫£m b·∫£o onclick ho·∫°t ƒë·ªông
      btn.onclick = function() {
        toggleTikzCode(this);
      };
    }
  });
  
  // ƒê·∫£m b·∫£o t·∫•t c·∫£ n√∫t "üìã Copy" trong tikz-code-block ƒë·ªÅu ho·∫°t ƒë·ªông khi ƒë√£ ƒëƒÉng nh·∫≠p
  document.querySelectorAll('.tikz-code-block .copy-btn[onclick*="copyTikzCode"]').forEach(function(btn) {
    if (window.appState.loggedIn) {
      // N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p, ƒë·∫£m b·∫£o onclick ho·∫°t ƒë·ªông
      btn.onclick = function() {
        copyTikzCode(this);
      };
    }
  });
});
function showLoginModal() {
  document.getElementById('login-modal').style.display = 'flex';
}

// H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t sau khi ƒëƒÉng nh·∫≠p
function updateButtonStates() {
  if (window.appState.loggedIn) {
    // N√∫t "üì∏ T·∫£i ·∫£nh PNG/JPEG" ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong ph·∫ßn kh·ªüi t·∫°o CodeMirror
    // Kh√¥ng c·∫ßn x·ª≠ l√Ω ·ªü ƒë√¢y v√¨ event listener g·ªëc ƒë√£ c√≥ ki·ªÉm tra ƒëƒÉng nh·∫≠p
    
    // Kh√¥i ph·ª•c n√∫t "üîó Copy Link" - kh√¥i ph·ª•c onclick g·ªëc
    document.querySelectorAll('.files-section .file-copy-link-btn').forEach(function(btn) {
      const originalOnclick = btn.getAttribute('data-original-onclick');
      if (originalOnclick) {
        // T·∫°o l·∫°i onclick function ƒë·ªÉ ƒë·∫£m b·∫£o th√¥ng b√°o hi·ªÉn th·ªã
        const url = originalOnclick.match(/copyToClipboard\('([^']+)'/)[1];
        btn.onclick = function() {
          copyToClipboard(url, this, 'üîó Copy Link');
        };
        btn.removeAttribute('data-original-onclick');
      }
    });
    
    // Kh√¥i ph·ª•c n√∫t "üìù Xem code TikZ" - kh√¥i ph·ª•c onclick g·ªëc
    document.querySelectorAll('.files-section .copy-btn[data-original-onclick]').forEach(function(btn) {
      const originalOnclick = btn.getAttribute('data-original-onclick');
      if (originalOnclick) {
        // T·∫°o l·∫°i onclick function ƒë·ªÉ ƒë·∫£m b·∫£o ho·∫°t ƒë·ªông
        btn.onclick = function() {
          toggleTikzCode(this);
        };
        btn.removeAttribute('data-original-onclick');
      }
    });
    
    // Kh√¥i ph·ª•c n√∫t "üìã Copy" trong tikz-code-block - kh√¥i ph·ª•c onclick g·ªëc
    document.querySelectorAll('.tikz-code-block .copy-btn[data-original-onclick]').forEach(function(btn) {
      const originalOnclick = btn.getAttribute('data-original-onclick');
      if (originalOnclick) {
        // T·∫°o l·∫°i onclick function ƒë·ªÉ ƒë·∫£m b·∫£o ho·∫°t ƒë·ªông
        btn.onclick = function() {
          copyTikzCode(this);
        };
        btn.removeAttribute('data-original-onclick');
      }
    });
    
    // Kh√¥i ph·ª•c CodeMirror - x√≥a s·ª± ki·ªán mousedown
    if (window.cm && typeof window.cm.off === 'function') {
      window.cm.off('mousedown');
    }
    
    // Kh√¥i ph·ª•c n√∫t bi√™n d·ªãch - x√≥a s·ª± ki·ªán click
    const compileBtn = document.getElementById('compile-btn');
    if (compileBtn) {
      compileBtn.removeEventListener('click', showLoginModal);
    }
  }
}

// Th√™m s·ª± ki·ªán click cho n√∫t ƒëƒÉng nh·∫≠p Google trong modal
document.addEventListener('DOMContentLoaded', function() {
  const modalLoginBtn = document.getElementById('modal-login-btn');
  if (modalLoginBtn) {
    modalLoginBtn.addEventListener('click', function() {
      window.location.href = '/login/google';
    });
  }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var logoutLink = document.getElementById('logout-link');
  if (logoutLink) {
    logoutLink.addEventListener('click', function(e) {
      e.preventDefault();
      window.location.href = '/logout?next=/';
    });
  }
});
</script>

<!-- Modal nh·∫≠p t·ª´ kh√≥a Bootstrap -->
<div class="modal fade" id="keywordModal" tabindex="-1" aria-labelledby="keywordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="keywordModalLabel">Nh·∫≠p m√¥ t·∫£ / t·ª´ kh√≥a</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- ·∫¢nh SVG preview -->
          <div id="modal-svg-preview">
            <img id="modal-svg-img" src="" alt="SVG Preview">
          </div>
          <p>Nh·∫≠p c√°c t·ª´ kh√≥a, c√°ch nhau b·∫±ng d·∫•u ph·∫©y:</p>
          <div class="position-relative">
            <textarea id="keywordsInput" class="form-control" rows="4" placeholder="V√≠ d·ª•: to√°n h·ªçc, h√¨nh h·ªçc, ƒë·ªì th·ªã"></textarea>
            <div id="keywordSuggestions" 
                 class="list-group position-absolute w-100" 
                 style="z-index:9999; max-height:200px; overflow-y:auto; display:none;"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" class="btn btn-primary" id="confirmKeywordBtn">X√°c nh·∫≠n</button>
        </div>
      </div>
    </div>
  </div>
  

<!-- 
Script n√†y x·ª≠ l√Ω logic l∆∞u file SVG l√™n server v·ªõi m√¥ t·∫£/t·ª´ kh√≥a do ng∆∞·ªùi d√πng nh·∫≠p:

- Bi·∫øn `pendingFileId` v√† `pendingTikzCode` l∆∞u t·∫°m th√¥ng tin file SVG c·∫ßn l∆∞u.
- Khi ng∆∞·ªùi d√πng b·∫•m n√∫t "L∆∞u server" (`save-server-btn`):
    + L·∫•y `file_id` v√† `tikz_code` t·ª´ thu·ªôc t√≠nh c·ªßa n√∫t.
    + Reset √¥ nh·∫≠p t·ª´ kh√≥a trong modal.
    + Hi·ªán modal Bootstrap ƒë·ªÉ ng∆∞·ªùi d√πng nh·∫≠p m√¥ t·∫£/t·ª´ kh√≥a.
- Khi ng∆∞·ªùi d√πng b·∫•m "X√°c nh·∫≠n" trong modal (`confirmKeywordBtn`):
    + L·∫•y t·ª´ kh√≥a ng∆∞·ªùi d√πng nh·∫≠p.
    + Ki·ªÉm tra c√≥ `file_id` ch∆∞a, n·∫øu ch∆∞a th√¨ b√°o l·ªói.
    + G·ª≠i POST request l√™n `/save_svg` v·ªõi `file_id`, `tikz_code`, `keywords`.
    + N·∫øu l∆∞u th√†nh c√¥ng th√¨ b√°o th√†nh c√¥ng v√† reload v·ªÅ trang ch·ªß, n·∫øu l·ªói th√¨ b√°o l·ªói.
    + ƒê√≥ng modal sau khi g·ª≠i request.
-->
<script>
    // Bi·∫øn l∆∞u t·∫°m th√¥ng tin file c·∫ßn l∆∞u (ƒë√£ chuy·ªÉn th√†nh global trong DOMContentLoaded)

    document.addEventListener('DOMContentLoaded', function() {
        const confirmBtn = document.getElementById('confirmKeywordBtn');
        const keywordsInput = document.getElementById('keywordsInput');
        const suggestionsBox = document.getElementById('keywordSuggestions');

        let typingTimeout = null;

        // Kh·ªüi t·∫°o bi·∫øn global cho pending data
        window.pendingFileId = null;
        window.pendingTikzCode = "";

        // Khi g√µ trong √¥ textarea ‚Üí fetch g·ª£i √Ω
        keywordsInput.addEventListener('input', function() {
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                const text = keywordsInput.value.trim();
                const parts = text.split(',');
                const lastPart = parts[parts.length - 1].trim();

                if (lastPart.length < 1) {
                    suggestionsBox.style.display = 'none';
                    return;
                }

                fetch(`/api/keywords/search?q=${encodeURIComponent(lastPart)}`)
                    .then(res => res.json())
                    .then(data => {
                        suggestionsBox.innerHTML = '';
                        if (data.length === 0) {
                            suggestionsBox.style.display = 'none';
                            return;
                        }

                        data.forEach(word => {
                            const item = document.createElement('button');
                            item.type = 'button';
                            item.className = 'list-group-item list-group-item-action';
                            item.textContent = word;
                            item.addEventListener('click', () => {
                                // Thay th·∫ø ph·∫ßn cu·ªëi b·∫±ng t·ª´ ch·ªçn
                                parts[parts.length - 1] = word;
                                keywordsInput.value = parts.map(s => s.trim()).filter(s => s).join(', ') + ', ';
                                suggestionsBox.style.display = 'none';
                                keywordsInput.focus();
                            });
                            suggestionsBox.appendChild(item);
                        });
                        suggestionsBox.style.display = 'block';
                    })
                    .catch(err => {
                        console.error(err);
                        suggestionsBox.style.display = 'none';
                    });
            }, 300);
        });

        // Click ngo√†i suggestion ‚Üí ·∫©n
        document.addEventListener('click', function(event) {
            if (!keywordsInput.contains(event.target) && !suggestionsBox.contains(event.target)) {
                suggestionsBox.style.display = 'none';
            }
        });

        // Khi b·∫•m n√∫t "X√°c nh·∫≠n" trong modal
        if (confirmBtn) {
            confirmBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                const keywords = keywordsInput.value.trim();
                if (!keywords) {
                    alert('Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt t·ª´ kh√≥a!');
                    keywordsInput.focus();
                    return;
                }

                if (!window.pendingFileId) {
                    alert("L·ªói: kh√¥ng c√≥ file_id!");
                    return;
                }

                fetch('/save_svg', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        file_id: window.pendingFileId,
                        tikz_code: window.pendingTikzCode,
                        keywords: keywords
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
                        window.location.href = "/";
                    } else {
                        alert(data.error || "C√≥ l·ªói x·∫£y ra!");
                    }
                })
                .catch(err => {
                    alert("L·ªói m·∫°ng ho·∫∑c server!");
                });

                const modal = bootstrap.Modal.getInstance(document.getElementById('keywordModal'));
                modal.hide();
            });
        }
    });
</script>

    
    

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- H√†m kh·ªüi t·∫°o l·∫°i CodeMirror cho textarea id="code" -->
    <script>
        function ensureCodeMirror() {
            const textarea = document.getElementById('code');
            if (!textarea) return;
            // N·∫øu ƒë√£ c√≥ CodeMirror instance, kh√¥ng kh·ªüi t·∫°o l·∫°i
            if (textarea.nextSibling && textarea.nextSibling.classList && textarea.nextSibling.classList.contains('CodeMirror')) {
                return;
            }
            window.cm = CodeMirror.fromTextArea(textarea, {
                mode: 'stex',
                theme: 'material',
                lineNumbers: true,
                placeholder: 'Nh·∫≠p code TikZ t·∫°i ƒë√¢y...'
            });
        }
    </script>

    <!-- ... trong submitTikzCodeAjax, sau khi c·∫≠p nh·∫≠t previewCol v√† resultToolsSection ... -->
    <!-- Th√™m d√≤ng n√†y sau khi c·∫≠p nh·∫≠t DOM: -->
    <!-- ensureCodeMirror(); -->
</body>
</html>
