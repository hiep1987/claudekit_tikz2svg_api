<!DOCTYPE html>
<html lang="vi" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Qu·∫£n l√Ω v√† xem c√°c file SVG ƒë√£ t·∫°o t·ª´ TikZ code">
    <meta name="keywords" content="TikZ, SVG, LaTeX, vector graphics, profile">
    <meta name="author" content="TikZ to SVG">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="File SVG c·ªßa t√¥i - TikZ to SVG">
    <meta property="og:description" content="Qu·∫£n l√Ω v√† xem c√°c file SVG ƒë√£ t·∫°o t·ª´ TikZ code">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="vi_VN">
    <title>File SVG c·ªßa t√¥i - TikZ to SVG</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="48x48" href="{{ url_for('static', filename='favicon-48x48.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='android-chrome-192x192.png') }}">
    <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='android-chrome-512x512.png') }}">
    <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='favicon-32x32.png') }}">
    
    <!-- Global JavaScript variables -->
    <script>
        window.isLoggedIn = {{ 'true' if current_user.is_authenticated else 'false' }};
        window.activeFeedbackCount = 0;
        window.isOwner = {{ 'true' if is_owner else 'false' }};
    </script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
    
    <!-- Custom Tailwind-like CSS - Production Ready -->
    <style>
        /* Tailwind-like utility classes for production */
        .w-full { width: 100%; }
        .max-w-7xl { max-width: 80rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .bg-white\/80 { background-color: rgba(255, 255, 255, 0.8); }
        .backdrop-blur { backdrop-filter: blur(8px); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .rounded-2xl { border-radius: 1rem; }
        .p-3 { padding: 0.75rem; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .mb-8 { margin-bottom: 2rem; }
        .gap-2 { gap: 0.5rem; }
        .bg-gradient-to-br { background-image: linear-gradient(to bottom right, var(--tw-gradient-stops)); }
        .from-blue-500 { --tw-gradient-from: #3b82f6; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(59, 130, 246, 0)); }
        .to-yellow-400 { --tw-gradient-to: #fbbf24; }
        .p-1\.5 { padding: 0.375rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .text-white { color: #ffffff; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-gray-800 { color: #1f2937; }
        .font-bold { font-weight: 700; }
        .hidden { display: none; }
        .md\:flex { }
        .gap-6 { gap: 1.5rem; }
        .font-medium { font-weight: 500; }
        .text-gray-700 { color: #374151; }
        .relative { position: relative; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .cursor-pointer { cursor: pointer; }
        .transition { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .hover\:text-blue-600:hover { color: #2563eb; }
        .block { display: block; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .md\:block { }
        .bg-gradient-to-r { background-image: linear-gradient(to right, var(--tw-gradient-stops)); }
        .from-red-400 { --tw-gradient-from: #f87171; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(248, 113, 113, 0)); }
        .to-red-600 { --tw-gradient-to: #dc2626; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .py-1\.5 { padding-top: 0.375rem; padding-bottom: 0.375rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .hover\:scale-105:hover { transform: scale(1.05); }
        .font-semibold { font-weight: 600; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .from-blue-400 { --tw-gradient-from: #60a5fa; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(96, 165, 250, 0)); }
        .to-yellow-400 { --tw-gradient-to: #fbbf24; }
        .md\:hidden { }
        .p-1\.5 { padding: 0.375rem; }
        .hover\:bg-blue-100:hover { background-color: #dbeafe; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-gray-500 { color: #6b7280; }
        .hover\:text-blue-400:hover { color: #60a5fa; }
        .fixed { position: fixed; }
        .top-0 { top: 0px; }
        .left-0 { left: 0px; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .bg-black\/50 { background-color: rgba(0, 0, 0, 0.5); }
        .z-40 { z-index: 40; }
        .z-400 { z-index: 400; }
        .absolute { position: absolute; }
        .right-0 { right: 0px; }
        .w-60 { width: 15rem; }
        .bg-white { background-color: #ffffff; }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .flex-col { flex-direction: column; }
        .p-6 { padding: 1.5rem; }
        .gap-3 { gap: 0.75rem; }
        .self-end { align-self: flex-end; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5px; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .text-gray-700 { color: #374151; }
        .font-medium { font-weight: 500; }
        .hover\:bg-blue-100:hover { background-color: #dbeafe; }
        .mt-2 { margin-top: 0.5rem; }
        .text-center { text-align: center; }
        .mt-8 { margin-top: 2rem; }
        .w-6 { width: 1.5rem; }
        .h-6 { height: 1.5rem; }
        .rounded-full { border-radius: 9999px; }
        .bg-gradient-to-br { background-image: linear-gradient(to bottom right, var(--tw-gradient-stops)); }
        .from-blue-500 { --tw-gradient-from: #3b82f6; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(59, 130, 246, 0)); }
        .to-purple-600 { --tw-gradient-to: #9333ea; }
        .justify-center { justify-content: center; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .text-gray-700 { color: #374151; }
        .mb-4 { margin-bottom: 1rem; }
        .flex-grow { flex-grow: 1; }
        .mx-4 { margin-left: 1rem; margin-right: 1rem; }
        .overflow-hidden { overflow: hidden; }
        .p-1\.5 { padding: 0.375rem; }
        .text-base { font-size: 1rem; line-height: 1.5rem; }
        .flex-shrink-0 { flex-shrink: 0; }
        
        /* Responsive breakpoints */
        @media (min-width: 920px) {
            .md\:flex { display: flex; }
            .md\:block { display: block; }
            .md\:hidden { display: none; }
        }
    </style>
    <!-- CodeMirror libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/stex/stex.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material.min.css">
    <style>
        body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          margin: 0 auto;
          padding: 20px;
          background-color: #f5f5f5;
        }
        
        /* New Navigation Styles */
        .menu-underline {
          transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
          height: 3px;
          width: 0;
          background: linear-gradient(90deg, #fbbf24, #38bdf8);
          border-radius: 2px;
          margin: 0 auto;
          position: absolute;
          bottom: -2px;
          left: 50%;
          transform: translateX(-50%);
        }
        .menu-item:hover .menu-underline, .menu-item.active .menu-underline {
          width: 80%;
        }
        
        /* Override custom CSS for menu items to remove unwanted styling */
        .menu-item {
          list-style: none !important;
        }
        
        .menu-item a {
          text-decoration: none !important;
          color: #374151 !important;
        }
        
        .menu-item:hover a {
          color: #2563eb !important;
        }
        
        /* Remove any bullet points or underlines from menu */
        .hidden.md\\:flex {
          list-style: none !important;
          padding: 0 !important;
          margin: 0 !important;
        }
        
        .hidden.md\\:flex li {
          list-style: none !important;
        }
        
        .hidden.md\\:flex li a {
          text-decoration: none !important;
        }
        
        /* Fix mobile menu styling */
        #mobile-menu a {
          text-decoration: none !important;
          color: #374151 !important;
        }
        
        #mobile-menu a:hover {
          color: #2563eb !important;
        }
        
        /* Mobile scroll for menu */
        #scrollable-menu {
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            -ms-overflow-style: none;
            scrollbar-width: none;
            padding-bottom: 0.75rem;
        }
        #scrollable-menu::-webkit-scrollbar {
            display: none;
        }
        
        #scrollable-menu-list {
            list-style: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        
        #scrollable-menu-list .menu-item {
            flex-shrink: 0;
        }
        
        #main-menu {
            list-style: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        
        .container {
          background: white;
          padding: 40px;
          border-radius: 12px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.1);
          max-width: 1280px;
          margin: 0 auto;
        }
        

        
        /* Bio styling for better bullet points */
        .public-profile-header div ul {
          margin: 0 !important;
          padding-left: 0 !important;
          list-style: none !important;
        }
        .public-profile-header div li {
          position: relative !important;
          padding-left: 28px !important;
          margin-bottom: 4px !important;
        }
        .public-profile-header div li::before {
          content: "‚Ä¢" !important;
          position: absolute !important;
          left: 0 !important;
          color: white !important;
          font-weight: bold !important;
          font-size: 16px !important;
        }
        
        /* Bio container specific styling */
        .bio-container {
          text-align: left !important;
          display: inline-block !important;
          width: auto !important;
          max-width: 100% !important;
        }
        .bio-container ul {
          margin: 0 !important;
          padding-left: 0 !important;
          list-style: none !important;
          text-align: left !important;
        }
        .bio-container ol {
          margin: 0 !important;
          padding-left: 0 !important;
          list-style: none !important;
          text-align: left !important;
        }
        .bio-container li {
          position: relative !important;
          padding-left: 25px !important;
          margin-bottom: 4px !important;
          text-align: left !important;
        }
        .bio-container ul li::before {
          content: "‚Ä¢" !important;
          position: absolute !important;
          left: 5px !important;
          color: white !important;
          font-weight: bold !important;
          font-size: 16px !important;
        }
        .bio-container ol li::before {
          content: counter(list-counter) ". " !important;
          position: absolute !important;
          left: 5px !important;
          color: white !important;
          font-weight: bold !important;
          font-size: 16px !important;
          counter-increment: list-counter !important;
        }
        .bio-container ol {
          counter-reset: list-counter !important;
        }
        
        .google-login-btn {
          max-width: 320px;
          display: flex;
          padding: 8px 16px;
          font-size: 14px;
          font-weight: 700;
          text-align: center;
          align-items: center;
          justify-content: center;
          border-radius: 6px;
          border: 1px solid rgba(0, 0, 0, 0.25);
          gap: 0.75rem;
          color: rgb(65, 63, 63);
          background-color: #fff;
          cursor: pointer;
          min-height: 40px;
        }

        .google-login-btn svg {
          height: 24px;
          flex-shrink: 0;
        }

        .google-login-btn:hover {
          transform: scale(1.02);
          background-color: #1565c0;
          color: white;
        }
        
        /* Files Grid */
        .files-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
          gap: 20px;
          margin-top: 20px;
          padding: 0;
          list-style: none;
        }

        /* Individual File Card */
        .file-card {
          position: relative;
          min-height: 260px;
          display: flex;
          flex-direction: column;
          justify-content: flex-start;
          background: #fff;
          border: 1px solid #ddd;
          border-radius: 10px;
          box-shadow: 0 2px 6px rgba(0,0,0,0.08);
          transition: transform 0.2s ease;
        }

        .file-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        /* Image Section */
        .file-img-container {
          position: relative;
          overflow: visible;
          border-radius: 10px 10px 0 0;
          background: #fff;
          min-height: 180px;
          width: 100%;
          display: flex;
          flex-direction: column;
        }

        .file-img-container img {
          width: 100%;
          height: 180px;
          object-fit: contain;
          display: block;
          background-color: #fff;
          transition: transform 0.3s ease;
        }

        .file-card:hover .file-img-container img {
          transform: scale(1.03);
        }

        /* ======== Overlay Action Menu (FIXED) ======== */
        .file-action-container {
          display: none;
          opacity: 0;
          pointer-events: none;
          transform: translateX(-10px);
          transition: opacity 0.3s, transform 0.3s;
          position: absolute;
          left: 12px;
          top: 2px;
          z-index: 300;
        }

        /* Desktop hover logic */
        @media (hover: hover) and (pointer: fine) {
          .file-img-container:hover + .file-action-container,
          .file-action-container:hover,
          .file-card:hover .file-action-container {
            display: block;
            opacity: 1;
            pointer-events: auto;
            transform: translateX(0);
          }
        }

        /* Mobile/Touch: Ch·ªâ hi·ªán khi card c√≥ class active */
        .file-card.active .file-action-container {
          display: block !important;
          opacity: 1 !important;
          pointer-events: auto !important;
          transform: translateX(0) !important;
        }

        @media (hover: none), (pointer: coarse) {
          .action-toggle-btn {
            display: block;
          }
          /* V√¥ hi·ªáu h√≥a hover tr√™n mobile */
          .file-img-container:hover + .file-action-container {
            display: none !important;
            opacity: 0 !important;
            pointer-events: none !important;
          }
          .file-card.active .file-action-container .Btn.individual-active,
          .file-card.active .file-action-container .Btn.ready-to-execute,
          .file-card.active .file-action-container .Btn.mobile-hover {
            background: linear-gradient(-50deg, rgb(39, 107, 255), rgb(112, 186, 255), rgb(39, 107, 255)) !important;
            width: 120px !important; /* ƒê·ªô r·ªông n√∫t tr∆∞·ªõc hover */
            transition: width 0.3s cubic-bezier(0.4,0,0.2,1);
          }

          .file-card.active .file-action-container .Btn.individual-active .text,
          .file-card.active .file-action-container .Btn.ready-to-execute .text,
          .file-card.active .file-action-container .Btn.mobile-hover .text {
            opacity: 1 !important;
            width: auto !important;
            max-width: 85px !important;
            color: #ffffff !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
          }

          /* Override opacity for active buttons */
          .file-card.active .file-action-container .Btn.individual-active .text,
          .file-card.active .file-action-container .Btn.ready-to-execute .text {
            opacity: 1 !important;
          }

          .file-card.active .file-action-container .Btn:not(.individual-active):not(.ready-to-execute):not(.mobile-hover) {
            background: linear-gradient(-50deg, rgb(39, 107, 255), rgb(112, 186, 255), rgb(39, 107, 255)) !important;
            max-width: 10px !important;
            border-radius: 18px !important;
          }

          .file-card.active .file-action-container .Btn .text {
            opacity: 0.5 !important;
            width: auto !important;
            max-width: 120px !important;
            color: #ffffff !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
          }
        }

        /* Force show on touch devices khi c√≥ class is-touch */
        .is-touch .action-toggle-btn {
          display: block !important;
        }

        /* ƒê·∫£m b·∫£o file-action-container hi·ªÉn th·ªã khi card active (cho mobile khi ch∆∞a ƒëƒÉng nh·∫≠p) */
        @media (max-width: 768px) {
          .file-card.active .file-action-container {
            display: flex !important;
            opacity: 1 !important;
            pointer-events: auto !important;
          }
          
          /* Ensure white text for mobile hover states */
          .file-card.active .file-action-container .Btn.individual-active .text,
          .file-card.active .file-action-container .Btn.ready-to-execute .text {
            color: #ffffff !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
            opacity: 1 !important;
          }
        }

        /* Action toggle button styling */
        .action-toggle-btn {
          transition: all 0.2s ease;
        }

        .action-toggle-btn:hover {
          background: rgba(39, 107, 255, 0.9) !important;
          color: white !important;
          transform: scale(1.05);
        }

        .copy-btn {
          padding: 6px 14px;
          font-size: 14px;
          border-radius: 6px;
          cursor: pointer;
          transition: background 0.25s ease;
          display: inline-flex;
          align-items: center;
          gap: 8px;
          background: #f5f5f5;
          border: 1px solid #ddd;
        }

        .copy-btn:hover {
          background: #e0e0e0;
        }

        /* Mobile: Hi·ªán n√∫t toggle ... */
        .action-toggle-btn {
          display: none;
          position: absolute;
          top: 10px;
          right: 10px;
          z-index: 200;
          border: none;
          background: rgba(255,255,255,0.95);
          border-radius: 50%;
          width: 38px;
          height: 38px;
          font-size: 22px;
          cursor: pointer;
          box-shadow: 0 2px 4px rgba(0,0,0,0.13);
        }

        @media (hover: none), (pointer: coarse) {
          .action-toggle-btn {
            display: block;
          }
        }

        .file-action-list {
          list-style: none;
          padding: 0;
          margin: 0;
          display: flex;
          flex-direction: column;
          gap: 8px;
          overflow: visible;
          width: auto;
        }

        .file-action-item {
          display: flex;
          justify-content: flex-start;
          width: 100%;
        }

        /* Button Styling */
        .Btn {
          display: flex;
          align-items: center;
          justify-content: flex-start;
          width: 35px;
          height: 35px;
          border: none;
          border-radius: 50%;
          cursor: pointer;
          position: relative;
          overflow: hidden;
          transition: all 0.3s ease;
          box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.199);
          background: linear-gradient(-50deg, rgb(39, 107, 255), rgb(112, 186, 255), rgb(39, 107, 255));
          background-size: 250%;
          background-position: left;
          min-width: 35px;
          flex-shrink: 0;
        }

        /* Icon container */
        .sign {
          width: 45px;
          height: 45px;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          justify-content: flex-start;
          padding-left: 4px;
          flex-shrink: 0;
          z-index: 2;
          position: relative;
        }

        .sign svg {
          width: 18px;
          height: 18px;
        }

        .sign svg path {
          fill: white;
        }

        .logoIcon {
          color: white;
          font-size: 16px;
        }

        /* Text label */
        .text {
          position: absolute;
          left: 20px;
          top: 50%;
          transform: translateY(-50%);
          width: 0;
          opacity: 0;
          color: #ffffff;
          font-size: 14px;
          font-weight: 600;
          transition: all 0.3s ease;
          white-space: nowrap;
          text-align: left;
          padding-left: 12px;
          z-index: 1;
          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* Desktop hover effect */
        .Btn:hover {
          width: 140px;
          border-radius: 20px;
          background-position: right;
        }

        .Btn:hover .text {
          opacity: 1;
          width: auto;
          max-width: 85px;
          color: #ffffff;
          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* Button states for touch devices */
        .Btn.individual-active {
          background: linear-gradient(-50deg, rgb(39, 107, 255), rgb(112, 186, 255), rgb(39, 107, 255)) !important;
          width: 120px !important;
          border-radius: 20px !important;
        }

        .Btn.ready-to-execute {
          background: linear-gradient(-50deg, rgb(39, 107, 255), rgb(112, 186, 255), rgb(39, 107, 255)) !important;
          width: 120px !important;
          border-radius: 20px !important;
        }

        .Btn.individual-active .text,
        .Btn.ready-to-execute .text {
          opacity: 1 !important;
          width: auto !important;
          max-width: 85px !important;
          color: #ffffff !important;
          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
        }

        /* File Info Styling */
        .file-info {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 0px;
            font-size: 13px;
            color: #555;
        }

        .file-meta {
            margin-bottom: 6px;
            font-weight: 400;
        }

        .file-meta .label {
            font-weight: 500;
            color: #333;
        }

        .file-creator {
            margin-top: 8px;
            font-size: 13px;
            font-weight: 400;
        }

        /* Like Button Styles */
        input[id^="heart-"] {
            display: none;
        }

        .like-button {
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            height: 32px;
            width: 90px;
            border-radius: 8px;
            border: none;
            background-color: #2d2d2d;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            padding: 0 8px;
        }

        .like-button input[type="checkbox"] {
            display: none;
        }

        .like {
            display: flex;
            cursor: pointer;
            align-items: center;
            gap: 4px;
            flex: 1;
        }

        .like-icon {
            fill: #808080;
            height: 16px;
            width: 16px;
            transition: fill 0.2s ease;
        }

        .like-text {
            color: #e0e0e0;
            font-size: 12px;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 500;
        }

        .like-count {
            color: #808080;
            font-size: 12px;
            font-weight: 500;
            margin-left: 4px;
            transition: all 0.3s ease;
        }

        .like-count.two {
            position: absolute;
            right: 8px;
            transform: translateY(20px);
            opacity: 0;
        }

        .like-count.one {
            position: relative;
        }

        input[id^="heart-"]:checked ~ .like .like-icon {
            fill: #ff4757;
            animation: heartBeat 0.3s ease;
        }

        input[id^="heart-"]:checked ~ .like-count.one {
            transform: translateY(-20px);
            opacity: 0;
        }

        input[id^="heart-"]:checked ~ .like-count.two {
            transform: translateY(0);
            opacity: 1;
            color: #ff4757;
        }

        @keyframes heartBeat {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.3);
            }
            100% {
                transform: scale(1);
            }
        }

        /* Like Button Wrapper */
        .like-button-wrapper {
            position: relative;
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
            z-index: 100;
        }

        @media (max-width: 768px) {
          .container {
            padding: 20px;
          }
        }

        /* Touch device detection */
        @media (hover: none) and (pointer: coarse) {
          html {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
          }
        }

        /* Add is-touch class for JavaScript detection */
        @media (hover: none), (pointer: coarse) {
          html.is-touch {
            /* Touch device styles */
          }
        }

        /* CodeMirror styles cho TikZ code block */
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            position: relative;
        }
        .code-block pre {
            margin: 0;
            padding: 15px;
            background: transparent;
        }
        .code-block code {
            background: transparent;
            padding: 0;
        }
        .CodeMirror {
            height: 220px;
            font-size: 15px;
            border-radius: 6px;
            border: 1.5px solid #bbb;
            background: #f8f9fa;
            overflow: auto;
        }
        .tikz-code-block .CodeMirror {
            max-height: 300px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 5px;
            width: 100%;
        }
        .tikz-code-block {
            width: 100%;
        }
        .tikz-code-block .code-block {
            width: 100%;
        }
        .tikz-code-block .tikz-cm {
            display: none;
        }
        .CodeMirror-placeholder {
            color: #bbb !important;
            font-style: italic;
        }
        .CodeMirror-gutter, .CodeMirror-gutters, .CodeMirror-linenumbers {
            width: 2.5em !important;
            min-width: 2.5em !important;
        }
        .CodeMirror-linenumber, .CodeMirror-gutter-elt {
            min-width: 2em !important;
            width: 2em !important;
            text-align: right !important;
            padding-right: 0.5em !important;
            box-sizing: content-box !important;
        }

        /* Pulse animation for real-time updates */
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        /* TikZ code block header and copy button */
        .tikz-code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            border-radius: 5px 5px 0 0;
            font-weight: bold;
            color: #333;
        }

        .copy-btn {
            padding: 6px 14px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.25s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #f5f5f5;
            border: 1px solid #ddd;
        }

        .copy-btn:hover {
            background: #e0e0e0;
        }
        </style>

</head>
<body>
    {% include '_navbar.html' %}

    <div class="container">
        <!-- Public Profile Header -->
        <div class="public-profile-header" style="text-align: center; margin-bottom: 40px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);">
            <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                {% if avatar %}
                    <img src="{{ url_for('static', filename='avatars/' ~ avatar) }}" alt="Avatar" style="width: 56px; height: 56px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.3); object-fit: cover; flex-shrink: 0;">
                {% else %}
                    <div style="width: 56px; height: 56px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; border: 4px solid rgba(255,255,255,0.3); flex-shrink: 0;">
                        {{ user_email[0].upper() if user_email else 'U' }}
                    </div>
                {% endif %}
                
                <h2 style="margin: 0; font-size: 28px; font-weight: bold;">{{ username or user_email.split('@')[0] }}</h2>
                
                <div style="display: flex; align-items: center; gap: 10px; font-size: 16px;">
                    <span style="color: rgba(255,255,255,0.7);">|</span>
                    <span>üë• {{ follower_count }} followers</span>
                </div>
            </div>
            
            {% if bio %}
                <div class="bio-container" style="margin-bottom: 20px; font-style: italic; font-size: 16px; opacity: 0.9;">
                    {{ bio | safe }}
                </div>
            {% endif %}
            
            <div style="margin-bottom: 20px; font-size: 14px; opacity: 0.8;">
                <strong>Email li√™n h·ªá:</strong> {{ user_email }}
            </div>
            
            {% if current_user.is_authenticated and not is_owner %}
                <div style="margin-top: 20px;">
                    {% if is_followed %}
                        <button type="button" class="btn btn-secondary follow-btn" data-user-id="{{ user_id }}" onclick="unfollowUser({{ user_id }})" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold;">
                            üë• B·ªè theo d√µi
                        </button>
                    {% else %}
                        {% if current_identity_verified %}
                            <button type="button" class="btn btn-primary follow-btn" data-user-id="{{ user_id }}" onclick="followUser({{ user_id }})" style="background: #1976d2; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold;">
                                üë• Theo d√µi
                            </button>
                        {% else %}
                            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; text-align:center;">
                                <button type="button" class="btn btn-secondary" disabled style="background: #9e9e9e; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; opacity: 0.8; cursor:not-allowed;">
                                    üë• Theo d√µi (c·∫ßn x√°c th·ª±c)
                                </button>
                                <small style="color:#fff; background:#f59e0b; padding:6px 10px; border-radius:6px; display:inline-block;">
                                    üîê Vui l√≤ng <a href="{{ url_for('profile_verification') }}" style="color:#0b3fae; font-weight:600; text-decoration:none;">x√°c th·ª±c danh t√≠nh</a> ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng theo d√µi
                                </small>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            {% endif %}
        </div>

        <section class="svg-files-section">
            <h3 style="color:#1976d2; margin-bottom:24px;">
                {% if is_owner %}
                    üìÇ C√°c file SVG b·∫°n ƒë√£ t·∫°o
                {% else %}
                    üìÇ Danh s√°ch c√°c file SVG ƒë√£ t·∫°o
                {% endif %}
            </h3>
            {% if svg_files %}
            <div class="files-grid">
                {% for file in svg_files %}
                <div class="file-card" data-id="{{ file.id }}">
                  <button class="action-toggle-btn" type="button" aria-label="Hi·ªán menu h√†nh ƒë·ªông">‚ãØ</button>
                  <div class="file-img-container">
                    <img src="{{ file.url }}" alt="{{ file.filename }}">
                    <!-- N√∫t Like m·ªõi - ch·ªâ hi·ªÉn th·ªã khi ƒë√£ ƒëƒÉng nh·∫≠p -->
                    {% if current_user.is_authenticated %}
                    <div class="like-button-wrapper">
                      <div class="like-button">
                        <input id="heart-{{ file.id }}" type="checkbox" {% if file.is_liked_by_current_user %}checked{% endif %} />
                        <label class="like" for="heart-{{ file.id }}">
                          <svg
                            class="like-icon"
                            fill-rule="nonzero"
                            viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg"
                          >
                            <path
                              d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z"
                            ></path>
                          </svg>
                          <span class="like-text">Likes</span>
                        </label>
                        <span class="like-count one">{{ file.like_count }}</span>
                        <span class="like-count two">{{ file.like_count }}</span>
                      </div>
                    </div>
                    {% else %}
                    <!-- Hi·ªÉn th·ªã s·ªë like khi ch∆∞a ƒëƒÉng nh·∫≠p -->
                    <div style="position: absolute; bottom: 8px; right: 8px; z-index: 100; background: rgba(0,0,0,0.8); color: white; padding: 6px 10px; border-radius: 16px; font-size: 13px; display: flex; align-items: center; gap: 6px; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1);">
                      <span style="color: #ff4757; font-size: 14px;">‚ù§Ô∏è</span>
                      <span style="font-weight: 600;">{{ file.like_count }}</span>
                    </div>
                    {% endif %}
                  </div>

                  <div class="file-action-container">
                    <ul class="file-action-list">
                      <li class="file-action-item">
                        <button type="button" class="Btn" data-filename="{{ file.filename }}" onclick="window.location.href='/view_svg/{{ file.filename }}'">
                          <div class="sign">
                            <i class="fas fa-image logoIcon"></i>
                          </div>
                          <div class="text">T·∫£i ·∫£nh</div>
                        </button>
                      </li>
                      <li class="file-action-item">
                        <button type="button" class="Btn fb-share-btn" data-filename="{{ file.filename }}" data-has-feedback="true">
                          <div class="sign">
                            <i class="fab fa-facebook logoIcon"></i>
                          </div>
                          <div class="text">Facebook</div>
                        </button>
                      </li>
                      <li class="file-action-item">
                        <button type="button" class="Btn file-copy-link-btn" data-url="{{ request.host_url.rstrip('/') ~ file.url }}" data-has-feedback="true">
                          <div class="sign">
                            <i class="fas fa-link logoIcon"></i>
                          </div>
                          <div class="text">Copy Link</div>
                        </button>
                      </li>
                      {% if file.tikz_code %}
                      <li class="file-action-item">
                        <button type="button" class="Btn view-code-btn" data-filename="{{ file.filename }}" {% if current_user.is_authenticated %}onclick="toggleTikzCode(this)"{% endif %}>
                          <div class="sign">
                            <i class="fas fa-code logoIcon"></i>
                          </div>
                          <div class="text">Xem Code</div>
                        </button>
                      </li>
                      {% endif %}
                      <!-- N√∫t x√≥a ch·ªâ hi·ªÉn th·ªã khi user xem profile c·ªßa ch√≠nh m√¨nh -->
                      {% if is_owner %}
                      <li class="file-action-item">
                        <button type="button" class="Btn delete-btn" onclick="showDeleteModal(this)">
                          <div class="sign">
                            <i class="fas fa-trash logoIcon"></i>
                          </div>
                          <div class="text">X√≥a ·∫£nh</div>
                        </button>
                      </li>
                      {% endif %}
                    </ul>
                  </div>
                  

                  <!-- Info Section -->
                  <div class="file-info">
                    <div class="file-meta">
                      <span class="label">T·∫°o l√∫c:</span> {{ file.created_time }}
                    </div>
                    {% if file.size %}
                      <div class="file-meta">
                        <span class="label">K√≠ch th∆∞·ªõc:</span> {{ file.size }} KB
                      </div>
                    {% else %}
                      <div class="file-meta">
                        <span class="label">K√≠ch th∆∞·ªõc:</span> Kh√¥ng x√°c ƒë·ªãnh
                      </div>
                    {% endif %}
                    {% if file.creator_id and file.creator_username %}
                      <div class="file-creator">
                        üë§ <a href="/profile/{{ file.creator_id }}" style="text-decoration: none; color: #1976d2; font-weight: 500;">
                          {{ file.creator_username }}
                        </a>
                      </div>
                    {% endif %}
                  </div>

                  <!-- TikZ Code Section -->
                  {% if file.tikz_code %}
                  <div class="tikz-code-block" style="display:none; margin-top:10px;">
                    <div class="tikz-code-header">
                      <span>Code TikZ:</span>
                      <button class="copy-btn" onclick="copyTikzCode(this)">üìã Copy</button>
                    </div>
                    <div class="code-block">
                      <textarea class="tikz-cm" readonly>{{ file.tikz_code | e }}</textarea>
                    </div>
                  </div>
                  {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="color:#666; margin-top:18px;">Ch∆∞a c√≥ file SVG n√†o ƒë∆∞·ª£c t·∫°o. H√£y th·ª≠ chuy·ªÉn ƒë·ªïi m·ªôt code TikZ!</div>
            {% endif %}
        </section>
    </div>

    <!-- Modal ƒëƒÉng xu·∫•t ch·ªâ render n·∫øu ƒë√£ login -->
    {% if user_email %}
    <div id="logout-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center;">
      <div style="background:white; padding:32px 40px; border-radius:12px; box-shadow:0 2px 16px rgba(0,0,0,0.15); min-width:320px; text-align:center;">
        <h3 style="margin-bottom:24px;">ƒêƒÉng xu·∫•t?</h3>
        <a href="/logout" style="display:inline-block; background:#d32f2f; color:white; padding:10px 28px; border-radius:6px; text-decoration:none; font-weight:bold;">ƒêƒÉng xu·∫•t</a>
        <button onclick="document.getElementById('logout-modal').style.display='none'" style="margin-left:18px; background:#eee; color:#333; padding:10px 28px; border-radius:6px; border:none; font-weight:bold;">Hu·ª∑</button>
      </div>
    </div>
    {% endif %}

    <!-- Modal ƒëƒÉng nh·∫≠p cho tr∆∞·ªùng h·ª£p ch∆∞a ƒëƒÉng nh·∫≠p -->
    {% if not current_user.is_authenticated %}
    <div id="login-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center;">
      <div style="background:white; padding:32px 40px; border-radius:12px; box-shadow:0 2px 16px rgba(0,0,0,0.15); min-width:320px; text-align:center;">
        <h3 style="margin-bottom:24px;">ƒêƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y</h3>
        <p style="margin-bottom:16px; color:#666;">Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ c√≥ th·ªÉ:</p>
        <ul style="margin-bottom:24px; color:#666; text-align:left; display:inline-block;">
          <li>üëç Like v√† unlike ·∫£nh</li>
          <li>üëÅÔ∏è Xem TikZ code</li>
          <li>üóëÔ∏è X√≥a ·∫£nh c·ªßa b·∫°n</li>
          <li>üë• Theo d√µi ng∆∞·ªùi d√πng kh√°c</li>
        </ul>
        <p style="margin-bottom:24px; color:#1976d2; font-weight:500;">üí° B·∫°n v·∫´n c√≥ th·ªÉ s·ª≠ d·ª•ng Facebook Share v√† Copy Link m√† kh√¥ng c·∫ßn ƒëƒÉng nh·∫≠p!</p>
        <button onclick="loginWithGoogle()" style="display:inline-block; background:#1976d2; color:white; padding:12px 24px; border-radius:6px; border:none; font-weight:bold; cursor:pointer; margin-right:12px;">
          <i class="fab fa-google" style="margin-right:8px;"></i>ƒêƒÉng nh·∫≠p v·ªõi Google
        </button>
        <button onclick="document.getElementById('login-modal').style.display='none'" style="background:#eee; color:#333; padding:12px 24px; border-radius:6px; border:none; font-weight:bold; cursor:pointer;">Hu·ª∑</button>
      </div>
    </div>
    
    <script>
    // Function ƒë·ªÉ ƒëƒÉng nh·∫≠p v·ªõi Google v√† ·ªü l·∫°i trang hi·ªán t·∫°i
    function loginWithGoogle() {
        const currentPath = window.location.pathname + window.location.search;
        
        // L∆∞u th√¥ng tin v·ªÅ action c·∫ßn th·ª±c hi·ªán sau khi ƒëƒÉng nh·∫≠p
        const pendingAction = {
            type: 'view_code',
            fileId: getCurrentPendingFileId(),
            timestamp: Date.now()
        };
        
        // L∆∞u v√†o localStorage
        localStorage.setItem('tikz2svg_pending_action', JSON.stringify(pendingAction));
        
        fetch('/set_next_url?url=' + encodeURIComponent(currentPath))
            .then(() => {
                console.log('‚úÖ Next URL set successfully, redirecting to Google login');
                window.location.href = '/login/google';
            })
            .catch(error => {
                console.error('‚ùå Error setting next URL:', error);
                // Fallback: redirect to login without setting next URL
                window.location.href = '/login/google';
            });
    }
    
    // Function ƒë·ªÉ l·∫•y file ID c·ªßa action ƒëang pending
    function getCurrentPendingFileId() {
        // ∆Øu ti√™n l·∫•y t·ª´ data attribute c·ªßa modal ƒëƒÉng nh·∫≠p
        const loginModal = document.getElementById('login-modal');
        if (loginModal && loginModal.style.display !== 'none') {
            const pendingFileId = loginModal.getAttribute('data-pending-file-id');
            if (pendingFileId) {
                return pendingFileId;
            }
        }
        
        // T√¨m file card ƒëang active
        const activeCard = document.querySelector('.file-card.active');
        if (activeCard) {
            return activeCard.getAttribute('data-id');
        }
        
        // N·∫øu kh√¥ng c√≥ card active, t√¨m card g·∫ßn nh·∫•t v·ªõi modal ƒëƒÉng nh·∫≠p
        if (loginModal && loginModal.style.display !== 'none') {
            // T√¨m card g·∫ßn nh·∫•t v·ªõi modal
            const cards = document.querySelectorAll('.file-card');
            let closestCard = null;
            let minDistance = Infinity;
            
            cards.forEach(card => {
                const cardRect = card.getBoundingClientRect();
                const modalRect = loginModal.getBoundingClientRect();
                const distance = Math.abs(cardRect.top - modalRect.top) + Math.abs(cardRect.left - modalRect.left);
                
                if (distance < minDistance) {
                    minDistance = distance;
                    closestCard = card;
                }
            });
            
            if (closestCard) {
                return closestCard.getAttribute('data-id');
            }
        }
        
        return null;
    }
    
    // Function ƒë·ªÉ th·ª±c hi·ªán action pending sau khi ƒëƒÉng nh·∫≠p
    function executePendingAction() {
        const pendingActionStr = localStorage.getItem('tikz2svg_pending_action');
        
        if (!pendingActionStr) {
            return;
        }
        
        try {
            const pendingAction = JSON.parse(pendingActionStr);
            const now = Date.now();
            
            // Ki·ªÉm tra xem action c√≥ qu√° c≈© kh√¥ng (5 ph√∫t)
            if (now - pendingAction.timestamp > 5 * 60 * 1000) {
                localStorage.removeItem('tikz2svg_pending_action');
                return;
            }
            
            if (pendingAction.type === 'view_code' && pendingAction.fileId) {
                // T√¨m file card v√† m·ªü code
                const targetCard = document.querySelector(`.file-card[data-id="${pendingAction.fileId}"]`);
                
                if (targetCard) {
                    // K√≠ch ho·∫°t card (hi·ªán action menu)
                    document.querySelectorAll('.file-card.active').forEach(card => {
                        card.classList.remove('active');
                    });
                    targetCard.classList.add('active');
                    
                    // T√¨m n√∫t "Xem Code" v√† click
                    const viewCodeBtn = targetCard.querySelector('.view-code-btn');
                    
                    if (viewCodeBtn) {
                        // Scroll ƒë·∫øn card
                        targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        // ƒê·ª£i m·ªôt ch√∫t r·ªìi click n√∫t "Xem Code"
                        setTimeout(() => {
                            viewCodeBtn.click();
                        }, 500);
                        
                        // Th√™m visual feedback
                        targetCard.style.animation = 'pulse 1s ease-in-out';
                        setTimeout(() => {
                            targetCard.style.animation = '';
                        }, 1000);
                    }
                }
            }
            
            // X√≥a action ƒë√£ th·ª±c hi·ªán
            localStorage.removeItem('tikz2svg_pending_action');
            
        } catch (error) {
            localStorage.removeItem('tikz2svg_pending_action');
        }
    }
    
    // X·ª≠ l√Ω click b√™n ngo√†i modal ƒë·ªÉ ƒë√≥ng
    document.getElementById('login-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    });
    </script>
    {% endif %}

    <!-- Modal x√°c nh·∫≠n x√≥a ·∫£nh -->
    <div id="delete-confirm-modal" style="display:none; position:fixed; z-index:99999; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); align-items:center; justify-content:center;">
      <div style="background:#fff; border-radius:10px; padding:32px 24px; min-width:300px; text-align:center; box-shadow:0 2px 16px rgba(0,0,0,0.18);">
        <h3 style="margin-bottom:18px;">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh n√†y?</h3>
        <div style="margin-bottom:18px; color:#d32f2f;">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</div>
        <button id="confirm-delete-btn" class="btn btn-primary" style="background:#d32f2f; color:#fff; margin-right:12px;">X√≥a</button>
        <button id="cancel-delete-btn" class="btn btn-secondary" style="background:#eee; color:#333;">H·ªßy</button>
      </div>
    </div>

    <script>
    let deleteSvgId = null;
    let deleteCardElem = null;

    function showDeleteModal(btn) {
      const card = btn.closest('.file-card');
      deleteCardElem = card;
      deleteSvgId = card.getAttribute('data-id');
      document.getElementById('delete-confirm-modal').style.display = 'flex';
    }

    // X·ª≠ l√Ω khi nh·∫•n n√∫t "X√≥a" trong modal
    document.getElementById('confirm-delete-btn').addEventListener('click', function() {
      if (deleteSvgId && deleteCardElem) {
        // G·ª≠i request x√≥a ·∫£nh
        fetch('/delete_svg', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({
            svg_image_id: deleteSvgId
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // X√≥a card kh·ªèi DOM
            deleteCardElem.remove();
            // ·∫®n modal
            document.getElementById('delete-confirm-modal').style.display = 'none';
            // Reset bi·∫øn
            deleteSvgId = null;
            deleteCardElem = null;
            // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
            alert('ƒê√£ x√≥a ·∫£nh th√†nh c√¥ng!');
          } else {
            alert(data.message || 'C√≥ l·ªói x·∫£y ra khi x√≥a ·∫£nh!');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('C√≥ l·ªói k·∫øt n·ªëi khi x√≥a ·∫£nh!');
        });
      }
    });

    // X·ª≠ l√Ω khi nh·∫•n n√∫t "H·ªßy" trong modal
    document.getElementById('cancel-delete-btn').addEventListener('click', function() {
      // ·∫®n modal
      document.getElementById('delete-confirm-modal').style.display = 'none';
      // Reset bi·∫øn
      deleteSvgId = null;
      deleteCardElem = null;
    });

    // X·ª≠ l√Ω khi click b√™n ngo√†i modal ƒë·ªÉ ƒë√≥ng
    document.getElementById('delete-confirm-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        // ·∫®n modal
        this.style.display = 'none';
        // Reset bi·∫øn
        deleteSvgId = null;
        deleteCardElem = null;
      }
    });
    </script>

    <script>
    // Suppress deprecated DOMNodeInserted warnings silently
    const originalAddEventListener = EventTarget.prototype.addEventListener;
    EventTarget.prototype.addEventListener = function(type, listener, options) {
        if (type === 'DOMNodeInserted' || type === 'DOMNodeRemoved' || type === 'DOMSubtreeModified') {
            // Silently suppress deprecated MutationEvents without logging
            return;
        }
        return originalAddEventListener.call(this, type, listener, options);
    };
    
    // Touch device detection
    if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
        document.documentElement.classList.add('is-touch');
    }

    // ==== MAIN DOMContentLoaded Event Listener ====
    document.addEventListener('DOMContentLoaded', function () {
        console.log('üöÄ Main DOMContentLoaded event listener initialized');
        
        // ==== Logout button logic ====
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function (e) {
                e.preventDefault();
                const logoutModal = document.getElementById('logout-modal');
                if (logoutModal) logoutModal.style.display = 'flex';
            });
        }

        // ==== Google login button logic (for modal only) ====
        const modalLoginBtn = document.getElementById('modal-login-btn');
        if (modalLoginBtn) {
            modalLoginBtn.addEventListener('click', function (e) {
                e.preventDefault();
                loginWithGoogle();
            });
        }

        // ==== Mobile Menu Toggle ====
        const menuToggle = document.getElementById('menu-toggle');
        const mobileMenu = document.getElementById('mobile-menu');
        const closeMenu = document.getElementById('close-menu');
        
        if (menuToggle && mobileMenu && closeMenu) {
            menuToggle.addEventListener('click', () => mobileMenu.classList.remove('hidden'));
            closeMenu.addEventListener('click', () => mobileMenu.classList.add('hidden'));
            // Optional: click outside to close
            mobileMenu.addEventListener('click', e => {
                if(e.target === mobileMenu) mobileMenu.classList.add('hidden');
            });
        }

        // ==== Like buttons for file-card ====
        initializeLikeButtons();

        // ==== Event delegation cho action-toggle-btn ====
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.action-toggle-btn');
            if (btn) {
                const card = btn.closest('.file-card');
                if (card) {
                    document.querySelectorAll('.file-card.active').forEach(other => {
                        if (other !== card) other.classList.remove('active');
                    });
                    card.classList.toggle('active');
                }
            }
        });

        // ==== ƒê√≥ng menu khi click b√™n ngo√†i ====
        document.addEventListener('click', function (e) {
            const activeCard = document.querySelector('.file-card.active');
            if (activeCard) {
                if (activeCard.dataset.preventClose === 'true') {
                    return;
                }
                
                if (!activeCard.contains(e.target) && !e.target.closest('.Btn') && !e.target.closest('.action-toggle-btn')) {
                    activeCard.classList.remove('active');
                }
            }
        });

        // ==== Initialize touch events for buttons ====
        initializeTouchBtnEvents();
        
        // ==== Initialize simple touch events for not logged in users ====
        if (!window.isLoggedIn) {
            initializeSimpleTouchEventsForNotLoggedIn();
            console.log('üîÑ Initialized touch events for not logged in users');
            
            // Th√™m debug info cho modal ƒëƒÉng nh·∫≠p
            const loginModal = document.getElementById('login-modal');
            if (loginModal) {
                console.log('‚úÖ Login modal found and ready');
            } else {
                console.warn('‚ö†Ô∏è Login modal not found');
            }
        }

        // ==== Initialize CodeMirror ====
        initializeCodeMirror();
        
        // ==== Initialize Facebook share buttons and copy link buttons ====
        initializeFbShareButtons();
        initializeCopyLinkButtons();
        
        // ==== Start polling for real-time updates ====
        // Start like polling for both logged in and not logged in users
        startLikePolling();
        
        // ==== Start polling for follower count updates ====
        // Only start follower count polling if we're viewing someone else's profile
        if (!window.isOwner) {
            startFollowerCountPolling();
        }
        
        // ==== Check if CodeMirror is available ====
        if (typeof CodeMirror !== 'undefined') {
            console.log('‚úÖ CodeMirror loaded successfully');
        } else {
            console.warn('‚ö†Ô∏è CodeMirror not loaded, retrying...');
            // Retry loading CodeMirror if needed
            setTimeout(function() {
                if (typeof CodeMirror !== 'undefined') {
                    console.log('‚úÖ CodeMirror loaded on retry');
                } else {
                    console.error('‚ùå CodeMirror failed to load');
                }
            }, 1000);
        }
        
        // ==== Check if Bootstrap is available ====
        if (typeof bootstrap !== 'undefined') {
            console.log('‚úÖ Bootstrap loaded successfully');
        } else {
            console.warn('‚ö†Ô∏è Bootstrap not loaded');
        }
        
        console.log('‚úÖ All initialization completed successfully');
        
                // ==== Ki·ªÉm tra v√† th·ª±c hi·ªán pending action sau khi ƒëƒÉng nh·∫≠p ====
        if (window.isLoggedIn) {
            // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ load ho√†n to√†n
            setTimeout(() => {
                try {
                    if (typeof executePendingAction === 'function') {
                        executePendingAction();
                    } else if (typeof window.executePendingAction === 'function') {
                        window.executePendingAction();
                    } else {
                        // Manual approach - th·ª±c hi·ªán tr·ª±c ti·∫øp
                        const pendingActionStr = localStorage.getItem('tikz2svg_pending_action');
                        if (pendingActionStr) {
                            try {
                                const pendingAction = JSON.parse(pendingActionStr);
                                const targetCard = document.querySelector(`.file-card[data-id="${pendingAction.fileId}"]`);
                                
                                if (targetCard) {
                                    const viewCodeBtn = targetCard.querySelector('.view-code-btn');
                                    if (viewCodeBtn) {
                                        viewCodeBtn.click();
                                    }
                                }
                            } catch (error) {
                                // Silent error handling
                            }
                        }
                    }
                } catch (error) {
                    // Silent error handling
                }
            }, 1000);
        }
    });

    // Like/Unlike functionality
    function initializeLikeButtons() {
        document.querySelectorAll('input[id^="heart-"]').forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                const fileId = this.id.replace('heart-', '');
                const isLiked = this.checked;
                const likeButton = this.closest('.like-button');
                const currentNumber = likeButton.querySelector('.like-count.one');
                const moveNumber = likeButton.querySelector('.like-count.two');
                
                // Prevent double click
                this.disabled = true;
                
                // Send AJAX request to backend
                fetch('/like_svg', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        svg_id: fileId,
                        action: isLiked ? 'like' : 'unlike'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update UI with new like count
                        const newCount = data.like_count;
                        currentNumber.textContent = newCount;
                        moveNumber.textContent = newCount;
                        
                        // Update checkbox state based on server response
                        this.checked = data.is_liked;
                        
                        console.log(`‚úÖ ${data.message}: ${newCount} likes`);
                    } else {
                        // Revert UI if backend failed
                        this.checked = !isLiked;
                        console.log(`‚ùå ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Revert UI on error
                    this.checked = !isLiked;
                    alert('C√≥ l·ªói k·∫øt n·ªëi!');
                })
                .finally(() => {
                    this.disabled = false;
                });
            });
        });
    }

    // Touch events for buttons (2-tap logic)
    function initializeTouchBtnEvents() {
        if (!document.documentElement.classList.contains('is-touch')) return;

        const originalHandlers = new Map();

        // S·ª≠ d·ª•ng event delegation thay v√¨ g·∫Øn tr·ª±c ti·∫øp
        document.addEventListener('click', function(e) {
            const btn = e.target.closest('.Btn');
            if (!btn) return;
            
            // X·ª≠ l√Ω c√°c n√∫t .Btn trong card c√≥ class active
            if (btn.classList.contains('Btn')) {
                const card = btn.closest('.file-card');
                if (!card || !card.classList.contains('active')) return;

                // L·∫•y ho·∫∑c t·∫°o tapCount
                if (!btn.dataset.tapCount) btn.dataset.tapCount = '0';
                
                const currentTapCount = parseInt(btn.dataset.tapCount);
                
                if (currentTapCount === 0) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();

                    // Reset c√°c n√∫t kh√°c
                    card.querySelectorAll('.Btn').forEach(otherBtn => {
                        if (otherBtn !== btn) {
                            otherBtn.classList.remove('individual-active', 'ready-to-execute');
                            otherBtn.dataset.tapCount = '0';
                        }
                    });

                    btn.classList.add('individual-active', 'ready-to-execute');
                    btn.dataset.tapCount = '1';

                    // Auto reset sau 5s
                    setTimeout(() => {
                        if (btn.dataset.tapCount === '1') {
                            btn.classList.remove('individual-active', 'ready-to-execute');
                            btn.dataset.tapCount = '0';
                        }
                    }, 5000);
                    
                    return false;
                } 
                else if (currentTapCount === 1) {
                    // TAP 2: Execute action
                    
                    // L·∫•y onclick handler
                    let originalHandler;
                    const onclickAttr = btn.getAttribute('onclick');
                    if (onclickAttr) {
                        originalHandler = new Function(onclickAttr);
                    } else if (originalHandlers.has(btn)) {
                        originalHandler = originalHandlers.get(btn);
                    }

                    if (originalHandler) {
                        try {
                            originalHandler.call(btn, e);
                        } catch (error) {
                            console.error('Error executing handler:', error);
                        }
                    }

                    // ‚úÖ X·ª≠ l√Ω cho n√∫t "Facebook" (kh√¥ng c√≥ onclick) - Cho ph√©p c·∫£ ƒë√£ ƒëƒÉng nh·∫≠p v√† ch∆∞a ƒëƒÉng nh·∫≠p
                    if (btn.classList.contains('fb-share-btn') && btn.hasAttribute('data-filename')) {
                        const filename = btn.getAttribute('data-filename');
                        const shareUrl = `${window.location.origin}/view_svg/${filename}`;
                        copyToClipboardWithCustomFeedback(shareUrl, btn, 'Facebook', 'ƒê√£ copy!');
                        
                        // Gi·ªØ feedback hi·ªÉn th·ªã 2 gi√¢y tr∆∞·ªõc khi reset
                        setTimeout(() => {
                            btn.dataset.tapCount = '0';
                            btn.classList.remove('individual-active', 'ready-to-execute');
                        }, 2000);
                    }

                    // ‚úÖ X·ª≠ l√Ω cho n√∫t "Copy Link" (kh√¥ng c√≥ onclick) - Cho ph√©p c·∫£ ƒë√£ ƒëƒÉng nh·∫≠p v√† ch∆∞a ƒëƒÉng nh·∫≠p
                    else if (btn.classList.contains('file-copy-link-btn') && btn.hasAttribute('data-url')) {
                        const url = btn.getAttribute('data-url');
                        copyToClipboard(url, btn);
                        
                        // Gi·ªØ feedback hi·ªÉn th·ªã 2 gi√¢y tr∆∞·ªõc khi reset
                        setTimeout(() => {
                            btn.dataset.tapCount = '0';
                            btn.classList.remove('individual-active', 'ready-to-execute');
                        }, 2000);
                    }

                    // ‚úÖ X·ª≠ l√Ω cho n√∫t "X√≥a ·∫£nh" (kh√¥ng c√≥ onclick)
                    else if (btn.classList.contains('delete-btn')) {
                        showDeleteModal(btn);
                        
                        // Gi·ªØ feedback hi·ªÉn th·ªã 1 gi√¢y tr∆∞·ªõc khi reset
                        setTimeout(() => {
                            btn.dataset.tapCount = '0';
                            btn.classList.remove('individual-active', 'ready-to-execute');
                        }, 1000);
                    }

                    // ‚úÖ Th√™m x·ª≠ l√Ω cho n√∫t "T·∫£i ·∫£nh" (kh√¥ng c√≥ onclick)
                    else if (btn.querySelector('.text')?.textContent === 'T·∫£i ·∫£nh') {
                        const filename = btn.getAttribute('data-filename');
                        if (filename) {
                            window.location.href = `/view_svg/${filename}`;
                        } else {
                            console.error('Kh√¥ng t√¨m th·∫•y data-filename cho n√∫t T·∫£i ·∫£nh');
                        }
                        // Reset tr·∫°ng th√°i cho n√∫t T·∫£i ·∫£nh ngay l·∫≠p t·ª©c v√¨ s·∫Ω navigate
                        btn.dataset.tapCount = '0';
                        btn.classList.remove('individual-active', 'ready-to-execute');
                    }
                    
                    // ‚úÖ Th√™m x·ª≠ l√Ω cho n√∫t "Xem Code"
                    else if (btn.querySelector('.text')?.textContent === 'Xem Code' || btn.querySelector('.text')?.textContent === '·∫®n code') {
                        // Ki·ªÉm tra n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p v√† l√† n√∫t "Xem Code"
                        if (!window.isLoggedIn && btn.querySelector('.text')?.textContent === 'Xem Code') {
                            // Hi·ªÉn th·ªã modal ƒëƒÉng nh·∫≠p
                            const loginModal = document.getElementById('login-modal');
                            if (loginModal) {
                                loginModal.style.display = 'flex';
                                console.log('üîÑ Showing login modal for "Xem Code" button');
                            } else {
                                console.error('‚ùå Login modal not found');
                            }
                        } else {
                            // G·ªçi function toggleTikzCode ƒë·ªÉ hi·ªÉn th·ªã/·∫©n code (ƒë√£ ƒëƒÉng nh·∫≠p)
                            toggleTikzCode(btn);
                        }
                        
                        // Gi·ªØ feedback hi·ªÉn th·ªã 1 gi√¢y tr∆∞·ªõc khi reset
                        setTimeout(() => {
                            btn.dataset.tapCount = '0';
                            btn.classList.remove('individual-active', 'ready-to-execute');
                        }, 1000);
                    } 
                    else {
                        // C√°c n√∫t kh√°c: Gi·ªØ feedback hi·ªÉn th·ªã 1 gi√¢y
                        setTimeout(() => {
                            btn.dataset.tapCount = '0';
                            btn.classList.remove('individual-active', 'ready-to-execute');
                        }, 1000);
                    }
                    
                    return false;
                }
            }
        }, true); // Capture phase
    }

    // Function x·ª≠ l√Ω touch events ƒë∆°n gi·∫£n cho tr∆∞·ªùng h·ª£p ch∆∞a ƒëƒÉng nh·∫≠p
    function initializeSimpleTouchEventsForNotLoggedIn() {
        if (!document.documentElement.classList.contains('is-touch')) return;
        if (window.isLoggedIn) return; // Ch·ªâ x·ª≠ l√Ω cho tr∆∞·ªùng h·ª£p ch∆∞a ƒëƒÉng nh·∫≠p

        // Logic 2-tap gi·ªëng nh∆∞ ƒë√£ ƒëƒÉng nh·∫≠p
        document.addEventListener('click', function(e) {
            const btn = e.target.closest('.Btn');
            if (!btn) return;
            
            const card = btn.closest('.file-card');
            if (!card) return;

            if (!card.classList.contains('active')) {
                // M·ªü menu tr∆∞·ªõc, kh√¥ng th·ª±c thi l·ªánh ngay
                document.querySelectorAll('.file-card.active').forEach(other => {
                    if (other !== card) {
                        other.classList.remove('active');
                    }
                });
                card.classList.add('active');
                // Ch·ªâ m·ªü menu, ch·ªù tap ti·∫øp theo m·ªõi th·ª±c thi l·ªánh
                return;
            }
            
            // Ch·ªâ x·ª≠ l√Ω cho tr∆∞·ªùng h·ª£p ch∆∞a ƒëƒÉng nh·∫≠p
            if (window.isLoggedIn) return;
            
            // L·∫•y ho·∫∑c t·∫°o tapCount
            if (!btn.dataset.tapCount) btn.dataset.tapCount = '0';
            const currentTapCount = parseInt(btn.dataset.tapCount);
            
            if (currentTapCount === 0) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();

                // Reset c√°c n√∫t kh√°c
                card.querySelectorAll('.Btn').forEach(otherBtn => {
                    if (otherBtn !== btn) {
                        otherBtn.classList.remove('individual-active', 'ready-to-execute');
                        otherBtn.dataset.tapCount = '0';
                    }
                });

                btn.classList.add('individual-active', 'ready-to-execute');
                btn.dataset.tapCount = '1';

                // Auto reset sau 5s
                setTimeout(() => {
                    if (btn.dataset.tapCount === '1') {
                        btn.classList.remove('individual-active', 'ready-to-execute');
                        btn.dataset.tapCount = '0';
                    }
                }, 5000);
                
                return false;
            } 
            else if (currentTapCount === 1) {
                // TAP 2: X·ª≠ l√Ω action d·ª±a tr√™n lo·∫°i n√∫t
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();

                // ‚úÖ X·ª≠ l√Ω cho n√∫t "Facebook" - Cho ph√©p c·∫£ ƒë√£ ƒëƒÉng nh·∫≠p v√† ch∆∞a ƒëƒÉng nh·∫≠p
                if (btn.classList.contains('fb-share-btn') && btn.hasAttribute('data-filename')) {
                    const filename = btn.getAttribute('data-filename');
                    const shareUrl = `${window.location.origin}/view_svg/${filename}`;
                    copyToClipboardWithCustomFeedback(shareUrl, btn, 'Facebook', 'ƒê√£ copy!');
                    
                    // Gi·ªØ feedback hi·ªÉn th·ªã 2 gi√¢y tr∆∞·ªõc khi reset
                    setTimeout(() => {
                        btn.dataset.tapCount = '0';
                        btn.classList.remove('individual-active', 'ready-to-execute');
                    }, 2000);
                }
                // ‚úÖ X·ª≠ l√Ω cho n√∫t "Copy Link" - Cho ph√©p c·∫£ ƒë√£ ƒëƒÉng nh·∫≠p v√† ch∆∞a ƒëƒÉng nh·∫≠p
                else if (btn.classList.contains('file-copy-link-btn') && btn.hasAttribute('data-url')) {
                    const url = btn.getAttribute('data-url');
                    copyToClipboard(url, btn);
                    
                    // Gi·ªØ feedback hi·ªÉn th·ªã 2 gi√¢y tr∆∞·ªõc khi reset
                    setTimeout(() => {
                        btn.dataset.tapCount = '0';
                        btn.classList.remove('individual-active', 'ready-to-execute');
                    }, 2000);
                }
                // ‚úÖ X·ª≠ l√Ω cho n√∫t "T·∫£i ·∫£nh" - Cho ph√©p c·∫£ ƒë√£ ƒëƒÉng nh·∫≠p v√† ch∆∞a ƒëƒÉng nh·∫≠p
                else if (btn.querySelector('.text')?.textContent === 'T·∫£i ·∫£nh') {
                    const filename = btn.getAttribute('data-filename');
                    if (filename) {
                        window.location.href = `/view_svg/${filename}`;
                    } else {
                        console.error('Kh√¥ng t√¨m th·∫•y data-filename cho n√∫t T·∫£i ·∫£nh');
                    }
                    // Reset tr·∫°ng th√°i cho n√∫t T·∫£i ·∫£nh ngay l·∫≠p t·ª©c v√¨ s·∫Ω navigate
                    btn.dataset.tapCount = '0';
                    btn.classList.remove('individual-active', 'ready-to-execute');
                }
                // ‚úÖ X·ª≠ l√Ω cho n√∫t "Xem Code" - Ch·ªâ cho ph√©p khi ƒë√£ ƒëƒÉng nh·∫≠p
                else if (btn.querySelector('.text')?.textContent === 'Xem Code') {
                    // L∆∞u file ID v√†o data attribute c·ªßa modal ƒë·ªÉ d·ªÖ truy c·∫≠p
                    const loginModal = document.getElementById('login-modal');
                    if (loginModal) {
                        const card = btn.closest('.file-card');
                        const fileId = card ? card.getAttribute('data-id') : null;
                        
                        if (fileId) {
                            loginModal.setAttribute('data-pending-file-id', fileId);
                            console.log('üîÑ Set pending file ID for login modal:', fileId);
                        }
                        
                        loginModal.style.display = 'flex';
                        console.log('üîÑ Showing login modal for "Xem Code" button (not logged in)');
                    } else {
                        console.error('‚ùå Login modal not found');
                        // Fallback: redirect to login
                        window.location.href = '/login/google';
                    }

                    // Gi·ªØ feedback hi·ªÉn th·ªã 1 gi√¢y tr∆∞·ªõc khi reset
                    setTimeout(() => {
                        btn.dataset.tapCount = '0';
                        btn.classList.remove('individual-active', 'ready-to-execute');
                    }, 1000);
                }
                // ‚úÖ X·ª≠ l√Ω cho n√∫t "X√≥a ·∫£nh" - Ch·ªâ cho ph√©p khi ƒë√£ ƒëƒÉng nh·∫≠p
                else if (btn.classList.contains('delete-btn')) {
                    // Hi·ªÉn th·ªã modal ƒëƒÉng nh·∫≠p
                    const loginModal = document.getElementById('login-modal');
                    if (loginModal) {
                        loginModal.style.display = 'flex';
                        console.log('üîÑ Showing login modal for "Delete" button (not logged in)');
                    } else {
                        console.error('‚ùå Login modal not found');
                        // Fallback: redirect to login
                        window.location.href = '/login/google';
                    }

                    // Gi·ªØ feedback hi·ªÉn th·ªã 1 gi√¢y tr∆∞·ªõc khi reset
                    setTimeout(() => {
                        btn.dataset.tapCount = '0';
                        btn.classList.remove('individual-active', 'ready-to-execute');
                    }, 1000);
                }
                // ‚úÖ X·ª≠ l√Ω cho c√°c n√∫t kh√°c - Hi·ªÉn th·ªã modal ƒëƒÉng nh·∫≠p
                else {
                    // Hi·ªÉn th·ªã modal ƒëƒÉng nh·∫≠p
                    const loginModal = document.getElementById('login-modal');
                    if (loginModal) {
                        loginModal.style.display = 'flex';
                    } else {
                        // Fallback: redirect to login
                        window.location.href = '/login/google';
                    }

                    // Gi·ªØ feedback hi·ªÉn th·ªã 1 gi√¢y tr∆∞·ªõc khi reset
                    setTimeout(() => {
                        btn.dataset.tapCount = '0';
                        btn.classList.remove('individual-active', 'ready-to-execute');
                    }, 1000);
                }
                
                return false;
            }
        }, true); // Capture phase
    }

    // Copy to clipboard functions
    function copyToClipboard(url, btn) {
        const card = btn.closest('.file-card');
        const actionContainer = card ? card.querySelector('.file-action-container') : null;
        
        // Ki·ªÉm tra xem c√≥ ph·∫£i HTTPS ho·∫∑c localhost kh√¥ng
        const isSecureContext = window.isSecureContext || window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        // Th·ª≠ s·ª≠ d·ª•ng navigator.clipboard tr∆∞·ªõc (ch·ªâ khi c√≥ quy·ªÅn)
        if (navigator.clipboard && isSecureContext) {
            navigator.clipboard.writeText(url).then(function() {
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = 'ƒê√£ copy!';
                    window.activeFeedbackCount++; // TƒÉng counter
                    setTimeout(() => { 
                        textDiv.textContent = 'Copy Link'; 
                        window.activeFeedbackCount--; // Gi·∫£m counter
                    }, 3000);
                }
            }).catch(function(err) {
                console.error('‚ùå Clipboard API failed:', err);
                console.log('üîÑ Falling back to execCommand method');
                // Fallback to execCommand
                fallbackCopyToClipboard(url, btn);
            });
        } else {
            // Fallback cho c√°c tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Clipboard API ho·∫∑c kh√¥ng c√≥ quy·ªÅn
            console.log('üîÑ Using fallback copy method (no clipboard permission)');
            fallbackCopyToClipboard(url, btn);
        }
    }

    function fallbackCopyToClipboard(url, btn) {
        console.log('üîÑ Executing fallback copy method for URL:', url);
        
        const textArea = document.createElement('textarea');
        textArea.value = url;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        
        try {
            textArea.focus();
            textArea.select();
            console.log('üîÑ Text selected, attempting to copy...');
            
            const successful = document.execCommand('copy');
            console.log('üîÑ execCommand result:', successful);
            
            if (successful) {
                console.log('‚úÖ Fallback copy successful');
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = 'ƒê√£ copy!';
                    window.activeFeedbackCount++; // TƒÉng counter
                    setTimeout(() => { 
                        textDiv.textContent = 'Copy Link'; 
                        window.activeFeedbackCount--; // Gi·∫£m counter
                    }, 3000);
                }
            } else {
                console.error('‚ùå execCommand copy failed');
                // Th·ª≠ hi·ªÉn th·ªã feedback ngay c·∫£ khi copy th·∫•t b·∫°i
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = 'Copy th·∫•t b·∫°i';
                    setTimeout(() => { 
                        textDiv.textContent = 'Copy Link'; 
                    }, 3000);
                }
                alert('Kh√¥ng th·ªÉ copy link. Vui l√≤ng copy th·ªß c√¥ng: ' + url);
            }
        } catch (err) {
            console.error('‚ùå execCommand copy error:', err);
            // Th·ª≠ hi·ªÉn th·ªã feedback ngay c·∫£ khi c√≥ l·ªói
            const textDiv = btn.querySelector('.text');
            if (textDiv) {
                textDiv.textContent = 'Copy th·∫•t b·∫°i';
                setTimeout(() => { 
                    textDiv.textContent = 'Copy Link'; 
                }, 3000);
            }
            alert('Kh√¥ng th·ªÉ copy link. Vui l√≤ng copy th·ªß c√¥ng: ' + url);
        } finally {
            // Lu√¥n cleanup textarea
            if (document.body.contains(textArea)) {
                document.body.removeChild(textArea);
            }
        }
    }

    function copyToClipboardWithCustomFeedback(url, btn, originalText, feedbackText) {
        const card = btn.closest('.file-card');
        const actionContainer = card ? card.querySelector('.file-action-container') : null;
        
        // Ki·ªÉm tra xem c√≥ ph·∫£i HTTPS ho·∫∑c localhost kh√¥ng
        const isSecureContext = window.isSecureContext || window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        // Th·ª≠ s·ª≠ d·ª•ng navigator.clipboard tr∆∞·ªõc (ch·ªâ khi c√≥ quy·ªÅn)
        if (navigator.clipboard && isSecureContext) {
            navigator.clipboard.writeText(url).then(function() {
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = feedbackText;
                    window.activeFeedbackCount++; // TƒÉng counter
                    
                    setTimeout(() => { 
                        textDiv.textContent = originalText; 
                        window.activeFeedbackCount--; // Gi·∫£m counter
                    }, 3000);
                }
            }).catch(function(err) {
                console.error('‚ùå Clipboard API failed (custom feedback):', err);
                // Fallback to execCommand
                fallbackCopyToClipboardWithCustomFeedback(url, btn, originalText, feedbackText);
            });
        } else {
            // Fallback cho c√°c tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Clipboard API ho·∫∑c kh√¥ng c√≥ quy·ªÅn
            console.log('üîÑ Using fallback copy method with custom feedback (no clipboard permission)');
            fallbackCopyToClipboardWithCustomFeedback(url, btn, originalText, feedbackText);
        }
    }

    function fallbackCopyToClipboardWithCustomFeedback(url, btn, originalText, feedbackText) {
        const textArea = document.createElement('textarea');
        textArea.value = url;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            
            if (successful) {
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = feedbackText;
                    window.activeFeedbackCount++; // TƒÉng counter
                    
                    setTimeout(() => { 
                        textDiv.textContent = originalText; 
                        window.activeFeedbackCount--; // Gi·∫£m counter
                    }, 3000);
                }
            } else {
                console.error('‚ùå execCommand copy failed (custom feedback)');
                // Th·ª≠ hi·ªÉn th·ªã feedback ngay c·∫£ khi copy th·∫•t b·∫°i
                const textDiv = btn.querySelector('.text');
                if (textDiv) {
                    textDiv.textContent = 'Copy th·∫•t b·∫°i';
                    setTimeout(() => { 
                        textDiv.textContent = originalText; 
                    }, 3000);
                }
                alert('Kh√¥ng th·ªÉ copy link. Vui l√≤ng copy th·ªß c√¥ng: ' + url);
            }
        } catch (err) {
            console.error('‚ùå execCommand copy error (custom feedback):', err);
            // Th·ª≠ hi·ªÉn th·ªã feedback ngay c·∫£ khi c√≥ l·ªói
            const textDiv = btn.querySelector('.text');
            if (textDiv) {
                textDiv.textContent = 'Copy th·∫•t b·∫°i';
                setTimeout(() => { 
                    textDiv.textContent = originalText; 
                }, 3000);
            }
            alert('Kh√¥ng th·ªÉ copy link. Vui l√≤ng copy th·ªß c√¥ng: ' + url);
        }
        
        document.body.removeChild(textArea);
    }

    // Toggle TikZ code function
    function toggleTikzCode(btn) {
        // Ki·ªÉm tra n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
        if (!window.isLoggedIn) {
            console.log('üîÑ User not logged in, showing login modal for "Xem Code"');
            const loginModal = document.getElementById('login-modal');
            if (loginModal) {
                loginModal.style.display = 'flex';
            } else {
                console.error('‚ùå Login modal not found');
            }
            return;
        }
        
        const card = btn.closest('.file-card');
        const codeBlock = card.querySelector('.tikz-code-block');
        const textDiv = btn.querySelector('.text');
        
        if (codeBlock.style.display === 'none' || !codeBlock.style.display) {
            codeBlock.style.display = 'block';
            textDiv.textContent = '·∫®n code';
            
            // Initialize CodeMirror when showing the code block
            setTimeout(() => {
                const textarea = codeBlock.querySelector('.tikz-cm');
                if (textarea && !textarea.CodeMirror) {
                    console.log('üîç T·∫°o CodeMirror instance m·ªõi');
                    const existingCm = codeBlock.querySelector('.CodeMirror');
                    if (existingCm) {
                        existingCm.remove();
                    }
                    
                    const cmInstance = CodeMirror.fromTextArea(textarea, {
                        mode: 'stex',
                        theme: 'material',
                        lineNumbers: true,
                        readOnly: true,
                        lineWrapping: true,
                        foldGutter: true,
                        gutters: ['CodeMirror-linenumbers'],
                        viewportMargin: Infinity
                    });
                    
                    // Refresh CodeMirror after a short delay
                    setTimeout(() => {
                        cmInstance.refresh();
                    }, 100);
                }
            }, 50);
        } else {
            codeBlock.style.display = 'none';
            textDiv.textContent = 'Xem Code';
        }
    }

    // Copy TikZ code function
    function copyTikzCode(btn) {
        // Ki·ªÉm tra n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
        if (!window.isLoggedIn) {
            console.log('üîÑ User not logged in, showing login modal for "Copy Code"');
            const loginModal = document.getElementById('login-modal');
            if (loginModal) {
                loginModal.style.display = 'flex';
            } else {
                console.error('‚ùå Login modal not found');
            }
            return;
        }
        
        const card = btn.closest('.file-card');
        const textarea = card.querySelector('.tikz-cm');
        
        // L·∫•y code t·ª´ CodeMirror instance n·∫øu c√≥, n·∫øu kh√¥ng th√¨ t·ª´ textarea g·ªëc
        let code = textarea.value;
        
        // ∆Øu ti√™n l·∫•y t·ª´ CodeMirror instance
        if (textarea.CodeMirror) {
            code = textarea.CodeMirror.getValue();
            console.log('Getting code from CodeMirror instance');
        } else {
            console.log('Getting code from original textarea');
        }
        
        // Ki·ªÉm tra xem c√≥ ph·∫£i HTTPS ho·∫∑c localhost kh√¥ng
        const isSecureContext = window.isSecureContext || window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        if (navigator.clipboard && isSecureContext) {
            navigator.clipboard.writeText(code).then(function() {
                btn.textContent = 'ƒê√£ copy!';
                setTimeout(() => { 
                    btn.textContent = 'üìã Copy'; 
                }, 2000);
            }).catch(function(err) {
                console.error('‚ùå Clipboard API failed:', err);
                fallbackCopyTikzCode(code, btn);
            });
        } else {
            console.log('üîÑ Using fallback copy method for TikZ code (no clipboard permission)');
            fallbackCopyTikzCode(code, btn);
        }
    }

    function fallbackCopyTikzCode(code, btn) {
        const textArea = document.createElement('textarea');
        textArea.value = code;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                btn.textContent = 'ƒê√£ copy!';
                setTimeout(() => { 
                    btn.textContent = 'üìã Copy'; 
                }, 2000);
            } else {
                alert('Kh√¥ng th·ªÉ copy code. Vui l√≤ng copy th·ªß c√¥ng.');
            }
        } catch (err) {
            console.error('‚ùå execCommand copy error:', err);
            alert('Kh√¥ng th·ªÉ copy code. Vui l√≤ng copy th·ªß c√¥ng.');
        }
        
        document.body.removeChild(textArea);
    }

    // Initialize CodeMirror for TikZ code blocks
    function initializeCodeMirror() {
        document.querySelectorAll('.tikz-cm').forEach(function(textarea) {
            if (!textarea.CodeMirror) {
                const codeBlock = textarea.closest('.tikz-code-block');
                if (codeBlock) {
                    console.log('üîç T·∫°o CodeMirror instance m·ªõi');
                    const existingCm = codeBlock.querySelector('.CodeMirror');
                    if (existingCm) {
                        existingCm.remove();
                    }
                    
                    const cmInstance = CodeMirror.fromTextArea(textarea, {
                        mode: 'stex',
                        theme: 'material',
                        lineNumbers: true,
                        readOnly: true,
                        lineWrapping: true,
                        foldGutter: true,
                        gutters: ['CodeMirror-linenumbers'],
                        viewportMargin: Infinity
                    });
                    
                    // Refresh CodeMirror after a short delay
                    setTimeout(() => {
                        cmInstance.refresh();
                    }, 100);
                }
            } else {
                console.log('üîç S·ª≠ d·ª•ng CodeMirror instance hi·ªán c√≥');
                const cmInstance = textarea.CodeMirror;
                setTimeout(() => {
                    cmInstance.refresh();
                }, 100);
                console.log('üîç Refresh CodeMirror');
            }
        });
    }



    // Function to initialize Facebook share buttons
    function initializeFbShareButtons() {
        // Initialize Facebook share buttons for regular file cards
        const regularFbShareBtns = document.querySelectorAll('.file-card:not(.followed-post-card) .fb-share-btn');
        console.log('üîÑ Initializing: Found', regularFbShareBtns.length, 'regular fb-share-btn buttons');
        
        // Facebook share buttons s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi Desktop logic v√† Touch events
        // Kh√¥ng c·∫ßn th√™m event listener ri√™ng ·ªü ƒë√¢y
        console.log('üîÑ Facebook share buttons will be handled by Desktop logic and Touch events');
    }

    // Function to initialize copy link buttons
    function initializeCopyLinkButtons() {
        const regularCopyLinkBtns = document.querySelectorAll('.file-card:not(.followed-post-card) .file-copy-link-btn');
        console.log('üîÑ Initializing: Found', regularCopyLinkBtns.length, 'regular file-copy-link-btn buttons');
        
        // Copy link buttons s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi Desktop logic v√† Touch events
        // Kh√¥ng c·∫ßn th√™m event listener ri√™ng ·ªü ƒë√¢y
        console.log('üîÑ Copy link buttons will be handled by Desktop logic and Touch events');
    }

    // Re-initialize buttons after a short delay to ensure DOM is ready
    setTimeout(function() {
        initializeFbShareButtons();
        initializeCopyLinkButtons();
        
        // ==== Th√™m logic cho Desktop buttons (ƒë√£ ƒëƒÉng nh·∫≠p) ====
        if (!document.documentElement.classList.contains('is-touch') && window.isLoggedIn) {
            console.log('üñ•Ô∏è Adding Desktop button logic (logged in)');
            
            // Th√™m event listener cho Desktop buttons
            document.addEventListener('click', function(e) {
                const btn = e.target.closest('.file-card:not(.followed-post-card) .fb-share-btn, .file-card:not(.followed-post-card) .file-copy-link-btn');
                if (!btn) return;
                
                console.log('üñ•Ô∏è Desktop button clicked (logged in):', btn.className);
                
                e.preventDefault();
                e.stopPropagation();
                
                if (btn.classList.contains('fb-share-btn')) {
                    const filename = btn.getAttribute('data-filename');
                    if (!filename) {
                        console.error('‚ùå No filename found for Desktop Facebook button');
                        return;
                    }
                    
                    const shareUrl = `${window.location.origin}/view_svg/${filename}`;
                    console.log('üñ•Ô∏è Desktop Facebook Share URL:', shareUrl);
                    
                    // S·ª≠ d·ª•ng function copyToClipboard v·ªõi custom feedback
                    copyToClipboardWithCustomFeedback(shareUrl, btn, 'Facebook', 'ƒê√£ copy!');
                    
                    console.log('‚úÖ Desktop Facebook button: Link copied successfully');
                } else if (btn.classList.contains('file-copy-link-btn')) {
                    const url = btn.getAttribute('data-url');
                    if (!url) {
                        console.error('‚ùå No URL found for Desktop Copy Link button');
                        return;
                    }
                    
                    console.log('üñ•Ô∏è Desktop Copy Link URL:', url);
                    
                    // S·ª≠ d·ª•ng function copyToClipboard
                    copyToClipboard(url, btn);
                    
                    console.log('‚úÖ Desktop Copy Link button: Link copied successfully');
                }
            });
        }
        
        // ==== Th√™m logic cho Desktop buttons (ch∆∞a ƒëƒÉng nh·∫≠p) - Cho ph√©p Facebook v√† Copy Link ====
        if (!document.documentElement.classList.contains('is-touch') && !window.isLoggedIn) {
            console.log('üñ•Ô∏è Adding Desktop button logic (not logged in) - Allowing Facebook and Copy Link');
            
            // Th√™m event listener cho Desktop buttons khi ch∆∞a ƒëƒÉng nh·∫≠p
            document.addEventListener('click', function(e) {
                const btn = e.target.closest('.file-card:not(.followed-post-card) .fb-share-btn, .file-card:not(.followed-post-card) .file-copy-link-btn, .file-card:not(.followed-post-card) .view-code-btn, .file-card:not(.followed-post-card) .delete-btn');
                if (!btn) return;
                
                console.log('üñ•Ô∏è Desktop button clicked (not logged in):', btn.className);
                
                e.preventDefault();
                e.stopPropagation();
                
                // ‚úÖ X·ª≠ l√Ω cho n√∫t "Facebook" - Cho ph√©p c·∫£ ƒë√£ ƒëƒÉng nh·∫≠p v√† ch∆∞a ƒëƒÉng nh·∫≠p
                if (btn.classList.contains('fb-share-btn')) {
                    const filename = btn.getAttribute('data-filename');
                    if (!filename) {
                        console.error('‚ùå No filename found for Desktop Facebook button');
                        return;
                    }
                    
                    const shareUrl = `${window.location.origin}/view_svg/${filename}`;
                    console.log('üñ•Ô∏è Desktop Facebook Share URL (not logged in):', shareUrl);
                    
                    // S·ª≠ d·ª•ng function copyToClipboard v·ªõi custom feedback
                    copyToClipboardWithCustomFeedback(shareUrl, btn, 'Facebook', 'ƒê√£ copy!');
                    
                    console.log('‚úÖ Desktop Facebook button (not logged in): Link copied successfully');
                }
                // ‚úÖ X·ª≠ l√Ω cho n√∫t "Copy Link" - Cho ph√©p c·∫£ ƒë√£ ƒëƒÉng nh·∫≠p v√† ch∆∞a ƒëƒÉng nh·∫≠p
                else if (btn.classList.contains('file-copy-link-btn')) {
                    const url = btn.getAttribute('data-url');
                    if (!url) {
                        console.error('‚ùå No URL found for Desktop Copy Link button');
                        return;
                    }
                    
                    console.log('üñ•Ô∏è Desktop Copy Link URL (not logged in):', url);
                    
                    // S·ª≠ d·ª•ng function copyToClipboard
                    copyToClipboard(url, btn);
                    
                    console.log('‚úÖ Desktop Copy Link button (not logged in): Link copied successfully');
                }
                // ‚úÖ X·ª≠ l√Ω cho n√∫t "Xem Code" v√† "X√≥a ·∫£nh" - Hi·ªÉn th·ªã modal ƒëƒÉng nh·∫≠p
                else if (btn.classList.contains('view-code-btn') || btn.classList.contains('delete-btn')) {
                    // L∆∞u file ID v√†o data attribute c·ªßa modal ƒë·ªÉ d·ªÖ truy c·∫≠p
                    const loginModal = document.getElementById('login-modal');
                    if (loginModal) {
                        const card = btn.closest('.file-card');
                        const fileId = card ? card.getAttribute('data-id') : null;
                        
                        if (fileId) {
                            loginModal.setAttribute('data-pending-file-id', fileId);
                            console.log('üîÑ Set pending file ID for login modal (desktop):', fileId);
                        }
                        
                        loginModal.style.display = 'flex';
                        console.log('üîÑ Showing login modal for button (desktop, not logged in)');
                    } else {
                        console.error('‚ùå Login modal not found');
                        // Fallback: redirect to login
                        window.location.href = '/login/google';
                    }
                }
            });
        }
        

    }, 100);

    // Real-time synchronization for follower count via polling
    function startFollowerCountPolling() {
        const pollInterval = 15000; // 15 seconds (longer than like polling)
        let lastUpdateTime = Date.now();
        
        console.log('üîÑ startFollowerCountPolling initialized with interval:', pollInterval, 'ms');
        
        setInterval(function() {
            // Skip polling if user action is in progress
            if (isUserActionInProgress) {
                console.log('üîÑ Skipping follower count polling - user action in progress');
                return;
            }
            
            // Get current user ID from the page
            const followBtn = document.querySelector('.follow-btn');
            let userId;
            
            if (followBtn) {
                userId = followBtn.getAttribute('data-user-id');
            } else {
                // If no follow button, try to get user ID from URL
                const pathParts = window.location.pathname.split('/');
                const userIndex = pathParts.indexOf('profile');
                if (userIndex !== -1 && pathParts[userIndex + 1]) {
                    userId = pathParts[userIndex + 1];
                }
            }
            
            if (!userId) {
                console.log('üîÑ No user ID found, skipping follower count polling');
                return;
            }
            
            console.log('üîÑ Polling for follower count of user:', userId);
            
            // Fetch updated follower count and follow status
            Promise.all([
                fetch(`/api/follower_count/${userId}`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                }),
                fetch(`/api/follow_status/${userId}`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
            ])
            .then(responses => Promise.all(responses.map(r => r.json())))
            .then(([followerData, followData]) => {
                // Update follower count
                if (followerData && followerData.follower_count !== undefined) {
                    const newFollowerCount = followerData.follower_count;
                    
                    // Update follower count display
                    let followerCountElement = null;
                    // Try to find by text content
                    const spans = document.querySelectorAll('.public-profile-header span');
                    for (let span of spans) {
                        if (span.textContent.includes('üë•')) {
                            followerCountElement = span;
                            break;
                        }
                    }
                    
                    if (followerCountElement) {
                        const currentText = followerCountElement.textContent;
                        const currentCount = parseInt(currentText.match(/\d+/)[0]) || 0;
                        
                        // Update if count changed
                        if (currentCount !== newFollowerCount) {
                            followerCountElement.textContent = `üë• ${newFollowerCount} followers`;
                            console.log(`üîÑ Real-time update: User ${userId} now has ${newFollowerCount} followers`);
                            
                            // Add visual feedback
                            followerCountElement.style.animation = 'pulse 0.5s ease-in-out';
                            setTimeout(() => {
                                followerCountElement.style.animation = '';
                            }, 500);
                        }
                    }
                }
                
                // Update follow button status
                if (followData && followData.is_following !== undefined) {
                    const newFollowStatus = followData.is_following;
                    const followBtn = document.querySelector(`.follow-btn[data-user-id="${userId}"]`);
                    
                    if (followBtn) {
                        const currentStatus = followBtn.textContent.includes('B·ªè theo d√µi');
                        
                        // Update if status changed
                        if (currentStatus !== newFollowStatus) {
                            if (newFollowStatus) {
                                // User is following - show "B·ªè theo d√µi" button
                                followBtn.textContent = 'üë• B·ªè theo d√µi';
                                followBtn.className = 'btn btn-secondary follow-btn';
                                followBtn.onclick = () => unfollowUser(userId);
                                console.log(`üîÑ Real-time update: Follow status changed to following`);
                            } else {
                                // User is not following - show "Theo d√µi" button
                                followBtn.textContent = 'üë• Theo d√µi';
                                followBtn.className = 'btn btn-primary follow-btn';
                                followBtn.onclick = () => followUser(userId);
                                console.log(`üîÑ Real-time update: Follow status changed to not following`);
                            }
                            
                            // Add visual feedback
                            followBtn.style.animation = 'pulse 0.5s ease-in-out';
                            setTimeout(() => {
                                followBtn.style.animation = '';
                            }, 500);
                        }
                    }
                }
                
                lastUpdateTime = Date.now();
            })
            .catch(error => {
                console.error('Follower count polling error:', error);
            });
        }, pollInterval);
    }

    // Real-time synchronization via polling
    function startLikePolling() {
        const pollInterval = 10000; // 10 seconds
        let lastUpdateTime = Date.now();
        
        console.log('üîÑ startLikePolling initialized with interval:', pollInterval, 'ms');
        console.log('üîÑ User login status:', window.isLoggedIn ? 'Logged in' : 'Not logged in');
        
        setInterval(function() {
            // Skip polling if user action is in progress
            if (isUserActionInProgress) {
                console.log('üîÑ Skipping like polling - user action in progress');
                return;
            }
            
            // Get all file IDs on the page
            const fileCards = document.querySelectorAll('.file-card');
            const fileIds = Array.from(fileCards).map(card => {
                return card.dataset.id;
            }).filter(id => id); // Filter out undefined
            
            if (fileIds.length === 0) {
                console.log('üîÑ No file cards found for polling');
                return;
            }
            
            console.log('üîÑ Polling for', fileIds.length, 'files:', fileIds);
            
            // Fetch updated like counts
            fetch('/api/like_counts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    ids: fileIds
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data && typeof data === 'object') {
                    let updateCount = 0;
                    
                    // Update UI for changed files
                    Object.keys(data).forEach(fileId => {
                        const fileData = data[fileId];
                        const fileCard = document.querySelector(`.file-card[data-id="${fileId}"]`);
                        
                        if (fileCard && fileData) {
                            const likeButton = fileCard.querySelector('.like-button');
                            const likeCountSpan = fileCard.querySelector('.like-count.one');
                            const moveNumber = fileCard.querySelector('.like-count.two');
                            
                            // C·∫≠p nh·∫≠t cho tr∆∞·ªùng h·ª£p ƒë√£ ƒëƒÉng nh·∫≠p (c√≥ like-button)
                            if (likeButton && likeCountSpan && moveNumber) {
                                const currentCount = parseInt(likeCountSpan.textContent) || 0;
                                const newLikeCount = fileData.like_count || 0;
                                
                                // Update like count if changed
                                if (currentCount !== newLikeCount) {
                                    likeCountSpan.textContent = newLikeCount;
                                    moveNumber.textContent = newLikeCount;
                                    console.log(`üîÑ Real-time update: File ${fileId} now has ${newLikeCount} likes (logged in)`);
                                    updateCount++;
                                    
                                    // Add visual feedback
                                    likeButton.style.animation = 'pulse 0.5s ease-in-out';
                                    setTimeout(() => {
                                        likeButton.style.animation = '';
                                    }, 500);
                                }
                                
                                // Update checkbox state if changed (only for logged in users)
                                const checkbox = likeButton.querySelector('input[type="checkbox"]');
                                if (checkbox && fileData.is_liked_by_current_user !== undefined) {
                                    const currentChecked = checkbox.checked;
                                    const newChecked = fileData.is_liked_by_current_user;
                                    
                                    if (currentChecked !== newChecked) {
                                        checkbox.checked = newChecked;
                                        console.log(`üîÑ Real-time update: File ${fileId} like status changed to ${newChecked}`);
                                        
                                        // Trigger change event to update UI styling
                                        const event = new Event('change', { bubbles: true });
                                        checkbox.dispatchEvent(event);
                                    }
                                }
                            }
                            // C·∫≠p nh·∫≠t cho tr∆∞·ªùng h·ª£p ch∆∞a ƒëƒÉng nh·∫≠p (kh√¥ng c√≥ like-button)
                            else {
                                // T√¨m like display div v·ªõi selector c·∫£i ti·∫øn
                                const likeDisplayDiv = fileCard.querySelector('div[style*="position: absolute"][style*="bottom: 8px"][style*="right: 8px"]') || 
                                                     fileCard.querySelector('div[style*="backdrop-filter"]') ||
                                                     fileCard.querySelector('div:has(span[style*="font-weight: 600"])');
                                
                                if (likeDisplayDiv) {
                                    const likeCountText = likeDisplayDiv.querySelector('span[style*="font-weight: 600"]') ||
                                                         likeDisplayDiv.querySelector('span:last-child');
                                    
                                    if (likeCountText) {
                                        const currentCount = parseInt(likeCountText.textContent) || 0;
                                        const newLikeCount = fileData.like_count || 0;
                                        
                                        // Update like count if changed
                                        if (currentCount !== newLikeCount) {
                                            likeCountText.textContent = newLikeCount;
                                            console.log(`üîÑ Real-time update: File ${fileId} now has ${newLikeCount} likes (not logged in)`);
                                            updateCount++;
                                            
                                            // Add visual feedback
                                            likeDisplayDiv.style.animation = 'pulse 0.5s ease-in-out';
                                            setTimeout(() => {
                                                likeDisplayDiv.style.animation = '';
                                            }, 500);
                                        }
                                    } else {
                                        console.warn(`‚ö†Ô∏è Could not find like count text for file ${fileId} (not logged in)`);
                                    }
                                } else {
                                    console.warn(`‚ö†Ô∏è Could not find like display div for file ${fileId} (not logged in)`);
                                }
                            }
                        }
                    });
                    
                    if (updateCount > 0) {
                        console.log(`‚úÖ Polling completed: Updated ${updateCount} like counts`);
                    }
                    
                    lastUpdateTime = Date.now();
                }
            })
            .catch(error => {
                console.error('‚ùå Polling error:', error);
            });
        }, pollInterval);
    }
    
    // Global flag to prevent polling conflicts
    let isUserActionInProgress = false;
    
    // Follow/Unfollow functions
    function followUser(userId) {
        // Set flag to prevent polling conflicts
        isUserActionInProgress = true;
        
        fetch(`/follow/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update button to unfollow
                const followBtn = document.querySelector(`.follow-btn[data-user-id="${userId}"]`);
                if (followBtn) {
                    followBtn.textContent = 'üë• B·ªè theo d√µi';
                    followBtn.className = 'btn btn-secondary follow-btn';
                    followBtn.onclick = () => unfollowUser(userId);
                }
                
                // Update follower count
                let followerCountElement = null;
                // Try to find by text content
                const spans = document.querySelectorAll('.public-profile-header span');
                for (let span of spans) {
                    if (span.textContent.includes('üë•')) {
                        followerCountElement = span;
                        break;
                    }
                }
                
                if (followerCountElement) {
                    const currentText = followerCountElement.textContent;
                    const currentCount = parseInt(currentText.match(/\d+/)[0]) || 0;
                    followerCountElement.textContent = `üë• ${currentCount + 1} followers`;
                    console.log(`‚úÖ Updated follower count from ${currentCount} to ${currentCount + 1}`);
                } else {
                    console.error('‚ùå Could not find follower count element');
                }
                
                console.log('‚úÖ Successfully followed user');
                
                // Reset flag after 3 seconds to allow polling to resume
                setTimeout(() => {
                    isUserActionInProgress = false;
                }, 3000);
            } else {
                alert(data.message || 'L·ªói khi theo d√µi user!');
                isUserActionInProgress = false;
            }
        })
        .catch(error => {
            console.error('Follow error:', error);
            alert('L·ªói khi theo d√µi user!');
            isUserActionInProgress = false;
        });
    }
    
    function unfollowUser(userId) {
        // Set flag to prevent polling conflicts
        isUserActionInProgress = true;
        
        fetch(`/unfollow/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update button to follow
                const unfollowBtn = document.querySelector(`.follow-btn[data-user-id="${userId}"]`);
                if (unfollowBtn) {
                    unfollowBtn.textContent = 'üë• Theo d√µi';
                    unfollowBtn.className = 'btn btn-primary follow-btn';
                    unfollowBtn.onclick = () => followUser(userId);
                }
                
                // Update follower count
                let followerCountElement = null;
                // Try to find by text content
                const spans = document.querySelectorAll('.public-profile-header span');
                for (let span of spans) {
                    if (span.textContent.includes('üë•')) {
                        followerCountElement = span;
                        break;
                    }
                }
                
                if (followerCountElement) {
                    const currentText = followerCountElement.textContent;
                    const currentCount = parseInt(currentText.match(/\d+/)[0]) || 0;
                    followerCountElement.textContent = `üë• ${Math.max(0, currentCount - 1)} followers`;
                    console.log(`‚úÖ Updated follower count from ${currentCount} to ${Math.max(0, currentCount - 1)}`);
                } else {
                    console.error('‚ùå Could not find follower count element');
                }
                
                console.log('‚úÖ Successfully unfollowed user');
                
                // Reset flag after 3 seconds to allow polling to resume
                setTimeout(() => {
                    isUserActionInProgress = false;
                }, 3000);
            } else {
                alert(data.message || 'L·ªói khi b·ªè theo d√µi user!');
                isUserActionInProgress = false;
            }
        })
        .catch(error => {
            console.error('Unfollow error:', error);
            alert('L·ªói khi b·ªè theo d√µi user!');
            isUserActionInProgress = false;
        });
    }
    

    </script>

<!-- Debug script for follow/unfollow -->
<script>
// Debug script for follow/unfollow functionality
function debugFollow(userId) {
    console.log('üîç Debugging follow function...');
    console.log('User ID:', userId);
    console.log('isUserActionInProgress flag:', isUserActionInProgress);
    
    // Test 1: Check if button exists
    const followBtn = document.querySelector(`.follow-btn[data-user-id="${userId}"]`);
    console.log('Follow button found:', followBtn);
    
    // Test 2: Check if follower count element exists
    const spans = document.querySelectorAll('.public-profile-header span');
    let followerCountElement = null;
    for (let span of spans) {
        if (span.textContent.includes('üë•')) {
            followerCountElement = span;
            break;
        }
    }
    console.log('Follower count element found:', followerCountElement);
    if (followerCountElement) {
        console.log('Current follower count text:', followerCountElement.textContent);
    }
    
    // Test 3: Simulate API call
    console.log('üîç Simulating API call to /follow/' + userId);
    
    fetch(`/follow/${userId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        
        if (data.success) {
            console.log('‚úÖ API call successful');
            
            // Test button update
            if (followBtn) {
                followBtn.textContent = 'üë• B·ªè theo d√µi';
                followBtn.className = 'btn btn-secondary follow-btn';
                console.log('‚úÖ Button updated');
            }
            
            // Test follower count update
            if (followerCountElement) {
                const currentText = followerCountElement.textContent;
                const currentCount = parseInt(currentText.match(/\d+/)[0]) || 0;
                followerCountElement.textContent = `üë• ${currentCount + 1} followers`;
                console.log(`‚úÖ Follower count updated from ${currentCount} to ${currentCount + 1}`);
            }
        } else {
            console.log('‚ùå API call failed:', data.message);
        }
    })
    .catch(error => {
        console.error('‚ùå Network error:', error);
    });
    
    // Test 4: Test new follow status API
    console.log('üîç Testing follow status API...');
    fetch(`/api/follow_status/${userId}`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Follow status API response:', data);
        if (data.success) {
            console.log(`‚úÖ Current follow status: ${data.is_following ? 'Following' : 'Not following'}`);
        }
    })
    .catch(error => {
        console.error('‚ùå Follow status API error:', error);
    });
}

// Debug script for polling functionality
function debugPolling() {
    console.log('üîç Debugging polling functionality...');
    console.log('User login status:', window.isLoggedIn ? 'Logged in' : 'Not logged in');
    console.log('isUserActionInProgress flag:', isUserActionInProgress);
    
    // Test 1: Check file cards
    const fileCards = document.querySelectorAll('.file-card');
    console.log('Found file cards:', fileCards.length);
    
    fileCards.forEach((card, index) => {
        const fileId = card.dataset.id;
        console.log(`File ${index + 1}: ID = ${fileId}`);
        
        // Check for like button (logged in)
        const likeButton = card.querySelector('.like-button');
        if (likeButton) {
            console.log(`  - Has like button (logged in mode)`);
            const likeCount = likeButton.querySelector('.like-count.one');
            if (likeCount) {
                console.log(`  - Current like count: ${likeCount.textContent}`);
            }
        } else {
            console.log(`  - No like button (not logged in mode)`);
            
            // Check for like display div (not logged in)
            const likeDisplayDiv = card.querySelector('div[style*="position: absolute"][style*="bottom: 8px"][style*="right: 8px"]') || 
                                 card.querySelector('div[style*="backdrop-filter"]');
            if (likeDisplayDiv) {
                console.log(`  - Has like display div (not logged in mode)`);
                const likeCountText = likeDisplayDiv.querySelector('span[style*="font-weight: 600"]') ||
                                     likeDisplayDiv.querySelector('span:last-child');
                if (likeCountText) {
                    console.log(`  - Current like count: ${likeCountText.textContent}`);
                }
            } else {
                console.log(`  - No like display div found`);
            }
        }
        
        // Check for view code button
        const viewCodeBtn = card.querySelector('.view-code-btn');
        if (viewCodeBtn) {
            console.log(`  - Has view code button`);
            const hasOnclick = viewCodeBtn.hasAttribute('onclick');
            console.log(`  - Has onclick attribute: ${hasOnclick}`);
        } else {
            console.log(`  - No view code button found`);
        }
    });
    
    // Test 2: Simulate polling API call
    const fileIds = Array.from(fileCards).map(card => card.dataset.id).filter(id => id);
    console.log('File IDs for polling:', fileIds);
    
    if (fileIds.length > 0) {
        console.log('üîç Testing polling API call...');
        fetch('/api/like_counts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                ids: fileIds
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Polling API response:', data);
            if (data && typeof data === 'object') {
                Object.keys(data).forEach(fileId => {
                    const fileData = data[fileId];
                    console.log(`File ${fileId}: like_count = ${fileData.like_count}, is_liked_by_current_user = ${fileData.is_liked_by_current_user}`);
                });
            }
        })
        .catch(error => {
            console.error('‚ùå Polling API error:', error);
        });
    }
}

// Debug script for "Xem Code" functionality
function debugViewCode() {
    console.log('üîç Debugging "Xem Code" functionality...');
    console.log('User login status:', window.isLoggedIn ? 'Logged in' : 'Not logged in');
    
    // Test 1: Check login modal
    const loginModal = document.getElementById('login-modal');
    if (loginModal) {
        console.log('‚úÖ Login modal found');
        console.log('Login modal display style:', loginModal.style.display);
    } else {
        console.log('‚ùå Login modal not found');
    }
    
    // Test 2: Check view code buttons
    const viewCodeBtns = document.querySelectorAll('.view-code-btn');
    console.log('Found view code buttons:', viewCodeBtns.length);
    
    viewCodeBtns.forEach((btn, index) => {
        console.log(`View code button ${index + 1}:`);
        console.log(`  - Has onclick: ${btn.hasAttribute('onclick')}`);
        console.log(`  - Onclick value: ${btn.getAttribute('onclick')}`);
        console.log(`  - Data filename: ${btn.getAttribute('data-filename')}`);
        console.log(`  - Text content: ${btn.querySelector('.text')?.textContent}`);
    });
    
    // Test 3: Simulate view code button click (not logged in)
    if (!window.isLoggedIn && viewCodeBtns.length > 0) {
        console.log('üîç Simulating view code button click (not logged in)...');
        const firstBtn = viewCodeBtns[0];
        
        // Create and dispatch click event
        const clickEvent = new MouseEvent('click', {
            bubbles: true,
            cancelable: true,
            view: window
        });
        
        firstBtn.dispatchEvent(clickEvent);
        console.log('‚úÖ Click event dispatched');
    }
}



// Add to window for testing
window.debugFollow = debugFollow;
window.debugPolling = debugPolling;
window.debugViewCode = debugViewCode;
window.executePendingAction = executePendingAction;
window.getCurrentPendingFileId = getCurrentPendingFileId;
window.loginWithGoogle = loginWithGoogle;

// Test function ƒë·ªÉ ki·ªÉm tra pending action
window.testPendingAction = function() {
    console.log('üß™ Testing pending action manually...');
    
    // Ki·ªÉm tra localStorage
    const pendingActionStr = localStorage.getItem('tikz2svg_pending_action');
    console.log('üîÑ Pending action:', pendingActionStr);
    
    if (pendingActionStr) {
        try {
            const pendingAction = JSON.parse(pendingActionStr);
            console.log('üîÑ Parsed pending action:', pendingAction);
            
            // Ki·ªÉm tra file card
            const targetCard = document.querySelector(`.file-card[data-id="${pendingAction.fileId}"]`);
            console.log('üîÑ Target card found:', !!targetCard);
            
            if (targetCard) {
                // Ki·ªÉm tra n√∫t "Xem Code"
                const viewCodeBtn = targetCard.querySelector('.view-code-btn');
                console.log('üîÑ View code button found:', !!viewCodeBtn);
                
                if (viewCodeBtn) {
                    console.log('üîÑ About to click view code button...');
                    viewCodeBtn.click();
                    console.log('üîÑ View code button clicked!');
                } else {
                    console.log('‚ùå View code button not found');
                }
            } else {
                console.log('‚ùå Target card not found');
            }
        } catch (error) {
            console.error('‚ùå Error parsing pending action:', error);
        }
    } else {
        console.log('‚ùå No pending action found');
    }
};

// Simple function ƒë·ªÉ click view code button
window.clickViewCode = function(fileId) {
    console.log('üß™ Clicking view code for file ID:', fileId);
    
    const targetCard = document.querySelector(`.file-card[data-id="${fileId}"]`);
    if (targetCard) {
        const viewCodeBtn = targetCard.querySelector('.view-code-btn');
        if (viewCodeBtn) {
            console.log('üîÑ Clicking view code button...');
            viewCodeBtn.click();
            console.log('üîÑ View code button clicked!');
        } else {
            console.log('‚ùå View code button not found');
        }
    } else {
        console.log('‚ùå File card not found');
    }
};


</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>

<!-- Production-ready script loading -->
<script>
    // Modern event handling to avoid deprecated warnings
    if (typeof window !== 'undefined') {
        // Use modern APIs instead of deprecated ones
        window.addEventListener('load', function() {
            console.log('‚úÖ Page loaded successfully');
        });
        
        // Replace deprecated DOMNodeInserted with MutationObserver
        if (typeof MutationObserver !== 'undefined') {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        // Handle DOM changes here if needed
                        // This replaces the deprecated DOMNodeInserted event
                    }
                });
            });
            
            // Start observing
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            console.log('‚úÖ Modern MutationObserver initialized');
        }
    }
</script>
</body>
</html> 