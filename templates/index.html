<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TikZ to SVG</title>
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="48x48" href="{{ url_for('static', filename='favicon-48x48.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='android-chrome-192x192.png') }}">
    <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='android-chrome-512x512.png') }}">
    <link rel="shortcut icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <!-- Highlight.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material.min.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- File Card CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/file_card.css', v='1.1') }}">
    
    <!-- Navigation CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navigation.css', v='1.0') }}">
    
    <!-- Index Page CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css', v='1.0') }}">
</head>
<body>
    {% include '_navbar.html' %}
    
    <!-- Search Bar -->
    <div class="container" style="margin-top: 20px; margin-bottom: 20px; overflow: visible;">
        <div class="search-container" style="display: flex; justify-content: center; align-items: center; gap: 20px;">
            <h3 class="search-title">T√¨m ki·∫øm ·∫£nh SVG</h3>
            <div class="group">
                <svg viewBox="0 0 24 24" aria-hidden="true" class="icon">
                    <g>
                        <path d="M21.53 20.47l-3.66-3.66C19.195 15.24 20 13.214 20 11c0-4.97-4.03-9-9-9s-9 4.03-9 9 4.03 9 9 9c2.215 0 4.24-.804 5.808-2.13l3.66 3.66c.147.146.34.22.53.22s.385-.073.53-.22c.295-.293.295-.767.002-1.06zM3.5 11c0-4.135 3.365-7.5 7.5-7.5s7.5 3.365 7.5 7.5-3.365 7.5-7.5 7.5-7.5-3.365-7.5-7.5z"></path>
                    </g>
                </svg>
                <input class="input" type="search" placeholder="T√¨m ki·∫øm..." id="main-search-input" />
                <div id="search-suggestions" class="search-suggestions" style="display: none;"></div>
            </div>
        </div>
    </div>
    
    <!-- Block 2: Input-Preview Section -->
    <div class="input-preview-section container">
        <h2>Chuy·ªÉn ƒë·ªïi TikZ sang SVG/PNG/JPEG</h2>

        <!-- Truy·ªÅn tr·∫°ng th√°i login t·ª´ server v√†o JS (ƒë·ªÉ linter kh√¥ng b√°o l·ªói) -->
        <script id="app-state" type="application/json">{{ {
          'loggedIn': logged_in,
          'userEmail': user_email,
          'username': username,
          'avatar': avatar
        } | tojson | safe }}</script>
        <!-- Gi√° tr·ªã TikZ ban ƒë·∫ßu ƒë·ªÉ kh·ªüi t·∫°o CodeMirror -->
        <script id="initial-tikz" type="application/json">{{ tikz_code|default('')|tojson|safe }}</script>
        <script>
          window.appState = JSON.parse(document.getElementById('app-state').textContent);
        </script>

        <div class="table-scroll-x">
          <div class="table-content">
            <div class="col">
              <form id="tikz-form" method="post" onsubmit="console.log('Form submit event'); return submitTikzCodeAjax(event)">
                <textarea name="code" id="code" rows="12" placeholder="Nh·∫≠p code TikZ t·∫°i ƒë√¢y...">{{ tikz_code|default('') }}</textarea>
                <div class="d-flex justify-content-end align-items-center gap-2" id="compile-save-row">
                  <button type="submit" id="compile-btn" class="compile-save-row-btn" {% if not logged_in %}title="B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p Google ƒë·ªÉ s·ª≠ d·ª•ng"{% endif %}>Bi√™n d·ªãch</button>
                  <button
                    type="button"
                    id="save-server-btn"
                    class="compile-save-row-btn"
                    data-file-id="{{ svg_temp_id }}"
                    data-tikz-code="{{ tikz_code | e }}"
                    style="display: none;"
                  >
                    üíæ L∆∞u server
                  </button>
                </div>
              </form>
            </div>
            <div class="col">
              {% if error %}
                <div class="error">{{ error|safe }}</div>
              {% elif svg_temp_url %}
                <img src="{{ svg_temp_url }}" alt="SVG Preview" style="width:100%;height:100%;object-fit:contain;display:block;">
              {% else %}
                <div class="preview-placeholder">
                  <p>Nh·∫≠p code TikZ ƒë·ªÉ xem preview real-time</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
        <!-- Th√¥ng b√°o h∆∞·ªõng d·∫´n cho mobile -->
        <p id="mobile-scroll-hint" style="margin-top: 12px; color: #777; font-size: 0.9em; text-align: center; display: none;">
          üì± Tr√™n ƒëi·ªán tho·∫°i, vu·ªët ngang ƒë·ªÉ xem ƒë·ªß 2 c·ªôt
        </p>

        {# Th√™m block n√†y NGAY SAU form, TR∆Ø·ªöC result-tools-section #}
        {% if error %}
            <div class="result-section">
                <div class="error">{{ error|safe }}
                    {% if error_log_full %}
                        <br><button id="show-log-btn" style="margin-top:10px; background:#b71c1c; color:white; border:none; border-radius:4px; padding:6px 16px; cursor:pointer;">Hi·ªÉn th·ªã chi ti·∫øt log</button>
                        <pre id="full-log" style="display:none; background:#fff0f0; color:#b71c1c; border:1px solid #f5c6cb; border-radius:4px; padding:12px; margin-top:10px; max-height:400px; overflow:auto;">{{ error_log_full }}</pre>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        {% if svg_temp_url and not error %}
    </div> <!-- ƒë√≥ng .input-preview-section tr∆∞·ªõc khi tools -->
    
    <div id="result-tools-section" class="container" style="margin-top: 16px;">
                <div class="export-section">
                    <h4>Xu·∫•t ·∫£nh PNG/JPEG</h4>
                    <form id="export-form" class="export-form">
                        <div class="export-pair">
                            <label for="export-format" class="export-label">ƒê·ªãnh d·∫°ng:</label>
                            <select id="export-format" class="export-input export-select">
                                <option value="png">PNG</option>
                                <option value="jpeg">JPEG</option>
                            </select>
                        </div>
                        <div class="export-pair">
                            <label for="export-dpi" class="export-label">DPI:</label>
                            <input type="number" id="export-dpi" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-pair">
                            <label for="export-width" class="export-label">Width (px):</label>
                            <input type="number" id="export-width" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-pair">
                            <label for="export-height" class="export-label">Height (px):</label>
                            <input type="number" id="export-height" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-btn-group">
                            <button id="export-btn" type="button" class="export-btn" data-file-id="{{ svg_temp_id }}">T·∫£i xu·ªëng</button>
                        </div>
                    </form>
                    <div id="export-msg" style="margin-top:5px; color:#388e3c;"></div>
                </div>

                {% if svg_content %}
                    <div class="code-section">
                        <button id="toggle-svg-code-btn" class="copy-btn" type="button">üìú Xem code SVG</button>
                        <div id="svg-code-container" style="display:none; margin-top:12px;">
                            <div class="code-header">
                                <span class="code-title">Code SVG:</span>
                                <button id="copy-svg-code-btn" class="copy-btn" type="button">üìã Copy Code</button>
                            </div>
                            <div class="code-block" id="svgCode">
                                <pre><code class="language-xml">{{ svg_content }}</code></pre>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        {% else %}
    </div> <!-- ƒë√≥ng .input-preview-section -->
        {% endif %}
    
    <!-- Block 3: Files Section -->
    <div class="files-section-container container files-section" data-is-owner="{{ 'true' if logged_in else 'false' }}">
        <h3 style="color:#1976d2; margin-bottom:24px;">üìÅ Files ƒë√£ l∆∞u</h3>
        <div id="files-container" class="files-grid">
            {% if svg_files %}
                {% for file in svg_files %}
                    {% include '_file_card.html' %}
                {% endfor %}
            {% else %}
                <div class="no-files">
                    <div class="no-files-icon">üìÅ</div>
                    <h4>Ch∆∞a c√≥ files n√†o</h4>
                    <p>H√£y t·∫°o file SVG ƒë·∫ßu ti√™n c·ªßa b·∫°n!</p>
                </div>
            {% endif %}
        </div>
    </div>

    <footer style='text-align:center;color:#888;font-size:14px;margin-top:40px;'>¬© 2024 TikZ2SVG - All rights reserved.</footer>

    <!-- Modal ƒëƒÉng nh·∫≠p cho n√∫t "Xem Code" -->
    <div id="login-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center;">
      <div style="background:white; padding:32px 40px; border-radius:12px; box-shadow:0 2px 16px rgba(0,0,0,0.15); min-width:320px; text-align:center;">
        <h3 style="margin-bottom:24px;">ƒêƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y</h3>
        <p style="margin-bottom:16px; color:#666;">Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ c√≥ th·ªÉ:</p>
        <ul style="margin-bottom:24px; color:#666; text-align:left; display:inline-block;">
          <li>üëÅÔ∏è Xem TikZ code</li>
          <li>üëç Like v√† unlike ·∫£nh</li>
          <li>üíæ L∆∞u ·∫£nh v√†o server</li>
          <li>üë• Theo d√µi ng∆∞·ªùi d√πng kh√°c</li>
        </ul>
        <p style="margin-bottom:24px; color:#1976d2; font-weight:500;">üí° B·∫°n v·∫´n c√≥ th·ªÉ s·ª≠ d·ª•ng Facebook Share v√† Copy Link m√† kh√¥ng c·∫ßn ƒëƒÉng nh·∫≠p!</p>
        
        <!-- Container cho c√°c n√∫t - cƒÉn gi·ªØa -->
        <div style="display:flex; justify-content:center; align-items:center; gap:12px; flex-wrap:wrap;">
          <button id="modal-login-btn" class="google-login-btn" style="margin:0;">
            <span class="google-login-content">
              <svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid" viewBox="0 0 256 262">
                <path fill="#4285F4" d="M255.878 133.451c0-10.734-.871-18.567-2.756-26.69H130.55v48.448h71.947c-1.45 12.04-9.283 30.172-26.69 42.356l-.244 1.622 38.755 30.023 2.685.268c24.659-22.774 38.875-56.282 38.875-96.027"></path>
                <path fill="#34A853" d="M130.55 261.1c35.248 0 64.839-11.605 86.453-31.622l-41.196-31.913c-11.024 7.688-25.82 13.055-45.257 13.055-34.523 0-63.824-22.773-74.269-54.25l-1.531.13-40.298 31.187-.527 1.465C35.393 231.798 79.49 261.1 130.55 261.1"></path>
                <path fill="#FBBC05" d="M56.281 156.37c-2.756-8.123-4.351-16.827-4.351-25.82 0-8.994 1.595-17.697 4.206-25.82l-.073-1.73L15.26 71.312l-1.335.635C5.077 89.644 0 109.517 0 130.55s5.077 40.905 13.925 58.602l42.356-32.782"></path>
                <path fill="#EB4335" d="M130.55 50.479c24.514 0 41.05 10.589 50.479 19.438l36.844-35.974C195.245 12.91 165.798 0 130.55 0 79.49 0 35.393 29.301 13.925 71.947l42.211 32.783c10.59-31.477 39.891-54.251 74.414-54.251"></path>
              </svg>
              ƒêƒÉng nh·∫≠p Google
            </span>
          </button>
          <button onclick="document.getElementById('login-modal').style.display='none'" style="background:#eee; color:#333; padding:12px 24px; border-radius:6px; border:none; font-weight:bold; margin:0;">Hu·ª∑</button>
        </div>
      </div>
    </div>

    <!-- Modal nh·∫≠p t·ª´ kh√≥a Bootstrap -->
    <div class="modal fade" id="keywordModal" tabindex="-1" aria-labelledby="keywordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="keywordModalLabel">Nh·∫≠p m√¥ t·∫£ / t·ª´ kh√≥a</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <!-- ·∫¢nh SVG preview -->
              <div id="modal-svg-preview">
                <img id="modal-svg-img" src="" alt="SVG Preview">
              </div>
              <p>Nh·∫≠p c√°c t·ª´ kh√≥a, c√°ch nhau b·∫±ng d·∫•u ph·∫©y:</p>
              <div class="position-relative">
                <textarea id="keywordsInput" class="form-control" rows="4" placeholder="V√≠ d·ª•: to√°n h·ªçc, h√¨nh h·ªçc, ƒë·ªì th·ªã"></textarea>
                <div id="keywordSuggestions" 
                     class="list-group position-absolute w-100" 
                     style="z-index:9999; max-height:200px; overflow-y:auto; display:none;"></div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
              <button type="button" class="btn btn-primary" id="confirmKeywordBtn">X√°c nh·∫≠n</button>
            </div>
          </div>
        </div>
    </div>

    <!-- External JavaScript Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/latex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/stex/stex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/display/placeholder.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Application JavaScript -->
    <script src="{{ url_for('static', filename='js/file_card.js', v='1.2') }}"></script>
    <script src="{{ url_for('static', filename='js/index.js', v='1.0') }}"></script>
</body>
</html>
