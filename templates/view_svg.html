{% extends "base.html" %}

{# Configuration flags #}
{% set include_highlight_js = true %}
{% set include_codemirror = true %}
{% set include_navigation = true %}
{% set include_login_modal = true %}
{% set include_navbar = true %}
{% set include_mathjax = true %}

{# Page-specific meta tags #}
{% block meta %}
<meta name="description" content="Xem vÃ  chia sáº» hÃ¬nh TikZ SVG trá»±c tuyáº¿n - {{ display_name }}">
<meta property="og:title" content="TikZ to SVG - {{ display_name }}" />
<meta property="og:type" content="website" />
<meta property="og:image" content="{{ request.host_url.rstrip('/') ~ png_url }}" />
<meta property="og:url" content="{{ request.host_url.rstrip('/') ~ url_for('view_svg', filename=filename) }}" />
<meta property="og:description" content="Xem vÃ  chia sáº» hÃ¬nh TikZ SVG trá»±c tuyáº¿n." />
{% endblock %}

{# Page title #}
{% block title %}Xem SVG - {{ display_name }}{% endblock %}

{# Body attributes for authentication #}
{% block body_attrs %} data-is-logged-in="{% if user_email %}true{% else %}false{% endif %}" data-set-next-url="{{ url_for('set_next_url') }}"{% endblock %}

{# Additional CSS #}
{% block extra_css %}
<!-- View SVG Page CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/view_svg.css', v='2.0') }}">
<!-- Comments System CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/comments.css', v='2.5') }}">
{% endblock %}

{# Main content #}
{% block content %}

<!-- View SVG Section -->
<div class="view-svg-container">
    <h2 class="view-svg-title">{{ display_name }}</h2>
    
    <div id="view-mode-row">
        <div class="view-col">
            <div id="view-svg-preview">
                <img id="view-svg-img" src="{{ svg_url }}" alt="Xem trÆ°á»›c hÃ¬nh áº£nh SVG - {{ display_name }}" aria-describedby="svg-description">
            </div>
            <div id="view-svg-actions">
                <button id="view-copy-link-btn" class="view-action-btn" aria-label="Sao chÃ©p liÃªn káº¿t Ä‘áº¿n file SVG nÃ y">ğŸ”— Copy Link</button>
                <button id="view-download-svg-btn" class="view-action-btn view-download-btn" aria-label="Táº£i xuá»‘ng file SVG">ğŸ“¥ Táº£i xuá»‘ng SVG</button>
            </div>
        </div>
        <div class="view-col">
            <div class="actions-header">
                <div class="actions-list">
                    <button id="view-back-to-edit-btn" aria-label="Quay vá» trang chá»‰nh sá»­a code TikZ">â†©ï¸ Quay vá» chá»‰nh sá»­a code TikZ</button>
                </div>
            </div>
            <div id="view-export-section">
                <div class="export-section">
                    <h4>Xuáº¥t áº£nh PNG/JPEG</h4>
                    <form id="view-export-form" class="export-form">
                        <div class="export-pair">
                            <label for="view-export-format" class="export-label">Äá»‹nh dáº¡ng:</label>
                            <select id="view-export-format" class="export-input export-select">
                                <option value="png">PNG</option>
                                <option value="jpeg">JPEG</option>
                            </select>
                        </div>
                        <div class="export-pair">
                            <label for="view-export-dpi" class="export-label">DPI:</label>
                            <input type="number" id="view-export-dpi" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-pair">
                            <label for="view-export-width" class="export-label">Width (px):</label>
                            <input type="number" id="view-export-width" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-pair">
                            <label for="view-export-height" class="export-label">Height (px):</label>
                            <input type="number" id="view-export-height" min="1" class="export-input export-number" placeholder="Auto">
                        </div>
                        <div class="export-btn-group">
                            <button id="view-export-btn" type="button" class="export-btn" aria-label="Táº£i xuá»‘ng file áº£nh PNG hoáº·c JPEG">Táº£i xuá»‘ng</button>
                        </div>
                    </form>
                    <div id="view-export-msg" class="export-msg"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Caption Section -->
<div class="image-caption-section">
    <h3 class="caption-section-title">
        <span class="caption-icon">ğŸ“</span> MÃ´ táº£ áº£nh
    </h3>
    
    <!-- Caption Display Mode -->
    <div id="caption-display" class="caption-content" {% if not caption or not caption.strip() %}style="display: none;"{% endif %}>
        <div class="caption-text">{{ caption|safe if caption else '' }}</div>
    </div>
    
    <!-- Empty State (when no caption) -->
    <div id="caption-empty" class="caption-empty" {% if caption and caption.strip() %}style="display: none;"{% endif %}>
        <p class="caption-empty-text">
            {% if user_email and user_id and current_user.is_authenticated and user_id == current_user.id %}
                ChÆ°a cÃ³ mÃ´ táº£. Nháº¥n nÃºt bÃªn dÆ°á»›i Ä‘á»ƒ thÃªm mÃ´ táº£ cho áº£nh.
            {% else %}
                áº¢nh nÃ y chÆ°a cÃ³ mÃ´ táº£.
            {% endif %}
        </p>
    </div>
    
    <!-- Edit Form (only visible when editing) -->
    <div id="caption-edit-form" class="caption-edit-form" style="display: none;">
        <textarea 
            id="caption-input" 
            class="caption-textarea"
            placeholder="ThÃªm mÃ´ táº£ cho áº£nh cá»§a báº¡n. Há»— trá»£ cÃ´ng thá»©c toÃ¡n: $x^2$, $$\int_{0}^{1} x dx$$"
            maxlength="5000"
        >{{ caption if caption else '' }}</textarea>
        <div class="caption-form-footer">
            <div class="caption-char-count">
                <span id="caption-char-current">{{ caption|length if caption else 0 }}</span>/5000 kÃ½ tá»±
            </div>
            <div class="caption-actions">
                <button id="cancel-caption-btn" class="caption-btn caption-btn-cancel">
                    âŒ Há»§y
                </button>
                <button id="save-caption-btn" class="caption-btn caption-btn-save">
                    âœ… LÆ°u
                </button>
            </div>
        </div>
        <div class="caption-preview">
            <h4>Preview (vá»›i MathJax):</h4>
            <div id="caption-preview-content" class="caption-preview-content"></div>
        </div>
    </div>
    
    <!-- Edit Button (only for owner) -->
    {% if user_email and user_id and current_user.is_authenticated and user_id == current_user.id %}
    <button id="edit-caption-btn" class="edit-caption-btn">
        <span class="edit-icon">âœï¸</span> 
        <span class="edit-text">{{ 'Chá»‰nh sá»­a mÃ´ táº£' if caption else 'ThÃªm mÃ´ táº£' }}</span>
    </button>
    {% endif %}
    
    <!-- Messages -->
    <div id="caption-message" class="caption-message"></div>
</div>

<!-- Comments Section -->
<div class="comments-section" id="comments-section">
    <h3 class="comments-section-title">
        <span class="comments-icon">ğŸ’¬</span> 
        BÃ¬nh luáº­n 
        <span id="comments-count-badge" class="comments-count-badge">0</span>
    </h3>
    
    <!-- Comment Form (Create new comment) -->
    {% if current_user.is_authenticated %}
    <div class="comment-form-container">
        <div class="comment-form-header">
            {% if current_avatar %}
                <img src="{{ url_for('static', filename='avatars/' ~ current_avatar) }}" 
                     alt="Avatar" 
                     class="comment-user-avatar"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            {% endif %}
            {% if not current_avatar %}
                <div class="comment-user-avatar comment-user-avatar-fallback">
                    {{ current_user_email[0].upper() if current_user_email else 'U' }}
                </div>
            {% endif %}
            <span class="comment-user-name">
                {{ current_username or (current_user_email.split('@')[0] if current_user_email) }}
                {% if current_identity_verified %}
                    <img src="{{ url_for('static', filename='identity-verification-icon.svg') }}" 
                         alt="Verified" 
                         class="verified-icon"
                         title="TÃ i khoáº£n Ä‘Ã£ xÃ¡c thá»±c">
                {% endif %}
            </span>
        </div>
        <textarea 
            id="new-comment-input" 
            class="comment-textarea"
            placeholder="Viáº¿t bÃ¬nh luáº­n... (Há»— trá»£ LaTeX: $x^2$ vÃ  TikZ code: \code{...})"
            maxlength="5000"
        ></textarea>
        <div class="comment-form-footer">
            <div class="comment-char-count">
                <span id="comment-char-current">0</span>/5000 kÃ½ tá»±
            </div>
            <button id="submit-comment-btn" class="comment-btn comment-btn-submit">
                <span class="btn-icon">ğŸ“¨</span> Gá»­i bÃ¬nh luáº­n
            </button>
        </div>
        <div class="comment-preview">
            <h4>Preview (vá»›i MathJax):</h4>
            <div id="comment-preview-content" class="comment-preview-content">
                Nháº­p bÃ¬nh luáº­n Ä‘á»ƒ xem preview...
            </div>
        </div>
        <div id="comment-form-message" class="comment-message"></div>
    </div>
    {% else %}
    <div class="comment-login-prompt">
        <p>
            <span class="lock-icon">ğŸ”’</span>
            <a href="#" id="login-to-comment-link" class="login-link">ÄÄƒng nháº­p</a> 
            Ä‘á»ƒ bÃ¬nh luáº­n
        </p>
    </div>
    {% endif %}
    
    <!-- Comments List -->
    <div class="comments-list-container">
        <!-- Loading Skeleton -->
        <div id="comments-loading" class="comments-loading">
            <div class="comment-skeleton">
                <div class="skeleton-avatar"></div>
                <div class="skeleton-content">
                    <div class="skeleton-line skeleton-line-short"></div>
                    <div class="skeleton-line skeleton-line-long"></div>
                    <div class="skeleton-line skeleton-line-medium"></div>
                </div>
            </div>
            <div class="comment-skeleton">
                <div class="skeleton-avatar"></div>
                <div class="skeleton-content">
                    <div class="skeleton-line skeleton-line-short"></div>
                    <div class="skeleton-line skeleton-line-long"></div>
                </div>
            </div>
        </div>
        
        <!-- Empty State -->
        <div id="comments-empty" class="comments-empty" style="display: none;">
            <div class="empty-icon">ğŸ’­</div>
            <p class="empty-text">ChÆ°a cÃ³ bÃ¬nh luáº­n nÃ o.</p>
            <p class="empty-subtext">
                {% if current_user.is_authenticated %}
                HÃ£y lÃ  ngÆ°á»i Ä‘áº§u tiÃªn bÃ¬nh luáº­n!
                {% else %}
                <a href="#" class="login-link" id="login-to-comment-empty">ÄÄƒng nháº­p</a> Ä‘á»ƒ trá»Ÿ thÃ nh ngÆ°á»i Ä‘áº§u tiÃªn bÃ¬nh luáº­n.
                {% endif %}
            </p>
        </div>
        
        <!-- Comments Container -->
        <div id="comments-container" class="comments-container">
            <!-- Comments will be dynamically inserted here -->
        </div>
        
        <!-- Pagination -->
        <div id="comments-pagination" class="comments-pagination" style="display: none;">
            <button id="comments-prev-btn" class="pagination-btn" disabled>
                â† TrÆ°á»›c
            </button>
            <span id="comments-page-info" class="page-info">
                Trang <span id="current-page">1</span> / <span id="total-pages">1</span>
            </span>
            <button id="comments-next-btn" class="pagination-btn" disabled>
                Sau â†’
            </button>
        </div>
        
        <!-- Load More Button (alternative to pagination) -->
        <div id="comments-load-more-container" style="display: none;">
            <button id="comments-load-more-btn" class="load-more-btn">
                Xem thÃªm bÃ¬nh luáº­n
            </button>
        </div>
    </div>
</div>

<!-- Comment Template (Hidden, used by JavaScript) -->
<template id="comment-template">
    <div class="comment" data-comment-id="">
        <div class="comment-header">
            <div class="comment-avatar-wrapper">
                <img src="" alt="" class="comment-avatar" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="comment-avatar comment-user-avatar-fallback" style="display: none;"></div>
            </div>
            <div class="comment-meta">
                <span class="comment-author-wrapper">
                    <span class="comment-author"></span>
                    <img src="" alt="Verified" class="verified-icon" style="display: none;">
                </span>
                <span class="comment-timestamp"></span>
            </div>
            <div class="comment-actions-menu">
                <button class="comment-menu-btn" aria-label="Menu">â‹®</button>
                <div class="comment-dropdown" style="display: none;">
                    <button class="dropdown-item edit-comment-btn">âœï¸ Chá»‰nh sá»­a</button>
                    <button class="dropdown-item delete-comment-btn">ğŸ—‘ï¸ XÃ³a</button>
                </div>
            </div>
        </div>
        <div class="comment-body">
            <div class="comment-text"></div>
            <div class="comment-edit-form" style="display: none;">
                <textarea class="comment-edit-textarea" maxlength="5000"></textarea>
                <div class="comment-edit-actions">
                    <button class="comment-btn comment-btn-cancel">Há»§y</button>
                    <button class="comment-btn comment-btn-save">LÆ°u</button>
                </div>
            </div>
        </div>
        <div class="comment-footer">
            <button class="comment-like-btn" aria-label="ThÃ­ch bÃ¬nh luáº­n">
                <span class="like-icon">ğŸ‘</span>
                <span class="like-count">0</span>
            </button>
            <button class="comment-reply-btn" aria-label="Tráº£ lá»i bÃ¬nh luáº­n">
                <span class="reply-icon">ğŸ’¬</span> Tráº£ lá»i
            </button>
            <span class="comment-edited-label" style="display: none;">(Ä‘Ã£ chá»‰nh sá»­a)</span>
        </div>
        
        <!-- Reply Form (hidden by default) -->
        <div class="comment-reply-form" style="display: none;">
            <textarea class="reply-textarea" placeholder="Viáº¿t cÃ¢u tráº£ lá»i..." maxlength="5000"></textarea>
            <div class="comment-preview">
                <h4>Preview (vá»›i MathJax):</h4>
                <div class="reply-preview-content">
                    Nháº­p cÃ¢u tráº£ lá»i Ä‘á»ƒ xem preview...
                </div>
            </div>
            <div class="reply-form-actions">
                <button class="comment-btn comment-btn-cancel">Há»§y</button>
                <button class="comment-btn comment-btn-submit">Gá»­i</button>
            </div>
        </div>
        
        <!-- Replies Container -->
        <div class="comment-replies">
            <!-- Nested replies will be inserted here -->
        </div>
    </div>
</template>

<!-- Inject TikZ code as JSON to avoid inline Jinja inside JS -->
<script id="tikz-code-json" type="application/json">{{ tikz_code|default("")|tojson|safe }}</script>

<!-- Inject caption data for JavaScript -->
<script id="caption-data-json" type="application/json">
{
    "filename": {{ filename|tojson|safe }},
    "caption": {{ caption|tojson|safe }},
    "isOwner": {% if user_email and user_id and current_user.is_authenticated and user_id == current_user.id %}true{% else %}false{% endif %}
}
</script>

<!-- Inject comments data for JavaScript -->
<script id="comments-data-json" type="application/json">
{
    "filename": {{ filename|tojson|safe }},
    "isLoggedIn": {% if current_user.is_authenticated %}true{% else %}false{% endif %},
    "currentUserId": {% if current_user.is_authenticated %}{{ current_user.id }}{% else %}null{% endif %},
    "currentUserAvatar": {% if current_user.is_authenticated %}{% if current_avatar %}{{ url_for('static', filename='avatars/' ~ current_avatar)|tojson|safe }}{% else %}null{% endif %}{% else %}null{% endif %},
    "currentUserAvatarFallback": {% if current_user.is_authenticated %}{% if not current_avatar %}{{ (current_user_email[0].upper() if current_user_email else 'U')|tojson|safe }}{% else %}null{% endif %}{% else %}null{% endif %},
    "currentUserName": {% if current_user.is_authenticated %}{{ (current_username or (current_user_email.split('@')[0] if current_user_email))|tojson|safe }}{% else %}null{% endif %},
    "currentUserVerified": {% if current_user.is_authenticated %}{{ current_identity_verified|tojson|safe }}{% else %}false{% endif %},
    "verifiedIconUrl": {{ url_for('static', filename='identity-verification-icon.svg')|tojson|safe }},
    "apiBasePath": "/api/comments"
}
</script>
{% endblock %}

{# Additional JavaScript #}
{% block extra_js %}
<!-- Application JavaScript -->
<script src="{{ url_for('static', filename='js/view_svg.js', v='1.0') }}"></script>
<!-- Comments System JavaScript -->
<script src="{{ url_for('static', filename='js/comments.js', v='2.2') }}"></script>
{% endblock %}